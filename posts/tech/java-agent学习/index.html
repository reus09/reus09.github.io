<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Java Agentå­¦ä¹  | Reus09&#39;s Blog</title>
<meta name="keywords" content="Instrumentation">
<meta name="description" content="å‰è¨€ JDK 1.5 å¼€å§‹ï¼ŒJavaæ–°å¢äº† Instrumentation ( Java Agent API )å’Œ JVMTI ( JVM Tool Interface )åŠŸèƒ½ï¼Œå…è®¸JVMåœ¨åŠ è½½æŸä¸ª class æ–‡ä»¶ä¹‹å‰å¯¹å…¶å­—èŠ‚ç è¿›è¡Œä¿®æ”¹ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒå¯¹å·²åŠ è½½çš„ class (ç±»å­—èŠ‚">
<meta name="author" content="Reus09">
<link rel="canonical" href="/posts/tech/java-agent%E5%AD%A6%E4%B9%A0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.40573d180b208ab15c3bf0a170c2ac86aa8ccf179f96f939352198fbee79100e.css" integrity="sha256-QFc9GAsgirFcO/ChcMKshqqMzxeflvk5NSGY&#43;&#43;55EA4=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="16x16" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="icon" type="image/png" sizes="32x32" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="apple-touch-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<link rel="mask-icon" href="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Java Agentå­¦ä¹ " />
<meta property="og:description" content="å‰è¨€ JDK 1.5 å¼€å§‹ï¼ŒJavaæ–°å¢äº† Instrumentation ( Java Agent API )å’Œ JVMTI ( JVM Tool Interface )åŠŸèƒ½ï¼Œå…è®¸JVMåœ¨åŠ è½½æŸä¸ª class æ–‡ä»¶ä¹‹å‰å¯¹å…¶å­—èŠ‚ç è¿›è¡Œä¿®æ”¹ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒå¯¹å·²åŠ è½½çš„ class (ç±»å­—èŠ‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/tech/java-agent%E5%AD%A6%E4%B9%A0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-07T18:51:30+08:00" />
<meta property="article:modified_time" content="2023-04-07T18:51:30+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Java Agentå­¦ä¹ "/>
<meta name="twitter:description" content="å‰è¨€ JDK 1.5 å¼€å§‹ï¼ŒJavaæ–°å¢äº† Instrumentation ( Java Agent API )å’Œ JVMTI ( JVM Tool Interface )åŠŸèƒ½ï¼Œå…è®¸JVMåœ¨åŠ è½½æŸä¸ª class æ–‡ä»¶ä¹‹å‰å¯¹å…¶å­—èŠ‚ç è¿›è¡Œä¿®æ”¹ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒå¯¹å·²åŠ è½½çš„ class (ç±»å­—èŠ‚"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯",
      "item": "/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Java Agentå­¦ä¹ ",
      "item": "/posts/tech/java-agent%E5%AD%A6%E4%B9%A0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Java Agentå­¦ä¹ ",
  "name": "Java Agentå­¦ä¹ ",
  "description": "å‰è¨€ JDK 1.5 å¼€å§‹ï¼ŒJavaæ–°å¢äº† Instrumentation ( Java Agent API )å’Œ JVMTI ( JVM Tool Interface )åŠŸèƒ½ï¼Œå…è®¸JVMåœ¨åŠ è½½æŸä¸ª class æ–‡ä»¶ä¹‹å‰å¯¹å…¶å­—èŠ‚ç è¿›è¡Œä¿®æ”¹ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒå¯¹å·²åŠ è½½çš„ class (ç±»å­—èŠ‚",
  "keywords": [
    "Instrumentation"
  ],
  "articleBody": "å‰è¨€ JDK 1.5 å¼€å§‹ï¼ŒJavaæ–°å¢äº† Instrumentation ( Java Agent API )å’Œ JVMTI ( JVM Tool Interface )åŠŸèƒ½ï¼Œå…è®¸JVMåœ¨åŠ è½½æŸä¸ª class æ–‡ä»¶ä¹‹å‰å¯¹å…¶å­—èŠ‚ç è¿›è¡Œä¿®æ”¹ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒå¯¹å·²åŠ è½½çš„ class (ç±»å­—èŠ‚ç )è¿›è¡Œé‡æ–°åŠ è½½( Retransform )ã€‚\nåœ¨1.6ç‰ˆæœ¬æ–°å¢äº†attach(é™„åŠ æ–¹å¼)ï¼Œå¯ä»¥å¯¹è¿è¡Œä¸­çš„Javaè¿›ç¨‹æ’å…¥Agentï¼ŒinstrumentationåŒ…è¢«èµ‹äºˆäº†æ›´å¼ºå¤§çš„åŠŸèƒ½ï¼šå¯åŠ¨åçš„ instrumentã€æœ¬åœ°ä»£ç ï¼ˆnative codeï¼‰instrumentï¼Œä»¥åŠåŠ¨æ€æ”¹å˜ classpath ç­‰ç­‰ã€‚è¿™äº›æ”¹å˜ï¼Œæ„å‘³ç€ Java å…·æœ‰äº†æ›´å¼ºçš„åŠ¨æ€æ§åˆ¶ã€è§£é‡Šèƒ½åŠ›ï¼Œå®ƒä½¿å¾— Java è¯­è¨€å˜å¾—æ›´åŠ çµæ´»å¤šå˜ã€‚\njava.lang.instrumentåŒ…çš„å…·ä½“å®ç°ï¼Œä¾èµ–äº JVMTIã€‚JVMTIï¼ˆJava Virtual Machine Tool Interfaceï¼‰æ˜¯ä¸€å¥—ç”± Java è™šæ‹Ÿæœºæä¾›çš„ï¼Œä¸º JVM ç›¸å…³çš„å·¥å…·æä¾›çš„æœ¬åœ°ç¼–ç¨‹æ¥å£é›†åˆã€‚JVMTI æ˜¯ä» Java SE 5 å¼€å§‹å¼•å…¥ï¼Œæ•´åˆå’Œå–ä»£äº†ä»¥å‰ä½¿ç”¨çš„ Java Virtual Machine Profiler Interface (JVMPI) å’Œ the Java Virtual Machine Debug Interface (JVMDI)ï¼Œè€Œåœ¨ Java SE 6 ä¸­ï¼ŒJVMPI å’Œ JVMDI å·²ç»æ¶ˆå¤±äº†ã€‚JVMTI æä¾›äº†ä¸€å¥—â€ä»£ç†â€ç¨‹åºæœºåˆ¶ï¼Œå¯ä»¥æ”¯æŒç¬¬ä¸‰æ–¹å·¥å…·ç¨‹åºä»¥ä»£ç†çš„æ–¹å¼è¿æ¥å’Œè®¿é—® JVMï¼Œå¹¶åˆ©ç”¨ JVMTI æä¾›çš„ä¸°å¯Œçš„ç¼–ç¨‹æ¥å£ï¼Œå®Œæˆå¾ˆå¤šè·Ÿ JVM ç›¸å…³çš„åŠŸèƒ½\nJava Agentå¯ä»¥å»å®ç°å­—èŠ‚ç æ’æ¡©ã€åŠ¨æ€è·Ÿè¸ªåˆ†æç­‰ï¼Œæ¯”å¦‚RASPäº§å“å’ŒJava Agentå†…å­˜é©¬ã€‚\næœ¬æ–‡ä¸»è¦å¯¹premainæ–¹æ³•å’Œagentmainæ–¹æ³•åšç®€å•çš„å­¦ä¹ ã€‚\nå‰æçŸ¥è¯† java.lang.instrument ä»£ç ä¸»è¦ä½äºjava.lang.instrumentåŒ…é‡Œï¼Œè¿™é‡Œä¸»è¦è®²å¸¸ç”¨çš„ã€‚\nClassDefinition ç»‘å®š/å®šä¹‰ç±» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 public final class ClassDefinition { /** * The class to redefine * è¦é‡å®šä¹‰çš„ç±» */ private final Class\u003c?\u003e mClass; /** * The replacement class file bytes * éœ€è¦æ›¿æ¢çš„æœ¬åœ°ç±»çš„byteï¼Œä¸ºæ•°ç»„ */ private final byte[] mClassFile; /** * Creates a new ClassDefinition binding using the supplied * class and class file bytes. Does not copy the supplied buffer, just captures a reference to it. * * @param theClass the Class that needs redefining * @param theClassFile the new class file bytes * * @throws java.lang.NullPointerException if the supplied class or array is null. */ public ClassDefinition( Class\u003c?\u003e theClass, byte[] theClassFile) { if (theClass == null || theClassFile == null) { throw new NullPointerException(); } mClass = theClass; mClassFile = theClassFile; } /** * Returns the class. * * @return the Class object referred to. */ public Class\u003c?\u003e getDefinitionClass() { return mClass; } /** * Returns the array of bytes that contains the new class file. * * @return the class file bytes. */ public byte[] getDefinitionClassFile() { return mClassFile; } } ClassFileTransformer æ¥å£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 public interface ClassFileTransformer { /** * ç±»æ–‡ä»¶è½¬æ¢æ–¹æ³•ï¼Œé‡å†™transformæ–¹æ³•å¯è·å–åˆ°å¾…åŠ è½½çš„ç±»ç›¸å…³ä¿¡æ¯ * * @param loader å®šä¹‰è¦è½¬æ¢çš„ç±»åŠ è½½å™¨ï¼›å¦‚æœæ˜¯å¼•å¯¼åŠ è½½å™¨ï¼Œåˆ™ä¸º null * @param className ç±»å,å¦‚:java/lang/Runtime * @param classBeingRedefined å¦‚æœæ˜¯è¢«é‡å®šä¹‰æˆ–é‡è½¬æ¢è§¦å‘ï¼Œåˆ™ä¸ºé‡å®šä¹‰æˆ–é‡è½¬æ¢çš„ç±»ï¼›å¦‚æœæ˜¯ç±»åŠ è½½ï¼Œåˆ™ä¸º null * @param protectionDomain è¦å®šä¹‰æˆ–é‡å®šä¹‰çš„ç±»çš„ä¿æŠ¤åŸŸ * @param classfileBuffer ç±»æ–‡ä»¶æ ¼å¼çš„è¾“å…¥å­—èŠ‚ç¼“å†²åŒºï¼ˆä¸å¾—ä¿®æ”¹ï¼‰ * @return è¿”å›ä¸€ä¸ªé€šè¿‡ASMä¿®æ”¹åæ·»åŠ äº†é˜²å¾¡ä»£ç çš„å­—èŠ‚ç byteæ•°ç»„ã€‚ */ byte[] transform( ClassLoader loader, String className, Class\u003c?\u003e classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException; } é‡å†™ transform() æ–¹æ³•éœ€è¦æ³¨æ„ä»¥ä¸‹äº‹é¡¹ï¼š\nClassLoader å¦‚æœæ˜¯è¢« Bootstrap ClassLoader (å¼•å¯¼ç±»åŠ è½½å™¨)æ‰€åŠ è½½é‚£ä¹ˆ loader å‚æ•°çš„å€¼æ˜¯ç©ºã€‚ ä¿®æ”¹ç±»å­—èŠ‚ç æ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„æ’å…¥çš„ä»£ç åœ¨å¯¹åº”çš„ ClassLoader ä¸­å¯ä»¥æ­£ç¡®çš„è·å–åˆ°ï¼Œå¦åˆ™ä¼šæŠ¥ ClassNotFoundException ï¼Œæ¯”å¦‚ä¿®æ”¹ java.io.FileInputStream (è¯¥ç±»ç”± Bootstrap ClassLoader åŠ è½½)æ—¶æ’å…¥äº†æˆ‘ä»¬æ£€æµ‹ä»£ç ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†å¿…é¡»ä¿è¯ FileInputStream èƒ½å¤Ÿè·å–åˆ°æˆ‘ä»¬çš„æ£€æµ‹ä»£ç ç±»ã€‚ JVMç±»åçš„ä¹¦å†™æ–¹å¼è·¯å¾„æ–¹å¼ï¼šjava/lang/String è€Œä¸æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ç±»åæ–¹å¼ï¼šjava.lang.Stringã€‚ ç±»å­—èŠ‚å¿…é¡»ç¬¦åˆ JVM æ ¡éªŒè¦æ±‚ï¼Œå¦‚æœæ— æ³•éªŒè¯ç±»å­—èŠ‚ç ä¼šå¯¼è‡´ JVM å´©æºƒæˆ–è€… VerifyError (ç±»éªŒè¯é”™è¯¯)ã€‚ å¦‚æœä¿®æ”¹çš„æ˜¯ retransform ç±»(ä¿®æ”¹å·²è¢« JVM åŠ è½½çš„ç±»)ï¼Œä¿®æ”¹åçš„ç±»å­—èŠ‚ç ä¸å¾—æ–°å¢æ–¹æ³•ã€ä¿®æ”¹æ–¹æ³•å‚æ•°ã€ç±»æˆå‘˜å˜é‡ã€‚ addTransformer æ—¶å¦‚æœæ²¡æœ‰ä¼ å…¥ retransform å‚æ•°(é»˜è®¤æ˜¯ false )ï¼Œå°±ç®— MANIFEST.MF ä¸­é…ç½®äº† Can-Redefine-Classes: true è€Œä¸”æ‰‹åŠ¨è°ƒç”¨äº†retransformClasses()æ–¹æ³•ä¹Ÿä¸€æ ·æ— æ³•retransformã€‚ å¸è½½ transform æ—¶éœ€è¦ä½¿ç”¨åˆ›å»ºæ—¶çš„ Instrumentation å®ä¾‹ã€‚ è¿˜éœ€è¦ç†è§£çš„æ˜¯ï¼Œåœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å½¢ä¸‹ ClassFileTransformer.transform() ä¼šè¢«æ‰§è¡Œï¼š\næ–°çš„ class è¢«åŠ è½½ã€‚ Instrumentation.redefineClasses æ˜¾å¼è°ƒç”¨ã€‚ addTransformer ç¬¬äºŒä¸ªå‚æ•°ä¸º true æ—¶ï¼ŒInstrumentation.retransformClasses æ˜¾å¼è°ƒç”¨ã€‚ Instrumentation æ¥å£ java.lang.instrument.Instrumentation æ˜¯ JVMTIAgentï¼ˆJVM Tool Interface Agentï¼‰çš„ä¸€éƒ¨åˆ†ï¼ŒJava agenté€šè¿‡è¿™ä¸ªç±»å’Œç›®æ ‡ JVM è¿›è¡Œäº¤äº’ï¼Œä»è€Œè¾¾åˆ°ä¿®æ”¹æ•°æ®çš„æ•ˆæœ\nåœ¨ Instrumentation ä¸­å¢åŠ äº†åå« transformer çš„ Class æ–‡ä»¶è½¬æ¢å™¨ï¼Œè½¬æ¢å™¨å¯ä»¥æ”¹å˜äºŒè¿›åˆ¶æµçš„æ•°æ®\nTransformer å¯ä»¥å¯¹æœªåŠ è½½çš„ç±»è¿›è¡Œæ‹¦æˆªï¼ŒåŒæ—¶å¯å¯¹å·²åŠ è½½çš„ç±»è¿›è¡Œé‡æ–°æ‹¦æˆªï¼Œæ‰€ä»¥æ ¹æ®è¿™ä¸ªç‰¹æ€§æˆ‘ä»¬èƒ½å¤Ÿå®ç°åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç \nåˆ©ç”¨ Instrumentation æˆ‘ä»¬å¯ä»¥å®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š\nç±»æ–¹æ³• åŠŸèƒ½ void addTransformer(ClassFileTransformer transformer, boolean canRetransform) æ·»åŠ ä¸€ä¸ª Transformerï¼Œæ˜¯å¦å…è®¸ reTransformer void addTransformer(ClassFileTransformer transformer) æ·»åŠ ä¸€ä¸ª Transformer boolean removeTransformer(ClassFileTransformer transformer) ç§»é™¤ä¸€ä¸ª Transformer boolean isRetransformClassesSupported() æ£€æµ‹æ˜¯å¦å…è®¸ reTransformer void retransformClasses(Class\u003c?\u003e... classes) é‡åŠ è½½ï¼ˆretransformï¼‰ç±» boolean isModifiableClass(Class\u003c?\u003e theClass) ç¡®å®šä¸€ä¸ªç±»æ˜¯å¦å¯ä»¥è¢« retransformation æˆ– redefinition ä¿®æ”¹ Class[] getAllLoadedClasses() è·å– JVM å½“å‰åŠ è½½çš„æ‰€æœ‰ç±» Class[] getInitiatedClasses(ClassLoader loader) è·å–æŒ‡å®šç±»åŠ è½½å™¨ä¸‹æ‰€æœ‰å·²ç»åˆå§‹åŒ–çš„ç±» long getObjectSize(Object objectToSize) è¿”å›æŒ‡å®šå¯¹è±¡å¤§å° void appendToBootstrapClassLoaderSearch(JarFile jarfile) æ·»åŠ åˆ° BootstrapClassLoader æœç´¢ void appendToSystemClassLoaderSearch(JarFile jarfile) æ·»åŠ åˆ° SystemClassLoader æœç´¢ boolean isNativeMethodPrefixSupported() æ˜¯å¦æ”¯æŒè®¾ç½® native æ–¹æ³• Prefix void setNativeMethodPrefix(ClassFileTransformer transformer, String prefix) é€šè¿‡å…è®¸é‡è¯•ï¼Œå°†å‰ç¼€åº”ç”¨åˆ°åç§°ï¼Œæ­¤æ–¹æ³•ä¿®æ”¹æœ¬æœºæ–¹æ³•è§£æçš„å¤±è´¥å¤„ç† boolean isRedefineClassesSupported() æ˜¯å¦æ”¯æŒç±» redefine void redefineClasses(ClassDefinition... definitions) é‡å®šä¹‰ï¼ˆredefineï¼‰ç±» å…¶ä¸­å¸¸ç”¨çš„æ–¹æ³•æœ‰:addTransformer,retransformClassesç­‰\næˆ‘ä»¬å¯ä»¥é€šè¿‡addTransformeræ–¹æ³•å®ç°ï¼Œæ·»åŠ ä¸€ä¸ªæˆ‘ä»¬è‡ªå®šä¹‰çš„è½¬æ¢å™¨ï¼Œè¿™ä¸ªè½¬æ¢å™¨å®ç°äº†ClassFileTransformerç±»ï¼Œåœ¨é‡å†™çš„transformæ–¹æ³•ä¸­å®ç°å¯¹ç±»çš„åŠ è½½å’Œä¿®æ”¹ã€‚\ncom.sun.tools.attach åœ¨ jdk 1.6 ä¸­å®ç°äº†attach-on-demandï¼ˆæŒ‰éœ€é™„ç€ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Attach API åŠ¨æ€åŠ è½½ agent ï¼Œç„¶è€Œ Attach API åœ¨ tool.jar ä¸­ï¼Œjvm å¯åŠ¨æ—¶æ˜¯é»˜è®¤ä¸åŠ è½½è¯¥ä¾èµ–çš„ï¼Œéœ€è¦æˆ‘ä»¬åœ¨ classpath ä¸­é¢å¤–è¿›è¡ŒæŒ‡å®š\nå¯åŠ¨ååŠ è½½ agent é€šè¿‡æ–°çš„ä»£ç†æ“ä½œæ¥å®ç°ï¼šagentmainï¼Œä½¿å¾—å¯ä»¥åœ¨ main å‡½æ•°å¼€å§‹è¿è¡Œä¹‹åå†è¿è¡Œ\nåœ¨ Java JDK6 ä»¥åå®ç°å¯åŠ¨ååŠ è½½ Instrument çš„æ˜¯ Attach apiã€‚å­˜åœ¨äº com.sun.tools.attach é‡Œé¢æœ‰ä¸¤ä¸ªé‡è¦çš„ç±»ã€‚\næ¥æŸ¥çœ‹ä¸€ä¸‹è¯¥åŒ…ä¸­çš„å†…å®¹ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„ç±»ï¼Œåˆ†åˆ«æ˜¯ VirtualMachine å’Œ VirtualMachineDescriptorï¼Œå…¶ä¸­æˆ‘ä»¬é‡ç‚¹å…³æ³¨ VirtualMachine ç±»ã€‚\nVirtualMachine VirtualMachine å¯ä»¥æ¥å®ç°è·å–ç³»ç»Ÿä¿¡æ¯ï¼Œå†…å­˜dumpã€ç°æˆdumpã€ç±»ä¿¡æ¯ç»Ÿè®¡ï¼ˆä¾‹å¦‚JVMåŠ è½½çš„ç±»ï¼‰ã€‚é‡Œé¢é…å¤‡æœ‰å‡ ä¸ªæ–¹æ³•LoadAgentï¼ŒAttach å’Œ Detach ã€‚ä¸‹é¢æ¥çœ‹çœ‹è¿™å‡ ä¸ªæ–¹æ³•çš„ä½œç”¨\nAttach ï¼šè¯¥ç±»å…è®¸æˆ‘ä»¬é€šè¿‡ç»™attachæ–¹æ³•ä¼ å…¥ä¸€ä¸ªjvmçš„pid(è¿›ç¨‹id)ï¼Œè¿œç¨‹è¿æ¥åˆ°jvmä¸Š\n1 VirtualMachine vm = VirtualMachine.attach(v.id()); loadAgentï¼šå‘jvmæ³¨å†Œä¸€ä¸ªä»£ç†ç¨‹åºagentï¼Œåœ¨è¯¥agentçš„ä»£ç†ç¨‹åºä¸­ä¼šå¾—åˆ°ä¸€ä¸ªInstrumentationå®ä¾‹ï¼Œè¯¥å®ä¾‹å¯ä»¥ åœ¨classåŠ è½½å‰æ”¹å˜classçš„å­—èŠ‚ç ï¼Œä¹Ÿå¯ä»¥åœ¨classåŠ è½½åé‡æ–°åŠ è½½ã€‚åœ¨è°ƒç”¨Instrumentationå®ä¾‹çš„æ–¹æ³•æ—¶ï¼Œè¿™äº›æ–¹æ³•ä¼šä½¿ç”¨ClassFileTransformeræ¥å£ä¸­æä¾›çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚\nDetachï¼šä» JVM ä¸Šé¢è§£é™¤ä¸€ä¸ªä»£ç†(agent)\nVirtualMachineDescriptor VirtualMachineDescriptor æ˜¯ä¸€ä¸ªæè¿°è™šæ‹Ÿæœºçš„å®¹å™¨ç±»ï¼Œé…åˆ VirtualMachine ç±»å®Œæˆå„ç§åŠŸèƒ½ã€‚\næ‰€ä»¥æœ€åæˆ‘ä»¬çš„æ³¨å…¥æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š\nè¿™é‡Œå€Ÿç”¨å¥¶æ€å¸ˆå‚…çš„å›¾ç‰‡:\né€šè¿‡ VirtualMachine ç±»çš„ attach(pid) æ–¹æ³•ï¼Œå¯ä»¥ attach åˆ°ä¸€ä¸ªè¿è¡Œä¸­çš„ java è¿›ç¨‹ä¸Šï¼Œä¹‹åä¾¿å¯ä»¥é€šè¿‡ loadAgent(agentJarPath) æ¥å°†agent çš„ jar åŒ…æ³¨å…¥åˆ°å¯¹åº”çš„è¿›ç¨‹ï¼Œç„¶åå¯¹åº”çš„è¿›ç¨‹ä¼šè°ƒç”¨agentmainæ–¹æ³•ã€‚\nåº”ç”¨ Java Agent æ”¯æŒä¸¤ç§æ–¹å¼è¿›è¡ŒåŠ è½½ï¼š\nå®ç° premain æ–¹æ³•ï¼Œåœ¨å¯åŠ¨æ—¶è¿›è¡ŒåŠ è½½ ï¼ˆè¯¥ç‰¹æ€§åœ¨ jdk 1.5 ä¹‹åæ‰æœ‰ï¼‰ å®ç° agentmain æ–¹æ³•ï¼Œåœ¨å¯åŠ¨åè¿›è¡ŒåŠ è½½ ï¼ˆè¯¥ç‰¹æ€§åœ¨ jdk 1.6 ä¹‹åæ‰æœ‰ï¼‰ è¿™é‡Œæˆ‘ä»¬æ¥ä¿®æ”¹ç±»:com.reus09.demo.MyClass#sayNiceæ–¹æ³•çš„å†…å®¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package com.reus09.demo; /** * @ClassName MyClass * @Description TODO * @Author reus09 * @Date 2023/3/24 00:36 * @Version 1.0 **/ public class MyClass { public static void sayNice(){ System.out.println(\"Nice!\"); } } premainæ–¹æ³• ä½¿ç”¨premainæ–¹æ³•è®©å‡½æ•°åœ¨æ‰§è¡Œå‰sayNiceæ–¹æ³•çš„è¾“å‡ºå†…å®¹è¢«ä¿®æ”¹æ‰ã€‚\né¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰è‡ªå·±çš„ MyTransformerï¼Œå¦‚ä¸‹ä»£ç ï¼Œè¿™é‡Œä½¿ç”¨åˆ¤æ–­å¦‚æœç±»åä¸ºæŒ‡å®šç±»çš„åç§°ï¼Œåˆ™ä½¿ç”¨ClassHandler.replaceBytes() æ–¹æ³•è¿›è¡Œå­—èŠ‚ç çš„æ›¿æ¢ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package com.reus09.demo.premain; import java.lang.instrument.ClassFileTransformer; import java.lang.instrument.IllegalClassFormatException; import java.security.ProtectionDomain; /** * @ClassName Transformer * @Description TODO * @Author reus09 * @Date 2023/3/24 00:37 * @Version 1.0 **/ public class MyTransformer implements ClassFileTransformer { @Override public byte[] transform(ClassLoader loader, String className, Class\u003c?\u003e classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException { // å°†å¸¸ç”¨çš„ç±»åè½¬æ¢ä¸º JVM è®¤è¯†çš„ç±»å className = className.replace(\"/\", \".\"); // å¦‚æœç±»åä¸ºæˆ‘ä»¬æŒ‡å®šçš„ç±» if (className.equals(\"com.reus09.demo.MyClass\")) { // è¿›ä¸€æ­¥è¿›è¡Œå¤„ç†ï¼Œæ›¿æ¢æ‰è¾“å‡ºå­—ç¬¦ä¸² return ClassHandler.replaceBytes(className, classfileBuffer); } return classfileBuffer; } } å­—ç¬¦å¤„ç†ä»£ç ï¼š\nä»£ç å®ç°æ€è·¯å¾ˆæœ´ç´ ï¼Œè¿™é‡Œå°†ç±»å­—èŠ‚ç è½¬æ¢ä¸ºbyteå­—ç¬¦ä¸²ï¼Œå¹¶è¿›è¡Œå­—ç¬¦ä¸²æŸ¥æ‰¾ï¼Œæ›¿æ¢åå†è½¬å› byteï¼Œåœ¨å®é™…é¡¹ç›®ä¸­å°†ä½¿ç”¨ ASM æˆ– javassist ç­‰å¯¹ç±»å­—èŠ‚ç è¿›è¡Œå¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 package com.reus09.demo.premain; import java.util.Arrays; /** * @ClassName ClassHandler * @Description TODO * @Author reus09 * @Date 2023/3/24 00:38 * @Version 1.0 **/ public class ClassHandler { public static byte[] replaceBytes(String className, byte[] classBuffer) { // å°†ç±»å­—èŠ‚ç è½¬æ¢æˆbyteå­—ç¬¦ä¸² String bufferStr = Arrays.toString(classBuffer); System.out.println(className + \"ç±»æ›¿æ¢å‰çš„å­—èŠ‚ç :\" + bufferStr); bufferStr = bufferStr.replace(\"[\", \"\").replace(\"]\", \"\"); // æŸ¥æ‰¾éœ€è¦æ›¿æ¢çš„JavaäºŒè¿›åˆ¶å†…å®¹ byte[] findBytes = \"Nice!\".getBytes(); // æŠŠæœç´¢çš„å­—ç¬¦ä¸²byteè½¬æ¢æˆbyteå­—ç¬¦ä¸² String findStr = Arrays.toString(findBytes).replace(\"[\", \"\").replace(\"]\", \"\"); // äºŒè¿›åˆ¶æ›¿æ¢åçš„byteå€¼ï¼Œæ³¨æ„è¿™ä¸ªå€¼éœ€è¦å’Œæ›¿æ¢çš„å­—ç¬¦ä¸²é•¿åº¦ä¸€è‡´ï¼Œä¸ç„¶ä¼šç ´åå¸¸é‡æ±  byte[] replaceBytes = \"Reus!\".getBytes(); // æŠŠæ›¿æ¢çš„å­—ç¬¦ä¸²byteè½¬æ¢æˆbyteå­—ç¬¦ä¸² String replaceStr = Arrays.toString(replaceBytes).replace(\"[\", \"\").replace(\"]\", \"\"); bufferStr = bufferStr.replace(findStr, replaceStr); // åˆ‡å‰²æ›¿æ¢åçš„byteå­—ç¬¦ä¸² String[] byteArray = bufferStr.split(\"\\\\s*,\\\\s*\"); // åˆ›å»ºæ–°çš„byteæ•°ç»„ï¼Œå­˜å‚¨æ›¿æ¢åçš„äºŒè¿›åˆ¶ byte[] bytes = new byte[byteArray.length]; // å°†byteå­—ç¬¦ä¸²è½¬æ¢æˆbyte for (int i = 0; i \u003c byteArray.length; i++) { bytes[i] = Byte.parseByte(byteArray[i]); } System.out.println(className + \"ç±»æ›¿æ¢åçš„å­—èŠ‚ç :\" + Arrays.toString(bytes)); // è¿”å›ä¿®æ”¹åçš„äºŒè¿›åˆ¶ return bytes; } } æ¥ä¸‹æ¥å®šä¹‰ Premainï¼Œç±»åéšæ„ï¼Œç±»ä¸­å®šä¹‰äº† premain() æ–¹æ³•æ·»åŠ è‡ªå·±çš„ Transformerã€‚ å…¶ä¸­å‚æ•° agentArgs æ˜¯ premain å‡½æ•°å¾—åˆ°çš„ç¨‹åºå‚æ•°ï¼ŒéšåŒ â€œ-javaagentâ€ä¸€èµ·ä¼ å…¥ã€‚ä¸ main å‡½æ•°ä¸åŒçš„æ˜¯ï¼Œè¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²è€Œä¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œå¦‚æœç¨‹åºå‚æ•°æœ‰å¤šä¸ªï¼Œç¨‹åºå°†è‡ªè¡Œè§£æè¿™ä¸ªå­—ç¬¦ä¸²ã€‚ Inst æ˜¯ä¸€ä¸ª java.lang.instrument.Instrumentation çš„å®ä¾‹ï¼Œç”± JVM è‡ªåŠ¨ä¼ å…¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 package com.reus09.demo; import com.reus09.demo.premain.MyTransformer; import java.lang.instrument.Instrumentation; /** * @ClassName Predemo * @Description TODO * @Author reus09 * @Date 2023/3/22 21:06 * @Version 1.0 **/ public class Predemo { public static void premain(String agentArgs, Instrumentation inst) throws Exception { inst.addTransformer(new MyTransformer()); } } ç„¶ååœ¨resources/META-INFç›®å½•ä¸‹åˆ›å»ºMANIFEST.MFæ–‡ä»¶ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­æˆ‘ä»¬æŒ‡å®šå¯¹åº”çš„Premain-Class: 1 2 Manifest-Version: 1.0 Premain-Class: com.reus09.demo.Predemo éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªæ–‡ä»¶éœ€è¦æœ‰ä¸€è¡Œæ¢è¡Œã€‚\nç„¶ååœ¨pom.xmlé‡ŒåŠ å…¥å¦‚ä¸‹é…ç½®ï¼š\n1 2 3 4 5 6 7 8 9 10 org.apache.maven.plugins maven-jar-plugin 2.3.2 src/main/resources/META-INF/MANIFEST.MF ç„¶åæ‰§è¡Œmvn clean installï¼Œè¿›è¡Œç¨‹åºæ‰“åŒ…ã€‚\nç„¶ååœ¨IDEAè¿è¡Œç¨‹åºæ—¶åŠ å…¥å¦‚ä¸‹å‚æ•°ï¼š\nè¿è¡ŒMyClassç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°sayNiceæ–¹æ³•æ‰§è¡Œçš„ç»“æœå·²ç»å˜äº†ã€‚\npremainæ–¹æ³•æµç¨‹å›¾ï¼š\nagentmainæ–¹æ³• JDK 1.6 æ–°å¢äº†attach (é™„åŠ æ–¹å¼)æ–¹å¼ï¼Œå¯ä»¥å¯¹è¿è¡Œä¸­çš„ Java è¿›ç¨‹é™„åŠ  Agent ã€‚\nè¿™å°±æ˜¯æˆ‘ä»¬è¯´çš„ agentmain ï¼Œä½¿ç”¨æ–¹å¼å’Œ permain ååˆ†ç›¸ä¼¼ï¼ŒåŒ…æ‹¬ç¼–å†™ MANIFEST.MF å’Œç”Ÿæˆä»£ç† Jar åŒ…ã€‚ä½†æ˜¯ï¼Œå®ƒå¹¶ä¸éœ€è¦é€šè¿‡-javaagent å‘½ä»¤è¡Œå½¢å¼å¼•å…¥ä»£ç† Jar ï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶é€šè¿‡ attach å·¥å…·æ¿€æ´»æŒ‡å®šä»£ç†å³å¯ã€‚\nåŒæ ·çš„ï¼Œæˆ‘ä»¬ç®€å•ä¿®æ”¹ä¸‹ MyClassï¼Œä½¿ç¨‹åºæ¯è¿‡ä¸‰ç§’æ‰“å°ä¸€æ¬¡ â€œNice!â€ å­—ç¬¦ä¸²ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 package com.reus09.demo; /** * @ClassName MyClass * @Description TODO * @Author reus09 * @Date 2023/3/24 00:36 * @Version 1.0 **/ public class MyClass { public static void sayNice(){ System.out.println(\"Nice!\"); } public static void main(String[] args) throws InterruptedException { while (true){ sayNice(); Thread.sleep(1000 * 3); } } } Transformer å’Œç¨‹åºå¤„ç†é€»è¾‘ä¸å˜ï¼Œå°† Premain ä¿®æ”¹ä¸º AgentMainã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 package org.su18; import java.lang.instrument.Instrumentation; import java.lang.instrument.UnmodifiableClassException; public class AgentMain { public static void agentmain(String agentArgs, Instrumentation inst) throws UnmodifiableClassException, ClassNotFoundException { inst.addTransformer(new Transformer(), true); inst.retransformClasses(Class.forName(\"org.su18.MyClass\")); } } è¿™é‡Œå¯ä»¥çœ‹åˆ°å’Œ premain çš„åŒºåˆ«åœ¨äºï¼Œæˆ‘ä»¬åœ¨ addTransformer çš„å‚æ•°ä¸­æŒ‡å®šäº† trueï¼Œè€Œä¸”ä½¿ç”¨äº† retransformClasses é‡æ–°åŠ è½½äº†æŒ‡å®šçš„ç±»ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package com.reus09.demo.agentmain; import com.reus09.demo.premain.MyTransformer; import com.sun.tools.attach.VirtualMachine; import java.lang.instrument.Instrumentation; import java.lang.instrument.UnmodifiableClassException; /** * @ClassName AgentMain * @Description TODO * @Author reus09 * @Date 2023/3/23 23:57 * @Version 1.0 **/ public class AgentMain { public static void agentmain(String agentArgs, Instrumentation inst) throws ClassNotFoundException, UnmodifiableClassException { System.out.println(\"This is agentMain\"); inst.addTransformer(new MyTransformer(),true); inst.retransformClasses(Class.forName(\"com.reus09.demo.MyClass\")); } } ç„¶åæˆ‘ä»¬å†ç¼–å†™ AttachTest ç±»ç”¨æ¥å°†æˆ‘ä»¬çš„ç¨‹åº attach è¿›å»ã€‚\né€šè¿‡VirtualMachineçš„listæ–¹æ³•è·å¾—æ‰€æœ‰å·²åˆå§‹åŒ–çš„ç±»ï¼Œç„¶åæ‰¾åˆ°æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„ç±»å°†å…¶åŠ è½½ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 package com.reus09.demo; import com.sun.tools.attach.*; import java.io.IOException; import java.util.List; /** * @ClassName AttachTest * @Description TODO * @Author reus09 * @Date 2023/4/4 22:40 * @Version 1.0 **/ public class AttachTest { public static void main(String[] args) throws IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException { List list = VirtualMachine.list(); for(VirtualMachineDescriptor virtualMachineDescriptor : list){ if(virtualMachineDescriptor.displayName().endsWith(\"MyClass\")){ VirtualMachine virtualMachine = VirtualMachine.attach(virtualMachineDescriptor.id()); virtualMachine.loadAgent(\"/Users/reus09/Desktop/JavaSec/agent/target/agent-1.0.jar\",\"arg1\"); virtualMachine.detach(); } } } } åŒæ ·æˆ‘ä»¬ä¹Ÿéœ€è¦ä¿®æ”¹ä¿®æ”¹ MANIFEST.MF æ–‡ä»¶ï¼šAgent-Class: ã€‚\n1 2 3 4 Manifest-Version: 1.0 Premain-Class: com.reus09.demo.Predemo Can-Retransform-Classes: true Agent-Class: com.reus09.demo.agentmain.AgentMain ç„¶åmvn clean installæ‰“åŒ…ç¨‹åºä¹‹åï¼Œå…ˆæ‰§è¡ŒMyClassæ–¹æ³•ï¼Œå†æ‰§è¡ŒAttachTestè¿›è¡ŒåŠ è½½ã€‚\nå¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ attach è¿›è¡Œé™„åŠ è¿›ç¨‹çš„æ–¹å¼å¯ä»¥åœ¨ç¨‹åºæ— éœ€é‡å¯çš„æƒ…å†µä¸‹è¿›è¡Œæ³¨å…¥å’Œä¿®æ”¹ï¼Œæ˜¯æ›´åŠ æ–¹ä¾¿çš„æ–¹å¼ï¼Œä¸¤ç§æ–¹å¼å¯ä»¥çœ‹æƒ…å†µé€‰æ‹©ã€‚\nä½†æ˜¯ä½¿ç”¨ attach æ–¹å¼è¿›è¡Œè¿›ç¨‹æ³¨å…¥æ—¶ï¼Œéœ€è¦æ³¨æ„çš„ç‚¹ä¸ºï¼š\njava agent ä¸­çš„æ‰€æœ‰ä¾èµ–ï¼Œåœ¨åŸè¿›ç¨‹ä¸­çš„ classpath ä¸­éƒ½è¦èƒ½æ‰¾åˆ°ï¼Œå¦åˆ™åœ¨æ³¨å…¥æ—¶åŸè¿›ç¨‹ä¼šæŠ¥é”™NoClassDefFoundErrorã€‚ java agent çš„ pom æ–‡ä»¶ä¸­åŒ…å«å¦‚ä¸‹å†…å®¹ï¼Œä»¥åœ¨ jar åŒ…ä¸­åŒ…å« MANIFEST.MF å¹¶è®¾ç½® Agent-Class å’Œ Can-Retransform-Classes å±æ€§ã€‚ agent è¿›ç¨‹çš„ classpath ä¸­å¿…é¡»æœ‰ tools.jarï¼ˆæä¾› VirtualMachine attach api ï¼‰ï¼Œjdk é»˜è®¤æœ‰ tools.jarï¼Œjre é»˜è®¤æ²¡æœ‰ã€‚ ",
  "wordCount" : "4951",
  "inLanguage": "en",
  "datePublished": "2023-04-07T18:51:30+08:00",
  "dateModified": "2023-04-07T18:51:30+08:00",
  "author":[{
    "@type": "Person",
    "name": "Reus09"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/posts/tech/java-agent%E5%AD%A6%E4%B9%A0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Reus09's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="" accesskey="h" title="Reus09&#39;s Blog (Alt + H)">Reus09&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="posts" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="categories" title="Categories">
                    <span>Categories</span>
                </a>
            </li>
            <li>
                <a href="tags" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="about" title="About">
                    <span>About</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="">Home</a>&nbsp;Â»&nbsp;<a href="/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯</a></div>
    <h1 class="post-title">
      Java Agentå­¦ä¹ 
    </h1>
    <div class="post-meta"><span title='2023-04-07 18:51:30 +0800 +0800'>2023-04-07</span>&nbsp;Â·&nbsp;10 min&nbsp;Â·&nbsp;Reus09

</div>
  </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
            <summary accesskey="c" title="(Alt + C)">
                <span class="details">Table of Contents</span>
            </summary>

            <div class="inner"><ul>
                    <li>
                        <a href="#%e5%89%8d%e8%a8%80" aria-label="å‰è¨€">å‰è¨€</a></li>
                    <li>
                        <a href="#%e5%89%8d%e6%8f%90%e7%9f%a5%e8%af%86" aria-label="å‰æçŸ¥è¯†">å‰æçŸ¥è¯†</a><ul>
                            
                    <li>
                        <a href="#javalanginstrument" aria-label="java.lang.instrument"><code>java.lang.instrument</code></a><ul>
                            
                    <li>
                        <a href="#classdefinition-%e7%bb%91%e5%ae%9a%e5%ae%9a%e4%b9%89%e7%b1%bb" aria-label="ClassDefinition ç»‘å®š/å®šä¹‰ç±»">ClassDefinition ç»‘å®š/å®šä¹‰ç±»</a></li>
                    <li>
                        <a href="#classfiletransformer-%e6%8e%a5%e5%8f%a3" aria-label="ClassFileTransformer æ¥å£">ClassFileTransformer æ¥å£</a></li>
                    <li>
                        <a href="#instrumentation-%e6%8e%a5%e5%8f%a3" aria-label="Instrumentation æ¥å£">Instrumentation æ¥å£</a></li></ul>
                    </li>
                    <li>
                        <a href="#comsuntoolsattach" aria-label="com.sun.tools.attach"><code>com.sun.tools.attach</code></a><ul>
                            
                    <li>
                        <a href="#virtualmachine" aria-label="VirtualMachine">VirtualMachine</a></li>
                    <li>
                        <a href="#virtualmachinedescriptor" aria-label="VirtualMachineDescriptor">VirtualMachineDescriptor</a></li></ul>
                    </li></ul>
                    </li>
                    <li>
                        <a href="#%e5%ba%94%e7%94%a8" aria-label="åº”ç”¨">åº”ç”¨</a><ul>
                            
                    <li>
                        <a href="#premain%e6%96%b9%e6%b3%95" aria-label="premainæ–¹æ³•"><code>premain</code>æ–¹æ³•</a></li>
                    <li>
                        <a href="#agentmain%e6%96%b9%e6%b3%95" aria-label="agentmainæ–¹æ³•"><code>agentmain</code>æ–¹æ³•</a>
                    </li>
                </ul>
                </li>
                </ul>
            </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
         
         activeElement = elements[0];
         const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
         document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
     }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 && 
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
             const id = encodeURI(element.getAttribute('id')).toLowerCase();
             if (element === activeElement){
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
             } else {
                 document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
             }
         })
     }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;   
    }
</script>

  <div class="post-content"><h2 id="å‰è¨€">å‰è¨€<a hidden class="anchor" aria-hidden="true" href="#å‰è¨€">#</a></h2>
<p>JDK 1.5 å¼€å§‹ï¼ŒJavaæ–°å¢äº† <code>Instrumentation</code> ( Java Agent API )å’Œ <code>JVMTI</code> ( JVM Tool Interface )åŠŸèƒ½ï¼Œå…è®¸JVMåœ¨åŠ è½½æŸä¸ª class æ–‡ä»¶ä¹‹å‰å¯¹å…¶å­—èŠ‚ç è¿›è¡Œä¿®æ”¹ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒå¯¹å·²åŠ è½½çš„ class (ç±»å­—èŠ‚ç )è¿›è¡Œé‡æ–°åŠ è½½( Retransform )ã€‚</p>
<p>åœ¨1.6ç‰ˆæœ¬æ–°å¢äº†attach(é™„åŠ æ–¹å¼)ï¼Œå¯ä»¥å¯¹è¿è¡Œä¸­çš„Javaè¿›ç¨‹æ’å…¥Agentï¼Œ<code>instrumentation</code>åŒ…è¢«èµ‹äºˆäº†æ›´å¼ºå¤§çš„åŠŸèƒ½ï¼šå¯åŠ¨åçš„ instrumentã€æœ¬åœ°ä»£ç ï¼ˆnative codeï¼‰instrumentï¼Œä»¥åŠåŠ¨æ€æ”¹å˜ classpath ç­‰ç­‰ã€‚è¿™äº›æ”¹å˜ï¼Œæ„å‘³ç€ Java å…·æœ‰äº†æ›´å¼ºçš„åŠ¨æ€æ§åˆ¶ã€è§£é‡Šèƒ½åŠ›ï¼Œå®ƒä½¿å¾— Java è¯­è¨€å˜å¾—æ›´åŠ çµæ´»å¤šå˜ã€‚</p>
<p><code>java.lang.instrument</code>åŒ…çš„å…·ä½“å®ç°ï¼Œä¾èµ–äº <code>JVMTI</code>ã€‚JVMTIï¼ˆJava Virtual Machine Tool Interfaceï¼‰æ˜¯ä¸€å¥—ç”± Java è™šæ‹Ÿæœºæä¾›çš„ï¼Œä¸º JVM ç›¸å…³çš„å·¥å…·æä¾›çš„æœ¬åœ°ç¼–ç¨‹æ¥å£é›†åˆã€‚JVMTI æ˜¯ä» Java SE 5 å¼€å§‹å¼•å…¥ï¼Œæ•´åˆå’Œå–ä»£äº†ä»¥å‰ä½¿ç”¨çš„ Java Virtual Machine Profiler Interface (JVMPI) å’Œ the Java Virtual Machine Debug Interface (JVMDI)ï¼Œè€Œåœ¨ Java SE 6 ä¸­ï¼ŒJVMPI å’Œ JVMDI å·²ç»æ¶ˆå¤±äº†ã€‚JVMTI æä¾›äº†ä¸€å¥—â€ä»£ç†â€ç¨‹åºæœºåˆ¶ï¼Œå¯ä»¥æ”¯æŒç¬¬ä¸‰æ–¹å·¥å…·ç¨‹åºä»¥ä»£ç†çš„æ–¹å¼è¿æ¥å’Œè®¿é—® JVMï¼Œå¹¶åˆ©ç”¨ JVMTI æä¾›çš„ä¸°å¯Œçš„ç¼–ç¨‹æ¥å£ï¼Œå®Œæˆå¾ˆå¤šè·Ÿ JVM ç›¸å…³çš„åŠŸèƒ½</p>
<p>Java Agentå¯ä»¥å»å®ç°å­—èŠ‚ç æ’æ¡©ã€åŠ¨æ€è·Ÿè¸ªåˆ†æç­‰ï¼Œæ¯”å¦‚RASPäº§å“å’ŒJava Agentå†…å­˜é©¬ã€‚</p>
<p>æœ¬æ–‡ä¸»è¦å¯¹<code>premain</code>æ–¹æ³•å’Œ<code>agentmain</code>æ–¹æ³•åšç®€å•çš„å­¦ä¹ ã€‚</p>
<h2 id="å‰æçŸ¥è¯†">å‰æçŸ¥è¯†<a hidden class="anchor" aria-hidden="true" href="#å‰æçŸ¥è¯†">#</a></h2>
<h3 id="javalanginstrument"><code>java.lang.instrument</code><a hidden class="anchor" aria-hidden="true" href="#javalanginstrument">#</a></h3>
<p>ä»£ç ä¸»è¦ä½äº<code>java.lang.instrument</code>åŒ…é‡Œï¼Œè¿™é‡Œä¸»è¦è®²å¸¸ç”¨çš„ã€‚</p>
<h4 id="classdefinition-ç»‘å®šå®šä¹‰ç±»">ClassDefinition ç»‘å®š/å®šä¹‰ç±»<a hidden class="anchor" aria-hidden="true" href="#classdefinition-ç»‘å®šå®šä¹‰ç±»">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">52
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">class</span> ClassDefinition {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *  The class to redefine
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *  è¦é‡å®šä¹‰çš„ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> Class&lt;?&gt; mClass;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *  The replacement class file bytes
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *  éœ€è¦æ›¿æ¢çš„æœ¬åœ°ç±»çš„byteï¼Œä¸ºæ•°ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">private</span> <span style="color:#fff;font-weight:bold">final</span> <span style="color:#fff;font-weight:bold">byte</span>[]   mClassFile;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *  Creates a new &lt;code&gt;ClassDefinition&lt;/code&gt; binding using the supplied
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *  class and class file bytes. Does not copy the supplied buffer, just captures a reference to it.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param theClass the &lt;code&gt;Class&lt;/code&gt; that needs redefining
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param theClassFile the new class file bytes
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @throws java.lang.NullPointerException if the supplied class or array is &lt;code&gt;null&lt;/code&gt;.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span>
</span></span><span style="display:flex;"><span>    ClassDefinition(    Class&lt;?&gt; theClass,
</span></span><span style="display:flex;"><span>                        <span style="color:#fff;font-weight:bold">byte</span>[]  theClassFile) {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">if</span> (theClass == <span style="color:#fff;font-weight:bold">null</span> || theClassFile == <span style="color:#fff;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">throw</span> <span style="color:#fff;font-weight:bold">new</span> NullPointerException();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        mClass      = theClass;
</span></span><span style="display:flex;"><span>        mClassFile  = theClassFile;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * Returns the class.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return    the &lt;code&gt;Class&lt;/code&gt; object referred to.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> Class&lt;?&gt;
</span></span><span style="display:flex;"><span>    getDefinitionClass() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> mClass;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * Returns the array of bytes that contains the new class file.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return    the class file bytes.
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">byte</span>[]
</span></span><span style="display:flex;"><span>    getDefinitionClassFile() {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> mClassFile;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="classfiletransformer-æ¥å£">ClassFileTransformer æ¥å£<a hidden class="anchor" aria-hidden="true" href="#classfiletransformer-æ¥å£">#</a></h4>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">interface</span> ClassFileTransformer {
</span></span><span style="display:flex;"><span>    <span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * ç±»æ–‡ä»¶è½¬æ¢æ–¹æ³•ï¼Œé‡å†™transformæ–¹æ³•å¯è·å–åˆ°å¾…åŠ è½½çš„ç±»ç›¸å…³ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     *
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param loader              å®šä¹‰è¦è½¬æ¢çš„ç±»åŠ è½½å™¨ï¼›å¦‚æœæ˜¯å¼•å¯¼åŠ è½½å™¨ï¼Œåˆ™ä¸º null
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param className           ç±»å,å¦‚:java/lang/Runtime
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param classBeingRedefined å¦‚æœæ˜¯è¢«é‡å®šä¹‰æˆ–é‡è½¬æ¢è§¦å‘ï¼Œåˆ™ä¸ºé‡å®šä¹‰æˆ–é‡è½¬æ¢çš„ç±»ï¼›å¦‚æœæ˜¯ç±»åŠ è½½ï¼Œåˆ™ä¸º null
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param protectionDomain    è¦å®šä¹‰æˆ–é‡å®šä¹‰çš„ç±»çš„ä¿æŠ¤åŸŸ
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @param classfileBuffer     ç±»æ–‡ä»¶æ ¼å¼çš„è¾“å…¥å­—èŠ‚ç¼“å†²åŒºï¼ˆä¸å¾—ä¿®æ”¹ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     * @return è¿”å›ä¸€ä¸ªé€šè¿‡ASMä¿®æ”¹åæ·»åŠ äº†é˜²å¾¡ä»£ç çš„å­—èŠ‚ç byteæ•°ç»„ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">byte</span>[]
</span></span><span style="display:flex;"><span>    transform(  ClassLoader         loader,
</span></span><span style="display:flex;"><span>                String              className,
</span></span><span style="display:flex;"><span>                Class&lt;?&gt;            classBeingRedefined,
</span></span><span style="display:flex;"><span>                ProtectionDomain    protectionDomain,
</span></span><span style="display:flex;"><span>                <span style="color:#fff;font-weight:bold">byte</span>[]              classfileBuffer)
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">throws</span> IllegalClassFormatException;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>é‡å†™ <code>transform()</code> æ–¹æ³•éœ€è¦æ³¨æ„ä»¥ä¸‹äº‹é¡¹ï¼š</p>
<ol>
<li>ClassLoader å¦‚æœæ˜¯è¢« Bootstrap ClassLoader (å¼•å¯¼ç±»åŠ è½½å™¨)æ‰€åŠ è½½é‚£ä¹ˆ loader å‚æ•°çš„å€¼æ˜¯ç©ºã€‚</li>
<li>ä¿®æ”¹ç±»å­—èŠ‚ç æ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„æ’å…¥çš„ä»£ç åœ¨å¯¹åº”çš„ ClassLoader ä¸­å¯ä»¥æ­£ç¡®çš„è·å–åˆ°ï¼Œå¦åˆ™ä¼šæŠ¥ ClassNotFoundException ï¼Œæ¯”å¦‚ä¿®æ”¹ java.io.FileInputStream (è¯¥ç±»ç”± Bootstrap ClassLoader åŠ è½½)æ—¶æ’å…¥äº†æˆ‘ä»¬æ£€æµ‹ä»£ç ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†å¿…é¡»ä¿è¯ FileInputStream èƒ½å¤Ÿè·å–åˆ°æˆ‘ä»¬çš„æ£€æµ‹ä»£ç ç±»ã€‚</li>
<li>JVMç±»åçš„ä¹¦å†™æ–¹å¼è·¯å¾„æ–¹å¼ï¼š<code>java/lang/String</code> è€Œä¸æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„ç±»åæ–¹å¼ï¼š<code>java.lang.String</code>ã€‚</li>
<li>ç±»å­—èŠ‚å¿…é¡»ç¬¦åˆ JVM æ ¡éªŒè¦æ±‚ï¼Œå¦‚æœæ— æ³•éªŒè¯ç±»å­—èŠ‚ç ä¼šå¯¼è‡´ JVM å´©æºƒæˆ–è€… VerifyError (ç±»éªŒè¯é”™è¯¯)ã€‚</li>
<li>å¦‚æœä¿®æ”¹çš„æ˜¯ retransform ç±»(ä¿®æ”¹å·²è¢« JVM åŠ è½½çš„ç±»)ï¼Œä¿®æ”¹åçš„ç±»å­—èŠ‚ç ä¸å¾—æ–°å¢æ–¹æ³•ã€ä¿®æ”¹æ–¹æ³•å‚æ•°ã€ç±»æˆå‘˜å˜é‡ã€‚</li>
<li>addTransformer æ—¶å¦‚æœæ²¡æœ‰ä¼ å…¥ retransform å‚æ•°(é»˜è®¤æ˜¯ false )ï¼Œå°±ç®— MANIFEST.MF ä¸­é…ç½®äº† <code>Can-Redefine-Classes: true</code> è€Œä¸”æ‰‹åŠ¨è°ƒç”¨äº†<code>retransformClasses()</code>æ–¹æ³•ä¹Ÿä¸€æ ·æ— æ³•retransformã€‚</li>
<li>å¸è½½ transform æ—¶éœ€è¦ä½¿ç”¨åˆ›å»ºæ—¶çš„ Instrumentation å®ä¾‹ã€‚</li>
</ol>
<p>è¿˜éœ€è¦ç†è§£çš„æ˜¯ï¼Œåœ¨ä»¥ä¸‹ä¸‰ç§æƒ…å½¢ä¸‹ <code>ClassFileTransformer.transform()</code> ä¼šè¢«æ‰§è¡Œï¼š</p>
<ol>
<li>æ–°çš„ class è¢«åŠ è½½ã€‚</li>
<li>Instrumentation.redefineClasses æ˜¾å¼è°ƒç”¨ã€‚</li>
<li>addTransformer ç¬¬äºŒä¸ªå‚æ•°ä¸º true æ—¶ï¼ŒInstrumentation.retransformClasses æ˜¾å¼è°ƒç”¨ã€‚</li>
</ol>
<h4 id="instrumentation-æ¥å£">Instrumentation æ¥å£<a hidden class="anchor" aria-hidden="true" href="#instrumentation-æ¥å£">#</a></h4>
<p><code>java.lang.instrument.Instrumentation </code>æ˜¯ JVMTIAgentï¼ˆJVM Tool Interface Agentï¼‰çš„ä¸€éƒ¨åˆ†ï¼ŒJava agenté€šè¿‡è¿™ä¸ªç±»å’Œç›®æ ‡ JVM è¿›è¡Œäº¤äº’ï¼Œä»è€Œè¾¾åˆ°ä¿®æ”¹æ•°æ®çš„æ•ˆæœ</p>
<p>åœ¨ Instrumentation ä¸­å¢åŠ äº†åå« transformer çš„ Class æ–‡ä»¶è½¬æ¢å™¨ï¼Œè½¬æ¢å™¨å¯ä»¥æ”¹å˜äºŒè¿›åˆ¶æµçš„æ•°æ®</p>
<p>Transformer å¯ä»¥å¯¹æœªåŠ è½½çš„ç±»è¿›è¡Œæ‹¦æˆªï¼ŒåŒæ—¶å¯å¯¹å·²åŠ è½½çš„ç±»è¿›è¡Œé‡æ–°æ‹¦æˆªï¼Œæ‰€ä»¥æ ¹æ®è¿™ä¸ªç‰¹æ€§æˆ‘ä»¬èƒ½å¤Ÿå®ç°åŠ¨æ€ä¿®æ”¹å­—èŠ‚ç </p>
<p>åˆ©ç”¨ Instrumentation æˆ‘ä»¬å¯ä»¥å®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š</p>
<table>
<thead>
<tr>
<th>ç±»æ–¹æ³•</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>void addTransformer(ClassFileTransformer transformer, boolean canRetransform)</code></td>
<td>æ·»åŠ ä¸€ä¸ª Transformerï¼Œæ˜¯å¦å…è®¸ reTransformer</td>
</tr>
<tr>
<td><code>void addTransformer(ClassFileTransformer transformer)</code></td>
<td>æ·»åŠ ä¸€ä¸ª Transformer</td>
</tr>
<tr>
<td><code>boolean removeTransformer(ClassFileTransformer transformer)</code></td>
<td>ç§»é™¤ä¸€ä¸ª Transformer</td>
</tr>
<tr>
<td><code>boolean isRetransformClassesSupported()</code></td>
<td>æ£€æµ‹æ˜¯å¦å…è®¸ reTransformer</td>
</tr>
<tr>
<td><code>void retransformClasses(Class&lt;?&gt;... classes)</code></td>
<td>é‡åŠ è½½ï¼ˆretransformï¼‰ç±»</td>
</tr>
<tr>
<td><code>boolean isModifiableClass(Class&lt;?&gt; theClass)</code></td>
<td>ç¡®å®šä¸€ä¸ªç±»æ˜¯å¦å¯ä»¥è¢« retransformation æˆ– redefinition ä¿®æ”¹</td>
</tr>
<tr>
<td><code>Class[] getAllLoadedClasses()</code></td>
<td>è·å– JVM å½“å‰åŠ è½½çš„æ‰€æœ‰ç±»</td>
</tr>
<tr>
<td><code>Class[] getInitiatedClasses(ClassLoader loader)</code></td>
<td>è·å–æŒ‡å®šç±»åŠ è½½å™¨ä¸‹æ‰€æœ‰å·²ç»åˆå§‹åŒ–çš„ç±»</td>
</tr>
<tr>
<td><code>long getObjectSize(Object objectToSize)</code></td>
<td>è¿”å›æŒ‡å®šå¯¹è±¡å¤§å°</td>
</tr>
<tr>
<td><code>void appendToBootstrapClassLoaderSearch(JarFile jarfile)</code></td>
<td>æ·»åŠ åˆ° BootstrapClassLoader æœç´¢</td>
</tr>
<tr>
<td><code>void appendToSystemClassLoaderSearch(JarFile jarfile)</code></td>
<td>æ·»åŠ åˆ° SystemClassLoader æœç´¢</td>
</tr>
<tr>
<td><code>boolean isNativeMethodPrefixSupported()</code></td>
<td>æ˜¯å¦æ”¯æŒè®¾ç½® native æ–¹æ³• Prefix</td>
</tr>
<tr>
<td><code>void setNativeMethodPrefix(ClassFileTransformer transformer, String prefix)</code></td>
<td>é€šè¿‡å…è®¸é‡è¯•ï¼Œå°†å‰ç¼€åº”ç”¨åˆ°åç§°ï¼Œæ­¤æ–¹æ³•ä¿®æ”¹æœ¬æœºæ–¹æ³•è§£æçš„å¤±è´¥å¤„ç†</td>
</tr>
<tr>
<td><code>boolean isRedefineClassesSupported()</code></td>
<td>æ˜¯å¦æ”¯æŒç±» redefine</td>
</tr>
<tr>
<td><code>void redefineClasses(ClassDefinition... definitions)</code></td>
<td>é‡å®šä¹‰ï¼ˆredefineï¼‰ç±»</td>
</tr>
</tbody>
</table>
<p>å…¶ä¸­å¸¸ç”¨çš„æ–¹æ³•æœ‰:<code>addTransformer</code>,<code>retransformClasses</code>ç­‰</p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>addTransformer</code>æ–¹æ³•å®ç°ï¼Œæ·»åŠ ä¸€ä¸ªæˆ‘ä»¬è‡ªå®šä¹‰çš„è½¬æ¢å™¨ï¼Œè¿™ä¸ªè½¬æ¢å™¨å®ç°äº†<code>ClassFileTransformer</code>ç±»ï¼Œåœ¨é‡å†™çš„<code>transform</code>æ–¹æ³•ä¸­å®ç°å¯¹ç±»çš„åŠ è½½å’Œä¿®æ”¹ã€‚</p>
<h3 id="comsuntoolsattach"><code>com.sun.tools.attach</code><a hidden class="anchor" aria-hidden="true" href="#comsuntoolsattach">#</a></h3>
<p>åœ¨ jdk 1.6 ä¸­å®ç°äº†attach-on-demandï¼ˆæŒ‰éœ€é™„ç€ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Attach API åŠ¨æ€åŠ è½½ agent ï¼Œç„¶è€Œ Attach API åœ¨ tool.jar ä¸­ï¼Œjvm å¯åŠ¨æ—¶æ˜¯é»˜è®¤ä¸åŠ è½½è¯¥ä¾èµ–çš„ï¼Œéœ€è¦æˆ‘ä»¬åœ¨ classpath ä¸­é¢å¤–è¿›è¡ŒæŒ‡å®š</p>
<p>å¯åŠ¨ååŠ è½½ agent é€šè¿‡æ–°çš„ä»£ç†æ“ä½œæ¥å®ç°ï¼šagentmainï¼Œä½¿å¾—å¯ä»¥åœ¨ main å‡½æ•°å¼€å§‹è¿è¡Œä¹‹åå†è¿è¡Œ</p>
<p>åœ¨ Java JDK6 ä»¥åå®ç°å¯åŠ¨ååŠ è½½ Instrument çš„æ˜¯ Attach apiã€‚å­˜åœ¨äº com.sun.tools.attach é‡Œé¢æœ‰ä¸¤ä¸ªé‡è¦çš„ç±»ã€‚</p>
<p>æ¥æŸ¥çœ‹ä¸€ä¸‹è¯¥åŒ…ä¸­çš„å†…å®¹ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„ç±»ï¼Œåˆ†åˆ«æ˜¯ VirtualMachine å’Œ VirtualMachineDescriptorï¼Œå…¶ä¸­æˆ‘ä»¬é‡ç‚¹å…³æ³¨ VirtualMachine ç±»ã€‚</p>
<h4 id="virtualmachine">VirtualMachine<a hidden class="anchor" aria-hidden="true" href="#virtualmachine">#</a></h4>
<p>VirtualMachine å¯ä»¥æ¥å®ç°è·å–ç³»ç»Ÿä¿¡æ¯ï¼Œå†…å­˜dumpã€ç°æˆdumpã€ç±»ä¿¡æ¯ç»Ÿè®¡ï¼ˆä¾‹å¦‚JVMåŠ è½½çš„ç±»ï¼‰ã€‚é‡Œé¢é…å¤‡æœ‰å‡ ä¸ªæ–¹æ³•LoadAgentï¼ŒAttach å’Œ Detach ã€‚ä¸‹é¢æ¥çœ‹çœ‹è¿™å‡ ä¸ªæ–¹æ³•çš„ä½œç”¨</p>
<p><strong>Attach</strong> ï¼šè¯¥ç±»å…è®¸æˆ‘ä»¬é€šè¿‡ç»™attachæ–¹æ³•ä¼ å…¥ä¸€ä¸ªjvmçš„pid(è¿›ç¨‹id)ï¼Œè¿œç¨‹è¿æ¥åˆ°jvmä¸Š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>VirtualMachine vm = VirtualMachine.<span style="color:#007f7f">attach</span>(v.<span style="color:#007f7f">id</span>());
</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230407195916491.png" alt="image-20230407195916491"  />
</p>
<p><strong>loadAgent</strong>ï¼šå‘jvmæ³¨å†Œä¸€ä¸ªä»£ç†ç¨‹åºagentï¼Œåœ¨è¯¥agentçš„ä»£ç†ç¨‹åºä¸­ä¼šå¾—åˆ°ä¸€ä¸ªInstrumentationå®ä¾‹ï¼Œè¯¥å®ä¾‹å¯ä»¥ åœ¨classåŠ è½½å‰æ”¹å˜classçš„å­—èŠ‚ç ï¼Œä¹Ÿå¯ä»¥åœ¨classåŠ è½½åé‡æ–°åŠ è½½ã€‚åœ¨è°ƒç”¨Instrumentationå®ä¾‹çš„æ–¹æ³•æ—¶ï¼Œè¿™äº›æ–¹æ³•ä¼šä½¿ç”¨ClassFileTransformeræ¥å£ä¸­æä¾›çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</p>
<p><strong>Detach</strong>ï¼šä» JVM ä¸Šé¢è§£é™¤ä¸€ä¸ªä»£ç†(agent)</p>
<h4 id="virtualmachinedescriptor">VirtualMachineDescriptor<a hidden class="anchor" aria-hidden="true" href="#virtualmachinedescriptor">#</a></h4>
<p>VirtualMachineDescriptor æ˜¯ä¸€ä¸ªæè¿°è™šæ‹Ÿæœºçš„å®¹å™¨ç±»ï¼Œé…åˆ VirtualMachine ç±»å®Œæˆå„ç§åŠŸèƒ½ã€‚</p>
<p>æ‰€ä»¥æœ€åæˆ‘ä»¬çš„æ³¨å…¥æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<p>è¿™é‡Œå€Ÿç”¨å¥¶æ€å¸ˆå‚…çš„å›¾ç‰‡:</p>
<p>é€šè¿‡ VirtualMachine ç±»çš„ attach(pid) æ–¹æ³•ï¼Œå¯ä»¥ attach åˆ°ä¸€ä¸ªè¿è¡Œä¸­çš„ java è¿›ç¨‹ä¸Šï¼Œä¹‹åä¾¿å¯ä»¥é€šè¿‡ loadAgent(agentJarPath) æ¥å°†agent çš„ jar åŒ…æ³¨å…¥åˆ°å¯¹åº”çš„è¿›ç¨‹ï¼Œç„¶åå¯¹åº”çš„è¿›ç¨‹ä¼šè°ƒç”¨agentmainæ–¹æ³•ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image20210614164445.png" alt="image-20210614164444958"  />
</p>
<h2 id="åº”ç”¨">åº”ç”¨<a hidden class="anchor" aria-hidden="true" href="#åº”ç”¨">#</a></h2>
<p>Java Agent æ”¯æŒä¸¤ç§æ–¹å¼è¿›è¡ŒåŠ è½½ï¼š</p>
<ol>
<li>å®ç° premain æ–¹æ³•ï¼Œåœ¨å¯åŠ¨æ—¶è¿›è¡ŒåŠ è½½ ï¼ˆè¯¥ç‰¹æ€§åœ¨ jdk 1.5 ä¹‹åæ‰æœ‰ï¼‰</li>
<li>å®ç° agentmain æ–¹æ³•ï¼Œåœ¨å¯åŠ¨åè¿›è¡ŒåŠ è½½ ï¼ˆè¯¥ç‰¹æ€§åœ¨ jdk 1.6 ä¹‹åæ‰æœ‰ï¼‰</li>
</ol>
<p>è¿™é‡Œæˆ‘ä»¬æ¥ä¿®æ”¹ç±»:<code>com.reus09.demo.MyClass#sayNice</code>æ–¹æ³•çš„å†…å®¹ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09.demo;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName MyClass
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/3/24 00:36
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MyClass {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> sayNice(){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Nice!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="premainæ–¹æ³•"><code>premain</code>æ–¹æ³•<a hidden class="anchor" aria-hidden="true" href="#premainæ–¹æ³•">#</a></h3>
<p>ä½¿ç”¨premainæ–¹æ³•è®©å‡½æ•°åœ¨æ‰§è¡Œå‰<code>sayNice</code>æ–¹æ³•çš„è¾“å‡ºå†…å®¹è¢«ä¿®æ”¹æ‰ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰è‡ªå·±çš„ <code>MyTransformer</code>ï¼Œå¦‚ä¸‹ä»£ç ï¼Œè¿™é‡Œä½¿ç”¨åˆ¤æ–­å¦‚æœç±»åä¸ºæŒ‡å®šç±»çš„åç§°ï¼Œåˆ™ä½¿ç”¨<code>ClassHandler.replaceBytes()</code> æ–¹æ³•è¿›è¡Œå­—èŠ‚ç çš„æ›¿æ¢ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09.demo.premain;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.lang.instrument.ClassFileTransformer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.lang.instrument.IllegalClassFormatException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.security.ProtectionDomain;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName Transformer
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/3/24 00:37
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MyTransformer <span style="color:#fff;font-weight:bold">implements</span> ClassFileTransformer {
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">byte</span>[] transform(ClassLoader loader, String className,
</span></span><span style="display:flex;"><span>                            Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain,
</span></span><span style="display:flex;"><span>                            <span style="color:#fff;font-weight:bold">byte</span>[] classfileBuffer) <span style="color:#fff;font-weight:bold">throws</span> IllegalClassFormatException {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å°†å¸¸ç”¨çš„ç±»åè½¬æ¢ä¸º JVM è®¤è¯†çš„ç±»å
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        className = className.<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;/&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;.&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å¦‚æœç±»åä¸ºæˆ‘ä»¬æŒ‡å®šçš„ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">if</span> (className.<span style="color:#007f7f">equals</span>(<span style="color:#0ff;font-weight:bold">&#34;com.reus09.demo.MyClass&#34;</span>)) {
</span></span><span style="display:flex;"><span>            <span style="color:#007f7f">// è¿›ä¸€æ­¥è¿›è¡Œå¤„ç†ï¼Œæ›¿æ¢æ‰è¾“å‡ºå­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>            <span style="color:#fff;font-weight:bold">return</span> ClassHandler.<span style="color:#007f7f">replaceBytes</span>(className, classfileBuffer);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">return</span> classfileBuffer;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>å­—ç¬¦å¤„ç†ä»£ç ï¼š</p>
<p>ä»£ç å®ç°æ€è·¯å¾ˆæœ´ç´ ï¼Œè¿™é‡Œå°†ç±»å­—èŠ‚ç è½¬æ¢ä¸ºbyteå­—ç¬¦ä¸²ï¼Œå¹¶è¿›è¡Œå­—ç¬¦ä¸²æŸ¥æ‰¾ï¼Œæ›¿æ¢åå†è½¬å› byteï¼Œåœ¨å®é™…é¡¹ç›®ä¸­å°†ä½¿ç”¨ ASM æˆ– javassist ç­‰å¯¹ç±»å­—èŠ‚ç è¿›è¡Œå¤„ç†ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">51
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09.demo.premain;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.Arrays;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName ClassHandler
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/3/24 00:38
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> ClassHandler {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">byte</span>[] replaceBytes(String className, <span style="color:#fff;font-weight:bold">byte</span>[] classBuffer) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å°†ç±»å­—èŠ‚ç è½¬æ¢æˆbyteå­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String bufferStr = Arrays.<span style="color:#007f7f">toString</span>(classBuffer);
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(className + <span style="color:#0ff;font-weight:bold">&#34;ç±»æ›¿æ¢å‰çš„å­—èŠ‚ç :&#34;</span> + bufferStr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        bufferStr = bufferStr.<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;[&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>).<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;]&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æŸ¥æ‰¾éœ€è¦æ›¿æ¢çš„JavaäºŒè¿›åˆ¶å†…å®¹
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">byte</span>[] findBytes = <span style="color:#0ff;font-weight:bold">&#34;Nice!&#34;</span>.<span style="color:#007f7f">getBytes</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æŠŠæœç´¢çš„å­—ç¬¦ä¸²byteè½¬æ¢æˆbyteå­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String findStr = Arrays.<span style="color:#007f7f">toString</span>(findBytes).<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;[&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>).<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;]&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// äºŒè¿›åˆ¶æ›¿æ¢åçš„byteå€¼ï¼Œæ³¨æ„è¿™ä¸ªå€¼éœ€è¦å’Œæ›¿æ¢çš„å­—ç¬¦ä¸²é•¿åº¦ä¸€è‡´ï¼Œä¸ç„¶ä¼šç ´åå¸¸é‡æ± 
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">byte</span>[] replaceBytes = <span style="color:#0ff;font-weight:bold">&#34;Reus!&#34;</span>.<span style="color:#007f7f">getBytes</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// æŠŠæ›¿æ¢çš„å­—ç¬¦ä¸²byteè½¬æ¢æˆbyteå­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String replaceStr = Arrays.<span style="color:#007f7f">toString</span>(replaceBytes).<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;[&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>).<span style="color:#007f7f">replace</span>(<span style="color:#0ff;font-weight:bold">&#34;]&#34;</span>, <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        bufferStr = bufferStr.<span style="color:#007f7f">replace</span>(findStr, replaceStr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// åˆ‡å‰²æ›¿æ¢åçš„byteå­—ç¬¦ä¸²
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        String[] byteArray = bufferStr.<span style="color:#007f7f">split</span>(<span style="color:#0ff;font-weight:bold">&#34;\\s*,\\s*&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// åˆ›å»ºæ–°çš„byteæ•°ç»„ï¼Œå­˜å‚¨æ›¿æ¢åçš„äºŒè¿›åˆ¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">byte</span>[] bytes = <span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">byte</span>[byteArray.<span style="color:#007f7f">length</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// å°†byteå­—ç¬¦ä¸²è½¬æ¢æˆbyte
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">for</span> (<span style="color:#fff;font-weight:bold">int</span> i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt; byteArray.<span style="color:#007f7f">length</span>; i++) {
</span></span><span style="display:flex;"><span>            bytes[i] = Byte.<span style="color:#007f7f">parseByte</span>(byteArray[i]);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(className + <span style="color:#0ff;font-weight:bold">&#34;ç±»æ›¿æ¢åçš„å­—èŠ‚ç :&#34;</span> + Arrays.<span style="color:#007f7f">toString</span>(bytes));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#007f7f">// è¿”å›ä¿®æ”¹åçš„äºŒè¿›åˆ¶
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"></span>        <span style="color:#fff;font-weight:bold">return</span> bytes;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¥ä¸‹æ¥å®šä¹‰ Premainï¼Œç±»åéšæ„ï¼Œç±»ä¸­å®šä¹‰äº† <code>premain()</code> æ–¹æ³•æ·»åŠ è‡ªå·±çš„ Transformerã€‚
å…¶ä¸­å‚æ•° agentArgs æ˜¯ premain å‡½æ•°å¾—åˆ°çš„ç¨‹åºå‚æ•°ï¼ŒéšåŒ â€œ-javaagentâ€ä¸€èµ·ä¼ å…¥ã€‚ä¸ main å‡½æ•°ä¸åŒçš„æ˜¯ï¼Œè¿™ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²è€Œä¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œå¦‚æœç¨‹åºå‚æ•°æœ‰å¤šä¸ªï¼Œç¨‹åºå°†è‡ªè¡Œè§£æè¿™ä¸ªå­—ç¬¦ä¸²ã€‚
Inst æ˜¯ä¸€ä¸ª java.lang.instrument.Instrumentation çš„å®ä¾‹ï¼Œç”± JVM è‡ªåŠ¨ä¼ å…¥ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09.demo;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.reus09.demo.premain.MyTransformer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.lang.instrument.Instrumentation;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName Predemo
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/3/22 21:06
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> Predemo {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> premain(String agentArgs, Instrumentation inst) <span style="color:#fff;font-weight:bold">throws</span>  Exception {
</span></span><span style="display:flex;"><span>       inst.<span style="color:#007f7f">addTransformer</span>(<span style="color:#fff;font-weight:bold">new</span> MyTransformer());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶ååœ¨<code>resources/META-INF</code>ç›®å½•ä¸‹åˆ›å»º<code>MANIFEST.MF</code>æ–‡ä»¶ï¼Œåœ¨è¯¥æ–‡ä»¶ä¸­æˆ‘ä»¬æŒ‡å®šå¯¹åº”çš„<code>Premain-Class: </code></p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span>Manifest-Version: 1.0
</span></span><span style="display:flex;"><span>Premain-Class: com.reus09.demo.Predemo
</span></span></code></pre></td></tr></table>
</div>
</div><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªæ–‡ä»¶éœ€è¦æœ‰ä¸€è¡Œæ¢è¡Œã€‚</p>
<p>ç„¶ååœ¨<code>pom.xml</code>é‡ŒåŠ å…¥å¦‚ä¸‹é…ç½®ï¼š</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="font-weight:bold">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;artifactId&gt;</span>maven-jar-plugin<span style="font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">&lt;version&gt;</span>2.3.2<span style="font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>         <span style="font-weight:bold">&lt;archive&gt;</span>
</span></span><span style="display:flex;"><span>             <span style="font-weight:bold">&lt;manifestFile&gt;</span>src/main/resources/META-INF/MANIFEST.MF<span style="font-weight:bold">&lt;/manifestFile&gt;</span>
</span></span><span style="display:flex;"><span>         <span style="font-weight:bold">&lt;/archive&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="font-weight:bold">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">&lt;/plugin&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åæ‰§è¡Œ<code>mvn clean install</code>ï¼Œè¿›è¡Œç¨‹åºæ‰“åŒ…ã€‚</p>
<p>ç„¶ååœ¨IDEAè¿è¡Œç¨‹åºæ—¶åŠ å…¥å¦‚ä¸‹å‚æ•°ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230407194534941.png" alt="image-20230407194534941"  />
</p>
<p>è¿è¡Œ<code>MyClass</code>ç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°<code>sayNice</code>æ–¹æ³•æ‰§è¡Œçš„ç»“æœå·²ç»å˜äº†ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230407194452444.png" alt="image-20230407194452444"  />
</p>
<p>premainæ–¹æ³•æµç¨‹å›¾ï¼š</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image3010963-20221030224006321-1362735476.png" alt="img"  />
</p>
<h3 id="agentmainæ–¹æ³•"><code>agentmain</code>æ–¹æ³•<a hidden class="anchor" aria-hidden="true" href="#agentmainæ–¹æ³•">#</a></h3>
<p>JDK 1.6 æ–°å¢äº†attach (é™„åŠ æ–¹å¼)æ–¹å¼ï¼Œå¯ä»¥å¯¹è¿è¡Œä¸­çš„ Java è¿›ç¨‹é™„åŠ  Agent ã€‚</p>
<p>è¿™å°±æ˜¯æˆ‘ä»¬è¯´çš„ agentmain ï¼Œä½¿ç”¨æ–¹å¼å’Œ permain ååˆ†ç›¸ä¼¼ï¼ŒåŒ…æ‹¬ç¼–å†™ MANIFEST.MF å’Œç”Ÿæˆä»£ç† Jar åŒ…ã€‚ä½†æ˜¯ï¼Œå®ƒå¹¶ä¸éœ€è¦é€šè¿‡<code>-javaagent</code> å‘½ä»¤è¡Œå½¢å¼å¼•å…¥ä»£ç† Jar ï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶é€šè¿‡ attach å·¥å…·æ¿€æ´»æŒ‡å®šä»£ç†å³å¯ã€‚</p>
<p>åŒæ ·çš„ï¼Œæˆ‘ä»¬ç®€å•ä¿®æ”¹ä¸‹ MyClassï¼Œä½¿ç¨‹åºæ¯è¿‡ä¸‰ç§’æ‰“å°ä¸€æ¬¡ â€œNice!â€ å­—ç¬¦ä¸²ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09.demo;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName MyClass
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/3/24 00:36
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> MyClass {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> sayNice(){
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;Nice!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> InterruptedException {
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">while</span> (<span style="color:#fff;font-weight:bold">true</span>){
</span></span><span style="display:flex;"><span>            sayNice();
</span></span><span style="display:flex;"><span>            Thread.<span style="color:#007f7f">sleep</span>(<span style="color:#ff0;font-weight:bold">1000</span> * <span style="color:#ff0;font-weight:bold">3</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Transformer å’Œç¨‹åºå¤„ç†é€»è¾‘ä¸å˜ï¼Œå°† Premain ä¿®æ”¹ä¸º AgentMainã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> org.su18;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.lang.instrument.Instrumentation;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.lang.instrument.UnmodifiableClassException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AgentMain {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> agentmain(String agentArgs, Instrumentation inst) <span style="color:#fff;font-weight:bold">throws</span> UnmodifiableClassException,
</span></span><span style="display:flex;"><span>			ClassNotFoundException {
</span></span><span style="display:flex;"><span>		inst.<span style="color:#007f7f">addTransformer</span>(<span style="color:#fff;font-weight:bold">new</span> Transformer(), <span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>		inst.<span style="color:#007f7f">retransformClasses</span>(Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;org.su18.MyClass&#34;</span>));
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°å’Œ premain çš„åŒºåˆ«åœ¨äºï¼Œæˆ‘ä»¬åœ¨ addTransformer çš„å‚æ•°ä¸­æŒ‡å®šäº† trueï¼Œè€Œä¸”ä½¿ç”¨äº† retransformClasses é‡æ–°åŠ è½½äº†æŒ‡å®šçš„ç±»ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09.demo.agentmain;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.reus09.demo.premain.MyTransformer;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.tools.attach.VirtualMachine;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.lang.instrument.Instrumentation;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.lang.instrument.UnmodifiableClassException;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName AgentMain
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/3/23 23:57
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AgentMain {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> agentmain(String agentArgs, Instrumentation inst) <span style="color:#fff;font-weight:bold">throws</span> ClassNotFoundException, UnmodifiableClassException {
</span></span><span style="display:flex;"><span>        System.<span style="color:#007f7f">out</span>.<span style="color:#007f7f">println</span>(<span style="color:#0ff;font-weight:bold">&#34;This is agentMain&#34;</span>);
</span></span><span style="display:flex;"><span>        inst.<span style="color:#007f7f">addTransformer</span>(<span style="color:#fff;font-weight:bold">new</span> MyTransformer(),<span style="color:#fff;font-weight:bold">true</span>);
</span></span><span style="display:flex;"><span>        inst.<span style="color:#007f7f">retransformClasses</span>(Class.<span style="color:#007f7f">forName</span>(<span style="color:#0ff;font-weight:bold">&#34;com.reus09.demo.MyClass&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶åæˆ‘ä»¬å†ç¼–å†™ AttachTest ç±»ç”¨æ¥å°†æˆ‘ä»¬çš„ç¨‹åº attach è¿›å»ã€‚</p>
<p>é€šè¿‡<code>VirtualMachine</code>çš„<code>list</code>æ–¹æ³•è·å¾—æ‰€æœ‰å·²åˆå§‹åŒ–çš„ç±»ï¼Œç„¶åæ‰¾åˆ°æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„ç±»å°†å…¶åŠ è½½ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">package</span> com.reus09.demo;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> com.sun.tools.attach.*;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.io.IOException;
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">import</span> java.util.List;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#007f7f">/**
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @ClassName AttachTest
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Description TODO
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Author reus09
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Date 2023/4/4 22:40
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> * @Version 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#007f7f"> **/</span>
</span></span><span style="display:flex;"><span><span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">class</span> AttachTest {
</span></span><span style="display:flex;"><span>    <span style="color:#fff;font-weight:bold">public</span> <span style="color:#fff;font-weight:bold">static</span> <span style="color:#fff;font-weight:bold">void</span> main(String[] args) <span style="color:#fff;font-weight:bold">throws</span> IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException {
</span></span><span style="display:flex;"><span>        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.<span style="color:#007f7f">list</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#fff;font-weight:bold">for</span>(VirtualMachineDescriptor virtualMachineDescriptor : list){
</span></span><span style="display:flex;"><span>            <span style="color:#fff;font-weight:bold">if</span>(virtualMachineDescriptor.<span style="color:#007f7f">displayName</span>().<span style="color:#007f7f">endsWith</span>(<span style="color:#0ff;font-weight:bold">&#34;MyClass&#34;</span>)){
</span></span><span style="display:flex;"><span>                VirtualMachine virtualMachine = VirtualMachine.<span style="color:#007f7f">attach</span>(virtualMachineDescriptor.<span style="color:#007f7f">id</span>());
</span></span><span style="display:flex;"><span>                virtualMachine.<span style="color:#007f7f">loadAgent</span>(<span style="color:#0ff;font-weight:bold">&#34;/Users/reus09/Desktop/JavaSec/agent/target/agent-1.0.jar&#34;</span>,<span style="color:#0ff;font-weight:bold">&#34;arg1&#34;</span>);
</span></span><span style="display:flex;"><span>                virtualMachine.<span style="color:#007f7f">detach</span>();
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŒæ ·æˆ‘ä»¬ä¹Ÿéœ€è¦ä¿®æ”¹ä¿®æ”¹ MANIFEST.MF æ–‡ä»¶ï¼š<code>Agent-Class: </code>ã€‚</p>
<div class="highlight"><div style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#727272">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-makefile" data-lang="makefile"><span style="display:flex;"><span>Manifest-Version: 1.0
</span></span><span style="display:flex;"><span>Premain-Class: com.reus09.demo.Predemo
</span></span><span style="display:flex;"><span>Can-Retransform-Classes: true
</span></span><span style="display:flex;"><span>Agent-Class: com.reus09.demo.agentmain.AgentMain
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç„¶å<code>mvn clean install</code>æ‰“åŒ…ç¨‹åºä¹‹åï¼Œå…ˆæ‰§è¡Œ<code>MyClass</code>æ–¹æ³•ï¼Œå†æ‰§è¡Œ<code>AttachTest</code>è¿›è¡ŒåŠ è½½ã€‚</p>
<p><img loading="lazy" src="https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/imageimage-20230407195300353.png" alt="image-20230407195300353"  />
</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ attach è¿›è¡Œé™„åŠ è¿›ç¨‹çš„æ–¹å¼å¯ä»¥åœ¨ç¨‹åºæ— éœ€é‡å¯çš„æƒ…å†µä¸‹è¿›è¡Œæ³¨å…¥å’Œä¿®æ”¹ï¼Œæ˜¯æ›´åŠ æ–¹ä¾¿çš„æ–¹å¼ï¼Œä¸¤ç§æ–¹å¼å¯ä»¥çœ‹æƒ…å†µé€‰æ‹©ã€‚</p>
<p>ä½†æ˜¯ä½¿ç”¨ attach æ–¹å¼è¿›è¡Œè¿›ç¨‹æ³¨å…¥æ—¶ï¼Œéœ€è¦æ³¨æ„çš„ç‚¹ä¸ºï¼š</p>
<ol>
<li>java agent ä¸­çš„æ‰€æœ‰ä¾èµ–ï¼Œåœ¨åŸè¿›ç¨‹ä¸­çš„ classpath ä¸­éƒ½è¦èƒ½æ‰¾åˆ°ï¼Œå¦åˆ™åœ¨æ³¨å…¥æ—¶åŸè¿›ç¨‹ä¼šæŠ¥é”™NoClassDefFoundErrorã€‚</li>
<li>java agent çš„ pom æ–‡ä»¶ä¸­åŒ…å«å¦‚ä¸‹å†…å®¹ï¼Œä»¥åœ¨ jar åŒ…ä¸­åŒ…å« MANIFEST.MF å¹¶è®¾ç½® Agent-Class å’Œ Can-Retransform-Classes å±æ€§ã€‚</li>
<li>agent è¿›ç¨‹çš„ classpath ä¸­å¿…é¡»æœ‰ tools.jarï¼ˆæä¾› VirtualMachine attach api ï¼‰ï¼Œjdk é»˜è®¤æœ‰ tools.jarï¼Œjre é»˜è®¤æ²¡æœ‰ã€‚</li>
</ol>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="/tags/instrumentation/">Instrumentation</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="/posts/tech/commonscollections11%E9%93%BE%E5%88%86%E6%9E%90/">
    <span class="title">Next Â»</span>
    <br>
    <span>CommonsCollections11é“¾åˆ†æ</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="">Reus09&#39;s Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
